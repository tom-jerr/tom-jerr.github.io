<!DOCTYPE html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Experience the journey of a database wizard, from the basics to advanced topics."><meta name=author content=tom-jerr><link href=https://tom-jerr.github.io/notes/sglang/SGLang%20Scheduler%20Evolution/ rel=canonical><link href=../SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/ rel=prev><link href=../RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/ rel=next><link rel=alternate type=application/rss+xml title="RSS feed" href=../../../feed_rss_created.xml><link rel=alternate type=application/rss+xml title="RSS feed of updated content" href=../../../feed_rss_updated.xml><link rel=icon href=../../../img/rocket.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.0"><title>Evolution of SGLang Scheduler - Want to be a MlSys wizard</title><link rel=stylesheet href=../../../assets/stylesheets/main.618322db.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=JetBrains+Mono:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"JetBrains Mono";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../css/custom.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css><link rel=stylesheet href=../../../css/card.css><link rel=stylesheet href=../../../css/flink.css><link rel=stylesheet href=../../../css/tasklist.css><link rel=stylesheet href=../../../css/footer-stats.css><link rel=stylesheet href=../../../css/ai-summary.css><link rel=stylesheet href=../../../assets/document_dates/fonts/material-icons.css><link rel=stylesheet href=../../../assets/document_dates/tippy/light.css><link rel=stylesheet href=../../../assets/document_dates/tippy/material.css><link rel=stylesheet href=../../../assets/document_dates/tippy/shift-away.css><link rel=stylesheet href=../../../assets/document_dates/tippy/scale.css><link rel=stylesheet href=../../../assets/document_dates/tippy/backdrop.css><link rel=stylesheet href=../../../assets/document_dates/tippy/tippy.css><link rel=stylesheet href=../../../assets/document_dates/core/core.css><link rel=stylesheet href=../../../assets/document_dates/user.config.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-NKJWZM1JHX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-NKJWZM1JHX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-NKJWZM1JHX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link href=../../../assets/stylesheets/glightbox.min.css rel=stylesheet><script src=../../../assets/javascripts/glightbox.min.js></script><style id=glightbox-style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#evolution-of-sglang-scheduler class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="Want to be a MlSys wizard" class="md-header__button md-logo" aria-label="Want to be a MlSys wizard" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 21h18v-2H2M20 8h-2V5h2m0-2H4v10a4 4 0 0 0 4 4h6a4 4 0 0 0 4-4v-3h2a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2"></path></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Want to be a MlSys wizard </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Evolution of SGLang Scheduler </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=indigo aria-label="light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=teal aria-label="dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/tom-jerr/tom-jerr.github.io/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg> </div> <div class=md-source__repository> tom-jerr's Site </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg> Home </a> </li> <li class=md-tabs__item> <a href=../../ class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 22a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z"></path></svg> Notes </a> </li> <li class=md-tabs__item> <a href=../../../paperreadings/ class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M384 512H96c-53 0-96-43-96-96V96C0 43 43 0 96 0h304c26.5 0 48 21.5 48 48v288c0 20.9-13.4 38.7-32 45.3V448c17.7 0 32 14.3 32 32s-14.3 32-32 32zM96 384c-17.7 0-32 14.3-32 32s14.3 32 32 32h256v-64zm32-232c0 13.3 10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24H152c-13.3 0-24 10.7-24 24m24 72c-13.3 0-24 10.7-24 24s10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24z"></path></svg> PaperReading </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../blogs/ class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M224 24c0-13.3 10.7-24 24-24 145.8 0 264 118.2 264 264 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-119.3-96.7-216-216-216-13.3 0-24-10.7-24-24M80 96c26.5 0 48 21.5 48 48v224c0 26.5 21.5 48 48 48s48-21.5 48-48-21.5-48-48-48c-8.8 0-16-7.2-16-16v-64c0-8.8 7.2-16 16-16 79.5 0 144 64.5 144 144s-64.5 144-144 144S32 447.5 32 368V144c0-26.5 21.5-48 48-48m168 0c92.8 0 168 75.2 168 168 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-66.3-53.7-120-120-120-13.3 0-24-10.7-24-24s10.7-24 24-24"></path></svg> Blogs </a> </li> <li class=md-tabs__item> <a href=../../../summary/ class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6 1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1zM5 8v11h14V8zm2 2h10v2H7z"></path></svg> Summaries </a> </li> <li class=md-tabs__item> <a href=../../../tags/ class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5.5 7A1.5 1.5 0 0 1 4 5.5 1.5 1.5 0 0 1 5.5 4 1.5 1.5 0 0 1 7 5.5 1.5 1.5 0 0 1 5.5 7m15.91 4.58-9-9C12.05 2.22 11.55 2 11 2H4c-1.11 0-2 .89-2 2v7c0 .55.22 1.05.59 1.41l8.99 9c.37.36.87.59 1.42.59s1.05-.23 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.56-.23-1.06-.59-1.42"></path></svg> Tags </a> </li> <li class=md-tabs__item> <a href=../../../links/ class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.78 3.653a3.936 3.936 0 1 1 5.567 5.567l-3.627 3.627a3.936 3.936 0 0 1-5.88-.353.75.75 0 0 0-1.18.928 5.436 5.436 0 0 0 8.12.486l3.628-3.628a5.436 5.436 0 1 0-7.688-7.688l-3 3a.75.75 0 0 0 1.06 1.061z"></path><path d="M7.28 11.153a3.936 3.936 0 0 1 5.88.353.75.75 0 0 0 1.18-.928 5.436 5.436 0 0 0-8.12-.486L2.592 13.72a5.436 5.436 0 1 0 7.688 7.688l3-3a.75.75 0 1 0-1.06-1.06l-3 3a3.936 3.936 0 0 1-5.567-5.568z"></path></svg> Links </a> </li> <li class=md-tabs__item> <a href=../../../about/ class=md-tabs__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M256 512a256 256 0 1 0 0-512 256 256 0 1 0 0 512m-90.6-190.1c20.4 28 53.4 46.1 90.6 46.1s70.2-18.1 90.6-46.1c7.8-10.7 22.8-13.1 33.5-5.3s13.1 22.8 5.3 33.5C356.3 390 309.2 416 256 416s-100.3-26-129.4-65.9c-7.8-10.7-5.4-25.7 5.3-33.5s25.7-5.4 33.5 5.3M144 208a32 32 0 1 1 64 0 32 32 0 1 1-64 0m164 8c0 11-9 20-20 20s-20-9-20-20c0-33.1 26.9-60 60-60h16c33.1 0 60 26.9 60 60 0 11-9 20-20 20s-20-9-20-20-9-20-20-20h-16c-11 0-20 9-20 20"></path></svg> About </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Want to be a MlSys wizard" class="md-nav__button md-logo" aria-label="Want to be a MlSys wizard" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M2 21h18v-2H2M20 8h-2V5h2m0-2H4v10a4 4 0 0 0 4 4h6a4 4 0 0 0 4-4v-3h2a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2"></path></svg> </a> Want to be a MlSys wizard </label> <div class=md-nav__source> <a href=https://github.com/tom-jerr/tom-jerr.github.io/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg> </div> <div class=md-source__repository> tom-jerr's Site </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 22a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z"></path></svg> <span class=md-ellipsis> Notes </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Notes </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> Python </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/ class=md-nav__link> <span class=md-ellipsis> Python 中的装饰器 </span> </a> </li> <li class=md-nav__item> <a href=../../python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/ class=md-nav__link> <span class=md-ellipsis> Python 中的并行 </span> </a> </li> <li class=md-nav__item> <a href=../../python/Asyncio/ class=md-nav__link> <span class=md-ellipsis> Asyncio 基础 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> tiny-llm </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> tiny-llm </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tiny-llm/Group%20Query%20Attention/ class=md-nav__link> <span class=md-ellipsis> Group Query Attention </span> </a> </li> <li class=md-nav__item> <a href=../../tiny-llm/RMSNorm%20%26%20MLP/ class=md-nav__link> <span class=md-ellipsis> RMSNorm &amp; MLP </span> </a> </li> <li class=md-nav__item> <a href=../../tiny-llm/Batching%20Inference%20%26%20KV%20Cache/ class=md-nav__link> <span class=md-ellipsis> Batch Inference &amp; KV Cache </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> Active SLAM </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> Active SLAM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/ class=md-nav__link> <span class=md-ellipsis> VINS 基础 </span> </a> </li> <li class=md-nav__item> <a href=../../../paperreadings/activeslam/active%20slam/ class=md-nav__link> <span class=md-ellipsis> Active SLAM 概述 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0> <span class=md-ellipsis> nebula </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> nebula </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../projects/nebula-vsearch/understanding/1.visitor%20pattern/ class=md-nav__link> <span class=md-ellipsis> Vistor Pattern in nebula </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/nebula-vsearch/understanding/2.memory%20management/ class=md-nav__link> <span class=md-ellipsis> Memory Management in nebula </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/nebula-vsearch/understanding/3.concurrent%20lru%20cache/ class=md-nav__link> <span class=md-ellipsis> Concurrent LRU Cache in nebula </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/nebula-vsearch/understanding/4.folly%20future%20promise/ class=md-nav__link> <span class=md-ellipsis> Folly Future Promise framework in nebula </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/nebula-vsearch/understanding/5.nGQL%20life/ class=md-nav__link> <span class=md-ellipsis> nGQL Life in Nebula </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/nebula-vsearch/understanding/6.raft-wal/ class=md-nav__link> <span class=md-ellipsis> Raft Wal in Nebula </span> </a> </li> <li class=md-nav__item> <a href=../../../projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/ class=md-nav__link> <span class=md-ellipsis> How to Modify nGQL </span> </a> </li> <li class=md-nav__item> <a href="../../../projects/nebula-vsearch/understandings/8.a kv life.md" class=md-nav__link> <span class=md-ellipsis> A Life of KV Pairs </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex=0> <span class=md-ellipsis> CS61C </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> CS61C </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CS61C/lecture2-Intro%20to%20C/ class=md-nav__link> <span class=md-ellipsis> 1 C Intro </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture4_C%20Memory%20Endianness/ class=md-nav__link> <span class=md-ellipsis> 4 C Memory Endianness </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture10_Combinational%20Logic/ class=md-nav__link> <span class=md-ellipsis> 10 Combinational Logic </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture11_FSMs/ class=md-nav__link> <span class=md-ellipsis> 11 FSMs </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture14_Datapath/ class=md-nav__link> <span class=md-ellipsis> 14 Datapath </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture15_Data-LevelParallelism/ class=md-nav__link> <span class=md-ellipsis> 15 Data-Level Parallelism </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture16_Thread-LevelParallelism/ class=md-nav__link> <span class=md-ellipsis> 16 Thread-Level Parallelism </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture17_Process_LevelParallelism/ class=md-nav__link> <span class=md-ellipsis> 17 Process-Level Parallelism </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture18_Caches/ class=md-nav__link> <span class=md-ellipsis> 18 Caches </span> </a> </li> <li class=md-nav__item> <a href=../../CS61C/lecture21_Virtual_Memory/ class=md-nav__link> <span class=md-ellipsis> 21 Virtual Memory </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_7> <label class=md-nav__link for=__nav_2_7 id=__nav_2_7_label tabindex=0> <span class=md-ellipsis> CSAPP </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_7_label aria-expanded=false> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> CSAPP </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/ class=md-nav__link> <span class=md-ellipsis> 5-优化程序性能 </span> </a> </li> <li class=md-nav__item> <a href=../../CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/ class=md-nav__link> <span class=md-ellipsis> 6-存储器层次结构 </span> </a> </li> <li class=md-nav__item> <a href=../../CSAPP/7-%E9%93%BE%E6%8E%A5/ class=md-nav__link> <span class=md-ellipsis> 7-链接 </span> </a> </li> <li class=md-nav__item> <a href=../../CSAPP/8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/ class=md-nav__link> <span class=md-ellipsis> 8-异常控制流 </span> </a> </li> <li class=md-nav__item> <a href=../../CSAPP/%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%BB%93%E6%9E%84%E5%92%8C%E6%89%A7%E8%A1%8C/ class=md-nav__link> <span class=md-ellipsis> 程序的结构和执行 </span> </a> </li> <li class=md-nav__item> <a href=../../CSAPP/%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/ class=md-nav__link> <span class=md-ellipsis> 在系统上运行程序 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_8> <label class=md-nav__link for=__nav_2_8 id=__nav_2_8_label tabindex=0> <span class=md-ellipsis> 6.s081 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_8_label aria-expanded=false> <label class=md-nav__title for=__nav_2_8> <span class="md-nav__icon md-icon"></span> 6.s081 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../6.s081/1-OS%E7%9A%84%E9%9A%94%E7%A6%BB%E6%80%A7/ class=md-nav__link> <span class=md-ellipsis> 1 OS的隔离性 </span> </a> </li> <li class=md-nav__item> <a href=../../6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/ class=md-nav__link> <span class=md-ellipsis> 2 虚拟内存实现 </span> </a> </li> <li class=md-nav__item> <a href=../../6.s081/3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8C%E9%99%B7%E5%85%A5/ class=md-nav__link> <span class=md-ellipsis> 3 系统调用和陷入 </span> </a> </li> <li class=md-nav__item> <a href=../../6.s081/4-%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/ class=md-nav__link> <span class=md-ellipsis> 4 缺页中断 </span> </a> </li> <li class=md-nav__item> <a href=../../6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/ class=md-nav__link> <span class=md-ellipsis> 5 硬件中断 </span> </a> </li> <li class=md-nav__item> <a href=../../6.s081/6-%E5%A4%9A%E6%A0%B8%E5%92%8C%E9%94%81/ class=md-nav__link> <span class=md-ellipsis> 6 多核和锁 </span> </a> </li> <li class=md-nav__item> <a href=../../6.s081/7-%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2/ class=md-nav__link> <span class=md-ellipsis> 7 进程切换 </span> </a> </li> <li class=md-nav__item> <a href=../../6.s081/8-%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92/ class=md-nav__link> <span class=md-ellipsis> 8 睡眠和唤醒 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_9> <label class=md-nav__link for=__nav_2_9 id=__nav_2_9_label tabindex=0> <span class=md-ellipsis> C++ Primer </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_9_label aria-expanded=false> <label class=md-nav__title for=__nav_2_9> <span class="md-nav__icon md-icon"></span> C++ Primer </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/ class=md-nav__link> <span class=md-ellipsis> 2_变量和基本类型 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/ class=md-nav__link> <span class=md-ellipsis> 3_字符串向量数组 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/ class=md-nav__link> <span class=md-ellipsis> 4_表达式 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/ class=md-nav__link> <span class=md-ellipsis> 5_语句 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/ class=md-nav__link> <span class=md-ellipsis> 6_函数 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/7_%E7%B1%BB/ class=md-nav__link> <span class=md-ellipsis> 7_类 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/8_IO%E5%BA%93/ class=md-nav__link> <span class=md-ellipsis> 8_IO库 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/ class=md-nav__link> <span class=md-ellipsis> 9_顺序容器 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 10_泛型算法 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/ class=md-nav__link> <span class=md-ellipsis> 11_关联容器 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/ class=md-nav__link> <span class=md-ellipsis> 12_动态内存 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/ class=md-nav__link> <span class=md-ellipsis> 13_拷贝控制 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/ class=md-nav__link> <span class=md-ellipsis> 14_重载运算和类型转换 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/15_%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/ class=md-nav__link> <span class=md-ellipsis> 15_面向对象程序设计 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 并发与多线程编程 </span> </a> </li> <li class=md-nav__item> <a href=../../c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/ class=md-nav__link> <span class=md-ellipsis> Makefile学习 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_10> <label class=md-nav__link for=__nav_2_10 id=__nav_2_10_label tabindex=0> <span class=md-ellipsis> C++ 新特性 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_10_label aria-expanded=false> <label class=md-nav__title for=__nav_2_10> <span class="md-nav__icon md-icon"></span> C++ 新特性 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../C%2B%2B/1-Container/ class=md-nav__link> <span class=md-ellipsis> 1-Container </span> </a> </li> <li class=md-nav__item> <a href=../../C%2B%2B/2-Algorithm/ class=md-nav__link> <span class=md-ellipsis> 2-Algorithm </span> </a> </li> <li class=md-nav__item> <a href=../../C%2B%2B/3-Iterator/ class=md-nav__link> <span class=md-ellipsis> 3-Iterator </span> </a> </li> <li class=md-nav__item> <a href=../../C++/4-FileSystem.md class=md-nav__link> <span class=md-ellipsis> 4-FileSystem </span> </a> </li> <li class=md-nav__item> <a href=../../C%2B%2B/5-View/ class=md-nav__link> <span class=md-ellipsis> 5-View </span> </a> </li> <li class=md-nav__item> <a href=../../C%2B%2B/6-Span/ class=md-nav__link> <span class=md-ellipsis> 6-Span </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_11> <label class=md-nav__link for=__nav_2_11 id=__nav_2_11_label tabindex=0> <span class=md-ellipsis> C++ Concurrency in Action </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_11_label aria-expanded=false> <label class=md-nav__title for=__nav_2_11> <span class="md-nav__icon md-icon"></span> C++ Concurrency in Action </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../C%2B%2BConcurrency/1-thread/ class=md-nav__link> <span class=md-ellipsis> 1-Thread </span> </a> </li> <li class=md-nav__item> <a href=../../C%2B%2BConcurrency/2-Memory%20Model/ class=md-nav__link> <span class=md-ellipsis> 2-Memory Model in C++ </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_12> <label class=md-nav__link for=__nav_2_12 id=__nav_2_12_label tabindex=0> <span class=md-ellipsis> CMU15445 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_12_label aria-expanded=false> <label class=md-nav__title for=__nav_2_12> <span class="md-nav__icon md-icon"></span> CMU15445 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CMU15445/3-Database%20Storage/ class=md-nav__link> <span class=md-ellipsis> 3-Database Storage </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/4-Database_Storage_II/ class=md-nav__link> <span class=md-ellipsis> 4-Database_Storage_II </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/5-Buffer%20Pool/ class=md-nav__link> <span class=md-ellipsis> 5-Buffer Pool </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/6-Hash%20Table/ class=md-nav__link> <span class=md-ellipsis> 6-Hash Table </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/7-B%2BTree/ class=md-nav__link> <span class=md-ellipsis> 7-B+Tree </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/8-Index%20Concurrency/ class=md-nav__link> <span class=md-ellipsis> 8-Index Concurrency </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/9-Sort%26Aggregation/ class=md-nav__link> <span class=md-ellipsis> 9-Sort&amp;Aggregation </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/10-Join%20Algorithm/ class=md-nav__link> <span class=md-ellipsis> 10-Join Algorithm </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/11-Query_Execution/ class=md-nav__link> <span class=md-ellipsis> 11-Query_Execution </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/12-Query_Plan%26Optimization/ class=md-nav__link> <span class=md-ellipsis> 12-Query_Plan&amp;Optimization </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/13-Concurrency_Control_Theory/ class=md-nav__link> <span class=md-ellipsis> 13-Concurrency_Control_Theory </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/14-Two_Phase_Lock/ class=md-nav__link> <span class=md-ellipsis> 14-Two_Phase_Lock </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/15-Timestamp_Ordering_Concurrency/ class=md-nav__link> <span class=md-ellipsis> 15-Timestamp_Ordering_Concurrency </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/16-Mult-Version_Concurrency/ class=md-nav__link> <span class=md-ellipsis> 16-Mult-Version_Concurrency </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/17-Database_Logging/ class=md-nav__link> <span class=md-ellipsis> 17-Database_Logging </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/18-Database_Recovery/ class=md-nav__link> <span class=md-ellipsis> 18-Database_Recovery </span> </a> </li> <li class=md-nav__item> <a href=../../CMU15445/19-Introducd_to_distributed_database/ class=md-nav__link> <span class=md-ellipsis> 19-Introducd_to_distributed_database </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_13> <label class=md-nav__link for=__nav_2_13 id=__nav_2_13_label tabindex=0> <span class=md-ellipsis> 6.824 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_13_label aria-expanded=false> <label class=md-nav__title for=__nav_2_13> <span class="md-nav__icon md-icon"></span> 6.824 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../6.824/MapReduce/ class=md-nav__link> <span class=md-ellipsis> MapReduce 论文阅读 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_14> <label class=md-nav__link for=__nav_2_14 id=__nav_2_14_label tabindex=0> <span class=md-ellipsis> Linux Tools </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_14_label aria-expanded=false> <label class=md-nav__title for=__nav_2_14> <span class="md-nav__icon md-icon"></span> Linux Tools </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../linux%20tools/1-grep/ class=md-nav__link> <span class=md-ellipsis> grep </span> </a> </li> <li class=md-nav__item> <a href=../../linux%20tools/2-sed/ class=md-nav__link> <span class=md-ellipsis> sed </span> </a> </li> <li class=md-nav__item> <a href=../../linux%20tools/3-awk/ class=md-nav__link> <span class=md-ellipsis> awk </span> </a> </li> <li class=md-nav__item> <a href=../../linux%20tools/4-find/ class=md-nav__link> <span class=md-ellipsis> find </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../../../paperreadings/ class="md-nav__link "> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M384 512H96c-53 0-96-43-96-96V96C0 43 43 0 96 0h304c26.5 0 48 21.5 48 48v288c0 20.9-13.4 38.7-32 45.3V448c17.7 0 32 14.3 32 32s-14.3 32-32 32zM96 384c-17.7 0-32 14.3-32 32s14.3 32 32 32h256v-64zm32-232c0 13.3 10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24H152c-13.3 0-24 10.7-24 24m24 72c-13.3 0-24 10.7-24 24s10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24z"></path></svg> <span class=md-ellipsis> PaperReading </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> PaperReading </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> Database Systems </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Database Systems </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../paperreadings/db/storage/NoMMAP/ class=md-nav__link> <span class=md-ellipsis> Do not use MMAP in DBMS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> Vector Search </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Vector Search </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../paperreadings/vector%20search/IQAN/ class=md-nav__link> <span class=md-ellipsis> IQAN </span> </a> </li> <li class=md-nav__item> <a href=../../../paperreadings/vector%20search/MIRAGE-ANNS/ class=md-nav__link> <span class=md-ellipsis> MIRAGE-ANNS </span> </a> </li> <li class=md-nav__item> <a href=../../../paperreadings/vector%20search/LSM-VEC/ class=md-nav__link> <span class=md-ellipsis> LSM-VEC </span> </a> </li> <li class=md-nav__item> <a href=../../../paperreadings/vector%20search/PANNS/ class=md-nav__link> <span class=md-ellipsis> PANNS </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class=md-ellipsis> Active SLAM </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Active SLAM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../paperreadings/activeslam/PL-VINS/ class=md-nav__link> <span class=md-ellipsis> PL-VINS </span> </a> </li> <li class=md-nav__item> <a href=../../../paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/ class=md-nav__link> <span class=md-ellipsis> 3D Active Metric-Semantic SLAM </span> </a> </li> <li class=md-nav__item> <a href=../../../paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/ class=md-nav__link> <span class=md-ellipsis> Exploration with Global Consistency Using Real-Time Re-integration and Active Loop Closure </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <div class="md-nav__link md-nav__container"> <a href=../../../blogs/ class="md-nav__link "> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M224 24c0-13.3 10.7-24 24-24 145.8 0 264 118.2 264 264 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-119.3-96.7-216-216-216-13.3 0-24-10.7-24-24M80 96c26.5 0 48 21.5 48 48v224c0 26.5 21.5 48 48 48s48-21.5 48-48-21.5-48-48-48c-8.8 0-16-7.2-16-16v-64c0-8.8 7.2-16 16-16 79.5 0 144 64.5 144 144s-64.5 144-144 144S32 447.5 32 368V144c0-26.5 21.5-48 48-48m168 0c92.8 0 168 75.2 168 168 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-66.3-53.7-120-120-120-13.3 0-24-10.7-24-24s10.7-24 24-24"></path></svg> <span class=md-ellipsis> Blogs </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Blogs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2 checked> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> SGLang 专题 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=true> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> SGLang 专题 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/ class=md-nav__link> <span class=md-ellipsis> 一条 Request 在 SGLang 的前世今生 </span> </a> </li> <li class=md-nav__item> <a href=../SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/ class=md-nav__link> <span class=md-ellipsis> SGLang Schedular 技术变迁 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> SGLang Scheduler Evolution </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> SGLang Scheduler Evolution </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#key-structure class=md-nav__link> <span class=md-ellipsis> Key Structure </span> </a> <nav class=md-nav aria-label="Key Structure"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#scheduler class=md-nav__link> <span class=md-ellipsis> Scheduler </span> </a> <nav class=md-nav aria-label=Scheduler> <ul class=md-nav__list> <li class=md-nav__item> <a href=#waiting_queue class=md-nav__link> <span class=md-ellipsis> waiting_queue </span> </a> </li> <li class=md-nav__item> <a href=#new_batch class=md-nav__link> <span class=md-ellipsis> new_batch </span> </a> </li> <li class=md-nav__item> <a href=#running_batch class=md-nav__link> <span class=md-ellipsis> running_batch </span> </a> </li> <li class=md-nav__item> <a href=#cur_batch class=md-nav__link> <span class=md-ellipsis> cur_batch </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#three-important-batches class=md-nav__link> <span class=md-ellipsis> Three Important Batches </span> </a> <nav class=md-nav aria-label="Three Important Batches"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#schedulebatch class=md-nav__link> <span class=md-ellipsis> ScheduleBatch </span> </a> </li> <li class=md-nav__item> <a href=#modelworkerbatch class=md-nav__link> <span class=md-ellipsis> ModelWorkerBatch </span> </a> </li> <li class=md-nav__item> <a href=#forwardbatch class=md-nav__link> <span class=md-ellipsis> ForwardBatch </span> </a> </li> <li class=md-nav__item> <a href=#batch-transformation class=md-nav__link> <span class=md-ellipsis> Batch Transformation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#cache class=md-nav__link> <span class=md-ellipsis> Cache </span> </a> <nav class=md-nav aria-label=Cache> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reqtotokenpool class=md-nav__link> <span class=md-ellipsis> ReqToTokenPool </span> </a> </li> <li class=md-nav__item> <a href=#token_to_kv_pool class=md-nav__link> <span class=md-ellipsis> token_to_kv_pool </span> </a> </li> <li class=md-nav__item> <a href=#tree-cache class=md-nav__link> <span class=md-ellipsis> Tree Cache </span> </a> </li> <li class=md-nav__item> <a href=#relationship class=md-nav__link> <span class=md-ellipsis> Relationship </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#prefilladder class=md-nav__link> <span class=md-ellipsis> PrefillAdder </span> </a> </li> <li class=md-nav__item> <a href=#generationbatchresult class=md-nav__link> <span class=md-ellipsis> GenerationBatchResult </span> </a> <nav class=md-nav aria-label=GenerationBatchResult> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-logits_output-optionallogitsprocessoroutput class=md-nav__link> <span class=md-ellipsis> 1. logits_output: Optional[LogitsProcessorOutput] </span> </a> </li> <li class=md-nav__item> <a href=#2-next_token_ids-optionaltorchtensor class=md-nav__link> <span class=md-ellipsis> 2. next_token_ids: Optional[torch.Tensor] </span> </a> </li> <li class=md-nav__item> <a href=#3-num_accepted_tokens-optionalint class=md-nav__link> <span class=md-ellipsis> 3. num_accepted_tokens: Optional[int] </span> </a> </li> <li class=md-nav__item> <a href=#4-next_draft_input-optionaleagledraftinput class=md-nav__link> <span class=md-ellipsis> 4. next_draft_input: Optional[EagleDraftInput] </span> </a> </li> <li class=md-nav__item> <a href=#5-extend_input_len_per_req-optionallistint class=md-nav__link> <span class=md-ellipsis> 5. extend_input_len_per_req: Optional[List[int]] </span> </a> </li> <li class=md-nav__item> <a href=#6-extend_logprob_start_len_per_req-optionallistint class=md-nav__link> <span class=md-ellipsis> 6. extend_logprob_start_len_per_req: Optional[List[int]] </span> </a> </li> <li class=md-nav__item> <a href=#7-copy_done-optionaltorchcudaevent class=md-nav__link> <span class=md-ellipsis> 7. copy_done: Optional[torch.cuda.Event] </span> </a> </li> <li class=md-nav__item> <a href=#8-delay_sample_func-optionalcallable class=md-nav__link> <span class=md-ellipsis> 8. delay_sample_func: Optional[callable] </span> </a> </li> <li class=md-nav__item> <a href=#9-future_indices-optionalfutureindices class=md-nav__link> <span class=md-ellipsis> 9. future_indices: Optional[FutureIndices] </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#normal-no-overlap class=md-nav__link> <span class=md-ellipsis> Normal (No overlap) </span> </a> <nav class=md-nav aria-label="Normal (No overlap)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_1 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> <nav class=md-nav aria-label=Overview> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pre-schedule class=md-nav__link> <span class=md-ellipsis> Pre Schedule </span> </a> </li> <li class=md-nav__item> <a href=#compute-batch class=md-nav__link> <span class=md-ellipsis> Compute batch </span> </a> </li> <li class=md-nav__item> <a href=#sample class=md-nav__link> <span class=md-ellipsis> Sample </span> </a> </li> <li class=md-nav__item> <a href=#post-schedule class=md-nav__link> <span class=md-ellipsis> Post Schedule </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#event-loop class=md-nav__link> <span class=md-ellipsis> Event Loop </span> </a> </li> <li class=md-nav__item> <a href=#pre-schedule_1 class=md-nav__link> <span class=md-ellipsis> Pre Schedule </span> </a> <nav class=md-nav aria-label="Pre Schedule"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#req-waiting_queue class=md-nav__link> <span class=md-ellipsis> Req -&gt; Waiting_queue </span> </a> </li> <li class=md-nav__item> <a href=#waiting_queuerunning_batch-cur_batch class=md-nav__link> <span class=md-ellipsis> Waiting_queue/running_batch -&gt; cur_batch </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#compute-batch-sample class=md-nav__link> <span class=md-ellipsis> Compute Batch &amp; Sample </span> </a> </li> <li class=md-nav__item> <a href=#post-schedule_1 class=md-nav__link> <span class=md-ellipsis> Post Schedule </span> </a> <nav class=md-nav aria-label="Post Schedule"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prefill class=md-nav__link> <span class=md-ellipsis> Prefill </span> </a> </li> <li class=md-nav__item> <a href=#decode class=md-nav__link> <span class=md-ellipsis> Decode </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#why-overlap class=md-nav__link> <span class=md-ellipsis> Why Overlap? </span> </a> </li> <li class=md-nav__item> <a href=#zero-overhead-scheduling-overlap class=md-nav__link> <span class=md-ellipsis> Zero-Overhead Scheduling (Overlap) </span> </a> <nav class=md-nav aria-label="Zero-Overhead Scheduling (Overlap)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#principle class=md-nav__link> <span class=md-ellipsis> Principle </span> </a> <nav class=md-nav aria-label=Principle> <ul class=md-nav__list> <li class=md-nav__item> <a href=#inference-overview class=md-nav__link> <span class=md-ellipsis> Inference Overview </span> </a> </li> <li class=md-nav__item> <a href=#overlap-overview class=md-nav__link> <span class=md-ellipsis> Overlap Overview </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#init-overlap class=md-nav__link> <span class=md-ellipsis> Init Overlap </span> </a> <nav class=md-nav aria-label="Init Overlap"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#futuremap class=md-nav__link> <span class=md-ellipsis> FutureMap </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#overlap-event-loop class=md-nav__link> <span class=md-ellipsis> Overlap Event Loop </span> </a> <nav class=md-nav aria-label="Overlap Event Loop"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#differences-from-normal-event-loop class=md-nav__link> <span class=md-ellipsis> Differences from normal event loop </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stream-synchronization class=md-nav__link> <span class=md-ellipsis> Stream Synchronization </span> </a> </li> <li class=md-nav__item> <a href=#differences-from-previous-overlap-version class=md-nav__link> <span class=md-ellipsis> Differences from previous overlap version </span> </a> <nav class=md-nav aria-label="Differences from previous overlap version"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pros-and-cons-of-the-two-versions class=md-nav__link> <span class=md-ellipsis> Pros and Cons of the Two Versions </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reference class=md-nav__link> <span class=md-ellipsis> Reference </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/ class=md-nav__link> <span class=md-ellipsis> RadixAttention 你需要知道的细节 </span> </a> </li> <li class=md-nav__item> <a href=../DP%20Attention/ class=md-nav__link> <span class=md-ellipsis> DP Attention </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/ class=md-nav__link> <span class=md-ellipsis> 从代码看 SGLang 的 KV Cache </span> </a> </li> <li class=md-nav__item> <a href=../SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/ class=md-nav__link> <span class=md-ellipsis> 🚧 SGLang 中的 Speculative Decoding </span> </a> </li> <li class=md-nav__item> <a href="../../sgalng/SGLang 中的并行.md" class=md-nav__link> <span class=md-ellipsis> 🚧 SGLang 中的并行 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> LLM Inference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> LLM Inference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../llm_inference/attention%26transformer/ class=md-nav__link> <span class=md-ellipsis> Attention &amp; Transformers </span> </a> </li> <li class=md-nav__item> <a href=../../llm_inference/transformerbasedllm/ class=md-nav__link> <span class=md-ellipsis> Transformer-Based LLM Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/llm_inference/Introduction.md class=md-nav__link> <span class=md-ellipsis> Introduction for LLM Inference </span> </a> </li> <li class=md-nav__item> <a href=../../llm_inference/parallelization/ class=md-nav__link> <span class=md-ellipsis> Parallelizatoin Concepts </span> </a> </li> <li class=md-nav__item> <a href=../../llm_inference/LLMparallelization/ class=md-nav__link> <span class=md-ellipsis> Parallelization in LLM Inference </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/PageAttention/ class=md-nav__link> <span class=md-ellipsis> PageAttention </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/ class=md-nav__link> <span class=md-ellipsis> FlashAttention </span> </a> </li> <li class=md-nav__item> <a href=../%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/ class=md-nav__link> <span class=md-ellipsis> 大模型推理服务中的 Batching </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> <span class=md-ellipsis> CUDA </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> CUDA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/ class=md-nav__link> <span class=md-ellipsis> GPU 内存系统演进 </span> </a> </li> <li class=md-nav__item> <a href=../../cuda/cudaopt/ class=md-nav__link> <span class=md-ellipsis> CUDA Optimization for LLM Inference </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/Vector%20Add%20Optimization%20Example/ class=md-nav__link> <span class=md-ellipsis> Vector Add Optimization Example </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/ class=md-nav__link> <span class=md-ellipsis> 上篇：初识 Nebula Graph —— 向量类型支持 </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/ class=md-nav__link> <span class=md-ellipsis> 中篇：Vector 类型的 DDL &amp; DML 适配 </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/ class=md-nav__link> <span class=md-ellipsis> 下篇：向量索引与相似度搜索 —— Nebula Graph 的 ANN 实现之路 </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/bision%20debug/ class=md-nav__link> <span class=md-ellipsis> bision debug </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/ class=md-nav__link> <span class=md-ellipsis> C++ 异步方案演进 </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/ class=md-nav__link> <span class=md-ellipsis> Bustub 通关指北 </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/Implement%20of%20Concurrent/ class=md-nav__link> <span class=md-ellipsis> 并发组件实现浅析 </span> </a> </li> <li class=md-nav__item> <a href=../../../blogs/posts/CS144/ class=md-nav__link> <span class=md-ellipsis> 实现一个TCP </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <div class="md-nav__link md-nav__container"> <a href=../../../summary/ class="md-nav__link "> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6 1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1zM5 8v11h14V8zm2 2h10v2H7z"></path></svg> <span class=md-ellipsis> Summaries </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Summaries </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> plan </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> plan </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../summary/2025/semester-plan/ class=md-nav__link> <span class=md-ellipsis> 研一下规划 </span> </a> </li> <li class=md-nav__item> <a href="../../../summary/2025/LLM 推理系统技能图谱.md" class=md-nav__link> <span class=md-ellipsis> 大模型技能掌握 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> <span class=md-ellipsis> 研究生总结 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> 研究生总结 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../summary/%E7%A0%94%E7%A9%B6%E7%94%9F%E6%80%BB%E7%BB%93/%E7%A0%94%E4%B8%80%E4%B8%8A%E6%80%BB%E7%BB%93/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6 1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1zM5 8v11h14V8zm2 2h10v2H7z"></path></svg> <span class=md-ellipsis> 研一上总结 </span> </a> </li> <li class=md-nav__item> <a href=../../../summary/%E7%A0%94%E7%A9%B6%E7%94%9F%E6%80%BB%E7%BB%93/%E7%A0%94%E4%B8%80%E4%B8%8B%E6%80%BB%E7%BB%93/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6 1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1zM5 8v11h14V8zm2 2h10v2H7z"></path></svg> <span class=md-ellipsis> 研一下总结 </span> </a> </li> <li class=md-nav__item> <a href=../../../summary/%E7%A0%94%E7%A9%B6%E7%94%9F%E6%80%BB%E7%BB%93/%E7%A0%94%E4%BA%8C%E4%B8%8A%E6%80%BB%E7%BB%93/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M6 1h2v2h8V1h2v2h1a2 2 0 0 1 2 2v14c0 1.11-.89 2-2 2H5a2 2 0 0 1-2-2V5c0-1.11.89-2 2-2h1zM5 8v11h14V8zm2 2h10v2H7z"></path></svg> <span class=md-ellipsis> 研二上总结 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../tags/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5.5 7A1.5 1.5 0 0 1 4 5.5 1.5 1.5 0 0 1 5.5 4 1.5 1.5 0 0 1 7 5.5 1.5 1.5 0 0 1 5.5 7m15.91 4.58-9-9C12.05 2.22 11.55 2 11 2H4c-1.11 0-2 .89-2 2v7c0 .55.22 1.05.59 1.41l8.99 9c.37.36.87.59 1.42.59s1.05-.23 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.56-.23-1.06-.59-1.42"></path></svg> <span class=md-ellipsis> Tags </span> </a> </li> <li class=md-nav__item> <a href=../../../links/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.78 3.653a3.936 3.936 0 1 1 5.567 5.567l-3.627 3.627a3.936 3.936 0 0 1-5.88-.353.75.75 0 0 0-1.18.928 5.436 5.436 0 0 0 8.12.486l3.628-3.628a5.436 5.436 0 1 0-7.688-7.688l-3 3a.75.75 0 0 0 1.06 1.061z"></path><path d="M7.28 11.153a3.936 3.936 0 0 1 5.88.353.75.75 0 0 0 1.18-.928 5.436 5.436 0 0 0-8.12-.486L2.592 13.72a5.436 5.436 0 1 0 7.688 7.688l3-3a.75.75 0 1 0-1.06-1.06l-3 3a3.936 3.936 0 0 1-5.567-5.568z"></path></svg> <span class=md-ellipsis> Links </span> </a> </li> <li class=md-nav__item> <a href=../../../about/ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M256 512a256 256 0 1 0 0-512 256 256 0 1 0 0 512m-90.6-190.1c20.4 28 53.4 46.1 90.6 46.1s70.2-18.1 90.6-46.1c7.8-10.7 22.8-13.1 33.5-5.3s13.1 22.8 5.3 33.5C356.3 390 309.2 416 256 416s-100.3-26-129.4-65.9c-7.8-10.7-5.4-25.7 5.3-33.5s25.7-5.4 33.5 5.3M144 208a32 32 0 1 1 64 0 32 32 0 1 1-64 0m164 8c0 11-9 20-20 20s-20-9-20-20c0-33.1 26.9-60 60-60h16c33.1 0 60 26.9 60 60 0 11-9 20-20 20s-20-9-20-20-9-20-20-20h-16c-11 0-20 9-20 20"></path></svg> <span class=md-ellipsis> About </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#key-structure class=md-nav__link> <span class=md-ellipsis> Key Structure </span> </a> <nav class=md-nav aria-label="Key Structure"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#scheduler class=md-nav__link> <span class=md-ellipsis> Scheduler </span> </a> <nav class=md-nav aria-label=Scheduler> <ul class=md-nav__list> <li class=md-nav__item> <a href=#waiting_queue class=md-nav__link> <span class=md-ellipsis> waiting_queue </span> </a> </li> <li class=md-nav__item> <a href=#new_batch class=md-nav__link> <span class=md-ellipsis> new_batch </span> </a> </li> <li class=md-nav__item> <a href=#running_batch class=md-nav__link> <span class=md-ellipsis> running_batch </span> </a> </li> <li class=md-nav__item> <a href=#cur_batch class=md-nav__link> <span class=md-ellipsis> cur_batch </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#three-important-batches class=md-nav__link> <span class=md-ellipsis> Three Important Batches </span> </a> <nav class=md-nav aria-label="Three Important Batches"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#schedulebatch class=md-nav__link> <span class=md-ellipsis> ScheduleBatch </span> </a> </li> <li class=md-nav__item> <a href=#modelworkerbatch class=md-nav__link> <span class=md-ellipsis> ModelWorkerBatch </span> </a> </li> <li class=md-nav__item> <a href=#forwardbatch class=md-nav__link> <span class=md-ellipsis> ForwardBatch </span> </a> </li> <li class=md-nav__item> <a href=#batch-transformation class=md-nav__link> <span class=md-ellipsis> Batch Transformation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#cache class=md-nav__link> <span class=md-ellipsis> Cache </span> </a> <nav class=md-nav aria-label=Cache> <ul class=md-nav__list> <li class=md-nav__item> <a href=#reqtotokenpool class=md-nav__link> <span class=md-ellipsis> ReqToTokenPool </span> </a> </li> <li class=md-nav__item> <a href=#token_to_kv_pool class=md-nav__link> <span class=md-ellipsis> token_to_kv_pool </span> </a> </li> <li class=md-nav__item> <a href=#tree-cache class=md-nav__link> <span class=md-ellipsis> Tree Cache </span> </a> </li> <li class=md-nav__item> <a href=#relationship class=md-nav__link> <span class=md-ellipsis> Relationship </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#prefilladder class=md-nav__link> <span class=md-ellipsis> PrefillAdder </span> </a> </li> <li class=md-nav__item> <a href=#generationbatchresult class=md-nav__link> <span class=md-ellipsis> GenerationBatchResult </span> </a> <nav class=md-nav aria-label=GenerationBatchResult> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-logits_output-optionallogitsprocessoroutput class=md-nav__link> <span class=md-ellipsis> 1. logits_output: Optional[LogitsProcessorOutput] </span> </a> </li> <li class=md-nav__item> <a href=#2-next_token_ids-optionaltorchtensor class=md-nav__link> <span class=md-ellipsis> 2. next_token_ids: Optional[torch.Tensor] </span> </a> </li> <li class=md-nav__item> <a href=#3-num_accepted_tokens-optionalint class=md-nav__link> <span class=md-ellipsis> 3. num_accepted_tokens: Optional[int] </span> </a> </li> <li class=md-nav__item> <a href=#4-next_draft_input-optionaleagledraftinput class=md-nav__link> <span class=md-ellipsis> 4. next_draft_input: Optional[EagleDraftInput] </span> </a> </li> <li class=md-nav__item> <a href=#5-extend_input_len_per_req-optionallistint class=md-nav__link> <span class=md-ellipsis> 5. extend_input_len_per_req: Optional[List[int]] </span> </a> </li> <li class=md-nav__item> <a href=#6-extend_logprob_start_len_per_req-optionallistint class=md-nav__link> <span class=md-ellipsis> 6. extend_logprob_start_len_per_req: Optional[List[int]] </span> </a> </li> <li class=md-nav__item> <a href=#7-copy_done-optionaltorchcudaevent class=md-nav__link> <span class=md-ellipsis> 7. copy_done: Optional[torch.cuda.Event] </span> </a> </li> <li class=md-nav__item> <a href=#8-delay_sample_func-optionalcallable class=md-nav__link> <span class=md-ellipsis> 8. delay_sample_func: Optional[callable] </span> </a> </li> <li class=md-nav__item> <a href=#9-future_indices-optionalfutureindices class=md-nav__link> <span class=md-ellipsis> 9. future_indices: Optional[FutureIndices] </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#normal-no-overlap class=md-nav__link> <span class=md-ellipsis> Normal (No overlap) </span> </a> <nav class=md-nav aria-label="Normal (No overlap)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview_1 class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> <nav class=md-nav aria-label=Overview> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pre-schedule class=md-nav__link> <span class=md-ellipsis> Pre Schedule </span> </a> </li> <li class=md-nav__item> <a href=#compute-batch class=md-nav__link> <span class=md-ellipsis> Compute batch </span> </a> </li> <li class=md-nav__item> <a href=#sample class=md-nav__link> <span class=md-ellipsis> Sample </span> </a> </li> <li class=md-nav__item> <a href=#post-schedule class=md-nav__link> <span class=md-ellipsis> Post Schedule </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#event-loop class=md-nav__link> <span class=md-ellipsis> Event Loop </span> </a> </li> <li class=md-nav__item> <a href=#pre-schedule_1 class=md-nav__link> <span class=md-ellipsis> Pre Schedule </span> </a> <nav class=md-nav aria-label="Pre Schedule"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#req-waiting_queue class=md-nav__link> <span class=md-ellipsis> Req -&gt; Waiting_queue </span> </a> </li> <li class=md-nav__item> <a href=#waiting_queuerunning_batch-cur_batch class=md-nav__link> <span class=md-ellipsis> Waiting_queue/running_batch -&gt; cur_batch </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#compute-batch-sample class=md-nav__link> <span class=md-ellipsis> Compute Batch &amp; Sample </span> </a> </li> <li class=md-nav__item> <a href=#post-schedule_1 class=md-nav__link> <span class=md-ellipsis> Post Schedule </span> </a> <nav class=md-nav aria-label="Post Schedule"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prefill class=md-nav__link> <span class=md-ellipsis> Prefill </span> </a> </li> <li class=md-nav__item> <a href=#decode class=md-nav__link> <span class=md-ellipsis> Decode </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#why-overlap class=md-nav__link> <span class=md-ellipsis> Why Overlap? </span> </a> </li> <li class=md-nav__item> <a href=#zero-overhead-scheduling-overlap class=md-nav__link> <span class=md-ellipsis> Zero-Overhead Scheduling (Overlap) </span> </a> <nav class=md-nav aria-label="Zero-Overhead Scheduling (Overlap)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#principle class=md-nav__link> <span class=md-ellipsis> Principle </span> </a> <nav class=md-nav aria-label=Principle> <ul class=md-nav__list> <li class=md-nav__item> <a href=#inference-overview class=md-nav__link> <span class=md-ellipsis> Inference Overview </span> </a> </li> <li class=md-nav__item> <a href=#overlap-overview class=md-nav__link> <span class=md-ellipsis> Overlap Overview </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#init-overlap class=md-nav__link> <span class=md-ellipsis> Init Overlap </span> </a> <nav class=md-nav aria-label="Init Overlap"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#futuremap class=md-nav__link> <span class=md-ellipsis> FutureMap </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#overlap-event-loop class=md-nav__link> <span class=md-ellipsis> Overlap Event Loop </span> </a> <nav class=md-nav aria-label="Overlap Event Loop"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#differences-from-normal-event-loop class=md-nav__link> <span class=md-ellipsis> Differences from normal event loop </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#stream-synchronization class=md-nav__link> <span class=md-ellipsis> Stream Synchronization </span> </a> </li> <li class=md-nav__item> <a href=#differences-from-previous-overlap-version class=md-nav__link> <span class=md-ellipsis> Differences from previous overlap version </span> </a> <nav class=md-nav aria-label="Differences from previous overlap version"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pros-and-cons-of-the-two-versions class=md-nav__link> <span class=md-ellipsis> Pros and Cons of the Two Versions </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reference class=md-nav__link> <span class=md-ellipsis> Reference </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <nav class=md-path aria-label=Navigation> <ol class=md-path__list> <li class=md-path__item> <a href=../../.. class=md-path__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-path__item> <a href=../../../blogs/ class=md-path__link> <span class=md-ellipsis> Blogs </span> </a> </li> <li class=md-path__item> <a href=../%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/ class=md-path__link> <span class=md-ellipsis> SGLang 专题 </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <div class="document-dates-plugin-wrapper document-dates-top"><div class=document-dates-plugin locale><span data-tippy-content data-tippy-raw=2025-12-02><span class=material-icons data-icon=doc_created></span><time datetime=2025-12-02T16:15:41+08:00>2025-12-02</time></span><span data-tippy-content data-tippy-raw=2025-12-02><span class=material-icons data-icon=doc_modified></span><time datetime=2025-12-02T08:15:41+00:00>2025-12-02</time></span><span class=material-icons data-icon=doc_author></span><div class=avatar-group><div class=avatar-wrapper data-name="Zhi Yiliu" data-tippy-content data-tippy-raw='<a href="mailto:2584074296@qq.com">Zhi Yiliu</a>'><span class=avatar-text></span><a class=glightbox data-type=image data-width=80% data-height=auto href=https://avatars.githubusercontent.com/tom-jerr data-desc-position=bottom><img class=avatar src=https://avatars.githubusercontent.com/tom-jerr onerror="this.style.display='none'"></a></div></div></div></div> <div class=md-typeset> <div class=blogging-tags-grid> <a href=https://tom-jerr.github.io/tags#LLMInference class=blogging-tag><code>#LLMInference</code></a> </div> </div> <style>
    .md-typeset .blogging-tags-grid {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 5px;
    }

    .md-typeset .blogging-tag {
        color: var(--md-typeset-color);
        background-color: var(--md-typeset-code-color);
        white-space: nowrap;
        display: block;
    }

    .md-typeset .blogging-tag code {
        border-radius: 5px;
    }
</style> <h1 id=evolution-of-sglang-scheduler>Evolution of SGLang Scheduler<a class=headerlink href=#evolution-of-sglang-scheduler title="Permanent link">¶</a></h1> <div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;"> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"></path></svg></span> 约 3217 个字 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M360.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6m64.6 136.1c-12.5 12.5-12.5 32.8 0 45.3l73.4 73.4-73.4 73.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l96-96c12.5-12.5 12.5-32.8 0-45.3l-96-96c-12.5-12.5-32.8-12.5-45.3 0zm-274.7 0c-12.5-12.5-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3l96 96c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l73.3-73.4c12.5-12.5 12.5-32.8 0-45.3z"></path></svg></span> 286 行代码 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"></path></svg></span> 10 张图片 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"></path></svg></span> 预计阅读时间 20 分钟</p> </div> <ul> <li>Initially, the Scheduler operated with CPU and GPU in serial, leading to significant GPU idle time.</li> <li>Later versions of the Scheduler allowed for CPU and GPU overlap, achieving a zero-overhead scheduler.</li> </ul> <p>The overall workflow of the Scheduler is shown in the figure below: <sup id=fnref:code-walk><a class=footnote-ref href=#fn:code-walk>3</a></sup></p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=../img/sglang_scheduler.svg data-desc-position=bottom><img alt src=../img/sglang_scheduler.svg></a></p> <p>We will analyze the entire Scheduler process in conjunction with the code. However, before diving into the workflow, we first need to understand the key data structures in scheduling and how they transform into one another.</p> <h2 id=key-structure>Key Structure<a class=headerlink href=#key-structure title="Permanent link">¶</a></h2> <h3 id=scheduler>Scheduler<a class=headerlink href=#scheduler title="Permanent link">¶</a></h3> <p>The <code>Scheduler</code> component is responsible for managing Active Requests. The following core global data structures are used to maintain these Active Requests within the <code>Scheduler</code>.</p> <h4 id=waiting_queue><code>waiting_queue</code><a class=headerlink href=#waiting_queue title="Permanent link">¶</a></h4> <ul> <li><strong>Purpose:</strong> <code>waiting_queue</code> is a data structure designed to hold Active Requests. It dynamically reorders these requests based on priority (longest prefix of the Request) or available memory to optimize batch processing.</li> <li><strong>Additional Points</strong></li> <li><strong>Enqueue</strong><ul> <li>Newly arrived Requests.</li> <li>Requests returned from <code>retract_decode</code>.</li> </ul> </li> <li><strong>Dequeue</strong> The request with the highest current priority is dequeued to form a batch.</li> </ul> <h4 id=new_batch><code>new_batch</code><a class=headerlink href=#new_batch title="Permanent link">¶</a></h4> <ul> <li><strong>Purpose:</strong> Represents a batch of Requests ready for the prefill/extend phase.</li> <li><strong>Additional Points</strong></li> <li><strong>Chunked Prefill:</strong> If the number of tokens required by a Request exceeds available memory (<code>remaining_tokens</code>), it may be chunked into smaller parts.</li> <li>Requests in <code>new_batch</code> will undergo prefill/extend.</li> <li>After prefill/extend, <code>new_batch</code> will transition to the <strong>Global Batch</strong> for the next iteration.</li> </ul> <h4 id=running_batch><code>running_batch</code><a class=headerlink href=#running_batch title="Permanent link">¶</a></h4> <ul> <li><strong>Purpose:</strong> A batch of Requests ready for the decode phase.</li> <li>Initialized as an empty batch: <code>ScheduleBatch(reqs=[], batch_is_full=False)</code></li> <li>Can dynamically add newly prefilled requests.</li> <li>Can remove completed requests.</li> <li><strong>Additional Points</strong></li> <li><strong>Retracted:</strong> If available memory is insufficient during decode, the <code>Scheduler</code> may retract certain Requests from the <code>running_batch</code> via <code>retract_decode</code>, returning them to the <code>waiting_queue</code> for later processing.</li> </ul> <h4 id=cur_batch><code>cur_batch</code><a class=headerlink href=#cur_batch title="Permanent link">¶</a></h4> <ul> <li><strong>Purpose:</strong> The batch of Requests currently being processed in the <code>Scheduler</code> main loop (<code>run_batch</code> function). <strong><code>prefill</code> takes precedence.</strong></li> <li><strong>Additional Points</strong></li> <li><code>cur_batch</code> is assigned in <code>event_loop_normal</code>.</li> <li>The logic for forming <code>cur_batch</code> is:<ul> <li>If there are Requests ready for prefill (<code>new_batch</code>) in this round, <code>new_batch</code> is used as <code>cur_batch</code>.</li> <li>Otherwise, <code>cur_batch</code> will process Requests ready for decode, so <code>running_batch</code> is used as <code>cur_batch</code>.</li> </ul> </li> </ul> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=../img/batch.png data-desc-position=bottom><img alt src=../img/batch.png></a></p> <h3 id=three-important-batches>Three Important Batches<a class=headerlink href=#three-important-batches title="Permanent link">¶</a></h3> <h4 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">¶</a></h4> <ul> <li><code>ScheduleBatch</code> is managed by <code>schedule.py::Scheduler</code>. It contains high-level scheduling data, most of which resides on the CPU.</li> <li><code>ModelWorkerBatch</code> is managed by <code>tp_worker.py::TpModelWorker</code>. It is a subset of <code>ScheduleBatch</code>, containing only data relevant to model forward on the GPU, and it transitions from the CPU scheduler to the GPU model runner.</li> <li><code>ForwardBatch</code> is managed by <code>model_runner.py::ModelRunner</code> and contains <strong>low-level tensor data</strong>.</li> </ul> <h4 id=schedulebatch>ScheduleBatch<a class=headerlink href=#schedulebatch title="Permanent link">¶</a></h4> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ScheduleBatch</span><span class=p>:</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>reqs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Req</span><span class=p>]</span>  <span class=c1># List of requests</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3></a><a href=#__codelineno-0-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>req_to_token_pool</span><span class=p>:</span> <span class=n>ReqToTokenPool</span>  <span class=c1># Request to token mapping pool</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4></a><a href=#__codelineno-0-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>token_to_kv_pool_allocator</span><span class=p>:</span> <span class=n>BaseTokenToKVPoolAllocator</span>  <span class=c1># KV cache allocator</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5></a><a href=#__codelineno-0-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>tree_cache</span><span class=p>:</span> <span class=n>BasePrefixCache</span>  <span class=c1># Prefix cache tree</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6></a><a href=#__codelineno-0-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>forward_mode</span><span class=p>:</span> <span class=n>ForwardMode</span>  <span class=c1># Forward mode</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7></a><a href=#__codelineno-0-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8></a><a href=#__codelineno-0-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=c1># Batch related</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9></a><a href=#__codelineno-0-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>input_ids</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span>  <span class=c1># Input token IDs</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10></a><a href=#__codelineno-0-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>seq_lens</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span>  <span class=c1># Sequence lengths</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11></a><a href=#__codelineno-0-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>extend_lens</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span>  <span class=c1># Extend lengths (seq_len - prefix_len)</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12></a><a href=#__codelineno-0-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>prefix_lens</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span>  <span class=c1># Prefix lengths</span>
</span></code></pre></div> <h4 id=modelworkerbatch>ModelWorkerBatch<a class=headerlink href=#modelworkerbatch title="Permanent link">¶</a></h4> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ModelWorkerBatch</span><span class=p>:</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>forward_mode</span><span class=p>:</span> <span class=n>ForwardMode</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>input_ids</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span> <span class=c1># Input token IDs</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4></a><a href=#__codelineno-1-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>req_pool_indices</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span> <span class=c1># Indices of out_cache_loc corresponding to req</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5></a><a href=#__codelineno-1-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>seq_lens</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span> <span class=c1># Sequence lengths</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6></a><a href=#__codelineno-1-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>out_cache_loc</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span> <span class=c1># Allocated KV cache</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7></a><a href=#__codelineno-1-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8></a><a href=#__codelineno-1-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=c1># Extension related (seq - prefix)</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9></a><a href=#__codelineno-1-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>extend_num_tokens</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10></a><a href=#__codelineno-1-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>extend_seq_lens</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]]</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11></a><a href=#__codelineno-1-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>extend_prefix_lens</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]]</span>
</span></code></pre></div> <h4 id=forwardbatch>ForwardBatch<a class=headerlink href=#forwardbatch title="Permanent link">¶</a></h4> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ForwardBatch</span><span class=p>:</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>forward_mode</span><span class=p>:</span> <span class=n>ForwardMode</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4></a><a href=#__codelineno-2-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>input_ids</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5></a><a href=#__codelineno-2-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>seq_lens</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6></a><a href=#__codelineno-2-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>positions</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span>  <span class=c1># Position encoding</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7></a><a href=#__codelineno-2-7><span class=linenos data-linenos=" 7 "></span></a>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8></a><a href=#__codelineno-2-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=c1># Attention related</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9></a><a href=#__codelineno-2-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>attn_backend</span><span class=p>:</span> <span class=n>AttentionBackend</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10></a><a href=#__codelineno-2-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>token_to_kv_pool</span><span class=p>:</span> <span class=n>KVCache</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11></a><a href=#__codelineno-2-11><span class=linenos data-linenos="11 "></span></a>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12></a><a href=#__codelineno-2-12><span class=linenos data-linenos="12 "></span></a>    <span class=c1># Extension information (seq - prefix)</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13></a><a href=#__codelineno-2-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>extend_num_tokens</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14></a><a href=#__codelineno-2-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>extend_start_loc</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>]</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15></a><a href=#__codelineno-2-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>extend_prefix_lens</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>]</span>
</span></code></pre></div> <h4 id=batch-transformation>Batch Transformation<a class=headerlink href=#batch-transformation title="Permanent link">¶</a></h4> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># 1. Scheduler creates ScheduleBatch</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>def</span><span class=w> </span><span class=nf>run_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>batch</span><span class=p>:</span> <span class=n>ScheduleBatch</span><span class=p>):</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3></a><a href=#__codelineno-3-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=c1># 2. Convert to ModelWorkerBatch</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4></a><a href=#__codelineno-3-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>model_worker_batch</span> <span class=o>=</span> <span class=n>batch</span><span class=o>.</span><span class=n>get_model_worker_batch</span><span class=p>()</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5></a><a href=#__codelineno-3-5><span class=linenos data-linenos=" 5 "></span></a>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6></a><a href=#__codelineno-3-6><span class=linenos data-linenos=" 6 "></span></a><span class=c1># 3. TpModelWorker processing</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7></a><a href=#__codelineno-3-7><span class=linenos data-linenos=" 7 "></span></a><span class=k>def</span><span class=w> </span><span class=nf>forward_batch_generation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_worker_batch</span><span class=p>:</span> <span class=n>ModelWorkerBatch</span><span class=p>):</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8></a><a href=#__codelineno-3-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=c1># 4. Convert to ForwardBatch</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9></a><a href=#__codelineno-3-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>forward_batch</span> <span class=o>=</span> <span class=n>ForwardBatch</span><span class=o>.</span><span class=n>init_new</span><span class=p>(</span><span class=n>model_worker_batch</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_runner</span><span class=p>)</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10></a><a href=#__codelineno-3-10><span class=linenos data-linenos="10 "></span></a>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11></a><a href=#__codelineno-3-11><span class=linenos data-linenos="11 "></span></a>        <span class=c1># 5. ModelRunner executes forward pass</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12></a><a href=#__codelineno-3-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>logits_output</span><span class=p>,</span> <span class=n>can_run_cuda_graph</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_runner</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=n>forward_batch</span><span class=p>)</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13></a><a href=#__codelineno-3-13><span class=linenos data-linenos="13 "></span></a>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14></a><a href=#__codelineno-3-14><span class=linenos data-linenos="14 "></span></a>        <span class=c1># 6. Sample to generate token</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15></a><a href=#__codelineno-3-15><span class=linenos data-linenos="15 "></span></a>        <span class=n>next_token_ids</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_runner</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=n>logits_output</span><span class=p>,</span> <span class=n>forward_batch</span><span class=p>)</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16></a><a href=#__codelineno-3-16><span class=linenos data-linenos="16 "></span></a>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17></a><a href=#__codelineno-3-17><span class=linenos data-linenos="17 "></span></a>        <span class=k>return</span> <span class=n>GenerationBatchResult</span><span class=p>(</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18></a><a href=#__codelineno-3-18><span class=linenos data-linenos="18 "></span></a>            <span class=n>logits_output</span><span class=o>=</span><span class=n>logits_output</span><span class=p>,</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19></a><a href=#__codelineno-3-19><span class=linenos data-linenos="19 "></span></a>            <span class=n>next_token_ids</span><span class=o>=</span><span class=n>next_token_ids</span><span class=p>,</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20></a><a href=#__codelineno-3-20><span class=linenos data-linenos="20 "></span></a>            <span class=n>can_run_cuda_graph</span><span class=o>=</span><span class=n>can_run_cuda_graph</span><span class=p>,</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21></a><a href=#__codelineno-3-21><span class=linenos data-linenos="21 "></span></a>        <span class=p>)</span>
</span></code></pre></div> <h3 id=cache>Cache<a class=headerlink href=#cache title="Permanent link">¶</a></h3> <p>In SGLang, caching mainly involves three structures: <code>req_to_token_pool</code>, <code>token_to_kv_pool</code>, and <code>tree_cache</code>.</p> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>req_to_token_pool</span><span class=p>[</span><span class=n>req_idx</span><span class=p>]:</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos=" 2 "></span></a><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos=" 3 "></span></a><span class=err>│</span>  <span class=n>Prefix</span> <span class=n>Part</span> <span class=p>(</span><span class=mi>1984</span> <span class=n>tokens</span><span class=p>)</span>    <span class=err>│</span>    <span class=n>New</span> <span class=n>Chunk</span> <span class=n>Part</span> <span class=p>(</span><span class=mi>2000</span> <span class=n>tokens</span><span class=p>)</span>    <span class=err>│</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos=" 4 "></span></a><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos=" 5 "></span></a><span class=err>│</span> <span class=p>[</span><span class=n>loc_1</span><span class=p>,</span> <span class=n>loc_2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>loc_1984</span><span class=p>]</span> <span class=err>│</span> <span class=p>[</span><span class=n>loc_1985</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>loc_3984</span><span class=p>]</span> <span class=err>│</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6></a><a href=#__codelineno-4-6><span class=linenos data-linenos=" 6 "></span></a><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7></a><a href=#__codelineno-4-7><span class=linenos data-linenos=" 7 "></span></a><span class=n>Position</span><span class=p>:</span>  <span class=mi>0</span>                    <span class=mi>1984</span>                         <span class=mi>3984</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8></a><a href=#__codelineno-4-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9></a><a href=#__codelineno-4-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>KV</span> <span class=n>Cache</span> <span class=n>Pool</span><span class=p>:</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10></a><a href=#__codelineno-4-10><span class=linenos data-linenos="10 "></span></a><span class=err>┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11></a><a href=#__codelineno-4-11><span class=linenos data-linenos="11 "></span></a><span class=err>│</span><span class=n>loc_1</span> <span class=err>│</span><span class=n>loc_2</span> <span class=err>│</span> <span class=o>...</span> <span class=err>│</span><span class=n>loc_1984</span><span class=err>│</span><span class=n>loc_1985</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span><span class=n>loc_3984</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12></a><a href=#__codelineno-4-12><span class=linenos data-linenos="12 "></span></a><span class=err>├──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┤</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13></a><a href=#__codelineno-4-13><span class=linenos data-linenos="13 "></span></a><span class=err>│</span> <span class=n>k1</span><span class=p>,</span><span class=n>v1</span><span class=err>│</span> <span class=n>k2</span><span class=p>,</span><span class=n>v2</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span><span class=n>k1984</span><span class=p>,</span><span class=n>v1984</span><span class=err>│</span><span class=n>k1985</span><span class=p>,</span><span class=n>v1985</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span><span class=n>k3984</span><span class=p>,</span><span class=n>v3984</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14></a><a href=#__codelineno-4-14><span class=linenos data-linenos="14 "></span></a><span class=err>└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘</span>
</span></code></pre></div> <h4 id=reqtotokenpool>ReqToTokenPool<a class=headerlink href=#reqtotokenpool title="Permanent link">¶</a></h4> <ul> <li>Manages the <strong>mapping from req_idx to token position</strong>.</li> <li>Allocates fixed memory slots for each request.</li> <li>Maintains the logical contiguous layout of the request's token sequence in memory.</li> </ul> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ReqToTokenPool</span><span class=p>:</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>max_context_len</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>device</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>enable_memory_saver</span><span class=p>:</span> <span class=nb>bool</span><span class=p>):</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3></a><a href=#__codelineno-5-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=c1># Main storage structure: [number of requests, max context length]</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4></a><a href=#__codelineno-5-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>req_to_token</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5></a><a href=#__codelineno-5-5><span class=linenos data-linenos=" 5 "></span></a>            <span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>max_context_len</span><span class=p>),</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6></a><a href=#__codelineno-5-6><span class=linenos data-linenos=" 6 "></span></a>            <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>int32</span><span class=p>,</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7></a><a href=#__codelineno-5-7><span class=linenos data-linenos=" 7 "></span></a>            <span class=n>device</span><span class=o>=</span><span class=n>device</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8></a><a href=#__codelineno-5-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=p>)</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9></a><a href=#__codelineno-5-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>free_slots</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>  <span class=c1># List of free slots</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10></a><a href=#__codelineno-5-10><span class=linenos data-linenos="10 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>size</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11></a><a href=#__codelineno-5-11><span class=linenos data-linenos="11 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>max_context_len</span> <span class=o>=</span> <span class=n>max_context_len</span>
</span></code></pre></div> <h4 id=token_to_kv_pool>token_to_kv_pool<a class=headerlink href=#token_to_kv_pool title="Permanent link">¶</a></h4> <ul> <li>Manages allocation and deallocation of physical KV cache.</li> <li>Handles page-aligned memory allocation (if paging is enabled).</li> <li>Supports different allocation strategies (contiguous allocation, paged allocation, etc.).</li> </ul> <h4 id=tree-cache>Tree Cache<a class=headerlink href=#tree-cache title="Permanent link">¶</a></h4> <p>It is essentially the organizational structure connecting the two pools. The scheduler accesses it frequently during scheduling to allocate slots in <code>req_to_token_pool</code> and <code>token_to_kv_pool</code> for requests.</p> <ul> <li><code>tree_cache</code> plays a key role in scheduling policy, determining when the current request is prefilled based on prefix matching.</li> <li> <p><code>page_size</code> determines the granularity of prefix matching, key matching strategy, and paged matching algorithm.</p> </li> <li> <p><code>page_size = 1</code> means exact token-by-token matching, capable of matching prefixes of any length.</p> </li> <li><code>page_size &gt; 1</code> means prefix matching by page (using <code>tuple(tokens)</code> as key).<br> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># page_size = 1</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2></a><a href=#__codelineno-6-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>root</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3></a><a href=#__codelineno-6-3><span class=linenos data-linenos=" 3 "></span></a><span class=err>└──</span> <span class=mi>1</span> <span class=p>(</span><span class=n>child_key</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4></a><a href=#__codelineno-6-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=err>└──</span> <span class=mi>2</span> <span class=p>(</span><span class=n>child_key</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5></a><a href=#__codelineno-6-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=err>└──</span> <span class=mi>3</span> <span class=p>(</span><span class=n>child_key</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6></a><a href=#__codelineno-6-6><span class=linenos data-linenos=" 6 "></span></a>            <span class=err>└──</span> <span class=mi>4</span> <span class=p>(</span><span class=n>child_key</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7></a><a href=#__codelineno-6-7><span class=linenos data-linenos=" 7 "></span></a>                <span class=err>└──</span> <span class=mi>5</span> <span class=p>(</span><span class=n>child_key</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8></a><a href=#__codelineno-6-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9></a><a href=#__codelineno-6-9><span class=linenos data-linenos=" 9 "></span></a><span class=c1># page_size = 4</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10></a><a href=#__codelineno-6-10><span class=linenos data-linenos="10 "></span></a><span class=n>root</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11></a><a href=#__codelineno-6-11><span class=linenos data-linenos="11 "></span></a><span class=err>└──</span> <span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span> <span class=p>(</span><span class=n>child_key</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>))</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12></a><a href=#__codelineno-6-12><span class=linenos data-linenos="12 "></span></a><span class=err>└──</span> <span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>7</span><span class=p>,</span><span class=mi>8</span><span class=p>)</span> <span class=p>(</span><span class=n>child_key</span><span class=o>=</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>6</span><span class=p>,</span><span class=mi>7</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
</span></code></pre></div></li> </ul> <h4 id=relationship>Relationship<a class=headerlink href=#relationship title="Permanent link">¶</a></h4> <p>When a new request enters:</p> <ul> <li>First, perform longest prefix matching to find the corresponding KV index.</li> <li><code>req_to_token_pool</code> allocates free slots for <code>extend_token</code> to get the <code>req_pool_idx</code>.</li> <li><code>token_to_kv_pool_allocator</code> allocates new KV Cache.</li> <li>Update the mapping between <code>req_pool_idx</code> and KV Cache.</li> </ul> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># Directly allocate KV cache needed for extend tokens of all reqs in this batch</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2></a><a href=#__codelineno-7-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>out_cache_loc</span> <span class=o>=</span> <span class=n>alloc_token_slots</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>tree_cache</span><span class=p>,</span> <span class=n>batch</span><span class=o>.</span><span class=n>extend_num_tokens</span><span class=p>)</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3></a><a href=#__codelineno-7-3><span class=linenos data-linenos=" 3 "></span></a><span class=c1># update mapping (prefix + extend)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4></a><a href=#__codelineno-7-4><span class=linenos data-linenos=" 4 "></span></a><span class=n>req_to_token_pool</span><span class=o>.</span><span class=n>write</span><span class=p>(</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5></a><a href=#__codelineno-7-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=p>(</span><span class=n>req_idx</span><span class=p>,</span> <span class=nb>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>prefix_len</span><span class=p>)),</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6></a><a href=#__codelineno-7-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>prefix_tensors</span><span class=p>[</span><span class=n>i</span><span class=p>],</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7></a><a href=#__codelineno-7-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>)</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8></a><a href=#__codelineno-7-8><span class=linenos data-linenos=" 8 "></span></a><span class=n>req_to_token_pool</span><span class=o>.</span><span class=n>write</span><span class=p>(</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9></a><a href=#__codelineno-7-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>(</span><span class=n>req_idx</span><span class=p>,</span> <span class=nb>slice</span><span class=p>(</span><span class=n>prefix_len</span><span class=p>,</span> <span class=n>seq_len</span><span class=p>)),</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10></a><a href=#__codelineno-7-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>out_cache_loc</span><span class=p>[</span><span class=n>pt</span> <span class=p>:</span> <span class=n>pt</span> <span class=o>+</span> <span class=n>extend_len</span><span class=p>],</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11></a><a href=#__codelineno-7-11><span class=linenos data-linenos="11 "></span></a><span class=p>)</span>
</span></code></pre></div> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=../img/sglang_cache.png data-desc-position=bottom><img alt src=../img/sglang_cache.png></a></p> <h3 id=prefilladder>PrefillAdder<a class=headerlink href=#prefilladder title="Permanent link">¶</a></h3> <p>It is the core component in SGLang Scheduler responsible for <strong>batching prefill and decode requests</strong>. Its main role is to select suitable requests from the waiting queue and assemble them into a prefill batch that can be executed efficiently.</p> <blockquote> <p>If Mixed Chunk is enabled, a batch can contain both prefill and decode requests simultaneously.</p> </blockquote> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>PrefillAdder</span><span class=p>:</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>...</span><span class=p>):</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>page_size</span> <span class=o>=</span> <span class=n>page_size</span> <span class=c1># memory page size</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tree_cache</span> <span class=o>=</span> <span class=n>tree_cache</span>  <span class=c1># radix kv cache</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>token_to_kv_pool_allocator</span> <span class=o>=</span> <span class=n>token_to_kv_pool_allocator</span> <span class=c1># kv cache pool</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>running_batch</span> <span class=o>=</span> <span class=n>running_batch</span> <span class=c1># currently running decode batch</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>new_token_ratio</span> <span class=o>=</span> <span class=n>new_token_ratio</span> <span class=c1># new token generation ratio</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8></a><a href=#__codelineno-8-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>can_run_list</span> <span class=o>=</span> <span class=p>[]</span>      <span class=c1># list of runnable requests</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9></a><a href=#__codelineno-8-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>preempt_list</span> <span class=o>=</span> <span class=p>[]</span>      <span class=c1># list of preempted requests</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10></a><a href=#__codelineno-8-10><span class=linenos data-linenos="10 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>new_chunked_req</span> <span class=o>=</span> <span class=kc>None</span>   <span class=c1># new chunked request</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11></a><a href=#__codelineno-8-11><span class=linenos data-linenos="11 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>log_hit_tokens</span> <span class=o>=</span> <span class=mi>0</span>     <span class=c1># number of cache hit tokens</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12></a><a href=#__codelineno-8-12><span class=linenos data-linenos="12 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>log_input_tokens</span> <span class=o>=</span> <span class=mi>0</span>   <span class=c1># input token statistics</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13></a><a href=#__codelineno-8-13><span class=linenos data-linenos="13 "></span></a>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14></a><a href=#__codelineno-8-14><span class=linenos data-linenos="14 "></span></a>    <span class=nd>@property</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15></a><a href=#__codelineno-8-15><span class=linenos data-linenos="15 "></span></a>    <span class=k>def</span><span class=w> </span><span class=nf>rem_total_tokens</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16></a><a href=#__codelineno-8-16><span class=linenos data-linenos="16 "></span></a><span class=w>        </span><span class=sd>"""Calculate total remaining available tokens"""</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17></a><a href=#__codelineno-8-17><span class=linenos data-linenos="17 "></span></a>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18></a><a href=#__codelineno-8-18><span class=linenos data-linenos="18 "></span></a>    <span class=k>def</span><span class=w> </span><span class=nf>add_one_req</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>req</span><span class=p>:</span> <span class=n>Req</span><span class=p>,</span> <span class=n>has_chunked_req</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span> <span class=n>truncation_align_size</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]):</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19></a><a href=#__codelineno-8-19><span class=linenos data-linenos="19 "></span></a><span class=w>        </span><span class=sd>"""Add a request to the batch"""</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20></a><a href=#__codelineno-8-20><span class=linenos data-linenos="20 "></span></a>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21></a><a href=#__codelineno-8-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>def</span><span class=w> </span><span class=nf>add_chunked_req</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>req</span><span class=p>:</span> <span class=n>Req</span><span class=p>):</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22></a><a href=#__codelineno-8-22><span class=linenos data-linenos="22 "></span></a><span class=w>        </span><span class=sd>"""Handle chunked prefill request"""</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23></a><a href=#__codelineno-8-23><span class=linenos data-linenos="23 "></span></a>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24></a><a href=#__codelineno-8-24><span class=linenos data-linenos="24 "></span></a>    <span class=k>def</span><span class=w> </span><span class=nf>preempt_to_schedule</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>req</span><span class=p>:</span> <span class=n>Req</span><span class=p>,</span> <span class=n>server_args</span><span class=p>:</span> <span class=n>ServerArgs</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25></a><a href=#__codelineno-8-25><span class=linenos data-linenos="25 "></span></a><span class=w>        </span><span class=sd>"""Preempt low-priority requests to make way for high-priority ones"""</span>
</span></code></pre></div> <h3 id=generationbatchresult>GenerationBatchResult<a class=headerlink href=#generationbatchresult title="Permanent link">¶</a></h3> <h4 id=1-logits_output-optionallogitsprocessoroutput><strong>1. logits_output: Optional[LogitsProcessorOutput]</strong><a class=headerlink href=#1-logits_output-optionallogitsprocessoroutput title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: Contains the complete logits output and related information from the model's forward pass.</li> <li><strong>Content</strong>:</li> <li>next_token_logits: Logits distribution of the next token <code>[batch_size, vocab_size]</code></li> <li>input_token_logprobs: Log probabilities of input tokens</li> <li>hidden_states: Hidden states (used for speculative decoding)</li> <li>Various top-k logprobs and token probability information</li> <li><strong>Usage</strong>: Used for sampling, calculating probabilities, and returning logprob information to the user.</li> </ul> <h4 id=2-next_token_ids-optionaltorchtensor><strong>2. next_token_ids: Optional[torch.Tensor]</strong><a class=headerlink href=#2-next_token_ids-optionaltorchtensor title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: The next token ID after sampling.</li> <li><strong>Shape</strong>:&nbsp;<code>[batch_size]</code></li> <li><strong>Content</strong>:</li> <li>Prefill mode: The first generated token sampled based on the last position.</li> <li>Decode mode: The next token generated in the current step.</li> <li>Prefill-only: All-zero placeholder tensor.</li> <li><strong>Usage</strong>: Directly used to update the request's <code>output_ids</code> to advance the generation process.</li> </ul> <h4 id=3-num_accepted_tokens-optionalint><strong>3. num_accepted_tokens: Optional[int]</strong><a class=headerlink href=#3-num_accepted_tokens-optionalint title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: Number of tokens accepted in speculative decoding.</li> <li><strong>Usage</strong>: Statistics on acceptance rate of speculative decoding, used for performance optimization and metric collection.</li> </ul> <h4 id=4-next_draft_input-optionaleagledraftinput><strong>4. next_draft_input: Optional[EagleDraftInput]</strong><a class=headerlink href=#4-next_draft_input-optionaleagledraftinput title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: Input information for the next round of EAGLE speculative decoding.</li> <li><strong>Content</strong>: Includes top-k probabilities, indices, hidden states, etc.</li> <li><strong>Usage</strong>: Preparing input data for the next round of speculative decoding.</li> </ul> <h4 id=5-extend_input_len_per_req-optionallistint><strong>5. extend_input_len_per_req: Optional[List[int]]</strong><a class=headerlink href=#5-extend_input_len_per_req-optionallistint title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: Extended input length for each request.</li> <li><strong>Usage</strong>: Knowing <strong>how many new tokens were actually processed</strong> for each request when processing batch results.</li> </ul> <h4 id=6-extend_logprob_start_len_per_req-optionallistint><strong>6. extend_logprob_start_len_per_req: Optional[List[int]]</strong><a class=headerlink href=#6-extend_logprob_start_len_per_req-optionallistint title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: The position where each request starts calculating logprob.</li> <li><strong>Usage</strong>: Determining from which position to start returning logprob information to the user.</li> </ul> <h4 id=7-copy_done-optionaltorchcudaevent><strong>7. copy_done: Optional[torch.cuda.Event]</strong><a class=headerlink href=#7-copy_done-optionaltorchcudaevent title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: Synchronization event for GPU to CPU data transfer completion.</li> <li><strong>Usage</strong>: Ensuring data transfer is complete before processing results in overlapped scheduling.</li> </ul> <h4 id=8-delay_sample_func-optionalcallable><strong>8. delay_sample_func: Optional[callable]</strong><a class=headerlink href=#8-delay_sample_func-optionalcallable title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: Delayed sampling function.</li> <li><strong>Usage</strong>: In overlapped scheduling, execute forward pass first, then execute sampling operation later.</li> </ul> <h4 id=9-future_indices-optionalfutureindices><strong>9. future_indices: Optional[FutureIndices]</strong><a class=headerlink href=#9-future_indices-optionalfutureindices title="Permanent link">¶</a></h4> <ul> <li><strong>Role</strong>: Index information in the Future mechanism.</li> <li><strong>Usage</strong>: <strong>Managing storage and retrieval of asynchronous results</strong> in overlapped scheduling.</li> </ul> <h2 id=normal-no-overlap>Normal (No overlap)<a class=headerlink href=#normal-no-overlap title="Permanent link">¶</a></h2> <p>LLMs have an autoregressive structure, so whether in Prefill or Decode, what drives them to the next inference step is the predicted next token of the sequence. Data containing <code>next_token_ids</code> is therefore crucial.</p> <p>In prefill mode, <code>next_token_ids</code> contains:</p> <ul> <li><strong>Shape</strong>:&nbsp;<code>[batch_size]</code>&nbsp;- one token ID per request.</li> <li><strong>Content</strong>: The <strong>next token</strong> for each sequence, i.e., the token sampled based on logits from the last position of the input sequence.</li> <li><strong>Position</strong>: For prefill, only the last position of the sequence is used for sampling.</li> </ul> <p>In decode mode, <code>next_token_ids</code> contains:</p> <ul> <li><strong>Shape</strong>:&nbsp;<code>[batch_size]</code>&nbsp;- one token ID per request.</li> <li><strong>Content</strong>: The <strong>next token</strong> generated by each request in the current decoding step.</li> <li><strong>Position</strong>: Sampling using the current decoding position.</li> </ul> <h3 id=overview_1>Overview<a class=headerlink href=#overview_1 title="Permanent link">¶</a></h3> <p>When a Request enters SGLang Scheduler, it goes through the following stages:</p> <div class="language-shell highlight"><span class=filename>Bash</span><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos="1 "></span></a>Req<span class=w> </span>-&gt;<span class=w> </span>Pre<span class=w> </span>Schedule<span class=o>(</span>CPU<span class=o>)</span><span class=w> </span>-&gt;<span class=w> </span>Compute<span class=w> </span>Batch<span class=w> </span>-&gt;<span class=w> </span>Sample<span class=o>(</span>GPU<span class=o>)</span><span class=w> </span>-&gt;<span class=w> </span>Post<span class=w> </span>Schedule<span class=o>(</span>CPU<span class=o>)</span><span class=w> </span>-&gt;<span class=w> </span>next<span class=w> </span>Schedule<span class=w> </span>...
</span></code></pre></div> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=../img/Scheduler.png data-desc-position=bottom><img alt src=../img/Scheduler.png></a></p> <h4 id=pre-schedule>Pre Schedule<a class=headerlink href=#pre-schedule title="Permanent link">¶</a></h4> <ul> <li>Collect requests from the TokenizerManager and put them into the waiting queue. (<code>Schedule::recv_request()</code> &amp; <code>Schedule::process_input_requests()</code>)</li> <li>Schedule from the waiting queue and <code>running_batch</code>. (<code>Schedule::get_batch_to_run()</code>)</li> <li>Prefill involves Radix Tree and Longest Prefix Matching algorithm. (<code>Req::init_next_round_input()</code>)</li> <li>Allocate memory resources required for Tokens for each request. (<code>ScheduleBatch::prepare_for_extend()</code> &amp; <code>ScheduleBatch::prepare_for_decode()</code>)</li> </ul> <h4 id=compute-batch>Compute batch<a class=headerlink href=#compute-batch title="Permanent link">¶</a></h4> <p>New requests enter the Prefill phase, and after Prefill ends, they enter the Decode phase.</p> <h5 id=prefill-schedule>Prefill Schedule<a class=headerlink href=#prefill-schedule title="Permanent link">¶</a></h5> <ol> <li><code>get_next_batch_to_run</code>: Prefill takes precedence here, so <code>get_new_batch_prefill</code> is called, and the returned <code>new_batch</code> is directly used <strong>as the batch for this execution round (i.e., <code>cur_batch</code>)</strong>.</li> <li><code>get_new_batch_prefill</code>:</li> </ol> <ul> <li>Create <code>PrefillAdder</code> to manage batch construction, selecting requests from <code>waiting_queue</code>.</li> <li><strong><code>init_next_round_input</code> updates the prefix of the radix tree cache.</strong></li> <li>Create a new <code>ScheduleBatch</code>, call <code>prepare_for_extend</code>:<ul> <li>Allocate <code>req_pool_indices</code>: Assign a unique index position in the request pool for each request. This index is used to store the request's token-to-KV mapping in <code>req_to_token_pool</code>.</li> <li>allocate KV cache</li> <li>Write the mapping of req to kv cache into <code>req_to_token_pool</code>.</li> </ul> </li> </ul> <ol start=3> <li><code>run_batch()</code>: Execute Prefill inference, call <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward()</code> -&gt; <code>ModelRunner::_forward_raw()</code> -&gt; <code>ModelRunner::forward_extend()</code>, then execute backend operators and wait for results.</li> </ol> <h5 id=decode-schedule>Decode Schedule<a class=headerlink href=#decode-schedule title="Permanent link">¶</a></h5> <ol> <li><code>get_next_batch_to_run()</code>: Process completed requests from the previous batch, then merge with <code>running_batch</code>.</li> <li><code>update_running_batch()</code>:<br> - Call <code>prepare_for_decode()</code>:<ul> <li><code>output_ids</code> from the previous schedule become <code>input_ids</code> for this one.</li> <li>Allocate (batch size * 1) slots for <code>out_cache_loc</code>, because in decode mode we generate only one token per batch at a time.<br> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos="1 "></span></a>&nbsp; <span class=n>out_cache_loc</span> <span class=o>=</span> <span class=n>alloc_token_slots</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>tree_cache</span><span class=p>,</span> <span class=n>bs</span> <span class=o>*</span> <span class=mi>1</span><span class=p>)</span>
</span></code></pre></div></li> </ul> </li> <li><code>run_batch()</code>: Execute Decode inference, call <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward()</code> -&gt; <code>ModelRunner::_forward_raw()</code> -&gt; <code>ModelRunner::forward_decode()</code>, then execute backend operators and wait for results.</li> </ol> <h4 id=sample>Sample<a class=headerlink href=#sample title="Permanent link">¶</a></h4> <p><code>TpModelWorker::forward_batch_generation()</code>:</p> <ul> <li>If not in overlap mode, perform Sample immediately; otherwise, overlap CPU and GPU for delayed sampling.</li> <li><strong>Sample to get <code>next_token_ids</code> of the batch for use in the next batch forward.</strong><br> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>sampling_info</span><span class=o>.</span><span class=n>update_regex_vocab_mask</span><span class=p>()</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2></a><a href=#__codelineno-11-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=n>sampling_info</span><span class=o>.</span><span class=n>apply_logits_bias</span><span class=p>(</span><span class=n>logits_output</span><span class=o>.</span><span class=n>next_token_logits</span><span class=p>)</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3></a><a href=#__codelineno-11-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>next_token_ids</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sampler</span><span class=p>(</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4></a><a href=#__codelineno-11-4><span class=linenos data-linenos=" 4 "></span></a>      <span class=n>logits_output</span><span class=p>,</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5></a><a href=#__codelineno-11-5><span class=linenos data-linenos=" 5 "></span></a>      <span class=n>forward_batch</span><span class=o>.</span><span class=n>sampling_info</span><span class=p>,</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6></a><a href=#__codelineno-11-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=n>forward_batch</span><span class=o>.</span><span class=n>return_logprob</span><span class=p>,</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7></a><a href=#__codelineno-11-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=n>forward_batch</span><span class=o>.</span><span class=n>top_logprobs_nums</span><span class=p>,</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8></a><a href=#__codelineno-11-8><span class=linenos data-linenos=" 8 "></span></a>      <span class=n>forward_batch</span><span class=o>.</span><span class=n>token_ids_logprobs</span><span class=p>,</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9></a><a href=#__codelineno-11-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=c1># For prefill, we only use the position of the last token.</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10></a><a href=#__codelineno-11-10><span class=linenos data-linenos="10 "></span></a>      <span class=p>(</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11></a><a href=#__codelineno-11-11><span class=linenos data-linenos="11 "></span></a>          <span class=n>forward_batch</span><span class=o>.</span><span class=n>positions</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12></a><a href=#__codelineno-11-12><span class=linenos data-linenos="12 "></span></a>          <span class=k>if</span> <span class=n>forward_batch</span><span class=o>.</span><span class=n>forward_mode</span><span class=o>.</span><span class=n>is_decode</span><span class=p>()</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13></a><a href=#__codelineno-11-13><span class=linenos data-linenos="13 "></span></a>          <span class=k>else</span> <span class=n>forward_batch</span><span class=o>.</span><span class=n>seq_lens</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14></a><a href=#__codelineno-11-14><span class=linenos data-linenos="14 "></span></a>      <span class=p>),</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15></a><a href=#__codelineno-11-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>)</span>
</span></code></pre></div></li> </ul> <h4 id=post-schedule>Post Schedule<a class=headerlink href=#post-schedule title="Permanent link">¶</a></h4> <ul> <li>Prefill: <code>process_batch_result_prefill()</code></li> <li>Get results, call <code>tree_cache</code>'s <code>cache_unfinished_req()</code> to retain the cache for that req.</li> <li>Decode: <code>process_batch_result_decode()</code>:</li> <li>Check each Req; if completed, release the corresponding KV cache in <code>tree_cache</code> (<strong>batch release after loop interpretation</strong>).</li> <li>Return batch results via <code>stream_out()</code> to detokenizer for next steps.</li> </ul> <h3 id=event-loop>Event Loop<a class=headerlink href=#event-loop title="Permanent link">¶</a></h3> <ul> <li>Requests will first execute the prefill phase and then the decode phase until EOS is obtained or exit for other reasons.</li> </ul> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span><span class=w> </span><span class=nf>event_loop_normal</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos=" 2 "></span></a><span class=w>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class=sd>"""A normal scheduler loop."""</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3></a><a href=#__codelineno-12-3><span class=linenos data-linenos=" 3 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4></a><a href=#__codelineno-12-4><span class=linenos data-linenos=" 4 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=n>recv_reqs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>recv_requests</span><span class=p>()</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5></a><a href=#__codelineno-12-5><span class=linenos data-linenos=" 5 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=bp>self</span><span class=o>.</span><span class=n>process_input_requests</span><span class=p>(</span><span class=n>recv_reqs</span><span class=p>)</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6></a><a href=#__codelineno-12-6><span class=linenos data-linenos=" 6 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=n>batch</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_next_batch_to_run</span><span class=p>()</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7></a><a href=#__codelineno-12-7><span class=linenos data-linenos=" 7 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=bp>self</span><span class=o>.</span><span class=n>cur_batch</span> <span class=o>=</span> <span class=n>batch</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8></a><a href=#__codelineno-12-8><span class=linenos data-linenos=" 8 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=k>if</span> <span class=n>batch</span><span class=p>:</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9></a><a href=#__codelineno-12-9><span class=linenos data-linenos=" 9 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>run_batch</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10></a><a href=#__codelineno-12-10><span class=linenos data-linenos="10 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=bp>self</span><span class=o>.</span><span class=n>process_batch_result</span><span class=p>(</span><span class=n>batch</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11></a><a href=#__codelineno-12-11><span class=linenos data-linenos="11 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=k>else</span><span class=p>:</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12></a><a href=#__codelineno-12-12><span class=linenos data-linenos="12 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=c1># When the server is idle, do self-check and re-init some states</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13></a><a href=#__codelineno-12-13><span class=linenos data-linenos="13 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=bp>self</span><span class=o>.</span><span class=n>self_check_during_idle</span><span class=p>()</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14></a><a href=#__codelineno-12-14><span class=linenos data-linenos="14 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=bp>self</span><span class=o>.</span><span class=n>last_batch</span> <span class=o>=</span> <span class=n>batch</span>
</span></code></pre></div> <h3 id=pre-schedule_1>Pre Schedule<a class=headerlink href=#pre-schedule_1 title="Permanent link">¶</a></h3> <h4 id=req-waiting_queue>Req -&gt; Waiting_queue<a class=headerlink href=#req-waiting_queue title="Permanent link">¶</a></h4> <ul> <li> <p>First execute <code>recv_requests</code>:</p> </li> <li> <p>Only Pipeline rank = 0 can get requests from tokenizer via zmq.</p> </li> <li>Other pipeline ranks get requests from the previous pipeline.</li> <li> <p><code>work_reqs</code> are broadcast in <code>attn_tp</code>; system <code>control_reqs</code> are broadcast across the entire <code>tp_size</code>.</p> </li> <li> <p>Then execute <code>process_input_requests</code><br> 1. <strong>Extract worker_id</strong>:&nbsp;<code>worker_id = recv_req.worker_id</code><br> 2. <strong>Unpack request</strong>:&nbsp;<code>recv_req = recv_req.obj</code><br> 3. <strong>Dispatch processing</strong>:&nbsp;<code>output = self._request_dispatcher(recv_req)</code> Call request dispatcher.</p> <ul> <li>Construct <code>recv_req</code> as a new <code>Req</code> object.</li> <li>Call <code>_add_request_to_queue()</code> to insert <code>Req</code> into <code>waiting_queue</code>.<br> 4. <strong>Send response</strong>: Send output back to the corresponding tokenizer worker process.</li> </ul> </li> </ul> <h4 id=waiting_queuerunning_batch-cur_batch>Waiting_queue/running_batch -&gt; cur_batch<a class=headerlink href=#waiting_queuerunning_batch-cur_batch title="Permanent link">¶</a></h4> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=../img/batch.png data-desc-position=bottom><img alt src=../img/batch.png></a></p> <h5 id=get-prefill-batch-get_new_batch_prefill>Get prefill batch <code>get_new_batch_prefill</code><a class=headerlink href=#get-prefill-batch-get_new_batch_prefill title="Permanent link">¶</a></h5> <ul> <li>Create <code>PrefillAdder</code>, chunk new requests, then process multiple chunks at a time.</li> <li><code>init_next_round_input()</code>:<ul> <li>Construct full sequence: original input tokens + generated output tokens.</li> <li>Max prefix length calculation: Cache up to the second to last token (<code>input_len - 1</code>).<blockquote> <p>The model needs an input token to query these cached historical information and calculate the logits (probability distribution) for the current step. If we count all tokens as prefix tokens and read them from cache, then there is no "input token" fed to the model for the current step, and the model cannot calculate the logits for <span class=arithmatex>\(t+1\)</span>. Therefore, we must <strong>keep the last token out of prefix matching</strong> and let it be the <code>input_ids</code> to the model for this inference.</p> </blockquote> </li> <li>Prefix matching:</li> <li>When Request <code>ABC</code> arrives, assume there is a node <code>AFG</code> in the current radix cache.</li> <li><code>match_prefix</code> will try to find the longest prefix of existing <code>ABC</code> in the current radix cache, meaning it will find <code>A</code> in the <code>AFG</code> node.</li> <li>Radix cache will split this node <code>AFG</code> into <code>A</code> and <code>FG</code>, with node <code>A</code> becoming the last node of the current Request.</li> </ul> </li> <li>Create a new <code>ScheduleBatch</code>.</li> <li> <p>Call <code>ScheduleBatch::prepare_for_extend()</code></p> </li> <li> <p>Allocate <code>req_pool_indices</code> to assign a unique index position in the request pool for each request. This index is used to store the request's token-to-KV mapping in <code>req_to_token_pool</code>.</p> <ul> <li>allocate kv cache: [Total input tokens per Request - matched prefix tokens] <code>out_cache_loc</code>.</li> <li>Write mapping of req to kv cache into <code>req_to_token_pool</code>.</li> </ul> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>req_to_token_pool</span><span class=p>[</span><span class=n>req_idx</span><span class=p>]:</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2></a><a href=#__codelineno-13-2><span class=linenos data-linenos=" 2 "></span></a><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3></a><a href=#__codelineno-13-3><span class=linenos data-linenos=" 3 "></span></a><span class=err>│</span>  <span class=n>Prefix</span> <span class=n>Part</span> <span class=p>(</span><span class=mi>1984</span> <span class=n>tokens</span><span class=p>)</span>    <span class=err>│</span>    <span class=n>New</span> <span class=n>Chunk</span> <span class=n>Part</span> <span class=p>(</span><span class=mi>2000</span> <span class=n>tokens</span><span class=p>)</span>    <span class=err>│</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4></a><a href=#__codelineno-13-4><span class=linenos data-linenos=" 4 "></span></a><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5></a><a href=#__codelineno-13-5><span class=linenos data-linenos=" 5 "></span></a><span class=err>│</span> <span class=p>[</span><span class=n>loc_1</span><span class=p>,</span> <span class=n>loc_2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>loc_1984</span><span class=p>]</span> <span class=err>│</span> <span class=p>[</span><span class=n>loc_1985</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>loc_3984</span><span class=p>]</span> <span class=err>│</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6></a><a href=#__codelineno-13-6><span class=linenos data-linenos=" 6 "></span></a><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7></a><a href=#__codelineno-13-7><span class=linenos data-linenos=" 7 "></span></a><span class=n>Position</span><span class=p>:</span>  <span class=mi>0</span>                    <span class=mi>1984</span>                         <span class=mi>3984</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8></a><a href=#__codelineno-13-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9></a><a href=#__codelineno-13-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>KV</span> <span class=n>Cache</span> <span class=n>Pool</span><span class=p>:</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10></a><a href=#__codelineno-13-10><span class=linenos data-linenos="10 "></span></a><span class=err>┌──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┐</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11></a><a href=#__codelineno-13-11><span class=linenos data-linenos="11 "></span></a><span class=err>│</span><span class=n>loc_1</span> <span class=err>│</span><span class=n>loc_2</span> <span class=err>│</span> <span class=o>...</span> <span class=err>│</span><span class=n>loc_1984</span><span class=err>│</span><span class=n>loc_1985</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span><span class=n>loc_3984</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12></a><a href=#__codelineno-13-12><span class=linenos data-linenos="12 "></span></a><span class=err>├──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┤</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13></a><a href=#__codelineno-13-13><span class=linenos data-linenos="13 "></span></a><span class=err>│</span> <span class=n>k1</span><span class=p>,</span><span class=n>v1</span><span class=err>│</span> <span class=n>k2</span><span class=p>,</span><span class=n>v2</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span><span class=n>k1984</span><span class=p>,</span><span class=n>v1984</span><span class=err>│</span><span class=n>k1985</span><span class=p>,</span><span class=n>v1985</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span><span class=n>k3984</span><span class=p>,</span><span class=n>v3984</span><span class=err>│</span> <span class=o>...</span> <span class=err>│</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14></a><a href=#__codelineno-13-14><span class=linenos data-linenos="14 "></span></a><span class=err>└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┘</span>
</span></code></pre></div> </li> </ul> <h5 id=get-decode-batch>Get decode batch<a class=headerlink href=#get-decode-batch title="Permanent link">¶</a></h5> <ul> <li>First remove completed or errored batches from the batch, then merge the previous round's decode batch with <code>running_batch</code>.</li> <li>Essentially concatenating <code>seq_lens</code>, <code>orig_seq_lens</code>, <code>output_ids</code>, etc. using <code>torch.cat</code>.</li> <li> <p>Call <code>update_running_batch()</code> to get decode batch.</p> </li> <li> <p>First check if requests need to be retracted.</p> </li> <li>If so, re-insert requests to be retracted into <code>waiting_queue</code> and re-queue for scheduling.</li> <li> <p>Call <code>ScheduleBatch::prepare_for_decode()</code></p> <ul> <li>Previous round output as this round's input.</li> <li>Memory allocation + sequence length update.</li> </ul> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># Assume batch has 3 requests, current lengths are [10, 15, 8]</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2></a><a href=#__codelineno-14-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1># Decode needs to allocate space for the next position of each request</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3></a><a href=#__codelineno-14-3><span class=linenos data-linenos=" 3 "></span></a>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4></a><a href=#__codelineno-14-4><span class=linenos data-linenos=" 4 "></span></a><span class=c1># KV cache mapping before allocation</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5></a><a href=#__codelineno-14-5><span class=linenos data-linenos=" 5 "></span></a><span class=n>req_to_token_pool</span><span class=p>[</span><span class=n>req1_idx</span><span class=p>,</span> <span class=mi>0</span><span class=p>:</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>loc1</span><span class=p>,</span> <span class=n>loc2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>loc10</span><span class=p>]</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6></a><a href=#__codelineno-14-6><span class=linenos data-linenos=" 6 "></span></a><span class=n>req_to_token_pool</span><span class=p>[</span><span class=n>req2_idx</span><span class=p>,</span> <span class=mi>0</span><span class=p>:</span><span class=mi>15</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>loc11</span><span class=p>,</span> <span class=n>loc12</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>loc25</span><span class=p>]</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7></a><a href=#__codelineno-14-7><span class=linenos data-linenos=" 7 "></span></a><span class=n>req_to_token_pool</span><span class=p>[</span><span class=n>req3_idx</span><span class=p>,</span> <span class=mi>0</span><span class=p>:</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>loc26</span><span class=p>,</span> <span class=n>loc27</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>loc33</span><span class=p>]</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8></a><a href=#__codelineno-14-8><span class=linenos data-linenos=" 8 "></span></a>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9></a><a href=#__codelineno-14-9><span class=linenos data-linenos=" 9 "></span></a><span class=c1># After executing alloc_for_decode</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10></a><a href=#__codelineno-14-10><span class=linenos data-linenos="10 "></span></a><span class=n>req_to_token_pool</span><span class=p>[</span><span class=n>req1_idx</span><span class=p>,</span> <span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=n>loc34</span>    <span class=c1># Allocate for position 10</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11></a><a href=#__codelineno-14-11><span class=linenos data-linenos="11 "></span></a><span class=n>req_to_token_pool</span><span class=p>[</span><span class=n>req2_idx</span><span class=p>,</span> <span class=mi>15</span><span class=p>]</span> <span class=o>=</span> <span class=n>loc35</span>    <span class=c1># Allocate for position 15</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12></a><a href=#__codelineno-14-12><span class=linenos data-linenos="12 "></span></a><span class=n>req_to_token_pool</span><span class=p>[</span><span class=n>req3_idx</span><span class=p>,</span> <span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=n>loc36</span>     <span class=c1># Allocate for position 8</span>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13></a><a href=#__codelineno-14-13><span class=linenos data-linenos="13 "></span></a>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14></a><a href=#__codelineno-14-14><span class=linenos data-linenos="14 "></span></a><span class=c1># out_cache_loc = [loc34, loc35, loc36]</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15></a><a href=#__codelineno-14-15><span class=linenos data-linenos="15 "></span></a>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16></a><a href=#__codelineno-14-16><span class=linenos data-linenos="16 "></span></a><span class=c1># A faster in-place version</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17></a><a href=#__codelineno-14-17><span class=linenos data-linenos="17 "></span></a><span class=bp>self</span><span class=o>.</span><span class=n>seq_lens</span><span class=o>.</span><span class=n>add_</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18></a><a href=#__codelineno-14-18><span class=linenos data-linenos="18 "></span></a><span class=bp>self</span><span class=o>.</span><span class=n>seq_lens_cpu</span><span class=o>.</span><span class=n>add_</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19></a><a href=#__codelineno-14-19><span class=linenos data-linenos="19 "></span></a><span class=bp>self</span><span class=o>.</span><span class=n>orig_seq_lens</span><span class=o>.</span><span class=n>add_</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20></a><a href=#__codelineno-14-20><span class=linenos data-linenos="20 "></span></a><span class=c1># update all length</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21></a><a href=#__codelineno-14-21><span class=linenos data-linenos="21 "></span></a><span class=bp>self</span><span class=o>.</span><span class=n>seq_lens_sum</span> <span class=o>+=</span> <span class=n>bs</span> &nbsp;<span class=c1># bs = batch_size</span>
</span></code></pre></div> </li> </ul> <h3 id=compute-batch-sample>Compute Batch &amp; Sample<a class=headerlink href=#compute-batch-sample title="Permanent link">¶</a></h3> <p>Here we temporarily only consider the <strong>generation</strong> case (there is also the Embedding case).</p> <ul> <li>Convert <code>ScheduleBatch</code> to <code>ModelWorkerBatch</code>.</li> <li>Call <code>TpModelWorker::forward_batch_generation()</code></li> <li>Convert <code>ModelWorkerBatch</code> to <code>ForwardBatch</code>.</li> <li>Call <code>ModelRunner::forward()</code>, finally calling backend flashinfer operators.<ul> <li>Prefill executes <code>ModelRunner::forward_extend()</code>.</li> <li>Decode executes <code>ModelRunner::forward_decode()</code>.</li> </ul> </li> <li><strong>Immediately perform Sample to get the next token based on logits.</strong></li> <li>Return result <code>GenerationBatchResult</code>.</li> </ul> <h3 id=post-schedule_1>Post Schedule<a class=headerlink href=#post-schedule_1 title="Permanent link">¶</a></h3> <h4 id=prefill>Prefill<a class=headerlink href=#prefill title="Permanent link">¶</a></h4> <ul> <li>Unpack <code>GenerationBatchResult</code>.</li> <li>Execute <code>synchronize()</code> to <strong>wait for GPU→CPU copy completion, ensuring subsequent data access is available on CPU</strong>.</li> <li>Iterate through each request in the batch.</li> <li>Update generation results.</li> <li>Update logprob.</li> <li>Special handling for Chunked requests: <code>is_chunked &gt; 0</code> indicates prefill is not yet fully complete, need to decrement counter and skip streaming output.</li> <li>Output streaming results: Call <code>stream_output()</code> to send results (token, logprob, etc.) to the client (e.g., WebSocket / API response).</li> </ul> <h4 id=decode>Decode<a class=headerlink href=#decode title="Permanent link">¶</a></h4> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos=" 1 "></span></a><span class=p>[</span><span class=n>GPU</span> <span class=n>forward</span> <span class=n>kernel</span><span class=p>]</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2></a><a href=#__codelineno-15-2><span class=linenos data-linenos=" 2 "></span></a>   <span class=err>↓</span> <span class=p>(</span><span class=n>Result</span> <span class=n>written</span> <span class=n>to</span> <span class=n>GenerationBatchResult</span><span class=p>)</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3></a><a href=#__codelineno-15-3><span class=linenos data-linenos=" 3 "></span></a><span class=p>[</span><span class=n>Scheduler</span><span class=o>.</span><span class=n>process_batch_result_decode</span><span class=p>()]</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4></a><a href=#__codelineno-15-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=err>├──</span> <span class=n>copy_done</span><span class=o>.</span><span class=n>synchronize</span><span class=p>()</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5></a><a href=#__codelineno-15-5><span class=linenos data-linenos=" 5 "></span></a>   <span class=err>├──</span> <span class=n>next_token_ids</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6></a><a href=#__codelineno-15-6><span class=linenos data-linenos=" 6 "></span></a>   <span class=err>├──</span> <span class=n>Update</span> <span class=n>req</span> <span class=n>status</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7></a><a href=#__codelineno-15-7><span class=linenos data-linenos=" 7 "></span></a>       <span class=err>├──</span> <span class=n>req</span><span class=o>.</span><span class=n>output_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>next_token_id</span><span class=p>)</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8></a><a href=#__codelineno-15-8><span class=linenos data-linenos=" 8 "></span></a>       <span class=err>├──</span> <span class=k>if</span> <span class=n>finished</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>tree_cache</span><span class=o>.</span><span class=n>cache_finished_req</span><span class=p>(</span><span class=n>req</span><span class=p>)</span> <span class=c1># Release kv cache</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9></a><a href=#__codelineno-15-9><span class=linenos data-linenos=" 9 "></span></a>   <span class=err>├──</span> <span class=n>stream_output</span><span class=p>()</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10></a><a href=#__codelineno-15-10><span class=linenos data-linenos="10 "></span></a>   <span class=err>└──</span> <span class=n>free</span> <span class=n>KV</span> <span class=n>pages</span>
</span></code></pre></div> <h2 id=why-overlap>Why Overlap?<a class=headerlink href=#why-overlap title="Permanent link">¶</a></h2> <p>Running the actual scheduling algorithm accounts for only a small fraction of the total scheduling overhead. <strong>Most of the overhead comes from model input preparation and model output post-processing.</strong> Specifically, the largest overheads come from constructing input tensors (<strong>Pre Schedule</strong>), executing output detokenization (<strong>Post Schedule</strong>), and preparing metadata for each request (<strong>Pre Schedule</strong>)<sup id=fnref:overhead><a class=footnote-ref href=#fn:overhead>2</a></sup>.</p> <p><strong>Overhead in constructing model input tensors and sampling metadata mainly stems from Python.</strong></p> <p>Using <strong>multi-step scheduling can reduce total scheduling overhead</strong>, but it also has drawbacks. For example, between two scheduling calls, even if some requests finish early, new requests cannot be added to the batch.</p> <ul> <li><strong>vLLM</strong>'s multi-step decode</li> <li><strong>SGLang</strong>'s speculative group execution</li> </ul> <h2 id=zero-overhead-scheduling-overlap>Zero-Overhead Scheduling (Overlap)<a class=headerlink href=#zero-overhead-scheduling-overlap title="Permanent link">¶</a></h2> <h3 id=principle>Principle<a class=headerlink href=#principle title="Permanent link">¶</a></h3> <p>Before introducing the principle, we need to recall the four major steps of the inference process above and consider which steps can be overlapped to reduce GPU bubbles (idle periods). Here is a diagram of the current overlap pipeline.</p> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=../img/lazy_sampling.png data-desc-position=bottom><img alt src=../img/lazy_sampling.png></a></p> <h4 id=inference-overview>Inference Overview<a class=headerlink href=#inference-overview title="Permanent link">¶</a></h4> <p>SGLang's inference process is mainly divided into the following four stages:</p> <ol> <li><strong>Pre schedule:</strong><br> - Collect requests from TokenizerManager and put them into waiting queue. (<code>Scheduler::recv_request()</code> &amp; <code>Scheduler::process_input_requests()</code>)<br> - Schedule from waiting queue and <code>running_batch</code>. (<code>Scheduler::get_batch_to_run()</code>)<ul> <li>Prefill involves Radix Tree and Longest Prefix Matching algorithm. (<code>Req::init_next_round_input()</code>)</li> <li>Allocate memory resources required for Tokens for each request. (<code>ScheduleBatch::prepare_for_extend()</code> &amp; <code>ScheduleBatch::prepare_for_decode()</code>)</li> </ul> </li> <li><strong>Compute batch:</strong><br> - Send batch to GPU for one step (i.e., one iter of Continue Batch) inference. (<code>Scheduler::run_batch()</code>)</li> <li><strong>Sample:</strong><br> - Sample based on Logit output from model to generate next Token. (<code>ModelRunner::sample()</code>)</li> <li><strong>Post schedule:</strong><br> - After one inference step, dynamically check if requests meet finish condition (Check Finish Condition). (<code>Scheduler::process_batch_result()</code>)<br> - Remove completed requests from the batch, send them to the detokenizer, then return results to the DetokenizerManager, and finally forward them to the TokenizerManager.</li> </ol> <h4 id=overlap-overview>Overlap Overview<sup id=fnref:overlap><a class=footnote-ref href=#fn:overlap>1</a></sup><a class=headerlink href=#overlap-overview title="Permanent link">¶</a></h4> <p>The <code>Compute batch</code> and <code>Sample</code> stages, which are adjacent, are GPU-heavy, while the two schedule stages are CPU-heavy. When multiple batches are pipelined, we can use <strong>GPU Compute and Sample to overlap the post scheduler of the previous batch with the pre scheduler of the current batch</strong>.</p> <blockquote> <p>Actually, our Prefill request entry does not depend on unfinished batches; <strong>the first request can execute normally</strong>.</p> </blockquote> <p>We implement overlap by using Forward CUDA Stream, specifically:</p> <ul> <li>In <code>Run Batch</code>, two operations are submitted to the <code>forward_stream</code> stream: one retrieves the next token of the previous batch from <code>FutureMap</code>; the other uses this token as <code>input_id</code> for the next calculation.</li> <li>In <code>Sample</code>, two operations are also submitted to the <code>forward_stream</code> stream: one performs sampling; the other <strong>writes the obtained next token back to FutureMap</strong>.</li> <li>We need to synchronize CPU and GPU before processing data in <code>Post Schedule</code> to ensure <code>next_token_ids</code> on CPU can be processed.</li> <li>We <strong>perform synchronization in Post Schedule</strong>, ensuring subsequent processing runs normally without affecting GPU pipeline work.<br> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1></a><a href=#__codelineno-16-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span><span class=w> </span><span class=nf>process_batch_result_decode</span><span class=p>(</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2></a><a href=#__codelineno-16-2><span class=linenos data-linenos=" 2 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class=bp>self</span><span class=p>:</span> <span class=n>Scheduler</span><span class=p>,</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3></a><a href=#__codelineno-16-3><span class=linenos data-linenos=" 3 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class=n>batch</span><span class=p>:</span> <span class=n>ScheduleBatch</span><span class=p>,</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4></a><a href=#__codelineno-16-4><span class=linenos data-linenos=" 4 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class=n>result</span><span class=p>:</span> <span class=n>GenerationBatchResult</span><span class=p>,</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5></a><a href=#__codelineno-16-5><span class=linenos data-linenos=" 5 "></span></a>&nbsp; &nbsp; <span class=p>):</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6></a><a href=#__codelineno-16-6><span class=linenos data-linenos=" 6 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>copy_done</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7></a><a href=#__codelineno-16-7><span class=linenos data-linenos=" 7 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=n>result</span><span class=o>.</span><span class=n>copy_done</span><span class=o>.</span><span class=n>synchronize</span><span class=p>()</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8></a><a href=#__codelineno-16-8><span class=linenos data-linenos=" 8 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class=n>logits_output</span><span class=p>,</span> <span class=n>next_token_ids</span><span class=p>,</span> <span class=n>can_run_cuda_graph</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9></a><a href=#__codelineno-16-9><span class=linenos data-linenos=" 9 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=n>result</span><span class=o>.</span><span class=n>logits_output</span><span class=p>,</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10></a><a href=#__codelineno-16-10><span class=linenos data-linenos="10 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=n>result</span><span class=o>.</span><span class=n>next_token_ids</span><span class=p>,</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11></a><a href=#__codelineno-16-11><span class=linenos data-linenos="11 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=n>result</span><span class=o>.</span><span class=n>can_run_cuda_graph</span><span class=p>,</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12></a><a href=#__codelineno-16-12><span class=linenos data-linenos="12 "></span></a>&nbsp; &nbsp; &nbsp; &nbsp; <span class=p>)</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13></a><a href=#__codelineno-16-13><span class=linenos data-linenos="13 "></span></a>  <span class=n>next_token_ids</span> <span class=o>=</span> <span class=n>next_token_ids</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14></a><a href=#__codelineno-16-14><span class=linenos data-linenos="14 "></span></a>  <span class=n>next_token_logprobs</span> <span class=o>=</span> <span class=n>logits_output</span><span class=o>.</span><span class=n>next_token_logprobs</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></code></pre></div></li> </ul> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=../img/lazy_sampling.png data-desc-position=bottom><img alt src=../img/lazy_sampling.png></a></p> <h3 id=init-overlap>Init Overlap<a class=headerlink href=#init-overlap title="Permanent link">¶</a></h3> <ul> <li><strong>forward_stream</strong>: Dedicated to GPU forward computation, parallel to default stream.</li> <li><strong>copy_stream</strong>: Handles GPU-&gt;CPU data transfer.</li> <li><strong>future_map</strong>: Manages asynchronous calculation results, using <strong>negative indices as future identifiers</strong>.</li> <li><code>output_id</code> calculated by previous batch serves as <code>input_id</code> for next batch, implemented by accessing <code>future_map</code>.</li> <li><strong>batch_record_buf</strong>: Batch buffer (prevents GPU tensors from being GC'd).</li> </ul> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1></a><a href=#__codelineno-17-1><span class=linenos data-linenos="1 "></span></a><span class=k>def</span><span class=w> </span><span class=nf>init_overlap</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2></a><a href=#__codelineno-17-2><span class=linenos data-linenos="2 "></span></a>    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_overlap</span><span class=p>:</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3></a><a href=#__codelineno-17-3><span class=linenos data-linenos="3 "></span></a>        <span class=k>return</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4></a><a href=#__codelineno-17-4><span class=linenos data-linenos="4 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>forward_stream</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>Stream</span><span class=p>()</span>      <span class=c1># GPU forward computation stream</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5></a><a href=#__codelineno-17-5><span class=linenos data-linenos="5 "></span></a>    <span class=c1># Future map manages asynchronous results</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6></a><a href=#__codelineno-17-6><span class=linenos data-linenos="6 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>future_map</span> <span class=o>=</span> <span class=n>FutureMap</span><span class=p>(</span><span class=n>max_running_requests</span><span class=p>,</span> <span class=n>device</span><span class=p>,</span> <span class=n>spec_algorithm</span><span class=p>)</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7></a><a href=#__codelineno-17-7><span class=linenos data-linenos="7 "></span></a>    <span class=c1># batch buffer (prevents GPU tensors from being GC'd)</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8></a><a href=#__codelineno-17-8><span class=linenos data-linenos="8 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_record_buf</span> <span class=o>=</span> <span class=p>[</span><span class=kc>None</span><span class=p>]</span> <span class=o>*</span> <span class=mi>2</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9></a><a href=#__codelineno-17-9><span class=linenos data-linenos="9 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_record_ct</span> <span class=o>=</span> <span class=mi>0</span>
</span></code></pre></div> <h4 id=futuremap>FutureMap<a class=headerlink href=#futuremap title="Permanent link">¶</a></h4> <p><strong>Stored on GPU.</strong></p> <ul> <li><code>future_ct</code>: Current ring counter (pointer), used to generate new future indices (not "number of unfinished").</li> <li><code>future_limit</code>: Modulo for ring pointer (used for <code>% self.future_limit</code>). The code uses a factor of <code>*3</code> to <strong>reduce index collision probability</strong> (preventing <code>future_ct</code> from wrapping around quickly and overwriting slots not yet written back).</li> <li> <p><code>future_buffer_len</code>: Actual physical buffer length (<code>*5</code>), longer than <code>future_limit</code> to ensure enough space in write interval (preventing slice out-of-bounds or wrap-around write/read conflicts).</p> </li> <li> <p>These two factors (3 and 5) are engineering empirical values used to increase safety margin; you can adjust based on concurrency and outstanding futures.</p> </li> </ul> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1></a><a href=#__codelineno-18-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>FutureMap</span><span class=p>:</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2></a><a href=#__codelineno-18-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3></a><a href=#__codelineno-18-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4></a><a href=#__codelineno-18-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=n>max_running_requests</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5></a><a href=#__codelineno-18-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=p>):</span>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6></a><a href=#__codelineno-18-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>future_ct</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7></a><a href=#__codelineno-18-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=c1># A factor of 3 is used to avoid collision in the circular buffer.</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8></a><a href=#__codelineno-18-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>future_limit</span> <span class=o>=</span> <span class=n>max_running_requests</span> <span class=o>*</span> <span class=mi>3</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9></a><a href=#__codelineno-18-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=c1># A factor of 5 is used to ensure the buffer is large enough.</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10></a><a href=#__codelineno-18-10><span class=linenos data-linenos="10 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>future_buffer_len</span> <span class=o>=</span> <span class=n>max_running_requests</span> <span class=o>*</span> <span class=mi>5</span>
</span></code></pre></div> <h3 id=overlap-event-loop>Overlap Event Loop<a class=headerlink href=#overlap-event-loop title="Permanent link">¶</a></h3> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1></a><a href=#__codelineno-19-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>def</span><span class=w> </span><span class=nf>event_loop_overlap</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2></a><a href=#__codelineno-19-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>result_queue</span> <span class=o>=</span> <span class=n>deque</span><span class=p>()</span>  <span class=c1># Store (batch, result) pairs</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3></a><a href=#__codelineno-19-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4></a><a href=#__codelineno-19-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=c1># === Pre Schedule 2 ===</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5></a><a href=#__codelineno-19-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>recv_reqs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>recv_requests</span><span class=p>()</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6></a><a href=#__codelineno-19-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>process_input_requests</span><span class=p>(</span><span class=n>recv_reqs</span><span class=p>)</span>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7></a><a href=#__codelineno-19-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>batch</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_next_batch_to_run</span><span class=p>()</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8></a><a href=#__codelineno-19-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>cur_batch</span> <span class=o>=</span> <span class=n>batch</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9></a><a href=#__codelineno-19-9><span class=linenos data-linenos=" 9 "></span></a>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10></a><a href=#__codelineno-19-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>batch_result</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11></a><a href=#__codelineno-19-11><span class=linenos data-linenos="11 "></span></a>        <span class=k>if</span> <span class=n>batch</span><span class=p>:</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12></a><a href=#__codelineno-19-12><span class=linenos data-linenos="12 "></span></a>            <span class=c1># === Launch Compute Batch 2 ===</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13></a><a href=#__codelineno-19-13><span class=linenos data-linenos="13 "></span></a>            <span class=n>batch_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>run_batch</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>  <span class=c1># Non-blocking launch</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14></a><a href=#__codelineno-19-14><span class=linenos data-linenos="14 "></span></a>            <span class=bp>self</span><span class=o>.</span><span class=n>result_queue</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>batch</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span> <span class=n>batch_result</span><span class=p>))</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15></a><a href=#__codelineno-19-15><span class=linenos data-linenos="15 "></span></a>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16></a><a href=#__codelineno-19-16><span class=linenos data-linenos="16 "></span></a>        <span class=c1># === Post Schedule 1 ===</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17></a><a href=#__codelineno-19-17><span class=linenos data-linenos="17 "></span></a>        <span class=c1># compute batch 2 executes in parallel with post schedule 1</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18></a><a href=#__codelineno-19-18><span class=linenos data-linenos="18 "></span></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>last_batch</span><span class=p>:</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19></a><a href=#__codelineno-19-19><span class=linenos data-linenos="19 "></span></a>            <span class=c1># Process results in queue (GPU is computing current batch in parallel at this time)</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20></a><a href=#__codelineno-19-20><span class=linenos data-linenos="20 "></span></a>            <span class=n>tmp_batch</span><span class=p>,</span> <span class=n>tmp_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>result_queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21></a><a href=#__codelineno-19-21><span class=linenos data-linenos="21 "></span></a>            <span class=bp>self</span><span class=o>.</span><span class=n>process_batch_result</span><span class=p>(</span><span class=n>tmp_batch</span><span class=p>,</span> <span class=n>tmp_result</span><span class=p>)</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22></a><a href=#__codelineno-19-22><span class=linenos data-linenos="22 "></span></a>        <span class=k>elif</span> <span class=n>batch</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23></a><a href=#__codelineno-19-23><span class=linenos data-linenos="23 "></span></a>            <span class=bp>self</span><span class=o>.</span><span class=n>self_check_during_idle</span><span class=p>()</span>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24></a><a href=#__codelineno-19-24><span class=linenos data-linenos="24 "></span></a>
</span><span id=__span-19-25><a id=__codelineno-19-25 name=__codelineno-19-25></a><a href=#__codelineno-19-25><span class=linenos data-linenos="25 "></span></a>        <span class=c1># === Launch Sample 2 ===</span>
</span><span id=__span-19-26><a id=__codelineno-19-26 name=__codelineno-19-26></a><a href=#__codelineno-19-26><span class=linenos data-linenos="26 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>launch_batch_sample_if_needed</span><span class=p>(</span><span class=n>batch_result</span><span class=p>)</span> <span class=c1># update vocab mask</span>
</span><span id=__span-19-27><a id=__codelineno-19-27 name=__codelineno-19-27></a><a href=#__codelineno-19-27><span class=linenos data-linenos="27 "></span></a>        <span class=bp>self</span><span class=o>.</span><span class=n>last_batch</span> <span class=o>=</span> <span class=n>batch</span>
</span></code></pre></div> <h4 id=differences-from-normal-event-loop>Differences from normal event loop<a class=headerlink href=#differences-from-normal-event-loop title="Permanent link">¶</a></h4> <ul> <li><code>Schedule::run_batch()</code></li> <li><code>Schedule::record_batch_in_overlap()</code>: Alternately stores <code>model_worker_batch</code> references in two overlapping batches, <strong>avoiding CUDA kernel accessing dangling pointers or freed memory when overlap forward is not yet finished</strong>.</li> <li><code>FutureMap::resolve_future()</code>: Replaces negative index placeholders with <strong>real tokens obtained from previous batch sample</strong>.</li> <li><code>TpModelWorker::forward_batch_generation()</code>, this function merely delays execution of <code>model_runner.sample</code> function, returning <code>batch_result</code> first.</li> <li>Added <code>Scheduler::launch_batch_sample_if_needed()</code>:</li> <li>Execute real Sample operation.<ul> <li>Mask illegal tokens, allocate <code>vocab_mask</code> tensor size <code>[batch, vocab_size]</code>.</li> <li>Move mask to CPU.</li> </ul> </li> <li>Store obtained <code>next_token_id</code> to corresponding position in <code>FutureMap</code>'s <code>future_indices</code>.<ul> <li>For next batch to get real token in <code>resolve_future</code> during <code>run_batch</code>.</li> </ul> </li> </ul> <h3 id=stream-synchronization>Stream Synchronization<a class=headerlink href=#stream-synchronization title="Permanent link">¶</a></h3> <ul> <li>In decode mode, <code>batch.output_ids</code> of previous batch is <code>batch.input_ids</code> of next batch.</li> <li><strong>First:</strong> After <strong>last batch</strong>'s <code>output_id</code> <strong>stored in FutureMap</strong>.</li> <li><strong>Second:</strong> <strong>current batch gets <code>output_id</code> from FutureMap</strong> and uses it as <code>input_id</code> for next batch calculation.</li> <li>Limitation of CUDA Stream itself.</li> <li>Implemented on CPU side using negative placeholders, waiting for GPU to fill real tokens.</li> </ul> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1></a><a href=#__codelineno-20-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1># previous batch output is negative indices</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2></a><a href=#__codelineno-20-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>batch</span><span class=o>.</span><span class=n>output_ids</span> <span class=o>=</span> <span class=o>-</span><span class=bp>self</span><span class=o>.</span><span class=n>future_map</span><span class=o>.</span><span class=n>alloc_future_indices</span><span class=p>(</span><span class=n>bs</span><span class=p>)</span><span class=o>.</span><span class=n>indices</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3></a><a href=#__codelineno-20-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>forward_stream_ctx</span><span class=p>:</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4></a><a href=#__codelineno-20-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>forward_stream</span><span class=o>.</span><span class=n>wait_stream</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>default_stream</span><span class=p>)</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5></a><a href=#__codelineno-20-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>_batch_result</span> <span class=o>=</span> <span class=n>batch_result</span><span class=o>.</span><span class=n>delay_sample_func</span><span class=p>()</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6></a><a href=#__codelineno-20-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=k>assert</span> <span class=n>_batch_result</span> <span class=ow>is</span> <span class=n>batch_result</span>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7></a><a href=#__codelineno-20-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=c1># store token to negative indices</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8></a><a href=#__codelineno-20-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>future_map</span><span class=o>.</span><span class=n>store_to_map</span><span class=p>(</span><span class=n>batch_result</span><span class=o>.</span><span class=n>future_indices</span><span class=p>,</span> <span class=n>batch_result</span><span class=p>)</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9></a><a href=#__codelineno-20-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>batch_result</span><span class=o>.</span><span class=n>copy_to_cpu</span><span class=p>()</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10></a><a href=#__codelineno-20-10><span class=linenos data-linenos="10 "></span></a>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11></a><a href=#__codelineno-20-11><span class=linenos data-linenos="11 "></span></a><span class=c1># next batch input is output of previous batch</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12></a><a href=#__codelineno-20-12><span class=linenos data-linenos="12 "></span></a>&nbsp;<span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>forward_stream_ctx</span><span class=p>:</span>
</span><span id=__span-20-13><a id=__codelineno-20-13 name=__codelineno-20-13></a><a href=#__codelineno-20-13><span class=linenos data-linenos="13 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>forward_stream</span><span class=o>.</span><span class=n>wait_stream</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>default_stream</span><span class=p>)</span>
</span><span id=__span-20-14><a id=__codelineno-20-14 name=__codelineno-20-14></a><a href=#__codelineno-20-14><span class=linenos data-linenos="14 "></span></a>    <span class=c1># get token from negative indices</span>
</span><span id=__span-20-15><a id=__codelineno-20-15 name=__codelineno-20-15></a><a href=#__codelineno-20-15><span class=linenos data-linenos="15 "></span></a>    <span class=bp>self</span><span class=o>.</span><span class=n>future_map</span><span class=o>.</span><span class=n>_resolve_future_token_ids</span><span class=p>(</span><span class=n>model_worker_batch</span><span class=o>.</span><span class=n>input_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>token_ids_buf</span><span class=p>)</span>
</span><span id=__span-20-16><a id=__codelineno-20-16 name=__codelineno-20-16></a><a href=#__codelineno-20-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>batch_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_worker</span><span class=o>.</span><span class=n>forward_batch_generation</span><span class=p>(</span>
</span><span id=__span-20-17><a id=__codelineno-20-17 name=__codelineno-20-17></a><a href=#__codelineno-20-17><span class=linenos data-linenos="17 "></span></a>        <span class=n>model_worker_batch</span>
</span><span id=__span-20-18><a id=__codelineno-20-18 name=__codelineno-20-18></a><a href=#__codelineno-20-18><span class=linenos data-linenos="18 "></span></a>    <span class=p>)</span>
</span></code></pre></div> <h3 id=differences-from-previous-overlap-version>Differences from previous overlap version<a class=headerlink href=#differences-from-previous-overlap-version title="Permanent link">¶</a></h3> <ul> <li>Moved <code>update_vocab_mask</code> to GPU for calculation, <code>vocab_mask</code> is also allocated directly on GPU, no longer transferred.</li> <li>Current GPU is additionally responsible for storing (after sample) and retrieving (before compute) <code>next_token_ids</code> to/from <code>FutureMap</code>.</li> <li><code>FutureMap</code> is also completely stored on GPU.</li> <li>GPU scheduling changed from CPU launch to directly submitting operations to the CUDA stream, scheduled by the stream itself.</li> <li>For sample synchronization, the previous version used a CUDA event; here we directly use <strong>CUDA stream ordering constraints for synchronization</strong>.</li> </ul> <p><a class=glightbox data-type=image data-width=80% data-height=auto href=../img/previous_overlap.png data-desc-position=bottom><img alt src=../img/previous_overlap.png></a><br> <a class=glightbox data-type=image data-width=80% data-height=auto href=../img/lazy_sampling.png data-desc-position=bottom><img alt src=../img/lazy_sampling.png></a></p> <h4 id=pros-and-cons-of-the-two-versions>Pros and Cons of the Two Versions<a class=headerlink href=#pros-and-cons-of-the-two-versions title="Permanent link">¶</a></h4> <h5 id=cuda-stream-version>CUDA stream version<a class=headerlink href=#cuda-stream-version title="Permanent link">¶</a></h5> <ul> <li>Higher execution efficiency: No CPU-GPU transfer for <code>vocab_mask</code> and <code>token_ids_buf</code>; fully utilizes GPU memory bandwidth.</li> <li>Lower latency: <code>token_ids_buf</code> modified in-place directly on GPU, no need for repeated transfer.</li> <li>On same device as model inference, facilitating pipelining.</li> <li>Large non-model VRAM usage: <code>token_ids_buf</code> occupies GPU VRAM, fixed overhead.</li> </ul> <h5 id=cpu-launch-version>CPU launch version<a class=headerlink href=#cpu-launch-version title="Permanent link">¶</a></h5> <ul> <li>Occupies GPU memory only when in use.</li> <li>Increased synchronization points: <code>vocab_mask</code> adds one CPU-GPU synchronization.</li> <li>CPU-GPU synchronization breaks pipeline.</li> </ul> <h2 id=reference>Reference<a class=headerlink href=#reference title="Permanent link">¶</a></h2> <div class=footnote> <hr> <ol> <li id=fn:overlap> <p><a href=https://github.com/zhaochenyang20/Awesome-ML-SYS-Tutorial/blob/main/sglang/zero-overhead-scheduler/zero-overhead-batch-scheduler.md>Zero-Overhead Batch Scheduler</a>&nbsp;<a class=footnote-backref href=#fnref:overlap title="Jump back to footnote 1 in the text">↩</a></p> </li> <li id=fn:overhead> <p><a href=https://mlsys.wuklab.io/posts/scheduling_overhead/ >Can Scheduling Overhead Dominate LLM Inference Performance? A Study of CPU Scheduling Overhead on Two Popular LLM Inference Systems</a>&nbsp;<a class=footnote-backref href=#fnref:overhead title="Jump back to footnote 2 in the text">↩</a></p> </li> <li id=fn:code-walk> <p><a href=https://github.com/zhaochenyang20/Awesome-ML-SYS-Tutorial/blob/main/sglang/code-walk-through/readme-CN.md>SGLang Code Walk Through</a>&nbsp;<a class=footnote-backref href=#fnref:code-walk title="Jump back to footnote 3 in the text">↩</a></p> </li> </ol> </div> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> Support Me! </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title="Support Me!" data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M96 400c-17.7 0-32 14.3-32 32v48c0 17.7 14.3 32 32 32h224c17.7 0 32-14.3 32-32v-48c0-17.7-14.3-32-32-32zm-22.8-48h64.6l-79.5-88.3c-6.6-7.4-10.3-16.9-10.3-26.8V204c0-16.1 11.9-29.5 27.4-31.7 11.8-1.7 20.6-11.8 20.6-23.8V72c0-13.3 10.7-24 24-24 7.2 0 13.6 3.1 18 8.1 4.6 5.2 11.1 8.1 18 8.1s13.4-3 18-8.1c4.4-5 10.8-8.1 18-8.1 8.5 0 15.9 4.4 20.2 11.1 6.9 10.7 20.9 14.2 32 8 3.5-1.9 7.4-3.1 11.8-3.1 10.6 0 19.7 6.9 22.8 16.6 3.8 11.7 15.9 18.7 28 16 1.7-.4 3.4-.6 5.2-.6 13.3 0 24 10.7 24 24v92.2c0 14.4-3.5 28.5-10.2 41.2L273.6 352h54.3l40.3-76.2c10.4-19.6 15.8-41.5 15.8-63.6V120c0-38.4-30.1-69.8-68.1-71.9C303 28.8 281 16 256 16c-5.7 0-11.2.7-16.5 1.9C226.8 6.8 210.2 0 192 0c-13.1 0-25.4 3.5-36 9.6C145.4 3.5 133.1 0 120 0 80.2 0 48 32.2 48 72v58.7C19.7 143 0 171.2 0 204v32.9c0 21.7 8 42.7 22.6 58.9z"></path></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> <center> 难道说……你愿意给我买一瓶快乐水吗！🫣 </center> <center> How about...buy me a coffee？😋 </center> <img src=/img/wechat.png width=200px> </div> </div> </div> </fieldset> </form> <!-- Insert generated snippet here --> <script src=https://giscus.app/client.js data-repo=tom-jerr/tom-jerr.github.io data-repo-id=R_kgDONZrjcA data-category=Announcements data-category-id=DIC_kwDONZrjcM4Ck-PT data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async>
    </script> <!-- Synchronize Giscus theme with palette --> <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

        // Instruct Giscus to set theme
        giscus.setAttribute("data-theme", theme)
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function () {
        var ref = document.querySelector("[data-md-component=palette]")
        ref.addEventListener("change", function () {
            var palette = __md_get("__palette")
            if (palette && typeof palette.color === "object") {
                var theme = palette.color.scheme === "slate"
                    ? "transparent_dark"
                    : "light"

                // Instruct Giscus to change theme
                var frame = document.querySelector(".giscus-frame")
                frame.contentWindow.postMessage(
                    {giscus: {setConfig: {theme}}},
                    "https://giscus.app"
                )
            }
        })
    })
</script> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <!-- Application footer --> <footer class=md-footer> <!-- Link to previous and/or next page --> <!-- Website statistics --> <div class=md-footer-stats> <div class="md-footer-stats__inner md-grid"> <div class=md-footer-stats__content> <span class=md-footer-stats__item> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24" width=16 height=16 style="vertical-align: middle; margin-right: 4px;"> <path fill=currentColor d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"></path> </svg> <span>运行时间: <span id=web-time>加载中...</span></span> </span> </div> </div> </div> <!-- Further information --> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright © 2025 - Present <a href=https://github.com/tom-jerr/ target=_blank rel=noopener>tom-jerr</a> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <!-- Social links --> <div class=md-social> <a href=https://github.com/tom-jerr/ target=_blank rel=noopener title=GitHub class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a href=/img/qq.png target=_blank rel=noopener title=QQ class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M434.1 420.4c-11.5 1.4-44.9-52.7-44.9-52.7 0 31.3-16.1 72.2-51 101.8 16.8 5.2 54.8 19.2 45.8 34.4-7.3 12.3-125.5 7.9-159.6 4-34.1 3.8-152.3 8.3-159.6-4-9-15.2 28.9-29.2 45.8-34.4-34.9-29.5-51.1-70.4-51.1-101.8 0 0-33.3 54.1-44.9 52.7-5.4-.6-12.4-29.6 9.3-99.7 10.3-33 22-60.5 40.1-105.8C60.9 98 109.2-.1 224.3-.1 338-.1 387.5 96 384.6 214.9c18.1 45.2 29.9 72.9 40.1 105.8 21.8 70.1 14.7 99.1 9.3 99.7z"></path></svg> </a> <a href=/img/wechat.png target=_blank rel=noopener title=微信 class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154m-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4m-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2M563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4m-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6m107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6"></path></svg> </a> <a href=https://x.com/tom_jerry_jack target=_blank rel=noopener title=X class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"></path></svg> </a> <a href=https://www.zhihu.com/people/chen-wen-de-jian-ke target=_blank rel=noopener title=Zhihu class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M170.5 148.1v217.5h23.4l7.7 26.4 42-26.4h49.5V148.1H170.4zM268.3 342h-27.9l-27.9 17.5-5.1-17.5h-11.9V171.7h72.8zm-118.5-94.3H97.5c1.7-27.1 2.2-51.6 2.2-73.5h51.2s2-22.6-8.6-22.3H53.8c3.5-13.1 7.9-26.7 13.1-40.7 0 0-24.1 0-32.3 21.6-3.4 8.9-13.2 43.1-30.7 78.1 5.9-.6 25.4-1.2 36.8-22.2 2.1-5.9 2.5-6.7 5.1-14.5h28.9c0 10.5-1.2 66.9-1.7 73.4H20.7c-11.7 0-15.6 23.6-15.6 23.6h65.6c-4.4 49.9-28 91.9-70.8 125.1 20.5 5.9 40.9-.9 51-9.9 0 0 23-20.9 35.6-69.3l54 64.9s7.9-26.9-1.2-40c-7.6-8.9-28.1-33.1-36.8-41.8L87.9 312c4.4-14 7-27.6 7.9-40.7h61.6s-.1-23.6-7.6-23.6m412-1.6c20.8-25.6 45-58.6 45-58.6s-18.6-14.8-27.4-4.1c-6 8.2-36.8 48.2-36.8 48.2l19.2 14.4zm-150-59.1c-9-8.2-25.9 2.1-25.9 2.1s39.5 55 41.1 57.4l19.5-13.7s-25.7-37.6-34.7-45.9zM640 258.4c-19.8 0-130.9.9-131.1.9v-101q7.2 0 22.8-1.2c40.9-2.4 70.1-4 87.8-4.8 0 0 12.2-27.2-.6-33.4-3.1-1.2-23.2 4.6-23.2 4.6s-165.2 16.5-232.4 18c1.6 8.8 7.6 17.1 15.8 19.6 13.3 3.5 22.7 1.7 49.2.9 24.8-1.6 43.7-2.4 56.5-2.4v99.8H351.3s2.8 22.3 25.5 22.9h107.9v70.9c0 14-11.2 22-24.5 21.1-14.1.1-26.1-1.1-41.7-1.8 2 4 6.3 14.4 19.3 21.8 9.9 4.8 16.2 6.6 26 6.6 29.6 0 45.7-17.3 44.9-45.3v-73.3h122.4c9.7 0 8.7-23.8 8.7-23.8z"></path></svg> </a> <a href=mailto:2584074296@qq.com target=_blank rel=noopener title="send email to me!" class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 576 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M536.4-26.3c9.8-3.5 20.6-1 28 6.3s9.8 18.2 6.3 28l-178 496.9c-5 13.9-18.1 23.1-32.8 23.1-14.2 0-27-8.6-32.3-21.7l-64.2-158c-4.5-11-2.5-23.6 5.2-32.6l94.5-112.4c5.1-6.1 4.7-15-.9-20.6s-14.6-6-20.6-.9l-112.4 94.3c-9.1 7.6-21.6 9.6-32.6 5.2L38.1 216.8c-13.1-5.3-21.7-18.1-21.7-32.3 0-14.7 9.2-27.8 23.1-32.8z"></path></svg> </a> </div> </div> </div> </footer> <!-- Website running time counter script --> <script>
  function updateWebTime() {
    var startDate = new Date("2025/05/04 20:00:00");
    var now = new Date();
    var diff = now.getTime() - startDate.getTime();
    
    var days = Math.floor(diff / (1000 * 60 * 60 * 24));
    var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    var timeStr = days + " 天 " + hours + " 小时 " + minutes + " 分钟";
    
    var webTimeElement = document.getElementById("web-time");
    if (webTimeElement) {
      webTimeElement.textContent = timeStr;
    }
    
    setTimeout(updateWebTime, 60000); // 每分钟更新一次
  }
  
  // 页面加载完成后启动计时器
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", updateWebTime);
  } else {
    updateWebTime();
  }
  

</script> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.footnote.tooltips", "content.tabs.link", "header.autohide", "navigation.tracking", "navigation.tabs", "navigation.top", "navigation.path", "navigation.indexes", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.e71a0d61.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script> <script src=../../../js/mathjax.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script> <script src=../../../assets/document_dates/tippy/popper.min.js></script> <script src=../../../assets/document_dates/tippy/tippy.umd.min.js></script> <script src=../../../assets/document_dates/core/default.config.js></script> <script src=../../../assets/document_dates/user.config.js></script> <script src=../../../assets/document_dates/core/utils.js></script> <script src=../../../assets/document_dates/core/core.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>