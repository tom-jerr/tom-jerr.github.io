{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":"Welcome to enjoy MlSys magic! \ud83c\udf89    Looking for a llm inference acceleration internship \ud83d\ude0d     contact me: tomlzy213@gmail.com   <p>  About Me /   Academic Page </p>"},{"location":"academy/","title":"\u5218\u82b7\u6ea2 (Zhiyi Liu)","text":""},{"location":"academy/#zhiyi-liu","title":"\u5218\u82b7\u6ea2 (Zhiyi Liu)","text":"<p> \u5de5\u4f5c\u90ae\u7bb1: lzy [underline] CS [underline] LN [at] 163 [dot] com</p> <p> \u4e2a\u4eba\u90ae\u7bb1: tomlzy213 [at] gmail [dot] com</p> <p> \u65e7\u7248\u7b80\u5386: \u70b9\u51fb\u67e5\u770b</p> <p> \u65b0\u7248\u7b80\u5386: </p> <p> </p>"},{"location":"academy/#_1","title":"\u4e2a\u4eba\u7b80\u4ecb","text":"<p>\u6211\u662f\u5728 \u7535\u5b50\u79d1\u6280\u5927\u5b66 (UESTC) \u653b\u8bfb\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u65b9\u5411\u7684\u7855\u58eb\u4e8c\u5e74\u7ea7\u5b66\u751f\uff0c\u76ee\u524d\u5c31\u8bfb\u4e8e\u5b9e\u9a8c\u5ba4 NDSL\u3002\u6211\u4e3b\u8981\u5173\u6ce8\u5927\u8bed\u8a00\u6a21\u578b\u63a8\u7406 (LLM Inference)\u3001\u6570\u636e\u5e93\u4e0e\u5206\u5e03\u5f0f\u7cfb\u7edf\u7b49\u65b9\u5411\u3002</p> <p>\u76ee\u524d\u6b63\u5728\u5bfb\u627e\u4e0e\u5927\u6a21\u578b\u63a8\u7406\u52a0\u901f\u76f8\u5173\u7684\u5b9e\u4e60\u673a\u4f1a\uff0c\u5982\u679c\u60a8\u6709\u76f8\u5173\u5c97\u4f4d\u6216\u7ebf\u7d22\uff0c\u6b22\u8fce\u968f\u65f6\u8054\u7cfb\u6211\uff01\u8c22\u8c22\uff01\ud83e\udd70\ud83e\udd70\ud83e\udd70</p>"},{"location":"academy/#_2","title":"\u7814\u7a76\u5174\u8da3","text":"<ul> <li>\u5927\u8bed\u8a00\u6a21\u578b\u63a8\u7406\u4e0e\u4f18\u5316\uff1a\u6b63\u5728\u6df1\u5165\u5b66\u4e60\u5927\u6a21\u578b\u63a8\u7406\u6846\u67b6\u7684\u4f53\u7cfb\u7ed3\u6784\uff0c\u5176\u4e2d\u5305\u62ec SGLang\u3002\u5e76\u7ef4\u62a4\u4e00\u4e2a\u5927\u6a21\u578b\u63a8\u7406\u7684\u6559\u5b66\u9879\u76ee MiniInfer\u3002 </li> </ul>"},{"location":"academy/#news","title":"News","text":"20252024 <p>[11/2025]  \u53c2\u4e0e\u7684 Nebula Graph \u793e\u533a\u5f00\u6e90\u4e4b\u590f\u9879\u76ee\u2014\u2014\u4e3a NebulaGraph \u652f\u6301\u5411\u91cf\u8fd1\u4f3c\u8fd1\u90bb\u68c0\u7d22\u987a\u5229\u7ed3\u9898\uff08\u9879\u76ee\u5468\u671f\uff1a2025.07 - 2025.10\uff09</p> <p>[12/2024]  NODDL \u56e2\u961f\u5728 2024 \u5e74 OceanBase \u6570\u636e\u5e93\u5927\u8d5b\u603b\u51b3\u8d5b\u4e2d\u83b7\u7b2c 11 \u540d\uff08\u7b2c 10/1212 \u652f\u961f\u4f0d\uff09</p> <p>[11/2024]  NODDL \u56e2\u961f\u83b7\u5f97 2024 \u5e74 OceanBase \u6570\u636e\u5e93\u5927\u8d5b\u521d\u8d5b\uff08\u56db\u5ddd\u8d5b\u533a\uff09\u4e00\u7b49\u5956</p>"},{"location":"academy/#_3","title":"\u6559\u80b2\u7ecf\u5386","text":""},{"location":"academy/#_4","title":"\u7535\u5b50\u79d1\u6280\u5927\u5b66 \u8ba1\u7b97\u673a\u79d1\u5b66\u4e0e\u5de5\u7a0b\u5b66\u9662\uff08\u7855\u58eb\uff09","text":"<p>2024\u5e749\u6708 \u2014\u2014 \u81f3\u4eca</p> <p></p>"},{"location":"academy/#_5","title":"\u7535\u5b50\u79d1\u6280\u5927\u5b66 \u8ba1\u7b97\u673a\u79d1\u5b66\u4e0e\u5de5\u7a0b\u5b66\u9662\uff08\u672c\u79d1\uff09","text":"<p>2020\u5e749\u6708 \u2014\u2014 2024\u5e746\u6708</p>"},{"location":"academy/#_6","title":"\u9879\u76ee\u7ecf\u5386","text":"<p>\u5f00\u6e90\u6691\u671f\u9879\u76ee \u2014 Nebula Graph (2025.07 \u2013 2025.10)</p> <p>\u4f5c\u4e3a\u6838\u5fc3\u8d21\u732e\u8005\u53c2\u4e0e Nebula Graph \u793e\u533a\u5f00\u6e90\u4e4b\u590f\u9879\u76ee\uff0c\u8d1f\u8d23\u4e3a\u5206\u5e03\u5f0f\u56fe\u6570\u636e\u5e93\u5f15\u5165\u539f\u751f\u5411\u91cf\u68c0\u7d22\uff08Vector Search\uff09\u80fd\u529b\u3002</p> <ul> <li>\u5411\u91cf\u5b58\u50a8\u5f15\u64ce\u8bbe\u8ba1\uff1a\u8bbe\u8ba1\u5e76\u5b9e\u73b0\u4e86\u539f\u751f\u5411\u91cf\u6570\u636e\u7c7b\u578b\uff08Vector Type\uff09\u53ca\u5176\u5e95\u5c42\u5b58\u50a8\u5e03\u5c40\uff0c\u4f18\u5316\u4e86\u9ad8\u7ef4\u5411\u91cf\u7684\u5e8f\u5217\u5316\u4e0e\u538b\u7f29\u5b58\u50a8\u673a\u5236\uff0c\u5b9e\u73b0\u4e86\u56fe\u5143\u7d20\uff08Vertex/Edge\uff09\u4e0e\u5411\u91cf\u6570\u636e\u7684\u7edf\u4e00\u7ba1\u7406\u3002</li> <li>\u67e5\u8be2\u8bed\u8a00\u4e0e\u6267\u884c\u5c42\u6269\u5c55\uff1a\u6269\u5c55\u4e86 nGQL\uff08Nebula Graph Query Language\uff09\u7684 DDL \u4e0e DML \u8bed\u6cd5\uff0c\u652f\u6301\u5411\u91cf\u7d22\u5f15\u7684\u5b9a\u4e49\u4e0e\u7ba1\u7406\uff1b\u89e3\u51b3\u4e86\u5411\u91cf\u5c5e\u6027\u5728\u5206\u5e03\u5f0f\u67b6\u6784\u4e0b\u7684\u5143\u6570\u636e\u540c\u6b65\u4e0e\u4e00\u81f4\u6027\u6311\u6218\u3002</li> <li>\u9ad8\u6027\u80fd ANN \u7d22\u5f15\u96c6\u6210\uff1a\u8bbe\u8ba1\u4e86\u5411\u91cf\u7d22\u5f15\u63a5\u53e3\u62bd\u8c61\uff0c\u96c6\u6210\u4e86 HNSW \u7b49\u8fd1\u4f3c\u6700\u8fd1\u90bb\u641c\u7d22\u7b97\u6cd5\uff0c\u5b9e\u73b0\u4e86\u57fa\u4e8e\u5411\u91cf\u76f8\u4f3c\u5ea6\u7684 Top-K \u67e5\u8be2\u7b97\u5b50\uff0c\u5927\u5e45\u63d0\u5347\u4e86\u56fe\u8c31\u8bed\u4e49\u68c0\u7d22\u7684\u6027\u80fd\u4e0e\u51c6\u786e\u5ea6\u3002</li> </ul> <p>BusTub \u5173\u7cfb\u578b\u6570\u636e\u5e93\u5185\u6838\u5b9e\u73b0 (2025.03-2025.06)</p> <p>\u5b9e\u73b0\u4e86\u4e00\u4e2a\u6559\u5b66\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5185\u6838\u7684\u4e00\u4e9b\u5173\u952e\u529f\u80fd\uff0c\u6db5\u76d6\u5b58\u50a8\u3001\u7d22\u5f15\u3001\u6267\u884c\u4e0e\u4e8b\u52a1\u56db\u5927\u6838\u5fc3\u6a21\u5757\u3002</p> <ul> <li>\u5b58\u50a8\u5f15\u64ce\u4e0e\u7f13\u51b2\u6c60\u7ba1\u7406\uff1a\u8bbe\u8ba1\u5e76\u5b9e\u73b0\u4e86\u57fa\u4e8e LRU-K \u7b97\u6cd5\u7684\u7f13\u51b2\u6c60\u7ba1\u7406\u5668 (Buffer Pool Manager)\uff0c\u652f\u6301\u9ad8\u5e76\u53d1\u4e0b\u7684\u9875\u9762\u7f6e\u6362\u4e0e\u810f\u9875\u5237\u76d8\uff1b\u5b9e\u73b0\u4e86\u78c1\u76d8\u8c03\u5ea6\u5668 (Disk Scheduler)\uff0c\u4f18\u5316\u4e86\u78c1\u76d8 I/O \u8bf7\u6c42\u7684\u5904\u7406\u6548\u7387\u3002</li> <li>\u5e76\u53d1 B+ \u6811\u7d22\u5f15\uff1a\u5b9e\u73b0\u4e86\u652f\u6301\u9ad8\u5e76\u53d1\u8bfb\u5199\u7684 B+ \u6811\u7d22\u5f15\uff0c\u91c7\u7528\u4e50\u89c2\u9501 (Optimistic Latch Crabbing) \u7b56\u7565\u4e0e Context \u673a\u5236\u4f18\u5316\u9501\u7ade\u4e89\uff0c\u663e\u8457\u63d0\u5347\u4e86\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u7684\u7d22\u5f15\u8bbf\u95ee\u6027\u80fd\uff1b\u652f\u6301\u8303\u56f4\u67e5\u8be2\u8fed\u4ee3\u5668 (Index Iterator)\u3002</li> <li>\u67e5\u8be2\u6267\u884c\u5f15\u64ce\uff1a\u5b9e\u73b0\u4e86\u57fa\u4e8e\u706b\u5c71\u6a21\u578b (Volcano Model) \u7684\u67e5\u8be2\u6267\u884c\u5668\uff0c\u5305\u62ec Hash Join \u7b97\u5b50\u4e0e\u5916\u90e8\u5f52\u5e76\u6392\u5e8f (External Merge Sort) \u7b97\u6cd5\uff0c\u652f\u6301\u5927\u89c4\u6a21\u6570\u636e\u7684\u8fde\u63a5\u4e0e\u6392\u5e8f\u64cd\u4f5c\u3002</li> <li>\u4e8b\u52a1\u4e0e\u5e76\u53d1\u63a7\u5236\uff1a\u6784\u5efa\u4e86\u57fa\u4e8e MVCC (\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236) \u4e0e OCC (\u4e50\u89c2\u5e76\u53d1\u63a7\u5236) \u7684\u4e8b\u52a1\u7ba1\u7406\u7cfb\u7edf\uff0c\u5b9e\u73b0\u4e86\u53ef\u4e32\u884c\u5316 (Serializable) \u9694\u79bb\u7ea7\u522b\uff1b\u8bbe\u8ba1\u4e86 Undo Log \u7248\u672c\u94fe\u7ba1\u7406\u4e0e\u5783\u573e\u56de\u6536 (GC) \u673a\u5236\uff0c\u6709\u6548\u89e3\u51b3\u4e86\u8bfb\u5199\u51b2\u7a81\u4e0e\u7248\u672c\u56de\u6eda\u95ee\u9898\u3002</li> </ul> <p>TinyKV \u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8\u7cfb\u7edf (2024.12-2025.02)</p> <p>\u8bbe\u8ba1\u5e76\u5b9e\u73b0\u4e86\u4e00\u4e2a\u57fa\u4e8e Raft \u5171\u8bc6\u7b97\u6cd5\u7684\u9ad8\u53ef\u7528\u3001\u5f3a\u4e00\u81f4\u6027\u5206\u5e03\u5f0f Key-Value \u5b58\u50a8\u7cfb\u7edf\uff08\u67b6\u6784\u53c2\u8003 TiKV\uff09\uff0c\u652f\u6301\u6c34\u5e73\u6269\u5c55\u3001\u591a\u526f\u672c\u5bb9\u9519\u53ca\u81ea\u52a8\u6545\u969c\u6062\u590d\u3002</p> <ul> <li>Raft \u5171\u8bc6\u7b97\u6cd5\u5b9e\u73b0\uff1a\u6784\u5efa Raft \u6838\u5fc3\u6a21\u5757\uff0c\u5b9e\u73b0\u4e86 Leader \u9009\u4e3e\u3001\u65e5\u5fd7\u590d\u5236\u3001\u5fc3\u8df3\u4fdd\u6d3b\u673a\u5236\uff1b\u901a\u8fc7\u8bbe\u8ba1\u6a21\u5757\u5316\u7684 RawNode \u63a5\u53e3\uff0c\u5b9e\u73b0\u4e86\u7b97\u6cd5\u903b\u8f91\u4e0e\u4e0a\u5c42\u5e94\u7528\u7684\u89e3\u8026\u3002</li> <li>Multi-Raft \u67b6\u6784\u4e0e\u6c34\u5e73\u6269\u5c55\uff1a\u5b9e\u73b0\u4e86\u57fa\u4e8e Region \u7684 Multi-Raft \u67b6\u6784\uff0c\u652f\u6301\u6570\u636e\u6309\u8303\u56f4\uff08Range\uff09\u81ea\u52a8\u5206\u7247\uff1b\u5f00\u53d1\u4e86 Region Split\uff08\u5206\u88c2\uff09\u673a\u5236\uff0c\u4f7f\u7cfb\u7edf\u80fd\u591f\u968f\u7740\u6570\u636e\u91cf\u589e\u957f\u81ea\u52a8\u8fdb\u884c\u6c34\u5e73\u6269\u5c55\u3002</li> <li>\u5b58\u50a8\u5f15\u64ce\u4e0e\u6301\u4e45\u5316\uff1a\u5c01\u88c5 BadgerDB \u4f5c\u4e3a\u5e95\u5c42\u5355\u673a\u5b58\u50a8\u5f15\u64ce\uff1b\u5b9e\u73b0\u4e86 PeerStorage \u6a21\u5757\uff0c\u8d1f\u8d23 Raft \u65e5\u5fd7\uff08Log Entries\uff09\u4e0e\u786c\u72b6\u6001\uff08HardState\uff09\u7684\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u4fdd\u8bc1\u4e86\u7cfb\u7edf\u5d29\u6e83\u540e\u7684\u6570\u636e\u5b89\u5168\u6027\u3002</li> <li>\u65e5\u5fd7\u538b\u7f29\u4e0e\u5feb\u7167\u673a\u5236\uff1a\u8bbe\u8ba1\u5e76\u5b9e\u73b0\u4e86 Raft \u65e5\u5fd7\u538b\u7f29\uff08Log Compaction\uff09\u548c\u5feb\u7167\uff08Snapshot\uff09\u529f\u80fd\uff0c\u89e3\u51b3\u4e86\u65e5\u5fd7\u65e0\u9650\u589e\u957f\u5bfc\u81f4\u7684\u5b58\u50a8\u538b\u529b\u95ee\u9898\uff0c\u5e76\u652f\u6301\u843d\u540e\u8282\u70b9\u901a\u8fc7\u5feb\u7167\u5feb\u901f\u6062\u590d\u72b6\u6001\u3002</li> </ul>"},{"location":"academy/#_7","title":"\u8363\u8a89\u5956\u9879","text":"<ul> <li>2024 \u5e74 OceanBase \u6570\u636e\u5e93\u5927\u8d5b\u521d\u8d5b\uff08\u56db\u5ddd\u8d5b\u533a\uff09\u4e00\u7b49\u5956, 2024</li> <li>2024 \u5e74 OceanBase \u6570\u636e\u5e93\u5927\u8d5b\u603b\u51b3\u8d5b\u7b2c 11 \u540d, 2024</li> </ul>"},{"location":"about/","title":"About","text":""},{"location":"about/#about","title":"About \ud83e\udd73","text":"<p> \u7ea6 649 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p> 2025-12-022025-12-02 \u4e2d\u6587EnglishAcadamy Page \ud83c\udf93 <p>\u4f60\u597d\uff01\u6211\u662f \u5218\u82b7\u6ea2\uff0c\u7535\u5b50\u79d1\u6280\u5927\u5b66 24 \u7ea7\u8ba1\u7b97\u673a\u79d1\u5b66\u4e0e\u6280\u672f\u7684\u7814\u7a76\u751f\u3002\u5f88\u9ad8\u5174\u80fd\u5728\u4e92\u8054\u7f51\u4e0a\u4e0e\u4f60\u76f8\u9047\ud83e\udd70\u3002</p> <p>\u73b0\u5728\u6211\u6b63\u5728\u5bfb\u627e\u5927\u6a21\u578b\u63a8\u7406\u52a0\u901f\u76f8\u5173\u7684\u5b9e\u4e60\u673a\u4f1a\u3002\u5982\u679c\u4f60\u6709\u76f8\u5173\u7684\u5c97\u4f4d\u4fe1\u606f\uff0c\u6b22\u8fce\u901a\u8fc7\u90ae\u4ef6\u6216\u8005\u793e\u4ea4\u5e73\u53f0\u8054\u7cfb\u6211\uff01</p> <p>\u6211\u5bf9\u5927\u6a21\u578b\u63a8\u7406\uff0cCUDA\uff0c\u5206\u5e03\u5f0f\u7cfb\u7edf\u3001\u6570\u636e\u5e93\u7b49\u9886\u57df\u5f88\u6709\u70ed\u60c5\uff0c\u4e5f\u559c\u6b22\u5206\u4eab\u81ea\u5df1\u7684\u5b66\u4e60\u7ecf\u9a8c\u548c\u601d\u8003\ud83e\udd13\u3002\u5982\u679c\u611f\u5174\u8da3\uff0c\u53ef\u4ee5\u770b\u770b\u6211\u7684 notes \u548c blog\uff0c\u4e5f\u8bb8\u4f1a\u627e\u5230\u4e00\u4e9b\u5bf9\u4f60\u6709\u5e2e\u52a9\u7684\u5185\u5bb9\u3002</p> <p>\u60f3\u4e86\u89e3\u6211\u7684\u7ecf\u5386\uff1f\u53ef\u4ee5\u67e5\u770b\u6211\u7684\u4e3b\u9875\ud83c\udf93\u3002</p> <p>\u6211\u559c\u6b22\u548c\u5927\u5bb6\u8fdb\u884c\u6280\u672f\u4ea4\u6d41\uff0c\u901a\u5e38\u901a\u8fc7\u5fae\u4fe1\u548c QQ \u4e0e\u5927\u5bb6\u4fdd\u6301\u8054\u7cfb\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u70b9\u51fb\u4e0b\u65b9\u7684\u56fe\u6807\uff0c\u626b\u4e00\u626b\u4e8c\u7ef4\u7801\u627e\u5230\u6211\uff0c\u968f\u65f6\u6b22\u8fce\u6dfb\u52a0\u597d\u53cb\uff01\u867d\u7136\u6211\u4e5f\u4f7f\u7528 X\uff08\u539f Twitter\uff09\uff0c\u4f46\u76ee\u524d\u4e3b\u8981\u4ee5\u9605\u8bfb\u4e3a\u4e3b\uff0c\u5f88\u5c11\u53d1\u5e03\u5185\u5bb9\ud83d\udc40\u3002</p> <p>\u5982\u679c\u6709\u4efb\u4f55\u95ee\u9898\uff0c\u6216\u8005\u60f3\u548c\u6211\u4ea4\u6d41\uff0c\u6b22\u8fce\u53d1\u90ae\u4ef6\u5230 tomlzy213@gmail.com\uff0c\u6211\u4f1a\u5c3d\u5feb\u56de\u590d\ud83d\ude0e\u3002</p> <p>\u5982\u679c\u4f60\u4e5f\u5728\u6210\u90fd\uff0c\u6b22\u8fce\u8054\u7cfb\u6211\u3002\u6211\u4eec\u53ef\u4ee5\u4e00\u8d77\u804a\u5929\u3001\u5b66\u4e60\uff0c\u6216\u8005\u4ea4\u6d41\u5171\u540c\u7684\u5174\u8da3\u7231\u597d\ud83d\udc7b\u3002</p> <p>GitHub \u6216\u8005\u77e5\u4e4e\u70b9\u4e2a\u5173\u6ce8\u8c22\u8c22\u55b5\ud83d\ude3a\uff0cGitHub \u6216\u8005\u77e5\u4e4e\u70b9\u4e2a\u5173\u6ce8\u8c22\u8c22\u55b5\ud83d\ude3a</p> <p>\u6211\u5e73\u65f6\u559c\u6b22\u542c\u97f3\u4e50\u3001\u6253\u7bee\u7403\u4ee5\u53ca\u9605\u8bfb\uff0c\u4e5f\u4f1a\u5728\u535a\u5ba2\u4e2d\u8bb0\u5f55\u4e00\u4e9b\u76f8\u5173\u5185\u5bb9\uff0c\u5206\u4eab\u4e2a\u4eba\u611f\u53d7\u270d\u3002</p> <p>Hi! I\u2019m tom-jerr, an graduated student majoring in Computer Science and Technology at UESTC (Class of 2024). It\u2019s a pleasure to meet you here\ud83e\udd70.</p> <p>I'm currently looking for internship opportunities related to accelerating large model inference. If you have any relevant job information, please feel free to contact me via email or social media!</p> <p>I am passionate about LLM Inference, CUDA, Distributed System and Database, and I enjoy sharing my learning experiences and insights\ud83e\udd13. You can check out my notes and blogs (both in Chinese) for useful resources.</p> <p>For more details, please visit my page \ud83c\udf93.</p> <p>I enjoy exchanging technical ideas with everyone and usually connect through WeChat and QQ. You can find my QR codes by clicking corresponding icon below\u2014feel free to add me! I also use X (formerly Twitter), though I mainly browse and rarely post\ud83d\udc40.</p> <p>If you have any questions or want to chat, feel free to send an email to tomlzy213@gmail.com or leave a comment below. I\u2019ll get back to you as soon as I can\ud83d\ude0e.</p> <p>If you\u2019re in Chengdu, feel free to reach out. We can chat, learn together, or share our interests\ud83d\udc7b.</p> <p>In my spare time, I enjoy listening to music, watching anime, and reading. Occasionally, I write about these hobbies on my blog to share my thoughts\u270d.</p> <p>\u6b22\u8fce\u8bbf\u95ee\u6211\u7684\u4e3b\u9875\ud83c\udf93\uff0c\u4e86\u89e3\u6211\u7684\u6559\u80b2\u80cc\u666f\u3001\u9879\u76ee\u7ecf\u9a8c\u548c\u6280\u80fd\u4e13\u957f\u3002\u5982\u679c\u4f60\u5bf9\u6211\u7684\u7ecf\u5386\u611f\u5174\u8da3\uff0c\u6216\u8005\u60f3\u8fdb\u4e00\u6b65\u4ea4\u6d41\uff0c\u6b22\u8fce\u968f\u65f6\u8054\u7cfb\u6211\uff01</p>"},{"location":"blogs/","title":"index","text":""},{"location":"blogs/#blogs","title":"Blogs \u270d","text":"2025-12-022025-12-02 <p>Abstract</p> <p>\u4e2a\u4eba\u535a\u5ba2\uff0c\u4e3b\u8981\u8bb0\u5f55</p> Text Only<pre><code>- \u5728 Database \u548cDistributed System \u76f8\u5173\u65b9\u9762\u7684\u5b66\u4e60\uff1b\n- \u4e00\u4e9b\u611f\u5174\u8da3\u8bba\u6587\u7684\u9605\u8bfb\u3002\uff1b\n- \u4e00\u4e9b\u6742\u8c08\u3002\n\n\u4e00\u4e9b\u6bd4\u8f83\u6210\u4f53\u7cfb\u7684\u7b14\u8bb0\u4f1a\u8bb0\u5f55\u5728 [Notes](../notes/index.md) \u4e2d\u3002\n\n\u672c\u90e8\u5206\u5185\u5bb9\uff08\u9664\u7279\u522b\u58f0\u660e\u5916\uff09\u91c7\u7528 [**\u7f72\u540d-\u975e\u5546\u4e1a\u6027\u4f7f\u7528-\u4fdd\u6301\u4e00\u81f4 4.0 \u56fd\u9645 (CC BY-NC-SA 4.0)**](https://creativecommons.org/licenses/by-nc-sa/4.0/) \u8bb8\u53ef\u534f\u8bae\u8fdb\u884c\u8bb8\u53ef\u3002\n</code></pre>"},{"location":"blogs/#archives","title":"Archives","text":"<p>\u5982\u679c\u5bfb\u627e\u4e0d\u65b9\u4fbf\u7684\u8bdd\uff0c\u4e0d\u59a8\u8bd5\u8bd5\u641c\u7d22\u6216\u8005\u524d\u5f80 Tags \u9875\u9762</p> <p>{{ blog_content }}</p>"},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/","title":"The history of C++ Asynchronous Solutions","text":"2025-06-102025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#key-concept","title":"Key Concept","text":"<p> \u7ea6 2521 \u4e2a\u5b57  189 \u884c\u4ee3\u7801  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 15 \u5206\u949f</p> <ol> <li>\u540c\u6b65 (Synchronous) vs. \u5f02\u6b65 (Asynchronous)</li> </ol> <ul> <li>\u540c\u6b65\uff1a\u5f53\u4f60\u53d1\u8d77\u4e00\u4e2a\u64cd\u4f5c\uff08\u6bd4\u5982\u8bfb\u53d6\u6587\u4ef6\u3001\u8bf7\u6c42\u7f51\u7edc\u6570\u636e\uff09\uff0c\u4f60\u7684\u7a0b\u5e8f\u4f1a\u505c\u5728\u90a3\u91cc\u7b49\u5f85\u8fd9\u4e2a\u64cd\u4f5c\u5b8c\u6210\uff0c\u7136\u540e\u624d\u80fd\u7ee7\u7eed\u6267\u884c\u4e0b\u4e00\u6b65\u3002\u8fd9\u5c31\u50cf\u6253\u7535\u8bdd\uff0c\u4f60\u5fc5\u987b\u7b49\u7740\u5bf9\u65b9\u63a5\u901a\u624d\u80fd\u8bf4\u8bdd\u3002</li> <li>\u5f02\u6b65\uff1a\u5f53\u4f60\u53d1\u8d77\u4e00\u4e2a\u64cd\u4f5c\uff0c\u7a0b\u5e8f\u4e0d\u4f1a\u7b49\u5f85\uff0c\u800c\u662f\u7acb\u5373\u8fd4\u56de\uff0c\u7ee7\u7eed\u6267\u884c\u540e\u7eed\u4ee3\u7801\u3002\u5f53\u90a3\u4e2a\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u67d0\u79cd\u65b9\u5f0f\uff08\u5982\u56de\u8c03\u51fd\u6570\u3001\u4e8b\u4ef6\u3001Future\uff09\u901a\u77e5\u4f60\u3002\u8fd9\u5c31\u50cf\u53d1\u77ed\u4fe1\uff0c\u4f60\u53d1\u5b8c\u540e\u53ef\u4ee5\u53bb\u505a\u522b\u7684\u4e8b\uff0c\u7b49\u6536\u5230\u56de\u590d\u65f6\u518d\u5904\u7406\u3002</li> </ul> <ol> <li>\u963b\u585e (Blocking) vs. \u975e\u963b\u585e (Non-Blocking)</li> </ol> <ul> <li>\u963b\u585e\uff1a\u4e00\u4e2a\u51fd\u6570\u6216\u64cd\u4f5c\u5728\u5b8c\u6210\u5176\u4efb\u52a1\u4e4b\u524d\u4e0d\u4f1a\u8fd4\u56de\uff0c\u4f1a\u201c\u963b\u585e\u201d\u5f53\u524d\u7ebf\u7a0b\u7684\u6267\u884c\u3002\u540c\u6b65\u64cd\u4f5c\u901a\u5e38\u662f\u963b\u585e\u7684\u3002</li> <li> </li> </ul>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#_1","title":"\u975e\u963b\u585e\uff1a\u4e00\u4e2a\u51fd\u6570\u6216\u64cd\u4f5c\u4f1a\u7acb\u5373\u8fd4\u56de\uff0c\u65e0\u8bba\u4efb\u52a1\u662f\u5426\u5b8c\u6210\u3002\u5982\u679c\u4efb\u52a1\u6ca1\u5b8c\u6210\uff0c\u5b83\u901a\u5e38\u4f1a\u8fd4\u56de\u4e00\u4e2a\u201c\u6b63\u5728\u8fdb\u884c\u4e2d\u201d\u6216\u201c\u7a0d\u540e\u518d\u8bd5\u201d\u7684\u72b6\u6001\u3002","text":"","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#future-and-promise-in-c","title":"\u6807\u51c6\u5e93\u7684\u5f02\u6b65\u5c1d\u8bd5\uff1aFuture and Promise in C++","text":"<ul> <li><code>std::future</code>: \u4e00\u4e2a\u4ee3\u8868\u672a\u6765\u67d0\u4e2a\u65f6\u523b\u624d\u4f1a\u6709\u7684\u7ed3\u679c\u7684\u5bf9\u8c61\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7\u5b83\u7684 get() \u65b9\u6cd5\u6765\u83b7\u53d6\u7ed3\u679c\u3002\u5982\u679c\u7ed3\u679c\u8fd8\u6ca1\u51c6\u5907\u597d\uff0cget() \u4f1a\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\u76f4\u5230\u7ed3\u679c\u53ef\u7528\u3002</li> <li><code>std::promise</code>: \u7528\u4e8e\u5728\u67d0\u4e2a\u7ebf\u7a0b\u4e2d\u8bbe\u7f6e\u503c\uff0c\u800c\u8fd9\u4e2a\u503c\u53ef\u4ee5\u88ab\u5173\u8054\u7684 <code>std::future</code> \u5728\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u83b7\u53d6\u3002std::async \u5185\u90e8\u5c31\u5c01\u88c5\u4e86 promise \u7684\u4f7f\u7528\u3002</li> </ul>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#example-1-logic","title":"Example 1 (Logic)","text":"<p>\u8bbe\u7ebf\u7a0b 1 \u9700\u8981\u7ebf\u7a0b 2 \u7684\u6570\u636e\uff0c\u90a3\u4e48\u7ec4\u5408\u4f7f\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <ol> <li>\u7ebf\u7a0b 1 \u521d\u59cb\u5316\u4e00\u4e2a promise \u5bf9\u8c61\u548c\u4e00\u4e2a future \u5bf9\u8c61\uff0cpromise \u4f20\u9012\u7ed9\u7ebf\u7a0b 2\uff0c\u76f8\u5f53\u4e8e\u7ebf\u7a0b 2 \u5bf9\u7ebf\u7a0b 1 \u7684\u4e00\u4e2a\u627f\u8bfa\uff1bfuture \u76f8\u5f53\u4e8e\u4e00\u4e2a\u63a5\u53d7\u4e00\u4e2a\u627f\u8bfa\uff0c\u7528\u6765\u83b7\u53d6\u672a\u6765\u7ebf\u7a0b 2 \u4f20\u9012\u7684\u503c</li> <li>\u7ebf\u7a0b 2 \u83b7\u53d6\u5230 promise \u540e\uff0c\u9700\u8981\u5bf9\u8fd9\u4e2a promise \u4f20\u9012\u6709\u5173\u7684\u6570\u636e\uff0c\u4e4b\u540e\u7ebf\u7a0b 1 \u7684 future \u5c31\u53ef\u4ee5\u83b7\u53d6\u6570\u636e\u4e86\u3002</li> <li>\u5982\u679c\u7ebf\u7a0b 1 \u60f3\u8981\u83b7\u53d6\u6570\u636e\uff0c\u800c\u7ebf\u7a0b 2 \u672a\u7ed9\u51fa\u6570\u636e\uff0c\u5219\u7ebf\u7a0b 1 \u963b\u585e\uff0c\u76f4\u5230\u7ebf\u7a0b 2 \u7684\u6570\u636e\u5230\u8fbe</li> </ol> <p></p>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#example-2-code","title":"Example 2 (Code)","text":"<p>\u4f7f\u7528<code>std::async</code>\u8fdb\u884c\u5f02\u6b65 CPU \u5bc6\u96c6\u578b\u4efb\u52a1\uff0c\u4e3b\u7ebf\u7a0b\u7b49\u5f85\u5f02\u6b65\u4efb\u52a1\u6267\u884c\u7684\u7ed3\u679c\u3002</p> C++<pre><code>#include &lt;iostream&gt;\n#include &lt;future&gt;\n#include &lt;chrono&gt;\n\nint heavy_calculation() {\n    std::this_thread::sleep_for(std::chrono::seconds(2));\n    return 42;\n}\n\nint main() {\n    // \u4f7f\u7528 std::async \u5f02\u6b65\u542f\u52a8\u4efb\u52a1\n    std::future&lt;int&gt; result_future = std::async(std::launch::async, heavy_calculation);\n\n    std::cout &lt;&lt; \"Main thread continues working while calculation is in progress...\" &lt;&lt; std::endl;\n    // ... \u5728\u8fd9\u91cc\u505a\u5176\u4ed6\u4e8b\u60c5 ...\n\n    std::cout &lt;&lt; \"Waiting for the result...\" &lt;&lt; std::endl;\n    int result = result_future.get(); // get()\u4f1a\u963b\u585e\u76f4\u5230\u7ed3\u679c\u53ef\u7528\n\n    std::cout &lt;&lt; \"The calculated result is: \" &lt;&lt; result &lt;&lt; std::endl;\n    return 0;\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#folly-future-and-promise-in-folly","title":"Folly \u5bf9\u6807\u51c6\u5e93\u7684\u8fdb\u4e00\u6b65\u5c01\u88c5\u548c\u6269\u5c55\uff1aFuture and Promise in Folly","text":"<p>Future \u7684\u6267\u884c\u901a\u8fc7 Executor \u6267\u884c\uff0cFolly \u5141\u8bb8 Future \u8fdb\u884c\u94fe\u5f0f\u8c03\u7528\uff0cPromise setValue \u540e\u6267\u884c\u56de\u8c03\uff0c\u8fd9\u4e00\u6b65\u5b9e\u9645\u4e0a\u662f\u5c06\u8be5\u8fc7\u7a0b\u52a0\u5165 eventloop\uff0c\u7531\u4e8b\u4ef6\u5faa\u73af\u53bb\u89e6\u53d1\u3002</p> <p></p>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#example","title":"Example","text":"<ol> <li>\u542f\u52a8: \u4e3b\u7ebf\u7a0b\u521b\u5efa\u4e86\u6240\u6709\u7ec4\u4ef6\u5e76\u542f\u52a8\u4e86\u4e8b\u4ef6\u5faa\u73af\u3002</li> <li>\u9636\u6bb5 1: \u7b2c\u4e00\u4e2a .thenValue() \u56de\u8c03\u5728\u4e3b\u7ebf\u7a0b\u4e0a\u6267\u884c\uff0c\u56e0\u4e3a\u8fd9\u662f mainEventBase \u8fd0\u884c\u7684\u5730\u65b9\u3002\u8fd9\u7b26\u5408\u9884\u671f\u3002</li> <li>\u5207\u6362\u5230\u7ebf\u7a0b\u6c60: via(cpuExecutor.get()) \u751f\u6548\u3002</li> <li>\u9636\u6bb5 2: \u7b2c\u4e8c\u4e2a .thenValue() \u56de\u8c03\u88ab\u8c03\u5ea6\u5230 CPUThreadPoolExecutor \u7684\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u4e0a\u3002\u7ebf\u7a0b ID \u7684\u53d8\u5316\u662f via() \u8d77\u4f5c\u7528\u7684\u6700\u76f4\u63a5\u8bc1\u660e\u3002 \u8017\u65f6\u7684\u8ba1\u7b97\u5728\u8fd9\u91cc\u8fdb\u884c\uff0c\u5b8c\u5168\u4e0d\u4f1a\u5f71\u54cd\u4e3b\u4e8b\u4ef6\u5faa\u73af\u7684\u54cd\u5e94\u3002</li> <li>\u5207\u6362\u56de EventBase: via(&amp;mainEventBase) \u751f\u6548\u3002</li> <li>\u9636\u6bb5 3: \u7b2c\u4e09\u4e2a .thenValue() \u56de\u8c03\u88ab\u8c03\u5ea6\u56de\u4e3b\u7ebf\u7a0b\u3002\u8fd9\u5bf9\u4e8e\u9700\u8981\u4e0e\u7279\u5b9a\u7ebf\u7a0b\uff08\u5982 UI \u7ebf\u7a0b\uff09\u4ea4\u4e92\u6216\u5bf9\u5171\u4eab\u8d44\u6e90\u8fdb\u884c\u4e32\u884c\u8bbf\u95ee\u7684\u573a\u666f\u81f3\u5173\u91cd\u8981\u3002</li> <li>\u7ed3\u675f: \u56de\u8c03\u4e2d\u8c03\u7528 terminateLoopSoon()\uff0c\u4e8b\u4ef6\u5faa\u73af\u7ed3\u675f\uff0c\u7a0b\u5e8f\u9000\u51fa\u3002</li> </ol> C++<pre><code>// \u8f85\u52a9\u51fd\u6570\uff0c\u6253\u5370\u5f53\u524d\u7ebf\u7a0bID\u548c\u6d88\u606f\nvoid print_thread_info(const std::string&amp; message) {\n    std::cout &lt;&lt; \"[\" &lt;&lt; std::this_thread::get_id() &lt;&lt; \"] \" &lt;&lt; message &lt;&lt; std::endl;\n}\n\nint main() {\n    // === 1. \u8bbe\u7f6e\u6267\u884c\u5668 ===\n    // a) \u4e3b\u4e8b\u4ef6\u5faa\u73af\uff0c\u7528\u4e8eI/O\u548c\u6700\u7ec8\u66f4\u65b0\n    folly::EventBase mainEventBase;\n    // b) CPU\u7ebf\u7a0b\u6c60\uff0c\u7528\u4e8e\u8ba1\u7b97\u5bc6\u96c6\u578b\u4efb\u52a1\n    //    \u521b\u5efa\u4e00\u4e2a\u67094\u4e2a\u7ebf\u7a0b\u7684\u7ebf\u7a0b\u6c60\n    auto cpuExecutor = std::make_unique&lt;folly::CPUThreadPoolExecutor&gt;(4);\n\n    print_thread_info(\"Main thread started. Setting up future chain.\");\n    print_thread_info(\"mainEventBase is running on this thread once loop starts.\");\n\n    // === 2. \u521b\u5efa\u5e76\u94fe\u63a5 Future \u94fe ===\n\n    // \u542f\u52a8\u4e00\u4e2aFuture\u94fe\uff0c\u521d\u59cb\u503c\u4e3a\u4e00\u4e2a\u7528\u6237ID\n    folly::makeFuture(123)\n\n        // ---------------------------------------------------------------------\n        // \u9636\u6bb5 1: \u5728\u9ed8\u8ba4\u6267\u884c\u5668 (mainEventBase) \u4e0a\u8fd0\u884c\n        // .then() \u7684\u56de\u8c03\u9ed8\u8ba4\u4f1a\u5728\u6dfb\u52a0\u5b83\u7684\u7ebf\u7a0b\uff08\u8fd9\u91cc\u662f\u4e3b\u7ebf\u7a0b\uff09\u7684 EventBase \u4e0a\u8c03\u5ea6\n        .thenValue([&amp;](int userID) {\n            print_thread_info(\"Phase 1: Fetched user ID. Preparing for heavy computation.\");\n            // \u6a21\u62df\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\u7684\u539f\u59cb\u6570\u636e\n            return \"raw_data_for_user_\" + std::to_string(userID);\n        })\n\n        // ---------------------------------------------------------------------\n        // *** \u5173\u952e\u90e8\u5206: \u5207\u6362\u5230 CPU \u7ebf\u7a0b\u6c60 ***\n        // via() \u786e\u4fdd\u4e0b\u4e00\u4e2a .then() \u5c06\u5728 cpuExecutor \u7684\u4e00\u4e2a\u7ebf\u7a0b\u4e0a\u6267\u884c\n        .via(cpuExecutor.get())\n\n        // ---------------------------------------------------------------------\n        // \u9636\u6bb5 2: \u5728 CPUThreadPoolExecutor \u7684\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u4e0a\u8fd0\u884c\n        .thenValue([](std::string rawData) {\n            print_thread_info(\"Phase 2: Starting heavy computation on CPU thread pool.\");\n            // \u6a21\u62df\u8017\u65f6\u7684 CPU \u5bc6\u96c6\u578b\u5de5\u4f5c\n            std::this_thread::sleep_for(std::chrono::seconds(2));\n            std::string processedData = \"PROCESSED(\" + rawData + \")\";\n            print_thread_info(\"Phase 2: Computation finished.\");\n            return processedData;\n        })\n\n        // ---------------------------------------------------------------------\n        // *** \u5173\u952e\u90e8\u5206: \u5207\u6362\u56de\u4e3b EventBase ***\n        // via() \u786e\u4fdd\u4e0b\u4e00\u4e2a .then() \u5c06\u56de\u5230 mainEventBase \u4e0a\u6267\u884c\n        .via(&amp;mainEventBase)\n\n        // ---------------------------------------------------------------------\n        // \u9636\u6bb5 3: \u56de\u5230\u4e3b EventBase \u7ebf\u7a0b\u4e0a\u8fdb\u884c\u6700\u7ec8\u5904\u7406\n        .thenValue([&amp;](std::string finalData) {\n            print_thread_info(\"Phase 3: Back on main EventBase. Finalizing result.\");\n            std::cout &lt;&lt; \"\\n&gt;&gt;&gt; FINAL RESULT: \" &lt;&lt; finalData &lt;&lt; \" &lt;&lt;&lt;\\n\" &lt;&lt; std::endl;\n\n            // \u5de5\u4f5c\u5b8c\u6210\uff0c\u505c\u6b62\u4e8b\u4ef6\u5faa\u73af\n            print_thread_info(\"Phase 3: Terminating event loop.\");\n            mainEventBase.terminateLoopSoon();\n        })\n\n        // \u5f02\u5e38\u5904\u7406\n        .thenError(folly::tag_t&lt;std::exception&gt;{}, [&amp;](const std::exception&amp; e) {\n            print_thread_info(\"An error occurred in the chain: \" + std::string(e.what()));\n            mainEventBase.terminateLoopSoon();\n        });\n\n\n    // === 3. \u542f\u52a8\u4e8b\u4ef6\u5faa\u73af ===\n    print_thread_info(\"Future chain is set up. Starting event loop...\");\n    mainEventBase.loopForever();\n\n    // === 4. \u6e05\u7406\u8d44\u6e90 ===\n    // \u7b49\u5f85\u6240\u6709\u7ebf\u7a0b\u6c60\u4e2d\u7684\u4efb\u52a1\u5b8c\u6210\n    cpuExecutor-&gt;join();\n    print_thread_info(\"Program finished.\");\n    return 0;\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#_2","title":"\u5e38\u7528\u65b9\u6cd5","text":"","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#collectall","title":"collectAll()","text":"<ul> <li>collectAll \u6301\u6709\u4e00\u4e2a\u5143\u7d20\u7c7b\u578b\u4e3a<code>Future&lt;T&gt;</code>\u7684\u53ef\u8fed\u4ee3\u96c6\u5408\u7c7b\u578b\uff0c\u8fd4\u56de\u4e00\u4e2a<code>Future&lt;std::vector&lt;Try&lt;T&gt;&gt;&gt;</code> \uff0c\u8fd9\u4e2a\u8fd4\u56de\u7684 Future \u5c06\u5728\u6240\u6709\u7684 input futures \u90fd\u53d8\u4e3a completed \u72b6\u6001\u65f6\u53d8\u4e3a completed \u72b6\u6001\u3002\u7ed3\u679c(resultant)Future \u4e2d\u7684 vector \u5c06\u6309\u7167 Future \u88ab\u6dfb\u52a0\u7684\u987a\u5e8f\u5305\u542b input futures \u7684\u503c\uff08\u6216\u8005\u5f02\u5e38\uff09\u3002\u4efb\u4f55\u7ec4\u4ef6 Future \u7684\u9519\u8bef\u90fd\u4e0d\u4f1a\u5bfc\u81f4\u8fd9\u4e2a\u8fc7\u7a0b\u63d0\u524d\u7ec8\u6b62\uff0cinput futures \u90fd\u662f\u88ab move \u800c\u53d8\u5f97\u65e0\u6548\u3002</li> </ul>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#via","title":"via()","text":"<ul> <li>Future \u62e5\u6709\u4e00\u4e2a via()\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u9700\u8981\u4e00\u4e2a Executor \u7c7b\u578b\u7684\u53c2\u6570\u3002Executor \u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u63a5\u53e3\uff0c\u5b83\u53ea\u5b58\u5728\u4e00\u4e2a\u7ebf\u7a0b\u5b89\u5168\u7684<code>add(std::function&lt;void()&gt; func)</code> \u65b9\u6cd5\uff0c\u5b83\u4f1a\u5728\u67d0\u4e2a\u65f6\u5019\u6267\u884c\u8fd9\u4e2a func\uff0c\u5c3d\u7ba1\u4e0d\u662f\u7acb\u5373\u6267\u884c\u3002\u800c via()\u53ef\u4ee5\u786e\u4fdd\u88ab\u8bbe\u7f6e\u7684\u56de\u8c03\u51fd\u6570\u5728\u6307\u5b9a\u7684 Executor \u4e0a\u6267\u884c\u3002</li> </ul>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#executor","title":"Executor \u5e38\u7528\u5b9e\u73b0","text":"<ul> <li>ThreadPoolExecutor \uff1a\u662f\u4e00\u4e2a\u62bd\u8c61\u7684\u7ebf\u7a0b\u6c60\u5b9e\u73b0\uff0c\u652f\u6301\u8c03\u6574\u5927\u5c0f\u3001\u81ea\u5b9a\u4e49\u7ebf\u7a0b\u5de5\u5382\u3001\u6c60\u548c\u6bcf\u4e2a\u4efb\u52a1\u7684\u7edf\u8ba1\u4fe1\u606f\u3001\u652f\u6301 NUMA\u3001\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u4efb\u52a1\u7ec8\u7ed3\u3002\u5f53\u524d\u5b83\u6709\u4e24\u4e2a\u5b9e\u73b0\u3002</li> <li>CPUThreadPoolExecutor\uff08\u662f\u4e00\u4e2a\u901a\u7528\u7ebf\u7a0b\u6c60\uff0c\u9664\u4e86\u4e0a\u8ff0\u529f\u80fd\u4e4b\u5916\uff0c\u5b83\u8fd8\u652f\u6301\u4efb\u52a1\u4f18\u5148\u7ea7\uff09</li> <li>IOThreadPoolExecutor (\u7c7b\u4f3c CPUThreadPoolExecutor\uff0c\u4f46\u662f\u6bcf\u4e00\u4e2a\u7ebf\u7a0b\u90fd\u5728\u4e00\u4e2a EventBase \u4e8b\u4ef6\u5faa\u73af loop)\u3002</li> <li>EventBase \uff1a\u662f\u4e00\u4e2a Executor\uff0c\u628a\u4efb\u52a1\u4f5c\u4e3a\u4e00\u4e2a\u56de\u8c03\u5728\u4e8b\u4ef6\u5faa\u73af\u4e0a\u6267\u884c\u3002</li> <li>FutureExecutor\uff1a\u5305\u88c5\u4e86\u5176\u4ed6 Executor\uff0c\u5e76\u63d0\u4f9b\u4e86<code>Future&lt;T&gt; addFuture(F func)</code>\u51fd\u6570\u8fd4\u56de\u4e00\u4e2a Future \u7528\u4e8e\u5f02\u6b65\u83b7\u53d6\u51fd\u6570\u7684\u6267\u884c\u7ed3\u679c\u3002</li> </ul>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#c-c26stdexecution","title":"C++ \u5f02\u6b65\u7684\u8fdb\u4e00\u6b65\u62bd\u8c61\uff08C++26\uff09\uff1astd::execution","text":"","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#architecture-overview","title":"Architecture overview","text":"<ul> <li> <p>Sender: lazy value\uff0c\u4f1a\u5ef6\u8fdf\u5230\u9700\u8981\u65f6\u624d\u8ba1\u7b97</p> </li> <li> <p>Receiver: continuation \u6216\u8005 callback\uff0c\u5f53 sender \u8ba1\u7b97\u5b8c\u6210\u65f6\uff0c\u5f97\u5230\u7684\u503c\u4f1a\u4f20\u5165 receiver \u800c\u4e0d\u662f\u8fd4\u56de\u7ed9\u8c03\u7528\u65b9\u3002</p> </li> <li> <p>Scheduler: \u8d44\u6e90\u7684\u63cf\u8ff0\u7b26\u3002</p> </li> </ul> <p></p>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#sender-details","title":"Sender Details","text":"<ul> <li>lazy: \u521b\u5efa\u53d1\u9001\u8005\u4e0d\u4f1a\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002</li> <li>potential: \u5b83\u77e5\u9053\u5728\u6210\u529f\u65f6\u5c06\u4ea7\u751f\u4ec0\u4e48\u7c7b\u578b\u7684\u503c\uff08T...\uff09\uff0c\u53ef\u80fd\u4ea7\u751f\u7684\u9519\u8bef\uff08E\uff09\uff0c\u6216\u8005\u662f\u5426\u53ef\u4ee5\u88ab\u53d6\u6d88\u3002</li> <li>composition: \u4f60\u53ef\u4ee5\u4f7f\u7528\u53ef\u7ba1\u9053\u64cd\u4f5c\u7b26\uff08|\uff09\u5982 then()\u3001upon_error()\u3001transfer()\u7b49\u5c06\u53d1\u9001\u8005\u94fe\u63a5\u5728\u4e00\u8d77\u3002\u94fe\u4e2d\u7684\u6bcf\u4e00\u6b65\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u3001\u66f4\u590d\u6742\u7684\u53d1\u9001\u8005\u3002</li> </ul> C++<pre><code>// Pseudocode for chaining senders\nauto final_work_order = scheduler.schedule()               // Sender 1: A sender that says \"run on this scheduler\"\n                      | then([]{ return read_file(); })   // Sender 2: A new sender that wraps Sender 1 and adds file reading\n                      | then([](string data){ return parse(data); }); // Sender 3: A new sender that wraps Sender 2...\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#receiver-details","title":"Receiver Details","text":"<p>\u63a5\u6536\u8005\u662f\u53d1\u9001\u8005\u7ed3\u679c\u7684\u4f7f\u7528\u8005\u3002\u5b83\u672c\u8d28\u4e0a\u662f\u4e00\u4e2a\u5177\u6709\u4e09\u4e2a\u4e0d\u540c\u901a\u9053\u7684\u56de\u8c03\u3002\u63a5\u6536\u8005\u5fc5\u987b\u5177\u6709\u8fd9\u4e09\u4e2a\u65b9\u6cd5\uff1a</p> <ul> <li> <p>set_value(T... values): \u5f53\u53d1\u9001\u8005\u7684\u64cd\u4f5c\u6210\u529f\u5b8c\u6210\u65f6\u88ab\u8c03\u7528\u3002\u5de5\u4f5c\u5df2\u7ecf\u5b8c\u6210\u3002</p> </li> <li> <p>set_error(E error): \u5f53\u53d1\u9001\u8005\u7684\u64cd\u4f5c\u5931\u8d25\u65f6\u8c03\u7528\u3002\u5de5\u4f5c\u5df2\u5b8c\u6210\u3002</p> </li> <li> <p>set_done(): \u5f53\u64cd\u4f5c\u88ab\u53d6\u6d88\u6216\u65e0\u503c/\u9519\u8bef\u5b8c\u6210\uff08\u4f8b\u5982\uff0c\u53d1\u9001\u8005\u88ab\u505c\u6b62\uff09\u65f6\u8c03\u7528\u3002\u5de5\u4f5c\u5df2\u5b8c\u6210\u3002</p> </li> </ul> C++<pre><code>// Pseudocode for a receiver (often a lambda)\nauto my_callback = receiver {\n    .set_value = [](auto result){ std::cout &lt;&lt; \"Success! Result is \" &lt;&lt; result &lt;&lt; std::endl; },\n    .set_error = [](auto error){ std::cout &lt;&lt; \"Failure! Error was \" &lt;&lt; error &lt;&lt; std::endl; },\n    .set_done  = []{ std::cout &lt;&lt; \"Operation was cancelled.\" &lt;&lt; std::endl; }\n};\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#scheduler-details","title":"Scheduler Details","text":"<ul> <li>execution context: \u8fd9\u53ef\u4ee5\u662f\u4e00\u4e2a\u7ebf\u7a0b\u6c60\u3001\u5f53\u524d\u7ebf\u7a0b\u3001\u7279\u5b9a\u7684 UI \u7ebf\u7a0b\u3001GPU \u6d41\u6216 I/O \u4e8b\u4ef6\u5faa\u73af\u3002</li> <li>factory for senders: \u8c03\u5ea6\u5668\u7684\u9996\u8981\u4efb\u52a1\u662f\u901a\u8fc7\u5176 <code>.schedule()</code> \u65b9\u6cd5\u751f\u6210\u4e00\u4e2a\u53d1\u9001\u8005\u3002\u8fd9\u4e2a\u201c\u8c03\u5ea6\u53d1\u9001\u8005\u201d\u662f\u5927\u591a\u6570\u5f02\u6b65\u5de5\u4f5c\u94fe\u7684\u8d77\u70b9\u3002\u5b83\u662f\u4e00\u4e2a\u5728\u542f\u52a8\u65f6\uff0c\u4ec5\u4ec5\u5728\u8c03\u5ea6\u5668\u7684\u4e0a\u4e0b\u6587\u4e2d\u5b8c\u6210\u7684\u53d1\u9001\u8005\u3002</li> </ul> C++<pre><code>// Get a scheduler from a thread pool\nthread_pool my_pool;\nscheduler auto sch = my_pool.get_scheduler();\n\n// Create a sender that will execute its subsequent work on the thread pool\nsender auto start_on_pool = sch.schedule();\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#bridge-between-sender-and-receiver","title":"Bridge between Sender and Receiver","text":"","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#connect","title":"connect()","text":"<ol> <li><code>std::execution::connect(sender, receiver) -&gt; operation_state</code></li> </ol> <ul> <li>\u5b83\u8fd4\u56de\u4e00\u4e2a operation_state \u5bf9\u8c61\u3002</li> <li>\u8fd9\u4ecd\u7136\u662f\u4e00\u4e2a\u61d2\u52a0\u8f7d\u6b65\u9aa4\uff0c\u4f46\u5b83\u53ef\u80fd\u4f1a\u6267\u884c\u9884\u8ba1\u7b97\u3001\u5185\u5b58\u5206\u914d\u7b49\u64cd\u4f5c\u3002\u5b83\u521b\u5efa\u4e86\u4e00\u4e2a\u53ef\u4ee5\u7acb\u5373\u8fd0\u884c\u7684\u8f6f\u4ef6\u5305\u3002</li> </ul> <ol> <li><code>std::execution::start(operation_state)</code></li> </ol> <ul> <li>\u8fd9\u662f\u552f\u4e00\u4e00\u4e2a\u6025\u5207\u6267\u884c\u7684\u51fd\u6570\u3002\u5b83\u63a5\u6536 operation_state \u5e76\u8bf4\"\u5f00\u59cb\u6267\u884c\uff01\"\u3002</li> <li>\u5b83\u662f\u5373\u63d2\u5373\u7528\u7684\u3002\u5b83\u7acb\u5373\u8fd4\u56de void</li> <li>\u53d1\u9001\u65b9\u63cf\u8ff0\u7684\u5de5\u4f5c\u5c06\u5728\u5176\u8c03\u5ea6\u5668\u63d0\u4f9b\u7684\u4e0a\u4e0b\u6587\u4e2d\u5f00\u59cb\u6267\u884c\u3002</li> <li>\u5728\u672a\u6765\u7684\u67d0\u4e2a\u65f6\u523b\uff0c\u5de5\u4f5c\u5c06\u5b8c\u6210\uff0c\u6301\u6709\u63a5\u6536\u65b9\u7684 operation_state \u5c06\u8c03\u7528\u5176 set_value\u3001set_error \u6216 set_done \u4e2d\u7684\u4e00\u4e2a\u65b9\u6cd5\u3002</li> </ul>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#coroutine-with-stdexecution","title":"Coroutine with std::execution","text":"","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#what-is-coroutine","title":"what is coroutine","text":"<p><code>co_await io_task</code>\u4e4b\u540e\uff0ccoroutine \u4f1a\u88ab\u6302\u8d77\u6765\uff0c\u6211\u4eec\u9996\u5148\u5c06 io \u4efb\u52a1\u5b89\u6392\u597d\uff08\u5229\u7528 epoll\u3001iouring\u3001windows IOCP \u7b49\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684 io \u5de5\u5177\uff09\u3002</p> <ul> <li>\u4e00\u822c\u6765\u8bb2\uff0c\u4f1a\u6709\u5355\u72ec\u7684\u4e00\u4e2a\u6216\u8005\u591a\u4e2a io \u7ebf\u7a0b\uff0c\u4e0d\u65ad\u4ece\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8bfb\u53d6 io \u72b6\u6001\uff0c\u4e00\u65e6 io \u5b8c\u6bd5\uff0c\u8fd9\u4e2a io \u7ebf\u7a0b\u4f1a\u8c03\u7528<code>handle.resume()</code>\uff0c\u4e8e\u662f\u540e\u7eed\u4efb\u52a1\u5c31\u4f1a\u5728 io \u7ebf\u7a0b\u4e2d\u5b8c\u6210\u3002</li> <li>\u5f53\u7136 io \u7ebf\u7a0b\u4e5f\u53ef\u4ee5\u9009\u62e9\u4e00\u65e6\u7ed3\u675f\uff0c\u5c31\u5c06 handle \u8c03\u5ea6\u5230\u5176\u4ed6 worker \u7ebf\u7a0b\uff0cworker \u7ebf\u7a0b\u4f1a\u8c03\u7528<code>handle.resume()</code>\u3002</li> </ul> C++<pre><code>some_return_type  my_coroutine() {\n     co_await async_read(some_buffer);\n     /// runs in some io threads or worker threads\n     ....\n     co_await async_write(some_buffer);\n     /// runs in some io threads or worker threads\n     ....\n     co_return;\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#task","title":"task","text":"<ul> <li>task \u662f\u4e00\u4e2a return_type\uff0c\u5c31\u662f\u8bf4\u4e00\u4e2a coroutine \u53ef\u4ee5 return task\u3002</li> <li>task \u662f\u4e00\u4e2a awaiter\uff0c\u5c31\u662f\u8bf4\u53ef\u4ee5 co_await \u4e00\u4e2a task \u7684 object\u3002</li> <li><code>task::promise_type</code>\u5c31\u662f\u4e00\u4e2a coroutine \u7684 promise\u3002\u5c31\u662f\u8bf4\u4e00\u4e2a coroutine \u5982\u679c\u8fd4\u56de\u4e86 task\uff0c\u90a3\u4e48\u7f16\u8bd1\u5668\u53ef\u4ee5\u76f4\u63a5\u4ece task::promise_type \u627e promise \u7684\u7c7b\u578b\u662f\u4ec0\u4e48\uff0c\u5e76\u751f\u6210 promsie object\u3002</li> </ul>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#example_1","title":"example","text":"<ol> <li>logic    - \u9ed8\u8ba4 task \u518d <code>initial_suspend</code> \u4f1a\u76f4\u63a5\u6302\u8d77\u8be5\u534f\u7a0b\u3002    - \u5728 my_coroutine \u88ab resume\uff0c\u5e76\u4e14\u5b8c\u5168\u6267\u884c\u5b8c\u6bd5\uff08co_await final_suspend()\uff09\u7684\u65f6\u5019\uff0canother_coroutine \u624d\u4f1a resume\u3002co_await just_coroutine \u8fc7\u7a0b\u4e5f\u662f\u5982\u6b64\u3002    - \u7b49\u5230 my_coroutine \u6267\u884c\u7ed3\u675f\u540e\uff0c<code>final_suspend</code>\u4f1a\u6062\u590d another_coroutine \u7684\u6267\u884c\u3002</li> </ol> <ol> <li>code</li> </ol> C++<pre><code>task&lt;void&gt; just_coroutine() {\n  std::cout &lt;&lt; \"just cout\\n\";\n}\n\ntask&lt;int&gt; my_coroutine() {\n    // task\u7f3a\u7701\u5b9e\u73b0\u7684promise\u662f\u4e00\u4e2alazy promise\u3002\n    // \u521a\u8fdb\u5165my_coroutine\u7684\u65f6\u5019\uff0c\u5728co_await promise.initial_suspend()\u7684\u65f6\u5019\uff0c\n    // \u4f1a\u76f4\u63a5\u6302\u8d77\u6765\uff0c\u4e0b\u9762\u7684co_await just_coroutine\u5e76\u4e0d\u4f1a\u7acb\u523b\u6267\u884c\u3002\n\n    co_await just_coroutine;\n    co_return 1;\n}\n\n\n// \u6ce8\u610f another coroutine\u4e5f\u662f\u4e00\u4e2alazy coroutine\uff08\u56e0\u4e3atask&lt;&gt; \u7f3a\u7701\u5b9e\u73b0)\ntask&lt;&gt; another_coroutine() {\n\n    // t\u662f\u4e00\u4e2atask&lt;int&gt;\u7c7b\u578b\uff0cmy_coroutine\u76f4\u63a5\u88ab\u6302\u8d77\u6765\u540e\uff0c\u8fd4\u56detask\uff0c\u5e76\u7ee7\u7eed\u8fd0\u884c\u8fd9\u91cc\n    auto t = my_coroutine();\n\n    // co_await t\u7684\u65f6\u5019\uff0c\u4f1a\u8c03\u7528 t.get_handle().resume(),\u5c31\u662f\u8bf4 co_await t\u7684\u65f6\u5019\uff0c\u624d\u4f1a\n    // \u63a5\u7740\u8fd0\u884c my_coroutine\u91cc\u7684 co_await just_coroutine\u3002\n    // \u540c\u65f6\uff0c\u672ccoroutine\uff08another_coroutine)\u4f1a\u88ab\u6302\u8d77\u6765\u3002\n    co_await t;\n    // \u5728 my_coroutine \u88abresume\uff0c\u5e76\u4e14\u5b8c\u5168\u6267\u884c\u5b8c\u6bd5\uff08co_await final_suspend()\uff09\u7684\u65f6\u5019\uff0c\u672ccoroutine\n    // \u624d\u4f1aresume\uff0c\u5c31\u662f\u8bf4\u672ccoroutine\u4f1a\u4e00\u76f4\u7b49\u5230 t\u6240\u4ee3\u8868\u7684\u4efb\u52a1\u5168\u90e8\u5b8c\u6210\u540e\uff0c\u624d\u4f1aresume()\u3002\n\n    // co_await just_coroutine\u53ef\u80fd\u5728\u522b\u7684\u7ebf\u7a0b\u5c06my_coroutine resume\uff0ctask\u63d0\u4f9b\u63a5\u53e3\u62ff\u5230 co_return\u7ed3\u679c\uff08co_return 1)\n    if (t.is_done()) {\n        print(t.get_result());\n     }\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#combine-coroutine-and-execution","title":"combine coroutine and execution","text":"<ul> <li>\u6bcf\u4e2a task \u90fd\u662f\u4e00\u4e2a\u5c0f\u4efb\u52a1\uff08\u7c7b\u4f3c\u4e8e sender\uff09\uff0c\u5f53\u53e6\u4e00\u4e2a task 2 \u4ee3\u8868\u7684 coroutine\uff0c\u8c03\u7528\u4e86 co_await task1 \u7684\u65f6\u5019\uff0ctask1 \u4ee3\u8868\u7684\u4efb\u52a1\u5b8c\u5168\u7ed3\u675f\u540e\uff0ctask2 \u624d\u4f1a\u7ee7\u7eed\u8fd0\u884c\u3002task2 \u6240\u4ee3\u8868\u7684\u4efb\u52a1\u5c31\u76f8\u5f53\u4e8e\u5305\u542b\u4e86\uff08\u7ec4\u5408\u4e86\uff09task1 \u7684\u4efb\u52a1\u3002\u8fd9\u548c execution \u662f\u5341\u5206\u50cf\u7684\u3002</li> <li>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u7c7b\u4f3c sender \u7684 connect \u63a5\u53e3\uff0c\u5b83\u7684\u5b9e\u73b0\u662f\u4e00\u4e2a lazy \u7684 coroutine\u3002</li> <li>\u8fd0\u884c connect(awaiter, receiver)\u7684\u65f6\u5019\uff0ccoroutine \u6302\u8d77\u6765\uff08\u5185\u90e8\u7684\u903b\u8f91\u5b8c\u5168\u6ca1\u6709\u8fd0\u884c\uff09\uff0ccoroutine \u4f1a\u8fd4\u56de\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7c7b\u578b\uff0c\u5728 execution \u6846\u67b6\u91cc\uff0c\u5c31\u662f\u8fd4\u56de operation\u3002</li> <li>\u5f53 start(op)\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ea\u8981\u5728 start(op)\u91cc\u8c03\u7528 handle.resume()\uff0c\u5373\u53ef\u7ee7\u7eed\u8fd0\u884c connect \u8fd9\u4e2a coroutine\u3002 C++<pre><code>my_awaiter awaiter;\nauto op = connect(awaiter, my_receiver{});\nstart(op);\n</code></pre></li> </ul>","tags":["C++"]},{"location":"blogs/posts/C%2B%2B%E5%BC%82%E6%AD%A5%E6%96%B9%E6%A1%88/#nvidia-stdexec-example","title":"NVIDIA std::exec example","text":"<p>\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u5f02\u6b65\u5de5\u4f5c\u6d41\uff1a\u9996\u5148\u7b49\u5f85 s2 \u5b8c\u6210\uff0c\u7136\u540e\u7b49\u5f85 s1 \u5b8c\u6210\uff0c\u5e76\u8fd4\u56de s1 \u7684\u7ed3\u679c\u3002 \u8fd9\u662f\u4e00\u4e2a\u5f02\u6b65\u7684\u201c\u4e32\u884c\u201d\u64cd\u4f5c\u3002</p> <ul> <li><code>co_await static_cast&lt;S2&amp;&amp;&gt;(s2)</code>: \u7b49\u5f85 s2 \u8fd9\u4e2a\u5f02\u6b65\u64cd\u4f5c\u5b8c\u6210\uff0c\u4f46\u5ffd\u7565\u5b83\u7684\u7ed3\u679c\uff08\u56e0\u4e3a s2 \u662f just()\uff0c\u7ed3\u679c\u662f\u7a7a\uff09\u3002</li> <li><code>co_return co_await static_cast&lt;S1&amp;&amp;&gt;(s1)</code>: \u5728 s2 \u5b8c\u6210\u540e\uff0c\u534f\u7a0b\u6062\u590d\u6267\u884c\u3002\u5b83\u63a5\u7740 co_await s1 (just(42))\u3002\u5f53 s1 \u5b8c\u6210\u5e76\u8fd4\u56de\u503c 42 \u65f6\uff0cco_return \u4f1a\u5c06\u8fd9\u4e2a\u503c 42 \u4f5c\u4e3a\u6574\u4e2a exec::task \u7684\u6700\u7ec8\u7ed3\u679c\u8fd4\u56de\u3002</li> <li><code>get_stop_token()</code>: \u8fd9\u662f\u4e00\u4e2a Sender\uff0c\u5f53\u5b83\u88ab\u6267\u884c\u65f6\uff0c\u4f1a\u8fd4\u56de\u4e0e\u5f53\u524d\u6267\u884c\u73af\u5883\u5173\u8054\u7684 inplace_stop_token\u3002\u8fd9\u4e2a token \u53ef\u4ee5\u7528\u6765\u67e5\u8be2\u662f\u5426\u6536\u5230\u4e86\u505c\u6b62\u8bf7\u6c42\u3002   stopped_as_optional(get_stop_token()): \u518d\u6b21\u4f7f\u7528 stopped_as_optional\u3002</li> <li>\u5982\u679c\u6267\u884c\u73af\u5883\u6ca1\u6709\u505c\u6b62\u8bf7\u6c42\uff0cget_stop_token() \u4f1a\u6210\u529f\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a stop_token\u3002stopped_as_optional \u4f1a\u5c06\u5176\u5305\u88c5\u5728 std::optional \u4e2d\u3002</li> <li>\u5982\u679c\u6267\u884c\u73af\u5883\u6709\u505c\u6b62\u8bf7\u6c42\uff0cget_stop_token() \u4f1a\u4f20\u64ad\u201c\u505c\u6b62\u201d\u4fe1\u53f7\u3002stopped_as_optional \u4f1a\u6355\u83b7\u5b83\u5e76\u8fd4\u56de\u4e00\u4e2a std::nullopt\u3002</li> </ul> C++<pre><code>using namespace stdexec;\n\ntemplate &lt;sender S1, sender S2&gt;\nauto async_answer(S1 s1, S2 s2) -&gt; exec::task&lt;int&gt; {\n  // Senders are implicitly awaitable (in this coroutine type):\n  co_await static_cast&lt;S2&amp;&amp;&gt;(s2);\n  co_return co_await static_cast&lt;S1&amp;&amp;&gt;(s1);\n}\n\ntemplate &lt;sender S1, sender S2&gt;\nauto async_answer2(S1 s1, S2 s2) -&gt; exec::task&lt;std::optional&lt;int&gt;&gt; {\n  co_return co_await stopped_as_optional(async_answer(s1, s2));\n}\n\n// tasks have an associated stop token\nauto async_stop_token() -&gt; exec::task&lt;std::optional&lt;stdexec::inplace_stop_token&gt;&gt; {\n  co_return co_await stopped_as_optional(get_stop_token());\n}\n\nauto main() -&gt; int {\n  try {\n    // Awaitables are implicitly senders:\n    auto [i] = stdexec::sync_wait(async_answer2(just(42), just())).value();\n    std::cout &lt;&lt; \"The answer is \" &lt;&lt; i.value() &lt;&lt; '\\n';\n  } catch (std::exception&amp; e) {\n    std::cout &lt;&lt; e.what() &lt;&lt; '\\n';\n  }\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/CS144/","title":"CS144-TCP\u534f\u8bae\u7b80\u5355\u5b9e\u73b0","text":"2024-04-222025-12-10 <code>#C</code> <code>#S</code> <code>#1</code> <code>#4</code> <code>#4</code>"},{"location":"blogs/posts/CS144/#minnow","title":"Minnow","text":"<p> \u7ea6 1134 \u4e2a\u5b57  902 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 17 \u5206\u949f</p> <ul> <li>\u521d\u59cb\u7684<code>TCPSocket</code>\u662f\u5728Linux TCP/IP\u6808\u4e0a\u5c01\u88c5\u7684\u4e00\u4e2a\u7c7b</li> <li><code>lab4</code>\u5f00\u59cb\u81ea\u5df1\u6784\u5efa<code>TCPPeer</code>\u5bf9\u7aef\u8fdb\u884c\u6570\u636e\u4f20\u8f93\uff0c\u76f4\u63a5\u4f7f\u7528\u7f51\u5361\u4e0a\u7684IP\u6570\u636e\u5305\u8fdb\u884cTCP\u5305\u7684\u6784\u5efa</li> <li><code>lab5</code>\u5b9e\u73b0\u7b80\u6613ARP\u534f\u8bae\uff0c\u53ef\u4ee5\u8f6c\u6362IP\u5730\u5740\u548cMAC\u5730\u5740NetworkInterface</li> <li><code>lab6</code>\u5b9e\u73b0\u4e86\u6700\u957f\u524d\u7f00\u5339\u914d\u7684\u94fe\u8def\u5c42\u9009\u8def\u7b97\u6cd5IP route</li> <li><code>lab7</code>\u5b9e\u73b0\u4e86\u4e00\u4e2a\u4f7f\u7528IProute\u3001NetworkInterface\u7684\u7aef\u5230\u7aef\u7684TCP\u62a5\u6587\u4f20\u8f93</li> </ul>"},{"location":"blogs/posts/CS144/#_1","title":"\u6570\u636e\u683c\u5f0f","text":""},{"location":"blogs/posts/CS144/#ip","title":"IP\u5305","text":"<ul> <li>IPv4\u6570\u636e\u5305\u6784\u5efa\uff1a\u4e0d\u652f\u6301IP\u9009\u9879</li> </ul> C++<pre><code>// IPv4 Internet datagram header (note: IP options are not supported)\nstruct IPv4Header\n{\n  static constexpr size_t LENGTH = 20;        // IPv4 header length, not including options\n  static constexpr uint8_t DEFAULT_TTL = 128; // A reasonable default TTL value\n  static constexpr uint8_t PROTO_TCP = 6;     // Protocol number for TCP\n\n  static constexpr uint64_t serialized_length() { return LENGTH; }\n\n  /*\n   *   0                   1                   2                   3\n   *   0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1\n   *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   *  |Version|  IHL  |Type of Service|          Total Length         |\n   *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   *  |         Identification        |Flags|      Fragment Offset    |\n   *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   *  |  Time to Live |    Protocol   |         Header Checksum       |\n   *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   *  |                       Source Address                          |\n   *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   *  |                    Destination Address                        |\n   *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   *  |                    Options                    |    Padding    |\n   *  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+\n   */\n\n  // IPv4 Header fields\n  uint8_t ver = 4;           // IP version\n  uint8_t hlen = LENGTH / 4; // header length (multiples of 32 bits)\n  uint8_t tos = 0;           // type of service\n  uint16_t len = 0;          // total length of packet\n  uint16_t id = 0;           // identification number\n  bool df = true;            // don't fragment flag\n  bool mf = false;           // more fragments flag\n  uint16_t offset = 0;       // fragment offset field\n  uint8_t ttl = DEFAULT_TTL; // time to live field\n  uint8_t proto = PROTO_TCP; // protocol field\n  uint16_t cksum = 0;        // checksum field\n  uint32_t src = 0;          // src address\n  uint32_t dst = 0;          // dst address\n\n  // Length of the payload\n  uint16_t payload_length() const;\n\n  // Pseudo-header's contribution to the TCP checksum\n  uint32_t pseudo_checksum() const;\n\n  // Set checksum to correct value\n  void compute_checksum();\n\n  // Return a string containing a header in human-readable format\n  std::string to_string() const;\n\n  void parse( Parser&amp; parser );\n  void serialize( Serializer&amp; serializer ) const;\n};\n</code></pre>"},{"location":"blogs/posts/CS144/#tcp","title":"TCP\u62a5\u6587","text":"<ul> <li>TCPMessage\u5305\u542bTCPSenderMessage\u548cTCPReceiverMessage</li> </ul> C++<pre><code>struct TCPMessage\n{\n  TCPSenderMessage sender {};\n  TCPReceiverMessage receiver {};\n};\n\nstruct TCPSenderMessage\n{\n  Wrap32 seqno { 0 };\n\n  bool SYN {};\n  std::string payload {};\n  bool FIN {};\n\n  bool RST {};\n\n  // How many sequence numbers does this segment use?\n  size_t sequence_length() const { return SYN + payload.size() + FIN; }\n};\n\nstruct TCPReceiverMessage\n{\n  std::optional&lt;Wrap32&gt; ackno {};\n  uint16_t window_size {};\n  bool RST {};\n};\n</code></pre> <ul> <li> <p>\u5728IP\u4e0a\u6784\u5efa\u81ea\u5df1\u7684TCP\u62a5\u6587\uff1b\u5c06IP\u6570\u636e\u5305\u901a\u8fc7TUN\u8bbe\u5907\u4e0e\u7f51\u7edc\u4e0a\u5176\u4ed6TCP\u8fdb\u884c\u901a\u4fe1</p> C++<pre><code>class TCPOverIPv4Adapter : public FdAdapterBase\n{\npublic:\nstd::optional&lt;TCPMessage&gt; unwrap_tcp_in_ip( const InternetDatagram&amp; ip_dgram );\n\nInternetDatagram wrap_tcp_in_ip( const TCPMessage&amp; msg );\n};\n\noptional&lt;TCPMessage&gt; TCPOverIPv4Adapter::unwrap_tcp_in_ip( const InternetDatagram&amp; ip_dgram )\n{\n// is the IPv4 datagram for us?\n// Note: it's valid to bind to address \"0\" (INADDR_ANY) and reply from actual address contacted\nif ( not listening() and ( ip_dgram.header.dst != config().source.ipv4_numeric() ) ) {\n  return {};\n}\n\n// is the IPv4 datagram from our peer?\nif ( not listening() and ( ip_dgram.header.src != config().destination.ipv4_numeric() ) ) {\n  return {};\n}\n\n// does the IPv4 datagram claim that its payload is a TCP segment?\nif ( ip_dgram.header.proto != IPv4Header::PROTO_TCP ) {\n  return {};\n}\n\n// is the payload a valid TCP segment?\nTCPSegment tcp_seg;\nif ( not parse( tcp_seg, ip_dgram.payload, ip_dgram.header.pseudo_checksum() ) ) {\n  return {};\n}\n\n// is the TCP segment for us?\nif ( tcp_seg.udinfo.dst_port != config().source.port() ) {\n  return {};\n}\n\n// should we target this source addr/port (and use its destination addr as our source) in reply?\nif ( listening() ) {\n  if ( tcp_seg.message.sender.SYN and not tcp_seg.message.sender.RST ) {\n    config_mutable().source = Address { inet_ntoa( { htobe32( ip_dgram.header.dst ) } ), config().source.port() };\n    config_mutable().destination\n      = Address { inet_ntoa( { htobe32( ip_dgram.header.src ) } ), tcp_seg.udinfo.src_port };\n    set_listening( false );\n  } else {\n    return {};\n  }\n}\n\n// is the TCP segment from our peer?\nif ( tcp_seg.udinfo.src_port != config().destination.port() ) {\n  return {};\n}\n\nreturn tcp_seg.message;\n}\n\n//! Takes a TCP segment, sets port numbers as necessary, and wraps it in an IPv4 datagram\n//! \\param[in] seg is the TCP segment to convert\nInternetDatagram TCPOverIPv4Adapter::wrap_tcp_in_ip( const TCPMessage&amp; msg )\n{\n  TCPSegment seg { .message = msg };\n  // set the port numbers in the TCP segment\n  seg.udinfo.src_port = config().source.port();\n  seg.udinfo.dst_port = config().destination.port();\n\n  // create an Internet Datagram and set its addresses and length\n  InternetDatagram ip_dgram;\n  ip_dgram.header.src = config().source.ipv4_numeric();\n  ip_dgram.header.dst = config().destination.ipv4_numeric();\n  ip_dgram.header.len = ip_dgram.header.hlen * 4 + 20 /* tcp header len */ + seg.message.sender.payload.size();\n\n  // set payload, calculating TCP checksum using information from IP header\n  seg.compute_checksum( ip_dgram.header.pseudo_checksum() );\n  ip_dgram.header.compute_checksum();\n  ip_dgram.payload = serialize( seg );\n\n  return ip_dgram;\n}\n</code></pre> </li> </ul>"},{"location":"blogs/posts/CS144/#fd","title":"FD\u64cd\u4f5c","text":"<ul> <li>\u5bf9FD\u7684\u64cd\u4f5c\u6bd4\u5982write\u548cread\uff0c\u90fd\u662f\u5bf9\u7cfb\u7edf\u8c03\u7528\u7684\u5c01\u88c5</li> </ul>"},{"location":"blogs/posts/CS144/#tcp_1","title":"TCP\u5de5\u4f5c\u6d41\u7a0b","text":"<ul> <li>\u4e8b\u4ef6\u9a71\u52a8\u6a21\u5f0f\u8fdb\u884cTCP\u7684\u76d1\u542c\uff0c\u8c03\u7528poll\u7cfb\u7edf\u8c03\u7528\u63a5\u6536\u6d88\u606f\uff1b\u8bbe\u7f6e\u56de\u8c03\uff0c\u5c06\u7f51\u7edc\u4e0a\u7684IP\u6570\u636e\u5305\u4f20\u9012\u5230\u6211\u4eec\u8bbe\u8ba1\u7684TCP\u4e0a</li> <li>TCPPeer\u6784\u5efa\u6d4b\u8bd5\u7a0b\u5e8f\uff0c\u540c\u6837\u4f7f\u7528\u4e8b\u4ef6\u9a71\u52a8\uff0c\u53ea\u662f\u56de\u8c03\u7565\u6709\u4e0d\u540c</li> </ul>"},{"location":"blogs/posts/CS144/#tcp_2","title":"\u521d\u59cb\u5316TCP","text":"<ul> <li>\u8bbe\u7f6epoll\u9700\u8981\u76d1\u542c\u7684\u4e8b\u4ef6   1. \u6536\u5230\u6570\u636e\u5305\uff0c\u5c06TCP\u62a5\u6587\u4f20\u9012\u7ed9TCPPeer\u63a5\u6536   1. \u8bfb\u53d6<code>pipe</code>\u7684\u5b57\u8282\u4f20\u9012\u7ed9TCPPeer\uff1a\u7528\u6237\u5728\u547d\u4ee4\u884c\u8f93\u5165\u5b57\u7b26\u4e32\u4f7f\u7528TCPSender\u53d1\u9001\u5230\u5bf9\u7aef   1. \u4ece<code>Reassembler</code>\u4e2d\u8bfb\u53d6\u5b57\u8282\u5199\u5165<code>LocalStreamSocket</code>\uff1a\u7528\u6237\u4ecereassembler\u4e2d\u8bfb\u53d6\u5b57\u7b26\u4e32\uff0c\u5199\u5165unix\u57df\u5957\u63a5\u5b57</li> </ul> C++<pre><code>template&lt;TCPDatagramAdapter AdaptT&gt;\nvoid TCPMinnowSocket&lt;AdaptT&gt;::_initialize_TCP( const TCPConfig&amp; config )\n{\n  _tcp.emplace( config );\n\n  // Set up the event loop\n\n  // There are three events to handle:\n  //\n  // 1) Incoming datagram received (needs to be given to TCPPeer::receive method)\n  //\n  // 2) Outbound bytes received from local application via a write()\n  //    call (needs to be read from the local stream socket and\n  //    given to TCPPeer)\n  //\n  // 3) Incoming bytes reassembled by the Reassembler\n  //    (needs to be read from the inbound_stream and written\n  //    to the local stream socket back to the application)\n\n  // rule 1: read from filtered packet stream and dump into TCPConnection\n  _eventloop.add_rule(\n    \"receive TCP segment from the network\",\n    _datagram_adapter.fd(),\n    Direction::In,\n    [&amp;] {\n      if ( auto seg = _datagram_adapter.read() ) {\n        _tcp-&gt;receive( std::move( seg.value() ), [&amp;]( auto x ) { _datagram_adapter.write( x ); } );\n      }\n\n      // debugging output:\n      if ( _thread_data.eof() and _tcp.value().sender().sequence_numbers_in_flight() == 0 and not _fully_acked ) {\n        std::cerr &lt;&lt; \"DEBUG: minnow outbound stream to \" &lt;&lt; _datagram_adapter.config().destination.to_string()\n                  &lt;&lt; \" has been fully acknowledged.\\n\";\n        _fully_acked = true;\n      }\n    },\n    [&amp;] { return _tcp-&gt;active(); } );\n\n  // rule 2: read from pipe into outbound buffer\n  _eventloop.add_rule(\n    \"push bytes to TCPPeer\",\n    _thread_data,\n    Direction::In,\n    [&amp;] {\n      std::string data;\n      data.resize( _tcp-&gt;outbound_writer().available_capacity() );\n      _thread_data.read( data );\n      _tcp-&gt;outbound_writer().push( move( data ) );\n\n      if ( _thread_data.eof() ) {\n        _tcp-&gt;outbound_writer().close();\n        _outbound_shutdown = true;\n\n        // debugging output:\n        std::cerr &lt;&lt; \"DEBUG: minnow outbound stream to \" &lt;&lt; _datagram_adapter.config().destination.to_string()\n                  &lt;&lt; \" finished (\" &lt;&lt; _tcp.value().sender().sequence_numbers_in_flight() &lt;&lt; \" seqno\"\n                  &lt;&lt; ( _tcp.value().sender().sequence_numbers_in_flight() == 1 ? \"\" : \"s\" )\n                  &lt;&lt; \" still in flight).\\n\";\n      }\n\n      _tcp-&gt;push( [&amp;]( auto x ) { _datagram_adapter.write( x ); } );\n    },\n    [&amp;] {\n      return ( _tcp-&gt;active() ) and ( not _outbound_shutdown )\n             and ( _tcp-&gt;outbound_writer().available_capacity() &gt; 0 );\n    },\n    [&amp;] {\n      _tcp-&gt;outbound_writer().close();\n      _outbound_shutdown = true;\n    },\n    [&amp;] {\n      std::cerr &lt;&lt; \"DEBUG: minnow outbound stream had error.\\n\";\n      _tcp-&gt;outbound_writer().set_error();\n    } );\n\n  // rule 3: read from inbound buffer into pipe\n  _eventloop.add_rule(\n    \"read bytes from inbound stream\",\n    _thread_data,\n    Direction::Out,\n    [&amp;] {\n      Reader&amp; inbound = _tcp-&gt;inbound_reader();\n      // Write from the inbound_stream into\n      // the pipe, handling the possibility of a partial\n      // write (i.e., only pop what was actually written).\n      if ( inbound.bytes_buffered() ) {\n        const std::string_view buffer = inbound.peek();\n        const auto bytes_written = _thread_data.write( buffer );\n        inbound.pop( bytes_written );\n      }\n\n      if ( inbound.is_finished() or inbound.has_error() ) {\n        _thread_data.shutdown( SHUT_WR );\n        _inbound_shutdown = true;\n\n        // debugging output:\n        std::cerr &lt;&lt; \"DEBUG: minnow inbound stream from \" &lt;&lt; _datagram_adapter.config().destination.to_string()\n                  &lt;&lt; \" finished \" &lt;&lt; ( inbound.has_error() ? \"uncleanly.\\n\" : \"cleanly.\\n\" );\n      }\n    },\n    [&amp;] {\n      return _tcp-&gt;inbound_reader().bytes_buffered()\n             or ( ( _tcp-&gt;inbound_reader().is_finished() or _tcp-&gt;inbound_reader().has_error() )\n                  and not _inbound_shutdown );\n    },\n    [&amp;] {},\n    [&amp;] {\n      std::cerr &lt;&lt; \"DEBUG: minnow inbound stream had error.\\n\";\n      _tcp-&gt;inbound_reader().set_error();\n    } );\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#connect","title":"connect","text":"<ul> <li><code>connect</code>\u4e8b\u4ef6\u662f\u5411TCP\u5bf9\u7aef\u5199\u6570\u636e(SYN\u5305)</li> </ul> C++<pre><code>template&lt;TCPDatagramAdapter AdaptT&gt;\nvoid TCPMinnowSocket&lt;AdaptT&gt;::connect( const TCPConfig&amp; c_tcp, const FdAdapterConfig&amp; c_ad )\n{\n  if ( _tcp ) {\n    throw std::runtime_error( \"connect() with TCPConnection already initialized\" );\n  }\n\n  _initialize_TCP( c_tcp );\n\n  _datagram_adapter.config_mut() = c_ad;\n\n  std::cerr &lt;&lt; \"DEBUG: minnow connecting to \" &lt;&lt; c_ad.destination.to_string() &lt;&lt; \"...\\n\";\n\n  if ( not _tcp.has_value() ) {\n    throw std::runtime_error( \"TCPPeer not successfully initialized\" );\n  }\n\n  _tcp-&gt;push( [&amp;]( auto x ) { _datagram_adapter.write( x ); } );\n\n  if ( _tcp-&gt;sender().sequence_numbers_in_flight() != 1 ) {\n    throw std::runtime_error( \"After TCPConnection::connect(), expected sequence_numbers_in_flight() == 1\" );\n  }\n\n  _tcp_loop( [&amp;] { return _tcp-&gt;sender().sequence_numbers_in_flight() == 1; } );\n  if ( _tcp-&gt;inbound_reader().has_error() ) {\n    std::cerr &lt;&lt; \"DEBUG: minnow error on connecting to \" &lt;&lt; c_ad.destination.to_string() &lt;&lt; \".\\n\";\n  } else {\n    std::cerr &lt;&lt; \"DEBUG: minnow successfully connected to \" &lt;&lt; c_ad.destination.to_string() &lt;&lt; \".\\n\";\n  }\n\n  _tcp_thread = std::thread( &amp;TCPMinnowSocket::_tcp_main, this );\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#listen_and_accept","title":"listen_and_accept","text":"<ul> <li><code>listen_and_accept</code>\u76d1\u542c\u5bf9\u7aef\u662f\u5426\u56de\u590dack</li> </ul> C++<pre><code>template&lt;TCPDatagramAdapter AdaptT&gt;\nvoid TCPMinnowSocket&lt;AdaptT&gt;::listen_and_accept( const TCPConfig&amp; c_tcp, const FdAdapterConfig&amp; c_ad )\n{\n  if ( _tcp ) {\n    throw std::runtime_error( \"listen_and_accept() with TCPConnection already initialized\" );\n  }\n\n  _initialize_TCP( c_tcp );\n\n  _datagram_adapter.config_mut() = c_ad;\n  _datagram_adapter.set_listening( true );\n\n  std::cerr &lt;&lt; \"DEBUG: minnow listening for incoming connection...\\n\";\n  _tcp_loop( [&amp;] { return ( not _tcp-&gt;has_ackno() ) or ( _tcp-&gt;sender().sequence_numbers_in_flight() ); } );\n  std::cerr &lt;&lt; \"DEBUG: minnow new connection from \" &lt;&lt; _datagram_adapter.config().destination.to_string() &lt;&lt; \".\\n\";\n\n  _tcp_thread = std::thread( &amp;TCPMinnowSocket::_tcp_main, this );\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#_2","title":"\u6267\u884c\u4e3b\u51fd\u6570","text":"<ul> <li> <p>\u4e00\u76f4\u5faa\u73af\uff0c\u771f\u6b63\u7ed3\u675f\u7684\u51fd\u6570\u5728<code>_tcp_loop</code></p> </li> <li> <p><code>_tcp_loop</code>\u7ed3\u675f\u5728poll\u7b49\u5f85\u4e8b\u4ef6\u7ed3\u675f</p> </li> <li> <p>\u51fa\u9519</p> </li> <li>TCP\u8fde\u63a5\u7684fd\u5173\u95ed</li> </ul> C++<pre><code>template&lt;TCPDatagramAdapter AdaptT&gt;\nvoid TCPMinnowSocket&lt;AdaptT&gt;::_tcp_main()\n{\n  try {\n    if ( not _tcp.has_value() ) {\n      throw std::runtime_error( \"no TCP\" );\n    }\n    _tcp_loop( [] { return true; } );\n    shutdown( SHUT_RDWR );\n    if ( not _tcp.value().active() ) {\n      std::cerr &lt;&lt; \"DEBUG: minnow TCP connection finished \"\n                &lt;&lt; ( _tcp-&gt;inbound_reader().has_error() ? \"uncleanly.\\n\" : \"cleanly.\\n\" );\n    }\n    _tcp.reset();\n  } catch ( const std::exception&amp; e ) {\n    std::cerr &lt;&lt; \"Exception in TCPConnection runner thread: \" &lt;&lt; e.what() &lt;&lt; \"\\n\";\n    throw e;\n  }\n}\n\n//! \\param[in] condition is a function returning true if loop should continue\ntemplate&lt;TCPDatagramAdapter AdaptT&gt;\nvoid TCPMinnowSocket&lt;AdaptT&gt;::_tcp_loop( const std::function&lt;bool()&gt;&amp; condition )\n{\n  auto base_time = timestamp_ms();\n  while ( condition() ) {\n    auto ret = _eventloop.wait_next_event( TCP_TICK_MS );\n    if ( ret == EventLoop::Result::Exit or _abort ) {\n      break;\n    }\n\n    if ( not _tcp.has_value() ) {\n      throw std::runtime_error( \"_tcp_loop entered before TCPPeer initialized\" );\n    }\n\n    if ( _tcp.value().active() ) {\n      const auto next_time = timestamp_ms();\n      _tcp.value().tick( next_time - base_time, [&amp;]( auto x ) { _datagram_adapter.write( x ); } );\n      _datagram_adapter.tick( next_time - base_time );\n      base_time = next_time;\n    }\n  }\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#tcppeer","title":"TCPPeer","text":"<ul> <li>\u63a5\u6536TCPMessage\uff0c\u7136\u540e\u5411\u5bf9\u7aef\u53d1\u9001\u6d88\u606f</li> </ul> C++<pre><code>class TCPPeer\n{\n  auto make_send( const auto&amp; transmit )\n  {\n    return [&amp;]( const TCPSenderMessage&amp; x ) { send( x, transmit ); };\n  }\n\npublic:\n  void receive( TCPMessage msg, const TransmitFunction&amp; transmit )\n  {\n    if ( not active() ) {\n      return;\n    }\n\n    // Record time in case this peer has to linger after streams finish.\n    time_of_last_receipt_ = cumulative_time_;\n\n    // If SenderMessage occupies a sequence number, make sure to reply.\n    need_send_ |= ( msg.sender.sequence_length() &gt; 0 );\n\n    // If SenderMessage is a \"keep-alive\" (with intentionally invalid seqno), make sure to reply.\n    // (N.B. orthodox TCP rules require a reply on any unacceptable segment.)\n    const auto our_ackno = receiver_.send().ackno;\n    need_send_ |= ( our_ackno.has_value() and msg.sender.seqno + 1 == our_ackno.value() );\n\n    // Did the inbound stream finish before the outbound stream? If so, no need to linger after streams finish.\n    if ( receiver_.writer().is_closed() and not sender_.reader().is_finished() ) {\n      linger_after_streams_finish_ = false;\n    }\n\n    // Give incoming TCPSenderMessage to receiver.\n    receiver_.receive( std::move( msg.sender ) );\n\n    // Give incoming TCPReceiverMessage to sender.\n    sender_.receive( msg.receiver );\n\n    // Send reply if needed.\n    if ( need_send_ ) {\n      send( sender_.make_empty_message(), transmit );\n    }\n  }\n\n\nprivate:\n  void send( const TCPSenderMessage&amp; sender_message, const TransmitFunction&amp; transmit )\n  {\n    TCPMessage msg { sender_message, receiver_.send() };\n    transmit( std::move( msg ) );\n    need_send_ = false;\n  }\n};\n</code></pre>"},{"location":"blogs/posts/CS144/#_3","title":"\u6d4b\u8bd5\u7aef","text":"<ul> <li> <p><code>bidirectional_stream_copy</code>\u89e6\u53d1rule1\u548crule2\uff1b\u89e6\u53d1<code>_initialize_TCP</code>\u7684read pipe into outbound buffer\uff1b\u7136\u540e\u53d1\u9001\u7ed9\u5bf9\u7aef\u6570\u636e\u62a5</p> </li> <li> <p>\u89e6\u53d1<code>_initialize_TCP</code>\u7684<code>receive TCP segment from network</code>\uff0c\u8fdb\u884c\u6d88\u606f\u7684\u6536\u53d1</p> </li> <li> <p>rule1: read from stdin into outbound byte stream</p> </li> <li> <p>rule2: read from outbound byte stream into socket</p> </li> <li> <p>rule3: read from socket into inbound byte stream</p> </li> <li> <p>rule4: read from inbound byte stream into stdout</p> </li> </ul> C++<pre><code>void bidirectional_stream_copy( Socket&amp; socket, string_view peer_name )\n{\n  constexpr size_t buffer_size = 1048576;\n\n  EventLoop _eventloop {};\n  FileDescriptor _input { STDIN_FILENO };\n  FileDescriptor _output { STDOUT_FILENO };\n  ByteStream _outbound { buffer_size };\n  ByteStream _inbound { buffer_size };\n  bool _outbound_shutdown { false };\n  bool _inbound_shutdown { false };\n\n  socket.set_blocking( false );\n  _input.set_blocking( false );\n  _output.set_blocking( false );\n\n  // rule 1: read from stdin into outbound byte stream\n  _eventloop.add_rule(\n    \"read from stdin into outbound byte stream\",\n    _input,\n    Direction::In,\n    [&amp;] {\n      string data;\n      data.resize( _outbound.writer().available_capacity() );\n      _input.read( data );\n      _outbound.writer().push( move( data ) );\n      if ( _input.eof() ) {\n        _outbound.writer().close();\n      }\n    },\n    [&amp;] {\n      return !_outbound.has_error() and !_inbound.has_error() and ( _outbound.writer().available_capacity() &gt; 0 )\n             and !_outbound.writer().is_closed();\n    },\n    [&amp;] { _outbound.writer().close(); },\n    [&amp;] {\n      cerr &lt;&lt; \"DEBUG: Outbound stream had error from source.\\n\";\n      _outbound.set_error();\n      _inbound.set_error();\n    } );\n\n  // rule 2: read from outbound byte stream into socket\n  _eventloop.add_rule(\n    \"read from outbound byte stream into socket\",\n    socket,\n    Direction::Out,\n    [&amp;] {\n      if ( _outbound.reader().bytes_buffered() ) {\n        _outbound.reader().pop( socket.write( _outbound.reader().peek() ) );\n      }\n      if ( _outbound.reader().is_finished() ) {\n        socket.shutdown( SHUT_WR );\n        _outbound_shutdown = true;\n        cerr &lt;&lt; \"DEBUG: Outbound stream to \" &lt;&lt; peer_name &lt;&lt; \" finished.\\n\";\n      }\n    },\n    [&amp;] {\n      return _outbound.reader().bytes_buffered() or ( _outbound.reader().is_finished() and not _outbound_shutdown );\n    },\n    [&amp;] { _outbound.writer().close(); },\n    [&amp;] {\n      cerr &lt;&lt; \"DEBUG: Outbound stream had error from destination.\\n\";\n      _outbound.set_error();\n      _inbound.set_error();\n    } );\n\n  // rule 3: read from socket into inbound byte stream\n  _eventloop.add_rule(\n    \"read from socket into inbound byte stream\",\n    socket,\n    Direction::In,\n    [&amp;] {\n      string data;\n      data.resize( _inbound.writer().available_capacity() );\n      socket.read( data );\n      _inbound.writer().push( move( data ) );\n      if ( socket.eof() ) {\n        _inbound.writer().close();\n      }\n    },\n    [&amp;] {\n      return !_inbound.has_error() and !_outbound.has_error() and ( _inbound.writer().available_capacity() &gt; 0 )\n             and !_inbound.writer().is_closed();\n    },\n    [&amp;] { _inbound.writer().close(); },\n    [&amp;] {\n      cerr &lt;&lt; \"DEBUG: Inbound stream had error from source.\\n\";\n      _outbound.set_error();\n      _inbound.set_error();\n    } );\n\n  // rule 4: read from inbound byte stream into stdout\n  _eventloop.add_rule(\n    \"read from inbound byte stream into stdout\",\n    _output,\n    Direction::Out,\n    [&amp;] {\n      if ( _inbound.reader().bytes_buffered() ) {\n        _inbound.reader().pop( _output.write( _inbound.reader().peek() ) );\n      }\n      if ( _inbound.reader().is_finished() ) {\n        _output.close();\n        _inbound_shutdown = true;\n        cerr &lt;&lt; \"DEBUG: Inbound stream from \" &lt;&lt; peer_name &lt;&lt; \" finished\"\n             &lt;&lt; ( _inbound.has_error() ? \" uncleanly.\\n\" : \".\\n\" );\n      }\n    },\n    [&amp;] {\n      return _inbound.reader().bytes_buffered() or ( _inbound.reader().is_finished() and not _inbound_shutdown );\n    },\n    [&amp;] { _inbound.writer().close(); },\n    [&amp;] {\n      cerr &lt;&lt; \"DEBUG: Inbound stream had error from destination.\\n\";\n      _outbound.set_error();\n      _inbound.set_error();\n    } );\n\n  // loop until completion\n  while ( true ) {\n    if ( EventLoop::Result::Exit == _eventloop.wait_next_event( -1 ) ) {\n      return;\n    }\n  }\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#ip_1","title":"IP\u5305\u53d1\u9001\u63a5\u6536\u7684\u8bbe\u5907\u652f\u6301","text":"<ul> <li> <p>\u6784\u5efa\u53ef\u4ee5\u901a\u4fe1\u7684TCP\uff0c\u6cdb\u578bAdapt\u9700\u8981\u6ee1\u8db3write\u548cread\u7684\u7ea6\u675f\uff1bCS144TCPSocket\u6ce8\u518c\u4e86\u4e00\u4e2aTUN\uff08\u7f51\u7edc\u96a7\u9053\uff09\u8bbe\u5907\u6765\u53d1\u9001\u548c\u63a5\u6536IP\u6570\u636e\u5305\u3002</p> </li> <li> <p>write\u5c06\u6211\u4eec\u6784\u9020\u7684TCP\u5305\u5e8f\u5217\u5316\u540e\u5199\u5165TUN\u8bbe\u5907</p> </li> <li> <p>read\u8bfb\u53d6IP\u5305\u5934\uff0c\u83b7\u53d6TCP\u62a5\u5934\u548c\u62a5\u6587(<code>unwrap_tcp_in_ip</code>)</p> </li> </ul> C++<pre><code>template&lt;class T&gt;\nconcept TCPDatagramAdapter = requires( T a, TCPMessage seg ) {\n  {\n    a.write( seg )\n  } -&gt; std::same_as&lt;void&gt;;\n\n  {\n    a.read()\n  } -&gt; std::same_as&lt;std::optional&lt;TCPMessage&gt;&gt;;\n};\n\n//! \\brief A FD adapter for IPv4 datagrams read from and written to a TUN device\nclass TCPOverIPv4OverTunFdAdapter : public TCPOverIPv4Adapter\n{\nprivate:\n  TunFD _tun;\n\npublic:\n  //! Construct from a TunFD\n  explicit TCPOverIPv4OverTunFdAdapter( TunFD&amp;&amp; tun ) : _tun( std::move( tun ) ) {}\n\n  //! Attempts to read and parse an IPv4 datagram containing a TCP segment related to the current connection\n  std::optional&lt;TCPMessage&gt; read();\n\n  //! Creates an IPv4 datagram from a TCP segment and writes it to the TUN device\n  void write( const TCPMessage&amp; seg ) { _tun.write( serialize( wrap_tcp_in_ip( seg ) ) ); }\n\n  //! Access the underlying TUN device\n  explicit operator TunFD&amp;() { return _tun; }\n\n  //! Access the underlying TUN device\n  explicit operator const TunFD&amp;() const { return _tun; }\n\n  //! Access underlying file descriptor\n  FileDescriptor&amp; fd() { return _tun; }\n};\n\noptional&lt;TCPMessage&gt; TCPOverIPv4OverTunFdAdapter::read()\n{\n  vector&lt;string&gt; strs( 2 );\n  strs.front().resize( IPv4Header::LENGTH );\n  _tun.read( strs );\n\n  InternetDatagram ip_dgram;\n  const vector&lt;string&gt; buffers = { strs.at( 0 ), strs.at( 1 ) };\n  if ( parse( ip_dgram, buffers ) ) {\n    return unwrap_tcp_in_ip( ip_dgram );\n  }\n  return {};\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#tcp_3","title":"TCP\u5b9e\u73b0","text":"<ul> <li>\u4e00\u4e2aTCP\u7684\u5bf9\u7b49\u7aef\u9700\u8981\u5b9e\u73b0\u7684\u6838\u5fc3\u6570\u636e\u7ed3\u6784\u548c\u529f\u80fd\u5982\u4e0b</li> </ul> C++<pre><code>class TCPPeer\n{\n\npublic:\n  explicit TCPPeer( const TCPConfig&amp; cfg ) : cfg_( cfg ) {}\n\n  Writer&amp; outbound_writer() { return sender_.writer(); }\n  Reader&amp; inbound_reader() { return receiver_.reader(); }\n\n  /* Passthrough methods */\n  void push( const TransmitFunction&amp; transmit ) { sender_.push( make_send( transmit ) ); }\n\n  void receive( TCPMessage msg, const TransmitFunction&amp; transmit );\n\n  // Testing interface\n  const TCPReceiver&amp; receiver() const { return receiver_; }\n  const TCPSender&amp; sender() const { return sender_; }\n\nprivate:\n  TCPConfig cfg_;\n  TCPSender sender_ { ByteStream { cfg_.send_capacity }, cfg_.isn, cfg_.rt_timeout };\n  TCPReceiver receiver_ { Reassembler { ByteStream { cfg_.recv_capacity } } };\n\n  void send( const TCPSenderMessage&amp; sender_message, const TransmitFunction&amp; transmit );\n};\n</code></pre>"},{"location":"blogs/posts/CS144/#_4","title":"\u91cd\u8981\u6570\u636e\u7ed3\u6784","text":""},{"location":"blogs/posts/CS144/#byte_stream","title":"Byte_Stream","text":"<ul> <li>\u5b9e\u73b0\u5b57\u7b26\u4e32\u7684\u5148\u8fdb\u5148\u51fa\uff1b<code>Writer</code>\u5199\u5165\u5b57\u7b26\u4e32\uff0c<code>Reader</code>\u8bfb\u51fa\u4efb\u610f\u957f\u5ea6\u7684\u5b57\u7b26</li> <li>\u4e3a\u4e86\u6027\u80fd\uff0c\u4f7f\u7528<code>std::queue&lt;std::string&gt;</code>\uff0c\u8bb0\u5f55\u5f39\u51fa\u5b57\u7b26\u5728\u5b57\u7b26\u4e32\u4e2d\u7684\u7d22\u5f15\u5b9e\u73b0<code>peek()</code></li> </ul> C++<pre><code>void Writer::push( string data )\n{\n  // Your code here.\n  size_t datalen = data.size();\n  size_t write_avail = Writer::available_capacity();\n\n  if ( Writer::is_closed() || write_avail == 0 || data.empty() ) {\n    return;\n  }\n  if ( datalen &gt; write_avail ) {\n    data.resize( write_avail );\n  }\n  pushed_ += data.size();\n  buffered_ += data.size();\n  data_.emplace( std::move( data ) );\n}\n\nstring_view Reader::peek() const\n{\n  // Your code here.\n  return data_.empty() ? string_view {} : string_view { data_.front() }.substr( read_index_ );\n}\n\nvoid Reader::pop( uint64_t len )\n{\n  // Your code here.\n  buffered_ -= len;\n  poped_ += len;\n  while ( len != 0U ) {\n    uint64_t size = data_.front().size() - read_index_;\n    if ( len &lt; size ) {\n      read_index_ += len;\n      break;\n    }\n    // \u9700\u8981\u5411\u524d\u79fb\u52a8\u4e00\u4e2astring\n    data_.pop();\n    read_index_ = 0;\n    len -= size;\n  }\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#reassembler","title":"Reassembler","text":"<ul> <li>\u5c06\u4e71\u5e8f\u63a5\u6536\u7684\u5b57\u7b26\u4e32\u53d8\u4e3a\u6709\u5e8f\u5b57\u8282\u6d41\uff0c\u4f7f\u7528<code>map</code>\u8fdb\u884c\u4e71\u5e8f\u5b57\u7b26\u4e32\u7684\u5b58\u50a8\uff1b\u91cd\u70b9\u5728\u4e8e\u5904\u7406\u91cd\u53e0\u5b57\u4e32</li> </ul>"},{"location":"blogs/posts/CS144/#_5","title":"\u91cd\u53e0\u5b57\u4e32\u7684\u5904\u7406","text":"<ul> <li> <p>\u627e\u5230\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u7b49\u4e8e<code>pos</code>\u7684\u8fed\u4ee3\u5668\uff0c\u5982\u679cmap\u4e2d\u542b\u6709\u7684\u5b57\u7b26\u4e32\u4e0e\u8981\u63d2\u5165\u7684\u5b57\u7b26\u4e32\u4ea7\u751f\u91cd\u53e0\uff0c\u79fb\u9664\u542b\u6709\u7684\u5b57\u7b26\u4e32\u91cd\u53e0\u90e8\u5206\uff0c\u589e\u52a0\u4e00\u4e2a\u91cd\u53e0\u90e8\u5206\u7684\u8fed\u4ee3\u5668\u8fdb\u884c\u540e\u7eed\u5220\u9664\u64cd\u4f5c</p> </li> <li> <p>\u5148\u627e\u63d2\u5165\u4e0e\u5b57\u7b26\u4e32\u672b\u5c3e\u91cd\u53e0\u7684\u8fed\u4ee3\u5668\uff0c\u9632\u6b62\u5931\u6548</p> </li> <li> <p>\u518d\u627e\u4e0e<code>first_index</code>\u91cd\u53e0\u7684\u8fed\u4ee3\u5668</p> </li> <li> <p>\u79fb\u9664[<code>lower</code>, <code>upper</code>)\u7684\u8fed\u4ee3\u5668\uff0c\u63d2\u5165\u65b0\u7684\u5b57\u7b26\u4e32</p> </li> </ul> C++<pre><code>\n</code></pre> <p>auto Reassembler::split( uint64_t pos ) noexcept { auto it { buffer_.lower_bound( pos ) }; if ( it != buffer_.end() and it-&gt;first == pos ) { return it; } if ( it == buffer_.begin() ) { // if buffer_.empty() then begin() == end() return it; } if ( const auto pit { prev( it ) }; pit-&gt;first + size( pit-&gt;second ) &gt; pos ) { // \u6784\u5efa\u91cd\u53e0\u90e8\u5206\u8fed\u4ee3\u5668 const auto res = buffer_.emplace_hint( it, pos, pit-&gt;second.substr( pos - pit-&gt;first ) ); pit-&gt;second.resize( pos - pit-&gt;first ); return res; } return it; }; // \u5bf9[lower, upper)\u7684\u8fed\u4ee3\u5668\u8fdb\u884c\u89c6\u56fe\u8f6c\u6362\uff0c\u7136\u540e\u66f4\u65b0reassemble\u7684\u5927\u5c0f ranges::for_each( ranges::subrange( lower, upper ) | views::values, [&amp;]( const auto&amp; str ) { reassemble_len_ -= str.size(); } ); reassemble_len_ += size(data); buffer_.emplace_hint(buffer_.erase(lower, upper), first_index, move(data));</p> C++<pre><code>void Reassembler::insert( uint64_t first_index, string data, bool is_last_substring )\n{\n  // Your code here.\n  const auto try_close = [&amp;]() noexcept -&gt; void {\n    if ( end_idx_.has_value() &amp;&amp; end_idx_.value() == next_unassem_idx_ ) {\n      output_.writer().close();\n    }\n  };\n\n  if ( data.empty() ) {\n    if ( !end_idx_.has_value() &amp;&amp; is_last_substring ) {\n      end_idx_.emplace( first_index );\n    }\n    return try_close();\n  }\n\n  if ( writer().is_closed() || writer().available_capacity() == 0 ) {\n    return;\n  }\n\n  uint64_t unassembled_index { next_unassem_idx_ };\n  uint64_t unacceptable_index { unassembled_index + writer().available_capacity() };\n  // \u5c06\u4e0d\u518d[unassembled_index, unacceptable_index)\u7684\u5b57\u7b26\u4e32\u8fdb\u884c\u5904\u7406\n  if ( first_index + size( data ) &lt;= unassembled_index || first_index &gt;= unacceptable_index ) {\n    return; // Out of ranger\n  }\n  if ( first_index + size( data ) &gt; unacceptable_index ) { // Remove unacceptable bytes\n    data.resize( unacceptable_index - first_index );\n    is_last_substring = false;\n  }\n  if ( first_index &lt; unassembled_index ) { // Remove poped/buffered bytes\n    data.erase( 0, unassembled_index - first_index );\n    first_index = unassembled_index;\n  }\n\n  if ( !end_idx_.has_value() and is_last_substring ) {\n    end_idx_.emplace( first_index + size( data ) );\n  }\n\n  // \u5bf9\u5b57\u7b26\u4e32\u8fdb\u884c\u5206\u5272\n  // TODO: \u53ef\u4ee5\u5bf9\u5b57\u7b26\u4e32\u79fb\u9664\u8fdb\u884c\u4f18\u5316\n  auto upper { split( first_index + size( data ) ) };\n  auto lower { split( first_index ) };\n  // \u5bf9[lower, upper)\u7684\u8fed\u4ee3\u5668\u8fdb\u884c\u89c6\u56fe\u8f6c\u6362\uff0c\u7136\u540e\u66f4\u65b0reassemble\u7684\u5927\u5c0f\n  ranges::for_each( ranges::subrange( lower, upper ) | views::values,\n                    [&amp;]( const auto&amp; str ) { reassemble_len_ -= str.size(); } );\n  reassemble_len_ += size( data );\n  buffer_.emplace_hint( buffer_.erase( lower, upper ), first_index, move( data ) );\n\n  // \u5411writer\u4e2d\u5199\u5165\u5df2\u7ecf\u6392\u597d\u5e8f\u7684\u62a5\u6587\n  while ( !buffer_.empty() ) {\n    auto&amp;&amp; [index, packet] { *buffer_.begin() };\n    if ( index != next_unassem_idx_ ) {\n      break;\n    }\n\n    reassemble_len_ -= size( packet );\n    next_unassem_idx_ += size( packet );\n    output_.writer().push( move( packet ) );\n    buffer_.erase( buffer_.begin() );\n  }\n  return try_close();\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#tcpreceiver","title":"TCPReceiver","text":"<ul> <li>64bit\u8f6c32bit ------- 32bit\u8f6c64bit\uff1a\u8981\u6c42\u6700\u8fd1\u4e14\u4e0d\u6ea2\u51fa</li> </ul> C++<pre><code>Wrap32 Wrap32::wrap( uint64_t n, Wrap32 zero_point )\n{\n  // Your code here.\n  return zero_point + static_cast&lt;uint32_t&gt;( n );\n}\n\nuint64_t Wrap32::unwrap( Wrap32 zero_point, uint64_t checkpoint ) const\n{\n  // Your code here.\n  const uint64_t n_low32 { this-&gt;raw_value_ - zero_point.raw_value_ };\n  const uint64_t c_low32 { checkpoint &amp; MASK_LOW_32 };\n  const uint64_t res { ( checkpoint &amp; MASK_HIGH_32 ) | n_low32 };\n  if ( res &gt;= BASE and n_low32 &gt; c_low32 and ( n_low32 - c_low32 ) &gt; ( BASE / 2 ) ) {\n    return res - BASE;\n  }\n  if ( res &lt; MASK_HIGH_32 and c_low32 &gt; n_low32 and ( c_low32 - n_low32 ) &gt; ( BASE / 2 ) ) {\n    return res + BASE;\n  }\n  return res;\n}\n</code></pre> <ul> <li><code>receive</code>\u65b9\u6cd5\u5c06\u5e8f\u5217\u53f7\u8f6c\u6362\u4e3a<code>payload</code>\u7d22\u5f15\uff1b<code>send</code>\u65b9\u6cd5\u8fd4\u56de\u786e\u8ba4\u7684ACK</li> </ul> C++<pre><code>void TCPReceiver::receive( TCPSenderMessage message )\n{\n  // Your code here.\n  if ( writer().has_error() )\n    return;\n  if ( message.RST ) {\n    reader().set_error();\n    return;\n  }\n  if ( !zero_point_.has_value() ) {\n    if ( !message.SYN ) {\n      return;\n    }\n    zero_point_.emplace( message.seqno );\n  }\n  const uint64_t checkpoint { writer().bytes_pushed() + 1 /* SYN */ }; // abs_seqno for expecting payload\n  const uint64_t absolute_seqno { message.seqno.unwrap( zero_point_.value(), checkpoint ) };\n  const uint64_t stream_index { absolute_seqno + static_cast&lt;uint64_t&gt;( message.SYN ) - 1 /* SYN */ };\n  reassembler_.insert( stream_index, move( message.payload ), message.FIN );\n}\n\nTCPReceiverMessage TCPReceiver::send() const\n{\n  // Your code here.\n  const uint16_t window_size { writer().available_capacity() &gt; UINT16_MAX\n                                 ? static_cast&lt;uint16_t&gt;( UINT16_MAX )\n                                 : static_cast&lt;uint16_t&gt;( writer().available_capacity() ) };\n  if ( zero_point_.has_value() ) {\n    const uint64_t ack_for_seqno { writer().bytes_pushed() + 1 + static_cast&lt;uint64_t&gt;( writer().is_closed() ) };\n    return { Wrap32::wrap( ack_for_seqno, zero_point_.value() ), window_size, writer().has_error() };\n  }\n  return { nullopt, window_size, writer().has_error() };\n}\n</code></pre>"},{"location":"blogs/posts/CS144/#tcpsender","title":"TCPSender","text":""},{"location":"blogs/posts/CS144/#timer","title":"Timer\u5b9e\u73b0","text":"<ul> <li>\u63a7\u5236\u542f\u52a8\u3001\u5173\u95ed\u3001\u91cd\u88c5 <code>RTO</code>\u3001\u91cd\u7f6e\u5b9a\u65f6\u5668\uff1b</li> <li>\u4f7f\u7528<code>tick</code>\u63a5\u53e3\u5b8c\u6210\u8ba1\u65f6\uff1b</li> <li>\u6309\u9700\u4f7f\u5f97 <code>RTO</code>\u7ffb\u500d\u3002</li> </ul> C++<pre><code>class Timer\n{\npublic:\n  explicit Timer( uint64_t initial_RTO_ms ) : RTO_ms_( initial_RTO_ms ) {}\n  [[nodiscard]] constexpr bool is_active() noexcept { return is_active_; }\n  [[nodiscard]] constexpr bool is_expired() noexcept { return is_active_ &amp;&amp; running_time_ &gt;= RTO_ms_; }\n  constexpr void reset() noexcept { running_time_ = 0; }\n  constexpr void exponential_back() noexcept { RTO_ms_ *= 2; }\n  constexpr void reload( uint64_t initail_RTO_ms ) noexcept\n  {\n    RTO_ms_ = initail_RTO_ms;\n    reset();\n  }\n  constexpr void start() noexcept\n  {\n    is_active_ = true;\n    reset();\n  }\n  constexpr void stop() noexcept\n  {\n    is_active_ = false;\n    reset();\n  }\n  constexpr Timer&amp; tick( uint64_t ticks ) noexcept\n  {\n    running_time_ += is_active_ ? ticks : 0;\n    return *this;\n  }\n\nprivate:\n  uint64_t RTO_ms_;\n  bool is_active_ {};\n  uint64_t running_time_ {};\n};\n</code></pre>"},{"location":"blogs/posts/CS144/#_6","title":"\u65b9\u6cd5\u5b9e\u73b0","text":"<ul> <li><code>push</code>\u5c3d\u53ef\u80fd\u5728\u4e00\u4e2a\u7a97\u53e3\u5c06<code>reader</code>\u7f13\u5b58\u672a\u53d1\u9001\u7684\u6570\u636e\u53d1\u9001\uff1b<code>receive</code>\u786e\u8ba4\u5f53\u524d\u8ddf\u8e2a\u7684\u6d88\u606fack\u5747\u5c0f\u4e8e\u4f20\u6765\u7684ack\uff0c\u4e0d\u518d\u8ddf\u8e2a\u6d88\u606f\uff1b<code>tick</code>\u5b9e\u73b0\u6307\u6570\u56de\u9000\u8d85\u65f6\u548c\u91cd\u4f20</li> </ul> C++<pre><code>void TCPSender::push( const TransmitFunction&amp; transmit )\n{\n  // Your code here.\n  // \u5c3d\u53ef\u80fd\u591a\u7684\u5728\u4e00\u4e2a\u7a97\u53e3\u53d1\u9001\u6570\u636e\n  while ( ( window_size_ == 0 ? 1 : window_size_ ) &gt; total_outstanding_ ) {\n    if ( FIN_sent_ )\n      break;\n    auto message { make_empty_message() };\n    // \u6807\u8bb0\u521d\u59cb\u53d1\u9001\u7684SYN\u5305\n    if ( !SYN_sent_ ) {\n      message.SYN = true;\n      SYN_sent_ = true;\n    }\n    // window_size\u7a7a\u4f59\u5bb9\u91cf(\u5305\u542b\u8be5\u6761\u4fe1\u606f\u7684\u957f\u5ea6)\n    const uint64_t remaining { ( window_size_ == 0 ? 1 : window_size_ ) - total_outstanding_ };\n    // \u8fd8\u80fd\u589e\u52a0payload\u7684\u957f\u5ea6\n    const size_t payload_len { min( TCPConfig::MAX_PAYLOAD_SIZE, remaining - message.sequence_length() ) };\n    auto&amp;&amp; payload { message.payload };\n    while ( reader().bytes_buffered() != 0U &amp;&amp; payload.size() &lt; payload_len ) {\n      string_view view { reader().peek() };\n      // \u5982\u679c\u5f53\u524dview\u957f\u5ea6\u5c0f\u4e8epayload_len\uff0c\u9700\u8981\u518d\u6b21\u8bfb\u53d6\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f7f\u7528\u5faa\u73af\n      view = view.substr( 0, payload_len - payload.size() );\n      payload += view;\n      input_.reader().pop( view.size() );\n    }\n    // \u4f55\u65f6\u589e\u52a0FIN\u6807\u8bb0\n    if ( !FIN_sent_ &amp;&amp; remaining &gt; message.sequence_length() &amp;&amp; reader().is_finished() ) {\n      message.FIN = true;\n      FIN_sent_ = true;\n    }\n\n    if ( message.sequence_length() == 0 )\n      break;\n\n    // \u4f20\u8f93message\n    transmit( message );\n    if ( !timer_.is_active() ) {\n      timer_.start();\n    }\n    next_seqno_ += message.sequence_length();\n    total_outstanding_ += message.sequence_length();\n    track_messages_.push( message );\n  }\n}\n\nvoid TCPSender::receive( const TCPReceiverMessage&amp; msg )\n{\n  // Your code here.\n  // \u9519\u8bef\u5904\u7406\n  if ( input_.has_error() )\n    return;\n  if ( msg.RST ) {\n    input_.set_error();\n    return;\n  }\n\n  window_size_ = msg.window_size;\n  if ( !msg.ackno.has_value() )\n    return;\n  const uint64_t recv_ack_seqno { msg.ackno-&gt;unwrap( isn_, next_seqno_ ) }; // \u63a5\u6536\u5230\u7684ack\u5e8f\u5217\u53f7\n  if ( recv_ack_seqno &gt; next_seqno_ )\n    return; // \u8d85\u8fc7\u671f\u5f85\u5e8f\u5217\u53f7\u7684\u5305\u76f4\u63a5\u4e22\u5f03\n  bool acked { false };\n  // \u4ece\u961f\u5217\u4e2d\u5220\u9664\u5df2\u7ecf\u786e\u8ba4\u7684\u5305\n  while ( !track_messages_.empty() ) {\n    const auto&amp; message { track_messages_.front() };\n    if ( ack_seqno_ + message.sequence_length() &gt; recv_ack_seqno )\n      break; // \u6ca1\u6709\u5b8c\u5168\u88ab\u786e\u8ba4\u7684\u5305\u4e22\u5f03\n    acked = true;\n    ack_seqno_ += message.sequence_length();\n    total_outstanding_ -= message.sequence_length();\n    track_messages_.pop();\n  }\n  // \u6536\u5230ack\u5305\u540e\uff0c\u91cd\u7f6eRTO\n  if ( acked ) {\n    total_retransmit_ = 0;\n    timer_.reload( initial_RTO_ms_ );\n    track_messages_.empty() ? timer_.stop() : timer_.start();\n  }\n}\n\nvoid TCPSender::tick( uint64_t ms_since_last_tick, const TransmitFunction&amp; transmit )\n{\n  // Your code here.\n  // \u53d1\u9001\u7684\u5305\u8d85\u65f6\n  if ( timer_.tick( ms_since_last_tick ).is_expired() ) {\n    if ( track_messages_.empty() )\n      return;\n    transmit( track_messages_.front() );\n    if ( window_size_ != 0 ) {\n      total_retransmit_ += 1;\n      timer_.exponential_back();\n    }\n    timer_.reset();\n  }\n}\n</code></pre>"},{"location":"blogs/posts/DP%20Attention/","title":"Data Parallelism in Attention in SGLang","text":"2025-10-272025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#data-parallelism-in-attention-in-sglang","title":"Data Parallelism in Attention in SGLang","text":"<p> \u7ea6 1471 \u4e2a\u5b57  47 \u884c\u4ee3\u7801  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 8 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#what-is-data-parallelism-in-attention","title":"What is Data Parallelism in Attention?","text":"<p>\u26a0 \u8fd9\u91cc\u7684 <code>dp_size</code> \u4e0d\u662f\u4f20\u7edf\u7684\u6570\u636e\u5e76\u884c\u800c\u662f <code>attentnion dp</code> \u5176\u76ee\u7684\u662f\u5c06\u4e00\u4e2a\u5927\u7684\u5f20\u91cf\u5e76\u884c\uff08TP\uff09\u7ec4\u91cd\u7ec4\u4e3a\u51e0\u4e2a\u8f83\u5c0f\u7684 TP \u7ec4 \uff0c\u8fd9\u4e9b\u8f83\u5c0f\u7684 TP \u7ec4\u53c8\u5f62\u6210\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e\u6ce8\u610f\u529b\u5c42\u7684\u65b0\u7684\u6570\u636e\u5e76\u884c\uff08DP\uff09\u7ec4\u3002</p> <ol> <li>\u5bf9\u4e8e\u6a21\u578b\u4e2d\u9664 MLP \u5c42\u4ee5\u5916\u7684\u90e8\u5206\uff08\u5982 Embedding, Self-Attention\uff09\uff0c\u6bcf\u4e2a\u6570\u636e\u5e76\u884c\u5355\u5143\uff08DP_Rank\uff09\u5185\u90e8\u7684\u5f20\u91cf\u5e76\u884c\u89c4\u6a21\uff08TP_Size\uff09\u8bbe\u7f6e\u4e3a 1\uff0c\u5373\u6bcf\u4e2a DP_Rank \u72ec\u7acb\u8ba1\u7b97\u8fd9\u4e9b\u90e8\u5206\u3002</li> <li>\u5bf9\u4e8e MLP \u5c42\uff0c\u6240\u6709 DP_Rank \u5219\u5171\u540c\u7ec4\u6210\u4e00\u4e2a\u5927\u7684\u5f20\u91cf\u5e76\u884c\u7ec4\uff08TP_Group\uff09\uff0c\u8be5\u7ec4\u7684\u5927\u5c0f\u7b49\u4e8e\u6570\u636e\u5e76\u884c\u7684\u89c4\u6a21\uff08DP_Size\uff09\u3002</li> </ol> <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#_1","title":"\u542f\u52a8\u6d41\u7a0b","text":"<ol> <li> <p>engine \u4f1a\u542f\u52a8\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u6267\u884c <code>run_data_parallel_control_process</code></p> </li> <li> <p>\u8be5\u51fd\u6570\u542f\u52a8 DataParallelController \u5e76\u6267\u884c <code>launch_dp_attention_schedulers</code></p> </li> </ol> <ul> <li>\u4e3a\u6bcf\u4e2a dp rank \u83b7\u53d6\u5355\u72ec\u7684 zmq \u901a\u4fe1\u63a5\u53e3</li> <li>\u8c03\u7528 <code>launch_tensor_parallel_group</code></li> </ul> <ol> <li><code>launch_tensor_parallel_group</code> \u5bf9\u6bcf\u4e2a (pp_rank, tp_rank) \u542f\u52a8\u4e00\u4e2a Schedular \u5b50\u8fdb\u7a0b - \u7236\u8fdb\u7a0b\u5728\u8fd9\u91cc\u963b\u585e\u7b49\u5f85\u6bcf\u4e2a\u5b50\u8fdb\u7a0b\u901a\u8fc7 pipe \u53d1\u9001\u521d\u59cb\u5316\u4fe1\u606f\uff08\u901a\u5e38\u5305\u542b\uff1a\u6a21\u578b\u5df2\u52a0\u8f7d\u5b8c\u6210\u3001\u6a21\u578b\u7684 buffer/kv \u914d\u7f6e\u3001\u6700\u5927 token \u957f\u5ea6\u7b49</li> </ol> Python<pre><code>scheduler = Scheduler(\n     server_args,\n     port_args,\n     gpu_id,\n     tp_rank,\n     moe_ep_rank,\n     pp_rank,\n     dp_rank,\n )\npipe_writer.send(\n         {\n             \"status\": \"ready\",\n             \"max_total_num_tokens\": scheduler.max_total_num_tokens,\n             \"max_req_input_len\": scheduler.max_req_input_len,\n         }\n     )\n\n# PP + TP\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Pipeline Stage 0 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\nTP=0\u2192 \u2502 TP Rank 0 \u2502 TP Rank 1 \u2502 TP Rank 2        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Pipeline Stage 1 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\nTP=1\u2192 \u2502 TP Rank 3 \u2502 TP Rank 4 \u2502 TP Rank 5        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Pipeline Stage 2 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\nTP=2\u2192 \u2502 TP Rank 6 \u2502 TP Rank 7 \u2502 TP Rank 8        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ol> <li>ModelRunner \u521d\u59cb\u5316\u65f6\u6267\u884c <code>initialize_dp_attention</code>\uff0c</li> </ol> <ul> <li>\u8ba1\u7b97 <code>attn_tp</code> \u7684\u5927\u5c0f\u4ee5\u53ca\u5bf9\u5e94\u7684 <code>attn_tp_rank</code> \u4ee5\u53ca <code>attn_dp_rank</code></li> <li>\u5e76\u636e\u6b64\u521b\u5efa attention-specific group coordinator\uff08attn_tp_group\uff09</li> <li>\u8bbe\u7f6e Gather \u65f6\u5019\u7684 Buffer      &gt; \u4e3a Gather buffer \u9884\u7559 <code>attn_tp_size</code> \u500d\u7684\u7a7a\u95f4</li> </ul> <p>\u4ee5\u4e0a\u9762\u7684\u56fe\u4e3a\u4f8b</p> tp_rank attn_tp_size attn_dp_rank attn_tp_rank 0 1 0 0 1 1 1 0 2 1 2 0 3 1 3 0","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#_2","title":"\u6267\u884c\u6d41\u7a0b","text":"<p>\u4e0e\u6b63\u5e38\u6267\u884c\u7c7b\u4f3c\uff0c\u90fd\u5148\u6267\u884c <code>recv_requests</code> \u548c <code>process_input_requests</code></p> <ol> <li> <p>\u5728 <code>get_next_batch_to_run</code> \u4e2d\u6267\u884c <code>prepare_mlp_sync_batch</code></p> </li> <li> <p><code>prepare_mlp_sync_batch</code> \u5728 (dp_size, attn_tp_size\uff09\u7ef4\u5ea6\u4e0a\u6536\u96c6\u6bcf\u4e2a worker \u7684 batch/forward-mode \u4fe1\u606f\uff08\u5305\u62ec token \u6570\u3001\u662f\u5426\u80fd\u8dd1 CUDA graph\u3001logprob \u76f8\u5173\u957f\u5ea6\u3001\u662f\u5426\u4e3a extend\u3001\u4ee5\u53ca TBO \u76f8\u5173\u7684 all-gather \u5143\u6570\u636e\uff09\uff0c\u7136\u540e\u5408\u5e76\u56de\u6bcf\u4e2a\u672c\u5730 <code>local_batch</code></p> </li> </ol> <ul> <li> <p>\u82e5\u672c\u5730\u6ca1\u4efb\u52a1\uff0c\u4f46\u4efb\u4e00\u5176\u5b83 DP \u526f\u672c\u6709\u4efb\u52a1\uff08\u8868\u793a\u5168\u5c40\u4e0d\u662f\u5b8c\u5168\u7a7a\u95f2\uff09\uff0c\u5219\u901a\u8fc7 <code>get_idle_batch()</code> \u83b7\u53d6\u4e00\u4e2a\u5360\u4f4d <code>ScheduleBatch</code>\uff0c\u4fbf\u4e8e\u8be5 worker \u53c2\u4e0e\u540e\u7eed\u540c\u6b65/\u5e76\u884c\uff08\u4f8b\u5982\u540c\u6b65 MLP gather \u6216 KV cache \u64cd\u4f5c\uff09\uff0c\u907f\u514d\u56e0\u4e3a\u67d0\u4e9b worker \u7f3a\u5931\u5bfc\u81f4\u6536\u96c6/\u901a\u4fe1\u5f02\u5e38\u3002</p> </li> <li> <p>\u6700\u540e\u8fd4\u56de <code>local_batch</code> \u4f5c\u4e3a\u6b64\u6b21\u7684 new_batch</p> Python<pre><code>\u00a0 \u00a0 def get_idle_batch(self):\n\u00a0 \u00a0 \u00a0 \u00a0 idle_batch = ScheduleBatch.init_new(\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 [],\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.req_to_token_pool,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.token_to_kv_pool_allocator,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.tree_cache,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.model_config,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.enable_overlap,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.spec_algorithm,\n\u00a0 \u00a0 \u00a0 \u00a0 )\n\u00a0 \u00a0 \u00a0 \u00a0 idle_batch.prepare_for_idle()\n\u00a0 \u00a0 \u00a0 \u00a0 return idle_batch\n</code></pre> </li> </ul> <ol> <li> <p>\u53d8\u4e3a <code>ModelWorkerBatch</code> \u540e\u8c03\u7528 <code>TpModelWorker::forward_batch_generation</code>\u8f6c\u5316\u4e3a <code>ForwardBatch</code>\uff0c\u8c03\u7528 <code>ModelRunner::forward</code> -&gt; <code>ModelRunner::_forward_raw</code> \u5728\u8fd9\u91cc\u8fdb\u884c padding</p> </li> <li> <p>\u5b9e\u9645\u4e0a\u662f\u8c03\u7528 <code>FowardBatch::prepare_mlp_sync_batch</code></p> </li> </ol> <ul> <li>\u628a\u5404\u4e2a dp rank \u7684 num_token \u4fe1\u606f\u5bf9\u9f50 Attention-tp-size<ul> <li>\u786e\u4fdd\u6bcf\u4e2a DP rank \u7684 token \u6570\u91cf\u662f <code>attn_tp_size</code>\u00a0 \u7684\u500d\u6570</li> <li>\u4e3a\u540e\u7eed\u53ef\u80fd\u7684 \u00a0reduce-scatter\u00a0 \u64cd\u4f5c\u505a\u51c6\u5907(reduce-scatter \u8981\u6c42\u53ef\u88ab\u6574\u9664\u7684\u5206\u5272)</li> </ul> </li> <li>\u6bcf\u4e2a dp rank \u672c\u5730\u7684 batch \u4f1a\u6839\u636e\u586b\u5145\u6a21\u5f0f\u88ab padding \u5230\u6307\u5b9a\u7684\u5927\u5c0f(bs = self.batchsize = num_tokens).<ul> <li>\u5f53 <code>dp_padding_mode</code> \u8bbe\u7f6e\u4e3a max \u65f6\uff0cpadding \u5230\u7684 batchsize \u5927\u5c0f\u4e3a\u6240\u6709 dp rank \u4e0a\u6700\u5927\u7684 local batch\uff0c\u540c\u65f6\u5bf9\u9f50\u5230 attention_tp_size;</li> <li>\u5f53 <code>dp_padding_mode</code> \u8bbe\u7f6e\u4e3a sum \u65f6\uff0cpadding \u5230\u7684 batchsize \u5927\u5c0f\u4e3a\u6240\u6709 dp rank \u4e0a local batch \u4e4b\u548c\uff0c\u5373 global batch size</li> <li>is_extend_in_batch \u8bbe\u7f6e SUM\uff0ccuda_graph \u8bbe\u7f6e MAX</li> </ul> </li> </ul> <ol> <li>\u5728\u5b8c\u6210 dp attention batch padding \u540e\uff0c\u6839\u636e batch \u7c7b\u578b\u8c03\u7528<code>self.forward_decode</code> \u8fdb\u884c\u6a21\u578b\u63a8\u7406\u3002\u5728\u5b8c\u6210\u63a8\u7406\u540e\uff0c\u8c03\u7528<code>forward_batch.post_forward_mlp_sync_batch(ret)</code></li> </ol> <ul> <li>\u590d\u539f\u88ab\u4e34\u65f6\u4fee\u6539\u7684\u5c5e\u6027</li> <li>\u5c06 padding \u540e\u7684 ForwardBatch \u8fd8\u539f\uff0c\u5177\u4f53\u505a\u6cd5\u662f\u5728 prepare \u65f6\u4f1a\u8bb0\u5f55\u539f batchsize\uff0c\u6b64\u65f6\u5bf9\u7ed3\u679c\u8fdb\u884c\u5207\u7247</li> </ul> Python<pre><code># prepare\nsetattr(self, \"_original_forward_mode\", self.forward_mode)\nsetattr(self, \"_original_batch_size\", self.batch_size)\n\n# post\nself.forward_mode = getattr(self, \"_original_forward_mode\", self.forward_mode)\nself.batch_size = getattr(self, \"_original_batch_size\", self.batch_size)\n\nlogits_output.next_token_logits = logits_output.next_token_logits[:bs]\nlogits_output.hidden_states = logits_output.hidden_states[:bs]\n</code></pre> <ol> <li>\u6700\u540e\u7684\u5904\u7406\u6d41\u7a0b\u4e0e\u5e38\u89c4\u65e0\u5dee\u522b\uff0c\u8c03\u7528 <code>process_batch_result</code> \u7ed3\u675f\u6b64\u8f6e\u8c03\u5ea6</li> </ol>","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#why-dp-attention","title":"Why DP Attention?","text":"<p>\u5b83\u7528\u4e00\u6b21\u76f8\u5bf9\u5ec9\u4ef7\u7684\u5185\u5b58\u901a\u4fe1\uff08<code>All-Gather KV Cache</code>\uff09\u6362\u53d6\u4e86Attention \u7684\u5e76\u884c\u52a0\u901f\uff0c\u540c\u65f6\u8fd8\u4fdd\u6301\u4e86 MLP \u5c42\uff08\\(O(N)\\)\uff09\u7684\u96f6\u901a\u4fe1\u6570\u636e\u5e76\u884c\u6548\u7387\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#why-padding","title":"Why Padding?","text":"<p>\u5728 Attention \u5c42\u4e0e MoE \u5c42\u4e4b\u95f4\u9700\u8981\u8fdb\u884c\u540c\u6b65\u901a\u4fe1\uff0c\u5bf9\u5404 dp rank atttention \u90e8\u5206\u8ba1\u7b97\u5f97\u5230\u7684 hidden_state \u96c6\u5408\u8fdb\u884c\u540c\u6b65\uff0c\u5982\u679c\u91c7\u7528 Allgather \u6216\u8005 Allreduce \u901a\u4fe1\uff0c\u5176\u5bf9\u6570\u636e\u6027\u72b6\u6709\u4e00\u5b9a\u7684\u8981\u6c42</p> <ul> <li>allgather\uff1a\u8981\u6c42\u6bcf\u4e2a sub-batchsize \u5927\u5c0f\u76f8\u540c\u3002\u56e0\u6b64\u9700\u8981\u628a local batchsize padding \u5230 max batchsize\uff0c\u4e14\u6700\u540e gatheredbuffer \u5927\u5c0f\u4e3a\uff1amax_batchsize * sync_group_size </li> <li>allreduce\uff1a\u6bcf\u4e2a dp rank \u4e0a\u90fd\u6709\u5b8c\u6574\u7684\u6570\u636e\u96c6\u5408(\u5bf9\u5e94 padding \u5230 sum batchsize). \u6700\u540e gatheredbuffer \u5927\u5c0f\u4e3a\uff1asum_batchsize </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#padding-problems","title":"Padding Problems","text":"<p>\u8fd9\u79cd\u4e3a\u4e86\u201c\u6b63\u786e\u6027\u201d\u800c\u505a\u7684 padding\uff0c\u53cd\u8fc7\u6765\u53c8\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff0c\u4e3b\u8981\u4f53\u73b0\u5728\u4ee5\u4e0b\u4e24\u65b9\u9762\uff1a</p>","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#a-load-imbalance-stragglers","title":"A. \u8d1f\u8f7d\u4e0d\u5747\u4e0e\u201c\u6389\u961f\u8005\u201d (Load Imbalance &amp; Stragglers)","text":"<p><code>GPU_0</code> \u6709 4 \u4e2a\u771f\u5b9e\u7684\u8bf7\u6c42\u9700\u8981\u8ba1\u7b97\uff0c\u800c <code>GPU_1, 2, 3</code> \u53ea\u6709 3 \u4e2a\u771f\u5b9e\u7684\u8bf7\u6c42\uff08\u548c 1 \u4e2a\u51e0\u4e4e\u4e0d\u8017\u65f6\u7684\u865a\u62df\u8bf7\u6c42\uff09\u3002</p> <ul> <li>\u7ed3\u679c\uff1a<code>GPU_1, 2, 3</code> \u4f1a\u5f88\u5feb\u5b8c\u6210\u5b83\u4eec\u7684\u672c\u5730\u8ba1\u7b97\u3002</li> <li>\u7b49\u5f85\uff1a\u7136\u540e\uff0c\u5b83\u4eec\u5728 <code>All-Gather</code> \u8fd9\u4e2a\u540c\u6b65\u70b9\uff08Barrier\uff09\u4e0a\u88ab\u8feb\u7a7a\u8f6c\uff08Idle\uff09\uff0c\u7b49\u5f85 <code>GPU_0</code> \u5b8c\u6210\u5b83\u90a3\u4efd\u66f4\u91cd\u7684\u5de5\u4f5c\u3002</li> <li><code>GPU_0</code> \u6210\u4e3a\u4e86\u8fd9\u4e2a\u6279\u6b21\u7684**\u201c\u6389\u961f\u8005\u201d (Straggler)**\uff0c\u5b83\u62d6\u6162\u4e86\u6240\u6709\u5176\u4ed6 GPU \u7684\u8fdb\u5ea6\u3002</li> </ul> <p>\u7ed3\u8bba\uff1a \u8fd9\u5bfc\u81f4\u4e86\u6781\u4f4e\u7684 GPU \u5229\u7528\u7387\u3002\u5728 <code>dp_size=4</code> \u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u6709 \u00be \u7684 GPU \u5728\u5927\u90e8\u5206\u65f6\u95f4\u91cc\u5904\u4e8e\u7a7a\u95f2\u7b49\u5f85\u72b6\u6001\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/DP%20Attention/#b-overhead","title":"B. \u8ba1\u7b97\u548c\u5185\u5b58\u7684\u989d\u5916\u5f00\u9500 (Overhead)","text":"<ol> <li>\u8ba1\u7b97\u5f00\u9500\uff1a</li> </ol> <ul> <li>\u5c3d\u7ba1\u662f\u201c\u865a\u62df\u201d\u8bf7\u6c42\uff0c\u4f46\u7cfb\u7edf\u4ecd\u7136\u9700\u8981\u542f\u52a8 CUDA Kernel \u6765\u5904\u7406\u5b83\u4eec\uff0c\u8fd9\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u8c03\u5ea6\u5f00\u9500\u3002</li> <li>\u66f4\u91cd\u8981\u7684\u662f\uff0c<code>All-Gather</code> \u64cd\u4f5c\u672c\u8eab\u3002\u6240\u6709 GPU \u73b0\u5728\u90fd\u5fc5\u987b\u4ea4\u6362\u4e00\u4e2a\u201c\u5927\u5c0f\u4e3a 4\u201d\u7684\u6279\u6b21\u6570\u636e\uff0c\u800c\u4e0d\u662f\u5b83\u4eec\u201c\u5b9e\u9645\u201d\u7684 <code>[4, 3, 3, 3]</code>\u3002\u901a\u4fe1\u91cf\u88ab\u653e\u5927\u4e86\u3002</li> </ul> <ol> <li>\u5185\u5b58\u5f00\u9500\uff1a</li> </ol> <ul> <li><code>All-Gather</code> \u4e4b\u540e\uff0c\u6bcf\u4e2a GPU \u90fd\u9700\u8981\u5206\u914d\u8db3\u591f\u5927\u7684\u5185\u5b58\u7f13\u51b2\u533a\u6765\u63a5\u6536\u6765\u81ea\u6240\u6709\u5176\u4ed6 rank \u7684\u6570\u636e\u3002</li> <li><code>GPU_1</code> \u660e\u660e\u53ea\u9700\u8981 <code>4+3+3+3 = 13</code> \u4e2a\u8bf7\u6c42\u7684\u6570\u636e\uff0c\u4f46\u5b83\u5fc5\u987b\u6309\u7167 <code>4+4+4+4 = 16</code> \u4e2a\u8bf7\u6c42\uff08\u5373<code>max_batch_per_rank * dp_size</code>\uff09\u7684\u6700\u5927\u53ef\u80fd\u6027\u6765\u5206\u914d\u5185\u5b58\u3002</li> <li>\u8fd9\u5bfc\u81f4\u4e86\u663e\u5b58\uff08VRAM\uff09\u7684\u6d6a\u8d39\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/","title":"FlashAttention","text":"2025-12-132025-12-13 <p>title: FlashAttention \u539f\u7406 v1-v2 tags:</p> <ul> <li>LLMInference   date: 2025/11/03</li> </ul>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#flashattention-v1-v2","title":"FlashAttention \u539f\u7406 v1-v2","text":"<p> \u7ea6 2570 \u4e2a\u5b57  16 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 13 \u5206\u949f</p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#motivation","title":"Motivation","text":"<p>attention \u7684\u8ba1\u7b97\u5bf9\u8ba1\u7b97\u548c\u5185\u5b58\u8981\u6c42\u90fd\u5f88\u9ad8\uff08b \u662f batch size\uff0cs \u662f seq len\uff0ch \u662f hidden size\uff09</p> <ul> <li>Compute\uff1a\\(4bs^2h\\)</li> <li>Memory\uff1a\\(bs^2h\\)</li> <li>\u6709\u6539\u8fdb\u7684\u65b9\u6cd5\u964d\u4f4e\u8ba1\u7b97\u590d\u6742\u5ea6\uff0c\u6ca1\u592a\u5927\u7528\uff0c\u539f\u56e0\u7f13\u5b58\u5b58\u53d6\u5f88\u8017\u65f6</li> <li><code>FlashAttention</code>\u00a0 \u4f18\u5316\u4e86\u663e\u5b58\u5b58\u53d6\uff0c\u975e\u4f18\u5316\u8ba1\u7b97\u590d\u6742\u5ea6</li> </ul> <p>\u4f20\u7edf\u7684 Attention \u8ba1\u7b97\u9700\u8981\u5bf9 HBM \u8fdb\u884c\u5b58\u53d6 8 \u6b21\uff0c\u975e\u5e38\u8017\u65f6</p> <p></p> <p>\u6211\u4eec\u5e0c\u671b\u5c3d\u53ef\u80fd\u5c06 attention \u5206\u5757\uff0c\u90e8\u5206\u52a0\u8f7d\u5230 shared memory \u8fdb\u884c\u4e00\u6b21\u8ba1\u7b97\u540e\u76f4\u63a5\u5199\u56de\uff0c\u907f\u514d\u591a\u6b21\u7684\u8bfb\u53d6\u548c\u5199\u5165\u3002\u8fd9\u5c31\u5e26\u6765\u4e86\u6311\u6218\uff0c\u6211\u4eec\u5fc5\u987b\u907f\u514d\u663e\u5f0f\u5730\uff08\u5728\u5185\u5b58\u4e2d\uff09\u6784\u5efa\u51fa\u77e9\u9635 S\uff0c\u540c\u65f6\u8fd8\u8981\u505a\u5230\uff1a</p> <ul> <li>\u5728\u524d\u5411\u4f20\u64ad\u4e2d\uff0c\u5728\u65e0\u6cd5\u8bbf\u95ee\u5b8c\u6574\u7684 \\(N \\\\times N\\) \u77e9\u9635\u7684\u60c5\u51b5\u4e0b\uff0c\u8ba1\u7b97\u51fa softmax \u7684\u5f52\u4e00\u5316\u7ed3\u679c \\(O\\)\uff1b</li> <li>\u5728\u53cd\u5411\u4f20\u64ad\u4e2d\uff0c\u5373\u4f7f\u6ca1\u6709\u4fdd\u5b58\u524d\u5411\u4f20\u64ad\u65f6\u7684 \\(N \\\\times N\\) softmax \u6fc0\u6d3b\u503c\uff0c\u4e5f\u80fd\u591f\u6b63\u786e\u8ba1\u7b97\u68af\u5ea6\u3002</li> </ul> <p></p> <p>\u5728\u6b63\u5f0f\u8fdb\u5165 Flash Attention \u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u91cd\u65b0\u56de\u987e\u4e0b softmax \u7684\u8fc7\u7a0b\u4ee5\u53ca *online softmax \u5982\u4f55\u5b9e\u73b0\u7684\uff0cFA \u4e3b\u8981\u601d\u60f3\u5c31\u662f\u8fdb\u884c\u5206\u5757\u8ba1\u7b97\u6ce8\u610f\u529b\uff0cOnline-Softmax \u662f FA \u5b9e\u73b0\u7684\u5173\u952e</p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#online-softmax","title":"Online Softmax","text":""},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#basic-softmax","title":"basic softmax","text":"\\[ \\\\bar{x_i} = \\\\frac{e^{x_i}}{\\\\sum_j^N{e^{x_j}}} \\]"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#safe-softmax","title":"safe softmax","text":"<p>\u5c06\u53d8\u91cf\u7684\u6307\u6570\u7edf\u4e00\u51cf\u53bb\u6700\u5927\u503c\uff0c\u9632\u6b62\u6307\u6570\u6570\u503c\u4e0a\u6ea2</p> \\[ \\\\bar{x_i} = \\\\frac{e^{x_i - max(x\\_{:N})}}{\\\\sum_j^N{e^{x_j - max(x\\_{:N})}}} \\] <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#online-softmax_1","title":"online softmax","text":"<p>\u5b9e\u9645\u4e0a\u6211\u4eec\u7684 \\(d_i^{\\\\prime}\\) \u53ef\u4ee5\u7531 \\(d_i\\) \u9012\u63a8\u5f97\u5230\uff1a</p> \\[ \\\\begin{aligned} d_i' &amp;= \\\\sum\\_{j=1}^{i} e^{x_j - m_i} \\\\ &amp;= \\\\left( \\\\sum\\_{j=1}^{i-1} e^{x_j - m_i} \\\\right) + e^{x_i - m_i} \\\\ &amp;= \\\\left( \\\\sum\\_{j=1}^{i-1} e^{x_j - m\\_{i-1}} \\\\right) e^{m\\_{i-1} - m_i} + e^{x_i - m_i} \\\\ &amp;= d\\_{i-1}' e^{m\\_{i-1} - m_i} + e^{x_i - m_i} \\\\end{aligned} \\] <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#flash-attention","title":"Flash Attention","text":"<p>\u5f53\u952e\u5411\u91cf K \u88ab\u5212\u5206\u4e3a\u4e24\u4e2a\u5757\uff08blocks\uff09\uff0c\u5e76\u4e14\u503c\u5411\u91cf V \u4e5f\u88ab\u5212\u5206\u4e3a\u4e24\u4e2a\u5757\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u5206\u522b\u5bf9\u6bcf\u4e2a\u5757\u8ba1\u7b97\u6ce8\u610f\u529b\uff08attention\uff09\uff0c\u7136\u540e\u5728\u6700\u540e\u5bf9\u8f93\u51fa\u8fdb\u884c\u91cd\u65b0\u7f29\u653e\uff08rescaling\uff09\uff0c\u8fd9\u6837\u5c31\u80fd\u5f97\u5230\u4e0e\u5b8c\u6574\u8ba1\u7b97\u76f8\u540c\u7684\u6b63\u786e\u7ed3\u679c\u3002</p> <p>\u5728\u793a\u610f\u56fe\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5316\u8bf4\u660e\uff0c\u6211\u4eec\u7701\u7565\u4e86 softmax \u4e2d\u51cf\u53bb\u6bcf\u884c\u6700\u5927\u503c\uff08row-wise max\u7684\u6b65\u9aa4\u3002</p> <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#sram","title":"SRAM \u5206\u5757\u793a\u4f8b","text":"<p>\u4f20\u7edf<code>Attention</code>\u00a07 \u6b21\u8fdb\u884c HBM \u5230 SRAM \u7684\u4ea4\u6362\uff0c\u6211\u4eec\u5e0c\u671b\u5206\u5757\u7684\u8ba1\u7b97\u53ef\u4ee5\u5728 SRAM \u4e00\u6b21\u7b97\u5b8c</p> <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#self-attention-v2-with-online-safe-softmax","title":"Self attention v2: with Online Safe Softmax","text":"<p>\u6211\u4eec\u901a\u8fc7 online safe softmax \u53ef\u4ee5\u5f97\u5230 self attention \u7684\u8ba1\u7b97\u8fc7\u7a0b</p> <ul> <li>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\uff0c\u5176\u5b9e\u6211\u4eec\u53ea\u9700\u8981 \\(o_i\\)\uff0c\u800c\u4e0d\u662f \\(a_i\\)</li> <li>\u6240\u6709\u6211\u4eec\u63a5\u4e0b\u6765\u53ef\u4ee5\u627e \\(o_i\\) \u7684\u9012\u63a8\u516c\u5f0f\uff0c\u53ea\u7528\u4e00\u4e2a\u5faa\u73af\u5b9e\u73b0\u90e8\u5206\u7684\u66f4\u65b0(max\uff0cd\uff0co)</li> </ul> <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#flash-attention_1","title":"Flash Attention","text":"<p>\u5bfb\u627e \\(o_i\\) \u7684\u9012\u63a8\u516c\u5f0f\uff1a</p> \\[ \\\\mathbf{o}'_i = \\\\sum_{j=1}^{i} \\\\frac{e^{x_j - m_i}}{d'\\_i} V[j,:] \\] \\[ = \\\\left( \\\\sum\\_{j=1}^{i-1} \\\\frac{e^{x_j - m_i}}{d'\\_i} V[j,:] \\\\right) + \\\\frac{e^{x_i - m_i}}{d'\\_i} V[i,:] \\] \\[ = \\\\left( \\\\sum\\_{j=1}^{i-1} \\\\frac{e^{x_j - m\\_{i-1}}}{d'_{i-1}} \\\\frac{e^{x_j - m_i}}{e^{x_j - m_{i-1}}} \\\\frac{d'\\_{i-1}}{d'\\_i} V[j,:] \\\\right) + \\\\frac{e^{x_i - m_i}}{d'\\_i} V[i,:] \\] \\[ = \\\\left( \\\\sum\\_{j=1}^{i-1} \\\\frac{e^{x_j - m\\_{i-1}}}{d'_{i-1}} V[j,:] \\\\right) \\\\frac{d'_{i-1} e^{m\\_{i-1} - m_i}}{d'\\_i} + \\\\frac{e^{x_i - m_i}}{d'\\_i} V[i,:] \\] \\[ = \\\\mathbf{o}'_{i-1} \\\\frac{d'_{i-1} e^{m\\_{i-1} - m_i}}{d'\\_i} + \\\\frac{e^{x_i - m_i}}{d'\\_i} V[i,:] \\] <p>\u6b64\u65f6\u5c31\u5f97\u5230<code>Flash Attention</code>\u7684 <code>one-pass</code> \u8fed\u4ee3\u5f62\u5f0f</p> <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#tiling-flash-attention","title":"Tiling Flash Attention","text":"<ul> <li>\u5916\u5c42\u5faa\u73af\u904d\u5386 K \u548c V \u7684 \u201d\u5217\u5757\u201c\uff08\u4e00\u6b21 I/O \u8bfb\uff09</li> <li>\u5185\u5b58\u5faa\u73af\u904d\u5386 Q \u7684 \"\u884c\u5757\"\uff08\u4e00\u6b21 I/O \u8bfb\uff09</li> <li>\u8ba1\u7b97 \\(Q \\\\cdot K^T\\)\u4ea7\u751f\u4e86\u4e00\u4e2a \\(B_r \\\\times B_c\\) \u7684\u5c0f\u77e9\u9635 \\(S\\_{ij}\\)\u3002\u5b83\u4ece\u4e0d\u88ab\u5199\u5165 HBM</li> <li>\u9488\u5bf9\u521a\u521a\u5f97\u5230\u7684 \\(S\\_{ij}\\) \u5757\uff0c\u8ba1\u7b97\u8fd9\u4e2a\u5757\u7684\u201c\u5c40\u90e8\u201dSoftmax \u7edf\u8ba1\u91cf\uff1a<ul> <li>\\(\\\\tilde{m}_{ij}\\)\uff1a\\(S_{ij}\\) \u8fd9\u4e00\u5757\u7684\u884c\u6700\u5927\u503c (rowmax)\u3002</li> <li>\\(\\\\tilde{P}_{ij}\\)\uff1a\\(S_{ij}\\) \u51cf\u53bb\u5757\u6700\u5927\u503c\u540e\u7684 \\(\\\\exp\\) \u7ed3\u679c\uff0c\u5373 \\(e^{S\\_{ij} - \\\\tilde{m}\\_{ij}}\\)\u3002</li> <li>\\(\\\\tilde{\\\\ell}_{ij}\\)\uff1a\\(\\\\tilde{P}_{ij}\\) \u7684\u884c\u548c (rowsum)\uff0c\u5373 \\(\\\\sum e^{S\\_{ij} - \\\\tilde{m}\\_{ij}}\\)\u3002</li> </ul> </li> <li>\u66f4\u65b0 \\(m_i^{new}\\) \u548c \\(l_i^{new}\\)</li> <li>\u66f4\u65b0\u8f93\u51fa \\(O_i\\) \uff08\u4e00\u6b21 I/O \u5199\uff09\uff1a\\(O_i \\\\leftarrow \\\\text{diag}(\\\\ell_i^{new})^{-1} \\\\left( \\\\text{diag}(e^{m_i - m_i^{new}}) O_i + e^{\\\\tilde{m}_{ij} - m_i^{new}} \\\\tilde{P}_{ij} V_j \\\\right)\\)<ul> <li>\\(e^{m_i - m_i^{new}} O_i\\)\uff1a\u7528\u7f29\u653e\u56e0\u5b50\u4fee\u6b63\u201c\u5386\u53f2\u201d\u8f93\u51fa \\(O_i\\)\u3002</li> <li>\\(e^{\\\\tilde{m}_{ij} - m_i^{new}} \\\\tilde{P}_{ij} V_j\\)\uff1a\u8ba1\u7b97\u201c\u5f53\u524d\u5757\u201d\u7684\uff08\u672a\u5f52\u4e00\u5316\u7684\uff09\u8f93\u51fa\uff0c\u5e76\u7528\u7f29\u653e\u56e0\u5b50\u4fee\u6b63\u5b83\u3002</li> <li>\u4e24\u8005\u76f8\u52a0\uff0c\u5f97\u5230\uff08\u672a\u5f52\u4e00\u5316\u7684\uff09\u65b0\u8f93\u51fa\u3002</li> <li>\\(\\\\text{diag}(\\\\ell_i^{new})^{-1}\\)\uff1a\u6700\u540e\uff0c\u9664\u4ee5\u65b0\u7684\u201c\u5168\u5c40\u201d\u5206\u6bcd \\(\\\\ell_i^{new}\\)\uff0c\u5b8c\u6210\u5f52\u4e00\u5316\u3002</li> </ul> </li> <li>\u7b2c\u4e8c\u6b21 I/O \u5199\uff1a \u5c06\u66f4\u65b0\u540e\u7684\u201c\u5728\u7ebf\u201d\u7edf\u8ba1\u91cf \\(\\\\ell_i^{new}\\) \u548c \\(m_i^{new}\\) \u4e5f\u5199\u56de HBM\uff0c\u4ee5\u4fbf\u4e0b\u4e00\u4e2a\u5916\u5faa\u73af\uff08\\(j+1\\)\uff09\u53ef\u4ee5\u4f7f\u7528\u5b83\u4eec\u3002</li> </ul>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#summary","title":"Summary","text":"<ul> <li>\u6211\u4eec\u53ea\u4f1a\u8bfb\u53d6 \\((Q, K)\\) \u4e00\u6b21\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u662f\u5206\u5757\u8ba1\u7b97\uff0c\u5206\u5757\u5b58\u50a8\u8f93\u51fa\u77e9\u9635 \\(O\\)</li> <li>\u6211\u4eec\u4ece\u6765\u4e0d\u4f1a\u83b7\u53d6\u5b8c\u6574\u7684 \\(S\\)</li> <li>\u6211\u4eec\u4e5f\u4e0d\u4f1a\u83b7\u53d6\u5b8c\u6574\u7684 \\(a (softmax(S))\\)</li> </ul>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#flash-attention-v2","title":"Flash Attention V2","text":"<p><code>Flash Attention 2</code> \u6bd4 <code>Flash Attention 1</code> \u52a0\u901f <code>2x</code>, \u8ba1\u7b97\u6548\u7387\u8fbe\u5230GEMM\u6027\u80fd\u7684 <code>50~73%</code>\uff0cv2 \u76f8\u6bd4\u4e8e v1 \u7684\u4f18\u5316\u4e3b\u8981\u6709\u4e0b\u9762\u51e0\u70b9\uff1a</p> <ul> <li>Parallelsim\uff1a\u7f6e\u6362\u5185\u5916\u5faa\u73af\u4f4d\u7f6e\uff0c\u540c\u65f6\u51cf\u5c11\u975e\u77e9\u9635\u7684\u8ba1\u7b97\u91cf</li> <li>Work Partitioning Between Warps\uff1a \u4f18\u5316 thread blocks \u5185\u90e8 warp \u7ea7\u522b\u7684\u5de5\u4f5c\u6a21\u5f0f\uff0c\u5c3d\u91cf\u51cf\u5c11 warp \u95f4\u7684\u901a\u8baf\u548c\u8bfb\u53d6 shared memory \u7684\u6b21\u6570</li> <li>Optimize non-matmul\uff1a\u4f18\u5316 Attention \u90e8\u5206thread blocks\u7684\u5e76\u884c\u5316\u8ba1\u7b97\uff0c\u65b0\u589e seq_len \u7ef4\u5ea6\u7684\u5e76\u884c\uff0c\u4f7f SM \u7684\u5229\u7528\u7387\u5c3d\u91cf\u6253\u6ee1\u3002\u8fd9\u5176\u5b9e\u4e5f\u662f\u5185\u5916\u5faa\u73af\u7f6e\u6362\u8fd9\u4e2a\u603b\u4f53\u601d\u60f3\u914d\u5957\u7684\u6539\u8fdb\u63aa\u65bd</li> <li>Causal Masking\uff1aFlash Attention \u662f\u5757\u8ba1\u7b97\u7684\uff0c\u53ef\u4ee5\u76f4\u63a5\u8df3\u8fc7 causal mask \u7684\u5757</li> </ul>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#parallelism","title":"Parallelism","text":"<p>FlashAttention \u5728 batch \u548c heads \u4e24\u4e2a\u7ef4\u5ea6\u4e0a\u8fdb\u884c\u4e86\u5e76\u884c\u5316\uff1a</p> <ul> <li>\u4f7f\u7528\u4e00\u4e2a thread block \u6765\u5904\u7406\u4e00\u4e2a attention head\uff0c\u603b\u5171\u9700\u8981 thread block \u7684\u6570\u91cf\u7b49\u4e8e<code>batch size \u00d7 number of heads</code>\u3002\u6bcf\u4e2a block \u88ab\u8c03\u5230\u5230\u4e00\u4e2a SM \u4e0a\u8fd0\u884c\uff0c\u4f8b\u5982 A100 GPU \u4e0a\u6709 108 \u4e2a SMs\u3002\u5f53 block \u6570\u91cf\u5f88\u5927\u65f6\uff08\u4f8b\u5982 \u226580\uff09\uff0c\u8fd9\u79cd\u8c03\u5ea6\u65b9\u5f0f\u662f\u9ad8\u6548\u7684\uff0c\u56e0\u4e3a\u51e0\u4e4e\u53ef\u4ee5\u6709\u6548\u5229\u7528 GPU \u4e0a\u6240\u6709\u8ba1\u7b97\u8d44\u6e90\u3002</li> </ul> <p>\u4f46\u662f\u5728\u5904\u7406\u957f\u5e8f\u5217\u8f93\u5165\u65f6\uff0c\u7531\u4e8e\u5185\u5b58\u9650\u5236\uff0c\u901a\u5e38\u4f1a\u51cf\u5c0f batch size \u548c head \u6570\u91cf\uff0c\u8fd9\u6837\u5e76\u884c\u5316\u7a0b\u5ea6\u5c31\u964d\u4f4e\u4e86\u3002\u56e0\u6b64\uff0cFlashAttention-2 \u8fd8\u5728\u5e8f\u5217\u957f\u5ea6\u8fd9\u4e00\u7ef4\u5ea6\u4e0a\u8fdb\u884c\u5e76\u884c\u5316\uff0c\u663e\u8457\u63d0\u5347\u4e86\u8ba1\u7b97\u901f\u5ea6\u3002\u6b64\u5916\uff0c\u5f53 batch size \u548c head \u6570\u91cf\u8f83\u5c0f\u65f6\uff0c\u5728\u5e8f\u5217\u957f\u5ea6\u4e0a\u589e\u52a0\u5e76\u884c\u6027\u6709\u52a9\u4e8e\u63d0\u9ad8 GPU \u5360\u7528\u7387\u3002</p> <ul> <li><code>Flash Attention 2</code>\u00a0 \u5c06 <code>Q</code> \u5f53\u4f5c\u5916\u5faa\u73af\uff0c<code>KV</code> \u5f53\u4f5c\u5185\u5faa\u73af\uff0c \u5c06 <code>O[i]</code> \u7684\u5728\u4e00\u4e2a <code>Q[i]</code> \u5468\u671f\u7b97\u5b8c\uff0c\u53ef\u4ee5\u51cf\u5c11 SRAM -&gt; HBM \u7684\u6b21\u6570</li> <li>\u7531\u4e8e\u6539\u8fdb\u4e86\u7b97\u6cd5\u4f7f\u5f97 warps \u4e4b\u95f4\u4e0d\u518d\u9700\u8981\u76f8\u4e92\u901a\u4fe1\u53bb\u5904\u7406\uff0c\u6240\u4ee5\u5916\u5faa\u73af\u53ef\u4ee5\u653e\u5728\u4e0d\u540c\u7684 thread block \u4e0a</li> <li>\u4ece<code>O</code>\u7684\u7f13\u5b58<code>write/read</code>\u6b21\u6570\u4ece<code>2 x B_q x B_kv -&gt; 2 x B_q</code>\u6b21</li> </ul> <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#work-partitioning-between-warps","title":"Work Partitioning Between Warps","text":"<p>\u5728\u6bcf\u4e2a thread block \u5185\u90e8\uff0c\u6211\u4eec\u4e5f\u9700\u8981\u51b3\u5b9a\u5982\u4f55\u5728\u4e0d\u540c\u7684 warp \u4e4b\u95f4\u5206\u914d\u5de5\u4f5c\u3002\u6211\u4eec\u901a\u5e38\u5728\u6bcf\u4e2a thread block \u4e2d\u4f7f\u7528 4 \u6216 8 \u4e2a warp\u3002</p> <ul> <li>v1 \u8ba1\u7b97\u8be5\u5757\u7684 \\(O_i\\) \u65f6\uff0c\u6bcf\u4e2a warp \u7b97\u51fa\u4e86\u77e9\u9635\u4e58\u7684\u90e8\u5206\u7ed3\u679c(\\(O_i\\))\uff0c\u9700\u8981\u5148\u5199\u5165\u5171\u4eab\u5185\u5b58\u3002\u7136\u540e\u518d\u540c\u6b65\uff0c\u5e76\u91cd\u65b0\u8bfb\u53d6\uff0creduce \u6210\u4e00\u4e2a\u3002\u4f1a\u6709\u989d\u5916\u7684\u5171\u4eab\u5185\u5b58\u8bfb\u5199\u5f00\u9500\uff0c\u548c\u4e0d\u540c warp \u540c\u6b65\u7684\u5f00\u9500\u3002 <p>\u9700\u8981\u628a partial \u7ed3\u679c\u5199\u5230\u5171\u4eab\u5185\u5b58\u5e76\u505a <code>__syncthreads()</code> + read + reduce</p> </li> <li>v2 \u5bf9 \\(Q_i\\) \u5206\u5757\uff0c\u6bcf\u4e2a warp \u80fd\u5f97\u5230\u77e9\u9635\u4e58\u7684\u90e8\u5206\u5b8c\u6574\u7ed3\u679c\u3002\u53ef\u4ee5\u76f4\u63a5\u5199\u5230\u5171\u4eab\u5185\u5b58\u4e2d\u8be5\u7ed3\u679c\u7684\u5bf9\u5e94\u90e8\u5206\uff0c\u4e0d\u9700\u8981 warp \u4e4b\u95f4\u540c\u6b65\u4e86\u3002\u4e5f\u4e0d\u9700\u8981\u518d\u50cf v1 \u4e00\u6837\u628a\u90e8\u5206\u548c\u4ece\u5171\u4eab\u5185\u5b58\u8bfb\u51fa\u6765\uff0c\u5199\u5230\u6700\u7ec8\u7ed3\u679c <p>\u6240\u6709\u7684\u540c\u6b65\u64cd\u4f5c\u90fd\u5728 warp \u5185\u5c31\u5b8c\u6210\u4e86\uff0c\u53ea\u6709\u6700\u540e\u7684 O \u8f93\u51fa\u7684\u65f6\u5019\u5c06 4 \u4e2a warp \u7684\u7ed3\u679c allgather \u6210\u5b8c\u6574\u7684 O</p> </li> </ul> <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#optimize-non-matmul","title":"Optimize non-matmul","text":"<p><code>Flash Attnetion v1</code>\u00a0 \u6bcf\u6b21\u90fd\u8981\u505a <code>Scaled</code>\u00a0(\\(O \\\\times L_i^{-1}\\))\uff0c\u90fd\u662f\u989d\u5916\u7684\u975e\u4e58\u6cd5\u8ba1\u7b97\uff1b</p> <p></p> <ol> <li>\u5728\u8ba1\u7b97\u5c40\u90e8 attention \u65f6\uff0c\u5148\u4e0d\u8003\u8651 softmax \u7684\u5206\u6bcd \\(\\\\sum e^{x_i}\\)\uff0c\u5373 \\(\\\\ell^{(i+1)} = e^{m^{(i)}-m^{(i+1)}} \\\\ell^{(i)} + \\\\text{rowsum}( e^{S^{(i+1)}-m^{(i+1)}} )\\)\uff0c\u4f8b\u5982\u8ba1\u7b97 \\(\\\\mathbf{O}^{(1)}\\) \u65f6\u53bb\u9664\u4e86 \\(\\\\text{diag}\\\\left(\\\\ell^{(1)}\\\\right)^{-1}\\)</li> </ol> <p>FlashAttention:</p> <p>$$    \\mathbf{O}^{(1)} = \\tilde{\\mathbf{P}}^{(1)} \\mathbf{V}^{(1)} = \\text{diag}\\left(\\ell<sup>{(1)}\\right)</sup> e<sup>{S</sup>}-m^{(1)}} \\mathbf{V}^{(1)    $$</p> <p>FlashAttention-2:</p> <p>$$    \\tilde{\\mathbf{O}}^{(1)} = e<sup>{S</sup>}-m^{(1)}} \\mathbf{V}^{(1)    $$</p> <ol> <li>\u7531\u4e8e\u53bb\u9664\u4e86 \\(\\\\text{diag}\\\\left(\\\\ell^{(i)}\\\\right)^{-1}\\)\uff0c\u66f4\u65b0 \\(\\\\tilde{\\\\mathbf{O}}^{(i+1)}\\) \u65f6\u4e0d\u9700\u8981 rescale \\(\\\\ell^{(i)} / \\\\ell^{(i+1)}\\)\uff0c\u4f46\u662f\u5f97\u5f25\u8865\u4e4b\u524d\u5c40\u90e8 max \u503c\uff0c\u4f8b\u5982\u793a\u4f8b\u4e2d\uff1a</li> </ol> <p>FlashAttention:</p> <p>$$    \\mathbf{O}^{(2)} = \\text{diag}\\left(\\ell^{(1)} / \\ell^{(2)}\\right) \\mathbf{O}^{(1)} + \\text{diag}\\left(\\ell<sup>{(2)}\\right)</sup> e<sup>{S</sup>}-m^{(2)}} \\mathbf{V}^{(2)    $$</p> <p>FlashAttention-2:</p> <p>$$    \\tilde{\\mathbf{O}}^{(2)} = \\text{diag}\\left(e<sup>{m</sup> + e}-m^{(2)}}\\right) \\tilde{\\mathbf{O}}^{(1)<sup>{S</sup> = e}-m^{(2)}} \\mathbf{V}^{(2)<sup>{S</sup> + e}-m^{(2)}} \\mathbf{V}^{(1)<sup>{S</sup>}-m^{(2)}} \\mathbf{V}^{(2)    $$</p> <ol> <li>\u7531\u4e8e\u66f4\u65b0 \\(\\\\tilde{\\\\mathbf{O}}^{(i+1)}\\) \u672a\u8fdb\u884c rescale\uff0c\u6700\u540e\u4e00\u6b65\u65f6\u9700\u8981\u5c06 \\(\\\\tilde{\\\\mathbf{O}}^{(\\\\text{last})}\\) \u4e58\u4ee5 \\(\\\\text{diag}\\\\left(\\\\ell^{(\\\\text{last})}\\\\right)^{-1}\\) \u6765\u5f97\u5230\u6b63\u786e\u7684\u8f93\u51fa\uff0c\u4f8b\u5982\u793a\u4f8b\u4e2d\uff1a</li> </ol> Text Only<pre><code>**FlashAttention-2:**\n</code></pre> <p>$$    \\mathbf{O} = \\text{diag}\\left(\\ell<sup>{(2)}\\right)</sup>} \\tilde{\\mathbf{O}}^{(2)    $$</p> <p></p>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#mask-block-attention","title":"\u5ffd\u7565 mask block \u7684 Attention \u8ba1\u7b97","text":"<ul> <li>\u7531\u4e8e FlashAttention \u548c FlashAttention-2 \u5df2\u7ecf\u901a\u8fc7\u5757\u64cd\u4f5c\u6765\u5b9e\u73b0\uff0c\u5bf9\u4e8e\u6240\u6709\u5217\u7d22\u5f15\u90fd\u5927\u4e8e\u884c\u7d22\u5f15\u7684\u5757\uff08\u5927\u7ea6\u5360\u603b\u5757\u6570\u7684\u4e00\u534a\uff09\uff0c\u6211\u4eec\u53ef\u4ee5\u8df3\u8fc7\u8be5\u5757\u7684\u8ba1\u7b97\u3002\u8fd9\u6bd4\u6ca1\u6709\u5e94\u7528\u56e0\u679c\u63a9\u7801\u7684\u6ce8\u610f\u529b\u8ba1\u7b97\u901f\u5ea6\u63d0\u9ad8\u4e86 1.7-1.8 \u500d\u3002</li> <li>\u4e0d\u9700\u8981\u5bf9\u90a3\u4e9b\u884c\u7d22\u5f15\u4e25\u683c\u5c0f\u4e8e\u5217\u7d22\u5f15\u7684\u5757\u5e94\u7528\u56e0\u679c\u63a9\u7801\u3002\u8fd9\u610f\u5473\u7740\u5bf9\u4e8e\u6bcf\u4e00\u884c\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5bf9 1 \u4e2a\u5757\u5e94\u7528\u56e0\u679c\u63a9\u7801\u3002</li> </ul>"},{"location":"blogs/posts/FlashAttention%20%E5%8E%9F%E7%90%86%20v1-v2/#summary_1","title":"Summary","text":"<p>Flash-Decoding \u5206 3 \u4e2a\u6b65\u9aa4\u8fdb\u884c\uff1a</p> <ol> <li>\u9996\u5148\uff0c\u6211\u4eec\u5c06\u952e/\u503c\u62c6\u5206\u6210\u66f4\u5c0f\u7684\u5757\u3002</li> <li>\u6211\u4eec\u4f7f\u7528 FlashAttention \u5e76\u884c\u8ba1\u7b97\u6bcf\u4e2a\u5206\u5272\u540e\u7684\u67e5\u8be2\u6ce8\u610f\u529b\u503c\u3002\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u4e3a\u6bcf\u884c\u548c\u6bcf\u4e2a\u5206\u5272\u5199\u5165\u4e00\u4e2a\u989d\u5916\u7684\u6807\u91cf\uff1a\u6ce8\u610f\u529b\u503c\u7684\u5bf9\u6570\u548c\u6307\u6570\u3002</li> <li>\u6700\u540e\uff0c\u6211\u4eec\u901a\u8fc7\u5bf9\u6240\u6709\u5206\u5272\u8fdb\u884c\u5f52\u7ea6\u6765\u8ba1\u7b97\u5b9e\u9645\u8f93\u51fa\uff0c\u4f7f\u7528\u5bf9\u6570\u6c42\u548c\u6307\u6570\u6765\u7f29\u653e\u6bcf\u4e2a\u5206\u5272\u7684\u8d21\u732e\u3002</li> </ol> <p>\u8fd9\u4e00\u5207\u4e4b\u6240\u4ee5\u53ef\u884c\uff0c\u662f\u56e0\u4e3a\u6ce8\u610f\u529b/softmax \u53ef\u4ee5\u8fed\u4ee3\u8ba1\u7b97\u3002\u5728 Flash-Decoding \u4e2d\uff0c\u5b83\u88ab\u7528\u4e8e\u4e24\u4e2a\u5c42\u9762\uff1a\u5728 splits \u5185\uff08\u7c7b\u4f3c\u4e8e FlashAttention\uff09\uff0c\u4ee5\u53ca\u8de8 splits \u8fdb\u884c\u6700\u7ec8\u7684 reduce\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u6b65\u9aa4 (1) \u4e0d\u6d89\u53ca\u4efb\u4f55 GPU \u64cd\u4f5c\uff0c\u56e0\u4e3a\u952e/\u503c\u5757\u662f\u5b8c\u6574\u952e/\u503c\u5f20\u91cf\u7684\u89c6\u56fe\u3002\u7136\u540e\uff0c\u6211\u4eec\u9700\u8981\u4e24\u4e2a\u72ec\u7acb\u7684\u5185\u6838\u5206\u522b\u6267\u884c\u6b65\u9aa4 (2) \u548c (3)\u3002</p> <p></p>"},{"location":"blogs/posts/Implement%20of%20Concurrent/","title":"The implement of Concurrent Component","text":"2025-06-112025-12-10 <code>#C++</code>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#mutex","title":"Mutex","text":"<p> \u7ea6 1452 \u4e2a\u5b57  74 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 8 \u5206\u949f</p>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#pthread_mutex_t","title":"pthread_mutex_t","text":"<p>\u4e00\u4e2a pthread_mutex_t \u53d8\u91cf\u4e0d\u4ec5\u4ec5\u662f\u4e00\u4e2a\u6574\u6570\u3002\u5b83\u662f\u4e00\u4e2a\u7ed3\u6784\u4f53\uff0c\u5305\u542b\u4e86\u9501\u7684\u72b6\u6001\u3001\u7c7b\u578b\u3001\u6301\u6709\u8005\u7b49\u4fe1\u606f\u3002\u5176\u5177\u4f53\u7ed3\u6784\u4f1a\u56e0\u67b6\u6784\u548c glibc \u7248\u672c\u800c\u5f02\uff0c\u4f46\u5176\u6838\u5fc3\u90e8\u5206\uff08\u5728 x86_64 \u4e0a\uff09\u901a\u5e38\u5982\u4e0b\uff1a</p> C++<pre><code>typedef union {\n  struct {\n    int __lock;             // \u6838\u5fc3\u7684 futex word\n    unsigned int __count;   // \u9012\u5f52\u9501\u7684\u8ba1\u6570\u5668\n    int __owner;            // \u6301\u6709\u8be5\u9501\u7684\u7ebf\u7a0bTID\n    unsigned int __nusers;  // \u7b49\u5f85\u8005\u7684\u6570\u91cf\n    int __kind;             // \u9501\u7684\u7c7b\u578b (normal, recursive, error-checking)\n    // ...\n  } __data;\n} pthread_mutex_t;\n// __lock:\n// 0: Unlocked\n// 1: Locked, no waiters\n// 2: Locked, with waiters\n</code></pre> <p>\u800c pthread_mutex_lock \u548c pthread_mutex_unlock \u7684\u5b9e\u73b0\u662f\u57fa\u4e8e\u539f\u5b50\u6307\u4ee4\u548c futex \u7cfb\u7edf\u8c03\u7528\u5b9e\u73b0\u7684\u3002</p>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#pthread_mutex_lock","title":"pthread_mutex_lock","text":"<ol> <li>\u9996\u5148\u5728\u7528\u6237\u6001\u4f7f\u7528 CAS\uff08Compare-And-Swap\uff09\u5c1d\u8bd5\u5c06 <code>__lock</code> \u4ece 0\uff08unlocked\uff09\u53d8\u4e3a 1\uff08locked\uff09\u3002\u5982\u679c\u6210\u529f\uff0c\u76f4\u63a5\u8fd4\u56de\u3002</li> <li>\u5982\u679c CAS \u5931\u8d25\uff0c\u8bf4\u660e\u9501\u5df2\u7ecf\u88ab\u5176\u4ed6\u7ebf\u7a0b\u6301\u6709\uff0c\u6b64\u65f6\u4f1a\u8fdb\u5165\u81ea\u65cb\u72b6\u6001\uff0c\u5c1d\u8bd5\u591a\u6b21\u83b7\u53d6\u9501\u3002</li> <li>\u5982\u679c\u81ea\u65cb\u591a\u6b21\u4ecd\u7136\u5931\u8d25\uff0c\u8bf4\u660e\u7ade\u4e89\u6fc0\u70c8\uff0c\u5c06<code>__lock</code>\u53d8\u4e3a 2\uff0c\u6b64\u65f6\u4f1a\u8c03\u7528 futex \u7cfb\u7edf\u8c03\u7528\uff0c\u5c06\u5f53\u524d\u7ebf\u7a0b\u6302\u8d77\uff0c\u7b49\u5f85\u9501\u88ab\u91ca\u653e\u3002</li> <li>\u5176\u4ed6\u7ebf\u7a0b\u91ca\u653e\u9501\u540e\uff0c\u8be5\u7ebf\u7a0b\u88ab\u5524\u9192\uff0c\u5faa\u73af\u56de\u5230\u81ea\u65cb\u72b6\u6001\uff0c\u91cd\u65b0\u5c1d\u8bd5\u83b7\u53d6\u9501\u3002</li> </ol> C++<pre><code>if (atomic_compare_and_swap(&amp;mutex-&gt;__lock, 0, 1) == 0) {\n    mutex-&gt;__owner = self_tid;\n    return 0;\n}\nfor (int i = 0; i &lt; SPIN_COUNT; ++i) {\n    if (mutex-&gt;__lock == 0) {\n        if (atomic_compare_and_swap(&amp;mutex-&gt;__lock, 0, 1) == 0) {\n            mutex-&gt;__owner = self_tid;\n            return 0;\n        }\n    }\n    // CPU \"pause\" \u6307\u4ee4\uff0c\u51cf\u5c11\u529f\u8017\u5e76\u63d0\u793aCPU\u8fd9\u662f\u5728\u81ea\u65cb\n    _mm_pause();\n}\nint old_lock = atomic_exchange(&amp;mutex-&gt;__lock, 2);\nif (old_lock != 0) {\n    // \u8c03\u7528 futex \u7cfb\u7edf\u8c03\u7528\uff0c\u8ba9\u5185\u6838\u5c06\u5f53\u524d\u7ebf\u7a0b\u7761\u7720\u3002\n    // \u7b49\u5f85\u5728 __lock \u4e0a\uff0c\u671f\u671b\u5b83\u7684\u503c\u662f 2\u3002\n    syscall(SYS_futex, &amp;mutex-&gt;__lock, FUTEX_WAIT, 2, ...);\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#pthread_mutex_unlock","title":"pthread_mutex_unlock","text":"<ol> <li>\u9996\u5148\u539f\u5b50\u5730\u5c06 <code>__lock</code> \u7684\u503c\u51cf 1\uff0c\u5e76\u8fd4\u56de\u4e4b\u524d\u7684\u503c\u3002</li> <li>\u5982\u679c\u4e4b\u524d\u7684\u503c\u662f 1\uff0c\u8bf4\u660e\u9501\u88ab\u6210\u529f\u91ca\u653e\uff0c\u6ca1\u6709\u7b49\u5f85\u8005\uff0c\u6b64\u65f6\u5c06 <code>__lock</code> \u8bbe\u4e3a 0\u3002</li> <li>\u5982\u679c\u4e4b\u524d\u7684\u503c\u662f 2\uff0c\u8bf4\u660e\u6709\u7ebf\u7a0b\u5728\u7b49\u5f85\uff0c\u6b64\u65f6\u8c03\u7528 futex_wake \u7cfb\u7edf\u8c03\u7528\uff0c\u5524\u9192\u4e00\u4e2a\u7b49\u5f85\u7684\u7ebf\u7a0b\u3002</li> </ol> C++<pre><code>int old_lock = atomic_fetch_sub(&amp;mutex-&gt;__lock, 1);\nif (old_lock != 1) {\n    syscall(SYS_futex, &amp;mutex-&gt;__lock, FUTEX_WAKE, 1, ...);\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#futex","title":"futex","text":"<p>\u5b9e\u9645\u4e0a\u4e3b\u8981\u903b\u8f91\u5206\u4e3a wait(do_futex_wait)\u4ee5\u53ca wake(do_futex_wake)</p>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#do_futex_wait","title":"do_futex_wait","text":"<ol> <li>\u9501\u5b9a\u5185\u6838\u6570\u636e\u7ed3\u6784\uff1a\u83b7\u53d6\u7ba1\u7406\u8be5 uaddr \u7684\u5185\u90e8\u9501\u3002</li> <li>\u9a8c\u8bc1\u6761\u4ef6: \u518d\u6b21\u4ece\u7528\u6237\u7a7a\u95f4\u8bfb\u53d6 *uaddr \u7684\u503c\uff0c\u5e76\u4e0e\u7528\u6237\u4f20\u5165\u7684 val \u6bd4\u8f83\u3002\u8fd9\u662f\u81f3\u5173\u91cd\u8981\u7684\u201c\u539f\u5b50\u6027\u201d\u4fdd\u8bc1\u3002\u5982\u679c\u5728\u7528\u6237\u6001\u68c0\u67e5\u540e\u3001\u8fdb\u5165\u5185\u6838\u524d\uff0c\u9501\u7684\u72b6\u6001\u6539\u53d8\u4e86\uff0c\u8fd9\u4e00\u6b65\u53ef\u4ee5\u53d1\u73b0\uff0c\u5e76\u7acb\u5373\u8fd4\u56de\uff0c\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u4f11\u7720\u3002</li> <li>\u52a0\u5165\u7b49\u5f85\u961f\u5217: \u5982\u679c\u6761\u4ef6\u4ecd\u7136\u6ee1\u8db3\uff0c\u5c06\u5f53\u524d\u7ebf\u7a0b\u5c01\u88c5\u6210\u4e00\u4e2a\u7b49\u5f85\u8282\u70b9\uff0c\u52a0\u5165\u5230 uaddr \u5bf9\u5e94\u7684\u54c8\u5e0c\u7b49\u5f85\u961f\u5217\u4e2d\u3002</li> <li>\u4f11\u7720: \u8c03\u7528\u8c03\u5ea6\u5668 schedule()\uff0c\u653e\u5f03 CPU\uff0c\u8fdb\u5165\u7761\u7720\u72b6\u6001\u3002</li> <li>\u5524\u9192\u540e\u6e05\u7406: \u88ab FUTEX_WAKE \u5524\u9192\u540e\uff0c\u4ece\u7b49\u5f85\u961f\u5217\u4e2d\u79fb\u9664\u81ea\u5df1\uff0c\u7136\u540e\u8fd4\u56de\u7528\u6237\u7a7a\u95f4\u3002</li> </ol>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#do_futex_wake","title":"do_futex_wake","text":"<ol> <li>\u9501\u5b9a\u5185\u6838\u6570\u636e\u7ed3\u6784\uff1a\u627e\u5230 uaddr \u5bf9\u5e94\u7684\u7b49\u5f85\u961f\u5217\u3002</li> <li>\u904d\u5386\u961f\u5217: \u904d\u5386\u7b49\u5f85\u961f\u5217\u4e2d\u7684\u7ebf\u7a0b\u3002</li> <li>\u5524\u9192\u7ebf\u7a0b: \u5bf9\u6bcf\u4e2a\u8981\u5524\u9192\u7684\u7ebf\u7a0b\u8c03\u7528 wake_up_process()\u3002\u8fd9\u4e2a\u51fd\u6570\u662f\u5185\u6838\u8c03\u5ea6\u5b50\u7cfb\u7edf\u7684\u6838\u5fc3\u90e8\u5206\uff0c\u5b83\u4f1a\u6539\u53d8\u7ebf\u7a0b\u7684\u72b6\u6001\uff0c\u4f7f\u5176\u6709\u8d44\u683c\u518d\u6b21\u88ab CPU \u8c03\u5ea6\u3002</li> <li>\u8fd4\u56de: \u8fd4\u56de\u88ab\u6210\u529f\u5524\u9192\u7684\u7ebf\u7a0b\u6570\u91cf\u3002</li> </ol>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#atomic-variable","title":"Atomic Variable","text":"<p>\u7f16\u8bd1\u5668\u5728\u7f16\u8bd1\u65f6\uff0c\u4f1a\u5c06 C++ \u6e90\u4ee3\u7801\u4e2d\u7684\u539f\u5b50\u64cd\u4f5c\uff08\u5982 load, store, fetch_add, compare_exchange_strong\uff09\u6620\u5c04\u5230\u76ee\u6807\u786c\u4ef6\u5e73\u53f0\u63d0\u4f9b\u7684\u6700\u4f18\u6307\u4ee4\u3002\u6211\u4eec\u53ef\u4ee5\u7528 <code>my_atomic.is_lock_free()</code> \u65b9\u6cd5\u6765\u67e5\u8be2\u4e00\u4e2a\u539f\u5b50\u53d8\u91cf\u5728\u5f53\u524d\u5e73\u53f0\u4e0a\u662f\u5426\u662f\u65e0\u9501\u7684\u3002</p> <ul> <li> <p><code>std::atomic_flag</code> \u662f\u4e00\u4e2a\u539f\u5b50\u7684\u5e03\u5c14\u7c7b\u578b\uff0c\u4e5f\u662f\u552f\u4e00\u4fdd\u8bc1 lock-free \u7684\u539f\u5b50\u7c7b\u578b\uff0c\u53ea\u80fd\u7528<code>ATOMIC_FLAG_INIT</code> \u521d\u59cb\u5316\u4e3a false</p> </li> <li> <p>\u6709\u539f\u751f\u539f\u5b50\u6307\u4ee4\u7684\u786c\u4ef6 (\u4e3b\u6d41): \u5728\u73b0\u4ee3 CPU \u67b6\u6784\uff08\u5982 x86/x86_64, ARMv7+, AArch64\uff09\u4e0a\uff0c\u7edd\u5927\u591a\u6570\u539f\u5b50\u64cd\u4f5c\u90fd\u6709\u5bf9\u5e94\u7684\u5355\u6761 CPU \u6307\u4ee4\u3002</p> </li> <li> <p>\u6ca1\u6709\u539f\u751f\u539f\u5b50\u6307\u4ee4\u7684\u786c\u4ef6 (\u975e\u4e3b\u6d41): \u5728\u4e00\u4e9b\u8f83\u8001\u6216\u7279\u6b8a\u7684\u67b6\u6784\u4e0a\uff0c\u53ef\u80fd\u6ca1\u6709\u539f\u751f\u7684\u539f\u5b50\u6307\u4ee4\u3002\u8fd9\u65f6\uff0cC++ \u6807\u51c6\u5e93\u4f1a\u4f7f\u7528\u81ea\u65cb\u9501\u6216\u5176\u4ed6\u673a\u5236\u6765\u6a21\u62df\u539f\u5b50\u64cd\u4f5c\u3002</p> </li> </ul> C++<pre><code>// \u6a21\u62df atomic&lt;T&gt;::fetch_add\nT fetch_add(T arg) {\n    internal_global_lock.lock(); // \u83b7\u53d6\u5168\u5c40\u9501\n    T old_value = this-&gt;value;\n    this-&gt;value += arg;\n    internal_global_lock.unlock(); // \u91ca\u653e\u9501\n    return old_value;\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#condition-variable","title":"Condition Variable","text":"","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#pthread_cond_t","title":"pthread_cond_t","text":"C++<pre><code>struct pthread_cond_t {\n    // futex word \u7528\u4e8e condvar \u7684\u7b49\u5f85\u548c\u5524\u9192\n    int cond_futex;\n    pthread_mutex_t *mutex;\n    unsigned int total_seq;    // \u603b\u7684 signal/broadcast \u6b21\u6570\n    unsigned int wakeup_seq;   // \u5df2\u88ab\u5524\u9192\u5904\u7406\u7684\u6b21\u6570\n    // \u5176\u4ed6\u5b57\u6bb5\uff0c\u5982\u7b49\u5f85\u8005\u6570\u91cf\u3001\u65f6\u949fID\u7b49...\n};\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#pthread_cond_wait","title":"pthread_cond_wait","text":"<ol> <li>\u8bfb\u53d6\u5f53\u524d\u7684 <code>total_seq</code>\u3002\u8fd9\u662f\u6211\u4eec\u8fdb\u5165\u7b49\u5f85\u524d\u7684\u201c\u7248\u672c\u5feb\u7167\u201d\u3002\u6211\u4eec\u5c06\u7528\u8fd9\u4e2a\u503c\u6765\u68c0\u67e5\u5728\u6211\u4eec\u89e3\u9501\u540e\uff0c\u662f\u5426\u6709 signal \u53d1\u751f\u3002</li> <li>\u89e3\u9501\u4f20\u5165\u7684\u4e92\u65a5\u4f53\u3002\u8fd9\u662f <code>wait</code> \u8bed\u4e49\u7684\u5173\u952e\u90e8\u5206\u3002\u4ece\u8fd9\u4e00\u523b\u8d77\uff0c\u5176\u4ed6\u7ebf\u7a0b\u53ef\u4ee5\u83b7\u53d6\u9501\u5e76 signal\u3002</li> <li>\u5728\u6211\u4eec\u89e3\u9501 mutex \u548c\u8c03\u7528 futex_wait \u4e4b\u95f4\uff0c\u53ef\u80fd\u5df2\u7ecf\u6709 signal \u53d1\u751f\u3002<code>wakeup_seq</code> \u8bb0\u5f55\u4e86\u88ab\u5524\u9192\u7684\u7ebf\u7a0b\u5e94\u8be5\u201c\u6d88\u8d39\u201d\u5230\u7684\u5e8f\u5217\u53f7\u3002\u5982\u679c <code>wakeup_seq</code> \u5df2\u7ecf\u8d76\u4e0a\u6216\u8d85\u8fc7\u4e86\u6211\u4eec\u8bb0\u5f55\u7684 <code>current_total_seq</code>\uff0c\u8bf4\u660e\u6211\u4eec\u5e94\u8be5\u88ab\u5524\u9192\u7684\u90a3\u4e2a signal \u5df2\u7ecf\u53d1\u751f\u4e86\u3002\u76f4\u63a5\u8df3\u5230 Fast Path</li> <li>\u8fdb\u5165\u5185\u6838\u7b49\u5f85 (Slow Path)\u3002\u53ea\u6709\u5728\u786e\u5b9a\u6ca1\u6709\u9519\u8fc7\u4fe1\u53f7\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u624d\u53bb\u7761\u7720\u3002\u6211\u4eec\u544a\u8bc9\u5185\u6838\u5728 <code>cond-&gt;cond_futex</code> \u4e0a\u7b49\u5f85\uff0c\u5e76\u4e14\u53ea\u6709\u5f53 <code>cond-&gt;cond_futex</code> \u7684\u503c\u7b49\u4e8e <code>current_total_seq</code> \u65f6\u624d\u7761\u7720\u3002    - \u8fd9\u662f\u4e00\u4e2a\u7b80\u5316\u7684\u6a21\u578b\uff0c\u6838\u5fc3\u662f\uff1a\u5982\u679c\u5728\u6211\u4eec\u68c0\u67e5\u540e\uff0c\u4f46\u5728\u7761\u7720\u524d\uff0c<code>signal</code> \u53d1\u751f\u5e76\u6539\u53d8\u4e86\u72b6\u6001\uff0cfutex_wait \u4f1a\u7acb\u5373\u8fd4\u56de\u3002</li> <li>\u65e0\u8bba\u6211\u4eec\u662f\u4ece <code>futex_wait</code> \u88ab\u5524\u9192\uff0c\u8fd8\u662f\u56e0\u4e3a\u9519\u8fc7\u4e86\u4fe1\u53f7\u800c\u76f4\u63a5\u8df3\u5230 Fast Path\uff0c\u6211\u4eec\u90fd\u9700\u8981\u66f4\u65b0 <code>wakeup_seq</code>\uff0c\u8868\u793a\u6211\u4eec\u5df2\u7ecf\u201c\u6d88\u8d39\u201d\u4e86\u8fd9\u4e2a\u5524\u9192\u3002    - \u6211\u4eec\u5c1d\u8bd5\u5c06 wakeup_seq \u4ece\u6211\u4eec\u4e4b\u524d\u770b\u5230\u7684 <code>current_total_seq</code> \u66f4\u65b0\u4e3a signal \u53d1\u751f\u540e\u7684 <code>current_total_seq + 1</code>\u3002    - \u8fd9\u901a\u5e38\u901a\u8fc7\u4e00\u4e2a CAS \u5faa\u73af\u5b8c\u6210\uff0c\u4ee5\u5904\u7406\u591a\u4e2a\u7ebf\u7a0b\u88ab broadcast \u5524\u9192\u7684\u60c5\u51b5\u3002\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u4f1a\u6210\u529f\u5730\u5c06 wakeup_seq \u52a0\u4e00\u3002</li> <li>\u91cd\u65b0\u83b7\u53d6\u4e92\u65a5\u9501\u3002\u8fd9\u662f <code>wait</code> \u8bed\u4e49\u7684\u53e6\u4e00\u534a\u3002\u51fd\u6570\u8fd4\u56de\u524d\uff0c\u5fc5\u987b\u91cd\u65b0\u6301\u6709\u9501\u3002</li> </ol> C++<pre><code>int pthread_cond_wait(pthread_cond_t* cond, pthread_mutex_t* mutex) {\n    unsigned int current_total_seq = cond-&gt;total_seq.load(memory_order_relaxed);\n    pthread_mutex_unlock(mutex);\n    if (cond-&gt;wakeup_seq.load(memory_order_acquire) == current_total_seq) {\n        syscall(SYS_futex, &amp;cond-&gt;cond_futex, FUTEX_WAIT, some_expected_value, ...);\n    }\n    unsigned int old_wakeup_seq = cond-&gt;wakeup_seq.load(memory_order_relaxed);\n    if (old_wakeup_seq == current_total_seq) {\n        cond-&gt;wakeup_seq.compare_exchange_strong(old_wakeup_seq, current_total_seq + 1, ...);\n    }\n    pthread_mutex_lock(mutex);\n    return 0; // Success\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/Implement%20of%20Concurrent/#pthread_cond_signal","title":"pthread_cond_signal","text":"<ol> <li>\u539f\u5b50\u5730\u589e\u52a0\u603b\u5e8f\u5217\u53f7\u8ba1\u6570\u5668\uff0c\u8fd9\u7559\u4e0b\u4e86 \"signal\" \u53d1\u751f\u8fc7\u7684\u75d5\u8ff9\u3002</li> <li>\u68c0\u67e5\u662f\u5426\u6709\u6f5c\u5728\u7684\u7b49\u5f85\u8005\u3002\u5982\u679c <code>wakeup_seq</code> \u8ffd\u4e0a\u4e86 <code>total_seq</code> (\u589e\u52a0\u524d\u7684\u503c)\uff0c\u8bf4\u660e\u6240\u6709\u4e4b\u524d\u7684 signal \u90fd\u5df2\u7ecf\u88ab wait \u7ebf\u7a0b\u201c\u6d88\u8d39\u201d\u4e86\uff0c\u5f88\u53ef\u80fd\u5f53\u524d\u6ca1\u6709\u7ebf\u7a0b\u5728\u7b49\u5f85\u3002\u8fd9\u662f\u4e00\u4e2a\u4f18\u5316\uff0c\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u7cfb\u7edf\u8c03\u7528\u3002</li> <li>\u5524\u9192\u4e00\u4e2a\u7ebf\u7a0b\u3002\u6211\u4eec\u544a\u8bc9\u5185\u6838\u53bb <code>cond-&gt;cond_futex</code> \u8fd9\u4e2a\u5730\u5740\u4e0a\uff0c\u5524\u9192\u6700\u591a 1 \u4e2a\u7ebf\u7a0b\u3002\u8fd9\u4e2a <code>futex_wake</code> \u8c03\u7528\u662f\u201c\u53d1\u5c04\u540e\u4e0d\u7ba1\u201d\u7684\u3002\u5373\u4f7f\u6ca1\u6709\u7ebf\u7a0b\u5728\u7b49\u5f85\uff0c\u5b83\u4e5f\u53ea\u662f\u4e00\u4e2a\u7a7a\u64cd\u4f5c\u3002</li> </ol> C++<pre><code>int pthread_cond_signal(pthread_cond_t* cond) {\n    unsigned int old_total_seq = cond-&gt;total_seq.fetch_add(1, memory_order_acq_rel);\n    if (cond-&gt;wakeup_seq.load(memory_order_relaxed) == old_total_seq) {\n        syscall(SYS_futex, &amp;cond-&gt;cond_futex, FUTEX_WAKE, 1, ...);\n    }\n    return 0; // Success\n}\n</code></pre>","tags":["C++"]},{"location":"blogs/posts/PageAttention/","title":"Page Attention","text":"2025-10-302025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#page-attention","title":"Page Attention","text":"<p> \u7ea6 3163 \u4e2a\u5b57  186 \u884c\u4ee3\u7801  8 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 18 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#prequisite","title":"Prequisite","text":"","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#gpu-tiling","title":"GPU Tiling","text":"<ul> <li>\u5c06\u77e9\u9635\u5212\u5206\u4e3a\u66f4\u5c0f\u7684\u5b50\u77e9\u9635\uff08tile\uff09\uff0c\u4ee5\u4fbf\u66f4\u9ad8\u6548\u5730\u5229\u7528 GPU \u7684\u5e76\u884c\u8ba1\u7b97\u80fd\u529b\u548c\u5185\u5b58\u5c42\u6b21\u7ed3\u6784\u3002</li> </ul> Python<pre><code>A_frag, B_frag, C_frag: registers\nA_tile, B_tile: shared memory\n\nfor p from 0 to K_tile-1:\n    A_frag[M_frag] &lt;= A_tile[0 to M_frag-1][p]\n    B_frag[N_frag] &lt;= B_tile[p][0 to N_frag-1]\n    for i from 0 to M_frag-1:\n        for j from 0 to N_frag-1:\n            C_frag[i][j] += A_frag[i][p] * B_frag[p][j];\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#sequence","title":"Sequence","text":"<p>\u5355\u4e2a\u67e5\u8be2\u6ce8\u610f\u529b\u5185\u6838\uff08single-query kernel\uff09\u6bcf\u4e2a\u5e8f\u5217\u5728\u8fd9\u4e2a kernel \u5185\u53ea\u6709\u4e00\u4e2a query token \u9700\u8981\u5904\u7406\u3002\u5982\u679c batch \u91cc\u6709\u5f88\u591a\u5e8f\u5217\u3001\u6bcf\u4e2a\u5e8f\u5217\u91cc\u6709\u591a\u4e2a token\uff0c\u5185\u6838\u5c31\u628a\u8fd9\u4e9b token \u5c55\u5e73\uff0c\u6bcf\u4e2a token \u5f53\u4f5c\u4e00\u4e2a \u201c\u72ec\u7acb\u7684 query \u5e8f\u5217\u201d\u3002</p> Bash<pre><code>[batch_size, seq_len, num_heads, head_size] =&gt;[num_seqs, num_heads, head_size]\n</code></pre> <p>\u5728\u5e38\u89c4\u7684 \u591a\u67e5\u8be2\u6ce8\u610f\u529b (multi-query) \u6216 \u6807\u51c6\u6ce8\u610f\u529b (scaled dot-product attention) \u5185\u6838\u4e2d\uff0c\u5f80\u5f80\u662f\u4e00\u6574\u4e2a\u5e8f\u5217\u7684\u6240\u6709 query \u4e00\u8d77\u7b97\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#prons","title":"Prons:","text":"<ul> <li> <p>\u5e76\u884c\u5ea6\u66f4\u9ad8\uff1a\u6bcf\u4e2a query token \u72ec\u7acb\u5e76\u884c\uff0c\u80fd\u66f4\u597d\u5730\u6620\u5c04\u5230 GPU thread block\u3002</p> </li> <li> <p>\u8282\u7701\u663e\u5b58\u8bbf\u95ee\uff1a\u5355 query kernel \u5f80\u5f80\u914d\u5408 KV-cache\uff0c\u628a\u6240\u6709 key/value \u653e\u5728\u663e\u5b58\u4e2d\uff0c\u4e00\u4e2a query \u53ea\u9700\u8981\u62c9\u53d6\u4e00\u6b21\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#vectorization","title":"Vectorization(\u77e2\u91cf\u5316\u8bbf\u95ee)","text":"","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#why-vectorization","title":"Why Vectorization","text":"<ul> <li> <p>\u5728 GPU \u4e0a\u505a\u77e9\u9635\u4e58\u6cd5\u6216\u6ce8\u610f\u529b\u64cd\u4f5c\u65f6\uff0c\u5982\u679c\u4e00\u4e2a\u7ebf\u7a0b\u53ea\u6309\u6807\u91cf\uff08scalar\uff09\u53bb\u8bfb\u6570\u636e\uff0c\u663e\u5b58\u5e26\u5bbd\u5229\u7528\u7387\u5f88\u4f4e\u3002\u56e0\u6b64\u5e38\u89c1\u7684\u4f18\u5316\u65b9\u6cd5\u662f\uff1a</p> </li> <li> <p>\u4e00\u6b21\u52a0\u8f7d\u591a\u4e2a\u5143\u7d20 \u2192 \u5411\u91cf\u5316\u52a0\u8f7d\uff08vectorized load\uff09</p> </li> <li> <p>\u6bcf\u4e2a\u7ebf\u7a0b\u7ec4\uff08warp \u6216 thread group\uff09\u534f\u540c\u52a0\u8f7d\u6570\u636e\uff0c\u4fdd\u8bc1\u5185\u5b58\u5bf9\u9f50\uff08alignment\uff09\u548c coalesced memory access\uff0c\u63d0\u5347\u541e\u5410\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#how-to-vectorization","title":"How to Vectorization","text":"<ul> <li>Key \u7684 VEC_SIZE: \u6bcf\u4e2a\u7ebf\u7a0b\u7ec4\uff08THREAD_GROUP_SIZE \u4e2a\u7ebf\u7a0b\uff09\u8981\u4fdd\u8bc1\u4e00\u6b21\u6293\u53d6\u7684\u6570\u636e\u603b\u91cf\u4e3a 16 \u5b57\u8282\u3002</li> </ul> Python<pre><code>VEC_SIZE = 16 / (scalar_t \u5927\u5c0f \u00d7 THREAD_GROUP_SIZE)\n</code></pre> <ul> <li>Value \u7684 V_VEC_SIZE: \u6bcf\u4e2a\u7ebf\u7a0b\u81ea\u5df1\u5c31\u8981\u5bf9\u9f50\u5230 16 \u5b57\u8282\u3002</li> </ul> Python<pre><code>V_VEC_SIZE = 16 / (scalar_t \u5927\u5c0f)\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#why-k-and-v-have-different-vec_size","title":"Why K and V have different VEC_SIZE","text":"<p>\u5bf9\u4e8e Key \u5411\u91cf</p> <ul> <li>\u8fdb\u884c QK \u70b9\u79ef\u8ba1\u7b97\u6211\u4eec\u9700\u8981\u590d\u7528\u4e00\u6bb5 Key \u5411\u91cf\u7684\u5143\u7d20\u505a\u591a\u6b21\u8fd0\u7b97 (tile d \u65b9\u5f0f)   $$   score_{i,j}\u200b= Q_i\u200b\u00b7K_j\u200b=\\sum_{d=1}^{head_size} Q_{i,d}\u200b\u00d7K_{j,d}\u200b   $$</li> <li>\u5982\u679c\u6bcf\u4e2a\u7ebf\u7a0b\u5355\u72ec\u62c9\u53d6 Key \u5411\u91cf\u7684\u8bdd</li> <li>\u5185\u5b58\u8bbf\u95ee\u5730\u5740\u4e0d\u8fde\u7eed\uff08stride \u5927\uff09</li> <li>\u6bcf\u6b21\u8bbf\u95ee\u7684\u5143\u7d20\u4e0d\u5171\u7528\uff08\u65e0\u590d\u7528\uff09</li> <li>GPU \u8bbf\u5b58 transaction \u4e0d\u5408\u5e76\u3002</li> <li>\u901a\u8fc7\u7ebf\u7a0b\u7ec4\u534f\u4f5c\u52a0\u8f7d\uff08\u6bcf\u4e2a\u7ebf\u7a0b\u52a0\u8f7d\u81ea\u5df1\u7684\u4e00\u5c0f\u6bb5\uff0c\u7ebf\u7a0b\u95f4\u5730\u5740\u8fde\u7eed\uff09\u53ef\u4ee5\u5b9e\u73b0 coalesced global loads\uff08\u5408\u5e76\u5185\u5b58\u4e8b\u52a1\uff09\uff0c\u5e76\u628a tile \u653e\u5230 shared memory \u4ee5\u5b9e\u73b0\u590d\u7528\u3002</li> </ul> <p>\u5bf9\u4e8e Value \u5411\u91cf</p> \\[ output_i = \\\\sum\\_{j=1}^{num_tokens} softmax(score\\_{i,j}) \u00d7 V_j\u200b \\] <ul> <li>\u6bcf\u4e2a\u7ebf\u7a0b\u8d1f\u8d23\u751f\u6210\u4e00\u4e2a query \u7684\u8f93\u51fa\u5411\u91cf\u4e00\u90e8\u5206\uff0c\u4e0d\u9700\u8981\u8fdb\u884c tile K \u65b9\u5f0f\u52a0\u8f7d\uff0c\u6240\u4ee5\u6bcf\u4e2a\u7ebf\u7a0b\u81ea\u5df1\u52a0\u8f7d\u81ea\u5df1\u7684 Value \u5411\u91cf\u5373\u53ef\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#hierarchical-computation","title":"Hierarchical Computation","text":"Python<pre><code>Grid (The entire attention calculation for all queries &amp; heads)\n\u2514\u2500\u2500 Thread Block (Task: Compute for Query #5, Head #3)\n    \u251c\u2500\u2500 Warp 0 (Processes KV context blocks 0, 4, 8...)\n    \u2502   \u251c\u2500\u2500 Thread Group 0 (Threads 0-3) -&gt; Works on Token A\n    \u2502   \u251c\u2500\u2500 Thread Group 1 (Threads 4-7) -&gt; Works on Token B\n    \u2502   \u2514\u2500\u2500 ...\n    \u2514\u2500\u2500 Warp 1 (Processes KV context blocks 1, 5, 9...)\n        \u251c\u2500\u2500 Thread Group 8 (Threads 32-35) -&gt; Works on Token C\n        \u2514\u2500\u2500 ...\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#grid","title":"Grid","text":"<p>\u7f51\u683c\u7684\u4efb\u52a1\u662f\u8ba1\u7b97 all tokens on all heads \u7684\u6ce8\u610f\u529b\u3002\u542f\u52a8\u914d\u7f6e Grid: (num_heads, num_seqs, max_partions)</p> <ul> <li> <p>\u7f51\u683c\u7684 x \u7ef4\u5ea6\u5bf9\u5e94\u4e0d\u540c\u7684\u6ce8\u610f\u529b\u5934\u3002</p> </li> <li> <p>y \u8f74\u5bf9\u5e94\u4e0d\u540c\u7684\u67e5\u8be2\u6807\u8bb0\uff08\u5e8f\u5217\uff09\u3002</p> </li> </ul> <p>\u672c\u8d28\u4e0a\uff0c\u7f51\u683c\u662f\u5355\u6b21\u524d\u5411\u4f20\u9012\u4e2d\u6ce8\u610f\u529b\u5c42\u7684\u6574\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#thread-block","title":"Thread Block","text":"<ul> <li> <p>\u5355\u4e2a\u7ebf\u7a0b\u5757\u6709\u4e00\u4e2a\u975e\u5e38\u5177\u4f53\u4e14\u72ec\u7acb\u7684\u4efb\u52a1\uff1a\u8ba1\u7b97\u5355\u4e2a token \u548c\u5355\u4e2a head \u7684\u5b8c\u6574\u6ce8\u610f\u529b\u8f93\u51fa\u3002</p> </li> <li> <p>\u56e0\u4e3a\u5757\u662f\u72ec\u7acb\u7684\uff0cGPU \u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u786c\u4ef6\u5355\u5143\u4e0a\u540c\u65f6\u8ba1\u7b97\uff08Query 0\uff0cHead 0\uff09\u3001\uff08Query 1\uff0cHead 0\uff09\u548c\uff08Query 0\uff0cHead 1\uff09\u7684\u6ce8\u610f\u529b\uff0c\u8fd9\u662f\u5e76\u884c\u5316\u7684\u4e3b\u8981\u6765\u6e90\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#warp","title":"Warp","text":"<p>\u5728\u4e00\u4e2a\u5355\u72ec\u7684\u5757\u4e2d\uff0c\u4f60\u4ecd\u7136\u6709\u5f88\u591a\u5de5\u4f5c\u8981\u505a\uff1a\u5355\u4e2a token \u9700\u8981\u4e0e\u6574\u4e2a\u4e0a\u4e0b\u6587\uff08\u6240\u6709 KV cache\uff09\u8fdb\u884c\u6bd4\u8f83\u3002\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u88ab\u5206\u6210\u66f4\u5c0f\u7684\u5757\u3002\u8fd9\u4e2a \u201cWarp-Stride Loop\u201d \u4ee5\u8f6e\u8be2\u7684\u65b9\u5f0f\u5c06\u4e0a\u4e0b\u6587\u5757\u5206\u914d\u7ed9 Warp\u3002</p> <ul> <li>Warp 0 \u5904\u7406 KV \u5757 0\u3001N\u30012N...</li> <li>Warp 1 \u5904\u7406 KV \u5757 1\u3001N+1\u30012N+1..</li> </ul> C++<pre><code>for (int block_idx = start_block_idx + warp_idx; ...; block_idx += NUM_WARPS) {\n  // \u5904\u7406 block_idx \u6307\u5b9a\u7684 KV \u5757\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#thread-group","title":"Thread Group","text":"<p>vLLM \u4e2d\u7684\u903b\u8f91\u6982\u5ff5\uff1a\u5c0f\u578b\u3001\u81ea\u5b9a\u4e49\u5927\u5c0f\u7684\u7ebf\u7a0b\u96c6\u5408\uff0c\u901a\u5e38\u662f\u4e00\u4e2a Warp \u7684\u5b50\u96c6\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u5305\u542b 32 \u4e2a\u7ebf\u7a0b\u7684 Warp \u53ef\u4ee5\u903b\u8f91\u4e0a\u5206\u4e3a 8 \u4e2a\u6bcf\u4e2a 4 \u7ebf\u7a0b\u7684 thread_group \u3002</p> <ul> <li>thread_group \u662f\u4e3a\u975e\u5e38\u7ec6\u7c92\u5ea6\u7684\u4efb\u52a1\u521b\u5efa\u7684\uff0c\u4e3b\u8981\u662f\u534f\u4f5c\u8bb0\u5fc6\u52a0\u8f7d\u548c\u8ba1\u7b97\u3002</li> <li>\u5728 QK \u90e8\u5206\uff0c\u4e00\u4e2a thread_group \u7684\u804c\u8d23\u662f\u4e0e\u7ec4\u5185\u5176\u4ed6\u7ebf\u7a0b\u534f\u4f5c\u52a0\u8f7d\u4e00\u5c0f\u90e8\u5206 Key \u5411\u91cf\u4ee5\u53ca\u4ece global memory \u4e2d\u534f\u4f5c\u53d6\u51fa q_ptr \u6307\u5411\u7684 query \u5411\u91cf\uff0c\u5e76\u8ba1\u7b97\u5b83\u4e0e Query \u5411\u91cf\u76f8\u5e94\u90e8\u5206\u7684\u70b9\u79ef\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#attention-kernel","title":"Attention Kernel","text":"","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#process","title":"Process","text":"<ol> <li> <p>Query \u6570\u636e\u5411\u91cf\u5316\u4ece global memory \u52a0\u8f7d\u5230 shared memory(\u53ea\u5904\u7406\u4e00\u4e2a query)</p> </li> <li> <p>\u6309\u7167 context \u7684 block \u6570\u91cf\u8fed\u4ee3</p> </li> </ol> <ul> <li>Key \u6570\u636e\u5411\u91cf\u5316\u4ece global memory \u52a0\u8f7d\u5230 register<ul> <li>\u4e00\u4e2a warp \u5185\u7684 thread_group \u534f\u4f5c\u52a0\u8f7d\u4e00\u4e2a page \u7684 key cache \u5230 register</li> <li>\u5047\u8bbe\u6bcf\u4e2a block \u6709 128 \u4e2a Key token\uff0c\u6bcf\u4e2a warp \u6709 32 \u4e2a\u7ebf\u7a0b\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u7ec4\uff08\u4f8b\u5982 4 \u7ebf\u7a0b\uff09\u8d1f\u8d23 8 \u4e2a token\uff0c\u6240\u4ee5\u4e00\u4e2a warp \u4e00\u8f6e\u53ea\u80fd\u5904\u7406 64 \u4e2a token\uff0c\u4e3a\u4e86\u8986\u76d6\u5b8c\u6574\u7684 block\uff08128 token\uff09\uff0c\u5c31\u8981\u5faa\u73af 2 \u6b21</li> <li>\u5728\u6bcf\u6b21\u5faa\u73af\u4e2d\uff0c\u901a\u8fc7 <code>(thread_group_idx + i * WARP_SIZE) % BLOCK_SIZE</code> \u8ba1\u7b97\u51fa\u672c\u8f6e\u8981\u5904\u7406\u7684 token \u5728 block \u5185\u7684\u504f\u79fb\u4f4d\u7f6e\u3002</li> </ul> </li> <li>\u8ba1\u7b97 QK \u70b9\u79ef\uff0c\u6bcf\u4e2a thread_group \u7684 0 \u53f7\u7ebf\u7a0b\u8ba1\u7b97\u6700\u5927\u7684 qk \u5e76\u5b58\u5165 logits \u6570\u7ec4(shared memory)</li> </ul> <ol> <li>\u8ba1\u7b97 Softmax</li> </ol> <ul> <li>\u89c4\u7ea6 qk_max</li> <li>\u89c4\u7ea6 exp_sum</li> <li>\u5f52\u4e00\u5316 logits \u6570\u7ec4</li> </ul> <ol> <li>\u8ba1\u7b97 LV</li> </ol> <ul> <li>\u6309\u8f93\u51fa\u5411\u91cf\u7ef4\u5ea6\u5212\u5206\u6bcf\u4e2a\u7ebf\u7a0b\u8d1f\u8d23\u7684 v_vec</li> <li>\u8ba1\u7b97 logits_vec \u548c v_vec \u7684\u70b9\u79ef\u5e76\u7d2f\u52a0\u5230 accs \u6570\u7ec4</li> <li>\u89c4\u7ea6 accs \u6570\u7ec4</li> </ul> <ol> <li>\u8f93\u51fa\u7ed3\u679c\u5230 out_ptr</li> </ol> Python<pre><code># from q_ptr to q_vecs\nq_vecs = ...\nfor ... { # Iteration over Key cache block\n  for ... { # \u4e3a\u4e86\u8986\u76d6\u5b8c\u6574\u7684 block\uff08128 token\uff09\uff0c\u5c31\u8981\u5faa\u73af 2 \u6b21\n    k_ptr = ...\n    for ... { # Warp Thread Group load 128 bites of k_vecs\n        k_vecs[i] = ...\n    }\n    ...\n    float qk = scale * Qk_dot&lt;scalar_t, THREAD_GROUP_SIZE&gt;::dot(q_vecs[thread_group_offset], k_vecs);\n    if (thread_group_offset == 0) {\n      const bool mask = token_idx &gt;= context_len;\n      logits[token_idx - start_token_idx] = mask ? 0.f : qk;\n      qk_max = mask ? qk_max : fmaxf(qk_max, qk);\n    }\n  }\n}\n\n# qk_max reduction\nfor (int mask = WARP_SIZE / 2; mask &gt;= THREAD_GROUP_SIZE; mask /= 2) {\n    qk_max = fmaxf(qk_max, VLLM_SHFL_XOR_SYNC(qk_max, mask));\n}\n\nif (lane == 0) {\n    red_smem[warp_idx] = qk_max;\n}\n\nfor (int mask = NUM_WARPS / 2; mask &gt;= 1; mask /= 2) {\n    qk_max = fmaxf(qk_max, VLLM_SHFL_XOR_SYNC(qk_max, mask));\n}\nqk_max = VLLM_SHFL_SYNC(qk_max, 0);\n\n# exp_sum\nfor (int i = thread_idx; i &lt; num_tokens; i += NUM_THREADS) {\n    float val = __expf(logits[i] - qk_max);\n    logits[i] = val;\n    exp_sum += val;\n}\n# ...\nexp_sum = block_sum&lt;NUM_WARPS&gt;(&amp;red_smem[NUM_WARPS], exp_sum);\nconst float inv_sum = __fdividef(1.f, exp_sum + 1e-6f);\nfor (int i = thread_idx; i &lt; num_tokens; i += NUM_THREADS) {\n    logits[i] *= inv_sum;\n}\n\n# lv\nfloat accs[NUM_ROWS_PER_THREAD];\nfor ... { # Iteration over Value cache block\n    logits_vec = ...\n    for ... { # Warp Thread Group load k_vecs\n        v_vec = ...\n        ...\n        accs[i] += dot(logits_vec, v_vec);\n    }\n}\n\n# accs reduction\nfor (int i = 0; i &lt; NUM_ROWS_PER_THREAD; i++) {\n    float acc = accs[i];\n    for (int mask = NUM_V_VECS_PER_ROW / 2; mask &gt;= 1; mask /= 2) {\n        acc += VLLM_SHFL_XOR_SYNC(acc, mask);\n    }\n    accs[i] = acc;\n}\n\n# output\nscalar_t* out_ptr = out + seq_idx * num_heads * max_num_partitions * HEAD_SIZE\n                + head_idx * max_num_partitions * HEAD_SIZE\n                + partition_idx * HEAD_SIZE;\nfor (int i = 0; i &lt; NUM_ROWS_PER_THREAD; i++) {\n    const int row_idx = lane / NUM_V_VECS_PER_ROW + i * NUM_ROWS_PER_ITER;\n    if (row_idx &lt; HEAD_SIZE &amp;&amp; lane % NUM_V_VECS_PER_ROW == 0) {\n        from_float(*(out_ptr + row_idx), accs[i]);\n    }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#query","title":"Query \u6570\u636e\u7684\u52a0\u8f7d","text":"<p>\u8fd9\u4e2a\u9636\u6bb5\u7684\u76ee\u6807\u662f\u5c06\u90a3\u4e2a\u56fa\u5b9a\u4e0d\u53d8\u7684 Query \u5411\u91cf\u4ece\u7f13\u6162\u7684\u5168\u5c40\u5185\u5b58\u52a0\u8f7d\u5230\u5feb\u901f\u7684\u5171\u4eab\u5185\u5b58\u4e2d\uff0c\u8ba9\u53c2\u4e0e\u8ba1\u7b97\u7684\u6240\u6709\u7ebf\u7a0b\u90fd\u80fd\u9ad8\u6548\u5730\u8bbf\u95ee\u5b83\u3002</p> <ul> <li>\u5b9a\u4f4d Query \u6570\u636e\uff1a\u6bcf\u4e2a\u7ebf\u7a0b\u5757\u9996\u5148\u8ba1\u7b97\u51fa\u5b83\u8d1f\u8d23\u7684 Query Token \u5728\u5168\u5c40\u5185\u5b58\u4e2d\u7684\u5730\u5740\uff0c\u5373 q_ptr\u3002\u8fd9\u4e2a\u6307\u9488\u5728\u5f53\u524d\u7ebf\u7a0b\u5757\u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\u662f\u56fa\u5b9a\u7684\u3002</li> </ul> C++<pre><code>const scalar_t* q_ptr = q + seq_idx * q_stride + head_idx * HEAD_SIZE;\n</code></pre> <p></p> <ul> <li>\u534f\u4f5c\u52a0\u8f7d\u5230\u5171\u4eab\u5185\u5b58\uff1aThread Group \u5185\u7684\u6240\u6709\u7ebf\u7a0b\uff08\u4f8b\u5982 thread0, thread1 \u7b49\uff09\u4e00\u8d77\u5de5\u4f5c\uff0c\u5c06 q_ptr \u6307\u5411\u7684\u6570\u636e\uff08\u4e00\u4e2a\u5b8c\u6574\u7684 Query \u5411\u91cf\uff0c\u5982 128 \u4e2a\u5143\u7d20\uff09\u642c\u8fd0\u5230\u5171\u4eab\u5185\u5b58\u6570\u7ec4 q_vecs \u4e2d\u3002</li> </ul> C++<pre><code>__shared__ Q_vec q_vecs[THREAD_GROUP_SIZE][NUM_VECS_PER_THREAD];\n</code></pre> <p></p> <ul> <li>\u52a0\u8f7d\u65b9\u5f0f\uff1a\u91c7\u7528\u9ad8\u6548\u7684\u5185\u5b58\u5408\u5e76 Memory Coalescing\u6a21\u5f0f\u3002\u5982\u56fe\u6240\u793a\uff0cthread0 \u52a0\u8f7d vec0, vec2 \u7b49\u5076\u6570\u4f4d\u7684\u6570\u636e\u5757\uff0cthread1 \u52a0\u8f7d vec1, vec3 \u7b49\u5947\u6570\u4f4d\u7684\u6570\u636e\u5757\u3002\u7531\u4e8e vec0 \u548c vec1 \u5728\u7269\u7406\u5185\u5b58\u4e2d\u662f\u76f8\u90bb\u7684\uff0c\u76f8\u90bb\u7ebf\u7a0b\u8bbf\u95ee\u76f8\u90bb\u5185\u5b58\uff0c\u89e6\u53d1\u5408\u5e76\u8bfb\u53d6\uff0c\u6781\u5927\u63d0\u5347\u4e86\u52a0\u8f7d\u6548\u7387\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#key-qk","title":"Key \u6570\u636e\u7684\u8fed\u4ee3\u52a0\u8f7d\u4e0e QK \u70b9\u79ef\u8ba1\u7b97\uff08\u5faa\u73af\u64cd\u4f5c\uff09","text":"<p>\u73b0\u5728 Query \u6570\u636e\u5df2\u7ecf\u51c6\u5907\u5c31\u7eea\uff0c\u7ebf\u7a0b\u5757\u8fdb\u5165\u4e00\u4e2a\u4e3b\u5faa\u73af\uff08\u5373\u6587\u6863\u4e2d\u7684 outer loop\uff09\uff0c\u8fed\u4ee3\u904d\u5386\u6240\u6709\u9700\u8981\u8ba1\u7b97\u7684 Key Token\u3002</p> <ul> <li> <p>\u5916\u5c42\u5faa\u73af\u5904\u7406\u6240\u6709\u7684 Key cache block</p> </li> <li> <p>\u4e2d\u95f4\u5faa\u73af\u5904\u7406\u4e3a\u4e86\u8986\u76d6\u5b8c\u6574\u7684 block\uff08128 token\uff09\uff0c\u5c31\u8981\u5faa\u73af 2 \u6b21</p> </li> <li> <p>\u5185\u5c42\u5faa\u73af\u5904\u7406\u4e00\u4e2a thread_group \u8d1f\u8d23\u7684\u6240\u6709 token</p> </li> <li> <p>\u5bf9\u4e8e\u5faa\u73af warp \u8d1f\u8d23\u7684\u4e00\u7ec4 Key Token\uff1a</p> </li> <li> <p>\u5b9a\u4f4d Key \u6570\u636e\uff1a\u5728\u6bcf\u6b21\u5faa\u73af\u5f00\u59cb\u65f6\uff0c\u8ba1\u7b97\u6307\u5411\u5f53\u524d Key Token \u7684\u6307\u9488 k_ptr\u3002\u8fd9\u4e2a\u6307\u9488\u5728\u6bcf\u6b21\u8fed\u4ee3\u65f6\u90fd\u4f1a\u66f4\u65b0\uff0c\u6307\u5411\u4e0b\u4e00\u4e2a\u65b0\u7684 Key Token\u3002</p> </li> <li> <p>\u52a0\u8f7d Key \u6570\u636e\u5230\u5bc4\u5b58\u5668\uff1a\u4f7f\u7528\u5185\u5b58\u5408\u5e76\u6a21\u5f0f\uff0c\u4ece k_ptr \u6307\u5411\u7684\u5168\u5c40\u5185\u5b58\u4e2d\u8bfb\u53d6\u5f53\u524d Key Token \u7684\u5411\u91cf\u6570\u636e\u3002\u5173\u952e\u533a\u522b\uff1a\u8fd9\u6b21\uff0cKey \u6570\u636e\u88ab\u52a0\u8f7d\u5230\u6bcf\u4e2a\u7ebf\u7a0b\u79c1\u6709\u7684\u5bc4\u5b58\u5668 k_vecs \u4e2d\u3002</p> <p>\u4e3a\u4ec0\u4e48\u662f\u5bc4\u5b58\u5668\uff1f \u56e0\u4e3a\u5f53\u524d\u8fd9\u4e2a Key \u5411\u91cf\u53ea\u4f1a\u88ab\u7528\u4e8e\u548c Query \u5411\u91cf\u505a\u4e00\u6b21\u70b9\u79ef\u8fd0\u7b97\u3002\u8ba1\u7b97\u5b8c\u6210\u540e\uff0c\u5728\u4e0b\u4e00\u6b21\u5faa\u73af\u4e2d\u5b83\u5c31\u4f1a\u88ab\u65b0\u7684 Key \u5411\u91cf\u8986\u76d6\u6389\u3002\u56e0\u6b64\uff0c\u4f7f\u7528\u6700\u5feb\u4f46\u79c1\u6709\u7684\u5bc4\u5b58\u5668\u662f\u6700\u9ad8\u6548\u7684\u9009\u62e9\u3002</p> </li> </ul> <p></p> C++<pre><code>const scalar_t* k_ptr = k_cache + physical_block_number * kv_block_stride\n                    + kv_head_idx * kv_head_stride\n                    + physical_block_offset * x;\n# x \u662f\u6bcf\u4e2a\u7ebf\u7a0b\u7ec4\u4e00\u6b21\u52a0\u8f7d\u7684\u5143\u7d20\u6570\u91cf\nK_vec k_vecs[NUM_VECS_PER_THREAD];\n</code></pre> <ul> <li>\u6267\u884c QK \u70b9\u79ef\u8fd0\u7b97\uff1a\u5982\u679c HEADSIZE \u7684\u503c\u4e3a 128 \u4e14 THREAD_GROUP_SIZE \u7684\u503c\u4e3a 2\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u7684 k_vecs \u5c06\u5305\u542b\u603b\u5171 64 \u4e2a\u5143\u7d20\u3002\u7136\u800c\uff0c\u8fd4\u56de\u7684 qk \u5b9e\u9645\u4e0a\u662f 128 \u4e2a\u67e5\u8be2\u5143\u7d20\u548c 128 \u4e2a\u952e\u5143\u7d20\u4e4b\u95f4\u7684\u70b9\u79ef\u4e58\u6cd5\u7684\u7ed3\u679c(\u4f7f\u7528 qk_dot \u51fd\u6570)\u3002</li> </ul> C++<pre><code>template &lt;int THREAD_GROUP_SIZE, typename Vec, int N&gt;\ninline __device__ float qk_dot_(const Vec (&amp;q)[N], const Vec (&amp;k)[N]) {\n  using A_vec = typename FloatVec&lt;Vec&gt;::Type;\n  // Compute the parallel products for Q*K^T (treat vector lanes separately).\n  A_vec qk_vec = mul&lt;A_vec, Vec, Vec&gt;(q[0], k[0]);\n  // \u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u8ba1\u7b97\u4e86\u4e00\u4e2a\u90e8\u5206\u548c\u5411\u91cf\u3002\n#pragma unroll\n  for (int ii = 1; ii &lt; N; ++ii) {\n    qk_vec = vllm::fma(q[ii], k[ii], qk_vec);\n  }\n\n  // Finalize the reduction across lanes.\n  float qk = sum(qk_vec);\n#pragma unroll\n  for (int mask = THREAD_GROUP_SIZE / 2; mask &gt;= 1; mask /= 2) {\n    qk += VLLM_SHFL_XOR_SYNC(qk, mask);\n  }\n  return qk;\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#softmax","title":"Softmax","text":"","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#qk_max","title":"\u5c40\u90e8 qk_max","text":"<p>\u5728 QK \u70b9\u79ef\u8ba1\u7b97\u7684\u4e3b\u5faa\u73af\u4e2d\uff0c\u6bcf\u5f53\u4e00\u4e2a\u7ebf\u7a0b\u7ec4\u8ba1\u7b97\u51fa\u4e00\u4e2a\u65b0\u7684 qk \u503c\u540e\uff0c\u5b83\u4f1a\u7acb\u5373\u505a\u4e24\u4ef6\u4e8b\uff1a</p> <ul> <li>\u6682\u5b58 qk \u503c\uff1a\u5c06\u8ba1\u7b97\u51fa\u7684 qk \u503c\u5b58\u5165\u4e00\u4e2a\u4f4d\u4e8eShared Memory\u7684 logits \u6570\u7ec4\u4e2d\u3002\u5171\u4eab\u5185\u5b58\u7684\u8bbf\u95ee\u901f\u5ea6\u8fdc\u5feb\u4e8e\u5168\u5c40\u5185\u5b58\u3002logits \u6570\u7ec4\u7684\u5927\u5c0f\u7b49\u4e8e\u4e0a\u4e0b\u6587\u4ee4\u724c\u7684\u6570\u91cf\uff0c\u7528\u4e8e\u5b58\u653e\u6240\u6709\u7684 qk \u503c\uff0c\u4f9b\u540e\u7eed\u8ba1\u7b97\u4f7f\u7528\u3002 </li> </ul> C++<pre><code>// thread_group_offset == 0 \u786e\u4fdd\u53ea\u6709\u6bcf\u4e2a\u7ec4\u7684\u7b2c\u4e00\u4e2a\u7ebf\u7a0b\u53bb\u5199\u5171\u4eab\u5185\u5b58\uff0c\u907f\u514d\u7ade\u4e89\nlogits[token_idx - start_token_idx] = mask ? 0.f : qk;\n</code></pre> <ul> <li>\u66f4\u65b0\u5c40\u90e8\u6700\u5927\u503c\uff1a\u6bcf\u4e2a\u7ebf\u7a0b\uff08\u6216\u7ebf\u7a0b\u7ec4\uff09\u7ef4\u62a4\u4e00\u4e2a\u79c1\u6709\u5bc4\u5b58\u5668\u4e2d\u7684 qk_max \u53d8\u91cf\uff0c\u5e76\u7528\u65b0\u8ba1\u7b97\u51fa\u7684 qk \u503c\u6765\u66f4\u65b0\u5b83\u3002</li> </ul> C++<pre><code>qk_max = mask ? qk_max : fmaxf(qk_max, qk);\n</code></pre> <ul> <li>\u6b64\u65f6\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u7684 qk_max \u53ea\u8bb0\u5f55\u4e86\u5b83\u81ea\u5df1\u5904\u7406\u8fc7\u7684 qk \u503c\u4e2d\u7684\u6700\u5927\u503c\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#qk_max-reduction","title":"\u5168\u5c40 qk_max \u89c4\u7ea6 (Reduction)","text":"<ul> <li>\u6211\u4eec\u7684\u76ee\u6807\u662f\u627e\u5230\u6574\u4e2a Thread Block\u4e2d\u6240\u6709 qk \u503c\u7684\u5168\u5c40\u6700\u5927\u503c\u3002\u8fd9\u662f\u4e00\u4e2a\u5178\u578b\u7684\u5e76\u884c\u89c4\u7ea6\u64cd\u4f5c\uff0c\u5206\u5c42\u8fdb\u884c\u4ee5\u4fdd\u8bc1\u6548\u7387\u3002</li> </ul> <ol> <li>Warp \u5185\u89c4\u7ea6\uff08Intra-Warp Reduction\uff09</li> </ol> C++<pre><code>for (int mask = WARP_SIZE / 2; mask &gt;= THREAD_GROUP_SIZE; mask /= 2) {\nqk_max = fmaxf(qk_max, VLLM_SHFL_XOR_SYNC(qk_max, mask));\n}\n</code></pre> <ul> <li>VLLM_SHFL_XOR_SYNC\uff1a\u8fd9\u662f\u4e00\u4e2a Warp Shuffle \u6307\u4ee4\u3002\u5b83\u5141\u8bb8\u4e00\u4e2a Warp \u5185\u7684\u7ebf\u7a0b\u4e4b\u95f4\u76f4\u63a5\u4ea4\u6362\u5bc4\u5b58\u5668\u4e2d\u7684\u6570\u636e\uff0c\u65e0\u9700\u901a\u8fc7\u5171\u4eab\u5185\u5b58\uff0c\u901f\u5ea6\u6781\u5feb\u3002</li> </ul> <ol> <li>Warp \u95f4\u89c4\u7ea6 (Inter-Warp Reduction)</li> </ol> C++<pre><code>if (lane == 0) { // lane \u662f\u7ebf\u7a0b\u5728 warp \u5185\u7684 ID\n  red_smem[warp_idx] = qk_max;\n}\n// ... \u540c\u6b65 ...\n// \u5728\u4e00\u4e2a warp \u5185\u518d\u6b21\u8fdb\u884c\u7c7b\u4f3c\u7684 shuffle \u64cd\u4f5c\u6765\u89c4\u7ea6\u6240\u6709 warp \u7684\u6700\u5927\u503c\nfor (int mask = NUM_WARPS / 2; mask &gt;= 1; mask /= 2) {\n  qk_max = fmaxf(qk_max, VLLM_SHFL_XOR_SYNC(qk_max, mask));\n}\n</code></pre> <ul> <li>\u6bcf\u4e2a Warp \u7684\u201c\u9886\u5934\u7ebf\u7a0b\u201d\uff08lane == 0\uff09\u5c06\u5b83\u5f97\u5230\u7684 Warp \u5185\u6700\u5927\u503c\u5199\u5165\u5171\u4eab\u5185\u5b58 red_smem \u4e2d\u3002</li> <li>\u7136\u540e\uff0c\u901a\u5e38\u7531\u7b2c\u4e00\u4e2a Warp \u8d1f\u8d23\u8bfb\u53d6 red_smem \u4e2d\u7684\u6240\u6709 Warp \u6700\u5927\u503c\uff0c\u5e76\u518d\u6b21\u8fdb\u884c\u4e00\u6b21\u89c4\u7ea6\uff0c\u4ece\u800c\u5f97\u5230\u6574\u4e2a\u7ebf\u7a0b\u5757\u7684\u5168\u5c40 qk_max\u3002</li> </ul> <ol> <li>\u5e7f\u64ad\u5168\u5c40 qk_max\uff1a</li> </ol> C++<pre><code>qk_max = VLLM_SHFL_SYNC(qk_max, 0);\n</code></pre> <ul> <li>\u6b64\u65f6\uff0c\u5168\u5c40 qk_max \u53ef\u80fd\u53ea\u5b58\u5728\u4e8e\u7ebf\u7a0b\u5757\u7684\u7b2c\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u3002\u8fd9\u6761\u6307\u4ee4\u5c06\u7b2c\u4e00\u4e2a\u7ebf\u7a0b\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u5e7f\u64ad\u7ed9\u5b83\u6240\u5728 Warp \u7684\u6240\u6709\u5176\u4ed6\u7ebf\u7a0b\u3002\u901a\u8fc7\u7c7b\u4f3c\u7684\u65b9\u5f0f\uff0c\u6700\u7ec8\u786e\u4fdd\u7ebf\u7a0b\u5757\u4e2d\u7684\u6bcf\u4e00\u4e2a\u7ebf\u7a0b\u90fd\u62e5\u6709\u4e86\u6b63\u786e\u7684\u5168\u5c40 qk_max \u503c\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#exp_sum","title":"\u8ba1\u7b97 exp_sum \u5e76\u5b8c\u6210\u5f52\u4e00\u5316","text":"<p>\u73b0\u5728\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u77e5\u9053\u4e86\u5168\u5c40\u7684 qk_max\uff0c\u53ef\u4ee5\u5f00\u59cb\u8ba1\u7b97 Softmax \u7684\u5206\u5b50\u548c\u5206\u6bcd\u4e86\u3002\u8ba1\u7b97\u5206\u5b50\u5e76\u6c42\u5c40\u90e8\u548c\uff1a</p> C++<pre><code>for (int i = thread_idx; i &lt; num_tokens; i += NUM_THREADS) {\n  float val = \\_\\_expf(logits[i] - qk_max); // \u8ba1\u7b97 e^(qk - qk_max)\n  logits[i] = val; // \u5c06\u7ed3\u679c\u5199\u56de\u5171\u4eab\u5185\u5b58\uff0c\u8986\u76d6\u539f qk \u503c\n  exp_sum += val; // \u7d2f\u52a0\u5230\u7ebf\u7a0b\u79c1\u6709\u7684 exp_sum \u4e2d\n}\n</code></pre> <ul> <li> <p>\u8fd9\u662f\u4e00\u4e2a Grid-Stride Loop\uff0c\u8ba9\u6709\u9650\u7684\u7ebf\u7a0b\u5904\u7406\u6240\u6709 num_tokens \u4e2a\u6570\u636e\u3002</p> </li> <li> <p>\u6bcf\u4e2a\u7ebf\u7a0b\u4ece\u5171\u4eab\u5185\u5b58 logits \u4e2d\u8bfb\u53d6 qk \u503c\uff0c\u51cf\u53bb\u5168\u5c40 qk_max\uff0c\u8ba1\u7b97 exp()\uff0c\u7136\u540e\u5c06\u7ed3\u679c\u5199\u56de logits \u6570\u7ec4\u3002\u6b64\u65f6 logits \u5b58\u50a8\u7684\u662f Softmax \u7684\u5206\u5b50\u3002</p> </li> <li> <p>\u540c\u65f6\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u5c06\u81ea\u5df1\u8ba1\u7b97\u51fa\u7684\u6240\u6709 val \u7d2f\u52a0\u5230\u79c1\u6709\u7684 exp_sum \u53d8\u91cf\u4e2d\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#exp_sum_1","title":"\u5168\u5c40 exp_sum \u89c4\u7ea6","text":"C++<pre><code>exp_sum = block_sum&lt;NUM_WARPS&gt;(&amp;red_smem[NUM_WARPS], exp_sum);\n</code></pre> <ul> <li>\u901a\u8fc7 Warp \u5185\u548c Warp \u95f4\u7684\u4e24\u7ea7\u89c4\u7ea6\uff0c\u6700\u7ec8\u5f97\u5230\u6240\u6709\u5206\u5b50\u4e4b\u548c\uff0c\u5373 Softmax \u7684\u5206\u6bcd exp_sum\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#_1","title":"\u6700\u7ec8\u5f52\u4e00\u5316","text":"C++<pre><code>const float inv_sum = \\_\\_fdividef(1.f, exp_sum + 1e-6f);\nfor (int i = thread_idx; i &lt; num_tokens; i += NUM_THREADS) {\n  logits[i] \\*= inv_sum;\n}\n</code></pre> <ul> <li> <p>\u4e3a\u4e86\u907f\u514d\u5f00\u9500\u8f83\u5927\u7684\u9664\u6cd5\u8fd0\u7b97\uff0c\u4ee3\u7801\u5148\u8ba1\u7b97\u4e86\u5206\u6bcd\u7684\u5012\u6570 inv_sum\u3002</p> </li> <li> <p>\u518d\u6b21\u4f7f\u7528 Grid-Stride Loop\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u5c06\u5171\u4eab\u5185\u5b58 logits \u4e2d\u5b58\u50a8\u7684\u5206\u5b50\u4e58\u4ee5\u8fd9\u4e2a\u5012\u6570\u3002</p> </li> <li> <p>\u5faa\u73af\u7ed3\u675f\u540e\uff0c\u5171\u4eab\u5185\u5b58 logits \u6570\u7ec4\u4e2d\u5b58\u50a8\u7684\u5c31\u662f\u6700\u7ec8\u5f52\u4e00\u5316\u540e\u7684 Softmax \u6ce8\u610f\u529b\u6743\u91cd\u3002\u8fd9\u4e9b\u6743\u91cd\u5c06\u5728\u4e0b\u4e00\u6b65\u4e2d\u7528\u4e8e\u4e0e\u503c\uff08Value\uff09\u6570\u636e\u8fdb\u884c\u70b9\u4e58\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#lv","title":"LV \u8ba1\u7b97","text":"","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#value","title":"Value","text":"C++<pre><code>// \u6bcf\u884cv_vecs\u7684\u6570\u91cf\nconstexpr int NUM_V_VECS_PER_ROW = BLOCK_SIZE / V_VEC_SIZE;\n// Warp \u5728\u5355\u6b21\u904d\u5386\u4e2d\u53ef\u4ee5\u540c\u65f6\u5904\u7406\u591a\u5c11\u884c\nconstexpr int NUM_ROWS_PER_ITER = WARP_SIZE / NUM_V_VECS_PER_ROW;\n// \u6bcf\u4e2a\u7ebf\u7a0b\u8d1f\u8d23\u7684\u884c\u6570\nconstexpr int NUM_ROWS_PER_THREAD =\n      DIVIDE_ROUND_UP(HEAD_SIZE, NUM_ROWS_PER_ITER);\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#_2","title":"\u8ba1\u7b97\u6838\u5fc3","text":"C++<pre><code>float accs[NUM_ROWS_PER_THREAD]; // \u6bcf\u4e2a\u7ebf\u7a0b\u79c1\u6709\u7684\u7d2f\u52a0\u5668\u6570\u7ec4\n\nfor ... { // \u5916\u5c42\u5faa\u73af (Outer loop): \u904d\u5386\u6240\u6709Token\u5757\n    logits_vec = ... // 1. \u52a0\u8f7d\u4e00\u6279Token\u7684\u6ce8\u610f\u529b\u6743\u91cd\n\n    for ... { // \u5185\u5c42\u5faa\u73af (Inner loop): \u904d\u5386\u8be5\u7ebf\u7a0b\u8d1f\u8d23\u7684\u8f93\u51fa\u7ef4\u5ea6\n        v_vec = ... // 2. \u52a0\u8f7d\u8fd9\u4e9bToken\u5728\u5f53\u524d\u7ef4\u5ea6\u4e0a\u7684Value\u503c\n\n        // 3. \u8ba1\u7b97\u70b9\u79ef\u5e76\u7d2f\u52a0\n        accs[i] += dot(logits_vec, v_vec);\n    }\n}\n</code></pre> <ul> <li> <p>\u5916\u5c42\u5faa\u73af (Outer Loop): \u8fd9\u4e2a\u5faa\u73af\u904d\u5386\u6240\u6709\u4e0a\u4e0b\u6587 Token\u3002\u4e3a\u4e86\u9ad8\u6548\u5904\u7406\uff0cToken \u88ab\u5206\u6210\u5927\u5c0f\u4e3a BLOCK_SIZE \u7684\u5757\u3002\u5728\u6bcf\u6b21\u5faa\u73af\u4e2d\uff0c\u7a0b\u5e8f\u4f1a\u5904\u7406\u4e00\u4e2a\u65b0\u7684 Token \u5757\u3002logits_vec \u4e5f\u4f1a\u76f8\u5e94\u5730\u79fb\u52a8\uff0c\u4ee5\u52a0\u8f7d\u5f53\u524d Token \u5757\u5bf9\u5e94\u7684\u6ce8\u610f\u529b\u6743\u91cd\u3002</p> </li> <li> <p>\u5185\u5c42\u5faa\u73af (Inner Loop): \u8fd9\u4e2a\u5faa\u73af\u904d\u5386\u5f53\u524d\u7ebf\u7a0b\u8d1f\u8d23\u7684\u8f93\u51fa\u7ef4\u5ea6\uff08\u7531 NUM_ROWS_PER_THREAD \u51b3\u5b9a\uff09\u3002</p> </li> <li> <p>\u5728 iter0 \u4e2d\uff0cthread0 \u5904\u7406\u7b2c 0 \u4e2a\u7ef4\u5ea6\u3002\u5b83\u4f1a\u52a0\u8f7d v_vec0\uff0c\u8fd9\u4e2a\u5411\u91cf\u5305\u542b\u4e86\u5f53\u524d logits_vec \u5bf9\u5e94\u7684\u6240\u6709 Token \u5728\u7b2c 0 \u4e2a\u7ef4\u5ea6\u4e0a\u7684\u503c\u3002</p> </li> <li> <p>\u5728 iter1 \u4e2d\uff0cthread0 \u5904\u7406\u7b2c 32 \u4e2a\u7ef4\u5ea6\u3002\u5b83\u4f1a\u52a0\u8f7d v_vec32\uff0c\u8fd9\u4e2a\u5411\u91cf\u5305\u542b\u4e86\u540c\u4e00\u6279 Token \u5728\u7b2c 32 \u4e2a\u7ef4\u5ea6\u4e0a\u7684\u503c\u3002</p> </li> <li> <p>\u70b9\u79ef\u8fd0\u7b97 dot(logits_vec, v_vec): \u8fd9\u662f\u8ba1\u7b97\u7684\u5173\u952e\u3002</p> </li> <li> <p>logits_vec: [w_0,w_1,...,w_7] (8 \u4e2a Token \u7684\u6743\u91cd)</p> </li> <li> <p>v_vec: [v_0,d,v_1,d,...,v_7,d] (\u8fd9 8 \u4e2a Token \u5728\u7ef4\u5ea6 d \u4e0a\u7684\u503c)</p> </li> <li> <p>\u7d2f\u52a0 accs[i] += ...: \u70b9\u79ef\u7684\u7ed3\u679c\u88ab\u7d2f\u52a0\u5230 accs \u6570\u7ec4\u4e2d\u5bf9\u5e94\u7684\u4f4d\u7f6e\u3002\u5916\u5c42\u5faa\u73af\u7ed3\u675f\u540e\uff0caccs[i] \u5c31\u5305\u542b\u4e86\u8f93\u51fa\u5411\u91cf\u5728\u7b2c i \u4e2a\u7ef4\u5ea6\u4e0a\u7531\u6240\u6709\u4e0a\u4e0b\u6587 Token \u8d21\u732e\u7684\u603b\u548c\u3002</p> </li> </ul> <p>\u4f46\u662f\uff0c\u8bf7\u6ce8\u610f\uff0c\u6b64\u65f6\u7684 accs \u53ea\u662f\u4e00\u4e2a\u90e8\u5206\u548c\u3002\u56e0\u4e3a\u4e00\u4e2a Warp \u5185\u7684\u591a\u4e2a\u7ebf\u7a0b\uff08\u4f8b\u5982 thread0, thread1...\uff09\u53ef\u80fd\u5171\u540c\u5904\u7406\u4e00\u4e2a logits_vec \u5bf9\u5e94\u7684\u66f4\u5927\u8303\u56f4\u7684 Token\u3002\u4f8b\u5982\uff0cthread0 \u5904\u7406 Token 0-7\uff0cthread1 \u5904\u7406 Token 8-15\u3002\u5b83\u4eec\u8ba1\u7b97\u7684\u70b9\u79ef\u7ed3\u679c\u90fd\u9700\u8981\u88ab\u52a0\u8d77\u6765\uff0c\u624d\u80fd\u5f97\u5230\u5b8c\u6574\u7684\u7ef4\u5ea6\u503c\u3002\u8fd9\u5c31\u5f15\u51fa\u4e86\u4e0b\u4e00\u6b65\uff1a\u89c4\u7ea6\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#reduction","title":"\u89c4\u7ea6 (Reduction)","text":"<ul> <li>Warp \u5185\u89c4\u7ea6 (Intra-Warp Reduction)\uff1a</li> <li>Warp \u95f4\u89c4\u7ea6 (Inter-Warp Reduction)</li> </ul> Python<pre><code>for (int i = 0; i &lt; NUM_ROWS_PER_THREAD; i++) {\n    float acc = accs[i];\n    for (int mask = NUM_V_VECS_PER_ROW / 2; mask &gt;= 1; mask /= 2) {\n        acc += VLLM_SHFL_XOR_SYNC(acc, mask);\n    }\n    accs[i] = acc;\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/PageAttention/#_3","title":"\u8f93\u51fa\u7ed3\u679c\u5230\u5168\u5c40\u5185\u5b58","text":"<ul> <li>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u5b9a\u4e49 out_ptr \u53d8\u91cf\uff0c\u8be5\u53d8\u91cf\u6307\u5411\u5206\u914d\u5e8f\u5217\u548c\u5206\u914d\u5934\u7684\u8d77\u59cb\u5730\u5740\u3002</li> <li>\u6211\u4eec\u9700\u8981\u8fed\u4ee3\u4e0d\u540c\u7684\u5206\u914d\u5934\u90e8\u4f4d\u7f6e\uff0c\u5e76\u6839\u636e out_ptr \u5199\u51fa\u76f8\u5e94\u7684\u7d2f\u79ef\u7ed3\u679c</li> </ul> C++<pre><code>scalar_t* out_ptr = out + seq_idx * num_heads * max_num_partitions * HEAD_SIZE\n                + head_idx * max_num_partitions * HEAD_SIZE\n                + partition_idx * HEAD_SIZE;\n\nfor (int i = 0; i &lt; NUM_ROWS_PER_THREAD; i++) {\n    const int row_idx = lane / NUM_V_VECS_PER_ROW + i * NUM_ROWS_PER_ITER;\n    if (row_idx &lt; HEAD_SIZE &amp;&amp; lane % NUM_V_VECS_PER_ROW == 0) {\n        from_float(*(out_ptr + row_idx), accs[i]);\n    }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/","title":"SGLang Scheduler \u6280\u672f\u53d8\u8fc1","text":"2025-10-282025-12-13 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#sglang-scheduler","title":"SGLang Scheduler \u6280\u672f\u53d8\u8fc1","text":"<p> \u7ea6 4854 \u4e2a\u5b57  272 \u884c\u4ee3\u7801  10 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 28 \u5206\u949f</p> <ul> <li>\u6700\u5f00\u59cb\u7684 Scheduler \u4e2d CPU \u548c GPU \u662f\u4e32\u884c\u7684\uff0c\u5bfc\u81f4 GPU \u7684\u5927\u91cf\u7a7a\u95f2</li> <li>\u540e\u9762\u7684 Scheduler \u5141\u8bb8 CPU \u548c GPU overlap\uff0c\u5b9e\u73b0\u4e86 zero overhead scheduler</li> </ul> <p>Scheduler \u6574\u4f53\u7684\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a[^code-walk]</p> <p></p> <p>\u6211\u4eec\u5c06\u7ed3\u5408\u4ee3\u7801\u5206\u6790\u4e00\u4e0b\u6574\u4e2a Scheduler \u7684\u6d41\u7a0b\u3002\u4f46\u5728\u5206\u6790\u6574\u4e2a\u6d41\u7a0b\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u4e86\u89e3\u4e00\u4e0b\u8c03\u5ea6\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684\u6570\u636e\u7ed3\u6784\u4ee5\u53ca\u8fd9\u4e9b\u7ed3\u6784\u4e4b\u95f4\u7684\u5173\u7cfb\u5982\u4f55\u8f6c\u6362</p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#key-structure","title":"Key Structure","text":"","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#scheduler","title":"Scheduler","text":"<p><code>Scheduler</code>\u00a0 \u7ec4\u4ef6\u8d1f\u8d23\u7ba1\u7406 Active Request\u3002\u4ee5\u4e0b\u6838\u5fc3\u5168\u5c40\u72b6\u6001\u7528\u4e8e\u5728 \u00a0<code>Scheduler</code>\u00a0 \u4e2d\u7ef4\u62a4\u8fd9\u4e9b Active Request\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#waiting_queue","title":"<code>waiting_queue</code>","text":"<ul> <li>\u7528\u9014\uff1a <code>waiting_queue</code>\u662f\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\uff0c\u8bbe\u8ba1\u7528\u4e8e\u5b58\u653e Active Request\u3002\u5b83\u6839\u636e\u4f18\u5148\u7ea7\uff08Request \u7684\u6700\u957f\u524d\u7f00\uff09\u6216\u53ef\u7528\u5185\u5b58\u52a8\u6001\u91cd\u65b0\u6392\u5e8f\u8fd9\u4e9b Request\uff0c\u4ee5\u4f18\u5316\u6279\u5904\u7406\u4efb\u52a1\u3002</li> <li>\u4e00\u4e9b\u989d\u5916\u8981\u70b9</li> <li>\u5165\u961f<ul> <li>\u65b0\u5230\u8fbe\u7684 Request\u3002</li> <li>\u4ece \u00a0<code>retract_decode</code>\u00a0 \u8fd4\u56de\u7684 Request\u3002</li> </ul> </li> <li>\u51fa\u961f\u00a0 \u5f53\u524d\u6709\u6700\u9ad8\u4f18\u5148\u7ea7\u7684 Request \u4ece\u961f\u5217\u4e2d\u51fa\u961f\u4ee5\u5f62\u6210 batch\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#new_batch","title":"<code>new_batch</code>","text":"<ul> <li>\u7528\u9014\uff1a\uff1a\u4e00\u6279\u51c6\u5907\u597d\u8fdb\u884c prefill/extend \u9636\u6bb5\u7684 Request\u3002</li> <li>\u4e00\u4e9b\u989d\u5916\u8981\u70b9</li> <li>\u5206\u5757\u9884\u586b\u5145\uff1a\u5982\u679c Request \u6240\u9700\u7684 token \u6570\u8d85\u8fc7\u53ef\u7528\u5185\u5b58\uff08<code>remaining_tokens</code>\uff09\uff0c\u53ef\u80fd\u4f1a\u88ab\u5206\u5757\u6210\u8f83\u5c0f\u7684\u90e8\u5206\u3002</li> <li><code>new_batch</code>\u00a0 \u4e2d\u7684 Request \u5c06\u7ecf\u5386 prefill/extend\u3002</li> <li>prefill/extend \u540e\uff0c<code>new_batch</code>\u00a0 \u5c06\u8fc7\u6e21\u5230 \u00a0\u5168\u5c40\u6279\u6b21\uff08Global Batch\uff09\uff0c\u7528\u4e8e\u4e0b\u4e00\u6b21\u8fed\u4ee3\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#running_batch","title":"<code>running_batch</code>","text":"<ul> <li>\u7528\u9014\uff1a\uff1a\u4e00\u6279\u51c6\u5907\u597d\u8fdb\u884c decode \u9636\u6bb5\u7684 Request\u3002</li> <li>\u521d\u59cb\u5316\u4e3a\u7a7a\u6279\u6b21\uff1a<code>ScheduleBatch(reqs=[], batch_is_full=False)</code></li> <li>\u53ef\u4ee5\u52a8\u6001\u6dfb\u52a0\u65b0\u5b8c\u6210 prefill \u7684\u8bf7\u6c42</li> <li>\u53ef\u4ee5\u79fb\u9664\u5df2\u5b8c\u6210\u7684\u8bf7\u6c42</li> <li>\u4e00\u4e9b\u989d\u5916\u8981\u70b9</li> <li>Retracted\uff1a\u5982\u679c decode \u671f\u95f4\u53ef\u7528\u5185\u5b58\u4e0d\u8db3\uff0c<code>Scheduler</code>\u53ef\u80fd\u4f1a\u901a\u8fc7 \u00a0<code>retract_decode</code>\u00a0 \u4ece \u00a0<code>running_batch</code>\u00a0 \u4e2d\u64a4\u56de\u67d0\u4e9b Request\uff0c\u5c06\u5176\u8fd4\u56de\u5230 \u00a0<code>waiting_queue</code>\u00a0 \u4ee5\u4f9b\u540e\u7eed\u5904\u7406\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#cur_batch","title":"<code>cur_batch</code>","text":"<ul> <li>\u7528\u9014\uff1a\uff1a<code>Scheduler</code>\u00a0 \u4e3b\u5faa\u73af\uff08<code>run_batch</code>\u00a0 \u51fd\u6570\uff09\u4e2d\u5f53\u524d\u6b63\u5728\u5904\u7406\u7684 Request \u6279\u6b21\u3002<code>prefill</code> \u4f18\u5148</li> <li>\u4e00\u4e9b\u989d\u5916\u8981\u70b9</li> <li><code>cur_batch</code>\u00a0 \u5728 \u00a0<code>event_loop_normal</code>\u00a0 \u4e2d\u5206\u914d\u3002</li> <li>\u5f62\u6210 \u00a0<code>cur_batch</code>\u00a0 \u7684\u903b\u8f91\u662f\uff1a<ul> <li>\u5982\u679c\u672c\u8f6e\u6709\u51c6\u5907\u597d prefill \u7684 Request\uff08<code>new_batch</code>\uff09\uff0c\u5219\u4f7f\u7528 \u00a0<code>new_batch</code>\u00a0 \u4f5c\u4e3a \u00a0<code>cur_batch</code>\u3002</li> <li>\u5426\u5219\uff0c<code>cur_batch</code>\u00a0 \u5c06\u5904\u7406\u51c6\u5907\u597d decode \u7684 Request\uff0c\u56e0\u6b64\u4f7f\u7528 \u00a0<code>running_batch</code>\u00a0 \u4f5c\u4e3a \u00a0<code>cur_batch</code>\u3002</li> </ul> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#batch","title":"\u4e09\u4e2a\u91cd\u8981\u7684 Batch","text":"","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overview","title":"Overview","text":"<ul> <li>ScheduleBatch \u7531 schedule.py::Scheduler \u7ba1\u7406\u3002\u5b83\u5305\u542b\u9ad8\u7ea7\u8c03\u5ea6\u6570\u636e\uff0c\u5927\u90e8\u5206\u6570\u636e\u4f4d\u4e8e CPU \u4e0a\u3002</li> <li>ModelWorkerBatch \u7531 tp_worker.py::TpModelWorker \u7ba1\u7406\u3002\u5b83\u662f ScheduleBatch \u7684\u5b50\u96c6\uff0c\u53ea\u5305\u542b\u4e0e GPU \u4e0a\u6a21\u578b forward \u76f8\u5173\u7684\u6570\u636e\uff0c\u5b83\u5c06\u4ece CPU scheduler \u8f6c\u6362\u5230 GPU model runner\u3002</li> <li>ForwardBatch \u7531 model_runner.py::ModelRunner \u7ba1\u7406\uff0c\u5b83\u5305\u542b\u4f4e\u7ea7 tensor \u6570\u636e</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#schedulebatch","title":"ScheduleBatch","text":"Python<pre><code>class ScheduleBatch:\n    reqs: List[Req]  # \u8bf7\u6c42\u5217\u8868\n    req_to_token_pool: ReqToTokenPool  # \u8bf7\u6c42\u5230token\u7684\u6620\u5c04\u6c60\n    token_to_kv_pool_allocator: BaseTokenToKVPoolAllocator  # KV\u7f13\u5b58\u5206\u914d\u5668\n    tree_cache: BasePrefixCache  # \u524d\u7f00\u7f13\u5b58\u6811\n    forward_mode: ForwardMode  # \u524d\u5411\u6a21\u5f0f\n\n    # \u6279\u5904\u7406\u76f8\u5173\n    input_ids: torch.Tensor  # \u8f93\u5165token IDs\n    seq_lens: torch.Tensor  # \u5e8f\u5217\u957f\u5ea6\n    extend_lens: List[int]  # \u6269\u5c55\u957f\u5ea6(sel_len - prefix_len)\n    prefix_lens: List[int]  # \u524d\u7f00\u957f\u5ea6\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#modelworkerbatch","title":"ModelWorkerBatch","text":"Python<pre><code>class ModelWorkerBatch:\n    forward_mode: ForwardMode\n    input_ids: torch.Tensor  # \u8f93\u5165token IDs\n    req_pool_indices: torch.Tensor  # req \u5bf9\u5e94\u7684 out_cache_loc \u7684\u7d22\u5f15\n    seq_lens: torch.Tensor  # \u5e8f\u5217\u957f\u5ea6\n    out_cache_loc: torch.Tensor  # \u5206\u914d\u7684 KV cache\n\n    # \u6269\u5c55\u76f8\u5173(seq - prefix)\n    extend_num_tokens: Optional[int]\n    extend_seq_lens: Optional[List[int]]\n    extend_prefix_lens: Optional[List[int]]\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#forwardbatch","title":"ForwardBatch","text":"Python<pre><code>class ForwardBatch:\n    forward_mode: ForwardMode\n    batch_size: int\n    input_ids: torch.Tensor\n    seq_lens: torch.Tensor\n    positions: torch.Tensor  # \u4f4d\u7f6e\u7f16\u7801\n\n    # \u6ce8\u610f\u529b\u76f8\u5173\n    attn_backend: AttentionBackend\n    token_to_kv_pool: KVCache\n\n    # \u6269\u5c55\u4fe1\u606f(seq - prefix)\n    extend_num_tokens: Optional[int]\n    extend_start_loc: Optional[torch.Tensor]\n    extend_prefix_lens: Optional[torch.Tensor]\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#transpose","title":"Transpose","text":"Python<pre><code># 1. Scheduler\u521b\u5efaScheduleBatch\ndef run_batch(self, batch: ScheduleBatch):\n    # 2. \u8f6c\u6362\u4e3aModelWorkerBatch\n    model_worker_batch = batch.get_model_worker_batch()\n\n\n# 3. TpModelWorker\u5904\u7406\ndef forward_batch_generation(self, model_worker_batch: ModelWorkerBatch):\n    # 4. \u8f6c\u6362\u4e3aForwardBatch\n    forward_batch = ForwardBatch.init_new(model_worker_batch, self.model_runner)\n\n    # 5. ModelRunner\u6267\u884c\u524d\u5411\u4f20\u64ad\n    logits_output, can_run_cuda_graph = self.model_runner.forward(forward_batch)\n\n    # 6. \u91c7\u6837\u751f\u6210token\n    next_token_ids = self.model_runner.sample(logits_output, forward_batch)\n\n    return GenerationBatchResult(\n        logits_output=logits_output,\n        next_token_ids=next_token_ids,\n        can_run_cuda_graph=can_run_cuda_graph,\n    )\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#cache","title":"Cache","text":"<p>cache \u5728 sglang \u4e2d\uff0c\u76f8\u5173\u7684\u4e3b\u8981\u662f``req_to_token_pool<code>,</code>token_to_kv_pool<code>,</code>tree_cache` \u4e09\u4e2a\u7ed3\u6784\u3002</p> Python<pre><code>req_to_token_pool[req_idx]:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u524d\u7f00\u90e8\u5206 (1984 tokens)    \u2502    \u65b0chunk\u90e8\u5206 (2000 tokens)    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 [loc_1, loc_2, ..., loc_1984] \u2502 [loc_1985, ..., loc_3984] \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u4f4d\u7f6e:  0                    1984                         3984\n\nKV Cache Pool:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502loc_1 \u2502loc_2 \u2502 ... \u2502loc_1984\u2502loc_1985\u2502 ... \u2502loc_3984\u2502 ... \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 k1,v1\u2502 k2,v2\u2502 ... \u2502k1984,v1984\u2502k1985,v1985\u2502 ... \u2502k3984,v3984\u2502 ... \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#reqtotokenpool","title":"ReqToTokenPool","text":"<ul> <li>\u7ba1\u7406 req_idx \u5230 token \u4f4d\u7f6e\u7684\u6620\u5c04\u5173\u7cfb</li> <li>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5206\u914d\u56fa\u5b9a\u7684\u5185\u5b58\u69fd\u4f4d</li> <li>\u7ef4\u62a4\u8bf7\u6c42\u7684 token \u5e8f\u5217\u5728\u5185\u5b58\u4e2d\u7684\u8fde\u7eed\u5e03\u5c40</li> </ul> Python<pre><code>class ReqToTokenPool:\n    def __init__(\n        self, size: int, max_context_len: int, device: str, enable_memory_saver: bool\n    ):\n        # \u4e3b\u8981\u5b58\u50a8\u7ed3\u6784\uff1a[\u8bf7\u6c42\u6570\u91cf, \u6700\u5927\u4e0a\u4e0b\u6587\u957f\u5ea6]\n        self.req_to_token = torch.zeros(\n            (size, max_context_len), dtype=torch.int32, device=device\n        )\n        self.free_slots = list(range(size))  # \u53ef\u7528\u69fd\u4f4d\u5217\u8868\n        self.size = size\n        self.max_context_len = max_context_len\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#token_to_kv_pool","title":"token_to_kv_pool","text":"<ul> <li>\u7ba1\u7406\u7269\u7406 KV \u7f13\u5b58\u7684\u5206\u914d\u548c\u91ca\u653e</li> <li>\u5904\u7406\u9875\u5bf9\u9f50\u7684\u5185\u5b58\u5206\u914d\uff08\u5982\u679c\u542f\u7528\u5206\u9875\uff09</li> <li>\u652f\u6301\u4e0d\u540c\u7684\u5206\u914d\u7b56\u7565\uff08\u8fde\u7eed\u5206\u914d\u3001\u5206\u9875\u5206\u914d\u7b49\uff09</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#tree-cache","title":"Tree Cache","text":"<p>\u5176\u5b9e\u662f\u8054\u7cfb\u4e24\u4e2a pool \u7684\u7ec4\u7ec7\u7ed3\u6784\uff0cscheduler \u8c03\u5ea6\u8fc7\u7a0b\u4e2d\u4f1a\u9891\u7e41\u8bbf\u95ee\uff0c\u5e76\u4e3a\u8bf7\u6c42\u5206\u914d <code>req_to_token_pool</code> \u548c <code>token_to_kv_pool</code> \u4e2d\u7684 slot</p> <ul> <li> <p>tree_cache \u5728\u8c03\u5ea6\u7b56\u7565\u4e2d\u662f\u4e2a\u5173\u952e\u89d2\u8272\uff0c\u6839\u636e prefix match \u7684\u60c5\u51b5\uff0c\u4f1a\u51b3\u5b9a\u5f53\u524d\u8bf7\u6c42\u4f55\u65f6\u88ab prefill</p> </li> <li> <p><code>page_size</code> \u51b3\u5b9a\u524d\u7f00\u5339\u914d\u7684\u7c92\u5ea6\uff0c\u952e\u5339\u914d\u7b56\u7565\u4ee5\u53ca\u5206\u9875\u5339\u914d\u7b97\u6cd5</p> </li> <li> <p>page_size = 1 \u662f\u9010 token \u7cbe\u786e\u5339\u914d\uff0c\u53ef\u4ee5\u5339\u914d\u4efb\u610f\u957f\u5ea6\u7684\u524d\u7f00</p> </li> <li>page_size &gt; 1 \u662f\u6309\u9875\u8fdb\u884c\u524d\u7f00\u5339\u914d\uff0c\u4f7f\u7528 tuple(tokens) \u4e3a key</li> </ul> Python<pre><code>   # page_size = 1\n   root\n   \u2514\u2500\u2500 1 (child_key=1)\n       \u2514\u2500\u2500 2 (child_key=2)\n           \u2514\u2500\u2500 3 (child_key=3)\n               \u2514\u2500\u2500 4 (child_key=4)\n                   \u2514\u2500\u2500 5 (child_key=5)\n\n # page_size = 4\n\n root\n \u2514\u2500\u2500 (1,2,3,4) (child_key=(1,2,3,4))\n \u2514\u2500\u2500 (5,6,7,8) (child_key=(5,6,7,8))\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#relationship","title":"RelationShip","text":"<p>\u4e00\u4e2a\u65b0\u8bf7\u6c42\u8fdb\u5165</p> <ul> <li>\u9996\u5148\u8fdb\u884c\u6700\u957f\u524d\u7f00\u5339\u914d\u627e\u5230\u5bf9\u5e94\u7684 KV \u7d22\u5f15</li> <li><code>req_to_token_pool</code> \u5206\u914d <code>extend_token</code> \u7684\u7a7a\u95f2\u69fd\u4f4d\uff0c\u5f97\u5230 <code>req_pool_idx</code> \u7d22\u5f15</li> <li><code>token_to_kv_pool_allocator</code> \u5206\u914d\u65b0\u7684 KV Cache</li> <li>\u66f4\u65b0 <code>req_pool_idx</code> \u4e0e KV Cache \u95f4\u7684\u6620\u5c04\u5173\u7cfb</li> <li>\u8ba1\u7b97\u5b8c\u6210\u540e\uff0c\u65b0\u7684\u952e\u503c\u7f13\u5b58\u901a\u8fc7 <code>cache_finished_req()</code> \u6216\u8005 <code>cache_unfinished_req()</code>\u88ab\u63d2\u5165\u56de\u6811\u7f13\u5b58\u4e2d</li> </ul> Python<pre><code># \u76f4\u63a5\u5206\u914d\u8fd9\u4e00\u4e2a batch \u6240\u6709 req \u7684 extend tokens \u9700\u8981\u7684 kv cache\nout_cache_loc = alloc_token_slots(batch.tree_cache, batch.extend_num_tokens)\n# update \u6620\u5c04(prefix + extend)\nreq_to_token_pool.write(\n    (req_idx, slice(0, prefix_len)),\n    prefix_tensors[i],\n)\nreq_to_token_pool.write(\n    (req_idx, slice(prefix_len, seq_len)),\n    out_cache_loc[pt : pt + extend_len],\n)\n</code></pre> <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#prefilladder","title":"PrefillAdder","text":"<p>\u662f SGLang Scheduler \u4e2d\u8d1f\u8d23\u667a\u80fd\u6279\u5904\u7406\u9884\u586b\u5145\u8bf7\u6c42\u7684\u6838\u5fc3\u7ec4\u4ef6\u3002\u5b83\u7684\u4e3b\u8981\u4f5c\u7528\u662f\u4ece\u7b49\u5f85\u961f\u5217\u4e2d\u9009\u62e9\u5408\u9002\u7684\u8bf7\u6c42\uff0c\u7ec4\u88c5\u6210\u4e00\u4e2a\u53ef\u4ee5\u9ad8\u6548\u6267\u884c\u7684\u9884\u586b\u5145\u6279\u6b21</p> Python<pre><code>class PrefillAdder:\n\u00a0 \u00a0 def __init__(self, ...):\n    \u00a0 \u00a0 self.page_size = page_size # \u5185\u5b58\u9875\u5927\u5c0f\n        self.tree_cache = tree_cache \u00a0# radix kv cache\n        self.token_to_kv_pool_allocator = token_to_kv_pool_allocator # kv cache pool\n        self.running_batch = running_batch # \u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684 decode batch\n        self.new_token_ratio = new_token_ratio # \u65b0 token \u751f\u6210\u6bd4\u4f8b\n\u00a0 \u00a0 \u00a0 \u00a0 self.can_run_list = [] \u00a0 \u00a0 \u00a0 \u00a0# \u53ef\u4ee5\u8fd0\u884c\u7684\u8bf7\u6c42\u5217\u8868\n\u00a0 \u00a0 \u00a0 \u00a0 self.preempt_list = [] \u00a0 \u00a0 \u00a0 \u00a0# \u88ab\u62a2\u5360\u7684\u8bf7\u6c42\u5217\u8868 \u00a0\n\u00a0 \u00a0 \u00a0 \u00a0 self.new_chunked_req = None \u00a0 # \u65b0\u7684\u5206\u5757\u8bf7\u6c42\n\u00a0 \u00a0 \u00a0 \u00a0 self.log_hit_tokens = 0 \u00a0 \u00a0 \u00a0 # \u7f13\u5b58\u547d\u4e2d\u7684token\u6570\n\u00a0 \u00a0 \u00a0 \u00a0 self.log_input_tokens = 0 \u00a0 \u00a0 # \u8f93\u5165token\u7edf\u8ba1\n\u00a0 \u00a0 \u00a0 \u00a0\n    @property\n    def rem_total_tokens(self):\n        \"\"\"\u8ba1\u7b97\u5269\u4f59\u53ef\u7528\u7684\u603btoken\u6570\"\"\"\n\n    def add_one_req(self, req: Req, has_chunked_req: bool, truncation_align_size: Optional[int]):\n        \"\"\"\u6dfb\u52a0\u4e00\u4e2a\u8bf7\u6c42\u5230\u6279\u6b21\u4e2d\"\"\"\n\n    def add_chunked_req(self, req: Req):\n    \u00a0 \u00a0 \"\"\"\u5904\u7406\u5206\u5757\u9884\u586b\u5145\u8bf7\u6c42\"\"\"\n    \u00a0 \u00a0\n    def preempt_to_schedule(self, req: Req, server_args: ServerArgs) -&gt; bool:\n    \u00a0 \u00a0 \"\"\"\u62a2\u5360\u4f4e\u4f18\u5148\u7ea7\u8bf7\u6c42\u4e3a\u9ad8\u4f18\u5148\u7ea7\u8bf7\u6c42\u8ba9\u8def\"\"\"\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#generationbatchresult","title":"GenerationBatchResult","text":"","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#1-logits_output-optionallogitsprocessoroutput","title":"1. logits_output: Optional[LogitsProcessorOutput]","text":"<ul> <li>\u4f5c\u7528: \u5305\u542b\u6a21\u578b\u524d\u5411\u4f20\u64ad\u7684\u5b8c\u6574 logits \u8f93\u51fa\u548c\u76f8\u5173\u4fe1\u606f</li> <li>\u5185\u5bb9:</li> <li>next_token_logits: \u4e0b\u4e00\u4e2a token \u7684 logits \u5206\u5e03 \u00a0<code>[batch_size, vocab_size]</code></li> <li>input_token_logprobs: \u8f93\u5165 token \u7684 log \u6982\u7387</li> <li>hidden_states: \u9690\u85cf\u72b6\u6001\uff08\u7528\u4e8e\u63a8\u6d4b\u89e3\u7801\uff09</li> <li>\u5404\u79cd top-k logprobs \u548c token \u6982\u7387\u4fe1\u606f</li> <li>\u7528\u9014: \u7528\u4e8e\u91c7\u6837\u3001\u8ba1\u7b97\u6982\u7387\u3001\u8fd4\u56de logprob \u4fe1\u606f\u7ed9\u7528\u6237</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#2-next_token_ids-optionaltorchtensor","title":"2. next_token_ids: Optional[torch.Tensor]","text":"<ul> <li>\u4f5c\u7528: \u7ecf\u8fc7\u91c7\u6837\u540e\u7684\u4e0b\u4e00\u4e2a token ID</li> <li>\u5f62\u72b6:\u00a0<code>[batch_size]</code></li> <li>\u5185\u5bb9:</li> <li>Prefill \u6a21\u5f0f\uff1a\u57fa\u4e8e\u6700\u540e\u4f4d\u7f6e\u91c7\u6837\u7684\u7b2c\u4e00\u4e2a\u751f\u6210 token</li> <li>Decode \u6a21\u5f0f\uff1a\u5f53\u524d\u6b65\u9aa4\u751f\u6210\u7684\u4e0b\u4e00\u4e2a token</li> <li>Prefill-only\uff1a\u5168\u96f6\u5360\u4f4d\u7b26 tensor</li> <li>\u7528\u9014: \u76f4\u63a5\u7528\u4e8e\u66f4\u65b0\u8bf7\u6c42\u7684 <code>output_ids</code>\uff0c\u63a8\u8fdb\u751f\u6210\u8fc7\u7a0b</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#3-num_accepted_tokens-optionalint","title":"3. num_accepted_tokens: Optional[int]","text":"<ul> <li>\u4f5c\u7528: \u63a8\u6d4b\u89e3\u7801\u4e2d\u88ab\u63a5\u53d7\u7684 token \u6570\u91cf</li> <li>\u7528\u9014: \u7edf\u8ba1\u63a8\u6d4b\u89e3\u7801\u7684\u63a5\u53d7\u7387\uff0c\u7528\u4e8e\u6027\u80fd\u4f18\u5316\u548c\u6307\u6807\u6536\u96c6</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#4-next_draft_input-optionaleagledraftinput","title":"4. next_draft_input: Optional[EagleDraftInput]","text":"<ul> <li>\u4f5c\u7528: EAGLE \u63a8\u6d4b\u89e3\u7801\u7684\u4e0b\u4e00\u8f6e\u8f93\u5165\u4fe1\u606f</li> <li>\u5185\u5bb9: \u5305\u542b top-k \u6982\u7387\u3001\u7d22\u5f15\u3001\u9690\u85cf\u72b6\u6001\u7b49</li> <li>\u7528\u9014: \u4e3a\u4e0b\u4e00\u8f6e\u63a8\u6d4b\u89e3\u7801\u51c6\u5907\u8f93\u5165\u6570\u636e</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#5-extend_input_len_per_req-optionallistint","title":"5. extend_input_len_per_req: Optional[List[int]]","text":"<ul> <li>\u4f5c\u7528: \u6bcf\u4e2a\u8bf7\u6c42\u7684\u6269\u5c55\u8f93\u5165\u957f\u5ea6</li> <li>\u7528\u9014: \u5728\u5904\u7406 batch \u7ed3\u679c\u65f6\uff0c\u77e5\u9053\u6bcf\u4e2a\u8bf7\u6c42\u5b9e\u9645\u5904\u7406\u4e86\u591a\u5c11\u4e2a\u65b0 token</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#6-extend_logprob_start_len_per_req-optionallistint","title":"6. extend_logprob_start_len_per_req: Optional[List[int]]","text":"<ul> <li>\u4f5c\u7528: \u6bcf\u4e2a\u8bf7\u6c42\u5f00\u59cb\u8ba1\u7b97 logprob \u7684\u4f4d\u7f6e</li> <li>\u7528\u9014: \u786e\u5b9a\u4ece\u54ea\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u8fd4\u56de logprob \u4fe1\u606f\u7ed9\u7528\u6237</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#7-copy_done-optionaltorchcudaevent","title":"7. copy_done: Optional[torch.cuda.Event]","text":"<ul> <li>\u4f5c\u7528: GPU \u5230 CPU \u6570\u636e\u4f20\u8f93\u5b8c\u6210\u7684\u540c\u6b65\u4e8b\u4ef6</li> <li>\u7528\u9014: \u5728\u91cd\u53e0\u8c03\u5ea6\u4e2d\u786e\u4fdd\u6570\u636e\u4f20\u8f93\u5b8c\u6210\u518d\u5904\u7406\u7ed3\u679c</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#8-delay_sample_func-optionalcallable","title":"8. delay_sample_func: Optional[callable]","text":"<ul> <li>\u4f5c\u7528: \u5ef6\u8fdf\u91c7\u6837\u51fd\u6570</li> <li>\u7528\u9014: \u5728\u91cd\u53e0\u8c03\u5ea6\u4e2d\uff0c\u5148\u6267\u884c\u524d\u5411\u4f20\u64ad\uff0c\u540e\u7eed\u518d\u6267\u884c\u91c7\u6837\u64cd\u4f5c</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#9-future_indices-optionalfutureindices","title":"9. future_indices: Optional[FutureIndices]","text":"<ul> <li>\u4f5c\u7528: Future \u673a\u5236\u4e2d\u7684\u7d22\u5f15\u4fe1\u606f</li> <li>\u7528\u9014: \u5728\u91cd\u53e0\u8c03\u5ea6\u4e2d\u7ba1\u7406\u5f02\u6b65\u7ed3\u679c\u7684\u5b58\u50a8\u548c\u68c0\u7d22</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#normal-no-overlap","title":"Normal (No overlap)","text":"<p>LLM \u662f\u81ea\u56de\u5f52\u7ed3\u6784\uff0c\u6240\u4ee5\u65e0\u8bba\u662f Prefill \u8fd8\u662f Decode\uff0c\u9a71\u52a8\u5b83\u4eec\u8fdb\u884c\u4e0b\u4e00\u6b65\u63a8\u7406\u7684\u90fd\u662f\u9884\u6d4b\u5e8f\u5217\u7684\u4e0b\u4e00\u4e2a token\uff0c\u5305\u542b <code>next_token_ids</code> \u7684\u6570\u636e\u5c31\u975e\u5e38\u5173\u952e</p> <p>\u5728 prefill \u6a21\u5f0f\u4e0b\uff0c<code>next_token_ids</code> \u5305\u542b\u7684\u662f\uff1a</p> <ul> <li>\u5f62\u72b6:\u00a0<code>[batch_size]</code>\u00a0- \u6bcf\u4e2a\u8bf7\u6c42\u4e00\u4e2a token ID</li> <li>\u5185\u5bb9: \u6bcf\u4e2a\u5e8f\u5217\u7684\u4e0b\u4e00\u4e2a token\uff0c\u5373\u57fa\u4e8e\u8f93\u5165\u5e8f\u5217\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\u7684 logits \u91c7\u6837\u5f97\u5230\u7684 token</li> <li>\u4f4d\u7f6e: \u5bf9\u4e8e prefill\uff0c\u53ea\u4f7f\u7528\u5e8f\u5217\u7684\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\u8fdb\u884c\u91c7\u6837</li> </ul> <p>\u5728 decode \u6a21\u5f0f\u4e0b\uff0c<code>next_token_ids</code> \u5305\u542b\u7684\u662f\uff1a</p> <ul> <li>\u5f62\u72b6:\u00a0<code>[batch_size]</code>\u00a0- \u6bcf\u4e2a\u8bf7\u6c42\u4e00\u4e2a token ID</li> <li>\u5185\u5bb9: \u6bcf\u4e2a\u8bf7\u6c42\u5f53\u524d\u89e3\u7801\u6b65\u9aa4\u751f\u6210\u7684\u4e0b\u4e00\u4e2a token</li> <li>\u4f4d\u7f6e: \u4f7f\u7528\u5f53\u524d\u89e3\u7801\u4f4d\u7f6e\u8fdb\u884c\u91c7\u6837</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overview_1","title":"Overview","text":"<p>\u4e00\u4e2a\u8bf7\u6c42 Request \u8fdb\u5165 SGLang Scheduler\uff0c\u4f1a\u7ecf\u8fc7\u5982\u4e0b\u9636\u6bb5</p> Bash<pre><code>Req -&gt; Pre Schedule(CPU) -&gt; Compute Batch -&gt; Sample(GPU) -&gt; Post Schedule(CPU) -&gt; next Schedule ...\n</code></pre> <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#pre-schedule","title":"Pre Schedule","text":"<ul> <li>\u6536\u96c6\u524d\u7aef\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u5e76\u5c06\u5176\u653e\u5165\u7b49\u5f85\u961f\u5217\u3002(<code>Schedule::recv_request()</code> &amp; <code>Schedule::process_input_requests()</code>)</li> <li>\u4ece\u7b49\u5f85\u961f\u5217\u548c running_batch \u4e2d\u8fdb\u884c\u8c03\u5ea6 (<code>Schedule::get_batch_to_run()</code>)</li> <li>Prefill \u4e2d\u6d89\u53ca Radix Tree \u548c\u6700\u957f\u524d\u7f00\u5339\u914d\uff08Longest Prefix Matching\uff09\u7b97\u6cd5\u3002(<code>Req::init_next_round_input()</code>)</li> <li>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5206\u914d Token \u6240\u9700\u7684\u5185\u5b58\u8d44\u6e90\u3002\u3002(<code>ScheduleBatch::prepare_for_extend()</code> &amp; <code>ScheduleBatch::prepare_for_decode()</code>)</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#compute-batch","title":"Compute batch","text":"<p>\u65b0\u7684\u8bf7\u6c42\u4f1a\u8fdb\u5165 Prefill \u9636\u6bb5\uff0cPrefill \u9636\u6bb5\u7ed3\u675f\u540e\u8fdb\u5165 Decode \u9636</p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#prefill-schedule","title":"Prefill Schedule","text":"<ol> <li> <p><code>get_next_batch_to_run</code>\uff1a\u8fd9\u91cc\u662f Prefill \u4f18\u5148\uff0c\u6240\u4ee5\u4f1a\u8c03\u7528 <code>get_new_batch_prefill</code>\uff0c\u5e76\u76f4\u63a5\u628a\u51fd\u6570\u8fd4\u56de\u7684<code>new_batch</code>\u4f5c\u4e3a\u8fd9\u4e00\u8f6e\u6267\u884c\u7684 batch(\u5373 <code>cur_batch</code>)</p> </li> <li> <p><code>get_new_batch_prefill</code>:</p> </li> </ol> <ul> <li>\u521b\u5efa PrefillAdder \u6765\u7ba1\u7406\u6279\u6b21\u6784\u5efa\uff0c\u4ece waiting_queue \u4e2d\u9009\u62e9\u8bf7\u6c42</li> <li><code>init_next_round_input</code> \u66f4\u65b0 radix tree cache \u7684\u524d\u7f00</li> <li>\u521b\u5efa\u65b0\u7684 ScheduleBatch\uff0c\u8c03\u7528 <code>prepare_for_extend</code>:<ul> <li>\u5206\u914d<code>req_pool_indices</code>\uff1a\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5728\u8bf7\u6c42\u6c60\u4e2d\u5206\u914d\u4e00\u4e2a\u552f\u4e00\u7684\u7d22\u5f15\u4f4d\u7f6e\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7528\u4e8e\u5728 \u00a0<code>req_to_token_pool</code>\u00a0 \u4e2d\u5b58\u50a8\u8be5\u8bf7\u6c42\u7684 token-to-KV \u6620\u5c04\u3002</li> <li>allocate kv cache</li> <li>\u5c06 req \u4e0e kv cache \u7684\u6620\u5c04\u5199\u5165\u5230 <code>req_to_token_pool</code></li> </ul> </li> </ul> <ol> <li><code>run_batch()</code>\uff1a\u6267\u884c Prefill \u63a8\u7406\uff0c\u8c03\u7528 <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward()</code> -&gt; <code>ModelRunner::_foward_raw()</code> -&gt; <code>ModelRunner::forward_extend()</code>\uff0c\u540e\u9762\u6267\u884c backend \u7684\u7b97\u5b50\u7b49\u5f85\u8fd4\u56de\u7ed3\u679c</li> </ol>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#decode-schedule","title":"Decode Schedule","text":"<ol> <li><code>get_next_batch_to_run()</code>\uff1a\u5904\u7406\u4e0a\u4e00\u6279\u6b21\u7684\u5b8c\u6210\u8bf7\u6c42\uff0c\u7136\u540e\u4e0e running_batch \u8fdb\u884c merge</li> <li><code>update_running_batch()</code>\uff1a    - \u8c03\u7528 \u00a0<code>prepare_for_decode()</code>\uff1a<ul> <li>\u4e0a\u4e00\u6b21 schedule \u7684 <code>output_ids</code> \u53d8\u4e3a\u8fd9\u4e00\u6b21\u7684 <code>input_ids</code></li> <li>\u4e3a \u00a0<code>out_cache_loc</code>\u00a0 \u5206\u914d\uff08batch size * 1\uff09\u4e2a slot\uff0c\u56e0\u4e3a\u5728 decode \u6a21\u5f0f\u4e0b\u6211\u4eec\u5bf9\u6bcf\u4e2a batch \u4e00\u6b21\u53ea\u751f\u6210\u4e00\u4e2a token Python<pre><code>out_cache_loc = alloc_token_slots(batch.tree_cache, bs * 1)\n</code></pre></li> </ul> </li> <li><code>run_batch()</code>\uff1a\u6267\u884c Decode \u63a8\u7406\uff0c\u8c03\u7528 <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward()</code> -&gt; <code>ModelRunner::_foward_raw()</code> -&gt; <code>ModelRunner::forward_decode()</code>\u540e\u9762\u6267\u884c backend \u7684\u7b97\u5b50\u7b49\u5f85\u8fd4\u56de\u7ed3\u679c</li> </ol>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#sample","title":"Sample","text":"<p><code>TpModelWorker::forward_batch_generation()</code>\uff1a</p> <ul> <li> <p>\u5982\u679c\u4e0d\u662f overlap \u6a21\u5f0f\uff0c\u7acb\u5373\u8fdb\u884c Sample\uff0c\u5426\u5219\u91cd\u53e0 CPU \u548c GPU \u8fdb\u884c\u5ef6\u8fdf\u91c7\u6837</p> </li> <li> <p>Sample \u5f97\u5230 batch \u7684 <code>next_token_ids</code>\uff0c\u4f9b\u4e0b\u4e00\u6b21 batch forward \u4f7f\u7528</p> </li> </ul> Python<pre><code>  sampling_info.update_regex_vocab_mask()\n  sampling_info.apply_logits_bias(logits_output.next_token_logits)\n  next_token_ids = self.sampler(\n</code></pre> <p>logits_output, forward_batch.sampling_info, forward_batch.return_logprob, forward_batch.top_logprobs_nums, forward_batch.token_ids_logprobs, # For prefill, we only use the position of the last token. ( forward_batch.positions if forward_batch.forward_mode.is_decode() else forward_batch.seq_lens - 1 ), ) ```</p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#post-schedule","title":"Post Schedule","text":"<ul> <li>Prefill\uff1a <code>process_batch_result_prefill()</code></li> <li>\u83b7\u53d6\u7ed3\u679c\uff0c\u8c03\u7528 tree_cache \u7684 <code>cache_unfinished_req()</code> \u4fdd\u7559\u8be5 req \u7684 cache</li> <li>Decode\uff1a <code>process_batch_result_decode()</code>\uff1a</li> <li>\u5bf9\u6bcf\u4e2a Req \u8fdb\u884c\u5224\u65ad\uff0c\u5982\u679c\u5df2\u7ecf\u5b8c\u6210\u5c31\u91ca\u653e tree_cache \u4e2d\u5bf9\u5e94\u7684 KV cache(\u5faa\u73af\u89e3\u91ca\u540e\u6279\u91cf\u91ca\u653e)</li> <li>\u5c06 batch \u7684\u7ed3\u679c\u901a\u8fc7 <code>stream_out()</code> \u8fd4\u56de\u7ed9 detokenizer \u8fdb\u884c\u4e0b\u4e00\u6b65\u5904\u7406</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_1","title":"\u4e8b\u4ef6\u5faa\u73af","text":"<ul> <li>\u8bf7\u6c42\u90fd\u4f1a\u5148\u6267\u884c prefill \u9636\u6bb5\u7136\u540e\u6267\u884c decode \u9636\u6bb5\uff0c\u76f4\u5230\u83b7\u5f97 EOS \u6216\u5176\u4ed6\u539f\u56e0\u9000\u51fa</li> </ul> Python<pre><code>def event_loop_normal(self):\n\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"A normal scheduler loop.\"\"\"\n\u00a0 \u00a0 \u00a0 \u00a0 while True:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 recv_reqs = self.recv_requests()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.process_input_requests(recv_reqs)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 batch = self.get_next_batch_to_run()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.cur_batch = batch\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if batch:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result = self.run_batch(batch)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.process_batch_result(batch, result)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 else:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # When the server is idle, do self-check and re-init some states\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.self_check_during_idle()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.last_batch = batch\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#pre-schedule_1","title":"Pre Schedule","text":"","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#req-waiting_queue","title":"Req -&gt; Waiting_queue","text":"<ul> <li> <p>\u9996\u5148\u6267\u884c <code>recv_requests</code>\uff1a</p> </li> <li> <p>\u53ea\u6709 Pipeline rank = 0 \u7684\u53ef\u4ee5\u4ece zmq \u4e2d\u83b7\u53d6 tokenizer \u4f20\u6765\u7684 requests</p> </li> <li>\u5176\u4ed6 pipeline rank \u4ece\u524d\u4e00\u4e2a pipeline \u83b7\u53d6 requests</li> <li> <p>work_reqs \u5728 attn_tp \u4e2d\u8fdb\u884c\u5e7f\u64ad\uff1b\u7cfb\u7edf\u7684 control_reqs \u5728\u6574\u4e2a tp_size \u4e2d\u5e7f\u64ad</p> </li> <li> <p>\u7136\u540e\u6267\u884c <code>process_input_requests</code></p> </li> </ul> <ol> <li>\u63d0\u53d6 worker_id:\u00a0<code>worker_id = recv_req.worker_id</code></li> <li>\u89e3\u5305\u8bf7\u6c42:\u00a0<code>recv_req = recv_req.obj</code></li> <li>\u5206\u53d1\u5904\u7406:\u00a0<code>output = self._request_dispatcher(recv_req)</code> \u8c03\u7528\u8bf7\u6c42\u5206\u53d1\u5668<ul> <li>\u5c06 recv_req \u6784\u5efa\u4e3a\u65b0\u7684 <code>Req</code> \u5bf9\u8c61</li> <li>\u8c03\u7528 <code>_add_request_to_queue()</code> \u5c06 <code>Req</code> \u63d2\u5165 waiting_queue \u4e2d</li> </ul> </li> <li>\u53d1\u9001\u56de\u5e94: \u5c06\u8f93\u51fa\u53d1\u9001\u56de\u5bf9\u5e94\u7684 tokenizer \u5de5\u4f5c\u8fdb\u7a0b</li> </ol>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#waiting_queuerunning_batch-cur_batch","title":"Waiting_queue/running_batch -&gt; cur_batch","text":"","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#prefill-batch-get_new_batch_prefill","title":"\u83b7\u53d6 prefill batch <code>get_new_batch_prefill</code>","text":"<ul> <li>\u521b\u5efa PrefillAdder\uff0c\u5bf9\u65b0\u6765\u7684\u8bf7\u6c42\u8fdb\u884c\u5206\u5757\uff0c\u7136\u540e\u6bcf\u6b21\u5904\u7406\u591a\u4e2a\u5206\u5757</li> <li><code>init_next_round_input()</code>\uff1a<ul> <li>\u6784\u5efa\u5b8c\u6574\u586b\u5145\u5e8f\u5217\uff1a\u539f\u59cb\u8f93\u5165 token + \u5df2\u751f\u6210\u7684\u8f93\u51fa token</li> <li>\u6700\u5927\u524d\u7f00\u957f\u5ea6\u8ba1\u7b97\uff1a\u6700\u591a\u7f13\u5b58\u5230\u5012\u6570\u7b2c\u4e8c\u4e2a token\uff08<code>input_len - 1</code>\uff09\uff0c\u4fdd\u7559\u6700\u540e\u4e00\u4e2a token \u4e3a\u9884\u6d4b\u76ee\u6807</li> <li>\u524d\u7f00\u5339\u914d\uff1a</li> <li>\u5f53 Request\u00a0<code>ABC</code>\u5230\u8fbe\u65f6\uff0c\u5047\u8bbe\u5f53\u524d radix cache \u91cc\u5b58\u5728\u4e00\u4e2a\u8282\u70b9<code>AFG</code></li> <li><code>match_prefix</code>\u00a0 \u4f1a\u5c1d\u8bd5\u5728\u5f53\u524d radix cache \u91cc\u627e\u5230\u73b0\u5b58\u7684<code>ABC</code>\u7684\u6700\u957f\u524d\u7f00\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b83\u4f1a\u5728<code>AFG</code>\u8282\u70b9\u91cc\u627e\u5230<code>A</code></li> <li>Radix cache \u4f1a\u628a\u8fd9\u4e2a\u8282\u70b9<code>AFG</code>\u62c6\u5206\u6210<code>A</code>\u548c<code>FG</code>\uff0c<code>A</code>\u8282\u70b9\u6210\u4e3a\u5f53\u524d Request \u7684\u6700\u540e\u4e00\u4e2a\u8282\u70b9</li> </ul> </li> <li>\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 ScheduleBatch</li> <li>\u8c03\u7528 <code>ScheduleBatch::prepare_for_extend()</code></li> <li>\u5206\u914d<code>req_pool_indices</code>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5728\u8bf7\u6c42\u6c60\u4e2d\u5206\u914d\u4e00\u4e2a\u552f\u4e00\u7684\u7d22\u5f15\u4f4d\u7f6e\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7528\u4e8e\u5728 \u00a0<code>req_to_token_pool</code>\u00a0 \u4e2d\u5b58\u50a8\u8be5\u8bf7\u6c42\u7684 token-to-KV \u6620\u5c04\u3002<ul> <li>allocate kv cache\uff1a[\u6bcf\u4e2a Request \u7684\u603b input token \u6570 - match \u5230\u7684 prefixtoken \u6570] \u4e2a<code>out_cache_loc</code></li> <li>\u5c06 req \u4e0e kv cache \u7684\u6620\u5c04\u5199\u5165\u5230 <code>req_to_token_pool</code></li> </ul> </li> </ul> Python<pre><code>req_to_token_pool[req_idx]:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u524d\u7f00\u90e8\u5206 (1984 tokens)    \u2502    \u65b0chunk\u90e8\u5206 (2000 tokens)    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 [loc_1, loc_2, ..., loc_1984] \u2502 [loc_1985, ..., loc_3984] \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u4f4d\u7f6e:  0                    1984                         3984\n\nKV Cache Pool:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502loc_1 \u2502loc_2 \u2502 ... \u2502loc_1984\u2502loc_1985\u2502 ... \u2502loc_3984\u2502 ... \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 k1,v1\u2502 k2,v2\u2502 ... \u2502k1984,v1984\u2502k1985,v1985\u2502 ... \u2502k3984,v3984\u2502 ... \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#decode-batch","title":"\u83b7\u53d6 decode batch","text":"<ul> <li> <p>\u5148\u4ece batch \u4e2d\u5220\u9664\u5df2\u7ecf\u5b8c\u6210\u6216\u8005\u5df2\u7ecf\u51fa\u9519\u7684 batch\uff0c\u7136\u540e\u5c06\u4e0a\u4e00\u8f6e\u7684 decode batch \u4e0e running_batch \u5408\u5e76</p> </li> <li> <p>\u5b9e\u9645\u4e0a\u5c31\u662f\u5c06 <code>seq_lens</code>, <code>orig_seq_lens</code>, <code>output_ids</code> \u7b49\u8fdb\u884c <code>torch.cat</code> \u62fc\u63a5</p> </li> <li> <p>\u8c03\u7528 <code>update_running_batch()</code> \u83b7\u53d6 decode batch</p> </li> <li> <p>\u5148\u68c0\u67e5\u662f\u5426\u9700\u8981\u56de\u9000\u8bf7\u6c42</p> </li> <li> <p>\u5982\u679c\u9700\u8981\uff0c\u628a\u8981\u56de\u9000\u7684\u8bf7\u6c42\u91cd\u65b0\u63d2\u5165 <code>waiting_queue</code>\uff0c\u91cd\u65b0\u6392\u961f\u8fdb\u884c\u8c03\u5ea6</p> </li> <li> <p>\u8c03\u7528 <code>ScheduleBatch::prepare_for_decode()</code></p> <ul> <li>\u4e0a\u4e00\u8f6e\u8f93\u51fa\u4f5c\u4e3a\u8fd9\u4e00\u8f6e\u7684\u8f93\u5165</li> <li>\u5185\u5b58\u5206\u914d + \u5e8f\u5217\u957f\u5ea6\u66f4\u65b0</li> </ul> Python<pre><code># \u5047\u8bbebatch\u67093\u4e2a\u8bf7\u6c42\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u5f53\u524d\u957f\u5ea6\u5206\u522b\u4e3a[10, 15, 8]\n# decode\u9700\u8981\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u7684\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\u5206\u914d\u7a7a\u95f4\n\n# \u5206\u914d\u524d\u7684KV cache\u6620\u5c04\nreq_to_token_pool[req1_idx, 0:10] = [loc1, loc2, ..., loc10]\nreq_to_token_pool[req2_idx, 0:15] = [loc11, loc12, ..., loc25]\nreq_to_token_pool[req3_idx, 0:8] = [loc26, loc27, ..., loc33]\n\n# \u6267\u884c alloc_for_decode \u540e\nreq_to_token_pool[req1_idx, 10] = loc34    # \u4e3a\u4f4d\u7f6e10\u5206\u914d\nreq_to_token_pool[req2_idx, 15] = loc35    # \u4e3a\u4f4d\u7f6e15\u5206\u914d\nreq_to_token_pool[req3_idx, 8] = loc36     # \u4e3a\u4f4d\u7f6e8\u5206\u914d\n\n# out_cache_loc = [loc34, loc35, loc36]\n\n# A faster in-place version\nself.seq_lens.add_(1)\nself.seq_lens_cpu.add_(1)\nself.orig_seq_lens.add_(1)\n# update all length\nself.seq_lens_sum += bs \u00a0# bs = batch_size\n</code></pre> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#compute-batch-sample","title":"Compute batch &amp; Sample","text":"<p>\u8fd9\u91cc\u6211\u4eec\u6682\u65f6\u53ea\u8003\u8651 generation \u7684\u60c5\u51b5\uff08\u8fd8\u6709 Embedding \u7684\u60c5\u51b5\uff09</p> <ul> <li>\u5c06 <code>ScheduleBatch</code> \u8f6c\u5316\u4e3a <code>ModelWorkerBatch</code></li> <li>\u8c03\u7528 <code>TpModelWorker::forward_batch_generation()</code></li> <li>\u5c06 <code>ModelWorkerBatch</code> \u8f6c\u5316\u4e3a <code>ForwardBatch</code></li> <li>\u8c03\u7528 <code>ModelRunner::forward()</code>\uff0c\u6700\u540e\u8c03\u7528\u540e\u7aef flashinfer \u7684\u7b97\u5b50<ul> <li>Prefill \u6267\u884c <code>ModelRunner::forward_extend()</code></li> <li>Decode \u6267\u884c <code>ModelRunner::forward_decode()</code></li> </ul> </li> <li>\u7acb\u5373\u8fdb\u884c Sample\uff0c\u6839\u636e logits \u83b7\u5f97\u4e0b\u4e00\u4e2a token</li> <li>\u8fd4\u56de\u7ed3\u679c <code>GenerationBatchResult</code></li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#post-schedule_1","title":"Post Schedule","text":"","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#prefill","title":"Prefill","text":"<ul> <li>\u89e3\u5305 <code>GenerationBatchResult</code></li> <li>\u6267\u884c <code>synchronize()</code> \u7b49\u5f85 GPU\u2192CPU \u62f7\u8d1d\u5b8c\u6210\uff0c\u4fdd\u8bc1\u4e4b\u540e\u8bbf\u95ee\u7684\u6570\u636e\u5df2\u5728 CPU \u4e0a\u53ef\u7528\u3002</li> <li>\u904d\u5386 batch \u4e2d\u6bcf\u4e2a\u8bf7\u6c42</li> <li>\u66f4\u65b0\u751f\u6210\u7ed3\u679c</li> <li>\u66f4\u65b0 logprob</li> <li>Chunked \u8bf7\u6c42\u7684\u7279\u6b8a\u5904\u7406\uff1a<code>is_chunked &gt; 0</code> \u8868\u793a prefill \u5c1a\u672a\u5168\u90e8\u5b8c\u6210\uff0c\u9700\u8981\u9012\u51cf\u8ba1\u6570\u5e76\u8df3\u8fc7\u6d41\u5f0f\u8f93\u51fa\u3002</li> <li>\u8f93\u51fa\u6d41\u5f0f\u7ed3\u679c\uff1a\u8c03\u7528 <code>stream_output()</code> \u5c06\u7ed3\u679c\uff08token\u3001logprob \u7b49\uff09\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\uff08\u4f8b\u5982 WebSocket / API response\uff09</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#decode","title":"Decode","text":"Python<pre><code>[GPU forward kernel]\n   \u2193 (\u7ed3\u679c\u5199\u5165 GenerationBatchResult)\n[Scheduler.process_batch_result_decode()]\n   \u251c\u2500\u2500 copy_done.synchronize()\n   \u251c\u2500\u2500 next_token_ids.tolist()\n   \u251c\u2500\u2500 \u66f4\u65b0 req \u72b6\u6001\n       \u251c\u2500\u2500 req.output_ids.append(next_token_id)\n       \u251c\u2500\u2500 if finished, self.tree_cache.cache_finished_req(req) # \u91ca\u653e kv cache\n   \u251c\u2500\u2500 stream_output()\n   \u2514\u2500\u2500 free KV pages\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#why-overlap","title":"Why Overlap?","text":"<p>\u8fd0\u884c\u5b9e\u9645\u8c03\u5ea6\u7b97\u6cd5\u4ec5\u5360\u603b\u4f53\u8c03\u5ea6\u5f00\u9500\u7684\u4e00\u5c0f\u90e8\u5206\u3002\u5927\u90e8\u5206\u5f00\u9500\u6765\u81ea\u4e8e\u6a21\u578b\u8f93\u5165\u7684\u51c6\u5907\u548c\u6a21\u578b\u8f93\u51fa\u7684\u540e\u5904\u7406\u3002\u5177\u4f53\u800c\u8a00\uff0c\u6700\u5927\u7684\u5f00\u9500\u6765\u81ea\u4e8e\u6784\u5efa\u8f93\u5165\u5f20\u91cf(Pre Schedule)\u3001\u6267\u884c\u8f93\u51fa\u53bb\u6807\u8bb0\u5316(Post Schedule)\u4ee5\u53ca\u51c6\u5907\u6bcf\u4e2a\u8bf7\u6c42\u7684\u5143\u6570\u636e(Pre Schedule)[^overhead]</p> <p>\u6784\u5efa\u6a21\u578b\u8f93\u5165\u5f20\u91cf\u548c\u91c7\u6837\u5143\u6570\u636e\u65b9\u9762\u7684\u5f00\u9500\u4e3b\u8981\u6e90\u4e8e Python</p> <p>\u4f7f\u7528\u591a\u6b65\u8c03\u5ea6\u53ef\u4ee5\u964d\u4f4e\u603b\u4f53\u8c03\u5ea6\u5f00\u9500\uff0c\u4f46\u4e5f\u5b58\u5728\u4e00\u4e9b\u5f0a\u7aef\u3002\u4f8b\u5982\uff0c\u5728\u4e24\u6b21\u8c03\u5ea6\u8c03\u7528\u4e4b\u95f4\uff0c\u5373\u4f7f\u67d0\u4e9b\u8bf7\u6c42\u63d0\u524d\u5b8c\u6210\uff0c\u4e5f\u65e0\u6cd5\u5c06\u65b0\u7684\u8bf7\u6c42\u6dfb\u52a0\u5230\u6279\u6b21\u4e2d\u3002</p> <ul> <li>vLLM \u7684 multi-step decode</li> <li>SGLang \u7684 speculative group execution</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#zero-overhead-scheduleoverlap","title":"Zero-Overhead Schedule(Overlap)","text":"","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_2","title":"\u539f\u7406","text":"<p>\u5728\u4ecb\u7ecd\u539f\u7406\u4e4b\u524d\u6211\u4eec\u9700\u8981\u56de\u5fc6\u4e00\u4e0b\u4e0a\u9762\u63a8\u7406\u8fc7\u7a0b\u7684 4 \u4e2a\u5927\u6b65\u9aa4\uff0c\u8003\u8651\u54ea\u4e9b\u6b65\u9aa4\u53ef\u4ee5\u8fdb\u884c Overlap\uff0c\u51cf\u5c11 GPU Bubble\uff0c\u5148\u653e\u4e00\u5f20\u73b0\u5728 Overlap \u7684\u6d41\u6c34\u7ebf\u56fe</p> <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#inference-overview","title":"Inference Overview","text":"<p>SGLang \u7684\u63a8\u7406\u8fc7\u7a0b\u4e3b\u8981\u5206\u4e3a\u4ee5\u4e0b\u56db\u4e2a\u9636\u6bb5\uff1a</p> <ol> <li>Pre schedule\uff1a    - \u6536\u96c6\u524d\u7aef\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u5e76\u5c06\u5176\u653e\u5165\u7b49\u5f85\u961f\u5217\u3002(<code>Scheduler::recv_request()</code> &amp; <code>Scheduler::process_input_requests()</code>)    - \u4ece\u7b49\u5f85\u961f\u5217\u548c running_batch \u4e2d\u8fdb\u884c\u8c03\u5ea6 (<code>Scheduler::get_batch_to_run()</code>)<ul> <li>Prefill \u4e2d\u6d89\u53ca Radix Tree \u548c\u6700\u957f\u524d\u7f00\u5339\u914d\uff08Longest Prefix Matching\uff09\u7b97\u6cd5\u3002(<code>Req::init_next_round_input()</code>)</li> <li>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5206\u914d Token \u6240\u9700\u7684\u5185\u5b58\u8d44\u6e90\u3002(<code>ScheduleBatch::prepare_for_extend()</code> &amp; <code>ScheduleBatch::prepare_for_decode()</code>)</li> </ul> </li> <li>Compute batch\uff1a    - \u5c06 batch \u53d1\u9001\u5230 GPU \u4e0a\u8fdb\u884c\u4e00\u6b65\uff08\u5373 Continue Batch \u7684\u4e00\u4e2a iter\uff09\u63a8\u7406(<code>Scheduler::run_batch()</code>)</li> <li>Sample\uff1a    - \u6839\u636e\u6a21\u578b\u8f93\u51fa\u7684 Logit \u8fdb\u884c\u91c7\u6837\uff0c\u751f\u6210\u4e0b\u4e00\u6b65\u7684 Token\u3002(<code>ModelRunner::sample()</code>)</li> <li>Post schedule\uff1a    - \u5728\u4e00\u6b65\u63a8\u7406\u5b8c\u6210\u540e\uff0c\u52a8\u6001\u68c0\u67e5\u8bf7\u6c42\u662f\u5426\u6ee1\u8db3\u7ed3\u675f\u6761\u4ef6\uff08Check Finish Condition\uff09\u3002(<code>Scheduler::process_batch_result()</code>)    - \u5c06\u5df2\u5b8c\u6210\u7684\u8bf7\u6c42\u4ece\u6279\u6b21\u4e2d\u79fb\u9664\uff0c\u5e76\u9001\u5165 Detokenizer \u5904\u7406\uff0c\u6700\u7ec8\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9\u524d\u7aef\u3002</li> </ol>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overlap-overviewoverlap","title":"Overlap Overview[^overlap]","text":"<p>Compute batch \u548c Sample \u8fd9\u4e24\u4e2a\u6328\u5728\u4e00\u8d77\u7684\u9636\u6bb5\u662f GPU heavy \u7684\uff0c\u800c schedule \u7684\u4e24\u4e2a\u9636\u6bb5\u662f CPU heavy \u7684\u3002\u5f53\u591a\u4e2a batch \u6d41\u6c34\u7ebf\u5316\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 GPU \u7684 Compute \u548c Sample \u6765\u91cd\u53e0\u4e0a\u4e00\u4e2a batch \u7684 post scheduler \u4e0e\u5f53\u524d batch \u7684 pre scheduler\u3002</p> <p>\u5b9e\u9645\u4e0a\u6211\u4eec\u7684 Prefill \u8bf7\u6c42\u8fdb\u5165\u5e76\u4e0d\u4f9d\u8d56\u672a\u5b8c\u6210\u7684 batch\uff0c\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u6765\u53ef\u4ee5\u76f4\u63a5\u6b63\u5e38\u6267\u884c</p> <p>\u6211\u4eec\u901a\u8fc7\u4f7f\u7528 Forward CUDA Stream \u7684\u65b9\u5f0f\u6765\u5b9e\u73b0 overlap\uff0c\u5177\u4f53\u6765\u8bf4\uff1a</p> <ul> <li> <p>Run Batch \u4e2d\u5c06\u4e24\u4e2a\u64cd\u4f5c\u63d0\u4ea4\u5230 forward_stream \u961f\u5217\uff1a\u4e00\u4e2a\u662f\u4ece FutureMap \u83b7\u53d6\u4e0a\u4e00\u6b21 batch \u7684 next token\uff1b\u4e00\u4e2a\u7528\u8fd9\u4e2a token \u4f5c\u4e3a <code>intput_id</code> \u8fdb\u884c\u4e0b\u4e00\u6b21\u8ba1\u7b97</p> </li> <li> <p>Sample \u4e2d\u4e5f\u628a\u4e24\u4e2a\u64cd\u4f5c\u63d0\u4ea4\u5230 forward_stream \u961f\u5217\uff1a\u4e00\u4e2a\u662f\u8fdb\u884c\u91c7\u6837\uff1b\u4e00\u4e2a\u662f\u5c06\u5f97\u5230\u7684 next token \u5199\u56de FutureMap</p> </li> <li> <p>\u6211\u4eec\u9700\u8981\u5728 Post Schedule \u5904\u7406\u6570\u636e\u524d\u5bf9 CPU \u548c GPU \u505a\u4e00\u4e2a\u540c\u6b65\uff0c\u4fdd\u8bc1\u53ef\u4ee5\u5904\u7406\u5230 CPU \u7684 <code>next_token_ids</code> - \u6211\u4eec\u5728 Post Schedule \u4e2d\u8fdb\u884c\u540c\u6b65\u64cd\u4f5c\uff0c\u786e\u4fdd\u540e\u7eed\u7684\u5904\u7406\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u4e14\u4e0d\u5f71\u54cd GPU \u7684\u6d41\u6c34\u7ebf\u5de5\u4f5c</p> </li> </ul> Python<pre><code>  def process_batch_result_decode(\n</code></pre> <p>self: Scheduler, batch: ScheduleBatch, result: GenerationBatchResult, ): if result.copy_done is not None: result.copy_done.synchronize() logits_output, next_token_ids, can_run_cuda_graph = ( result.logits_output, result.next_token_ids, result.can_run_cuda_graph, ) next_token_ids = next_token_ids.tolist() next_token_logprobs = logits_output.next_token_logprobs.tolist() ```</p> <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overlap","title":"\u521d\u59cb\u5316 Overlap","text":"<ul> <li>forward_stream\uff1a\u4e13\u95e8\u7528\u4e8e GPU \u524d\u5411\u8ba1\u7b97\uff0c\u4e0e\u9ed8\u8ba4\u6d41\u5e76\u884c</li> <li>copy_stream\uff1a\u5904\u7406 GPU-&gt;CPU \u6570\u636e\u4f20\u8f93</li> <li>future_map\uff1a\u7ba1\u7406\u5f02\u6b65\u8ba1\u7b97\u7ed3\u679c\uff0c\u4f7f\u7528\u8d1f\u7d22\u5f15\u4f5c\u4e3a future \u6807\u8bc6\u7b26</li> <li>\u4e0a\u4e00\u4e2a batch \u8ba1\u7b97\u7684 <code>output_id</code> \u4f5c\u4e3a\u4e0b\u4e00\u4e2a batch \u7684 <code>input_id</code>\uff0c\u901a\u8fc7\u5b58\u53d6 <code>future_map</code> \u5b9e\u73b0</li> </ul> Python<pre><code>def init_overlap(self):\n    if not self.enable_overlap:\n        return\n    self.forward_stream = torch.cuda.Stream()  # GPU\u524d\u5411\u8ba1\u7b97\u6d41\n    # Future\u6620\u5c04\u7ba1\u7406\u5f02\u6b65\u7ed3\u679c\n    self.future_map = FutureMap(max_running_requests, device, spec_algorithm)\n    # batch \u7f13\u51b2\u533a\uff08\u9632\u6b62GPU\u5f20\u91cf\u88abGC\u56de\u6536\uff09\n    self.batch_record_buf = [None] * 2\n    self.batch_record_ct = 0\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#futuremap","title":"FutureMap","text":"<ul> <li> <p>\u5b58\u653e\u5728 GPU \u4e0a</p> </li> <li> <p><code>future_ct</code>\uff1a\u5f53\u524d\u73af\u5f62\u8ba1\u6570\u5668\uff08\u6307\u9488\uff09\uff0c\u7528\u4e8e\u751f\u6210\u65b0\u7684 future indices\uff08\u5e76\u975e\u201c\u5c1a\u672a\u5b8c\u6210\u7684\u6570\u91cf\u201d\uff09\u3002</p> </li> <li> <p><code>future_limit</code>\uff1a\u73af\u5f62\u6307\u9488\u7684\u6a21\uff08\u7528\u6765\u505a <code>% self.future_limit</code>\uff09\u3002\u4ee3\u7801\u91cc\u7528 <code>*3</code> \u7684\u56e0\u5b50\u6765 \u51cf\u5c0f\u7d22\u5f15\u51b2\u7a81\u6982\u7387\uff08\u9632\u6b62 <code>future_ct</code> \u5feb\u901f\u56de\u7ed5\u8986\u76d6\u5c1a\u672a\u5199\u56de\u7684 slot\uff09\u3002</p> </li> <li> <p><code>future_buffer_len</code>\uff1a\u5b9e\u9645\u7f13\u51b2\u533a\u7269\u7406\u957f\u5ea6\uff08<code>*5</code>\uff09\uff0c\u6bd4 <code>future_limit</code> \u66f4\u957f\u4ee5\u4fdd\u8bc1\u5199\u5165\u533a\u95f4\u6709\u8db3\u591f\u7a7a\u95f4\uff08\u9632\u6b62 slice \u8d8a\u754c\u6216\u56de\u7ed5\u5199\u5165\u4e0e\u8bfb\u51b2\u7a81\uff09\u3002</p> </li> <li> <p>\u8fd9\u4e24\u4e2a\u56e0\u5b50\uff083 \u548c 5\uff09\u662f\u5de5\u7a0b\u7ecf\u9a8c\u503c\uff0c\u7528\u6765\u589e\u52a0\u5b89\u5168\u88d5\u91cf\uff1b\u4f60\u53ef\u4ee5\u6839\u636e\u5e76\u53d1\u91cf\u548c outstanding futures \u8c03\u6574\u3002</p> </li> </ul> Python<pre><code>class FutureMap:\n\u00a0 \u00a0 def __init__(\n\u00a0 \u00a0 \u00a0 \u00a0 self,\n\u00a0 \u00a0 \u00a0 \u00a0 max_running_requests: int,\n\u00a0 \u00a0 ):\n\u00a0 \u00a0 \u00a0 \u00a0 self.future_ct = 0\n\u00a0 \u00a0 \u00a0 \u00a0 # A factor of 3 is used to avoid collision in the circular buffer.\n\u00a0 \u00a0 \u00a0 \u00a0 self.future_limit = max_running_requests * 3\n\u00a0 \u00a0 \u00a0 \u00a0 # A factor of 5 is used to ensure the buffer is large enough.\n\u00a0 \u00a0 \u00a0 \u00a0 self.future_buffer_len = max_running_requests * 5\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overlap_1","title":"Overlap \u4e8b\u4ef6\u5faa\u73af","text":"Python<pre><code>def event_loop_overlap(self):\n    self.result_queue = deque()  # \u5b58\u50a8(batch, result)\u5bf9\n    while True:\n        # === Pre Schedule 2 ===\n        recv_reqs = self.recv_requests()\n        self.process_input_requests(recv_reqs)\n        batch = self.get_next_batch_to_run()\n        self.cur_batch = batch\n\n        batch_result = None\n        if batch:\n            # === Launch Compute Batch 2 ===\n            batch_result = self.run_batch(batch)  # \u975e\u963b\u585e\u542f\u52a8\n            self.result_queue.append((batch.copy(), batch_result))\n\n        # === Post Schedule 1 ===\n        # compute batch 2 \u4e0e post schedule 1 \u5e76\u884c\u6267\u884c\n        if self.last_batch:\n            # \u5904\u7406\u961f\u5217\u4e2d\u7684\u7ed3\u679c\uff08\u6b64\u65f6GPU\u5728\u5e76\u884c\u8ba1\u7b97\u5f53\u524d\u6279\u6b21\uff09\n            tmp_batch, tmp_result = self.result_queue.popleft()\n            self.process_batch_result(tmp_batch, tmp_result)\n        elif batch is None:\n            self.self_check_during_idle()\n\n        # === Launch Sample 2 ===\n        self.launch_batch_sample_if_needed(batch_result)  # update vocab mask\n        self.last_batch = batch\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#normal-event-loop","title":"\u4e0e normal event loop \u7684\u4e0d\u540c","text":"<ul> <li><code>Schedule::run_batch()</code></li> <li><code>Schedule::record_batch_in_overlap()</code>\uff1a\u5728\u4e24\u4e2a overlap \u7684 batch \u4e2d\u4ea4\u66ff\u5b58\u50a8 model_worker_batch \u5f15\u7528\uff0c\u907f\u514d\u5728 overlap \u7684 forward \u5c1a\u672a\u7ed3\u675f\u65f6\uff0cCUDA kernel \u8bbf\u95ee\u91ce\u6307\u9488\u6216\u5df2\u91ca\u653e\u7684\u663e\u5b58</li> <li><code>FutureMap::resolve_future()</code>\uff1a\u7528\u4e0a\u4e00\u8f6e batch sample \u5f97\u5230\u7684\u771f\u5b9e token \u66ff\u6362\u8d1f\u7d22\u5f15\u7684\u5360\u4f4d\u7b26</li> <li><code>TpModelWorker::forward_batch_generation()</code>\uff0c\u8be5\u51fd\u6570\u4ec5\u4ec5\u5c06 model_runner.sample \u51fd\u6570 delay \u6267\u884c\uff0c\u5148\u8fd4\u56de batch_result</li> <li>\u589e\u52a0\u4e86 <code>Scheduler::launch_batch_sample_if_needed()</code>\uff1a</li> <li>\u6267\u884c\u771f\u6b63\u7684 Sample \u64cd\u4f5c<ul> <li>\u5c4f\u853d\u975e\u6cd5 token\uff0c\u5206\u914d vocab_mask \u5f20\u91cf\u5927\u5c0f [batch, vocab_size]</li> <li>\u79fb\u52a8 mask \u5230 CPU</li> </ul> </li> <li>\u5c06\u5f97\u5230\u7684 <code>next_token_id</code> \u5b58\u50a8\u5230 FutureMap \u7684 <code>future_indices</code> \u7684\u5bf9\u5e94\u4f4d\u7f6e<ul> <li>\u4e3a\u4e86\u4e0b\u4e00\u6b21 batch \u5728 <code>run_batch</code> \u4e2d\u7684 <code>resolve_future</code> \u83b7\u53d6\u5230\u771f\u6b63\u7684 token</li> </ul> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_3","title":"\u6d41\u540c\u6b65","text":"<ul> <li>decode \u6a21\u5f0f\u4e0b\u524d\u4e00\u6b21 batch \u7684 <code>batch.output_ids</code> \u662f\u540e\u4e00\u6b21 batch \u7684 <code>batch.input_ids</code></li> <li>\u524d\u4e00\u6b21 batch \u7684 <code>output_id</code> \u5b58\u5165 FutureMap \u540e\uff0c\u624d\u4f1a\u6267\u884c\u540e\u4ece FutureMap \u4e2d\u83b7\u53d6\u8fd9\u4e2a <code>output_id</code> \u5e76\u4f5c\u4e3a\u4e0b\u4e00\u6b21 batch \u7684 <code>input_id</code> \u8fdb\u884c\u8ba1\u7b97</li> <li>CUDA Stream \u7684\u672c\u8eab\u7684\u9650\u5236</li> <li>CPU \u4fa7\u4f7f\u7528\u8d1f\u6570\u5360\u4f4d\u7b26\u5b9e\u73b0\uff0c\u7b49\u5f85 GPU \u8fdb\u884c\u771f\u6b63 token \u7684\u586b\u5145</li> </ul> Python<pre><code># previos batch output is negative indices\nbatch.output_ids = -self.future_map.alloc_future_indices(bs).indices\nwith self.forward_stream_ctx:\n    self.forward_stream.wait_stream(self.default_stream)\n    _batch_result = batch_result.delay_sample_func()\n    assert _batch_result is batch_result\n    # store token to negative indices\n    self.future_map.store_to_map(batch_result.future_indices, batch_result)\n    batch_result.copy_to_cpu()\n\n# next batch input is output of previous batch\n\u00a0with self.forward_stream_ctx:\n    self.forward_stream.wait_stream(self.default_stream)\n    # get token from negative indices\n    self.future_map._resolve_future_token_ids(model_worker_batch.input_ids, self.token_ids_buf)\n    batch_result = self.model_worker.forward_batch_generation(\n        model_worker_batch\n    )\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overlap_2","title":"\u4e0e\u4e0a\u4e00\u7248 overlap \u5dee\u5f02","text":"<ul> <li>\u5c06 update_vocab_mask \u79fb\u52a8\u5230 GPU \u8fdb\u884c\u8ba1\u7b97\uff0c<code>vocab_mask</code> \u4e5f\u5728 GPU \u76f4\u63a5\u8fdb\u884c\u5206\u914d\uff0c\u4e0d\u518d\u8fdb\u884c\u4f20\u8f93</li> <li>\u73b0\u5728\u7684 GPU \u989d\u5916\u8d1f\u8d23\u5411 FutureMap \u5b58\u50a8(after sample)\u4ee5\u53ca\u83b7\u53d6(before compute) <code>next_token_ids</code></li> <li>FutureMap \u4e5f\u662f\u5b8c\u5168\u5b58\u50a8\u5728 GPU \u4e0a</li> <li>\u5bf9 GPU \u8c03\u5ea6\u7531\u539f\u6765 CPU \u8fdb\u884c launch\uff0c\u53d8\u6210\u76f4\u63a5\u5c06\u64cd\u4f5c\u63d0\u4ea4\u5230 cuda stream\uff0c\u7531 stream \u81ea\u5df1\u6765\u8c03\u5ea6</li> <li>\u5bf9 sample \u7684\u540c\u6b65\uff0c\u4e0a\u4e00\u7248\u4f7f\u7528 cuda event \u8fdb\u884c\u540c\u6b65\uff0c\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528 cuda stream \u987a\u5e8f\u9650\u5236\u6765\u8fdb\u884c\u540c\u6b65</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_4","title":"\u4e24\u4e2a\u7248\u672c\u7684\u4f18\u7f3a\u70b9","text":"","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#cuda-stream","title":"CUDA stream \u7248\u672c","text":"<ul> <li>\u6267\u884c\u6548\u7387\u66f4\u9ad8\uff1a<code>vocab_mask</code> \u548c <code>token_ids_buf</code> \u65e0 CPU-GPU \u4f20\u8f93\uff1b\u5145\u5206\u5229\u7528 GPU \u5185\u5b58\u5e26\u5bbd</li> <li>\u5ef6\u8fdf\u66f4\u4f4e\uff1a<code>token_ids_buf</code> \u76f4\u63a5\u5728 GPU \u4e0a\u539f\u5730\u4fee\u6539\uff0c\u4e0d\u5fc5\u53cd\u590d\u4f20\u8f93</li> <li>\u4e0e\u6a21\u578b\u63a8\u7406\u5728\u540c\u4e00\u8bbe\u5907\u4e0a\uff0c\u4fbf\u4e8e\u6d41\u6c34\u7ebf</li> <li>\u975e\u6a21\u578b\u5360\u7528\u663e\u5b58\u5927\uff1a<code>token_ids_buf</code> \u5360\u7528 GPU \u663e\u5b58\uff0c\u5f00\u9500\u56fa\u5b9a</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#cpu-launch","title":"CPU launch \u7248\u672c","text":"<ul> <li>\u53ea\u6709\u5728\u4f7f\u7528\u65f6\u624d\u5360\u7528 GPU \u5185\u5b58</li> <li>\u540c\u6b65\u70b9\u589e\u52a0\uff1a<code>vocab_mask</code> \u4f1a\u589e\u52a0\u4e00\u6b21 CPU-GPU \u540c\u6b65</li> <li>CPU-GPU \u540c\u6b65\u4f1a\u7834\u574f\u6d41\u6c34\u7ebf</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#special-tbotow-chunk-overlaptco","title":"Special TBO(Tow Chunk Overlap)[^tco]","text":"<p>Two Batch Overlap\uff08TBO\uff09\u91cc\uff0c\u8c03\u5ea6\u5668\u5c1d\u8bd5\u91cd\u53e0\u4e24\u6279\u6b21\uff08micro-batch\uff09\u6765\u906e\u63a9\u8ba1\u7b97\u548c\u901a\u4fe1\u7b49\u5f00\u9500\uff0c\u4f46\u5f53\u8f93\u5165\u957f\u5ea6\u9ad8\u5ea6\u4e0d\u5747\uff08\u6bd4\u5982\u4e00\u4e2a\u5f88\u957f\uff0c\u4e00\u4e2a\u5f88\u77ed\u6216\u7a7a\uff09\u65f6\uff0c\u4f1a\u51fa\u73b0 \u201cidle batch\u201d\u2014\u2014\u5373\u67d0\u4e2a micro-batch \u6ca1\u6709\u6709\u6548 token \u8981\u5904\u7406\uff0c\u5bfc\u81f4 GPU \u5b58\u5728\u7a7a\u95f2\u65f6\u95f4</p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_5","title":"\u539f\u7406","text":"<p>\u628a\u4e00\u4e2a\u957f\u5e8f\u5217\u667a\u80fd\u62c6\u6210\u4e24\u4e2a chunk \u5e76\u628a\u5b83\u4eec\u5f53\u4f5c\u4e24\u4e2a\u5e76\u884c\u7684 micro-batch \u53bb\u6267\u884c\uff0c\u4ece\u800c\u6d88\u9664\u7a7a\u95f2 micro-batch\u3001\u63d0\u9ad8 GPU \u5229\u7528\u7387\u4e0e\u541e\u5410\u3002\u6bd4\u5982\u628a 3072 \u62c6\u6210 1536 + 1536\uff1a</p> <p>\u7b2c\u4e00\u4e2a chunk \u662f (seq_len=1536, prefix=0) \u7b2c\u4e8c\u4e2a chunk \u662f (seq_len=1536, prefix=1536) \u7b2c\u4e8c\u4e2a chunk \u5728\u903b\u8f91\u4e0a\u662f\u63a5\u7eed\u7b2c\u4e00\u4e2a chunk \u7684\u540e\u534a\u6bb5\uff0c\u4f46\u4f5c\u4e3a\u53e6\u4e00\u4e2a\u5e76\u884c micro-batch \u88ab\u5b89\u6392\uff0c\u4ece\u800c\u907f\u514d\u7a7a\u95f2</p>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#example","title":"Example","text":"Python<pre><code>two batch overlap\ndp0:\nbatch_size = 1, extend_seq_len = [4000], extend_prefix_len = [0, 0].\ndp1-dp31 :\nbatch_size = 2, extend_seq_len = [2000, 2000], extend_prefix_len = [0, 0]\n\ntwo chunk overlap\nextend_seq_len0=[2000], extend_prefix_len0=[0]\nextend_seq_len1=[2000], extend_prefix_len1=[2000]\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#reference","title":"Reference","text":"<p>[^overlap]: Zero-Overhead Batch Scheduler [^overhead]: Can Scheduling Overhead Dominate LLM Inference Performance? A Study of CPU Scheduling Overhead on Two Popular LLM Inference Systems [^code-walk]:  SGLang \u540e\u7aef\u4ee3\u7801\u89e3\u6790 [^tco]: two-chunk overlap for DeepSeekV3/R1</p>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/","title":"\u4e00\u6b65\u6b65\u5b9e\u73b0 CUDA Vector Add \u4f18\u5316","text":"2025-10-212025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#cuda-vector-add","title":"\u4e00\u6b65\u6b65\u5b9e\u73b0 CUDA Vector Add \u4f18\u5316","text":"<p> \u7ea6 2222 \u4e2a\u5b57  284 \u884c\u4ee3\u7801  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 15 \u5206\u949f</p> <p>\ud83d\udcda \u672c\u6587\u5c06\u4ece\u6700\u57fa\u7840\u7684 vector add \u5b9e\u73b0\u5f00\u59cb\uff0c\u4f7f\u7528 nsight compute \u5de5\u5177\u8fdb\u884c\u6027\u80fd\u5206\u6790\u5bfb\u627e\u74f6\u9888\u5e76\u4e00\u6b65\u6b65\u8fdb\u884c\u4f18\u5316\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6765\u5b66\u4e60 CUDA \u7684\u7f16\u7a0b\u548c\u4f18\u5316\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#prerequisite","title":"Prerequisite","text":"","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#arithmetic-intensityai","title":"Arithmetic Intensity(AI)","text":"<p>\u7b97\u672f\u5f3a\u5ea6\u662f\u8861\u91cf\u4e00\u4e2a\u8ba1\u7b97\u4efb\u52a1\uff08\u5982 CUDA Kernel\uff09\u662f\u201c\u8ba1\u7b97\u5bc6\u96c6\u578b\u201d\u8fd8\u662f\u201c\u8bbf\u5b58\u5bc6\u96c6\u578b\u201d\u7684\u6838\u5fc3\u6307\u6807\u3002</p> <p>1. \u5b9a\u4e49\uff1a \u5b83\u88ab\u5b9a\u4e49\u4e3a\u201c\u603b\u5171\u6267\u884c\u7684\u6d6e\u70b9\u8ba1\u7b97\u64cd\u4f5c\u6b21\u6570\u201d\u4e0e\u201c\u603b\u5171\u4f20\u8f93\u7684\u6570\u636e\u5b57\u8282\u6570\u201d\u4e4b\u95f4\u7684\u6bd4\u7387\u3002</p> <ul> <li><code>AI = (\u603b\u8ba1\u7b97\u64cd\u4f5c\u6570) / (\u603b\u8bbf\u5b58\u5b57\u8282\u6570)</code></li> <li>\u5355\u4f4d\uff1a <code>FLOPs/Byte</code> (\u5373\uff0c\u6bcf\u4f20\u8f93\u4e00\u4e2a\u5b57\u8282\u7684\u6570\u636e\uff0c\u80fd\u5bf9\u5e94\u6267\u884c\u591a\u5c11\u6b21\u6d6e\u70b9\u8ba1\u7b97)</li> </ul> <p>2. \u4e3a\u4ec0\u4e48\u5b83\u5982\u6b64\u91cd\u8981\uff1f AI \u51b3\u5b9a\u4e86\u4e00\u4e2a\u7a0b\u5e8f\u7406\u8bba\u4e0a\u7684\u6027\u80fd\u74f6\u9888\u3002\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u5bf9\u6bd4\u4e00\u4e2a\u7a0b\u5e8f\u548c\u4e00\u4e2a\u786c\u4ef6\uff08GPU\uff09\u7684\u7279\u6027\uff1a</p> <ul> <li>\u786c\u4ef6\u7684\u201cAI\u201d\uff1aGPU \u4e5f\u6709\u4e00\u4e2a\u5e73\u8861\u70b9\uff0c\u5373\u5b83\u7684 <code>\u5cf0\u503c\u8ba1\u7b97\u80fd\u529b (GFLOPs/s)</code> / `\u5cf0\u503c\u5185\u5b58\u5e26\u5bbd (GB/s)</li> <li>\u7a0b\u5e8f\u7684 AI\uff1a\u5185\u6838\u7684 <code>FLOPs / Bytes</code>\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#roofline","title":"Roofline","text":"<p>Roofline \u6a21\u578b\uff08\u5c4b\u9876\u7ebf\u6a21\u578b\uff09\u662f\u4e00\u79cd\u7528\u6765\u5206\u6790\u7a0b\u5e8f\u6027\u80fd\u74f6\u9888\uff08\u8ba1\u7b97\u53d7\u9650\u8fd8\u662f\u5e26\u5bbd\u53d7\u9650\uff09\u7684\u65b9\u6cd5\u3002\\ \u5b83\u628a\u8ba1\u7b97\u6027\u80fd\uff08FLOPs/s\uff09\u548c\u8bbf\u5b58\u6027\u80fd\uff08Bytes/s\uff09\u8054\u7cfb\u5728\u4e00\u8d77\uff0c\u3002\u4ee5\u53ef\u89c6\u5316\u7684\u65b9\u5f0f\u5c55\u793a\u6027\u80fd\u4e0a\u9650</p> \\[ Achievable\u00a0FLOPs=min(AI\u00d7Memory\u00a0BW,Peak\u00a0FLOPs) \\] <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#stall-in-ncu","title":"Stall in NCU","text":"\u7c7b\u578b \u4ee3\u8868\u7b49\u5f85 \u5178\u578b\u74f6\u9888 \u4f18\u5316\u65b9\u5411 All Scoreboard \u6240\u6709\u4f9d\u8d56\u672a\u6ee1\u8db3 \u5b8c\u5168\u7b49\u5f85 \u63d0\u9ad8\u5e76\u53d1\u3001\u5f02\u6b65\u8bbf\u95ee Long Scoreboard DRAM \u8bbf\u95ee\u672a\u8fd4\u56de \u5185\u5b58\u5ef6\u8fdf \u4f18\u5316\u8bbf\u5b58\u3001\u5171\u4eab\u5185\u5b58 Short Scoreboard L1/\u5bc4\u5b58\u5668\u4f9d\u8d56 \u6570\u636e\u4f9d\u8d56 \u8c03\u6574\u6307\u4ee4\u987a\u5e8f Execution Dependency \u7b97\u672f\u6307\u4ee4\u7ed3\u679c\u672a\u5c31\u7eea \u8fd0\u7b97\u94fe\u957f \u589e\u52a0 ILP Barrier/Branch \u540c\u6b65\u6216\u5206\u652f\u7b49\u5f85 \u63a7\u5236\u6d41 \u51cf\u5c11\u5206\u652f/\u540c\u6b65","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#baseline","title":"baseline","text":"C++<pre><code>// FP32\n// ElementWise Add grid(N/256),\n// block(256) a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)\n__global__ void vector_add_kernel(const float *a, const float *b, float *c,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 int n) {\n\u00a0 int idx = blockIdx.x * blockDim.x + threadIdx.x;\n\u00a0 if (idx &lt; n) {\n\u00a0 \u00a0 c[idx] = a[idx] + b[idx];\n\u00a0 }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_1","title":"\u5206\u6790","text":"<p>\u8be5\u7248\u672c\u7684 vector add\uff0c\u6267\u884c\u4e00\u6b21\u8ba1\u7b97\u9700\u8981\u4e09\u6b21\u8bbf\u5b58\uff0c\u6bcf\u6b21\u8bfb 4 bytes (read A, read B, write C)</p> \\[ AI = 1 / (3 \\\\times 4) =1/12\\\\approx 0.083 \\] <p>\u8bf4\u660e\u8fd9\u662f\u4e00\u4e2a memory-bound \u7684\u7a0b\u5e8f</p> <ul> <li>\u67e5\u770b ncu \u7684 SLO \u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u786e\u5b9e\u5185\u5b58\u8fbe\u5230\u5cf0\u503c\u6027\u80fd\u7684 90% \u4ee5\u4e0a</li> </ul> <p></p> <ul> <li>\u67e5\u770b Memory Workload Analysis\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u6211\u4eec\u5b8c\u5168\u6ca1\u6709\u7528\u5230 shared memory\uff0c\u76f4\u63a5\u7528 L2 Cache \u548c L1 Cache</li> </ul> <p></p> <ul> <li>Kernel \u7684\u4e3b\u8981\u74f6\u9888\u662f <code>Stall Long Scoreboard</code>\u2014\u2014\u5373\u5185\u5b58\u5ef6\u8fdf\u505c\u987f\u3002GPU \u9690\u85cf\u8fd9\u79cd\u201c\u7b49\u5f85\u201d\u7684\u552f\u4e00\u673a\u5236\uff0c\u5c31\u662f Occupancy (\u5360\u7528\u7387)</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#optimization-v1-vectorized-access","title":"Optimization V1 -- vectorized access","text":"","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_2","title":"\u4f18\u5316","text":"<ul> <li>\u77e2\u91cf\u5316\u5185\u5b58\u8bbf\u95ee\uff1a\u6211\u4eec\u4e0d\u518d\u4e00\u6b21\u8bfb\u53d6\u4e00\u4e2a float\uff0c\u800c\u662f\u540c\u65f6\u53d6 4 \u4e2a float\uff0c\u4e00\u4e2a wrap \u91cc\u9762\u7684\u6240\u6709\u7ebf\u7a0b\u540c\u65f6\u83b7\u53d6 4 float\uff0c\u53ef\u4ee5\u53d8\u4e3a LDG.128 \u4e00\u6b21\u6027\u83b7\u53d6 128 bit \u6570\u636e</li> <li>\u26a0 \u8fd9\u91cc\u6709\u4e2a trade-off\uff0c\u5982\u679c\u6211\u4eec\u6bcf\u4e2a thread \u4f7f\u7528\u4e86\u8fc7\u591a\u7684\u5bc4\u5b58\u5668\uff0c\u90a3\u4e48 SM \u4e0a\u6d3b\u8dc3\u7684 Warp \u4f1a\u53d8\u5c11\uff0c\u5bfc\u81f4 Occupany \u4f1a\u4e0b\u964d\uff0c\u8fd9\u540c\u6837\u5bf9\u6027\u80fd\u5f71\u54cd\u5f88\u5927</li> </ul> C++<pre><code>// ElementWise Add + Vec4\n// grid(N/256), block(256/4)\n// a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)\n__global__ void vector_add_kernel_vec4(const float *a, const float *b, float *c,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0int n) {\n\u00a0 int idx = (blockIdx.x * blockDim.x + threadIdx.x) * 4;\n\u00a0 if (idx &lt; n) {\n\u00a0 \u00a0 float4 a_vec = FLOAT4(a); // registers\n\u00a0 \u00a0 float4 b_vec = FLOAT4(b);\n\u00a0 \u00a0 float4 c_vec;\n\u00a0 \u00a0 c_vec.x = a_vec.x + b_vec.x;\n\u00a0 \u00a0 c_vec.y = a_vec.y + b_vec.y;\n\u00a0 \u00a0 c_vec.z = a_vec.z + b_vec.z;\n\u00a0 \u00a0 c_vec.w = a_vec.w + b_vec.w;\n\u00a0 \u00a0 FLOAT4(c[idx]) = c_vec;\n\u00a0 }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_3","title":"\u5206\u6790","text":"<ul> <li> <p>\u901a\u8fc7\u8fd9\u79cd\u4f18\u5316\u540e\uff0c\u6211\u4eec\u5df2\u7ecf\u5c06\u5185\u5b58\u5408\u5e76\u8bbf\u95ee\uff0cMemory \u7684\u6548\u7387\u5df2\u7ecf\u63d0\u5347\u4e86\uff0c\u4f46\u662f Compute \u6548\u7387\u8fd8\u662f\u5f88\u4f4e</p> </li> <li> <p>\u65f6\u95f4\u51e0\u4e4e\u76f8\u540c\uff1a21.66 \u03bcs \u2192 21.25 \u03bcs\u3002</p> </li> <li> <p>\u5185\u5b58\u5e26\u5bbd\u5229\u7528\u7387\u90fd\u9ad8 (~96%)\uff1a\u8bf4\u660e\u4e24\u8005\u90fd\u88ab memory-bound \u9650\u5236\uff0c\u800c\u975e\u7b97\u529b\u74f6\u9888\u3002</p> </li> <li> <p>Compute Throughput \u53cd\u800c\u4e0b\u964d\uff0814% \u2192 3.6%\uff09\uff0c\u56e0\u4e3a\u76f8\u540c\u7684\u6570\u636e\u91cf\u4e0b\uff0c<code>float4</code> \u7248\u672c\u9700\u8981\u66f4\u5c11\u7684\u6307\u4ee4\uff0c\u56e0\u6b64\u7b97\u672f\u90e8\u5206\u76f8\u5bf9\u5360\u6bd4\u53d8\u5c0f\u3002</p> </li> <li> <p>\uff1a\u5411\u91cf\u5316\u8bbf\u95ee (<code>float4</code>) \u4f18\u5316\u4e86\u8bbf\u5b58\u6548\u7387\uff08\u4e00\u6b21\u8bfb\u53d6 4 \u4e2a float\uff09\uff0c\u4f46\u603b\u5185\u5b58\u5e26\u5bbd\u5df2\u63a5\u8fd1\u9971\u548c\uff0c\u6240\u4ee5\u6027\u80fd\u63d0\u5347\u6709\u9650\u3002</p> </li> </ul> <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#optimization-v2-fp16-compute","title":"Optimization V2 -- fp16 compute","text":"","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_4","title":"\u4f18\u5316","text":"<ul> <li>\u5728 30 \u7cfb\u53ca\u4ee5\u4e0a\u663e\u5361\uff0c\u5bf9 fp16 \u548c fp32 \u7684\u8ba1\u7b97\u51e0\u4e4e\u65e0\u5dee\u522b\uff0c\u90fd\u4f7f\u7528\u76f8\u540c\u7684 ALU \u8fdb\u884c\u8ba1\u7b97\uff0c\u4f46\u662f fp16 \u6bcf\u6b21\u5b58\u53d6\u6bd4 fp32 \u5c11\u4e00\u822c\u7684\u5185\u5b58\uff0c\u6240\u4ee5\u53ef\u4ee5\u8282\u7701\u5185\u5b58\u5e26\u5bbd\uff0c\u4ece\u800c\u5927\u5e45\u63d0\u9ad8\u6548\u7387</li> <li>FP16 \u8ba1\u7b97\uff1a\u6211\u4eec\u4f7f\u7528\u7684\u662f RTX Titan\uff0c\u8be5\u663e\u5361 fp16 \u7684\u8ba1\u7b97 FLOPS \u662f fp32 \u7684 2 \u500d\u5de6\u53f3</li> </ul> C++<pre><code>// FP16\n// ElementWise Add grid(N/256),\n// block(256) a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)\n__global__ void elementwise_add_f16_kernel(half *a, half *b, half *c, int N) {\n\u00a0 int idx = blockIdx.x * blockDim.x + threadIdx.x;\n\u00a0 if (idx &lt; N)\n\u00a0 \u00a0 c[idx] = __hadd(a[idx], b[idx]);\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_5","title":"\u5206\u6790","text":"\\[ AI = \\\\frac{1 FLOPs}{2 * 3 Bytes} = 1/6 \\\\approx 0.17 FLOPs /Byte \\] <p>\u26a0 fp16 \u8ba1\u7b97\u7684\u7cbe\u5ea6\u4f1a\u6bd4 fp32 \u4f4e\u5f88\u591a\uff0c\u9700\u8981\u8003\u8651\u5e94\u7528\u7684\u573a\u666f\u662f\u5426\u53ef\u4ee5\u63a5\u53d7\uff0c\u6d4b\u8bd5\u53d1\u73b0\u57fa\u672c\u7cbe\u5ea6\u5728 0.2 \u4ee5\u4e0b</p> <ul> <li>Memory Throughput \u4e0b\u964d (96%\u219271%)\uff1aFP16 \u6570\u636e\u91cf\u53ea\u6709 float \u7684\u4e00\u534a\uff0c\u663e\u5b58\u4f20\u8f93\u538b\u529b\u5c0f\u3002</li> <li>Compute Throughput \u4e0a\u5347 (14%\u219222%)\uff1a\u867d\u7136\u6570\u636e\u53d8\u5c0f\uff0c\u4f46 ALU \u5bf9 FP16 \u5904\u7406\u66f4\u5feb\uff08\u90e8\u5206\u67b6\u6784\u53ef\u53cc\u53d1\u5c04\u6216\u66f4\u9ad8\u5bc6\u5ea6\u5904\u7406\uff09\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#optimization-v3-fp16-more-compute-per-thread","title":"Optimization V3 -- fp16 + more compute per thread","text":"","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_6","title":"\u4f18\u5316","text":"<ul> <li><code>half2</code> \u53cc\u6253\u5305\u4e00\u6b21\u8bbf\u95ee\u4e24\u500d\u6570\u636e\u91cf</li> <li>\u8282\u7701\u4e86\u5185\u5b58\u5e26\u5bbd</li> <li>\u644a\u9500\u7b97\u672f\u6210\u672c</li> </ul> C++<pre><code>__global__ void elementwise_add_f16x2_kernel(half *a, half *b, half *c, int N) {\n\u00a0 int idx = 2 * (blockIdx.x * blockDim.x + threadIdx.x);\n\u00a0 if (idx &lt; N) {\n\u00a0 \u00a0 half2 reg_a = HALF2(a[idx]);\n\u00a0 \u00a0 half2 reg_b = HALF2(b[idx]);\n\u00a0 \u00a0 half2 reg_c;\n\u00a0 \u00a0 reg_c.x = __hadd(reg_a.x, reg_b.x);\n\u00a0 \u00a0 reg_c.y = __hadd(reg_a.y, reg_b.y);\n\u00a0 \u00a0 HALF2(c[idx]) = reg_c;\n\u00a0 }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_7","title":"\u5206\u6790","text":"\\[ AI = \\\\frac{2\\*(\\_hadd) FLOPs}{4 * 3 Bytes} = 1/6 \\\\approx 0.17 FLOPs /Byte \\] <ul> <li>\u6267\u884c\u65f6\u95f4\u7ee7\u7eed\u4e0b\u964d\uff1a13.41 \u03bcs \u2192 11.17 \u03bcs</li> <li>Memory Throughput \u6062\u590d\u4e0a\u5347 (71%\u219287%)\uff1a<code>half2</code> \u53cc\u6253\u5305\u4e00\u6b21\u8bbf\u95ee\u4e24\u500d\u6570\u636e\u91cf\uff0c\u8bbf\u95ee\u6548\u7387\u63d0\u5347\u3002</li> <li>Compute Throughput \u7565\u964d (22%\u219214%)\uff1a\u7b97\u672f\u8d1f\u8f7d\u88ab\u644a\u8584\uff08\u8ba1\u7b97\u91cf\u5c11\uff0c\u4f46\u8bbf\u5b58\u66f4\u5feb\uff09\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#optimization-v4-fp16-more-compute-per-thread-memory-alignment","title":"Optimization V4 -- fp16 + more compute per thread + memory alignment","text":"","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_8","title":"\u4f18\u5316","text":"<ul> <li>\u5185\u5b58\u5bf9\u9f50 128 bit\uff0c\u53ef\u4ee5\u77e2\u91cf\u5316\u8bbf\u95ee\u5185\u5b58\uff0c\u51cf\u5c11\u6307\u4ee4\u6570</li> <li>\u6bcf\u4e2a\u7ebf\u7a0b\u4e00\u6b21\u5904\u7406 8 \u4e2a half\uff08\u5373 4 \u6b21 <code>__hadd2</code>\uff09\uff0c\u52a0\u4e0a <code>#pragma unroll</code> \u2192 \u5c55\u5f00\u5faa\u73af\uff0c\u907f\u514d\u5206\u652f\u5f00\u9500</li> </ul> \u4f18\u5316\u7ef4\u5ea6 \u666e\u901a\u7248\u672c\uff08__hadd\uff09 \u4f18\u5316\u7248\uff08__hadd2 + pack\uff09 \u6027\u80fd\u6548\u679c \u8ba1\u7b97\u6a21\u5f0f \u6bcf\u6b21\u7b97 1 \u4e2a half \u6bcf\u6b21\u7b97 2 \u4e2a half \u2705 \u8ba1\u7b97\u541e\u5410\u63d0\u5347\u7ea6 2\u00d7 \u5bc4\u5b58\u5668\u5229\u7528\u7387 \u8f83\u5206\u6563\uff0c\u6307\u4ee4\u4f9d\u8d56\u591a \u66f4\u8fde\u7eed\uff0c\u6307\u4ee4\u590d\u7528\u7387\u9ad8 \u2705 \u63d0\u9ad8 ILP\u3001\u51cf\u5c11 stall warp \u6548\u7387 \u8bbf\u5b58\u6307\u4ee4\u591a\uff0cwarp \u5e38\u7b49\u5f85 warp \u5185\u8bbf\u5b58\u5bf9\u9f50\u4e00\u81f4 \u2705 warp active cycles \u66f4\u9ad8 C++<pre><code>__global__ void elementwise_add_f16x8_pack_kernel(half *a, half *b, half *c, int N) {\n  int idx = 8 * (blockIdx.x * blockDim.x + threadIdx.x);\n  // temporary register(memory), .local space in ptx, addressable\n  half pack_a[8], pack_b[8], pack_c[8]; // 8x16 bits=128 bits.\n  // reinterpret as float4 and load 128 bits in 1 memory issue.\n  LDST128BITS(pack_a[0]) = LDST128BITS(a[idx]); // load 128 bits\n  LDST128BITS(pack_b[0]) = LDST128BITS(b[idx]); // load 128 bits\n#pragma unroll\n  for (int i = 0; i &lt; 8; i += 2) {\n    // __hadd2 for half2 x 4\n    HALF2(pack_c[i]) = __hadd2(HALF2(pack_a[i]), HALF2(pack_b[i]));\n  }\n  // reinterpret as float4 and store 128 bits in 1 memory issue.\n  if ((idx + 7) &lt; N) {\n    LDST128BITS(c[idx]) = LDST128BITS(pack_c[0]);\n  } else {\n    for (int i = 0; idx + i &lt; N; i++) {\n      c[idx + i] = __hadd(a[idx + i], b[idx + i]);\n    }\n  }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_9","title":"\u5206\u6790","text":"\\[ AI = \\\\frac{4\\*(\\_hadd2) FLOPs}{16 * 3 Bytes} = 1/6 \\\\approx 0.17 FLOPs /Byte \\] <ul> <li>\u4e00\u6b21\u52a0\u8f7d 128 bit \u6570\u636e\uff0c\u51cf\u5c11\u5185\u5b58\u4e8b\u52a1\u6570\u91cf\uff0c\u8282\u7701\u65f6\u95f4</li> <li>\u5355\u4e2a\u7ebf\u7a0b\u7684\u5de5\u4f5c\u91cf\u63d0\u5347</li> <li>\u5b9e\u9645 benchmark \u548c profile \u53d1\u73b0\uff0c\u5728 RTX Titan \u663e\u5361\u4e0a\uff0c\u5bf9\u4e8e 1M \u5927\u5c0f\u7684\u6570\u636e\u8fd9\u4e2a\u7b97\u5b50\u7684\u5b9e\u9645 Occupancy \u6bd4 <code>fp16x2</code> \u7b97\u5b50\u66f4\u5c11\uff0c\u52a0\u901f\u6548\u679c\u7565\u4e0d\u660e\u663e</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#summary","title":"Summary","text":"<p>vector add \u7b97\u5b50\u662f\u4e00\u4e2a\u5178\u578b\u7684 memory-bound \u7684\u7b97\u5b50\uff0c\u6211\u4eec\u9700\u8981\u5c3d\u53ef\u80fd\u8282\u7701\u5185\u5b58\u5e26\u5bbd\u5e76\u63d0\u9ad8\u8ba1\u7b97\u6548\u7387\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u4f7f\u7528 benchmark \u6d4b\u8bd5\u6240\u6709\u7b97\u5b50\u7684\u5f00\u9500\uff0c\u89c2\u5bdf\u548c\u6211\u4eec\u7684\u5206\u6790\u54ea\u91cc\u4e0d\u540c</p>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#1-vs-kernel-launch-overhead","title":"\u6d1e\u5bdf 1\uff1a\u95ee\u9898\u89c4\u6a21 vs. \u542f\u52a8\u5f00\u9500 (Kernel Launch Overhead)","text":"<p>\u8fd9\u4e2a\u6d4b\u8bd5\u5b8c\u7f8e\u5730\u5c55\u793a\u4e86\u4e3a\u4ec0\u4e48 GPU \u4e0d\u9002\u5408\u5904\u7406\u201c\u5c0f\u4efb\u52a1\u201d\u3002</p> <ul> <li> <p>**\u5728 1K (N=1024) \u65f6\uff1aCPU \u83b7\u80dc</p> </li> <li> <p>CPU Time: 0.0030 ms</p> </li> <li> <p>GPU (\u6700\u5feb): 0.0078 ms</p> </li> <li> <p>\u539f\u56e0\uff1a \u8c03\u7528\u4e00\u4e2a CUDA \u5185\u6838\uff08<code>__global__ void</code>\uff09\u672c\u8eab\u5c31\u6709\u56fa\u5b9a\u7684\u5f00\u9500\uff08<code>Kernel Launch Overhead</code>\uff09\uff0c\u8fd9\u4e2a\u5f00\u9500\u901a\u5e38\u9700\u8981\u51e0\u4e2a\u5fae\u79d2 (microseconds)\u3002\u5bf9\u4e8e 1K \u8fd9\u6837\u7684\u5c0f\u95ee\u9898\uff0cGPU \u5b9e\u9645\u6267\u884c\u8ba1\u7b97\u7684\u65f6\u95f4\uff08\u53ef\u80fd\u53ea\u6709 1-2 \u5fae\u79d2\uff09\u8fdc\u5c0f\u4e8e\u542f\u52a8\u5b83\u6240\u82b1\u8d39\u7684\u65f6\u95f4\uff085-6 \u5fae\u79d2\uff09\u3002CPU \u76f4\u63a5\u5728\u672c\u5730\u6267\u884c\u5faa\u73af\uff0c\u6ca1\u6709\u4efb\u4f55\u542f\u52a8\u5f00\u9500\uff0c\u6240\u4ee5\u66f4\u5feb\u3002</p> </li> <li> <p>\u5728 1M (N=1048576) \u65f6\uff1aGPU \u5b8c\u80dc</p> </li> <li> <p>CPU Time: 3.0058 ms</p> </li> <li>GPU (\u6700\u5feb): 0.0132 ms (\u5373 <code>GPU FP16 x2</code> \u7248\u672c)</li> <li>\u539f\u56e0\uff1a \u5f53\u95ee\u9898\u89c4\u6a21\u53d8\u5f97\u8db3\u591f\u5927\u65f6\uff0c\u5927\u89c4\u6a21\u5e76\u884c\uff08Massive Parallelism\uff09\u7684\u4f18\u52bf\u5f00\u59cb\u663e\u73b0\u3002\u542f\u52a8\u5185\u6838\u7684 5-6 \u5fae\u79d2\u5f00\u9500\u5728\u603b\u5171 13.2 \u5fae\u79d2\u7684\u6267\u884c\u65f6\u95f4\u4e2d\u53d8\u5f97\u5fae\u4e0d\u8db3\u9053\u3002\u6b64\u65f6\uff0cGPU \u7684\u5de8\u5927\u5185\u5b58\u5e26\u5bbd\uff08<code>GPU FP16 x2</code> \u8fbe\u5230\u4e86 475.7 GB/s\uff09\u5f7b\u5e95\u51fb\u8d25\u4e86 CPU \u7684\u5185\u5b58\u5e26\u5bbd\uff08\u88ab\u9650\u5236\u5728 4.2 GB/s\uff09\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#2-memory-bound","title":"\u6d1e\u5bdf 2\uff1a\u5185\u5b58\u5e26\u5bbd\u662f\u74f6\u9888 (Memory-Bound)","text":"<p>\u9010\u5143\u7d20\u52a0\u6cd5\uff08Vector Addition\uff09\u662f\u4e00\u4e2a\u7ecf\u5178\u7684**\u5185\u5b58\u5e26\u5bbd\u53d7\u9650\uff08Memory-Bound\uff09**\u95ee\u9898\uff0c\u5b83\u7684\u8ba1\u7b97\u5bc6\u96c6\u5ea6 (AI) \u6781\u4f4e\u3002\u8fd9\u610f\u5473\u7740\u6027\u80fd\u7684\u74f6\u9888\u662f**\u4f60\u80fd\u591a\u5feb\u5730\u4ece\u663e\u5b58\u4e2d\u8bfb\u53d6 a \u548c b\uff0c\u5e76\u5199\u56de c\u3002</p> <p>\u8fd9\u4e2a\u6d4b\u8bd5\u7ed3\u679c\u6e05\u695a\u5730\u8bc1\u660e\u4e86\u8fd9\u4e00\u70b9\uff1a</p> <ul> <li> <p>**FP32 vs. FP16 (\u5728 1M \u6570\u636e\u96c6)</p> </li> <li> <p><code>GPU Standard</code> (FP32): 0.0250 ms</p> </li> <li> <p><code>GPU FP16 Std</code>: 0.0163 ms</p> </li> <li> <p>\u539f\u56e0\uff1a FP32 \u5185\u6838\u9700\u8981\u79fb\u52a8\u7684\u6570\u636e\u91cf\u662f \\(1M \\\\times (4+4+4) = 12 \\\\text{ MB}\\)\u3002\u800c FP16 \u5185\u6838\u53ea\u9700\u8981\u79fb\u52a8 \\(1M \\\\times (2+2+2) = 6 \\\\text{ MB}\\)\u3002</p> </li> <li> <p>\u6570\u636e\u91cf\u51cf\u534a\uff0c\u6027\u80fd\u51e0\u4e4e\u7ffb\u500d\uff08<code>0.0250 / 0.0163 = 1.53x</code> \u52a0\u901f\uff09\u3002\u8fd9\u8bc1\u5b9e\u4e86\u74f6\u9888\u5728\u5185\u5b58\uff0c\u800c\u4e0d\u662f\u8ba1\u7b97\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#3baseline","title":"\u6d1e\u5bdf 3\uff1abaseline \u5b9e\u73b0\u5728\u8f83\u5c0f\u7684\u95ee\u9898\u89c4\u6a21\u4e0b\u5df2\u8db3\u591f\u597d","text":"<ul> <li>\u5728\u6570\u636e\u5c0f\u4e8e 64K \u5927\u5c0f\u7684\u60c5\u51b5\u4e0b\uff0cbaseline \u662f\u6700\u4f18\u7684\u65b9\u6cd5</li> </ul> Bash<pre><code>========== Testing 1K (N=1024) ==========\n--- Speedup Analysis ---\nStandard vs Vec4:       0.98x\nStandard vs FP16:       0.98x\nStandard vs FP16x2:     0.97x\nStandard vs FP16x8:     0.95x\nStandard vs FP16x8_pack:  0.99x\n\n========== Testing 4K (N=4096) ==========\n--- Speedup Analysis ---\nStandard vs Vec4:       1.02x\nStandard vs FP16:       0.78x\nStandard vs FP16x2:     0.79x\nStandard vs FP16x8:     0.75x\nStandard vs FP16x8_pack:  0.76x\n\n========== Testing 16K (N=16384) ==========\n--- Speedup Analysis ---\nStandard vs Vec4:       1.00x\nStandard vs FP16:       0.99x\nStandard vs FP16x2:     0.99x\nStandard vs FP16x8:     0.87x\nStandard vs FP16x8_pack:  0.91x\n\n\n========== Testing 64K (N=65536) ==========\n--- Speedup Analysis ---\nStandard vs Vec4:       0.96x\nStandard vs FP16:       0.98x\nStandard vs FP16x2:     1.00x\nStandard vs FP16x8:     0.92x\nStandard vs FP16x8_pack:  0.88x\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#41m-fp16-x2","title":"\u6d1e\u5bdf 4\uff1a1M \u6570\u636e\u6d4b\u8bd5\u4e0b <code>FP16 x2</code> \u662f\u6700\u4f73\u7684 \"\u5de5\u4f5c\u7c92\u5ea6\"","text":"<p>\u5728\u6700\u5927\u7684 1M \u6d4b\u8bd5\u4e2d\uff0c\u6211\u4eec\u770b FP16 \u7684\u5404\u79cd\u5b9e\u73b0\uff1a</p> <ol> <li><code>GPU FP16 x2</code>: 0.0132 ms (\ud83c\udfc6)</li> <li><code>GPU FP16 x8_pack</code>: 0.0158 ms</li> <li><code>GPU FP16 x8</code>: 0.0161 ms</li> <li><code>GPU FP16 Std</code>: 0.0163 ms</li> </ol> <ul> <li><code>FP16 Std</code> (1 \u7ebf\u7a0b/1 \u5143\u7d20) \u662f\u6700\u6162\u7684\uff0c\u56e0\u4e3a\u5b83\u6700\u6734\u7d20\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u53ea\u505a\u4e86\u6700\u5c11\u7684\u5de5\u4f5c\uff0c\u8c03\u5ea6\u7684\u5f00\u9500\u76f8\u5bf9\u6700\u5927\u3002</li> <li><code>FP16 x8</code> \u548c <code>x8_pack</code> (1 \u7ebf\u7a0b/8 \u5143\u7d20) \u8868\u73b0\u66f4\u597d\uff0c\u56e0\u4e3a\u5b83\u4eec\u8ba9\u6bcf\u4e2a\u7ebf\u7a0b\u505a\u4e86\u66f4\u591a\u5de5\u4f5c\uff0c\u51cf\u5c11\u4e86\u603b\u7684\u8c03\u5ea6\u5f00\u9500\u5e76\u4f7f\u7528\u4e86\u5411\u91cf\u5316\u6307\u4ee4\uff08\u5982 Nsight \u5206\u6790\u6240\u793a\uff09\u3002</li> <li><code>FP16 x2</code> \u4e3a\u4ec0\u4e48\u66f4\u4f18\uff1f</li> <li><code>FP16 x2</code> \u5185\u6838\u4f7f\u7528\u4e86 <code>half2</code> \u6570\u636e\u7c7b\u578b\u8fdb\u884c\u52a0\u8f7d\u3002\u800c <code>x8_pack</code> \u4f7f\u7528\u7684\u662f 128-bit (<code>float4</code>) \u64cd\u4f5c\u3002</li> <li>\u5728\u8fd9\u4e2a\u7279\u5b9a\u7684\u6d4b\u8bd5\u4e2d\uff0c<code>half2</code> \u8fbe\u5230\u4e86\u201c\u5de5\u4f5c\u7c92\u5ea6\u201d\u548c\u201c\u786c\u4ef6\u4eb2\u548c\u6027\u201d\u7684 sweet spot\u3002\u5b83\u6bd4 <code>x8_pack</code> \u66f4\u7b80\u5355\uff0c\u9700\u8981\u66f4\u5c11\u7684\u5bc4\u5b58\u5668(<code>x8_pack</code> \u9700\u8981 22 \u4e2a\uff0c\u800c <code>x2</code>\u53ea\u9700\u8981 16 \u4e2a)\uff0c\u5b9e\u9645\u5360\u7528\u7387 (Achieved Occupancy)\u66f4\u9ad8\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/Vector%20Add%20Optimization%20Example/#_10","title":"\u9644\u5f55","text":"Bash<pre><code>Vector Addition Performance Test\n================================\n\n========== Testing 1K (N=1024) ==========\nMismatch at index 2: 2.39844 != 2.4 (error: 0.0015626)\nCorrectness: FAIL (Max error: 0.037506)\nArray Size: 1024 elements (0.00 GB)\n\n--- Execution Times (Kernel Only) ---\nCPU Time:           0.0030 ms (Bandwidth:    4.1 GB/s)\nGPU Standard:       0.0078 ms (Bandwidth:    1.6 GB/s)\nGPU Vec4:           0.0079 ms (Bandwidth:    1.5 GB/s)\nGPU FP16 Std:       0.0079 ms (Bandwidth:    0.8 GB/s)\nGPU FP16 x2:        0.0080 ms (Bandwidth:    0.8 GB/s)\nGPU FP16 x8:        0.0082 ms (Bandwidth:    0.8 GB/s)\nGPU FP16 x8_pack:   0.0078 ms (Bandwidth:    0.8 GB/s)\n\n--- Speedup Analysis ---\nCPU vs GPU Standard:    0.39x\nCPU vs GPU Vec4:        0.38x\nCPU vs GPU FP16:        0.38x\nCPU vs GPU FP16x2:      0.38x\nCPU vs GPU FP16x8:      0.37x\nCPU vs GPU FP16x8_pack:  0.39x\nStandard vs Vec4:       0.98x\nStandard vs FP16:       0.98x\nStandard vs FP16x2:     0.97x\nStandard vs FP16x8:     0.95x\nStandard vs FP16x8_pack:  0.99x\nFP16 vs FP16x2:         0.99x\nFP16x2 vs FP16x8:       0.98x\nFP16x8 vs FP16x8_pack:  1.05x\n\n========== Testing 4K (N=4096) ==========\nMismatch at index 0: 9.60156 != 9.6 (error: 0.00156212)\nCorrectness: FAIL (Max error: 0.037506)\nArray Size: 4096 elements (0.00 GB)\n\n--- Execution Times (Kernel Only) ---\nCPU Time:           0.0120 ms (Bandwidth:    4.1 GB/s)\nGPU Standard:       0.0060 ms (Bandwidth:    8.1 GB/s)\nGPU Vec4:           0.0059 ms (Bandwidth:    8.3 GB/s)\nGPU FP16 Std:       0.0077 ms (Bandwidth:    3.2 GB/s)\nGPU FP16 x2:        0.0077 ms (Bandwidth:    3.2 GB/s)\nGPU FP16 x8:        0.0081 ms (Bandwidth:    3.0 GB/s)\nGPU FP16 x8_pack:   0.0080 ms (Bandwidth:    3.1 GB/s)\n\n--- Speedup Analysis ---\nCPU vs GPU Standard:    1.98x\nCPU vs GPU Vec4:        2.01x\nCPU vs GPU FP16:        1.55x\nCPU vs GPU FP16x2:      1.56x\nCPU vs GPU FP16x8:      1.48x\nCPU vs GPU FP16x8_pack:  1.50x\nStandard vs Vec4:       1.02x\nStandard vs FP16:       0.78x\nStandard vs FP16x2:     0.79x\nStandard vs FP16x8:     0.75x\nStandard vs FP16x8_pack:  0.76x\nFP16 vs FP16x2:         1.01x\nFP16x2 vs FP16x8:       0.95x\nFP16x8 vs FP16x8_pack:  1.01x\n\n========== Testing 16K (N=16384) ==========\nMismatch at index 0: 38.4062 != 38.4 (error: 0.00624847)\nCorrectness: FAIL (Max error: 0.100006)\nArray Size: 16384 elements (0.00 GB)\n\n--- Execution Times (Kernel Only) ---\nCPU Time:           0.0472 ms (Bandwidth:    4.2 GB/s)\nGPU Standard:       0.0044 ms (Bandwidth:   45.1 GB/s)\nGPU Vec4:           0.0044 ms (Bandwidth:   45.1 GB/s)\nGPU FP16 Std:       0.0044 ms (Bandwidth:   22.4 GB/s)\nGPU FP16 x2:        0.0044 ms (Bandwidth:   22.4 GB/s)\nGPU FP16 x8:        0.0050 ms (Bandwidth:   19.5 GB/s)\nGPU FP16 x8_pack:   0.0048 ms (Bandwidth:   20.4 GB/s)\n\n--- Speedup Analysis ---\nCPU vs GPU Standard:   10.82x\nCPU vs GPU Vec4:       10.82x\nCPU vs GPU FP16:       10.74x\nCPU vs GPU FP16x2:     10.75x\nCPU vs GPU FP16x8:      9.36x\nCPU vs GPU FP16x8_pack:  9.80x\nStandard vs Vec4:       1.00x\nStandard vs FP16:       0.99x\nStandard vs FP16x2:     0.99x\nStandard vs FP16x8:     0.87x\nStandard vs FP16x8_pack:  0.91x\nFP16 vs FP16x2:         1.00x\nFP16x2 vs FP16x8:       0.87x\nFP16x8 vs FP16x8_pack:  1.05x\n\n========== Testing 64K (N=65536) ==========\nMismatch at index 0: 53.5938 != 53.6 (error: 0.00625229)\nCorrectness: FAIL (Max error: 0.100006)\nArray Size: 65536 elements (0.00 GB)\n\n--- Execution Times (Kernel Only) ---\nCPU Time:           0.1875 ms (Bandwidth:    4.2 GB/s)\nGPU Standard:       0.0096 ms (Bandwidth:   82.3 GB/s)\nGPU Vec4:           0.0099 ms (Bandwidth:   79.3 GB/s)\nGPU FP16 Std:       0.0097 ms (Bandwidth:   40.4 GB/s)\nGPU FP16 x2:        0.0096 ms (Bandwidth:   41.0 GB/s)\nGPU FP16 x8:        0.0103 ms (Bandwidth:   38.0 GB/s)\nGPU FP16 x8_pack:   0.0109 ms (Bandwidth:   36.2 GB/s)\n\n--- Speedup Analysis ---\nCPU vs GPU Standard:   19.63x\nCPU vs GPU Vec4:       18.91x\nCPU vs GPU FP16:       19.28x\nCPU vs GPU FP16x2:     19.57x\nCPU vs GPU FP16x8:     18.13x\nCPU vs GPU FP16x8_pack: 17.27x\nStandard vs Vec4:       0.96x\nStandard vs FP16:       0.98x\nStandard vs FP16x2:     1.00x\nStandard vs FP16x8:     0.92x\nStandard vs FP16x8_pack:  0.88x\nFP16 vs FP16x2:         1.01x\nFP16x2 vs FP16x8:       0.93x\nFP16x8 vs FP16x8_pack:  0.95x\n\n========== Testing 256K (N=262144) ==========\nMismatch at index 0: 14.3984 != 14.4 (error: 0.00156307)\nCorrectness: FAIL (Max error: 0.037506)\nArray Size: 262144 elements (0.00 GB)\n\n--- Execution Times (Kernel Only) ---\nCPU Time:           0.7488 ms (Bandwidth:    4.2 GB/s)\nGPU Standard:       0.0111 ms (Bandwidth:  282.9 GB/s)\nGPU Vec4:           0.0105 ms (Bandwidth:  299.7 GB/s)\nGPU FP16 Std:       0.0108 ms (Bandwidth:  145.7 GB/s)\nGPU FP16 x2:        0.0101 ms (Bandwidth:  155.5 GB/s)\nGPU FP16 x8:        0.0107 ms (Bandwidth:  146.7 GB/s)\nGPU FP16 x8_pack:   0.0109 ms (Bandwidth:  143.9 GB/s)\n\n--- Speedup Analysis ---\nCPU vs GPU Standard:   67.36x\nCPU vs GPU Vec4:       71.34x\nCPU vs GPU FP16:       69.35x\nCPU vs GPU FP16x2:     74.03x\nCPU vs GPU FP16x8:     69.83x\nCPU vs GPU FP16x8_pack: 68.53x\nStandard vs Vec4:       1.06x\nStandard vs FP16:       1.03x\nStandard vs FP16x2:     1.10x\nStandard vs FP16x8:     1.04x\nStandard vs FP16x8_pack:  1.02x\nFP16 vs FP16x2:         1.07x\nFP16x2 vs FP16x8:       0.94x\nFP16x8 vs FP16x8_pack:  0.98x\n\n========== Testing 1M (N=1048576) ==========\nMismatch at index 0: 57.5938 != 57.6 (error: 0.00625229)\nCorrectness: FAIL (Max error: 0.100006)\nArray Size: 1048576 elements (0.01 GB)\n\n--- Execution Times (Kernel Only) ---\nCPU Time:           3.0058 ms (Bandwidth:    4.2 GB/s)\nGPU Standard:       0.0250 ms (Bandwidth:  503.4 GB/s)\nGPU Vec4:           0.0233 ms (Bandwidth:  539.8 GB/s)\nGPU FP16 Std:       0.0163 ms (Bandwidth:  384.9 GB/s)\nGPU FP16 x2:        0.0132 ms (Bandwidth:  475.7 GB/s)\nGPU FP16 x8:        0.0161 ms (Bandwidth:  391.2 GB/s)\nGPU FP16 x8_pack:   0.0158 ms (Bandwidth:  398.0 GB/s)\n\n--- Speedup Analysis ---\nCPU vs GPU Standard:  120.26x\nCPU vs GPU Vec4:      128.94x\nCPU vs GPU FP16:      183.90x\nCPU vs GPU FP16x2:    227.29x\nCPU vs GPU FP16x8:    186.88x\nCPU vs GPU FP16x8_pack:190.17x\nStandard vs Vec4:       1.07x\nStandard vs FP16:       1.53x\nStandard vs FP16x2:     1.89x\nStandard vs FP16x8:     1.55x\nStandard vs FP16x8_pack:  1.58x\nFP16 vs FP16x2:         1.24x\nFP16x2 vs FP16x8:       0.82x\nFP16x8 vs FP16x8_pack:  1.02x\n\n========== Test Complete ==========\n\u279c  build git:(master) \u2717\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/bision%20debug/","title":"Bison Debug \u6307\u5317","text":"2025-06-242025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"blogs/posts/bision%20debug/#what-is-bison","title":"What is bison?","text":"<p> \u7ea6 309 \u4e2a\u5b57  15 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p> <ul> <li>Flex (\u8bcd\u6cd5\u5206\u6790\u5668)\uff1a\u8d1f\u8d23\u5c06\u8f93\u5165\u7684\u539f\u59cb\u6587\u672c\u6d41\u5206\u89e3\u6210\u4e00\u4e2a\u4e2a\u6709\u610f\u4e49\u7684\u5355\u5143\uff0c\u79f0\u4e3aTokens\u3002</li> <li>Bison (\u8bed\u6cd5\u5206\u6790\u5668)\uff1a\u63a5\u6536 Flex \u751f\u6210\u7684\u4ee4\u724c\u6d41\uff0c\u5e76\u6839\u636e\u4f60\u5b9a\u4e49\u7684\u8bed\u6cd5\u89c4\u5219\u6765\u68c0\u67e5\u8fd9\u4e9b\u4ee4\u724c\u7684\u7ec4\u5408\u662f\u5426\u5408\u6cd5\u3002\u68c0\u67e5\u8bcd\u8bed\uff08Tokens\uff09\u662f\u5426\u7ec4\u6210\u4e86\u5408\u6cd5\u7684\u53e5\u5b50\uff08Statements/Expressions\uff09\u3002</li> </ul>","tags":["Database"]},{"location":"blogs/posts/bision%20debug/#_1","title":"\u4f7f\u7528\u6307\u5357","text":"<ol> <li>\u7f16\u5199 Bison \u8bed\u6cd5\u6587\u4ef6 (.y)\uff1a\u5b9a\u4e49\u8ba1\u7b97\u5668\u8bed\u8a00\u7684\u89c4\u5219\u3002</li> <li>\u7f16\u5199 Flex \u8bcd\u6cd5\u6587\u4ef6 (.l)\uff1a\u5b9a\u4e49\u5982\u4f55\u8bc6\u522b\u6570\u5b57\u548c\u64cd\u4f5c\u7b26\u3002</li> <li>\u7f16\u8bd1\u548c\u94fe\u63a5\uff1a\u4f7f\u7528 Bison \u548c Flex \u751f\u6210 C \u4ee3\u7801\uff0c\u7136\u540e\u7528 GCC/G++ \u7f16\u8bd1\u5b83\u4eec\u3002</li> <li>\u8fd0\u884c\u7a0b\u5e8f\u3002</li> </ol>","tags":["Database"]},{"location":"blogs/posts/bision%20debug/#how-to-view-the-conflicts-in-bison","title":"How to view the conflicts in bison?","text":"<p>\u5982\u679c\u662f\u5728 CMake \u4e2d\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e bison_flags \u6765\u8fdb\u884c\u67e5\u770b\uff1a<code>set(bison_flags \"-v -Wcex\")</code>\u3002\\ \u5982\u679c\u6211\u4eec\u5b9a\u4e49\u7684\u89c4\u5219\u6709\u51b2\u7a81\uff0cbison \u4f1a\u7ed9\u6211\u4eec\u4e00\u4e2a\u6700\u5c0f\u51b2\u7a81\u4f8b\u5b50\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b\u8be5\u4f8b\u5b50\u6765\u89e3\u51b3\u51b2\u7a81\uff1a</p> C++<pre><code>  Example: L_BRACKET DOUBLE \u2022 R_BRACKET\n  First reduce derivation\n    container_expression\n    \u21b3 list_expression\n      \u21b3 L_BRACKET opt_expression_list       R_BRACKET\n                  \u21b3 expression_list\n                    \u21b3 expression_internal\n                      \u21b3 constant_expression\n                        \u21b3 DOUBLE \u2022\n  Second reduce derivation\n    container_expression\n    \u21b3 vector_expression\n      \u21b3 L_BRACKET vector_item_list            R_BRACKET\n                  \u21b3 vector_element_expression\n                    \u21b3 DOUBLE \u2022\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bision%20debug/#how-to-debug-in-bison","title":"How to debug in bison?","text":"<ol> <li>\u5728 parser.yy \u6587\u4ef6\u5f00\u5934\u52a0\u5165\u8bbe\u7f6e bison debug \u5f00\u542f\u8bed\u53e5 <code>%define parse.trace true</code></li> <li>\u5728 C++ \u6587\u4ef6\u4e2d\u627e\u5230 parser \u5bf9\u8c61\uff0c\u8bbe\u7f6e debug level \u4e3a 1 <code>parser_.set_debug_level(1);</code></li> </ol>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/","title":"Bustub \u901a\u5173\u6307\u5317","text":"2025-06-232025-12-13 <code>#Database</code>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#basic-knowledge","title":"Basic Knowledge","text":"<p> \u7ea6 5375 \u4e2a\u5b57  432 \u884c\u4ee3\u7801  10 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 32 \u5206\u949f</p> <p>Bustub \u662f\u4e00\u4e2a\u6559\u5b66\u7528\u7684 RDBMS\uff0c\u6838\u5fc3\u7ec4\u4ef6\u5305\u62ec Parser\u3001Planner\u3001Optimizer\u3001Executor \u4ee5\u53ca Storage\u3002CMU15445 \u8fd9\u95e8\u8bfe\u7684\u8bfe\u7a0b\u4f5c\u4e1a\u9700\u8981\u4fee\u6539\u4e0a\u8ff0\u51e0\u4e4e\u5168\u90e8\u5185\u5bb9\uff0c\u53ef\u4ee5\u8ba9\u6570\u636e\u5e93\u521d\u5b66\u8005\u6df1\u5165\u7406\u89e3\u6570\u636e\u5e93\u7684\u5de5\u4f5c\u539f\u7406\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#parser","title":"Parser","text":"<p>Bustub \u7684 Parser \u5b9e\u9645\u4e0a\u4f7f\u7528\u7684\u662f duckdb_libpgquery \u7684\u5e93\uff0c\u8d1f\u8d23\u5c06 SQL \u8bed\u53e5\u89e3\u6790\u6210\u62bd\u8c61\u8bed\u6cd5\u6811\uff08AST\uff09\u3002\u5728\u8fd9\u4e2a\u9636\u6bb5\uff0c\u4f60\u9700\u8981\u7406\u89e3 SQL \u7684\u57fa\u672c\u8bed\u6cd5\u548c\u5982\u4f55\u5c06\u5176\u8f6c\u6362\u4e3a AST\u3002</p> <p>Bustub \u8fd8\u591a\u4e86\u4e00\u4e2a binder \u7684\u8fc7\u7a0b\uff0c\u5c06 Statement \u8f6c\u6362\u4e3a\u66f4\u5177\u4f53\u7684\u8bed\u6cd5\u6811\uff08\u5982 InsertStatement\uff09\uff0c\u8fd9\u4e00\u6b65\u9aa4\u4f1a\u8fdb\u884c\u7c7b\u578b\u68c0\u67e5\u548c\u7b26\u53f7\u89e3\u6790\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#planner","title":"Planner","text":"<p>Planner \u8d1f\u8d23\u5c06 AST \u8f6c\u6362\u4e3a\u903b\u8f91\u67e5\u8be2\u8ba1\u5212\uff08Logical Query Plan\uff09\u3002\u6574\u4e2a\u67e5\u8be2\u8ba1\u5212\u4ee5\u6811\u7684\u5f62\u5f0f\u5b58\u5728\uff0c\u5305\u542b\u4e86\u5404\u79cd\u64cd\u4f5c\u8282\u70b9\uff08\u5982 SeqScan\u3001IndexScan\u3001Filter \u7b49\uff09\u3002\u6211\u4eec\u9700\u8981\u77e5\u9053\u5982\u4f55\u7ec4\u7ec7\u8fd9\u4e9b\u64cd\u4f5c\u7ed3\u70b9\uff0c\u4ece\u800c\u8ba9\u6574\u4e2a\u8ba1\u5212\u53ef\u4ee5\u81ea\u4e0b\u800c\u4e0a\u5730\u6267\u884c\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#optimizer","title":"Optimizer","text":"<p>Optimizer \u8d1f\u8d23\u5bf9\u67e5\u8be2\u8ba1\u5212\u8fdb\u884c\u4f18\u5316\uff0c\u4e3b\u6d41\u7684\u6570\u636e\u5e93\u4f18\u5316\u5668\u4e00\u822c\u4f7f\u7528 RBO\uff08\u57fa\u4e8e\u89c4\u5219\u4f18\u5316\uff09\u548c CBO\uff08\u57fa\u4e8e\u6210\u672c\u4f30\u7b97\u4f18\u5316\uff09\u5c06\u903b\u8f91\u8ba1\u5212\u8f6c\u53d8\u4e3a\u7269\u7406\u8ba1\u5212\uff08Physical Query Plan\uff09\u3002 \u4f46\u662f Bustub \u53ea\u6709 RBO \u4f18\u5316\uff0c\u4f18\u5316\u5668\u4f18\u5316\u89c4\u5219\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u9762\uff1a</p> <ul> <li>\u8c13\u8bcd\u4e0b\u63a8\uff1a\u5c06\u8fc7\u6ee4\u6761\u4ef6\u5c3d\u53ef\u80fd\u65e9\u5730\u5e94\u7528\u5230\u6570\u636e\u4e0a\uff0c\u4ee5\u51cf\u5c11\u540e\u7eed\u64cd\u4f5c\u7684\u6570\u636e\u91cf\u3002</li> <li>\u8fde\u63a5\u987a\u5e8f\u4f18\u5316\uff1a\u901a\u8fc7\u6539\u53d8\u8fde\u63a5\u64cd\u4f5c\u7684\u987a\u5e8f\u6765\u51cf\u5c11\u4e2d\u95f4\u7ed3\u679c\u96c6\u7684\u5927\u5c0f\uff0c\u4ece\u800c\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\u3002</li> <li>\u7d22\u5f15\u9009\u62e9\uff1a\u6839\u636e\u67e5\u8be2\u6761\u4ef6\u9009\u62e9\u5408\u9002\u7684\u7d22\u5f15\u6765\u52a0\u901f\u6570\u636e\u8bbf\u95ee\u3002</li> </ul>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#executor","title":"Executor","text":"<p>Executor \u8d1f\u8d23\u6267\u884c\u7269\u7406\u67e5\u8be2\u8ba1\u5212\u4e2d\u7684\u64cd\u4f5c\u8282\u70b9\u3002\u5b83\u4f1a\u6839\u636e\u7269\u7406\u67e5\u8be2\u8ba1\u5212\u7684\u7ed3\u6784\uff0c\u9010\u4e2a\u6267\u884c\u64cd\u4f5c\uff0c\u5e76\u5c06\u7ed3\u679c\u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2a\u64cd\u4f5c\u8282\u70b9\u3002Executor \u7684\u5b9e\u73b0\u9700\u8981\u7406\u89e3\u6bcf\u79cd\u64cd\u4f5c\u7684\u5177\u4f53\u6267\u884c\u903b\u8f91\uff0c\u5982\u5982\u4f55\u8fdb\u884c\u8868\u626b\u63cf\u3001\u7d22\u5f15\u626b\u63cf\u3001\u8fde\u63a5\u64cd\u4f5c\u7b49\u3002</p> <p>Bustub \u5e76\u6ca1\u6709\u652f\u6301\u6240\u6709\u7b97\u5b50\uff0c\u4f46\u662f\u652f\u6301\u4e86\u591a\u79cd Join \u7b97\u5b50\uff08\u5982 Nested Loop Join\u3001Nested Index Join\u3001Hash Join \u7b49\uff09\uff0c\u5e76\u4e14\u652f\u6301\u4e86\u591a\u79cd Scan \u7b97\u5b50\uff08\u5982 SeqScan\u3001IndexScan \u7b49\uff09\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#storage","title":"Storage","text":"<p>Storage \u6a21\u5757\u8d1f\u8d23\u6570\u636e\u7684\u5b58\u50a8\u548c\u7ba1\u7406\uff0c\u5305\u62ec\u6570\u636e\u9875\u7684\u8bfb\u5199\u3001\u7f13\u51b2\u6c60\u7684\u7ba1\u7406\u3001\u7d22\u5f15\u7684\u7ef4\u62a4\u7b49\u3002</p> <p>Bustub \u7684\u6570\u636e\u5b58\u50a8\u4e0e PostgreSQL \u4e00\u81f4\uff0c\u4f7f\u7528 Slotted page \u8fdb\u884c tuple \u7684\u5b58\u50a8\u3002</p> C++<pre><code>/**\n * Slotted page format:\n *  ---------------------------------------------------------\n *  | HEADER | ... FREE SPACE ... | ... INSERTED TUPLES ... |\n *  ---------------------------------------------------------\n *                                ^\n *                                free space pointer\n *\n *  Header format (size in bytes):\n *  ----------------------------------------------------------------------------\n *  | NextPageId (4)| NumTuples(2) | NumDeletedTuples(2) |\n *  ----------------------------------------------------------------------------\n *  ----------------------------------------------------------------\n *  | Tuple_1 offset+size (4) | Tuple_2 offset+size (4) | ... |\n *  ----------------------------------------------------------------\n *\n * Tuple format:\n * | meta | data |\n */\n</code></pre> <p>\u540c\u65f6\uff0cBustub \u4f7f\u7528\u4e86 B+\u6811\u4f5c\u4e3a\u7d22\u5f15\u7ed3\u6784\uff0c\u5e76\u5b9e\u73b0\u4e86\u7f13\u51b2\u6c60\u7ba1\u7406\u5668\u6765\u4f18\u5316\u78c1\u76d8 I/O \u64cd\u4f5c\u3002</p> <p>\u4e3a\u4e86\u66f4\u597d\u5730\u5bf9\u78c1\u76d8\u8fdb\u884c\u64cd\u4f5c\u5e76\u4e0d\u5f71\u54cd\u524d\u53f0\u7684\u67e5\u8be2\uff0cBustub \u8bbe\u8ba1\u4e86 DiskManager \u548c DiskScheduler\u3002DiskManager \u8d1f\u8d23\u78c1\u76d8\u7684\u8bfb\u5199\u64cd\u4f5c\uff0c\u800c DiskScheduler \u5219\u8d1f\u8d23\u8c03\u5ea6\u8fd9\u4e9b\u64cd\u4f5c\uff0c\u4ee5\u786e\u4fdd\u67e5\u8be2\u7684\u9ad8\u6548\u6267\u884c\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#multi-version-concurrency-control-mvcc-optimistic-concurrency-control-occ","title":"Multi-Version Concurrency Control (MVCC) + Optimistic Concurrency Control (OCC)","text":"<p>Bustub \u672c\u8eab\u5e76\u6ca1\u6709\u5b9e\u73b0 MVCC\uff0c\u4f46\u5b83\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u672c\u6846\u67b6\u9700\u8981\u6211\u4eec\u6765\u5b9e\u73b0\u3002MVCC \u5141\u8bb8\u591a\u4e2a\u4e8b\u52a1\u5e76\u53d1\u6267\u884c\u800c\u4e0d\u4f1a\u76f8\u4e92\u5e72\u6270\uff0c\u4e3b\u8981\u901a\u8fc7\u7248\u672c\u63a7\u5236\u6765\u5b9e\u73b0\u3002\u6bcf\u4e2a\u6570\u636e\u9879\u90fd\u6709\u4e00\u4e2a\u7248\u672c\u53f7\uff0c\u4e8b\u52a1\u5728\u8bfb\u53d6\u6570\u636e\u65f6\u4f1a\u68c0\u67e5\u7248\u672c\u53f7\uff0c\u4ee5\u786e\u4fdd\u8bfb\u53d6\u5230\u7684\u662f\u6700\u65b0\u7684\u7248\u672c\u3002</p> <p>OCC \u5219\u662f\u4e00\u79cd\u4e50\u89c2\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u5b83\u5047\u8bbe\u4e8b\u52a1\u4e4b\u95f4\u4e0d\u4f1a\u53d1\u751f\u51b2\u7a81\uff0c\u56e0\u6b64\u5728\u63d0\u4ea4\u65f6\u624d\u8fdb\u884c\u51b2\u7a81\u68c0\u6d4b\u3002\u5982\u679c\u68c0\u6d4b\u5230\u51b2\u7a81\uff0c\u5219\u56de\u6eda\u4e8b\u52a1\u3002Bustub \u7684 MVCC + OCC \u5b9e\u73b0\u4e86\u4e32\u884c\u5316\u9694\u79bb\u7ea7\u522b\uff0c\u786e\u4fdd\u4e8b\u52a1\u7684\u6267\u884c\u7ed3\u679c\u4e0e\u4e32\u884c\u6267\u884c\u7684\u7ed3\u679c\u4e00\u81f4\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#buffer-pool-manager","title":"Buffer Pool Manager","text":"<p>\u8fd9\u4e2a\u4efb\u52a1\u5b9e\u9645\u4e0a\u5305\u62ec\u4e09\u4e2a\u5c0f\u4efb\u52a1\uff1a</p> <ol> <li>LRU-K Policy</li> <li>Disk Scheduler</li> <li>Buffer Pool Manager</li> </ol>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#lru-k-policy","title":"LRU-K Policy","text":"<p>LRU-K \u662f\u4e00\u79cd\u6539\u8fdb\u7684 LRU\uff08Least Recently Used\uff09\u7f13\u5b58\u66ff\u6362\u7b56\u7565\uff0cLRU-K \u7b97\u6cd5\u4f1a\u6dd8\u6c70\u5728\u66ff\u6362\u5668\u4e2d\u53cd\u5411 k \u8ddd\u79bb\u6700\u5927\u7684\u9875\u5e27\u3002\u53cd\u5411 k \u8ddd\u79bb\u662f\u901a\u8fc7\u5f53\u524d\u65f6\u95f4\u6233\u4e0e\u7b2c k \u6b21\u5148\u524d\u8bbf\u95ee\u7684\u65f6\u95f4\u6233\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\u8ba1\u7b97\u7684\u3002\u5c11\u4e8e k \u6b21\u5386\u53f2\u8bbf\u95ee\u7684\u9875\u5e27\u4f1a\u88ab\u8d4b\u4e88+inf \u4f5c\u4e3a\u5176\u53cd\u5411 k \u8ddd\u79bb\u3002\u5982\u679c\u591a\u4e2a\u9875\u5e27\u5177\u6709+inf \u53cd\u5411 k \u8ddd\u79bb\uff0c\u66ff\u6362\u5668\u4f1a\u6dd8\u6c70\u5177\u6709\u6700\u65e9\u6574\u4f53\u65f6\u95f4\u6233\u7684\u9875\u5e27\uff08\u5373\u8bb0\u5f55\u8bbf\u95ee\u6700\u4e45\u8fdc\u7684\u9875\u5e27\uff09\u3002</p> <p>LRUKReplacer \u4e2d\u7ef4\u62a4\u4e86\u4e00\u4e2a unordered_map \u5b58\u50a8 frame_id \u548c\u5176\u5bf9\u5e94\u7684 LRU-K \u4fe1\u606f\u3002\u6bcf\u4e2a frame_id \u5bf9\u5e94\u4e00\u4e2a LRUKNode \u5bf9\u8c61\uff0c\u5305\u542b\u4e86 frame_id\u3001\u8bbf\u95ee\u6b21\u6570\u3001\u8bbf\u95ee\u5386\u53f2\u7b49\u4fe1\u606f\u3002</p> C++<pre><code>class LRUKNode {\n private:\n  /** History of last seen K timestamps of this page. Least recent timestamp stored in front. */\n  std::list&lt;size_t&gt; history_;         // history timestamp\n  size_t k_{0};                       // k times\n  frame_id_t fid_{INVALID_FRAME_ID};  // frame id\n  bool is_evictable_{false};          // whether or not can be evicted\n};\n\nclass LRUKReplacer {\n  std::unordered_map&lt;frame_id_t, LRUKNode&gt; node_store_;\n  size_t current_timestamp_{0};\n  size_t curr_size_{0};\n  size_t replacer_size_;\n  size_t k_;\n  std::mutex latch_;\n};\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#disk-scheduler","title":"Disk Scheduler","text":"<p>\u78c1\u76d8\u8c03\u5ea6\u5668\u53ef\u4ee5\u88ab\u5176\u4ed6\u7ec4\u4ef6\u4f7f\u7528\uff0c\u4ee5\u5c06\u78c1\u76d8\u8bf7\u6c42\u6392\u961f\uff0c\u8fd9\u4e9b\u8bf7\u6c42\u7531\u4e00\u4e2a DiskRequest \u7ed3\u6784\u4f53\u8868\u793a\u3002\u78c1\u76d8\u8c03\u5ea6\u5668\u5c06\u7ef4\u62a4\u4e00\u4e2a\u540e\u53f0\u5de5\u4f5c\u7ebf\u7a0b\uff0c\u8d1f\u8d23\u5904\u7406\u8c03\u5ea6\u597d\u7684\u8bf7\u6c42\u3002\u8fd9\u91cc\u7684 DiskRequest \u91cc\u9762\u6709\u4e00\u4e2a std::promise \u5bf9\u8c61\uff0c\u7528\u4e8e\u5728\u8bf7\u6c42\u5b8c\u6210\u65f6\u901a\u77e5\u7b49\u5f85\u7684\u7ebf\u7a0b\uff0c\u4f46\u662f\u6211\u4eec\u6682\u65f6\u5e76\u6ca1\u6709\u5b9e\u73b0\u6210\u5b8c\u5168\u5f02\u6b65\u7684\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 epoll \u7b49\u4e8b\u4ef6\u901a\u77e5\u673a\u5236\u914d\u5408 promise \u548c future \u6765\u5b9e\u73b0\u771f\u6b63\u7684\u5f02\u6b65\u8bf7\u6c42\u3002</p> C++<pre><code>struct DiskRequest {\n  /** Flag indicating whether the request is a write or a read. */\n  bool is_write_;\n  /**\n   *  Pointer to the start of the memory location where a page is either:\n   *   1. being read into from disk (on a read).\n   *   2. being written out to disk (on a write).\n   */\n  char *data_;\n  /** ID of the page being read from / written to disk. */\n  page_id_t page_id_;\n  /** Callback used to signal to the request issuer when the request has been completed. */\n  std::promise&lt;bool&gt; callback_;\n};\n\nvoid DiskScheduler::StartWorkerThread() {\n  std::optional&lt;DiskRequest&gt; request;\n  while (true) {\n    request = request_queue_.Get();\n    if (request != std::nullopt) {\n      if (request-&gt;is_write_) {\n        disk_manager_-&gt;WritePage(request-&gt;page_id_, request-&gt;data_);\n        request-&gt;callback_.set_value(true);\n      } else if (!request-&gt;is_write_) {\n        disk_manager_-&gt;ReadPage(request-&gt;page_id_, request-&gt;data_);\n        request-&gt;callback_.set_value(true);\n      }\n    } else {\n      break;\n    }\n  }\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#buffer-pool-manager_1","title":"Buffer Pool Manager","text":"<p>BufferPoolManager \u8d1f\u8d23\u4f7f\u7528 DiskScheduler \u4ece\u78c1\u76d8\u83b7\u53d6\u6570\u636e\u5e93\u9875\u9762\uff0c\u5e76\u5c06\u5b83\u4eec\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u3002 BufferPoolManager \u8fd8\u53ef\u4ee5\u6839\u636e\u660e\u786e\u7684\u6307\u793a\u6216\u5728\u9700\u8981\u9a71\u9010\u9875\u9762\u4ee5\u817e\u51fa\u7a7a\u95f4\u7ed9\u65b0\u9875\u9762\u65f6\uff0c\u8c03\u5ea6\u810f\u9875\u5199\u5165\u78c1\u76d8\u3002Bustub \u63d0\u4f9b\u4e86\u4e00\u4e2a\u540d\u4e3a FrameHeader \u7684\u8f85\u52a9\u7c7b\uff0c\u7528\u4e8e\u7ba1\u7406\u5185\u5b58\u4e2d\u7684\u5e27\u3002\u6240\u6709\u5bf9\u9875\u9762\u6570\u636e\u7684\u8bbf\u95ee\u90fd\u5e94\u901a\u8fc7 FrameHeader \u8fdb\u884c\u3002 FrameHeader \u6709\u4e00\u4e2a\u540d\u4e3a GetData \u7684\u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u8fd4\u56de\u5176\u5e27\u5185\u5b58\u7684\u539f\u59cb\u6307\u9488\uff0c\u800c DiskScheduler / DiskManager \u5c06\u4f7f\u7528\u6b64\u6307\u9488\u5c06\u78c1\u76d8\u4e0a\u7684\u7269\u7406\u9875\u9762\u5185\u5bb9\u590d\u5236\u5230\u5185\u5b58\u4e2d\u3002</p> <p>\u5728\u5b9e\u73b0\u591a\u7ebf\u7a0b\u7f13\u51b2\u6c60\u7ba1\u7406\u5668\u65f6\uff0c\u6211\u4eec\u5fc5\u987b\u6ce8\u610f\u540c\u6b65\u6570\u636e\u8bbf\u95ee\u3002\u8fd9\u610f\u5473\u7740\u6211\u4eec\u4e0d\u60f3\u5728\u7f13\u51b2\u6c60\u7684\u4e0d\u540c\u5e27\u4e2d\u5b58\u5728\u76f8\u540c\u9875\u9762\u7684\u591a\u4e2a\u526f\u672c\u3002\u5982\u679c\u6211\u4eec\u5141\u8bb8\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u4f1a\u9047\u5230\u8fd9\u6837\u7684\u573a\u666f\uff1a</p> <ol> <li>\u7ebf\u7a0b T1 \u5c06\u9875 X1 \u4ece\u78c1\u76d8\u52a0\u8f7d\u5230\u7f13\u51b2\u533a\u5e27\u4e2d\uff0c\u5e76\u5f00\u59cb\u4fee\u6539\u9875 X1 \uff0c\u6211\u4eec\u5c06\u8fd9\u4e2a\u65b0\u7248\u672c\u79f0\u4e3a\u9875 X2 \u3002</li> <li>\u7ebf\u7a0b T2 \u5c06\u9875 X1 \u4ece\u78c1\u76d8\u52a0\u8f7d\u5230\u4e0d\u540c\u7684\u7f13\u51b2\u533a\u5e27\u4e2d\uff0c\u5e76\u5f00\u59cb\u4fee\u6539\u8fd9\u4e2a\u7248\u672c\u7684\u9875 X1 \uff0c\u6211\u4eec\u5c06\u8fd9\u4e2a\u5176\u4ed6\u4fee\u6539\u8fc7\u7684\u7248\u672c\u79f0\u4e3a\u9875 X3 \u3002</li> <li>\u7ebf\u7a0b T2 \u5b8c\u6210\u5199\u5165\u5e76\u5c06 X3 \u5199\u56de\u78c1\u76d8\u3002</li> <li>\u7ebf\u7a0b T1 \u5b8c\u6210\u5199\u5165\u5e76\u5c06 X2 \u5199\u56de\u78c1\u76d8\u3002</li> <li>\u6570\u636e\u7ade\u4e89 \u2620\ufe0f\uff01</li> </ol> <p>\u56e0\u6b64\uff0cBustub \u6bcf\u6b21\u53ea\u5728\u5185\u5b58\u4e2d\u4fdd\u7559\u4e00\u9875\u7684\u7248\u672c\uff0c\u4ee5\u9632\u6b62\u6570\u636e\u540c\u6b65\u7ade\u4e89\u3002\u6b64\u5916\uff0c\u4e3a\u4e86\u9632\u6b62\u5728\u7ebf\u7a0b\u8bbf\u95ee\u9875\u65f6\u5c06\u5176\u9a71\u9010\uff0c\u6211\u4eec\u5728\u5b58\u50a8\u8be5\u9875\u7684\u5e27\u4e0a\u7ef4\u62a4\u4e00\u4e2a\u5f15\u7528\u8ba1\u6570/\u56fa\u5b9a\u8ba1\u6570\u3002\u6700\u540e\uff0c\u4e3a\u4e86\u8ddf\u8e2a\u54ea\u4e9b\u9875\u5b58\u50a8\u5728\u54ea\u4e9b\u5e27\u4e2d\uff0c\u6211\u4eec\u8fd8\u4f7f\u7528\u54c8\u5e0c\u6620\u5c04\u7ef4\u62a4\u4e00\u4e2a\u9875\u8868\uff0c\u8be5\u54c8\u5e0c\u6620\u5c04\u5c06\u9875 ID \u6620\u5c04\u5230\u5e27\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#_1","title":"\u5b9e\u73b0","text":"<p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u83b7\u53d6 FrameHeader \u4e2d\u7684 rw_latch \u524d\u9700\u8981\u91ca\u653e bpm_latch\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u6b7b\u9501\u3002WritePageGuard \u548c ReadPageGuard \u6574\u4e2a\u751f\u547d\u5468\u671f\u5185\u90fd\u6301\u6709 rw_latch\u3002</p> <p>\u53c2\u8003 the king king \u7684\u535a\u5ba2</p> <p>\u4e3a\u4e86\u4fdd\u8bc1\u5bf9\u540c\u4e00\u9875\u5199\u5165\u548c\u8bfb\u53d6\u7684\u5e76\u53d1\u5b89\u5168\uff0c\u6211\u4eec\u9700\u8981\u5728 BufferPoolManager \u4e2d\u5b9e\u73b0\u4e00\u4e2a\u810f\u9875\u5199\u5165\u673a\u5236\u3002\u8fd9\u4e2a\u673a\u5236\u53ef\u4ee5\u786e\u4fdd\u5728\u6709\u810f\u9875\u5b58\u5728\u65f6\uff0c\u5176\u4ed6\u7ebf\u7a0b\u4e0d\u4f1a\u8bfb\u53d6\u672a\u5199\u5165\u7684\u810f\u9875\u3002</p> C++<pre><code>/** @brief A set of dirty pages that need to be flushed to disk. */\nstd::unordered_set&lt;page_id_t&gt; dirty_pages_;\n/** @brief A mutex to protect the dirty pages set. */\nstd::mutex flush_mutex_;\n/** @brief A condition variable to notify the flusher thread that there are dirty pages to flush. */\nstd::condition_variable flush_cv_;\n</code></pre> <p>\u64cd\u4f5c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u83b7\u53d6 FreeFrame\uff0c\u5982\u679c\u662f\u810f\u9875\u8fdb\u884c\u6807\u8bb0\u5e76\u5c06\u8be5\u9875\u52a0\u5165\u5230 dirty_pages\uff0c\u810f\u9875\u5237\u76d8\u4e0d\u5e94\u8be5\u5728 bpm_latch \u4e2d\u8fdb\u884c\uff0c\u800c\u662f\u5e94\u8be5\u5728\u83b7\u53d6\u5230 frame \u7684 rw_latch \u540e\u8fdb\u884c\u3002</li> <li>\u4fee\u6539 Buffer Pool Manager \u7684\u5143\u6570\u636e\u7136\u540e\u91ca\u653e bpm_latch\uff0c\u83b7\u53d6 frame \u7684 rw_latch\u3002</li> <li>\u5982\u679c\u662f\u810f\u9875\u4e14\u9700\u8981\u5237\u76d8\uff0c\u5c06 frame \u5237\u5199\u5230\u78c1\u76d8 \u4e2d\uff0c\u5e76\u91cd\u7f6e frame \u7684\u72b6\u6001\uff0c\u7136\u540e\u5c06\u810f\u9875\u4ece dirty_pages \u4e2d\u5220\u9664\uff0c\u5e76\u901a\u77e5 flusher \u7ebf\u7a0b\u3002</li> <li>\u7b49\u5f85 flushcv \u7684\u901a\u77e5\uff0c\u76f4\u5230 dirty_pages \u4e2d\u4e0d\u5305\u542b\u5f53\u524d\u9875\uff0c\u7136\u540e\u52a0\u8f7d\u9875\u9762\u5230 frame \u4e2d\u3002</li> <li>\u8fd4\u56de WritePageGuard \u6216 ReadPageGuard\u3002</li> </ol>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#concurrent-bplustree-index","title":"Concurrent BPlusTree Index","text":"<p>B+\u6811\u4e5f\u662f\u6309\u7167\u9875\u9762\u6765\u8fdb\u884c\u5b58\u50a8\u7684\uff0cB+\u6811\u7684\u6bcf\u4e2a\u8282\u70b9\u90fd\u662f\u4e00\u4e2a\u9875\u9762\u3002B+\u6811\u7684\u8282\u70b9\u5206\u4e3a\u53f6\u5b50\u8282\u70b9\u548c\u5185\u90e8\u8282\u70b9\uff0c\u53f6\u5b50\u8282\u70b9\u5b58\u50a8\u6709\u5e8f\u7684\u952e\u53ca\u5176\u5bf9\u5e94\u7684\u503c\u3002\u800c\u5185\u90e8\u8282\u70b9\u5b58\u50a8 m \u4e2a\u6709\u5e8f\u952e\u548c m + 1 \u4e2a\u6307\u5411\u5176\u4ed6 B+\u6811\u9875\u9762\u7684\u5b50\u6307\u9488\uff08\u5373\u9875\u9762 ID\uff09\u3002</p> <p>\u4efb\u4f55\u65f6\u5019\uff0c\u6bcf\u4e2a\u5185\u90e8\u9875\u9762\u7684\u586b\u5145\u7387\u5e94\u81f3\u5c11\u4e3a\u534a\u6ee1\u3002\u5728\u5220\u9664\u64cd\u4f5c\u4e2d\uff0c\u4e24\u4e2a\u534a\u6ee1\u9875\u9762\u53ef\u4ee5\u5408\u5e76\uff0c\u6216\u8005\u53ef\u4ee5\u5c06\u952e\u548c\u6307\u9488\u91cd\u65b0\u5206\u914d\u4ee5\u907f\u514d\u5408\u5e76\u3002\u5728\u63d2\u5165\u64cd\u4f5c\u4e2d\uff0c\u4e00\u4e2a\u6ee1\u9875\u9762\u53ef\u4ee5\u62c6\u5206\u4e3a\u4e24\u4e2a\uff0c\u6216\u8005\u53ef\u4ee5\u5c06\u952e\u548c\u6307\u9488\u91cd\u65b0\u5206\u914d\u4ee5\u907f\u514d\u62c6\u5206\u3002\u53f6\u5b50\u9875\u9762\u4e0e\u5185\u90e8\u9875\u9762\u4e00\u6837\uff0c\u5bf9\u952e\u503c\u5bf9\u7684\u6570\u91cf\u6709\u76f8\u540c\u7684\u9650\u5236\uff0c\u5e76\u4e14\u5e94\u9075\u5faa\u76f8\u540c\u7684\u5408\u5e76\u3001\u62c6\u5206\u548c\u91cd\u65b0\u5206\u914d\u952e\u7684\u64cd\u4f5c\u3002</p> <p>\u6bcf\u4e2a B+\u6811\u53f6\u5b50\u8282\u70b9/\u5185\u90e8\u9875\u9762\u5bf9\u5e94\u4e8e\u7f13\u51b2\u6c60\u83b7\u53d6\u7684\u5185\u5b58\u9875\u9762\u7684\u5185\u5bb9\uff08\u5373 data_ \u90e8\u5206\uff09\u3002\u6bcf\u6b21\u4ece\u53f6\u5b50\u8282\u70b9\u6216\u5185\u90e8\u9875\u9762\u8bfb\u53d6\u6216\u5199\u5165\u65f6\uff0c\u5fc5\u987b\u9996\u5148\u4ece\u7f13\u51b2\u6c60\u4e2d\u83b7\u53d6\u8be5\u9875\u9762\uff08\u4f7f\u7528\u5176\u552f\u4e00\u7684 page_id \uff09\uff0c\u5c06\u5176\u91cd\u65b0\u89e3\u91ca\u8f6c\u6362\u4e3a\u53f6\u5b50\u8282\u70b9\u6216\u5185\u90e8\u9875\u9762\uff0c\u5e76\u5728\u8bfb\u53d6\u6216\u5199\u5165\u540e\u53d6\u6d88\u56fa\u5b9a\u8be5\u9875\u9762\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#_2","title":"\u5b9e\u73b0","text":"<p>\u4f7f\u7528\u4e86\u4e50\u89c2\u9501\u4f18\u5316\uff0c\u9996\u5148\u4ece root \u5230 leaf \u5168\u90e8\u52a0\u8bfb\u9501\uff0c\u5982\u679c\u4e2d\u95f4\u7684\u5185\u90e8\u8282\u70b9\u6216\u8005\u53f6\u5b50\u8282\u70b9\u9700\u8981\u5206\u88c2\u6216\u8005\u5408\u5e76\uff0c\u5219\u91ca\u653e\u6240\u6709\u9501\uff0c\u7136\u540e\u4ece\u5934\u5f00\u59cb\u83b7\u53d6\u5199\u9501\uff0c\u6267\u884c\u6b63\u5e38\u7684\u63d2\u5165\u6216\u5220\u9664\u64cd\u4f5c\u3002</p> <p>\u4f7f\u7528 Context \u6765\u7ef4\u62a4\u4e86\u4ece\u6839\u8282\u70b9\u5230\u53f6\u5b50\u8282\u70b9\u7684\u8def\u5f84\u4ee5\u53ca\u5199\u9501\u548c\u8bfb\u9501\u7684\u96c6\u5408\u3002\u53ef\u4ee5\u907f\u514d\u5728 B+\u6811\u8282\u70b9\u4e2d\u7ef4\u62a4\u7236\u8282\u70b9\u6307\u9488\uff0c\u51cf\u5c0f\u5b58\u50a8\u5f00\u9500\u3002</p> <p>\u6574\u4f53\u5e76\u53d1\u63a7\u5236\u4f7f\u7528 latch crabbing \u7b56\u7565\uff0c\u5982\u679c\u786e\u5b9a\u5f53\u524d\u8282\u70b9\u63d2\u5165\u4e0d\u4f1a\u5206\u88c2/\u5220\u9664\u4e0d\u4f1a\u5408\u5e76\uff0c\u5219\u91ca\u653e\u4e4b\u524d\u7684\u6240\u6709\u5199\u9501\uff0c\u53ea\u4fdd\u7559\u5f53\u524d\u8282\u70b9\u7684\u9501\uff0c\u76f4\u5230\u53f6\u5b50\u8282\u70b9\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#insert","title":"Insert","text":"<ol> <li>\u5982\u679c\u662f\u7a7a\u6811\uff0c\u76f4\u63a5\u5f00\u59cb\u65b0\u6811\u3002</li> <li>\u4ece\u6839\u8282\u70b9\u5f00\u59cb\u4e00\u76f4\u5411\u4e0b\u67e5\u627e\u53f6\u5b50\u8282\u70b9\uff0c\u83b7\u53d6\u8bfb\u9501\uff0c\u5982\u679c\u53f6\u5b50\u8282\u70b9\u672a\u6ee1\uff0c\u5219\u76f4\u63a5\u63d2\u5165\u3002</li> <li>\u5982\u679c\u53f6\u5b50\u8282\u70b9\u5df2\u6ee1\uff0c\u91ca\u653e\u6240\u6709\u8bfb\u9501\uff0c\u91cd\u65b0\u4ece\u6839\u8282\u70b9\u5f00\u59cb\u67e5\u627e\u53f6\u5b50\u8282\u70b9\uff0c\u83b7\u53d6\u5199\u9501\u3002</li> <li>\u5f00\u59cb\u6267\u884c\u9012\u5f52\u63d2\u5165\u8282\u70b9\u76f4\u5230 B+\u6811\u8fbe\u5230\u5e73\u8861\u3002</li> </ol> C++<pre><code>INDEX_TEMPLATE_ARGUMENTS\nauto BPLUSTREE_TYPE::OptiInsert(Context *ctx, const KeyType &amp;key, const ValueType &amp;value) -&gt; bool {\n  ctx-&gt;header_page_ = bpm_-&gt;WritePage(header_page_id_);\n  if (IsEmpty(ctx)) {\n    return StartNewTree(ctx, key, value); // \u5982\u679c\u662f\u7a7a\u6811\uff0c\u76f4\u63a5\u5f00\u59cb\u65b0\u6811\n  }\n  ctx-&gt;ReleaseAllLatch();\n  auto leaf_page_id = OptiFindLeafPage(ctx, Operation::INSERT, key, comparator_, false, false); // \u8bfb\u9501\n  // \u6b64\u65f6ctx.write_set_\u4e2d\u4fdd\u5b58\u8fd9leaf_page\u7684\u5199\u9501\n  auto leaf_page = ctx-&gt;write_set_.back().AsMut&lt;LeafPage&gt;();\n  if (leaf_page-&gt;GetSize() &lt; leaf_page-&gt;GetMaxSize() - 1) {\n    auto before_insert_size = leaf_page-&gt;GetSize();\n    leaf_page-&gt;Insert(key, value, comparator_);\n    auto new_size = leaf_page-&gt;GetSize();\n    // check leaf node whether it is full or not\n    // 1. duplicate key\n    return before_insert_size != new_size;\n  }\n  ctx-&gt;ReleaseAllLatch();\n  ctx-&gt;header_page_ = bpm_-&gt;WritePage(header_page_id_);\n\n  auto new_leaf_page_id = FindLeafPage(ctx, Operation::INSERT, key, comparator_, false, false); // \u5199\u9501\n\n  // \u5982\u679c\u627e\u5230\u53f6\u5b50\u8282\u70b9\uff0c\u4e00\u5b9a\u786e\u4fddctx.write_set_\u4e0d\u4e3a\u7a7a\n  BUSTUB_ASSERT(!ctx-&gt;write_set_.empty(), \"write set is empty\");\n  auto new_leaf_page = ctx-&gt;write_set_.back().template AsMut&lt;LeafPage&gt;();\n\n  auto before_insert_size = new_leaf_page-&gt;GetSize();\n  new_leaf_page-&gt;Insert(key, value, comparator_);\n  auto new_size = new_leaf_page-&gt;GetSize();\n  // check leaf node whether it is full or not\n  // 1. duplicate key\n  if (before_insert_size == new_size) {\n    return false;\n  }\n  // 2. leaf node is  not full\n  if (new_size &lt; new_leaf_page-&gt;GetMaxSize()) {\n    return true;\n  }\n  // 3. leaf node is full\n  auto ret = SplitLeaf(ctx);\n  auto new_key = ret.new_key_;\n  auto new_page_id = ret.new_page_id_;\n\n  InsertIntoParent(ctx, new_leaf_page_id, new_key, new_page_id, 0);\n  return true;\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#remove","title":"Remove","text":"<ol> <li>\u9996\u5148\u5148\u83b7\u53d6\u8bfb\u9501\uff0c\u627e\u5230\u53f6\u5b50\u8282\u70b9\u3002</li> <li>\u5982\u679c\u53f6\u5b50\u8282\u70b9\u672a\u6ee1\uff0c\u5219\u76f4\u63a5\u5220\u9664\u3002</li> <li>\u5982\u679c\u53f6\u5b50\u8282\u70b9\u5df2\u6ee1\uff0c\u91ca\u653e\u6240\u6709\u8bfb\u9501\uff0c\u91cd\u65b0\u4ece\u6839\u8282\u70b9\u5f00\u59cb\u67e5\u627e\u53f6\u5b50\u8282\u70b9\uff0c\u83b7\u53d6\u5199\u9501\u3002</li> <li>\u5f00\u59cb\u6267\u884c\u9012\u5f52\u5220\u9664\u8282\u70b9\u76f4\u5230 B+\u6811\u8fbe\u5230\u5e73\u8861\u3002</li> <li>\u5220\u9664\u65f6\u6211\u4eec\u8fd9\u91cc\u5148\u8fdb\u884c Redistribute\uff0c\u5982\u679c Redistribute \u5931\u8d25\uff0c\u5219\u8fdb\u884c Coalesce\u3002    - Redistribute \u662f\u5c06\u5f53\u524d\u8282\u70b9\u548c\u5144\u5f1f\u8282\u70b9\u7684\u952e\u503c\u5bf9\u8fdb\u884c\u91cd\u65b0\u5206\u914d\uff0c\u4fdd\u8bc1\u4e24\u4e2a\u8282\u70b9\u7684\u952e\u503c\u5bf9\u6570\u91cf\u90fd\u5927\u4e8e\u7b49\u4e8e\u6700\u5c0f\u503c\u3002    - Coalesce \u662f\u5c06\u5f53\u524d\u8282\u70b9\u548c\u5144\u5f1f\u8282\u70b9\u5408\u5e76\uff0c\u4fdd\u8bc1\u4e24\u4e2a\u8282\u70b9\u7684\u952e\u503c\u5bf9\u6570\u91cf\u90fd\u5927\u4e8e\u7b49\u4e8e\u6700\u5c0f\u503c\u3002    - \u5982\u679c\u5f53\u524d\u8282\u70b9\u662f\u6839\u8282\u70b9\u4e14\u53ea\u6709\u4e00\u4e2a\u5b50\u8282\u70b9\uff0c\u5219\u5c06\u6839\u8282\u70b9\u5220\u9664\uff0c\u5b50\u8282\u70b9\u4f5c\u4e3a\u65b0\u7684\u6839\u8282\u70b9\uff0c\u6811\u9ad8\u5ea6\u51cf\u4e00\u3002</li> </ol> C++<pre><code>INDEX_TEMPLATE_ARGUMENTS\nvoid BPLUSTREE_TYPE::OptiRemove(Context *ctx, const KeyType &amp;key) {\n  ctx-&gt;header_page_ = bpm_-&gt;WritePage(header_page_id_);\n  if (IsEmpty(ctx)) {\n    return;\n  }\n  ctx-&gt;ReleaseAllLatch();\n  auto leaf_page_id = OptiFindLeafPage(ctx, Operation::REMOVE, key, comparator_, false, false);\n\n  auto leaf_page = ctx-&gt;write_set_.back().AsMut&lt;LeafPage&gt;();\n  if (leaf_page-&gt;GetSize() &gt; leaf_page-&gt;GetMinSize()) {\n    leaf_page-&gt;RemoveAndDeleteRecord(key, comparator_);\n    return;\n  }\n  ctx-&gt;ReleaseAllLatch();\n  ctx-&gt;header_page_ = bpm_-&gt;WritePage(header_page_id_);\n  auto new_leaf_page_id = FindLeafPage(ctx, Operation::REMOVE, key, comparator_, false, false);\n  if (leaf_page_id == INVALID_PAGE_ID) {\n    return;\n  }\n\n  DeleteEntry(ctx, key, -1, new_leaf_page_id, 0);\n}\n\nINDEX_TEMPLATE_ARGUMENTS\nauto BPLUSTREE_TYPE::DeleteEntry(Context *ctx, const KeyType &amp;key, int delete_index, page_id_t current_page_id,\n                                 int recursive_level) -&gt; bool {\n  if (ctx-&gt;IsRootPage(current_page_id)) {\n    AdjustRoot(ctx);\n    return true;\n  }\n  // ...\n  bool redistribute = Redistribute(ctx, old_page_index, sibling_index, recursive_level, parent_key);\n  if (!redistribute) {\n    if (old_page_index != 0) {\n      coalesec = Coalesce(ctx, sibling_index, true, recursive_level, parent_key);\n    } else {\n      coalesec = Coalesce(ctx, sibling_index, false, recursive_level, parent_key);\n    }\n  }\n  return true;\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#search","title":"Search","text":"<ol> <li>\u4ece\u6839\u8282\u70b9\u5f00\u59cb\uff0c\u83b7\u53d6\u8bfb\u9501\uff0c\u5411\u4e0b\u67e5\u627e\u53f6\u5b50\u8282\u70b9\u3002</li> <li>\u5982\u679c\u627e\u5230\u53f6\u5b50\u8282\u70b9\uff0c\u5219\u8fd4\u56de\u53f6\u5b50\u8282\u70b9\u4e2d\u7684\u503c\u3002</li> </ol>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#iterator","title":"Iterator","text":"<p>\u9700\u8981\u6ce8\u610f BPlusTree \u7684 Begin()\u548c End()\u65b9\u6cd5\u5728\u540e\u9762 IndexScan \u7b97\u5b50\u4e2d\u4f1a\u7528\u5230\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u8bbe\u8ba1 IndexIterator \u91cc\u9762\u5305\u542b\u4e00\u4e2a ReadPageGuard\uff0c\u7528\u4e8e\u5728\u8fed\u4ee3\u5668\u4e2d\u8bfb\u53d6\u53f6\u5b50\u8282\u70b9\u7684\u5185\u5bb9\u3002</p> <ul> <li>End()\u65b9\u6cd5\u7684\u8fed\u4ee3\u5668\u91cc\u9762\u5b9e\u9645\u4e0a\u6ca1\u6709\u5185\u5bb9\uff0c\u6240\u4ee5\u6211\u4eec\u5728 IndexIterator \u4e2d\u4f7f\u7528 std::optional \u6765\u8868\u793a\u662f\u5426\u6709\u53f6\u5b50\u8282\u70b9\u7684\u5185\u5bb9\u3002</li> </ul> C++<pre><code>INDEX_TEMPLATE_ARGUMENTS\nclass IndexIterator {\n private:\n  // add your own private member variables here\n  BufferPoolManager *bpm_;\n  std::optional&lt;ReadPageGuard&gt; leaf_page_guard_;\n  int index_;\n};\n\nINDEX_TEMPLATE_ARGUMENTS\nauto BPLUSTREE_TYPE::Begin(const KeyType &amp;key) -&gt; INDEXITERATOR_TYPE {\n  Context ctx;\n  FindLeafPage(&amp;ctx, Operation::SEARCH, key, comparator_, false, false);\n  auto *leaf_page = ctx.read_set_.back().As&lt;LeafPage&gt;();\n  auto index = leaf_page-&gt;KeyIndex(key, comparator_);\n  return INDEXITERATOR_TYPE(bpm_, std::optional&lt;ReadPageGuard&gt;(std::move(ctx.read_set_.back())), index);\n}\n\nINDEX_TEMPLATE_ARGUMENTS\nauto BPLUSTREE_TYPE::End() -&gt; INDEXITERATOR_TYPE {\n  return INDEXITERATOR_TYPE(bpm_, std::nullopt, 0);\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#sql-support","title":"SQL support","text":"<p>Slotted page \u7684\u6574\u4f53\u5e03\u5c40\uff0c\u5176\u4e2d tuple meta \u4e2d\u5305\u542b\u4e86\u4e8b\u52a1\u7684\u65f6\u95f4\u6233\u548c\u5220\u9664\u6807\u8bb0\u3002Tuple \u7ed3\u6784\u4f53\u5305\u542b\u4e86 RID \u548c\u6570\u636e\u90e8\u5206\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u7684 DELETE \u64cd\u4f5c\u5b9e\u9645\u4e0a\u662f\u5c06 tuple \u7684 isdeleted \u6807\u8bb0\u4e3a true\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u5220\u9664 tuple\u3002\u8fd9\u6837\u53ef\u4ee5\u5b9e\u73b0 MVCC \u7684\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\u3002\u540e\u9762\u5b9e\u73b0 MVCC \u65f6\uff0c\u6211\u4eec\u4f1a\u6709\u540e\u53f0 GC \u7ebf\u7a0b\u6765\u6e05\u7406\u8fd9\u4e9b\u88ab\u5220\u9664\u4e14\u4e0d\u518d\u88ab\u5176\u4ed6\u4e8b\u52a1\u5f15\u7528\u7684 tuple\u3002</p> C++<pre><code>/**\n * Slotted page format:\n *  ---------------------------------------------------------\n *  | HEADER | ... FREE SPACE ... | ... INSERTED TUPLES ... |\n *  ---------------------------------------------------------\n *                                ^\n *                                free space pointer\n *\n *  Header format (size in bytes):\n *  ----------------------------------------------------------------------------\n *  | NextPageId (4)| NumTuples(2) | NumDeletedTuples(2) |\n *  ----------------------------------------------------------------------------\n *  ----------------------------------------------------------------\n *  | Tuple_1 offset+size (4) | Tuple_2 offset+size (4) | ... |\n *  ----------------------------------------------------------------\n *\n * Tuple format:\n * | meta | data |\n */\n struct TupleMeta {\n  /** the ts / txn_id of this tuple. In project 3, simply set it to 0. */\n  timestamp_t ts_;\n  /** marks whether this tuple is marked removed from table heap. */\n  bool is_deleted_;\n };\n\n class Tuple {\n  RID rid_{};  // if pointing to the table heap, the rid is valid\n  std::vector&lt;char&gt; data_;\n};\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#hash-join","title":"Hash Join","text":"<p>Hash Join \u662f\u4e00\u79cd\u57fa\u4e8e\u54c8\u5e0c\u8868\u7684\u8fde\u63a5\u7b97\u6cd5\uff0c\u4e3b\u8981\u7528\u4e8e\u8fde\u63a5\u4e24\u4e2a\u5173\u7cfb\uff08\u8868\uff09\u3002\u5b83\u7684\u57fa\u672c\u601d\u8def\u662f\u5c06\u5176\u4e2d\u4e00\u4e2a\u5173\u7cfb\uff08\u901a\u5e38\u662f\u8f83\u5c0f\u7684\u5173\u7cfb\uff09\u6784\u5efa\u6210\u54c8\u5e0c\u8868\uff0c\u7136\u540e\u626b\u63cf\u53e6\u4e00\u4e2a\u5173\u7cfb\uff0c\u4f7f\u7528\u54c8\u5e0c\u8868\u6765\u67e5\u627e\u5339\u914d\u7684\u8bb0\u5f55\u3002</p> <p>HashTable \u7684\u6784\u5efa\u5728\u8be5\u7b97\u5b50\u7684\u521d\u59cb\u5316\u9636\u6bb5\uff0c\u5b58\u50a8\u53f3\u4fa7\u7b97\u5b50\u7684\u7ed3\u679c\u3002\u6267\u884c\u9636\u6bb5\u5219\u662f\u5bf9\u5de6\u4fa7\u7b97\u5b50\u7684\u7ed3\u679c\u8fdb\u884c\u626b\u63cf\uff0c\u5e76\u4f7f\u7528\u54c8\u5e0c\u8868\u6765\u67e5\u627e\u5339\u914d\u7684\u8bb0\u5f55\u3002</p> C++<pre><code>void HashJoinExecutor::Init() {\n  // 1. init child executors\n  left_child_executor_-&gt;Init();\n  right_child_executor_-&gt;Init();\n\n  // 2. build hash table for right table\n  Tuple right_tuple{};\n  RID right_rid;\n  while (right_child_executor_-&gt;Next(&amp;right_tuple, &amp;right_rid)) {\n    HashJoinKey key = GetRightJoinKey(&amp;right_tuple);\n    // jht_ \u662f HashJoinTable \u7684\u5b9e\u4f8b\uff0c\u5b58\u50a8\u4e86\u53f3\u8868\u7684\u54c8\u5e0c\u8868\n    jht_-&gt;Insert(key, right_tuple);\n  }\n}\n\nauto HashJoinExecutor::Next(Tuple *tuple, RID *rid) -&gt; bool {\n  if (!results_.empty()) {\n    *tuple = results_.front();\n    *rid = RID{1, 0};\n    results_.pop_front();\n    return true;\n  }\n  auto left_schema = left_child_executor_-&gt;GetOutputSchema();\n  auto right_schema = right_child_executor_-&gt;GetOutputSchema();\n  while (left_child_executor_-&gt;Next(tuple, rid)) {\n    auto left_hash_key = GetLeftJoinKey(tuple);\n    if (jht_-&gt;GetValue(left_hash_key) != nullptr) {\n      for (const auto &amp;right_tuple : *jht_-&gt;GetValue(left_hash_key)) {\n        std::vector&lt;Value&gt; values;\n        for (uint32_t i = 0; i &lt; left_schema.GetColumnCount(); i++) {\n          values.emplace_back(tuple-&gt;GetValue(&amp;left_schema, i));\n        }\n        for (uint32_t i = 0; i &lt; right_schema.GetColumnCount(); i++) {\n          values.emplace_back(right_tuple.GetValue(&amp;right_schema, i));\n        }\n        results_.emplace_back(Tuple{values, &amp;GetOutputSchema()});\n      }\n    } else if (plan_-&gt;GetJoinType() == JoinType::LEFT) {\n      std::vector&lt;Value&gt; values;\n      for (uint32_t i = 0; i &lt; left_schema.GetColumnCount(); i++) {\n        values.emplace_back(tuple-&gt;GetValue(&amp;left_schema, i));\n      }\n      for (uint32_t i = 0; i &lt; right_schema.GetColumnCount(); i++) {\n        values.emplace_back(ValueFactory::GetNullValueByType(right_schema.GetColumn(i).GetType()));\n      }\n      results_.emplace_back(Tuple{values, &amp;GetOutputSchema()});\n    }\n    // \u76f4\u5230\u8fd9\u6b21\u7684left_tuple\u4e0eright_tuples\u5339\u914d\u7684\u6570\u7ec4\u90fd\u88ab\u904d\u5386\u5b8c\u624d\u4f1a\u7ee7\u7eed\u4e0b\u4e00\u6b21\u7684left_tuple\n    if (!results_.empty()) {\n      *tuple = results_.front();\n      *rid = RID{1, 0};\n      results_.pop_front();\n      return true;\n    }\n  }\n  return false;\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#external-merge-sort","title":"External Merge Sort","text":"<p>External Merge Sort \u662f\u4e00\u79cd\u5916\u90e8\u6392\u5e8f\u7b97\u6cd5\uff0c\u4e3b\u8981\u7528\u4e8e\u5904\u7406\u65e0\u6cd5\u5b8c\u5168\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u7684\u5927\u6570\u636e\u96c6\u3002\u5b83\u7684\u57fa\u672c\u601d\u8def\u662f\u5c06\u6570\u636e\u5206\u6210\u591a\u4e2a\u5c0f\u5757\uff0c\u6bcf\u4e2a\u5c0f\u5757\u5728\u5185\u5b58\u4e2d\u8fdb\u884c\u6392\u5e8f\uff0c\u7136\u540e\u5c06\u8fd9\u4e9b\u5df2\u6392\u5e8f\u7684\u5c0f\u5757\u5408\u5e76\u6210\u4e00\u4e2a\u5927\u7684\u6709\u5e8f\u7ed3\u679c\u3002</p> <ol> <li>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 2-way merge sort\uff0c\u4f7f\u7528 MergeSortRun \u6765\u8868\u793a\u4e00\u4e2a\u5df2\u6392\u5e8f\u7684\u5c0f\u5757\u3002\u6bcf\u4e2a MergeSortRun \u5305\u542b\u4e00\u4e2a\u5f53\u524d\u6392\u597d\u5e8f tuple \u7684\u8fed\u4ee3\u5668\u3002</li> <li>\u6240\u6709\u7684\u6392\u5e8f\u5de5\u4f5c\u5728 Init \u9636\u6bb5\u5b8c\u6210\uff0cNext \u65b9\u6cd5\u53ea\u9700\u8981\u4ece\u6700\u540e\u7684\u6392\u5e8f\u7ed3\u679c\u4e2d\u8bfb\u53d6\u6570\u636e\u3002</li> </ol> C++<pre><code>template &lt;size_t K&gt;\nvoid ExternalMergeSortExecutor&lt;K&gt;::Init() {\n  child_executor_-&gt;Init();\n  // 1. \u751f\u6210\u521d\u59cb\u7684mergesortrun\n  auto *bpm = exec_ctx_-&gt;GetBufferPoolManager();\n  // ...\n  while (child_executor_-&gt;Next(&amp;child_tuple, &amp;child_rid)) {\n    auto sort_key = GenerateSortKey(child_tuple, plan_-&gt;GetOrderBy(), GetOutputSchema());\n    buffer.emplace_back(SortEntry{sort_key, child_tuple});\n    if (buffer.size() == max_tuples_per_page) {\n      task_nums++;\n      // \u5c06buffer\u4e2d\u7684\u6570\u636eflush\u5230\u4e00\u4e2a\u65b0\u7684MergeSortRun\u4e2d\n      thread_pool_-&gt;Enqueue([=]() {\n        FlushBufferToRun(buffer, bpm, max_tuples_per_page, tuple_length, runs_);\n        task_nums_.fetch_add(1);\n      });\n      buffer.clear();\n    }\n  }\n  // \u672a\u6ee1\u4e00\u9875\u4e5f\u9700\u8981flush\n  if (!buffer.empty()) {\n    task_nums++;\n    thread_pool_-&gt;Enqueue([=]() {\n      FlushBufferToRun(buffer, bpm, max_tuples_per_page, tuple_length, runs_);\n      task_nums_.fetch_add(1);\n    });\n    buffer.clear();\n  }\n  // \u540c\u6b65IO\u7ebf\u7a0b\uff0c\u4fdd\u8bc1\u6240\u6709\u7684page\u90fd\u662f\u6392\u597d\u5e8f\u7684\n  while (task_nums != task_nums_.load()) {\n  }\n  task_nums_.store(0);\n\n  // 2. merge all runs\n  while (runs_.size() &gt; 1) {\n    std::vector&lt;MergeSortRun&gt; new_runs;\n    // 2-way external merge sort\n    for (size_t i = 0; i &lt; runs_.size(); i += 2) {\n      if (i + 1 &lt; runs_.size()) {\n        Merge2Runs(runs_[i], runs_[i + 1], bpm, max_tuples_per_page, tuple_length, new_runs);\n      } else {\n        new_runs.emplace_back(runs_[i]);\n      }\n    }\n    runs_ = std::move(new_runs);\n  }\n\n  // 3. read the last run\n  if (!runs_.empty()) {\n    current_iterator_ = runs_[0].Begin();\n    end_iterator_ = runs_[0].End();\n    is_inited_ = true;\n  } else {\n    current_iterator_ = {};\n    end_iterator_ = {};\n  }\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#multi-version-concurrency-control-and-optimistic-concurrency-control-mvocc","title":"Multi-version Concurrency Control And Optimistic Concurrency Control (MVOCC)","text":"<p>MVCC \u4fdd\u8bc1\u53ef\u91cd\u590d\u8bfb\uff0cMVCC \u914d\u5408\u884c\u9501+\u95f4\u9699\u9501\uff08MYSQL \u4f7f\u7528\uff09\u6216\u8005 MVCC \u914d\u5408\u4e50\u89c2\u9501\uff08PostgreSQL \u4f7f\u7528\uff09\u53ef\u4ee5\u4fdd\u8bc1\u4e32\u884c\u5316\u9694\u79bb\u7ea7\u522b\u3002Bustub \u5b9e\u73b0\u7684\u662f MVCC + OCC \u5b9e\u73b0\u4e32\u884c\u5316\u9694\u79bb\u7ea7\u522b\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#transaction-manager","title":"Transaction Manager","text":"<p>TransactionManager \u662f\u5168\u5c40\u5b9e\u4f8b\uff0c\u8d1f\u8d23\u7ba1\u7406\u6240\u6709\u4e8b\u52a1\u7684\u751f\u547d\u5468\u671f\u3002\u5b83\u63d0\u4f9b\u4e86\u4e8b\u52a1\u7684\u5f00\u59cb\u3001\u63d0\u4ea4\u548c\u56de\u6eda\u7b49\u64cd\u4f5c\u3002</p> <p>PageVersionInfo \u7528\u4e8e\u5b58\u50a8\u6bcf\u4e2a\u9875\u9762\u7684\u7248\u672c\u4fe1\u606f\uff0c\u5305\u62ec\u4e4b\u524d\u7684\u7248\u672c\u94fe\u63a5\u3002UndoLink \u7528\u4e8e\u5b58\u50a8\u64a4\u9500\u65e5\u5fd7\u7684\u94fe\u8868\uff0cUndoLog \u5219\u662f\u5177\u4f53\u7684\u64a4\u9500\u65e5\u5fd7\u5185\u5bb9\uff0c\u6700\u540e\u4e00\u4e2a UndoLink \u7684 TxnId \u4e3a INVALID_TXN_ID\uff0c\u8868\u793a\u8be5\u7248\u672c\u662f\u6700\u65b0\u7684\u3002</p> <p></p> C++<pre><code>/**\n * TransactionManager keeps track of all the transactions running in the system.\n */\nclass TransactionManager {\n public:\n  /**\n   * Begins a new transaction.\n   * @param isolation_level an optional isolation level of the transaction.\n   * @return an initialized transaction\n   */\n  auto Begin(IsolationLevel isolation_level = IsolationLevel::SNAPSHOT_ISOLATION) -&gt; Transaction *;\n\n  /**\n   * Commits a transaction.\n   * @param txn the transaction to commit, the txn will be managed by the txn manager so no need to delete it by\n   * yourself\n   */\n  auto Commit(Transaction *txn) -&gt; bool;\n\n  /**\n   * Aborts a transaction\n   * @param txn the transaction to abort, the txn will be managed by the txn manager so no need to delete it by yourself\n   */\n  void Abort(Transaction *txn);\n\n  /** @brief Stop-the-world garbage collection. Will be called only when all transactions are not accessing the table\n   * heap. */\n  void GarbageCollection();\n\n  /** protects txn map */\n  std::shared_mutex txn_map_mutex_;\n  /** All transactions, running or committed */\n  std::unordered_map&lt;txn_id_t, std::shared_ptr&lt;Transaction&gt;&gt; txn_map_;\n\n  struct PageVersionInfo {\n    /** protects the map */\n    std::shared_mutex mutex_;\n    /** Stores previous version info for all slots. Note: DO NOT use `[x]` to access it because\n     * it will create new elements even if it does not exist. Use `find` instead.\n     */\n    std::unordered_map&lt;slot_offset_t, UndoLink&gt; prev_link_;\n  };\n\n  /** protects version info */\n  std::shared_mutex version_info_mutex_;\n  /** Stores the previous version of each tuple in the table heap. Do not directly access this field. Use the helper\n   * functions in `transaction_manager_impl.cpp`. */\n  std::unordered_map&lt;page_id_t, std::shared_ptr&lt;PageVersionInfo&gt;&gt; version_info_;\n\n  /** Stores all the read_ts of running txns so as to facilitate garbage collection. */\n  Watermark running_txns_{0};\n\n  /** Only one txn is allowed to commit at a time */\n  std::mutex commit_mutex_;\n  /** The last committed timestamp. */\n  std::atomic&lt;timestamp_t&gt; last_commit_ts_{0};\n\n  /** Catalog */\n  Catalog *catalog_;\n\n  std::atomic&lt;txn_id_t&gt; next_txn_id_{TXN_START_ID};\n};\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#tuple-storage","title":"Tuple Storage","text":"<p>BusTub \u5c06\u4e8b\u52a1\u6570\u636e\u5b58\u50a8\u5728\u4e09\u4e2a\u5730\u65b9\uff1a\u8868\u5806\u3001\u4e8b\u52a1\u7ba1\u7406\u5668\u548c\u6bcf\u4e2a\u4e8b\u52a1\u7684\u5de5\u4f5c\u7a7a\u95f4\u4e2d\u3002\u8868\u5806\u59cb\u7ec8\u5305\u542b\u6700\u65b0\u7684\u5143\u7ec4\u6570\u636e\u3002\u4e8b\u52a1\u7ba1\u7406\u5668\u5b58\u50a8\u6bcf\u4e2a\u5143\u7ec4\u7684\u6700\u65b0\u64a4\u9500\u65e5\u5fd7\u7684\u6307\u9488 ( PageVersionInfo )\u3002\u4e8b\u52a1\u5b58\u50a8\u5b83\u4eec\u521b\u5efa\u7684\u64a4\u9500\u65e5\u5fd7(UndoLog)\uff0c\u8fd9\u4e9b\u65e5\u5fd7\u8bb0\u5f55\u4e86\u4e8b\u52a1\u5982\u4f55\u4fee\u6539\u5143\u7ec4\u3002</p> <ul> <li>\u8981\u5728\u4e00\u4e2a\u7ed9\u5b9a\u7684\u8bfb\u65f6\u95f4\u6233\u4e0b\u68c0\u7d22\u4e00\u4e2a\u5143\u7ec4\uff0c\u4f60\u9700\u8981 (1) \u83b7\u53d6\u6240\u6709\u5728\u8be5\u65f6\u95f4\u6233\u4e4b\u540e\u53d1\u751f\u7684\u4fee\u6539\uff08\u5373\u64a4\u9500\u65e5\u5fd7\uff09\uff0c\u4ee5\u53ca (2) \u4ece\u5143\u7ec4\u7684\u6700\u65b0\u7248\u672c\u4e2d\u56de\u6eda\u8fd9\u4e9b\u4fee\u6539\uff08\u201c\u64a4\u9500\u201d\u64a4\u9500\u65e5\u5fd7\uff09\uff0c\u4ee5\u6062\u590d\u8be5\u5143\u7ec4\u7684\u8fc7\u53bb\u7248\u672c\u3002</li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#undolog","title":"UndoLog","text":"<p>\u65f6\u95f4\u6233\uff08 ts* \uff09\u662f\u6307\u8fd9\u4e2a UndoLog \u5bf9\u5e94\u7684\u63d0\u4ea4\u65f6\u95f4\u6233\u3002\u6211\u4eec\u8fd8\u5b58\u50a8\u4e86\u4e00\u4e2a\u6307\u5411\u4e0b\u4e00\u4e2a UndoLog \u7684\u94fe\u63a5\uff08 prev_version* \u901a\u8fc7 UndoLink \u5b58\u50a8\uff09\u3002\u5982\u679c\u4e00\u4e2a UndoLog \u662f\u7248\u672c\u94fe\u4e2d\u7684\u6700\u540e\u4e00\u4e2a\uff0cTxnId\uff08\u5728\u4ee3\u7801\u4e2d\u5bf9\u5e94 prevtxn \uff09\u5c06\u88ab\u8bbe\u7f6e\u4e3a INVALID_TXN \u3002</p> <p></p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#garbage-collection","title":"Garbage Collection","text":"<p>\u9700\u8981\u904d\u5386\u8868\u5806\u548c\u7248\u672c\u94fe\uff0c\u4ee5\u8bc6\u522b\u4ecd\u53ef\u88ab\u5177\u6709\u6700\u4f4e\u8bfb\u65f6\u95f4\u6233\u7684\u4e8b\u52a1\u8bbf\u95ee\u7684\u64a4\u9500\u65e5\u5fd7\u3002\u5982\u679c\u4e8b\u52a1\u5df2\u63d0\u4ea4/\u4e2d\u6b62\uff0c\u5e76\u4e14\u4e0d\u5305\u542b\u5bf9\u5177\u6709\u6700\u4f4e\u8bfb\u65f6\u95f4\u6233\u7684\u4e8b\u52a1\u53ef\u89c1\u7684\u4efb\u4f55\u64a4\u9500\u65e5\u5fd7\uff0c\u53ef\u4ee5\u76f4\u63a5\u5c06\u5176\u4ece\u4e8b\u52a1\u6620\u5c04\u4e2d\u79fb\u9664\u3002</p> <p>\u4e0b\u9762\u7684\u4f8b\u5b50\u8bf4\u660e\u4e86\u5f53\u6c34\u4f4d\u65f6\u95f4\u6233\u4e3a 3 \u65f6\uff0c\u6211\u4eec\u5df2\u7ecf\u6709 txn1 \u3001 txn2 \u548c txn9 \u63d0\u4ea4\u7684\u60c5\u51b5\u3002</p> <p></p> <ul> <li>txn1 \u7684\u64a4\u9500\u65e5\u5fd7\u4e0d\u518d\u53ef\u8bbf\u95ee\uff0c\u56e0\u4e3a\u6240\u6709\u63d0\u4ea4\u65f6\u95f4\u6233\u4e3a 1 \u7684\u64a4\u9500\u65e5\u5fd7\u90fd\u88ab\u63d0\u4ea4\u65f6\u95f4\u6233\u5c0f\u4e8e\u6216\u7b49\u4e8e 3 \u7684\u66f4\u65b0\u8986\u76d6\u4e86\u3002\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5220\u9664 txn1 \u3002</li> <li>txn2 \u7684\u5143\u7ec4(A, 2)\u7684\u64a4\u9500\u65e5\u5fd7\u4e0d\u53ef\u8bbf\u95ee\uff0c\u4f46\u5176\u5143\u7ec4(C, 2)\u7684\u64a4\u9500\u65e5\u5fd7\u4ecd\u7136\u53ef\u8bbf\u95ee\uff0c\u56e0\u4e3a\u6ca1\u6709\u989d\u5916\u7684\u66f4\u65b0\uff0c\u6240\u4ee5\u6211\u4eec\u73b0\u5728\u4e0d\u80fd\u5220\u9664\u5b83\u3002</li> </ul>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#abort","title":"Abort","text":"<p>\u8fdb\u5165 TAINTED \u72b6\u6001\u7684\u4e8b\u52a1\u4f1a\u5bfc\u81f4\u5176\u4ed6\u4e8b\u52a1\u5728\u5199\u51b2\u7a81\u7684\u5143\u7ec4\u4e0a\u4e2d\u6b62\u3002\u5f53\u4e2d\u6b62\u4e00\u4e2a\u4e8b\u52a1\u65f6\uff0c\u6211\u4eec\u5e94\u8be5\u64a4\u9500\u8fd9\u4e2a\u4fee\u6539\uff0c\u4ee5\u4fbf\u5176\u4ed6\u4e8b\u52a1\u53ef\u4ee5\u5199\u5165\u5143\u7ec4\u3002</p> <p></p> <p>\u4e2d\u6b62 txn9 \u5c06\u539f\u5b50\u6027\u5730\u5c06\u64a4\u9500\u94fe\u63a5\u94fe\u63a5\u5230\u524d\u4e00\u4e2a\u7248\u672c\u5e76\u66f4\u65b0\u8868\u5806\u3002\u6211\u4eec\u4f7f\u7528 UpdateTupleAndUndoLink / GetTupleAndUndoLink \u6765\u539f\u5b50\u6027\u5730\u66f4\u65b0/\u8bfb\u53d6\u5143\u7ec4\u548c\u64a4\u9500\u94fe\u63a5\u3002</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#trasaction","title":"Trasaction","text":"<p>Transaction \u662f\u4e8b\u52a1\u5bf9\u8c61\uff0c\u5305\u542b\u4e00\u4e2a\u8bfb\u53d6\u65f6\u95f4\u6233\u548c\u4e00\u4e2a\u63d0\u4ea4\u65f6\u95f4\u6233\u3002\u4e8b\u52a1\u7684\u72b6\u6001\u7531 TransactionState \u679a\u4e3e\u7c7b\u578b\u8868\u793a\uff0c\u53ef\u80fd\u7684\u72b6\u6001\u5305\u62ec RUNNING\u3001COMMITTED \u548c TAINTED \u3002</p> <p>\u5199\u96c6\u5408\u548c\u626b\u63cf\u8c13\u8bcd\u96c6\u5408\u7528\u4e8e OCC \u5224\u65ad\u4e8b\u52a1\u4e0e\u5728\u6211\u8bfb\u53d6\u65f6\u95f4\u6233\u4e4b\u524d\u7684\u4e8b\u52a1\u662f\u5426\u5b58\u5728\u51b2\u7a81\u3002\u5199\u96c6\u5408\u5b58\u50a8\u4e86\u4e8b\u52a1\u4fee\u6539\u7684\u5143\u7ec4\u7684 RID\uff0c\u800c\u626b\u63cf\u8c13\u8bcd\u96c6\u5408\u5b58\u50a8\u4e86\u4e8b\u52a1\u8bfb\u53d6\u7684\u5143\u7ec4\u7684\u8c13\u8bcd\u3002</p> C++<pre><code>/**\n * Transaction tracks information related to a transaction.\n */\nclass Transaction {\n  // The below fields should be ONLY changed by txn manager (with the txn manager lock held).\n\n  /** The state of this transaction. */\n  std::atomic&lt;TransactionState&gt; state_{TransactionState::RUNNING};\n\n  /** The read ts */\n  std::atomic&lt;timestamp_t&gt; read_ts_{0};\n\n  /** The commit ts */\n  std::atomic&lt;timestamp_t&gt; commit_ts_{INVALID_TS};\n\n  /** The latch for this transaction for accessing txn-level undo logs, protecting all fields below. */\n  std::mutex latch_;\n\n  /**\n   * @brief Store undo logs. Other undo logs / table heap will store (txn_id, index) pairs, and therefore\n   * you should only append to this vector or update things in-place without removing anything.\n   */\n  std::vector&lt;UndoLog&gt; undo_logs_;\n\n  /** stores the RID of write tuples */\n  std::unordered_map&lt;table_oid_t, std::unordered_set&lt;RID&gt;&gt; write_set_;\n  /** store all scan predicates */\n  std::unordered_map&lt;table_oid_t, std::vector&lt;AbstractExpressionRef&gt;&gt; scan_predicates_;\n\n  // The below fields are set when a txn is created and will NEVER be changed.\n\n  /** The isolation level of the transaction. */\n  const IsolationLevel isolation_level_;\n\n  /** The thread ID which the txn starts from.  */\n  const std::thread::id thread_id_;\n\n  /** The ID of this transaction. */\n  const txn_id_t txn_id_;\n};\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#timestamp","title":"TimeStamp","text":"<p>\u5728 BusTub \u4e2d\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u5c06\u88ab\u5206\u914d\u4e24\u4e2a\u65f6\u95f4\u6233\uff1a\u4e00\u4e2a\u8bfb\u53d6\u65f6\u95f4\u6233\u548c\u4e00\u4e2a\u63d0\u4ea4\u65f6\u95f4\u6233\u3002</p> <ul> <li> <p>\u5f53\u4e8b\u52a1\u5f00\u59cb\u65f6\uff0c\u5b83\u5c06\u88ab\u5206\u914d\u4e00\u4e2a\u8bfb\u53d6\u65f6\u95f4\u6233\uff0c\u8be5\u65f6\u95f4\u6233\u7b49\u4e8e\u6700\u8fd1\u63d0\u4ea4\u7684\u4e8b\u52a1\u7684\u63d0\u4ea4\u65f6\u95f4\u6233\u3002\u4ece\u9ad8\u5c42\u6b21\u6765\u770b\uff0c\u4f60\u53ef\u4ee5\u5c06\u5176\u7406\u89e3\u4e3a\u8bb0\u5f55\u6570\u636e\u5e93\u4e2d\u6700\u65b0\u539f\u5b50\u5199\u5165\u7684\u65f6\u95f4\u6233\u3002\u8bfb\u53d6\u65f6\u95f4\u6233\u51b3\u5b9a\u4e86\u4e8b\u52a1\u53ef\u4ee5\u5b89\u5168\u4e14\u6b63\u786e\u8bfb\u53d6\u54ea\u4e9b\u6570\u636e\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u8bfb\u53d6\u65f6\u95f4\u6233\u51b3\u5b9a\u4e86\u5f53\u524d\u4e8b\u52a1\u53ef\u4ee5\u770b\u5230\u7684\u5143\u7ec4\u7684\u6700\u65b0\u7248\u672c\u3002</p> </li> <li> <p>\u5f53\u4e8b\u52a1\u63d0\u4ea4\u65f6\uff0c\u5b83\u5c06\u88ab\u5206\u914d\u4e00\u4e2a\u5355\u8c03\u9012\u589e\u7684\u63d0\u4ea4\u65f6\u95f4\u6233\u3002\u63d0\u4ea4\u65f6\u95f4\u6233\u51b3\u5b9a\u4e86\u4e8b\u52a1\u7684\u5e8f\u5217\u5316\u987a\u5e8f\u3002\u7531\u4e8e\u8fd9\u4e9b\u63d0\u4ea4\u65f6\u95f4\u6233\u662f\u552f\u4e00\u7684\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u63d0\u4ea4\u65f6\u95f4\u6233\u552f\u4e00\u5730\u8bc6\u522b\u5df2\u63d0\u4ea4\u7684\u4e8b\u52a1\u3002</p> </li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#generate-undolog","title":"Generate UndoLog","text":"<p>\u9700\u8981\u8003\u8651\u4e09\u79cd\u60c5\u51b5\uff1a</p> <ol> <li> <p>\u66f4\u65b0\uff1a\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u57fa\u4e8e\u57fa\u7840\u5143\u7ec4\u548c\u76ee\u6807\u5143\u7ec4\u751f\u6210 UndoLog \u3002\u5982\u679c\u8fd9\u4e0d\u662f\u8be5\u4e8b\u52a1\u4e2d\u7684\u7b2c\u4e00\u6b21\u66f4\u65b0\uff0c\u5219\u901a\u8fc7 GenerateUpdatedUndoLog \u5c06\u5176\u4e0e\u539f\u59cb UndoLog \u5408\u5e76\u3002\u8bf7\u6ce8\u610f\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u6700\u591a\u5e94\u4fdd\u7559\u4e00\u4e2a\u9488\u5bf9\u6bcf\u4e2a RID \u7684\u64a4\u9500\u65e5\u5fd7\u3002\u5982\u679c\u4e8b\u52a1\u9700\u8981\u4e24\u6b21\u66f4\u65b0\u5143\u7ec4\uff0c\u5b83\u5e94\u8be5\u53ea\u66f4\u65b0\u57fa\u7840\u5143\u7ec4\u53ca\u5176\u5f53\u524d\u7684\u64a4\u9500\u65e5\u5fd7\u3002</p> </li> <li> <p>\u5220\u9664\uff1a\u5982\u679c\u4e0d\u662f\u5f53\u524d\u4e8b\u52a1\u4fee\u6539\uff0c\u751f\u6210\u65b0 UndoLog\uff1b\u5982\u679c\u662f\u5f53\u524d\u4e8b\u52a1\u4fee\u6539\uff0c\u5219\u9700\u8981\u5c06\u5143\u6570\u636e\u66f4\u65b0\u4e3a\u5220\u9664\u72b6\u6001\uff0c\u5e76 UpdateUndoLog \u4fdd\u8bc1\u6bcf\u4e2a tuple \u5bf9\u6bcf\u4e2a\u4e8b\u52a1\u53ea\u6709\u4e00\u4e2a UndoLog\u3002</p> </li> <li> <p>\u63d2\u5165\uff1atuple \u88ab\u5f53\u524d\u4e8b\u52a1\u5220\u9664\uff0c\u4f46\u662f\u7d22\u5f15\u8fd8\u5b58\u5728\uff0c\u66f4\u65b0 tuple \u5143\u6570\u636e\u4ee5\u53ca Undolog\uff1b\u5982\u679c\u88ab\u53e6\u4e00\u4e8b\u52a1\u5220\u9664\uff0c\u9700\u8981\u751f\u6210\u65b0\u7684 undolog \u63d2\u5165\u5230 undo_link \u4e2d\u3002</p> </li> </ol>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#optimistic-concurrency-control","title":"Optimistic Concurrency Control","text":"<p>Optimistic Concurrency Control (OCC) \u662f\u4e00\u79cd\u4e50\u89c2\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u4e3b\u8981\u7528\u4e8e\u5904\u7406\u4e8b\u52a1\u4e4b\u95f4\u7684\u5e76\u53d1\u51b2\u7a81\u3002\u5b83\u7684\u57fa\u672c\u601d\u8def\u662f\u5141\u8bb8\u4e8b\u52a1\u5728\u6ca1\u6709\u9501\u7684\u60c5\u51b5\u4e0b\u6267\u884c\uff0c\u76f4\u5230\u63d0\u4ea4\u65f6\u624d\u68c0\u67e5\u662f\u5426\u5b58\u5728\u51b2\u7a81\u3002</p> <p>\u6240\u8c13\u7684\u51b2\u7a81\u68c0\u6d4b, \u5c31\u662f\u9a8c\u8bc1 timestamp ordering \u51b3\u5b9a\u7684\u4e8b\u52a1\u6267\u884c\u987a\u5e8f\u548c data dependence \u51b3\u5b9a\u7684\u4e8b\u52a1\u6267\u884c\u987a\u5e8f\u662f\u5426\u5b58\u5728\u77db\u76fe</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#wawwrite-after-write","title":"WAW(write-after-write)","text":"<p>\u4e5f\u53eb\u505a output dependence, T1.write \u2192 T2.write =&gt; T1 \u2192 T2; </p> <p>\u5982\u679c\u4e24\u4e2a\u4e8b\u52a1\u90fd\u63d0\u4ea4, \u5219\u5148\u63d0\u4ea4\u7684\u4e8b\u52a1(T2) overwrite \u540e\u63d0\u4ea4\u7684\u4e8b\u52a1(T1)\u7684\u7ed3\u679c , i.e. Lost Update.</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#warwrite-after-read","title":"WAR(write-after-read):","text":"<p>\u4e5f\u53eb\u505a anti-dependence, T1.read \u2192 T2.write =&gt; T1 \u2192 T2; </p> <p>\u5982\u679c\u4e24\u4e2a\u4e8b\u52a1\u90fd\u63d0\u4ea4, \u5219\u5148\u63d0\u4ea4\u7684\u4e8b\u52a1(T2)\u7684\u7ed3\u679c\u5bf9\u540e\u63d0\u4ea4\u7684\u4e8b\u52a1(T1)\u4e0d\u53ef\u89c1, \u540e\u63d0\u4ea4\u7684\u4e8b\u52a1(T1)\u4f9d\u7136\u6839\u636e Stale \u8bb0\u5f55\u4fee\u6539\u6570\u636e\u5e93, \u5bfc\u81f4\u5148\u63d0\u4ea4\u4e8b\u52a1(T2)\u7684\u7ed3\u679c\u88ab\u8986\u76d6\u800c\u4e22\u5931. i.e. Lost Update.</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#rawread-after-write","title":"RAW(read-after-write):","text":"<p>\u4e5f\u53eb\u505a flow dependence, T1.write \u2192 T2.read =&gt; T1 \u2192 T2 </p> <p>\u6240\u4ee5\u4e0d\u53ef\u80fd\u51fa\u73b0 RAW \u51b2\u7a81.</p>","tags":["Database"]},{"location":"blogs/posts/bustub%E9%80%9A%E5%85%B3%E6%8C%87%E5%8C%97/#bustub-occ","title":"Bustub OCC \u5b9e\u73b0","text":"<ol> <li>\u4e0d\u9700\u8981\u9a8c\u8bc1\u53ea\u8bfb\u4e8b\u52a1\uff0c\u56e0\u4e3a RAW \u51b2\u7a81\u4e0d\u53ef\u80fd\u53d1\u751f\u3002</li> <li>\u6536\u96c6\u6240\u6709\u5728\u5f53\u524d\u4e8b\u52a1\u7684\u8bfb\u65f6\u95f4\u6233\u4e4b\u540e\u63d0\u4ea4\u7684\u4e8b\u52a1\u3002\u6211\u4eec\u5c06\u8fd9\u4e9b\u4e8b\u52a1\u79f0\u4e3a\u201c\u51b2\u7a81\u4e8b\u52a1\u201d\u3002\uff08WAR/WAW Conflict\uff09</li> <li>\u5bf9\u4e8e\u6bcf\u4e2a\u5143\u7ec4\uff0c\u904d\u5386\u5176\u7248\u672c\u94fe\u4ee5\u9a8c\u8bc1\u5f53\u524d\u4e8b\u52a1\u662f\u5426\u8bfb\u53d6\u4e86\u4efb\u4f55\u201c\u5e7d\u7075\u201d\u3002\u4f60\u53ef\u4ee5\u6536\u96c6\u6240\u6709\u5728\u4e8b\u52a1\u8bfb\u65f6\u95f4\u6233\u4e4b\u524d\u7684\u64a4\u9500\u65e5\u5fd7\u3002\u7136\u540e\u9010\u4e2a\u91cd\u653e\u4ee5\u68c0\u67e5\u4ea4\u96c6\u3002</li> <li>\u5bf9\u4e8e\u7248\u672c\u94fe\u4e2d\u7684\u6bcf\u4e2a\u66f4\u65b0:    - \u5bf9\u4e8e\u63d2\u5165\u64cd\u4f5c\uff0c\u4f60\u5e94\u8be5\u68c0\u67e5\u65b0\u5143\u7ec4\u662f\u5426\u6ee1\u8db3\u5f53\u524d\u4e8b\u52a1\u7684\u4efb\u4f55\u626b\u63cf\u8c13\u8bcd\u3002\u5982\u679c\u6ee1\u8db3\uff0c\u5219\u4e2d\u6b62\u3002    - \u5bf9\u4e8e\u5220\u9664\u64cd\u4f5c\uff0c\u4f60\u5e94\u8be5\u68c0\u67e5\u88ab\u5220\u9664\u7684\u5143\u7ec4\u662f\u5426\u6ee1\u8db3\u5f53\u524d\u4e8b\u52a1\u7684\u4efb\u4f55\u626b\u63cf\u8c13\u8bcd\u3002\u5982\u679c\u6ee1\u8db3\uff0c\u5219\u4e2d\u6b62\u3002    - \u5b58\u5728\u4e00\u79cd\u8fb9\u7f18\u60c5\u51b5\uff0c\u5373\u4e00\u4e2a\u4e8b\u52a1\u63d2\u5165\u7136\u540e\u5220\u9664\u4e00\u4e2a\u5143\u7ec4\uff0c\u8fd9\u4f1a\u5728\u8868\u5806\u4e2d\u7559\u4e0b\u4e00\u4e2a\u5220\u9664\u6807\u8bb0\u3002\u8fd9\u79cd\u60c5\u51b5\u5e94\u8be5\u88ab\u89c6\u4e3a\u65e0\u64cd\u4f5c\uff0c\u800c\u4e0d\u662f\u5220\u9664\u3002    - \u5bf9\u4e8e\u66f4\u65b0\u64cd\u4f5c\uff0c\u4f60\u5e94\u8be5\u68c0\u67e5\u201c\u65e7\u56fe\u50cf\u201d\u548c\u201c\u65b0\u56fe\u50cf\u201d\u3002\u5982\u679c\u5176\u4e2d\u4efb\u4f55\u4e00\u4e2a\u4e0e\u5f53\u524d\u4e8b\u52a1\u7684\u626b\u63cf\u8c13\u8bcd\u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u91cd\u53e0\uff0c\u5c31\u4e2d\u6b62\u3002<ul> <li>\u8003\u8651\u8fd9\u6837\u4e00\u79cd\u60c5\u51b5\uff1a\u4e00\u4e2a\u4e8b\u52a1\u4fee\u6539\u4e86\u4e00\u4e2a\u5143\u7ec4\uff0c\u4f46\u968f\u540e\u53c8\u5c06\u5176\u64a4\u9500\uff0c\u8fd9\u4f1a\u7559\u4e0b\u4e00\u4e2a\u64a4\u9500\u65e5\u5fd7\uff0c\u5176\u4e2d\u67d0\u4e9b\u5217\u88ab\u66f4\u65b0\u4e3a\u76f8\u540c\u7684\u503c\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f60\u4ecd\u7136\u5e94\u8be5\u5c06\u5176\u5904\u7406\u4e3a\u76f8\u540c\u7684\u66f4\u65b0\uff0c\u800c\u4e0d\u662f\u5ffd\u7565\u5b83\uff0c\u5e76\u5728\u5fc5\u8981\u65f6\u4e2d\u6b62\u4e8b\u52a1\u3002</li> <li>\u7136\u800c\uff0c\u5982\u679c\u5b58\u5728\u4e24\u4e2a\u4e8b\u52a1\uff0c\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u5c06\u503c\u4ece X \u4fee\u6539\u4e3a Y\uff0c\u7136\u540e\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u5c06 Y \u4fee\u6539\u4e3a X\uff0c\u90a3\u4e48\u5f53\u6709\u4e00\u4e2a\u4e8b\u52a1 txn3 \u5728 txn1 \u5f00\u59cb\u4e4b\u524d\u542f\u52a8\uff0c\u5e76\u5728 txn2 \u63d0\u4ea4\u4e4b\u540e\u63d0\u4ea4\u65f6\uff0c\u4f60\u4ecd\u7136\u5e94\u8be5\u68c0\u6d4b\u5230 X \u53d1\u751f\u4e86\u53d8\u5316\u6240\u5f15\u53d1\u7684\u51b2\u7a81\u3002</li> </ul> </li> </ol>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/","title":"\u4e0a\u7bc7\uff1a\u521d\u8bc6 Nebula Graph \u2014\u2014 \u5411\u91cf\u7c7b\u578b\u652f\u6301","text":"2025-10-282025-12-13 <code>#Database</code>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#nebula-graph","title":"\u4e0a\u7bc7\uff1a\u521d\u8bc6 Nebula Graph \u2014\u2014 \u5411\u91cf\u7c7b\u578b\u652f\u6301","text":"<p> \u7ea6 2614 \u4e2a\u5b57  204 \u884c\u4ee3\u7801  7 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 16 \u5206\u949f</p> <p>\ud83d\udcda \u672c\u7cfb\u5217\u6587\u7ae0\u5206\u4e3a\u4e0a\u4e2d\u4e0b\u4e09\u7bc7\uff0c\u8bb0\u5f55\u4e86\u6211\u5728\u5f00\u6e90\u4e4b\u590f\u9879\u76ee\u4e2d\uff0c\u5f00\u53d1 Nebula Graph \u5411\u91cf\u641c\u7d22\u529f\u80fd\u7684\u4e00\u4e9b\u590d\u76d8\u548c\u601d\u8003\uff0c\u5e0c\u671b\u53ef\u4ee5\u7ed9\u5927\u5bb6\u5b66\u4e60\u548c\u5f00\u53d1\u7c7b\u4f3c\u7cfb\u7edf\u65f6\u6709\u4e00\u5b9a\u7684\u6837\u672c\u53c2\u8003\u3002\u5e0c\u671b\u5927\u5bb6\u591a\u591a\u5173\u6ce8\u548c\u4ea4\u6d41\uff0c\u5927\u5bb6\u4e00\u8d77\u8fdb\u6b65 \ud83d\ude0a \u6b22\u8fce\u8ba2\u9605\u6211\u7684\u4e2a\u4eba\u7f51\u7ad9 tom-jerr.github.io</p> <p>\u4e0a\u7bc7\u4e3b\u8981\u4ecb\u7ecd Nebula Graph \u7684\u6574\u4f53\u6267\u884c\u6d41\u7a0b\uff0c\u91cd\u70b9\u8bb2\u89e3\u5411\u91cf\u7c7b\u578b\u7684\u8bbe\u8ba1\u548c\u5411\u91cf\u5b58\u50a8\u7684\u8bbe\u8ba1\u601d\u8def\u3002</p> <p>\u4e2d\u7bc7\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u652f\u6301\u5411\u91cf\u5c5e\u6027\u7684 DDL \u548c DML \u8bed\u53e5( \u8d70\u4e86\u5f88\u591a\u8bbe\u8ba1\u7684\u5f2f\u8def)\u3002</p> <p>\u4e0b\u7bc7\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u5b9e\u73b0\u5411\u91cf\u7d22\u5f15\u548c\u5411\u91cf\u641c\u7d22\u529f\u80fd\u3002</p> <p>\u5728\u771f\u6b63\u5f00\u59cb\u5bf9 Nebula Graph \u8fdb\u884c\u5927\u5200\u9614\u65a7\u7684\u6539\u52a8\u4e4b\u524d\uff0c\u6211\u4eec\u5fc5\u987b\u5148\u4e86\u89e3\uff0c\u4e00\u6761 Cypher \u8bed\u53e5\u662f\u5982\u4f55\u5728\u7cfb\u7edf\u4e2d\u6267\u884c\u7684\u3002\u5f53\u6709\u4e86\u5bf9\u8bed\u53e5\u6267\u884c\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u6211\u4eec\u53ef\u4ee5\u5f00\u59cb\u6df1\u5165\u6bcf\u4e2a\u6a21\u5757\u8fdb\u884c\u4fee\u6539\u6765\u652f\u6301\u5411\u91cf\u529f\u80fd\u3002</p> <p>\u8fd9\u7bc7\u6587\u7ae0\u4e3b\u8981\u4ece\u5bf9 Nebula Graph \u7684\u6574\u4f53\u6267\u884c\u6d41\u7a0b\u51fa\u53d1\uff0c\u805a\u7126\u5982\u4f55\u5b9e\u73b0 Vector \u6570\u636e\u7c7b\u578b\u4ee5\u53ca Vector \u5b58\u50a8\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#cypher","title":"\u4e00\u6761 Cypher \u8bed\u53e5\u7684\u524d\u4e16\u4eca\u751f","text":"<p>\u26a0 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6574\u4e2a Nebula Graph \u7cfb\u7edf\u7684\u6267\u884c\u8def\u5f84\u90fd\u662f\u5f02\u6b65\u7684\uff0c\u8c03\u7528\u8005\u7acb\u5373\u62ff\u5230 Future\uff0c\u800c\u6267\u884c\u8005\u5728\u5de5\u4f5c\u5b8c\u6210\u540e\u901a\u8fc7 Promise \u586b\u5145\u7ed3\u679c\uff0c\u7136\u540e\u81ea\u52a8\u89e6\u53d1 Future \u4e0a\u7684\u56de\u8c03\u6267\u884c\u540e\u7eed\u903b\u8f91\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#overview","title":"Overview","text":"<ol> <li>\u7528\u6237\u5728 <code>console</code> \u6216\u8005\u901a\u8fc7 <code>sdk</code> \u8f93\u5165 Cypher \u8bed\u53e5\u5230 Graph Service\uff0c\u7acb\u5373\u8fd4\u56de\u7ed9\u7528\u6237 Future\uff0c\u7ebf\u7a0b\u6c60\u7684\u5de5\u4f5c\u7ebf\u7a0b\u5f00\u59cb\u6267\u884c\u4e0b\u9762\u7684\u771f\u5b9e\u5de5\u4f5c\u6d41\u7a0b\u3002</li> <li>Graph Service \u5c06 Query\u3001Session\u3001Storage \u7b49\u6253\u5305\u6210 Request Context\uff0c\u968f\u540e\u5c06 Request Context \u6253\u5305\u6210 Query Context\uff0c\u521b\u5efa Query Instance \u968f\u540e\u5f00\u59cb\u6267\u884c parse\u3001validate\u3001optimize\u3001execute \u6574\u4e2a\u6d41\u7a0b\uff0c\u8fd9\u91cc\u751f\u6210\u4e86 Graphd \u7684\u7269\u7406\u8ba1\u5212\u3002    - Query Context \u7684\u751f\u547d\u5468\u671f\u4ece\u8bed\u53e5\u4f20\u5165 Graphd \u5f00\u59cb\uff0c\u5230\u5411 client \u8fd4\u56de\u7ed3\u679c</li> <li>\u7136\u540e\u5c06 Request Context \u4f20\u5165 Scheduler\uff0c\u6309\u7167\u7b97\u5b50\u6811\u4f9d\u6b21\u6267\u884c\u6bcf\u4e2a\u7269\u7406\u8282\u70b9\u8ba1\u5212\u3002</li> <li>\u6bcf\u4e2a\u7269\u7406\u8282\u70b9\u8ba1\u5212\u5728 Graphd \u4e2d\u5b58\u5728\u4e00\u4e2a executor\uff0c\u5b9e\u9645\u4e0a\u91cc\u9762\u8c03\u7528\u4e86 storaged \u7684 processor\u3002</li> <li>Storaged \u7684\u6bcf\u4e2a processor \u5185\u90e8\u4e5f\u4f1a\u751f\u6210\u81ea\u5df1\u7684\u6267\u884c\u8ba1\u5212\u3002    - \u771f\u6b63\u5bf9\u6570\u636e\u7684\u64cd\u4f5c\u8ba1\u5212\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a(node)\uff1a\u4ece RocksDB \u4e2d\u83b7\u53d6\u6216\u8005\u5b58\u50a8 KV \u5bf9\uff0c\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 raft-wal \u8fdb\u884c\u96c6\u7fa4\u95f4\u7684\u6570\u636e\u540c\u6b65\uff08\u786e\u4fdd\u539f\u5b50\u6027\u548c\u4e00\u81f4\u6027\uff09\uff0c\u7136\u540e\u7528\u7ed3\u679c\u53bb\u8bbe\u7f6e Promise\uff0c\u89e6\u53d1 Future \u56de\u8c03\u8fd4\u56de\u7ed9 client \u7ed3\u679c\u3002</li> </ol>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#details","title":"Details","text":"<p>\u5b9e\u9645\u4e0a\u6bd4\u8f83\u91cd\u8981\u7684\u5c31\u662f\u4e09\u4e2a\u5b88\u62a4\u8fdb\u7a0b\uff1a\u8ba1\u7b97\u8282\u70b9 Graphd\u3001\u5143\u6570\u636e\u8282\u70b9 Metad \u548c\u5b58\u50a8\u8282\u70b9 Storaged\uff0c\u4e0b\u9762\u4ee5 Insert \u8bed\u53e5\u6267\u884c\u4e3a\u4f8b\uff0c\u8be6\u7ec6\u89e3\u91ca\u4e0b\u6574\u4e2a\u8bed\u53e5\u6267\u884c\u6d41\u7a0b\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#graphd","title":"Graphd","text":"<p>Graphd \u5927\u4f53\u4e0a\u5206\u4e3a parse\uff0cvalidate\uff0cplanner\uff0coptimize\uff0cexecute \u8fd9\u51e0\u4e2a\u9636\u6bb5\u3002\u6240\u6709\u7684 statement\u3001execplan \u4ee5\u53ca\u6700\u540e\u7684 resultset \u5305\u62ec\u539f\u59cb\u7684 Query \u8bed\u53e5\uff0c\u90fd\u5b58\u50a8\u5728 RequestContext \u4e2d\u3002</p> <ul> <li>\u6784\u5efa RequestContext \u5e76\u628a Query \u8bed\u53e5\u4f20\u5165\uff0c\u6839\u636e RequestContext \u6784\u5efa Query Instance\u3002\u5f00\u542f\u6240\u6709\u7684\u5f02\u6b65\u6d41\u7a0b\u540e\uff0c\u8fd4\u56de\u7528\u6237\u4e00\u4e2a Future\u3002</li> <li>\u5728 Query Instance \u4e2d\u6267\u884c parse\uff0c\u5c06\u8bed\u53e5\u89e3\u6790\u6210 sentence(statement)\u3002</li> <li>\u5728 validate \u4e2d\u901a\u8fc7<code>validateimpl</code>\u65b9\u6cd5\u8fdb\u884c check\uff0c\u6821\u9a8c\u662f\u5426\u6ee1\u8db3 schema \u4ee5\u53ca\u662f\u5426\u6570\u636e\u672a\u8d85\u8303\u56f4\u3002</li> </ul> C++<pre><code>  Status InsertVerticesValidator::validateImpl() {\n    spaceId_ = vctx_-&gt;whichSpace().id;\n    NG_RETURN_IF_ERROR(check());\n    NG_RETURN_IF_ERROR(prepareVertices());\n    return Status::OK();\n  }\n</code></pre> <ul> <li>\u901a\u8fc7 validator \u7684<code>toplan</code>\u65b9\u6cd5\u5c06 sentence \u53d8\u6210 execution plan tree\u3002</li> </ul> C++<pre><code>  Status InsertVerticesValidator::toPlan() {\n    auto doNode = InsertVertices::make(qctx_,\n                                      nullptr,\n                                      spaceId_,\n                                      std::move(vertices_),\n                                      std::move(tagPropNames_),\n                                      ifNotExists_,\n                                      ignoreExistedIndex_);\n    root_ = doNode;\n    tail_ = root_;\n    return Status::OK();\n  }\n</code></pre> <ul> <li>\u5c06\u903b\u8f91\u6267\u884c\u8ba1\u5212\u6811\u4ea4\u7ed9 Optimizer \u8fdb\u884c\u4f18\u5316\uff0cnebula \u73b0\u5728\u7684\u4f18\u5316\u662f Rule-based optimization\uff0c\u6bcf\u4e2a\u6267\u884c\u8ba1\u5212\u9700\u8981\u904d\u5386\u6240\u6709\u7684 rules\uff0c\u5f97\u5230\u6700\u4f18\u7684\u7269\u7406\u6267\u884c\u8ba1\u5212\u3002</li> <li> <p>\u7136\u540e\u5c06\u6574\u4e2a\u7269\u7406\u8ba1\u5212\u4ea4\u7ed9 Scheduler \u8fdb\u884c\u6267\u884c\uff0c\u5728 Scheduler \u4e2d\u6309\u7167\u8ba1\u5212\u6811\u7684\u7236\u5b50\u5173\u7cfb\uff0c\u4ece\u4e0b\u4e4b\u4e0a\u4f9d\u6b64\u6267\u884c\u8ba1\u5212\uff0c\u6240\u6709\u7684\u8ba1\u5212\u90fd\u662f\u7528 Future \u5f02\u6b65\u6267\u884c\u3002</p> </li> <li> <p>\u9996\u5148\u5148\u6839\u636e Logical Plan \u6784\u9020\u51fa Physical Plan(Execution Plan)</p> C++<pre><code>Executor *Executor::makeExecutor(const PlanNode *node,\n                             QueryContext *qctx,\n                             std::unordered_map&lt;int64_t, Executor *&gt; *visited)\n</code></pre> </li> <li> <p>\u5bf9 Executor \u8fdb\u884c\u8c03\u5ea6\uff0cparent plan \u8282\u70b9\u9700\u8981\u6240\u6709\u7684 children plan \u8282\u70b9\u90fd\u6267\u884c\u5b8c\u540e\u624d\u5f00\u59cb\u6267\u884c\u3002</p> </li> </ul> C++<pre><code>  folly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::scheduleExecutor(\n  std::vector&lt;folly::Future&lt;Status&gt;&gt;&amp;&amp; futures, Executor* exe, folly::Executor* runner) const {\n  switch (exe-&gt;node()-&gt;kind()) {\n    // ...\n    case PlanNode::Kind::kArgument: {\n      return runExecutor(std::move(futures), exe, runner);\n    }\n    default: {\n      if (exe-&gt;depends().empty()) {\n        return runLeafExecutor(exe, runner);\n      } else {\n        return runExecutor(std::move(futures), exe, runner);\n      }\n    }\n  }\n  }\n  folly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::runExecutor(\n    std::vector&lt;folly::Future&lt;Status&gt;&gt;&amp;&amp; futures, Executor* exe, folly::Executor* runner) const {\n  return folly::collect(futures).via(runner).thenValue(\n      [exe, this](auto&amp;&amp; t) mutable -&gt; folly::Future&lt;Status&gt; {\n        NG_RETURN_IF_ERROR(checkStatus(std::move(t)));\n        // Execute in current thread.\n        return execute(exe);\n      });\n  }\n\n  folly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::runLeafExecutor(Executor* exe,\n                                                                    folly::Executor* runner) const {\n    return std::move(execute(exe)).via(runner);\n  }\n</code></pre> <ul> <li>\u5728 runExecutor \u65b9\u6cd5\u4e2d\u4f1a\u8c03\u7528 graphd \u4e2d\u7684 executor\uff0c\u8fdb\u884c\u7269\u7406\u8ba1\u5212\u7684\u6267\u884c\u3002\u91cc\u9762\u6d89\u53ca\u5230\u5b58\u50a8\u5c42\u7684\u5185\u5bb9\u65f6\u4f1a\u901a\u8fc7 RPC \u5411 Storaged \u8bf7\u6c42\u670d\u52a1\u3002</li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#storaged","title":"Storaged","text":"<p>Storaged \u63a5\u6536\u5230 graphd \u53d1\u9001\u7684 executor \u8bf7\u6c42\uff0c\u542f\u52a8\u5bf9\u5e94\u7684 Processor\uff0c\u6267\u884c<code>process</code>\u65b9\u6cd5\uff0c\u5b9e\u9645\u4e0a\u6267\u884c<code>doProcess</code>\u65b9\u6cd5\u3002</p> <p></p> <ul> <li>\u5bf9\u4e8e\u67e5\u8be2\u8bed\u53e5\u6765\u8bf4\uff0c\u5b9e\u9645\u4e0a <code>doProcess</code> \u65b9\u6cd5\u4e5f\u4f1a\u751f\u6210 Storage \u7684\u6267\u884c\u8ba1\u5212\uff0c\u5bf9 RocksDB \u8fdb\u884c\u64cd\u4f5c\uff0c\u8fd9\u91cc\u5bf9\u4e8e Insert \u8bed\u53e5\u6765\u8bf4\u5c31\u662f\u7b80\u5355\u7684\u6267\u884c <code>doPut</code> \u64cd\u4f5c\uff0c\u901a\u8fc7 raft-wal \u5411 RockDB \u4e2d\u5199\u5165\u6570\u636e</li> <li>\u5728\u6267\u884c\u5b8c\u903b\u8f91\u540e\uff0c\u5c06\u6240\u6709\u7684\u66f4\u6539\u5199\u5165\u96c6\u7fa4\uff0c\u6700\u540e\u5728\u56de\u8c03\u4e2d\u6267\u884c<code>handleAsync</code>\u65b9\u6cd5\uff0c\u5b9e\u9645\u4e0a\u662f\u6267\u884c<code>onFinished</code>\u65b9\u6cd5\uff0c<code>onFinished</code>\u65b9\u6cd5\u4e2d\u8bbe\u7f6e promise \u7684 value \u4e3a RESP\uff0cRESP \u4e2d\u5305\u542b\u67e5\u8be2\u7684\u7ed3\u679c\uff0c\u4e00\u5c42\u5c42\u8fd4\u56de\u76f4\u5230\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ul> C++<pre><code>template &lt;typename RESP&gt;\nvoid BaseProcessor&lt;RESP&gt;::doPut(GraphSpaceID spaceId,\n                                PartitionID partId,\n                                std::vector&lt;kvstore::KV&gt;&amp;&amp; data) {\n  this-&gt;env_-&gt;kvstore_-&gt;asyncMultiPut(\n      spaceId, partId, std::move(data), [spaceId, partId, this](nebula::cpp2::ErrorCode code) {\n        handleAsync(spaceId, partId, code);\n      });\n}\n\ntemplate &lt;typename RESP&gt;\nvoid BaseProcessor&lt;RESP&gt;::handleAsync(GraphSpaceID spaceId,\n                                    PartitionID partId,\n                                    nebula::cpp2::ErrorCode code) {\n  bool finished = false;\n  {\n    std::lock_guard&lt;std::mutex&gt; lg(this-&gt;lock_);\n    handleErrorCode(code, spaceId, partId);\n    this-&gt;callingNum_--;\n    if (this-&gt;callingNum_ == 0) {\n      finished = true;\n    }\n  }\n  if (finished) {\n    this-&gt;onFinished();\n  }\n}\n\nvirtual void onFinished() {\n  memory::MemoryCheckOffGuard guard;\n  this-&gt;result_.failed_parts_ref() = this-&gt;codes_;\n  this-&gt;resp_.result_ref() = std::move(this-&gt;result_);\n  this-&gt;promise_.setValue(std::move(this-&gt;resp_));\n  delete this;\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#doput","title":"doPut","text":"<ul> <li>\u5199\u5165\u66f4\u6539\u662f doPut \u64cd\u4f5c\uff0c\u8be5\u64cd\u4f5c\u5b9e\u9645\u4e0a\u662f\u5bf9 raft \u63d0\u4ea4\u65e5\u5fd7\uff0c\u9a71\u52a8 raft \u72b6\u6001\u673a\u5c06\u8be5\u64cd\u4f5c\u540c\u6b65\u5230\u96c6\u7fa4\u4e2d\u3002</li> </ul> <ul> <li>Raft \u7684\u65e5\u5fd7\u590d\u5236\u8fc7\u7a0b\u5927\u81f4\u5206\u4e3a\u4e09\u4e2a\u6b65\u9aa4\uff1a   1. Leader\uff1a\u9996\u5148\u68c0\u67e5\u81ea\u8eab\u72b6\u6001\uff0c\u7136\u540e\u5148\u5199\u5165\u672c\u5730 WAL\uff0c\u7136\u540e\u5c06\u6240\u6709 log \u590d\u5236\u5230\u6240\u6709 follower   2. Follower\uff1aFollowers \u4e5f\u4f1a\u5c06\u65b0\u65e5\u5fd7\u5199\u5165\u81ea\u5df1\u7684 WAL\uff0c\u5e76\u5411 Leader \u56de\u590d \u201c\u6210\u529f\u201d\u3002   3. Leader\uff1a\u5305\u62ec\u81ea\u5df1\u5728\u5185\u7684\u5927\u591a\u6570\uff08Majority\uff09 \u8282\u70b9\u90fd\u5df2\u6210\u529f\u5c06\u8be5\u65e5\u5fd7\u5199\u5165\u5176 WAL\uff0cLeader \u5c31\u4f1a\u8ba4\u4e3a\u8fd9\u6761\u65e5\u5fd7\u662f \u201c\u5df2\u63d0\u4ea4\u201d (Committed) \u7684\u3002Leader \u5c31\u53ef\u4ee5\u5b89\u5168\u5730\u5c06\u8be5\u65e5\u5fd7\uff08\u5373 KV \u64cd\u4f5c\uff09\u5e94\u7528\u5230\u5176\u72b6\u6001\u673a\uff08\u5373\u771f\u6b63\u6267\u884c multiPut\uff09</li> </ul> C++<pre><code>void RaftPart::appendLogsInternal(AppendLogsIterator iter, TermID termId) {\n  do {\n    // Process 1\n  // Step 1: Write Local WAL\n    {\n      SCOPED_TIMER(\n      if (!wal_-&gt;appendLogs(iter)) {\n        break;\n      }\n    }\n  } while (false);\n\n\n  // Step 2: Replicate to followers\n  auto* eb = ioThreadPool_-&gt;getEventBase();\n  replicateLogs(eb, std::move(iter), currTerm, lastId, committed, prevLogTerm, prevLogId);\n  return;\n}\n\n// process 2 &amp; 3\nvoid RaftPart::replicateLogs(folly::EventBase* eb,\n                             AppendLogsIterator iter,\n                             TermID currTerm,\n                             LogID lastLogId,\n                             LogID committedId,\n                             TermID prevLogTerm,\n                             LogID prevLogId) {\n  collectNSucceeded(gen::from(hosts) |\n                        gen::map([self = shared_from_this(),\n                                  eb,\n                                  currTerm,\n                                  lastLogId,\n                                  prevLogId,\n                                  prevLogTerm,\n                                  committedId](std::shared_ptr&lt;Host&gt; hostPtr) {\n                          return via(eb, [=]() -&gt; Future&lt;cpp2::AppendLogResponse&gt; {\n                            // \u5411\u6240\u6709 follower \u53d1\u9001 AppendLogs \u8bf7\u6c42\n                            return hostPtr-&gt;appendLogs(\n                                eb, currTerm, lastLogId, committedId, prevLogTerm, prevLogId);\n                          });\n                        }) |\n                        gen::as&lt;std::vector&gt;(),\n                    quorum_,\n                    [hosts](size_t index, cpp2::AppendLogResponse&amp; resp) {\n      // Process 2: \u6536\u96c6\u5230\u4e86\u534a\u6570\u8282\u70b9\u901a\u8fc7\n                      return resp.get_error_code() == nebula::cpp2::ErrorCode::SUCCEEDED &amp;&amp;\n                             !hosts[index]-&gt;isLearner();\n                    })\n      .via(executor_.get())\n      .then([self = shared_from_this(),\n             eb,\n             it = std::move(iter),\n             currTerm,\n             lastLogId,\n             committedId,\n             prevLogId,\n             prevLogTerm,\n             pHosts = std::move(hosts),\n             beforeAppendLogUs](folly::Try&lt;AppendLogResponses&gt;&amp;&amp; result) mutable {\n        // Process 3: followers \u771f\u6b63\u5f00\u59cb\u8fdb\u884c\u5199\u5165\n        self-&gt;processAppendLogResponses(*result,\n                                        eb,\n                                        std::move(it),\n                                        currTerm,\n                                        lastLogId,\n                                        committedId,\n                                        prevLogTerm,\n                                        prevLogId,\n                                        std::move(pHosts));\n        return *result;\n      });\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#metad","title":"Metad","text":"<p>\u4e00\u822c Metad \u4e3b\u8981\u53c2\u4e0e DDL \u7684\u8bed\u53e5\u6267\u884c\u6d41\u7a0b\uff0c\u8d1f\u8d23\u5b58\u50a8 Tag/Edge \u7684 Schema \u4ee5\u53ca\u4e00\u4e9b\u7d22\u5f15\u7684\u5143\u6570\u636e\u4fe1\u606f\u3002\u7ba1\u7406 ReBuild Index \u7b49\u9700\u8981\u4e0e Storaged \u540c\u6b65\u7684 Job</p> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#our-work","title":"Our Work","text":"<p>\u6211\u4eec\u5df2\u7ecf\u68b3\u7406\u4e86\u4e00\u6761 Cypher \u8bed\u53e5\u4ece\u8f93\u5165\u5230\u6267\u884c\u7684\u5b8c\u6574\u6d41\u7a0b\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u5f00\u59cb\u5bf9 Nebula Graph \u8fdb\u884c\u6539\u52a8\uff0c\u652f\u6301\u5411\u91cf\u7c7b\u578b\u4ee5\u53ca\u5411\u91cf\u5b58\u50a8\u3002</p> <p>Nebula Graph \u7684\u5b9e\u9645\u7c7b\u578b\u5b58\u50a8\u662f\u4ee5 KV \u5bf9\u7684\u5f62\u5f0f\u5b58\u50a8\u5728 RocksDB \u4e2d\u7684\uff0cKey \u6709\u81ea\u5df1\u7279\u6b8a\u7684\u7ed3\u6784\uff0cValue \u5219\u662f\u5c5e\u6027\u503c\u7684\u4e8c\u8fdb\u5236\u5e8f\u5217\u5316\u7ed3\u679c\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u505a\u4e24\u65b9\u9762\u7684\u5de5\u4f5c\uff1a</p> <ol> <li>\u8bbe\u8ba1\u5411\u91cf\u7c7b\u578b (Vector Data Type)\uff1a\u5b9e\u73b0\u5411\u91cf\u6570\u636e\u7c7b\u578b\u548c\u5c5e\u6027\u3001\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316</li> <li>\u8bbe\u8ba1\u5411\u91cf\u5b58\u50a8 (Vector Storage)\uff1a\u4fee\u6539\u5b58\u50a8\u5f15\u64ce\uff0c\u652f\u6301\u5411\u91cf\u5c5e\u6027\u7684\u5355\u72ec\u5b58\u50a8\u548c\u8bfb\u53d6\uff0c\u8bbe\u8ba1\u5411\u91cf\u5c5e\u6027\u7684 Key \u548c Value \u683c\u5f0f <p>\u4e3a\u4e86\u65b9\u4fbf\u540e\u9762\u7684\u5411\u91cf\u7d22\u5f15\u8bbe\u8ba1\uff0c\u6211\u4eec\u5c06\u5411\u91cf\u5c5e\u6027\u5355\u72ec\u5b58\u50a8\u5728\u4e00\u4e2a Column Family \u4e2d\uff0c\u5176\u4ed6\u5c5e\u6027\u5b58\u50a8\u5728\u9ed8\u8ba4\u7684 Column Family \u4e2d\u3002</p> </li> </ol>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#_1","title":"\u5411\u91cf\u7c7b\u578b\u8bbe\u8ba1","text":"<p>Nebula Graph \u4e2d\u5df2\u7ecf\u6709\u4e86\u652f\u6301\u591a Value \u7684\u6570\u636e\u7c7b\u578b List\uff0c\u4f46\u662f\u6211\u4eec\u4ecd\u7136\u9700\u8981\u8bbe\u8ba1\u65b0\u7684 Vector \u7c7b\u578b\u3002 Why?</p> <p>\u5411\u91cf\u4e0e\u6807\u51c6\u4e2d\u5df2\u652f\u6301\u7684\u6570\u7ec4\u5728\u4ee5\u4e0b\u65b9\u9762\u6709\u6240\u4e0d\u540c\uff1a</p> <ul> <li>\u6570\u7ec4\u7c7b\u578b\u662f\u4e00\u79cd\u96c6\u5408\u7c7b\u578b\u3002\u6570\u7ec4\u662f\u503c\u7684\u96c6\u5408\u3002\u8fd9\u4e9b\u503c\u5728\u6570\u7ec4\u4e4b\u5916\u53ef\u80fd\u5177\u6709\u610f\u4e49\u3002\u4f8b\u5982\uff0c\u5728\u4e00\u4e2a\u7535\u8bdd\u53f7\u7801\u6570\u7ec4\u4e2d\uff0c\u6bcf\u4e2a\u7535\u8bdd\u53f7\u7801\u5728\u6570\u7ec4\u4e4b\u5916\u90fd\u6709\u5176\u610f\u4e49\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u5411\u91cf\u7684\u5355\u4e2a\u5750\u6807\u672c\u8eab\u5728\u5411\u91cf\u4e4b\u5916\u6ca1\u6709\u592a\u591a\u610f\u4e49\u3002</li> <li>\u4e00\u4e2a\u5411\u91cf\u7c7b\u578b\u4e2d\u7684\u6240\u6709\u5411\u91cf\u90fd\u5177\u6709\u76f8\u540c\u7684\u7ef4\u5ea6 \\(n\\)\u3002\\(1\\) \u548c \\(n\\) \u4e4b\u95f4\u7684\u6bcf\u4e2a\u5750\u6807\u90fd\u662f\u975e\u7a7a\u503c\u3002\u8fd9\u4e0e\u6570\u7ec4\u7c7b\u578b\u5f62\u6210\u5bf9\u6bd4\uff0c\u6570\u7ec4\u7c7b\u578b\u901a\u8fc7\u58f0\u660e\u7684\u6700\u5927\u57fa\u6570 \\(n\\) \u6765\u652f\u6301\u53ef\u53d8\u7684\u57fa\u6570\uff0c\u5e76\u4e14\u5141\u8bb8\u6bcf\u4e2a\u5143\u7d20\u4e3a\u7a7a\u503c\u3002</li> <li>\u5411\u91cf\u7c7b\u578b\u9664\u4e86<code>==</code>\u548c<code>!=</code>\uff0c\u5176\u4ed6\u7684\u7b97\u6570\u64cd\u4f5c\u5747\u4e0d\u5e94\u8be5\u652f\u6301</li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#vector-value-type","title":"Vector Value Type","text":"<p>Vector \u7c7b\u578b\u4e3b\u8981\u7531\u4e00\u4e2a <code>std::vector&lt;float&gt;</code> \u7ec4\u6210</p> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#vector-property-type","title":"Vector Property Type","text":"<ul> <li>\u65b0\u589e\u5c5e\u6027\u7c7b\u578b\uff0c\u5176\u503c\u7c7b\u578b\u4e3a VECTOR (\u5411\u91cf)\u3002</li> <li>\u5728 common.thrift \u4e2d\u4e3a\u5411\u91cf (VECTOR) \u503c\u7c7b\u578b\u6dfb\u52a0\u65b0\u6a21\u5f0f\u3002</li> </ul> Thrift<pre><code>// Vector type\nstruct Vector {\n    1: list&lt;double&gt; values;\n} (cpp.type = \"nebula::Vector\")\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#_2","title":"\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316","text":"<p>\u4e3a Vector \u7c7b\u578b\u5b9e\u73b0\u4e0b\u9762\u7684\u63a5\u53e3\u5373\u53ef</p> C++<pre><code>template &lt;class Protocol&gt;\nuint32_t Cpp2Ops&lt;nebula::Vector&gt;::write(Protocol* proto, nebula::Vector const* obj;\n\ntemplate &lt;class Protocol&gt;\nvoid Cpp2Ops&lt;nebula::Vector&gt;::read(Protocol* proto, nebula::Vector* obj);\n\ntemplate &lt;class Protocol&gt;\nuint32_t Cpp2Ops&lt;nebula::Vector&gt;::serializedSize(Protocol const* proto, nebula::Vector const* obj);\n\ntemplate &lt;class Protocol&gt;\nuint32_t Cpp2Ops&lt;nebula::Vector&gt;::serializedSizeZC(Protocol const* proto,\n                                                   nebula::Vector const* obj);\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#_3","title":"\u5411\u91cf\u5b58\u50a8\u8bbe\u8ba1","text":"<p>\u6211\u4eec\u7684\u76ee\u6807\u662f\u5c06\u5411\u91cf\u5c5e\u6027\u5b58\u50a8\u5728 Nebula Graph \u7684\u5b58\u50a8\u5f15\u64ce\u4e2d\uff0cNebula Graph \u9ed8\u8ba4\u7684\u5b58\u50a8\u5f15\u64ce\u662f RocksDB\uff0c\u540c\u65f6\u9700\u8981\u652f\u6301\u4e00\u4e2a Tag/Edge \u4e0a\u540c\u65f6\u5b58\u5728\u591a\u4e2a\u5411\u91cf\u5c5e\u6027\u3002</p> <p>\u6211\u4eec\u7684\u8bbe\u8ba1\u662f\u5c06\u5411\u91cf\u5c5e\u6027\u548c\u5176\u4ed6\u5c5e\u6027\u5206\u5f00\u5b58\u50a8\uff0c\u65b9\u4fbf\u540e\u7eed\u521b\u5efa\u5411\u91cf\u7d22\u5f15\u3002\u90a3\u4e48\u6211\u4eec\u7684\u5de5\u4f5c\u5c31\u53d8\u6210\u4e86\uff1a</p> <ul> <li>\u4fee\u6539\u5b58\u50a8\u5f15\u64ce\uff0c\u652f\u6301\u5411\u91cf\u5c5e\u6027\u7684\u5355\u72ec\u5b58\u50a8\u548c\u8bfb\u53d6(\u5f53\u524d Nebula Graph \u53ea\u652f\u6301 RocksDB \u7684\u9ed8\u8ba4 Column Family)</li> <li>\u8bbe\u8ba1\u5411\u91cf\u5c5e\u6027\u7684 Key \u548c Value \u683c\u5f0f</li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#why","title":"Why?","text":"<p>\u5728 Nebula Graph \u9ed8\u8ba4\u8bbe\u8ba1\u4e2d\uff0c\u6240\u6709\u5c5e\u6027\uff08\u5305\u62ec\u6807\u91cf\u5c5e\u6027\u3001\u6587\u672c\u5c5e\u6027\u3001\u5411\u91cf\u5c5e\u6027\uff09\u90fd\u5b58\u653e\u5728 Default Column Family \u91cc\uff0c\u5373\uff1a</p> C++<pre><code>Key = {tag_id, vertex_id, property_name}\nValue = {encoded property value}\n</code></pre> <p>\u4f46\u8fd9\u5bf9\u5411\u91cf\u5c5e\u6027\u6765\u8bf4\u6709\u51e0\u4e2a\u95ee\u9898\uff1a</p> <ul> <li> <p>\u6570\u636e\u81a8\u80c0\uff1a\u5411\u91cf\u6570\u636e\u901a\u5e38\u662f\u9ad8\u7ef4\uff08\u5982 512D \u6216 1024D\uff09\uff0c\u5355\u6761\u8bb0\u5f55\u4f53\u79ef\u5927\uff0c\u5bb9\u6613\u9020\u6210 LSM-tree \u5199\u653e\u5927\u548c Compaction \u538b\u529b\uff1b</p> </li> <li> <p>\u8bbf\u95ee\u6a21\u5f0f\u4e0d\u540c\uff1a\u666e\u901a\u5c5e\u6027\u591a\u4e3a\u70b9\u67e5\u6216\u6761\u4ef6\u8fc7\u6ee4\uff0c\u800c\u5411\u91cf\u5c5e\u6027\u8bfb\u53d6\u901a\u5e38\u662f\u6279\u91cf\u8bfb\u53d6\u6216\u626b\u63cf\u5f0f\uff08\u6784\u5efa\u7d22\u5f15\u65f6\u9700\u8981\u8bfb\u6240\u6709\u5411\u91cf\uff09\uff1b</p> </li> <li> <p>Scan \u6548\u7387\u4f4e\uff1a\u5411\u91cf\u7d22\u5f15\u6784\u5efa\u65f6\u9700\u8981\u626b\u63cf\u6240\u6709\u5411\u91cf\u6570\u636e\uff0c\u82e5\u4e0e\u666e\u901a\u5c5e\u6027\u6df7\u5b58\uff0c\u8bfb\u53d6\u65f6\u4f1a\u5e26\u6765\u5927\u91cf\u65e0\u7528\u6570\u636e\u7684 IO \u5f00\u9500\u548c\u89e3\u6790\u5f00\u9500</p> </li> </ul> <p>\u6240\u4ee5\u6211\u4eec\u51b3\u5b9a\u5c06\u5411\u91cf\u5c5e\u6027\u5355\u72ec\u5b58\u50a8\u5728\u4e00\u4e2a Column Family \u91cc\uff0c\u5176\u4ed6\u5c5e\u6027\u7ee7\u7eed\u5b58\u50a8\u5728 Default Column Family \u91cc\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#_4","title":"\u5b58\u50a8\u5f15\u64ce\u4fee\u6539","text":"<p>\u6240\u6709\u7684\u5c5e\u6027\u90fd\u662f\u5b58\u5728 RocksDB \u4e2d\u7684 KV \u5bf9\u4e2d\uff0c\u4e00\u822c\u5c5e\u6027\u7684 Key \u7531 <code>partId + tagId/edgeId + vertexId + propId</code> \u7ec4\u6210\uff0cValue \u5219\u662f\u5c5e\u6027\u503c\u7684\u4e8c\u8fdb\u5236\u5e8f\u5217\u5316\u7ed3\u679c\u3002</p> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 RocksDB \u7684 Column Family \u529f\u80fd\uff0c\u5c06\u5411\u91cf\u5c5e\u6027\u5355\u72ec\u5b58\u50a8\u5728\u4e00\u4e2a Column Family \u4e2d\uff0c\u5176\u4ed6\u5c5e\u6027\u5b58\u50a8\u5728\u9ed8\u8ba4\u7684 Column Family \u4e2d\u3002</p> <p>\u8fd9\u91cc\u7684 ID-VID Column Family \u662f\u540e\u7eed\u521b\u5efa\u5411\u91cf\u7d22\u5f15\u65f6\u9700\u8981\u7684\uff0c\u8fd9\u91cc\u5148\u4e0d\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p></p> <p> \u6709\u8da3\u7684\u662f\uff0cRockDB \u652f\u6301\u591a Column Family \u9700\u8981\u5148\u4f7f\u7528\u9ed8\u8ba4\u5217\u65cf\u6253\u5f00 RocksDB\uff0c\u7136\u540e\u521b\u5efa\u5176\u4ed6\u5217\u65cf\u5e76\u83b7\u53d6\u8fd9\u4e9b\u5217\u65cf\u7684\u53e5\u67c4\uff08CF handles\uff09\u3002\u63a5\u7740\u5173\u95ed\u6570\u636e\u5e93\uff0c\u518d\u4f7f\u7528\u591a\u4e2a\u5217\u65cf\u53e5\u67c4\u91cd\u65b0\u6253\u5f00\u8be5\u6570\u636e\u5e93\u3002</p> C++<pre><code>// We need first open the db with default column family, then create the other column families.\n// Last we reopen the db with all column families.\nrocksdb::Options singleCFOptions(dbOptions, cfDescriptors[0].options);\ninitRocksdbOptions(singleCFOptions, spaceId, vIdLen);\nstatus = rocksdb::DB::Open(singleCFOptions, path, &amp;db);\n\nsize_t cfCount = cfDescriptors.size();\nfor (size_t i = 0; i &lt; cfCount; ++i) {\n  if (cfDescriptors[i].name == NebulaKeyUtils::kDefaultColumnFamilyName) {\n    continue;\n  }\n  rocksdb::ColumnFamilyHandle* handle = nullptr;\n  status = db-&gt;CreateColumnFamily(cfDescriptors[i].options, cfDescriptors[i].name, &amp;handle);\n  if (!status.ok()) {\n    LOG(FATAL) &lt;&lt; \"Failed to create column family \" &lt;&lt; cfDescriptors[i].name &lt;&lt; \": \"\n                &lt;&lt; status.ToString();\n  }\n}\ndelete db;\ndb = nullptr;\ncfHandles_.clear();\nstatus = rocksdb::DB::Open(dbOptions, path, cfDescriptors, &amp;cfHandles_, &amp;db);\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#key-value","title":"\u5411\u91cf Key \u548c Value \u683c\u5f0f","text":"<p>\u6211\u4eec\u8bbe\u8ba1\u5411\u91cf\u5c5e\u6027\u7684 Key \u683c\u5f0f\u4e3a <code>type + partId + tagId + vertexId + propId</code>\uff0c\u53ef\u4ee5\u533a\u5206\u5355\u4e2a Tag \u4e2d\u7684\u5411\u91cf\u5c5e\u6027\u3002Value \u5219\u662f vector data type \u7684\u4e8c\u8fdb\u5236\u5e8f\u5217\u5316\u7ed3\u679c\u3002</p> <p>\u8fd9\u6837\u7684\u8bbe\u8ba1\u53ef\u4ee5\u652f\u6301\u4e00\u4e2a Tag \u4e2d\u6709\u591a\u4e2a vector \u5c5e\u6027 \u4e0d\u540c\u7684 tag \u6216\u5c5e\u6027\u53ef\u4ee5\u7528\u4e0d\u540c\u7684 propId \u533a\u5206\uff0c\u4e0d\u4f1a\u76f8\u4e92\u5f71\u54cd</p> Bash<pre><code>VectorTagKey: () \u91cc\u9762\u662f\u5b57\u8282\u6570\ntype(1) + partId(3) + vertexId(*) + tagId(4) + propId(4)\n\nVectroEdgeKey:\ntype(1) + partId(3) + srcId(*) + edgeType(4) + edgeRank(8) + dstId(*) + propId(4) +placeHolder(1)\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/","title":"\u4e0b\u7bc7\uff1a\u5411\u91cf\u7d22\u5f15\u4e0e\u76f8\u4f3c\u5ea6\u641c\u7d22 \u2014\u2014 Nebula Graph \u7684 ANN \u5b9e\u73b0\u4e4b\u8def","text":"2025-11-132025-12-13 <code>#Database</code>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#nebula-graph-ann","title":"\u4e0b\u7bc7\uff1a\u5411\u91cf\u7d22\u5f15\u4e0e\u76f8\u4f3c\u5ea6\u641c\u7d22 \u2014\u2014 Nebula Graph \u7684 ANN \u5b9e\u73b0\u4e4b\u8def","text":"<p> \u7ea6 5096 \u4e2a\u5b57  207 \u884c\u4ee3\u7801  8 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 28 \u5206\u949f</p> <p>\ud83d\udcda \u672c\u7cfb\u5217\u6587\u7ae0\u5206\u4e3a\u4e0a\u4e2d\u4e0b\u4e09\u7bc7\uff0c\u8bb0\u5f55\u4e86\u6211\u5728\u5f00\u6e90\u4e4b\u590f\u9879\u76ee\u4e2d\uff0c\u5f00\u53d1 Nebula Graph \u5411\u91cf\u641c\u7d22\u529f\u80fd\u7684\u4e00\u4e9b\u590d\u76d8\u548c\u601d\u8003\uff0c\u5e0c\u671b\u53ef\u4ee5\u7ed9\u5927\u5bb6\u5b66\u4e60\u548c\u5f00\u53d1\u7c7b\u4f3c\u7cfb\u7edf\u65f6\u6709\u4e00\u5b9a\u7684\u6837\u672c\u53c2\u8003\u3002\u5e0c\u671b\u5927\u5bb6\u591a\u591a\u5173\u6ce8\u548c\u4ea4\u6d41\uff0c\u5927\u5bb6\u4e00\u8d77\u8fdb\u6b65 \ud83d\ude0a \u6b22\u8fce\u8ba2\u9605\u6211\u7684\u4e2a\u4eba\u7f51\u7ad9 tom-jerr.github.io</p> <p>\u672c\u7bc7\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u652f\u6301 Ann \u7d22\u5f15\u548c Ann Search\u3002</p> <p>\u5728nebula graph \u7684\u4e0a\u7bc7\u548c\u4e2d\u7bc7\uff0c\u6211\u4eec\u5df2\u7ecf\u5b9e\u73b0\u4e86 Vector \u7c7b\u578b\u7684\u5b58\u50a8\u4ee5\u53ca\u5bf9 DDL \u548c DML \u7684\u9002\u914d\u3002\u73b0\u5728\u6211\u4eec\u9700\u8981\u5b9e\u73b0 Ann Index \u6784\u5efa\u548c Ann Search\uff0c\u8fd9\u91cc\u5206\u4e09\u4e2a\u6b65\u9aa4\u6765\u5b9e\u73b0\uff1a</p> <ul> <li>\u6784\u5efa Ann Index Adapter\uff0c\u5c06 HNSWlib \u548c faiss \u5c01\u88c5\u6210\u7edf\u4e00\u7684\u63a5\u53e3</li> <li>\u5b9e\u73b0 Ann Index \u7684 DDL\uff0c\u652f\u6301\u521b\u5efa\u548c\u5220\u9664 Ann Index</li> <li>\u5229\u7528 Ann Index \u8fdb\u884c Ann Search</li> </ul> <p>\u8fd9\u91cc\u9762\u4e5f\u6709\u4e00\u4e9b\u5173\u952e\u95ee\u9898\u9700\u8981\u89e3\u51b3\uff1a</p> <ol> <li>Ann Index \u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u8c01\u6765\u8d1f\u8d23\uff1f</li> <li>Ann Index \u7684\u6570\u636e\u5b58\u50a8\u5728\u54ea\u91cc\uff1f</li> <li>Ann Search \u751f\u6210\u7684\u8ba1\u5212\u5982\u4f55\u4f7f\u7528 Ann Index \u8fdb\u884c\u641c\u7d22\uff1f</li> </ol> <p>\u6211\u4eec\u4f1a\u5728\u4e0b\u9762\u7684\u7ae0\u8282\u4e2d\u7ed3\u5408\u4e09\u4e2a\u6b65\u9aa4\u9010\u4e00\u8fdb\u884c\u8bf4\u660e\uff0c\u5e76\u4e14\u5206\u4eab\u6211\u4eec\u5728\u5b9e\u73b0\u8fc7\u7a0b\u4e2d\u5f97\u5230\u7684\u7ecf\u9a8c\u6559\u8bad\u3002</p> <p> \u8fd9\u91cc\u4e3a\u4e86\u7b80\u5316\uff0c\u6211\u4eec\u5047\u8bbe\u4f7f\u7528 Tag Schema \u8fdb\u884c\u8bf4\u660e</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#ann-index-interface","title":"Ann Index Interface","text":"","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#ann-index-lifecycle","title":"Ann Index Lifecycle","text":"<p>\u5411\u91cf\u7d22\u5f15\u7684\u751f\u547d\u5468\u671f\u7531\u5b58\u50a8\u670d\u52a1\u5668\u7ba1\u7406\u3002\u6267\u884c\u521b\u5efa\u7d22\u5f15\u547d\u4ee4\u540e\uff0c\u5411\u91cf\u7d22\u5f15\u5c06\u88ab\u63d2\u5165\uff1b\u6267\u884c\u5220\u9664\u7d22\u5f15\u547d\u4ee4\u540e\uff0c\u5411\u91cf\u7d22\u5f15\u5c06\u88ab\u5220\u9664\u3002\u5728\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0c\u5b58\u50a8\u670d\u52a1\u5668\u5c06\u7ee7\u7eed\u7ef4\u62a4\u6b64\u7d22\u5f15\u3002</p> <p>\u5728 Ann Index DDL \u7ae0\u8282\u4e2d\u4f1a\u8be6\u7ec6\u4ecb\u7ecd\u521b\u5efa\u548c\u5220\u9664\u7d22\u5f15\u7684\u5b9e\u73b0\u3002\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 <code>VectorIndexManager</code> \u6765\u7ba1\u7406\u5411\u91cf\u7d22\u5f15\u7684\u751f\u547d\u5468\u671f\uff0c\u8fd9\u4e2a\u5355\u4f8b\u4f1a\u7ef4\u62a4\u4e00\u4e2a\u5185\u5b58\u4e2d\u7684\u5411\u91cf\u7d22\u5f15\u6620\u5c04\u8868\uff0cKey \u662f <code>GraphSpaceID + PartID + IndexID</code>\uff0cValue \u662f\u5177\u4f53\u7684\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\u3002</p> <p>\u8fd9\u4e2a <code>VectorIndexManager</code> \u5728\u5b58\u50a8\u5b88\u62a4\u8fdb\u7a0b\u542f\u52a8\u65f6\u521d\u59cb\u5316(\u52a0\u8f7d\u6301\u4e45\u5316\u7684\u5411\u91cf\u7d22\u5f15)\uff0c\u5728\u8fdb\u7a0b\u9000\u51fa\u524d\u6301\u4e45\u5316\u6240\u6709\u7684\u5411\u91cf\u7d22\u5f15\u5230\u78c1\u76d8\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#ann-index-persistence","title":"Ann Index Persistence","text":"<p>\u6211\u4eec\u8fd9\u91cc\u6682\u65f6\u6ca1\u6709\u8003\u8651\u5230\u5206\u5e03\u5f0f\u4e00\u81f4\u6027\u548c\u5b95\u673a\u91cd\u542f\u60c5\u51b5\uff0c\u6240\u4ee5\u53ea\u662f\u7b80\u5355\u7684\u8c03\u7528 faiss \u548c hnswlib \u7684\u5e8f\u5217\u5316 ann index \u63a5\u53e3\uff0c\u4ee5\u4e8c\u8fdb\u5236\u5f62\u5f0f\u5199\u5165\u672c\u5730\u6587\u4ef6\u3002</p> <p>\u5b9e\u9645\u4e0a\u8fd9\u4e9b ann search \u5e93\u6301\u4e45\u5316\u5e95\u5c42\u4f7f\u7528\u7684\u4e5f\u662f C++ IOStream \u5e8f\u5217\u5316\u673a\u5236</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#memory-tracked","title":"Memory Tracked","text":"<p>\u6682\u65f6\u6211\u7684\u5b9e\u73b0\u662f\u4f7f\u7528 Nebula \u5185\u7f6e\u7684 MemoryTracker \u5b9a\u671f\u67e5\u8be2\u5185\u5b58\u7d22\u5f15\u7684\u5927\u5c0f\u3002\u5982\u679c\u8d85\u8fc7\u9650\u5236\uff0c\u5219\u65e0\u6cd5\u63d2\u5165\u65b0\u7684 Vector</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#ann-index-interface_1","title":"Ann Index Interface","text":"<p>\u4e3a\u4e86\u652f\u6301\u4e0d\u540c\u7684\u5411\u91cf\u7d22\u5f15\u5e93\uff0c\u6211\u4eec\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a\u7edf\u4e00\u7684\u5411\u91cf\u7d22\u5f15\u63a5\u53e3 <code>AnnIndex</code>\uff0c\u5e76\u4e14\u5b9e\u73b0\u4e0d\u540c\u7684\u5411\u91cf\u7d22\u5f15\u9002\u914d\u5668\u3002\u8fd9\u4e2a\u63a5\u53e3\u4e3b\u8981\u5305\u542b\u4ee5\u4e0b\u65b9\u6cd5\uff1a</p> C++<pre><code>class AnnIndex {\n public:\n  AnnIndex() = default;\n\n  AnnIndex(GraphSpaceID graphID\uff0c\n           PartitionID partitionID\uff0c\n           IndexID indexID\uff0c\n           const std::string &amp;indexName\uff0c\n           bool propFromNode\uff0c\n           size_t dim\uff0c\n           const std::string &amp;rootPath\uff0c\n           MetricType metricType\uff0c\n           size_t minTrainDataSize = 3);\n\n  virtual ~AnnIndex() = default;\n  AnnIndex(const AnnIndex &amp;) = delete;\n  AnnIndex &amp;operator=(const AnnIndex &amp;) = delete;\n\n  [[nodiscard]] virtual Status init(const BuildParams *params) = 0;\n  // add data to index incrementally\n  [[nodiscard]] virtual Status add(const VecData *data) = 0;\n  // upsert data to index\n  [[nodiscard]] virtual Status upsert(const VecData *data) = 0;\n  // soft delete data from index\uff0c return number of deleted vectors\n  [[nodiscard]] virtual StatusOr&lt;size_t&gt; remove(const IDSelector &amp;sel) = 0;\n\n  // ann search\n  [[nodiscard]] virtual Status search(const SearchParams *params\uff0c SearchResult *res) = 0;\n  // reconstruct vector by id\n  [[nodiscard]] virtual StatusOr&lt;Vector&gt; reconstruct(VectorID id) = 0;\n\n  // load index file from disk\n  // flush index to disk\n  [[nodiscard]] virtual Status read(const std::string &amp;file) = 0;\n  [[nodiscard]] virtual Status write(const std::string &amp;dir\uff0c const std::string &amp;file) = 0;\n  virtual AnnIndexType indexType() const = 0;\n  virtual std::string toString() const = 0;\n};\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#concurrent-ann-index","title":"Concurrent Ann Index","text":"<p>\u901a\u8fc7\u5b9e\u73b0 <code>AnnIndex</code> \u63a5\u53e3\uff0c\u6211\u4eec\u6784\u5efa\u4e86\u4e24\u4e2a\u5411\u91cf\u7d22\u5f15\uff1a\u4e00\u4e2a\u5e95\u5c42\u4f7f\u7528 Faiss IVF \u7d22\u5f15\uff0c\u53e6\u4e00\u4e2a\u5e95\u5c42\u4f7f\u7528 HNSWlib HNSW \u7d22\u5f15\u3002\u4e3a\u4e86\u5b9e\u73b0\u5e76\u53d1\uff0c\u6211\u4eec\u5728\u5411\u91cf\u7d22\u5f15\u4e2d\u4f7f\u7528\u4e86\u8bfb\u5199\u9501\u3002\u8fd9\u5141\u8bb8\u591a\u4e2a\u67e5\u8be2\u6267\u884c Ann Search\uff0c\u4f46\u53ea\u5141\u8bb8\u6267\u884c\u4e00\u4e2a\u67e5\u8be2\u6267\u884c\u5bf9\u7d22\u5f15\u7684 DML \u64cd\u4f5c\uff08\u6dfb\u52a0\u6216\u5220\u9664\uff09\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#ann-index-utils","title":"Ann Index Utils","text":"<p>\u4e3a\u4e86\u7b80\u5316\u5411\u91cf\u7d22\u5f15\u7684\u4f7f\u7528\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e9b\u8f85\u52a9\u6570\u636e\u7ed3\u6784\u548c\u679a\u4e3e\u7c7b\u578b\uff1a</p> <ul> <li><code>MetricType</code>\uff1a\u8868\u793a\u5411\u91cf\u8ddd\u79bb\u5ea6\u91cf\u7c7b\u578b\uff0c\u5982 L2 \u8ddd\u79bb\u548c\u5185\u79ef\u3002</li> <li><code>AnnIndexType</code>\uff1a\u8868\u793a\u5411\u91cf\u7d22\u5f15\u7c7b\u578b\uff0c\u5982 IVF \u548c HNSW\u3002</li> <li><code>IDSelector</code>\uff1a\u7528\u4e8e\u9009\u62e9\u8981\u5220\u9664\u7684\u5411\u91cf ID \u5217\u8868\u3002</li> <li><code>VecData</code>\uff1a\u8868\u793a\u5411\u91cf\u6570\u636e\uff0c\u5305\u62ec\u5411\u91cf\u6570\u91cf\u3001\u7ef4\u5ea6\u3001\u6570\u636e\u548c ID\u3002</li> <li><code>BuildParams</code>\uff1a\u8868\u793a\u5411\u91cf\u7d22\u5f15\u6784\u5efa\u53c2\u6570\u7684\u57fa\u7c7b\uff0c\u4ee5\u53ca\u5176\u6d3e\u751f\u7c7b <code>BuildParamsIVF</code> \u548c <code>BuildParamsHNSW</code>\u3002</li> <li><code>SearchParams</code>\uff1a\u8868\u793a\u5411\u91cf\u641c\u7d22\u53c2\u6570\u7684\u57fa\u7c7b\uff0c\u4ee5\u53ca\u5176\u6d3e\u751f\u7c7b <code>SearchParamsIVF</code> \u548c <code>SearchParamsHNSW</code>\u3002</li> <li><code>SearchResult</code>\uff1a\u8868\u793a\u5411\u91cf\u641c\u7d22\u7ed3\u679c\uff0c\u5305\u62ec\u5411\u91cf ID\u3001\u8ddd\u79bb\u548c\u5411\u91cf\u6570\u636e\u3002</li> </ul> C++<pre><code>enum MetricType : int8_t { L2\uff0c INNER_PRODUCT };\nenum AnnIndexType : int8_t { IVF\uff0c HNSW };\n\n// faiss used\nstruct IDSelector {\n  size_t cnt;\n  VectorID* ids;  // vector of IDs to select\n};\n\nstruct VecData {\n  size_t cnt;     // number of vectors\n  size_t dim;     // dimension of each vector\n  float* fdata;   // float type vector data source\n  VectorID* ids;  // int64 identifier of each vector\n};\n\nstruct OwnedVecData {\n  std::vector&lt;float&gt; flat;\n  std::vector&lt;VectorID&gt; ids;\n  VecData view;\n};\n\n// ANN index build parameters\nstruct BuildParams {\n  MetricType metricType{MetricType::L2};\n  AnnIndexType indexType{AnnIndexType::IVF};\n};\n\nstruct BuildParamsIVF final : public BuildParams {\n  size_t nl{3};  // number of lists\n  size_t ts{3};  // train size\n};\n\nstruct BuildParamsHNSW final : public BuildParams {\n  size_t maxDegree{16};      // the maximum degrees\n  size_t efConstruction{8};  // expansion in construction time\n  size_t capacity{10000};    // capacity of the index\n};\n\nstruct SearchParams {\n  size_t topK{10};        // number of nearest neighbors to search\n  float* query{nullptr};  // query vector data\n  size_t queryDim{0};     // dimension of query vector\n};\n\nstruct SearchParamsIVF final : public SearchParams {\n  size_t nprobe{10};  // number of lists to probe\n};\n\nstruct SearchParamsHNSW final : public SearchParams {\n  size_t efSearch{16};  // expansion factor at search time\n};\n\n// ANN search result\nstruct SearchResult {\n  std::vector&lt;VectorID&gt; IDs;\n  // distances of the result vectors\n  std::vector&lt;float&gt; distances;\n  // result vectors\n  std::vector&lt;float&gt; vectors;\n};\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#ann-index-ddl","title":"Ann Index DDL","text":"<p>Ann Index DDL \u529f\u80fd\u7684\u4e3b\u8981\u8bbe\u8ba1\u76ee\u6807\u662f\u652f\u6301\u5bf9\u591a\u4e2a\u5171\u4eab\u540c\u540d\u5c5e\u6027\u7684\u6807\u7b7e\u8fdb\u884c\u7d22\u5f15\u3002\u8fd9\u9700\u8981\u65b0\u7684 DDL \u8bed\u6cd5\u3001\u5143\u6570\u636e\u7ed3\u6784\u4ee5\u53ca Graphd \u3001 Metad \u548c Storaged \u4e4b\u95f4\u534f\u8c03\u7684\u6267\u884c\u6d41\u7a0b\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#create-ann-index-syntax","title":"Create Ann Index Syntax","text":"<ul> <li>Tag Ann Index Creation Syntax</li> </ul> Bash<pre><code>CREATE TAG ANNINDEX &lt;index_name&gt; ON &lt;tag_name_list&gt;::(&lt;field_name&gt;) [IF NOT EXISTS] ann_index_params}[COMMENT '&lt;comment&gt;']\n</code></pre> <ul> <li> <p>Ann Index Parameters</p> </li> <li> <p><code>ANNINDEX_TYPE</code>: Index type\uff0c support <code>IVF</code> and <code>HNSW</code></p> </li> <li><code>DIM</code>: Vector dimension</li> <li><code>METRIC_TYPE</code>: Metric type\uff0c support <code>L2</code> and <code>INNER_PRODUCT</code></li> <li><code>NLIST</code>: Number of lists\uff0c only for <code>IVF</code> index</li> <li><code>TRAINSIZE</code>: Training size\uff0c only for <code>IVF</code> index</li> <li><code>MAXDEGREE</code>: Maximum degree\uff0c only for <code>HNSW</code> index</li> <li><code>EFCONSTRUCTION</code>: Expansion factor at construction time\uff0c only for <code>HNSW</code> index</li> <li><code>MAXELEMENTS</code>: Capacity of the index\uff0c only for <code>HNSW</code> index</li> </ul> Bash<pre><code>{ANNINDEX_TYPE: \"IVF\"\uff0c DIM:128\uff0c METRIC_TYPE:\"L2\"\uff0c NLIST:3\uff0c TRAINSIZE:3}\n{ANNINDEX_TYPE: \"HNSW\"\uff0c DIM:128\uff0c METRIC_TYPE:\"L2\"\uff0c MAXDEGREE:15\uff0c EFCONSTRUCTION:200\uff0c MAXELEMENTS:10000}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#thrift-structure","title":"Thrift Structure","text":"","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#1-thrift-ann-index-item","title":"1. Thrift Ann Index Item","text":"<ul> <li>\u901a\u7528\u7d22\u5f15\u9879\u5b9a\u4e49\u4e86\u5355\u4e2a\u6a21\u5f0f\u4e2d\u591a\u4e2a\u5b57\u6bb5\u7684\u7d22\u5f15\uff0c\u5176\u7d22\u5f15\u53c2\u6570\u4ec5\u5305\u542b <code>s2_max_level</code> \u548c <code>s2_max_cells</code> \uff0c\u8fd9\u65e0\u6cd5\u6ee1\u8db3 Ann \u7d22\u5f15\u5bf9\u8de8\u591a\u4e2a\u6a21\u5f0f\u7684\u540c\u540d\u5c5e\u6027\u521b\u5efa\u7d22\u5f15\u7684\u8981\u6c42\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u65b0\u7684 Ann \u7d22\u5f15\u9879\u3002</li> </ul> C++<pre><code>struct IndexItem {\n    1: common.IndexID       index_id\uff0c\n    2: binary               index_name\uff0c\n    3: common.SchemaID      schema_id\n    4: binary               schema_name\uff0c\n    5: list&lt;ColumnDef&gt;      fields\uff0c\n    6: optional binary      comment\uff0c\n    7: optional IndexParams index_params\uff0c\n}\n</code></pre> <ul> <li>Ann \u7d22\u5f15\u9879\u5b9a\u4e49\u4e86\u5728\u591a\u4e2a\u6a21\u5f0f\u4e2d\u540c\u540d\u5c5e\u6027\u4e4b\u95f4\u521b\u5efa\u7d22\u5f15\u7684\u8fc7\u7a0b\uff0c\u5305\u62ec\u6240\u6709\u9700\u8981\u5efa\u7acb\u7d22\u5f15\u7684\u6a21\u5f0f\u7684\u4fe1\u606f\u3002\u540c\u65f6\uff0c\u5b83\u8fd8\u4f7f\u7528\u4e00\u4e2a\u5217\u8868\u6765\u5b58\u50a8\u521b\u5efa Ann \u7d22\u5f15\u6240\u9700\u7684\u53c2\u6570\u3002</li> </ul> C++<pre><code>ann index params:\n[IVF/*ann type*/\uff0c 128 /*dim*/\uff0c L2/*metric type*/\uff0c 3/*nlist*/\uff0c 3/*train size*/]\n[HNSW/*ann type*/\uff0c 128 /*dim*/\uff0c L2/*metric type*/\uff0c 16/*max degree*/\uff0c 200/*ef construction*/\uff0c 100000/*max elements*/]\n</code></pre> C++<pre><code>struct AnnIndexItem {\n    1: common.IndexID           index_id\uff0c\n    2: binary                   index_name\uff0c\n    3: binary                   prop_name\uff0c\n    4: list&lt;common.SchemaID&gt;    schema_ids\uff0c\n    5: list&lt;binary&gt;             schema_names\uff0c\n    6: list&lt;ColumnDef&gt;          fields\uff0c\n    7: optional binary          comment\uff0c\n    8: optional list&lt;binary&gt;    ann_params\uff0c\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#2-thrift-request-response-structure","title":"2. Thrift Request &amp; Response Structure","text":"<ul> <li>DDL \u5728 Graphd \u63a5\u6536\u5230\u521b\u5efa Ann Index \u8bf7\u6c42\u540e\uff0c\u4f1a\u5c06\u8bf7\u6c42\u8f6c\u6362\u4e3a Thrift \u8bf7\u6c42\u53d1\u9001\u5230 Metad\u3002\u6211\u4eec\u5b9a\u4e49\u4e86\u4ee5\u4e0b Thrift \u7ed3\u6784\uff1a</li> </ul> C++<pre><code>struct CreateTagAnnIndexReq {\n    1: common.GraphSpaceID      space_id\uff0c\n    2: binary                   index_name\uff0c\n    3: list&lt;binary&gt;             tag_names\uff0c\n    4: IndexFieldDef            field\uff0c\n    5: bool                     if_not_exists\uff0c\n    6: optional binary          comment\uff0c\n    7: optional list&lt;binary&gt;    ann_params\uff0c\n}\n</code></pre> <ul> <li>Storaged \u4f1a\u5b9a\u671f\u5411 Metad \u8bf7\u6c42 Ann Index \u5143\u6570\u636e\uff0c\u5e76\u6839\u636e\u5143\u6570\u636e\u521b\u5efa\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u65b0\u7684 request \u5c06\u6240\u6709\u7684 Ann Index \u5143\u6570\u636e\u53d1\u9001\u5230 Storaged\uff1a</li> </ul> C++<pre><code>struct ListTagAnnIndexesResp {\n    1: common.ErrorCode         code\uff0c\n    2: common.HostAddr          leader\uff0c\n    3: list&lt;AnnIndexItem&gt; items\uff0c\n}\nstruct ListEdgeAnnIndexesResp {\n    1: common.ErrorCode         code\uff0c\n    2: common.HostAddr          leader\uff0c\n    3: list&lt;AnnIndexItem&gt;     items\uff0c\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#core-component","title":"Core Component","text":"<p>\u6211\u4eec\u7684\u8bbe\u60f3\u662f\u5728 Storaged \u4e2d\u7ef4\u62a4\u6211\u4eec\u7684\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\uff0c\u4e3a\u4e86\u4e0e\u5176\u4ed6\u529f\u80fd\u6a21\u5757\u89e3\u8026\uff0c\u6211\u4eec\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u6838\u5fc3\u7ec4\u4ef6 <code>VectorIndexManager</code> \u6765\u7ba1\u7406\u6240\u6709\u7684\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\u3002</p> <ul> <li>\u5728\u5b58\u50a8\u5b88\u62a4\u8fdb\u7a0b\u4e2d\uff0c\u8bbe\u8ba1\u4e00\u4e2a <code>VectorIndexManager</code> \u5355\u4f8b\u6765\u7ba1\u7406 Storaged \u4e2d\u7684\u6240\u6709 Ann Index\u3002</li> <li>Ann Index \u7684\u751f\u547d\u5468\u671f\uff1a</li> <li>\u521b\u5efa \uff1a\u901a\u8fc7 <code>CreateTagAnnIndex</code> \u8bf7\u6c42\u521b\u5efa Ann \u7d22\u5f15\u3002     &gt; \u9664\u975e\u5220\u9664\uff0c\u5426\u5219\u5b83\u5c06\u59cb\u7ec8\u4fdd\u5b58\u5728\u5185\u5b58\u4e2d\u3002\u9000\u51fa\u65f6\u9700\u8981\u5c06\u6240\u6709 Ann Index \u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u5e76\u5728\u7cfb\u7edf\u91cd\u542f\u540e\u4ece\u78c1\u76d8\u91cd\u65b0\u52a0\u8f7d\u3002</li> <li>\u8bbf\u95ee \uff1a\u901a\u8fc7 <code>GetTagAnnIndex</code> \u8bf7\u6c42\u8bbf\u95ee Ann \u7d22\u5f15\u7528\u4e8e\u52a0\u901f Ann Search\u3002</li> <li>\u5220\u9664 \uff1a\u901a\u8fc7 <code>DropTagAnnIndex</code> \u8bf7\u6c42\u5220\u9664 Ann Index\u3002</li> <li>\u66f4\u65b0 \uff1a\u901a\u8fc7 <code>UpdateTagAnnIndex</code> \u8bf7\u6c42\u66f4\u65b0 Ann Index\u3002</li> <li>\u5b9e\u9645\u4e0a\uff0c<code>VectorIndexManager</code> \u7ef4\u62a4\u4e86\u4e00\u4e2a\u5185\u5b58\u4e2d\u7684\u5411\u91cf\u7d22\u5f15\u6620\u5c04\u8868\uff0cKey \u662f <code>GraphSpaceID + PartID + IndexID</code>\uff0cValue \u662f\u5177\u4f53\u7684 Ann Index \u7684\u667a\u80fd\u6307\u9488\u3002</li> </ul> C++<pre><code>class VectorIndexManager final {\n public:\n  static VectorIndexManager&amp; getInstance();\n  Status init(meta::IndexManager* indexManager\uff0c std::string annIndexPath);\n  Status start();\n  Status stop();\n\n  // Create &amp; Rebuild\n  Status createOrUpdateIndex(GraphSpaceID spaceId\uff0c\n                             PartitionID partitionId\uff0c\n                             IndexID indexId\uff0c\n                             const std::shared_ptr&lt;meta::cpp2::AnnIndexItem&gt;&amp; indexItem);\n  Status rebuildIndex(GraphSpaceID spaceId\uff0c\n                      PartitionID partitionId\uff0c\n                      IndexID indexId\uff0c\n                      const std::shared_ptr&lt;meta::cpp2::AnnIndexItem&gt;&amp; indexItem);\n\n  // Access &amp; Search\n  StatusOr&lt;std::shared_ptr&lt;AnnIndex&gt;&gt; getIndex(GraphSpaceID spaceId\uff0c\n                                               PartitionID partitionId\uff0c\n                                               IndexID indexId);\n  StatusOr&lt;SearchResult&gt; searchVectors(GraphSpaceID spaceId\uff0c\n                                       PartitionID partitionId\uff0c\n                                       IndexID indexId\uff0c\n                                       const SearchParams&amp; searchParams);\n\n  // Update &amp; Delete\n  Status addVectors(GraphSpaceID spaceId\uff0c\n                    PartitionID partitionId\uff0c\n                    IndexID indexId\uff0c\n                    const VecData&amp; vecData);\n  Status removeIndex(GraphSpaceID spaceId\uff0c PartitionID partitionId\uff0c IndexID indexId);\n\n  // Utility\n  std::vector&lt;std::shared_ptr&lt;AnnIndex&gt;&gt; getIndexesByPartition(GraphSpaceID spaceId\uff0c\n                                                               PartitionID partitionId);\n  bool hasIndex(GraphSpaceID spaceId\uff0c PartitionID partitionId\uff0c IndexID indexId) const;\n\n  // ... private members for lifecycle management\n};\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#create-index-execution-flow","title":"Create Index Execution Flow","text":"<p>\u521b\u5efa\u8fc7\u7a0b\u662f\u4e00\u4e2a\u591a\u6b65\u9aa4\u64cd\u4f5c\uff0c\u6d89\u53ca Graphd \u3001 Metad \u548c Storaged \u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#1-graphd-metad-storaged","title":"1. Graphd -&gt; Metad -&gt; Storaged","text":"<ol> <li> <p>Graphd: \u89e3\u6790 <code>CREATE ANNINDEX DDL</code> \u5e76\u751f\u6210\u751f\u6210\u8ba1\u5212 <code>Start-&gt;CreateTagAnnIndex-&gt;\u200b\u200bSubmitJob</code>\u3002</p> </li> <li> <p>Metad: \u6267\u884c <code>CreateTagAnnIndex</code> \u6b65\u9aa4\u3002Metad \u4f1a\u5728\u5185\u90e8\u521b\u5efa <code>AnnIndexItem</code> \u5143\u6570\u636e\u6761\u76ee\u3002\u521b\u5efa\u6210\u529f\u540e\uff0c\u63d0\u4ea4\u4e00\u4e2a AdminJob\u3002</p> </li> <li>Metad: \u8be5 AdminJob \u5c06 Ann Index \u53c2\u6570\u6253\u5305\u6210 AdeminTask \u53d1\u9001\u7ed9 Storaged\u3002Storaged \u901a\u8fc7\u5176\u5185\u90e8\u7684 <code>AdminTaskManager</code> \u5904\u7406\u8fd9\u4e9b\u4efb\u52a1\u4ee5\u5b8c\u6210\u4f5c\u4e1a\u3002\u8fd9\u6d89\u53ca\u5230\u4e00\u4e2a\u5206\u5e03\u5f0f\u65f6\u5e8f\u95ee\u9898\uff1a</li> </ol> <ul> <li>Meta Client \u4f1a\u56e0\u7f13\u5b58\u66f4\u65b0\u770b\u4e0d\u5230\u65b0\u52a0\u5165\u7684\u7d22\u5f15\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u5728 Storaged \u4e2d\u4f7f\u7528\u4e86\u91cd\u8bd5\u673a\u5236\u3002\u5982\u679c\u591a\u6b21\u91cd\u8bd5\u5931\u8d25\uff0c\u6211\u4eec\u4f1a\u76f4\u63a5\u4ece\u5143\u670d\u52a1\u5668\u8bf7\u6c42\u6570\u636e\u4ee5\u5f3a\u5236\u5237\u65b0\u7f13\u5b58\u3002</li> </ul> <p>Meta Client \u7f13\u5b58\u66f4\u65b0\u673a\u5236\uff1a \u5b58\u50a8\u8282\u70b9\u7684 <code>IndexManager</code> \u901a\u8fc7 <code>MetaClient</code> \u83b7\u53d6\u7d22\u5f15\u4fe1\u606f\uff0c\u4f46 <code>MetaClient</code> \u7684\u7f13\u5b58\u901a\u8fc7\u5fc3\u8df3\u5468\u671f\u8fdb\u884c\u66f4\u65b0\uff1a</p> <ul> <li>\u65f6\u5e8f\u95ee\u9898\uff1a \u5143\u670d\u52a1\u521b\u5efa\u7d22\u5f15\u540e\uff0c\u5b58\u50a8\u8282\u70b9\u9700\u8981\u7b49\u5230\u4e0b\u4e00\u4e2a\u5fc3\u8df3\u5468\u671f\u624d\u80fd\u770b\u5230\u65b0\u7d22\u5f15\u3002   \u540c\u6b65\u95ee\u9898\uff1a <code>getTagAnnIndex</code> \u76f4\u63a5\u4ece\u7f13\u5b58\u8bfb\u53d6\u6570\u636e\u3002\u5982\u679c\u7f13\u5b58\u5c1a\u672a\u66f4\u65b0\uff0c\u5219\u4f1a\u8fd4\u56de IndexNotFound \u9519\u8bef\u3002</li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#2-storaged-ann-index-creation","title":"2. Storaged Ann Index Creation","text":"<p>\u5b58\u50a8\u8282\u70b9\u5728\u63a5\u6536\u5230\u521b\u5efa Ann Index \u7684 AdminTask \u540e\uff0c\u4f1a\u751f\u6210\u771f\u6b63\u7684\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\u5e76\u5c06\u5176\u5b58\u50a8\u5728 <code>VectorIndexManager</code> \u4e2d\u3002</p> <p>\u5bf9\u4e8e\u6bcf\u4e2a\u5206\u533a\uff0cStoraged \u4f1a\u6267\u884c\u4ee5\u4e0b\u6b65\u9aa4\uff1a</p> <ol> <li> <p>\u626b\u63cf KVStore\uff08RocksDB\uff09\u4e2d\u4e0e\u5c5e\u6027\u540d\u79f0\u5339\u914d\u7684\u6240\u6709 Vector \u5c5e\u6027\u6570\u636e\u3002</p> </li> <li> <p>\u5c06\u8fd9\u4e9b\u5411\u91cf\u6570\u636e\u6279\u91cf\u6dfb\u52a0\u5230\u65b0\u521b\u5efa\u7684\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\u4e2d\u3002</p> </li> <li> <p>\u5c06\u9876\u70b9 ID/\u8fb9\u7c7b\u578b\u548c\u5411\u91cf ID \u4e4b\u95f4\u7684\u6620\u5c04\u5173\u7cfb\u5b58\u50a8\u5230 KVStore \u7684 id-vid \u5217\u65cf\u4e2d\u3002</p> <p>\u9876\u70b9 ID \u7684\u7c7b\u578b\u4e3a std::string\u3002\u8fd9\u91cc VectorID \u662f\u901a\u8fc7\u54c8\u5e0c\u8ba1\u7b97\u5f97\u5230\u7684\uff0c\u56e0\u6b64\u9700\u8981\u5b58\u50a8\u4e24\u4e2a\u6620\u5c04\uff1aVectorID-&gt;VertexID \u548c VertexID-&gt;VectorID\u3002</p> </li> </ol> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#ann-search","title":"Ann Search","text":"<p>\u4e3a\u4e86\u5728 Graphd \u4e2d\u652f\u6301 Ann Search\uff0c\u6211\u4eec\u5fc5\u987b\u4fee\u6539\u67e5\u8be2\u6267\u884c\u6d41\u7a0b\u3002\u5f53\u67e5\u8be2\u7684 Tag/Edge \u4e0a\u5b58\u5728 Ann Index \u65f6\uff0c\u6267\u884c\u8ba1\u5212\u5c06\u4f18\u5148\u626b\u63cf Ann Index \u4ee5\u83b7\u53d6 limit * K \u6761\u6570\u636e\uff0c\u7136\u540e\u518d\u8fdb\u884c\u8fc7\u6ee4\u3002</p> <p>\u8fd9\u9700\u8981\u5bf9\u4f18\u5316\u89c4\u5219\u3001Graphd \u6267\u884c\u8ba1\u5212\u4ee5\u53ca Storaged \u4e2d\u7684\u6267\u884c\u8ba1\u5212\u8fdb\u884c\u4fee\u6539\uff0c\u6700\u4e3b\u8981\u7684\u662f\u5728 Storaged \u4e2d\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684 AnnIndexScan \u8282\u70b9\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#ann-search-syntax","title":"Ann Search Syntax","text":"<p>\u4e3a\u4e86\u8f7b\u677e\u533a\u5206 Ann Search \u548c\u539f\u59cb\u7684 MATCH \u8bed\u53e5\uff0c\u6211\u4eec\u8bbe\u8ba1\u4e86\u65b0\u7684 <code>APPROXIMATE LIMIT</code> \u8bed\u6cd5\u3002\u8fd9\u4f7f\u6211\u4eec\u65e0\u9700\u5728 yacc \u5c42\u9762\u505a\u8fc7\u591a\u6539\u52a8\u3002</p> <p>\u8bed\u6cd5\u793a\u4f8b\uff1a</p> SQL<pre><code>MATCH (v:v1)\nRETURN v\uff0c euclidean(vector(0.90\uff0c 0.85\uff0c 0.88)\uff0c v.embedding) AS distance\nORDER BY euclidean(vector(0.90\uff0c 0.85\uff0c 0.88)\uff0c v.embedding)\nAPPROXIMATE LIMIT 1\nOPTIONS {ANNINDEX_TYPE:'IVF'\uff0c METRIC_TYPE:L2\uff0c NPROBE:2};\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#overview-of-ann-search-execution-flow","title":"Overview of Ann Search Execution Flow","text":"<ol> <li> <p>Graphd (\u4f18\u5316)\uff1a \u4f18\u5316\u89c4\u5219\u8bc6\u522b\u51fa <code>APPROXIMATE LIMIT</code> \u8bed\u6cd5\uff0c\u5e76\u751f\u6210\u4e00\u4e2a\u5305\u542b <code>TagAnnIndexCcan</code> \u8282\u70b9\u7684\u7269\u7406\u6267\u884c\u8ba1\u5212\u3002</p> </li> <li> <p>Storaged (\u7d22\u5f15\u626b\u63cf)\uff1a Storaged \u6536\u5230 <code>TagAnnIndexScan</code> \u8bf7\u6c42\u3002\u5b83\u4f1a\u751f\u6210\u4e00\u4e2a\u5185\u90e8\u8ba1\u5212\uff0c\u5728\u5e95\u5c42\u7684 Ann Index\uff08\u4f8b\u5982 IVF\uff09\u4e0a\u6267\u884c\u641c\u7d22\u3002</p> </li> <li> <p>Storaged (\u8fd4\u56de VIDs)\uff1a \u7d22\u5f15\u626b\u63cf\u8fd4\u56de\u5339\u914d\u7684 <code>VectorID</code>\u3002Storaged \u968f\u540e\u5c06 <code>VectorID</code> \u6620\u5c04\u56de <code>vid</code>\uff0c\u5e76\u5c06 <code>vid</code> \u8fd4\u56de\u7ed9 Graphd\u3002</p> </li> <li> <p>Graphd (\u83b7\u53d6\u5c5e\u6027)\uff1a Graphd \u8c03\u7528 Storaged \u7684 <code>GetProp</code> \u64cd\u4f5c\u7b26\uff0c\u4e3a\u4e0a\u4e00\u6b65\u8fd4\u56de\u7684 <code>vid</code> \u6279\u91cf\u83b7\u53d6\u5176\u4f59\u7684\u975e\u5411\u91cf\u5c5e\u6027\u3002</p> </li> <li> <p>Graphd (\u6536\u5c3e)\uff1a Graphd \u6267\u884c\u6700\u7ec8\u7684 Limit \u548c Project \u64cd\u4f5c\uff0c\u6574\u7406\u6570\u636e\u540e\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef</p> </li> </ol> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#graphd-details","title":"Graphd Details","text":"","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#1-ann-search-optimization-rule","title":"1. Ann Search Optimization Rule","text":"<p>\u65b0\u7684\u4f18\u5316\u89c4\u5219\u7528\u4e8e\u8bc6\u522b Ann Search \u6a21\u5f0f\u5e76\u5c06\u5176\u8f6c\u6362\u4e3a <code>TagAnnIndexScan</code> \u8ba1\u5212\u3002\u89c4\u5219\u9700\u8981\u8986\u76d6\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\uff1a</p> <ul> <li>\u60c5\u51b5 1\uff1a\u4e0d\u8fd4\u56de\u5411\u91cf\u8ddd\u79bb\uff1a</li> </ul> SQL<pre><code>MATCH (v:tag5:tag6)\nRETURN v\nORDER BY euclidean(vector(1.0\uff0c2.0\uff0c3.0)\uff0c v.vec)\nAPPROXIMATE LIMIT 3\nOPTIONS {ANNINDEX_TYPE:'IVF'\uff0c METRIC_TYPE:L2\uff0c NPROBE:3}\n</code></pre> <p></p> <ul> <li>\u60c5\u51b5 2\uff1a\u8fd4\u56de\u5411\u91cf\u8ddd\u79bb\uff1a<code>ApproximateLimit-&gt;Sort-&gt;Project-&gt;ScanVertices</code> \u8f6c\u6362\u4e3a <code>Limit-&gt;TagAnnIndexScan</code></li> </ul> SQL<pre><code>MATCH (v:tag5:tag6)\nRETURN v\uff0c euclidean(vector(1.0\uff0c2.0\uff0c3.0)\uff0c v.vec)\nORDER BY euclidean(vector(1.0\uff0c2.0\uff0c3.0)\uff0c v.vec)\nAPPROXIMATE LIMIT 1\nOPTIONS {ANNINDEX_TYPE:'IVF'\uff0c METRIC_TYPE:L2\uff0c NPROBE:3}\n</code></pre> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#2-attribute-expression-modification","title":"2. Attribute Expression Modification","text":"<p>\u4e3a\u4e86\u652f\u6301\u5728\u591a\u4e2a\u6807\u7b7e\u4e0a\u5bf9\u540c\u540d\u5411\u91cf\u5c5e\u6027\u8fdb\u884c Ann Search\uff0c\u6211\u4eec\u5fc5\u987b\u4fee\u6539 <code>AttributeExpression</code> \u7684\u5904\u7406\u65b9\u5f0f\u3002</p> SQL<pre><code>MATCH (v:coach_vector:player_vector)\nRETURN v\uff0c euclidean(vector(0.90\uff0c 0.85\uff0c 0.88)\uff0c v.embedding) AS distance\nORDER BY euclidean(vector(0.90\uff0c 0.85\uff0c 0.88)\uff0c v.embedding)\nAPPROXIMATE LIMIT 1\nOPTIONS {ANNINDEX_TYPE:'IVF'\uff0c METRIC_TYPE:L2\uff0c NPROBE:2};\n</code></pre> <ul> <li> <p>\u539f\u6709\u9650\u5236\uff1a \u539f\u59cb\u8868\u8fbe\u5f0f\u5f3a\u5236\u8981\u6c42\u4f7f\u7528 <code>v.tag.prop</code> \u7684\u5f62\u5f0f\u6765\u83b7\u53d6\u9876\u70b9\u5c5e\u6027\uff0c\u8fd9\u6837\u7684\u8bdd <code>v.embedding</code> \u4f1a\u88ab\u8bc6\u522b\u6210\u5bf9 Tag \u7684\u83b7\u53d6\u76f4\u63a5\u8fd4\u56de NULL \u7ed9\u7528\u6237\u3002</p> </li> <li> <p>\u4fee\u6539\u540e\uff1a \u5bf9\u4e8e\u5411\u91cf\u5c5e\u6027\uff0c\u6211\u4eec\u653e\u5bbd\u4e86\u8fd9\u4e00\u9650\u5236\u3002\u7cfb\u7edf\u73b0\u5728\u652f\u6301 <code>v.embedding</code> \u8fd9\u79cd\u5f62\u5f0f\u6765\u83b7\u53d6 Vertex \u7684 Vector \u5c5e\u6027\uff0c\u5e76</p> </li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#storaged-details","title":"Storaged Details","text":"<p>Graphd \u7684\u6267\u884c\u5668\u4f1a\u901a\u8fc7 RPC \u8c03\u7528 Storaged \u4e0a\u7684\u670d\u52a1\u3002Storaged \u5185\u90e8\u4f1a\u542f\u52a8\u81ea\u5df1\u7684\u6267\u884c\u5668\u5e76\u751f\u6210 Storaged \u8ba1\u5212\u3002\u800c\u6211\u4eec\u4e3b\u8981\u9700\u8981\u4fee\u6539\u7684\u662f Storaged \u8ba1\u5212\u4e2d\u7684 <code>AnnIndexScan</code> \u8282\u70b9\u548c <code>GetProp</code> \u8282\u70b9\u3002</p> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#1-annindexscan-node","title":"1. AnnIndexScan Node","text":"<p><code>AnnIndexScan</code> \u7684\u5185\u90e8\u6d41\u7a0b\u4e0e <code>IndexScan</code> \u975e\u5e38\u76f8\u4f3c\uff1a</p> <ol> <li> <p>\u521d\u59cb\u5316\uff1a \u6267\u884c <code>doExecute</code>\uff0c\u5b83\u4f1a\u8c03\u7528 <code>resetIter</code> \u6765\u51c6\u5907\u6570\u636e\u3002</p> </li> <li> <p>\u83b7\u53d6 VectorID\uff1a <code>resetIter</code> \u8d1f\u8d23\u8c03\u7528 Ann Index\uff08\u4f8b\u5982 IVF\uff09\u7684\u641c\u7d22\u63a5\u53e3\u3002\u8fd9\u4e00\u6b65\u8fd4\u56de\u7684\u7ed3\u679c\u4ec5\u4ec5\u662f VectorID\uff08ANN \u7d22\u5f15\u5185\u90e8\u7684 ID\uff09\uff0c\u800c\u4e0d\u662f\u5b9e\u9645\u7684 vid\u3002</p> </li> <li> <p>\u8fed\u4ee3\u4e0e\u6620\u5c04\uff1a <code>doNext</code> \u8d1f\u8d23\u904d\u5386 <code>resetIter</code> \u83b7\u53d6\u7684 VectorID \u7ed3\u679c\u3002</p> </li> <li> <p>\u83b7\u53d6 VID\uff1a \u5728 <code>doNext</code> \u5185\u90e8\uff0c\u8c03\u7528 <code>AnnIndexVertexScan::getVidByVectorid()</code> \u51fd\u6570\u3002\u6b64\u51fd\u6570\u901a\u8fc7\u83b7\u53d6 RocksDB \u7684 id-vid \u5217\u65cf\u6570\u636e\uff0c\u5f97\u5230 VectorID \u5bf9\u5e94\u7684\u5b9e\u9645 vid\u3002</p> </li> <li> <p>\u8fd4\u56de\u6570\u636e\uff1a Storaged \u5c06 vid \u8fd4\u56de\u7ed9 Graphd\u3002</p> </li> </ol> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#2-getprop-node","title":"2. GetProp Node","text":"<p>\u4e3a\u4e86\u914d\u5408 Multi-Tag Ann Search\uff0cStoraged \u4e2d <code>AppendVerticesExecutor</code> \u6267\u884c\u8ba1\u5212\u91cc\u7684 <code>GetProp</code> \u8282\u70b9\u4e5f\u9700\u8981\u4fee\u6539\u3002</p> <p>\u6211\u4eec\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u65b0\u51fd\u6570 <code>collectAllVertexProps</code>\uff0c\u7528\u4e8e\u6536\u96c6\u5355\u4e2a\u9876\u70b9\u7684\u6240\u6709\u975e\u5411\u91cf\u5c5e\u6027\u548c\u5411\u91cf\u5c5e\u6027\u3002</p> <ul> <li> <p>\u76ee\u7684\uff1a \u5f53\u6211\u4eec\u5bf9 tag5 \u548c tag6 \u8fdb\u884c Ann Search \u65f6\uff0c\u4e00\u4e2a\u9876\u70b9\u53ef\u80fd\u53ea\u5339\u914d\u4e86 tag5\uff08\u5373\u5b83\u53ea\u6709 tag5\uff09\uff0c\u4f46\u6ca1\u6709 tag6\u3002</p> </li> <li> <p>\u884c\u4e3a\uff1a <code>collectAllVertexProps</code> \u51fd\u6570\u80fd\u6b63\u786e\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\uff0c\u5c06\u672a\u5339\u914d\u6807\u7b7e\u7684\u5c5e\u6027\u8bbe\u7f6e\u4e3a EMPTY\uff08\u7a7a\uff09\uff0c\u786e\u4fdd\u8fd4\u56de\u7ed9 Graphd \u7684\u6570\u636e\u7ed3\u6784\u59cb\u7ec8\u4e00\u81f4\u3002</p> </li> </ul> <p>GetProp \u8fd4\u56de\u7684\u5c5e\u6027\u793a\u4f8b\uff1a</p> Bash<pre><code> _vid|tag5.id|tag5.vec|tag5._tag|tag6.num|tag6.vec|tag6._tag\n \"v7\"|7|vector(1.9\uff0c2.0\uff0c2.1)|2|__EMPTY__|__EMPTY__|__EMPTY__\n \"v8\"|8|vector(2.2\uff0c2.3\uff0c2.4)|2|__EMPTY__|__EMPTY__|__EMPTY__\n \"v6\"|6|vector(1.6\uff0c1.7\uff0c1.8)|2|__EMPTY__|__EMPTY__|__EMPTY__\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#_1","title":"\u8e29\u8fc7\u7684\u5751","text":"<p>\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\u8fc7\u7a0b\u4e2d\uff0c\u4e00\u822c\u6211\u4eec\u9047\u5230\u7684\u95ee\u9898\u90fd\u662f\u8bbe\u8ba1\u4e0d\u591f\u5468\u5168\u5bfc\u81f4\u7684\u3002\u8fd9\u91cc\u603b\u7ed3\u51e0\u4e2a\u6bd4\u8f83\u5178\u578b\u7684\uff1a</p> <ol> <li>Ann Index \u5143\u6570\u636e\u8bbe\u8ba1\u4e0d\u5408\u7406</li> </ol> <ul> <li>\u95ee\u9898\uff1a\u6700\u521d\u6211\u4eec\u5c1d\u8bd5\u4f7f\u7528\u901a\u7528\u7d22\u5f15\u9879 <code>IndexItem</code> \u6765\u8868\u793a Ann Index \u5143\u6570\u636e\uff0c\u4f46\u5b83\u65e0\u6cd5\u652f\u6301\u5728\u591a\u4e2a\u6807\u7b7e\u4e0a\u5bf9\u540c\u540d\u5c5e\u6027\u521b\u5efa\u7d22\u5f15\u7684\u9700\u6c42\u3002</li> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u6211\u4eec\u8bbe\u8ba1\u4e86\u65b0\u7684 <code>AnnIndexItem</code> \u7ed3\u6784\uff0c\u80fd\u591f\u5305\u542b\u591a\u4e2a Tag \u7684\u4fe1\u606f\uff0c\u5e76\u4e14\u4f7f\u7528\u5217\u8868\u6765\u5b58\u50a8\u521b\u5efa Ann Index \u6240\u9700\u7684\u53c2\u6570\u3002</li> </ul> <ol> <li>Ann Index \u521b\u5efa\u7684\u65f6\u5e8f\u95ee\u9898</li> </ol> <ul> <li>\u95ee\u9898\uff1a\u5b9e\u73b0\u8fc7\u7a0b\u4e2d\u5e76\u672a\u8003\u8651 Metad \u548c Storaged \u7684\u65f6\u5e8f\u95ee\u9898\uff0c\u5728\u6d4b\u8bd5\u65f6\u53d1\u73b0\u65e0\u6cd5\u83b7\u53d6\u5230 Ann Index</li> <li>\u539f\u7406\uff1a\u5728 Metad \u521b\u5efa Ann Index \u540e\uff0cStoraged \u53ef\u80fd\u65e0\u6cd5\u7acb\u5373\u770b\u5230\u65b0\u521b\u5efa\u7684\u7d22\u5f15\uff0c\u56e0\u4e3a Meta Client \u7684\u7f13\u5b58\u9700\u8981\u901a\u8fc7\u5fc3\u8df3\u5468\u671f\u66f4\u65b0\u3002</li> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u6211\u4eec\u5728 Storaged \u4e2d\u5b9e\u73b0\u4e86\u91cd\u8bd5\u673a\u5236\u3002\u5982\u679c\u591a\u6b21\u91cd\u8bd5\u5931\u8d25\uff0c\u6211\u4eec\u4f1a\u76f4\u63a5\u4ece\u5143\u670d\u52a1\u5668\u8bf7\u6c42\u6570\u636e\u4ee5\u5f3a\u5236\u5237\u65b0\u7f13\u5b58\u3002</li> </ul> <ol> <li>Ann Search \u4f18\u5316\u89c4\u5219\u4e0d\u5b8c\u5584</li> </ol> <ul> <li>\u95ee\u9898\uff1a\u6700\u521d\u7684\u4f18\u5316\u89c4\u5219\u53ea\u8986\u76d6\u4e86\u8fd4\u56de\u5411\u91cf\u8ddd\u79bb\u7684\u60c5\u51b5\uff0c\u5ffd\u7565\u4e86\u4e0d\u8fd4\u56de\u5411\u91cf\u8ddd\u79bb\u7684\u573a\u666f\u3002</li> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u6211\u4eec\u6269\u5c55\u4e86\u4f18\u5316\u89c4\u5219\uff0c\u786e\u4fdd\u5b83\u80fd\u591f\u8bc6\u522b\u4e24\u79cd\u60c5\u51b5\uff0c\u5e76\u6b63\u786e\u751f\u6210\u5305\u542b <code>TagAnnIndexScan</code> \u8282\u70b9\u7684\u6267\u884c\u8ba1\u5212\u3002</li> </ul> <ol> <li>Multi-Tag Ann Search \u5c5e\u6027\u83b7\u53d6\u95ee\u9898    - \u95ee\u9898\uff1a\u5728 Multi-Tag Ann Search \u573a\u666f\u4e0b\uff0c<code>v.embedding</code> \u8fd9\u79cd\u5f62\u5f0f\u65e0\u6cd5\u6b63\u786e\u83b7\u53d6\u5411\u91cf\u5c5e\u6027\uff0c\u5bfc\u81f4\u8fd4\u56de\u7ed3\u679c\u603b\u662f\u4e3a\u7a7a\u3002    - \u539f\u56e0\uff1a\u539f\u59cb\u7684 <code>AttributeExpression</code> \u5b9e\u73b0\u5f3a\u5236\u8981\u6c42\u4f7f\u7528 <code>v.tag.prop</code> \u7684\u5f62\u5f0f\u6765\u83b7\u53d6\u9876\u70b9\u5c5e\u6027\u3002    - \u89e3\u51b3\u65b9\u6848\uff1a\u6211\u4eec\u4fee\u6539\u4e86 <code>AttributeExpression</code> \u7684\u5904\u7406\u903b\u8f91\uff0c\u5141\u8bb8\u5bf9\u5411\u91cf\u5c5e\u6027\u4f7f\u7528 <code>v.embedding</code> \u8fd9\u79cd\u5f62\u5f0f\u8fdb\u884c\u8bbf\u95ee\u3002\u540c\u65f6\u4e3a\u4e86\u7b80\u5316\u903b\u8f91\uff0c\u6211\u4eec\u8bbe\u8ba1\u4e86 <code>collectAllVertexProps</code> \u51fd\u6570\uff0c\u786e\u4fdd\u5373\u4f7f\u67d0\u4e9b\u6807\u7b7e\u672a\u5339\u914d\uff0c\u5176\u5c5e\u6027\u4e5f\u4f1a\u88ab\u8bbe\u7f6e\u4e3a EMPTY\uff0c\u4ece\u800c\u4fdd\u6301\u6570\u636e\u7ed3\u6784\u7684\u4e00\u81f4\u6027\u3002</li> </ol>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#_2","title":"\u603b\u7ed3","text":"<p>\u672c\u6587\u8be6\u7ec6\u4ecb\u7ecd\u4e86\u5728 Nebula Graph \u4e2d\u5b9e\u73b0\u5411\u91cf\u7d22\u5f15\u548c\u76f8\u4f3c\u5ea6\u641c\u7d22\u7684\u5b8c\u6574\u8fc7\u7a0b\uff0c\u8fd9\u662f\u672c\u7cfb\u5217\u7684\u4e0b\u7bc7\u3002\u5728\u524d\u4e24\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u5b8c\u6210\u4e86 Vector \u7c7b\u578b\u7684\u5b58\u50a8\u652f\u6301\u4ee5\u53ca DDL/DML \u7684\u9002\u914d\uff0c\u800c\u672c\u7bc7\u5219\u805a\u7126\u4e8e Ann Index \u7684\u6784\u5efa\u548c Ann Search \u7684\u5b9e\u73b0\u3002</p> <p> \u5b9e\u5728\u662f\u6ca1\u6709\u65f6\u95f4\uff0c\u5206\u5e03\u5f0f\u4e0b\u7684\u529f\u80fd\u8fd8\u6ca1\u6709\u5b8c\u6210\uff0c\u5e0c\u671b\u4ee5\u540e\u6709\u673a\u4f1a\u518d\u6765\u586b\u5751\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#_3","title":"\u6838\u5fc3\u6210\u679c","text":"<p>\u901a\u8fc7\u672c\u6b21\u5f00\u53d1\uff0c\u6211\u4eec\u5b9e\u73b0\u4e86\u4ee5\u4e0b\u6838\u5fc3\u529f\u80fd:</p> <ol> <li> <p>\u7edf\u4e00\u7684 Ann Index \u63a5\u53e3: \u8bbe\u8ba1\u4e86 <code>AnnIndex</code> \u62bd\u8c61\u63a5\u53e3\uff0c\u6210\u529f\u5c01\u88c5\u4e86 HNSWlib \u548c Faiss \u4e24\u79cd\u4e3b\u6d41\u5411\u91cf\u7d22\u5f15\u5e93\uff0c\u4e3a\u540e\u7eed\u6269\u5c55\u66f4\u591a\u7d22\u5f15\u7c7b\u578b\u5960\u5b9a\u4e86\u57fa\u7840\u3002</p> </li> <li> <p>\u5b8c\u6574\u7684\u7d22\u5f15\u751f\u547d\u5468\u671f\u7ba1\u7406: \u901a\u8fc7 <code>VectorIndexManager</code> \u5355\u4f8b\u5b9e\u73b0\u4e86\u5411\u91cf\u7d22\u5f15\u7684\u521b\u5efa\u3001\u8bbf\u95ee\u3001\u66f4\u65b0\u548c\u5220\u9664\u7684\u5b8c\u6574\u751f\u547d\u5468\u671f\u7ba1\u7406\uff0c\u5305\u62ec\u7d22\u5f15\u7684\u6301\u4e45\u5316\u548c\u91cd\u542f\u540e\u7684\u81ea\u52a8\u52a0\u8f7d\u3002</p> </li> <li> <p>Multi-Tag Ann Index \u652f\u6301: \u7a81\u7834\u4e86\u4f20\u7edf\u7d22\u5f15\u53ea\u80fd\u4f5c\u7528\u4e8e\u5355\u4e2a Schema \u7684\u9650\u5236\uff0c\u5b9e\u73b0\u4e86\u8de8\u591a\u4e2a Tag \u5bf9\u540c\u540d\u5411\u91cf\u5c5e\u6027\u5efa\u7acb\u7d22\u5f15\u7684\u80fd\u529b\uff0c\u8fd9\u662f\u672c\u6b21\u5b9e\u73b0\u7684\u4e00\u5927\u4eae\u70b9\u3002</p> </li> <li> <p>\u9ad8\u6548\u7684 Ann Search \u6267\u884c\u6d41\u7a0b: \u8bbe\u8ba1\u4e86\u4ece Graphd \u5230 Storaged \u7684\u5b8c\u6574\u6267\u884c\u94fe\u8def,\u5305\u62ec\u65b0\u7684\u4f18\u5316\u89c4\u5219\u3001<code>TagAnnIndexScan</code> \u6267\u884c\u8282\u70b9,\u4ee5\u53ca VectorID \u5230 VertexID \u7684\u6620\u5c04\u673a\u5236\u3002</p> </li> </ol>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#_4","title":"\u56de\u987e\u5173\u952e\u95ee\u9898","text":"<p>\u5728\u6587\u7ae0\u5f00\u5934\uff0c\u6211\u4eec\u63d0\u51fa\u4e86\u4e09\u4e2a\u5173\u952e\u95ee\u9898\u3002\u73b0\u5728\u8ba9\u6211\u4eec\u6765\u56de\u987e\u4e00\u4e0b\u8fd9\u4e9b\u95ee\u9898\u7684\u7b54\u6848\uff1a</p> <p>\u95ee\u9898 1\uff1aAnn Index \u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u8c01\u6765\u8d1f\u8d23\uff1f</p> <p>\u7b54\u6848\uff1a\u7531 Storaged \u901a\u8fc7 <code>VectorIndexManager</code> \u5355\u4f8b\u6765\u7ba1\u7406\u3002\u8fd9\u4e2a\u5355\u4f8b\u7ef4\u62a4\u4e86\u4e00\u4e2a\u5185\u5b58\u4e2d\u7684\u5411\u91cf\u7d22\u5f15\u6620\u5c04\u8868\uff08Key \u4e3a <code>GraphSpaceID + PartID + IndexID</code>\uff0cValue \u4e3a\u5177\u4f53\u7684\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\uff09\u3002<code>VectorIndexManager</code> \u5728\u5b58\u50a8\u5b88\u62a4\u8fdb\u7a0b\u542f\u52a8\u65f6\u521d\u59cb\u5316\u5e76\u52a0\u8f7d\u6301\u4e45\u5316\u7684\u7d22\u5f15\uff0c\u5728\u8fdb\u7a0b\u9000\u51fa\u524d\u5c06\u6240\u6709\u7d22\u5f15\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u79cd\u8bbe\u8ba1\u5c06\u7d22\u5f15\u5b9e\u4f8b\u7ef4\u62a4\u5728\u5b58\u50a8\u5c42\uff0c\u65e2\u4fdd\u8bc1\u4e86\u6570\u636e\u5c40\u90e8\u6027\uff0c\u53c8\u7b80\u5316\u4e86\u5206\u5e03\u5f0f\u73af\u5883\u4e0b\u7684\u4e00\u81f4\u6027\u95ee\u9898\u3002</p> <p>\u95ee\u9898 2\uff1aAnn Index \u7684\u6570\u636e\u5b58\u50a8\u5728\u54ea\u91cc\uff1f</p> <p>\u7b54\u6848\uff1aAnn Index \u4ee5\u4e24\u79cd\u5f62\u5f0f\u5b58\u50a8\uff1a</p> <ul> <li>\u5185\u5b58\u5b58\u50a8\uff1a\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\uff08IVF\u3001HNSW\uff09\u5e38\u9a7b\u5185\u5b58\uff0c\u901a\u8fc7 <code>VectorIndexManager</code> \u7ba1\u7406\uff0c\u4ee5\u652f\u6301\u9ad8\u6027\u80fd\u7684\u5411\u91cf\u641c\u7d22\u3002</li> <li>\u78c1\u76d8\u6301\u4e45\u5316\uff1a\u8c03\u7528 Faiss \u548c HNSWlib \u7684\u5e8f\u5217\u5316\u63a5\u53e3\uff0c\u5c06\u7d22\u5f15\u4ee5\u4e8c\u8fdb\u5236\u5f62\u5f0f\u5199\u5165\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u3002\u8fd9\u4e9b\u5e93\u5e95\u5c42\u4f7f\u7528 C++ IOStream \u5e8f\u5217\u5316\u673a\u5236\u3002</li> <li>\u6620\u5c04\u5173\u7cfb\u5b58\u50a8\uff1aVectorID \u4e0e VertexID/EdgeType \u4e4b\u95f4\u7684\u6620\u5c04\u5173\u7cfb\u5b58\u50a8\u5728 RocksDB \u7684 id-vid \u5217\u65cf\u4e2d\uff0c\u786e\u4fdd\u80fd\u591f\u5c06\u5411\u91cf\u641c\u7d22\u7ed3\u679c\u8f6c\u6362\u56de\u5b9e\u9645\u7684\u9876\u70b9\u6216\u8fb9\u3002</li> </ul> <p>\u95ee\u9898 3\uff1aAnn Search \u751f\u6210\u7684\u8ba1\u5212\u5982\u4f55\u4f7f\u7528 Ann Index \u8fdb\u884c\u641c\u7d22\uff1f</p> <p>\u7b54\u6848\uff1a\u901a\u8fc7\u4e13\u95e8\u7684\u4f18\u5316\u89c4\u5219\u548c\u6267\u884c\u8282\u70b9\u5b9e\u73b0\uff1a</p> <ol> <li>Graphd \u4f18\u5316\u9636\u6bb5\uff1a\u65b0\u7684\u4f18\u5316\u89c4\u5219\u8bc6\u522b <code>APPROXIMATE LIMIT</code> \u8bed\u6cd5\uff0c\u5c06 <code>ApproximateLimit-&gt;Sort-&gt;Project-&gt;ScanVertices</code> \u8f6c\u6362\u4e3a <code>Limit-&gt;TagAnnIndexScan</code> \u6267\u884c\u8ba1\u5212\u3002</li> <li>Storaged \u6267\u884c\u9636\u6bb5\uff1a<code>AnnIndexScan</code> \u8282\u70b9\u901a\u8fc7 <code>VectorIndexManager</code> \u83b7\u53d6\u5bf9\u5e94\u7684\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\uff0c\u8c03\u7528\u5176 <code>search</code> \u63a5\u53e3\u8fd4\u56de VectorID \u5217\u8868\u3002</li> <li>ID \u6620\u5c04\u8f6c\u6362\uff1a\u901a\u8fc7\u67e5\u8be2 RocksDB \u7684 id-vid \u5217\u65cf\uff0c\u5c06 VectorID \u8f6c\u6362\u4e3a\u5b9e\u9645\u7684 VertexID\u3002</li> <li>\u5c5e\u6027\u8865\u5168\uff1aGraphd \u4f7f\u7528\u8fd4\u56de\u7684 VertexID \u5217\u8868\u8c03\u7528 <code>GetProp</code> \u83b7\u53d6\u5b8c\u6574\u7684\u9876\u70b9\u5c5e\u6027\uff0c\u901a\u8fc7 <code>collectAllVertexProps</code> \u51fd\u6570\u5904\u7406 Multi-Tag \u573a\u666f\u3002</li> </ol>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#_5","title":"\u5173\u952e\u6280\u672f\u51b3\u7b56","text":"<p>\u5728\u5b9e\u73b0\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u505a\u51fa\u4e86\u51e0\u4e2a\u91cd\u8981\u7684\u6280\u672f\u51b3\u7b56:</p> <ul> <li> <p>\u7d22\u5f15\u751f\u547d\u5468\u671f\u7531 Storaged \u7ba1\u7406: \u5c06\u5411\u91cf\u7d22\u5f15\u5b9e\u4f8b\u7ef4\u62a4\u5728\u5b58\u50a8\u5c42\uff0c\u65e2\u80fd\u4fdd\u8bc1\u6570\u636e\u5c40\u90e8\u6027\uff0c\u53c8\u80fd\u7b80\u5316\u5206\u5e03\u5f0f\u73af\u5883\u4e0b\u7684\u4e00\u81f4\u6027\u95ee\u9898\u3002</p> </li> <li> <p>\u65b0\u7684\u5143\u6570\u636e\u7ed3\u6784 <code>AnnIndexItem</code>: \u6446\u8131\u4e86\u901a\u7528 <code>IndexItem</code> \u7684\u9650\u5236\uff0c\u4e13\u95e8\u4e3a Ann Index \u8bbe\u8ba1\u7684\u5143\u6570\u636e\u7ed3\u6784\uff0c\u80fd\u591f\u66f4\u597d\u5730\u652f\u6301 Multi-Tag \u573a\u666f\u3002</p> </li> <li> <p>\u91cd\u8bd5\u673a\u5236\u89e3\u51b3\u65f6\u5e8f\u95ee\u9898: \u901a\u8fc7\u5728 Storaged \u4e2d\u5f15\u5165\u91cd\u8bd5\u673a\u5236\uff0c\u89e3\u51b3\u4e86 Meta Client \u7f13\u5b58\u66f4\u65b0\u5ef6\u8fdf\u5e26\u6765\u7684\u65f6\u5e8f\u95ee\u9898\u3002</p> </li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#_6","title":"\u7ecf\u9a8c\u4e0e\u6559\u8bad","text":"<p>\u56de\u987e\u6574\u4e2a\u5f00\u53d1\u8fc7\u7a0b\uff0c\u6211\u4eec\u603b\u7ed3\u51fa\u4ee5\u4e0b\u51e0\u70b9\u7ecf\u9a8c:</p> <ol> <li> <p>\u5145\u5206\u8003\u8651\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u65f6\u5e8f\u95ee\u9898: \u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\uff0c\u4e0d\u540c\u7ec4\u4ef6\u4e4b\u95f4\u7684\u72b6\u6001\u540c\u6b65\u662f\u5f02\u6b65\u7684\u3002\u6211\u4eec\u5728 Ann Index \u521b\u5efa\u6d41\u7a0b\u4e2d\u9047\u5230\u7684 Meta Client \u7f13\u5b58\u66f4\u65b0\u95ee\u9898\u5c31\u662f\u4e00\u4e2a\u5178\u578b\u6848\u4f8b\u3002\u8bbe\u8ba1\u65f6\u5e94\u8be5\u5145\u5206\u8003\u8651\u8fd9\u7c7b\u65f6\u5e8f\u95ee\u9898\uff0c\u5e76\u8bbe\u8ba1\u76f8\u5e94\u7684\u91cd\u8bd5\u6216\u5f3a\u5236\u5237\u65b0\u673a\u5236\u3002</p> </li> <li> <p>\u63a5\u53e3\u8bbe\u8ba1\u8981\u8003\u8651\u53ef\u6269\u5c55\u6027: <code>AnnIndex</code> \u63a5\u53e3\u7684\u8bbe\u8ba1\u4f7f\u5f97\u6211\u4eec\u80fd\u591f\u8f7b\u677e\u652f\u6301\u591a\u79cd\u5411\u91cf\u7d22\u5f15\u5e93\u3002\u7edf\u4e00\u7684\u63a5\u53e3\u4e0d\u4ec5\u7b80\u5316\u4e86\u4e0a\u5c42\u8c03\u7528\u903b\u8f91\uff0c\u4e5f\u4e3a\u540e\u7eed\u5f15\u5165\u65b0\u7684\u7d22\u5f15\u7c7b\u578b(\u5982 DiskANN\u3001ScaNN \u7b49)\u9884\u7559\u4e86\u7a7a\u95f4\u3002</p> </li> <li> <p>\u4f18\u5316\u89c4\u5219\u8981\u8986\u76d6\u6240\u6709\u573a\u666f: \u5728\u5b9e\u73b0 Ann Search \u4f18\u5316\u89c4\u5219\u65f6\uff0c\u6211\u4eec\u6700\u521d\u53ea\u8003\u8651\u4e86\u8fd4\u56de\u8ddd\u79bb\u7684\u573a\u666f\uff0c\u5bfc\u81f4\u4e0d\u8fd4\u56de\u8ddd\u79bb\u7684\u67e5\u8be2\u65e0\u6cd5\u88ab\u4f18\u5316\u3002\u8fd9\u63d0\u9192\u6211\u4eec\u5728\u8bbe\u8ba1\u4f18\u5316\u89c4\u5219\u65f6\uff0c\u9700\u8981\u5168\u9762\u68b3\u7406\u6240\u6709\u53ef\u80fd\u7684\u67e5\u8be2\u6a21\u5f0f\u3002</p> </li> <li> <p>\u6d4b\u8bd5\u5148\u884c: \u5728\u5f00\u53d1\u8fc7\u7a0b\u4e2d\uff0c\u5145\u5206\u7684\u6d4b\u8bd5\u5e2e\u52a9\u6211\u4eec\u53d1\u73b0\u4e86\u8bb8\u591a\u8bbe\u8ba1\u4e0a\u7684\u758f\u6f0f\uff0c\u5982 Multi-Tag \u573a\u666f\u4e0b\u7684\u5c5e\u6027\u83b7\u53d6\u95ee\u9898\u3002\u5b8c\u5584\u7684\u6d4b\u8bd5\u7528\u4f8b\u4e0d\u4ec5\u80fd\u5e2e\u52a9\u53d1\u73b0 bug\uff0c\u8fd8\u80fd\u9a71\u52a8\u6211\u4eec\u601d\u8003\u66f4\u591a\u7684\u8fb9\u754c\u60c5\u51b5\u3002</p> </li> </ol>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%8B%E7%AF%87%EF%BC%9A%E5%90%91%E9%87%8F%E7%B4%A2%E5%BC%95%E4%B8%8E%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%90%9C%E7%B4%A2%20%E2%80%94%E2%80%94%20Nebula%20Graph%20%E7%9A%84%20ANN%20%E5%AE%9E%E7%8E%B0%E4%B9%8B%E8%B7%AF/#_7","title":"\u5c55\u671b","text":"<p>\u5f53\u524d\u7684\u5b9e\u73b0\u5df2\u7ecf\u57fa\u672c\u6ee1\u8db3\u4e86\u5411\u91cf\u641c\u7d22\u7684\u6838\u5fc3\u9700\u6c42\uff0c\u4f46\u4ecd\u6709\u4e00\u4e9b\u53ef\u4ee5\u4f18\u5316\u548c\u6269\u5c55\u7684\u65b9\u5411:</p> <ul> <li> <p>\u7d22\u5f15\u66f4\u65b0\u7b56\u7565\u4f18\u5316: \u5f53\u524d\u7684\u7d22\u5f15\u66f4\u65b0\u662f\u5b9e\u65f6\u7684\uff0c\u5bf9\u4e8e\u5927\u89c4\u6a21\u6570\u636e\u63d2\u5165\u573a\u666f\uff0c\u53ef\u4ee5\u8003\u8651\u5f15\u5165\u6279\u91cf\u66f4\u65b0\u6216\u5f02\u6b65\u66f4\u65b0\u673a\u5236\u3002</p> </li> <li> <p>\u66f4\u591a\u7d22\u5f15\u7c7b\u578b\u652f\u6301: \u53ef\u4ee5\u5f15\u5165\u66f4\u591a\u7c7b\u578b\u7684\u5411\u91cf\u7d22\u5f15\uff0c\u5982\u57fa\u4e8e\u78c1\u76d8\u7684 DiskANN\uff0c\u4ee5\u652f\u6301\u8d85\u5927\u89c4\u6a21\u5411\u91cf\u6570\u636e\u3002</p> </li> <li> <p>\u6df7\u5408\u67e5\u8be2\u4f18\u5316: \u63a2\u7d22\u5411\u91cf\u641c\u7d22\u4e0e\u56fe\u904d\u5386\u7684\u66f4\u6df1\u5ea6\u878d\u5408\uff0c\u5982\u5728\u56fe\u904d\u5386\u8fc7\u7a0b\u4e2d\u52a8\u6001\u6267\u884c\u5411\u91cf\u8fc7\u6ee4\u3002</p> </li> <li> <p>\u5206\u5e03\u5f0f\u7d22\u5f15: \u5f53\u524d\u7d22\u5f15\u662f\u6309\u5206\u533a\u72ec\u7acb\u7ba1\u7406\u7684\uff0c\u672a\u6765\u53ef\u4ee5\u8003\u8651\u5b9e\u73b0\u8de8\u5206\u533a\u7684\u5206\u5e03\u5f0f\u7d22\u5f15\uff0c\u63d0\u5347\u5927\u89c4\u6a21\u573a\u666f\u4e0b\u7684\u67e5\u8be2\u6027\u80fd\u3002</p> </li> </ul> <p>\u901a\u8fc7\u8fd9\u4e2a\u9879\u76ee\uff0c\u6211\u6df1\u523b\u4f53\u4f1a\u5230\u5728\u590d\u6742\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u6dfb\u52a0\u65b0\u529f\u80fd\u7684\u6311\u6218\u6027\u3002\u5b83\u4e0d\u4ec5\u9700\u8981\u5bf9\u7cfb\u7edf\u67b6\u6784\u6709\u6df1\u5165\u7684\u7406\u89e3\uff0c\u8fd8\u9700\u8981\u7ec6\u81f4\u5730\u8003\u8651\u5404\u79cd\u8fb9\u754c\u60c5\u51b5\u548c\u6027\u80fd\u4f18\u5316\u3002\u5e0c\u671b\u8fd9\u4e2a\u7cfb\u5217\u7684\u5206\u4eab\u80fd\u7ed9\u6b63\u5728\u5f00\u53d1\u7c7b\u4f3c\u529f\u80fd\u7684\u540c\u5b66\u4e00\u4e9b\u53c2\u8003\u548c\u542f\u53d1\u3002</p> <p>\u6700\u540e\uff0c\u611f\u8c22 Nebula Graph \u793e\u533a\u548c\u5f00\u6e90\u4e4b\u590f\u9879\u76ee\u7ec4\u63d0\u4f9b\u7684\u5b66\u4e60\u548c\u5b9e\u8df5\u673a\u4f1a\uff01\u611f\u8c22\u6211\u7684\u9879\u76ee\u66f9\u5fd7\u9e4f\u5bfc\u5e08\u7684\u6307\u5bfc\u548c Nebula Graph \u793e\u533a\u5c0f\u59d0\u59d0\u7684\u5e2e\u52a9\uff01 \ud83c\udf89</p> <p>\u76f8\u5173\u6587\u7ae0:</p> <ul> <li>\u4e0a\u7bc7\uff1a\u521d\u8bc6 Nebula Graph \u2014\u2014 \u5411\u91cf\u7c7b\u578b\u652f\u6301</li> <li>\u4e2d\u7bc7\uff1aVector \u7c7b\u578b\u7684 DDL&amp;DML \u9002\u914d</li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/","title":"\u4e2d\u7bc7\uff1aVector \u7c7b\u578b\u7684 DDL & DML \u9002\u914d","text":"2025-11-052025-12-13 <code>#Database</code>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#vector-ddl-dml","title":"\u4e2d\u7bc7\uff1aVector \u7c7b\u578b\u7684 DDL &amp; DML \u9002\u914d","text":"<p> \u7ea6 3333 \u4e2a\u5b57  269 \u884c\u4ee3\u7801  8 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 20 \u5206\u949f</p> <p>\ud83d\udcda \u672c\u7cfb\u5217\u6587\u7ae0\u5206\u4e3a\u4e0a\u4e2d\u4e0b\u4e09\u7bc7\uff0c\u8bb0\u5f55\u4e86\u6211\u5728\u5f00\u6e90\u4e4b\u590f\u9879\u76ee\u4e2d\uff0c\u5f00\u53d1 Nebula Graph \u5411\u91cf\u641c\u7d22\u529f\u80fd\u7684\u4e00\u4e9b\u590d\u76d8\u548c\u601d\u8003\uff0c\u5e0c\u671b\u53ef\u4ee5\u7ed9\u5927\u5bb6\u5b66\u4e60\u548c\u5f00\u53d1\u7c7b\u4f3c\u7cfb\u7edf\u65f6\u6709\u4e00\u5b9a\u7684\u6837\u672c\u53c2\u8003\u3002\u5e0c\u671b\u5927\u5bb6\u591a\u591a\u5173\u6ce8\u548c\u4ea4\u6d41\uff0c\u5927\u5bb6\u4e00\u8d77\u8fdb\u6b65 \ud83d\ude0a \u6b22\u8fce\u8ba2\u9605\u6211\u7684\u4e2a\u4eba\u7f51\u7ad9 tom-jerr.github.io</p> <p>\u672c\u7bc7\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u652f\u6301\u5411\u91cf\u5c5e\u6027\u7684 DDL \u548c DML \u8bed\u53e5( \u8d70\u4e86\u5f88\u591a\u8bbe\u8ba1\u7684\u5f2f\u8def)\u3002</p> <p>\u5728nebula graph \u7684\u4e0a\u7bc7\u6211\u4eec\u5df2\u7ecf\u5bf9 Nebula Graph \u7684\u6574\u4f53\u6267\u884c\u6d41\u7a0b\u6709\u4e86\u8ba4\u8bc6\uff0c\u5e76\u6982\u8ff0\u4e86\u5982\u4f55\u5b9e\u73b0 Vector \u6570\u636e\u7c7b\u578b\u4ee5\u53ca Vector \u5b58\u50a8\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u9700\u8981\u5c06 Vector \u7c7b\u578b\u96c6\u6210\u5230 Nebula Graph \u4e2d\uff0c\u652f\u6301\u7528\u6237\u901a\u8fc7 DDL \u548c DML \u8bed\u53e5\u6765\u521b\u5efa\u548c\u64cd\u4f5c Vector \u7c7b\u578b\u7684\u5c5e\u6027\u3002\u6211\u4eec\u9700\u8981\u89e3\u51b3\u51e0\u4e2a\u5173\u952e\u95ee\u9898\uff1a</p> <ul> <li>\u5982\u4f55\u5728\u5df2\u6709\u7684 Tag/Edge Schema \u4e2d\u6dfb\u52a0 Vector \u7c7b\u578b\u7684\u5c5e\u6027\uff1f</li> <li>\u5982\u4f55\u5728 Insert/Update \u8bed\u53e5\u4e2d\u63d2\u5165\u548c\u66f4\u65b0 Vector \u7c7b\u578b\u7684\u5c5e\u6027\u503c\uff1f</li> <li>\u5982\u4f55\u4fdd\u8bc1 Storage \u5c42\u83b7\u53d6\u6b63\u786e\u7684 Schema \u4fe1\u606f\uff0c\u5e76\u6b63\u786e\u5b58\u50a8\u548c\u8bfb\u53d6 Vector \u7c7b\u578b\u7684\u5c5e\u6027\u503c\uff1f</li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u4e00\u6b65\u4e00\u6b65\u6765\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u6211\u4eec\u5c06\u4ece DDL \u9002\u914d\u5f00\u59cb\u8bb2\u8d77\uff0c\u7136\u540e\u662f DML \u9002\u914d\uff0c\u6700\u540e\u603b\u7ed3\u6211\u4eec\u4e2d\u95f4\u8d70\u4e86\u7684\u5f2f\u8def\u548c\u7ecf\u9a8c\u6559\u8bad\uff0c\u4e0a\u9762\u63d0\u5230\u7684\u95ee\u9898\u6211\u4eec\u90fd\u4f1a\u4e00\u4e00\u8986\u76d6\u5230\u3002</p> <p> \u8fd9\u91cc\u4e3a\u4e86\u7b80\u5316\uff0c\u6211\u4eec\u5047\u8bbe\u4f7f\u7528 Tag Schema \u8fdb\u884c\u8bf4\u660e</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#ddl","title":"DDL \u9002\u914d","text":"<p>\u5728 Nebula Graph \u4e2d\uff0cTag/Edge \u7684 Schema \u5b9a\u4e49\u5b58\u50a8\u5728 Metad \u8282\u70b9\u4e2d\uff0c\u7528\u6237\u901a\u8fc7 DDL \u8bed\u53e5\uff08\u5982 CREATE TAG/ALTER TAG\uff09\u6765\u5b9a\u4e49\u548c\u4fee\u6539 Schema\u3002</p> <p> \u5b9e\u9645\u4e0a Storaged \u8282\u70b9\u5728\u6267\u884c DML \u8bed\u53e5\u65f6\u4f1a\u4ece Metad \u83b7\u53d6\u6700\u65b0\u7684 Schema \u4fe1\u606f\u3002\u901a\u8fc7\u81ea\u5df1\u7684 cache \u5b9a\u671f\u66f4\u65b0\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#ddl-syntax","title":"DDL Syntax","text":"<p>\u6211\u4eec\u9700\u8981\u5728 DDL \u8bed\u53e5\u4e2d\u652f\u6301\u5b9a\u4e49 Vector \u7c7b\u578b\u7684\u5c5e\u6027\u3002</p> <ul> <li>\u5b9a\u4e49 vector \u5c5e\u6027\u65f6\uff0c\u9700\u8981\u6307\u5b9a\u5411\u91cf\u7684\u7ef4\u5ea6\uff0c\u4f8b\u5982 <code>vector(128)</code> \u8868\u793a\u4e00\u4e2a 128 \u7ef4\u7684\u5411\u91cf\u3002</li> <li>\u5bf9\u4e8e vector \u5177\u4f53\u7684\u6570\u503c\u5e38\u91cf\uff0c\u6211\u4eec\u4e3a\u4e86\u907f\u514d parser \u7684\u4e8c\u4e49\u6027\uff0c\u5355\u72ec\u8bbe\u8ba1\u4e86\u8bed\u6cd5\u89c4\u5219 <code>vector(1.0,2.0,3.0)</code> \u6765\u8868\u793a\u4e00\u4e2a\u5177\u4f53\u7684\u5411\u91cf\u503c\u3002</li> </ul> Cypher<pre><code>CREATE TAG IF NOT EXISTS test1(name string, embedding vector(3) DEFAULT vector(1.0,2.0,3.0)) TTL_DURATION = 100, TTL_COL = \"create_time\";;\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#schema-support","title":"Schema Support","text":"","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#schema-storage","title":"Schema Storage","text":"<p>Meta \u670d\u52a1\u4f7f\u7528 RocksDB \u5b58\u50a8\uff0c\u5c06 schema \u5bf9\u5e94\u7684 KV \u5bf9\u5b58\u5165\u5176\u4e2d</p> <ul> <li> <p>Key \u7ed3\u6784\uff1a <code>SpaceId + TagId + Version</code></p> </li> <li> <p>Value \u662f Thrift \u5e8f\u5217\u5316\u7684 Schema \u5b9a\u4e49\uff0c\u6211\u4eec\u590d\u7528\u4e86\u539f\u6709\u7684 Schema \u7ed3\u6784\uff0c\u53ea\u662f\u6269\u5c55\u4e86 ColumnTypeDef \u6765\u652f\u6301 Vector \u7c7b\u578b</p> </li> </ul> <p>\u8fd9\u91cc\u6211\u4eec\u590d\u7528\u4e86 <code>ColumnTypeDef</code> \u4e2d\u7684 <code>type_length</code> \u5b57\u6bb5\u6765\u8868\u793a Vector \u7684\u7ef4\u5ea6</p> C++<pre><code>struct ColumnTypeDef {\n  1: required common.PropertyType    type, // add vector type\n  // type_length is valid for fixed_string type and vector type for dimension\n  2: optional i16                    type_length = 0,\n  // geo_shape is valid for geography type\n  3: optional GeoShape               geo_shape,\n}\nstruct ColumnDef {\n    1: required binary          name,\n    2: required ColumnTypeDef   type,\n    3: optional binary          default_value,\n    4: optional bool            nullable = false,\n    5: optional binary          comment,\n}\nstruct SchemaProp {\n    1: optional i64      ttl_duration,\n    2: optional binary   ttl_col,\n    3: optional binary   comment,\n}\nstruct Schema {\n    1: list&lt;ColumnDef&gt; columns,\n    2: SchemaProp schema_prop,\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#schema-provider","title":"Schema Provider","text":"<p><code>SchemaProvider</code> \u662f\u5185\u5b58\u4e2d\u7684 schema \u8868\u793a\uff0c\u63d0\u4f9b\u5b57\u6bb5\u67e5\u8be2\u3001\u504f\u79fb\u8ba1\u7b97\u7b49\u529f\u80fd\uff0c\u662f\u5bf9\u6570\u636e\u7f16\u89e3\u7801\u7684\u6838\u5fc3\u4f9d\u8d56</p> <ul> <li>\u5b9e\u9645\u4e0a\uff0cSchema \u5728 graphd \u4e2d\u901a\u8fc7 <code>SchemaProvider</code> \u7ba1\u7406 field</li> </ul> C++<pre><code>class NebulaSchemaProvider {\n private:\n  SchemaVer ver_;  // Schema \u7248\u672c\u53f7\n  // \u5b57\u6bb5\u6620\u5c04: \u5b57\u6bb5\u540d -&gt; \u5b57\u6bb5\u7d22\u5f15\n  std::unordered_map&lt;std::string, int64_t&gt; fieldNameIndex_;\n  // \u5b57\u6bb5\u6570\u7ec4,\u6309\u987a\u5e8f\u5b58\u50a8\u6240\u6709\u5b57\u6bb5\n  std::vector&lt;SchemaField&gt; fields_;\n  // \u53ef\u7a7a\u5b57\u6bb5\u6570\u91cf\n  size_t numNullableFields_;\n  // Vector \u5b57\u6bb5\u76f8\u5173\n  std::unordered_map&lt;std::string, int64_t&gt; vectorFieldNameIndex_;\n  std::vector&lt;SchemaField&gt; vector_fields_;\n  size_t numVectorNullableFields_;\n  // Schema \u5c5e\u6027 (TTL\u7b49)\n  cpp2::SchemaProp schemaProp_;\n};\n</code></pre> <ul> <li>field \u7531 <code>SchemaField</code> \u8868\u793a</li> </ul> C++<pre><code>class SchemaField {\n  std::string name_;           // \u5b57\u6bb5\u540d\n  PropertyType type_;          // \u6570\u636e\u7c7b\u578b\n  bool nullable_;              // \u662f\u5426\u53ef\u7a7a\n  bool hasDefault_;            // \u662f\u5426\u6709\u9ed8\u8ba4\u503c\n  std::string defaultValue_;   // \u9ed8\u8ba4\u503c\n  size_t size_;                // \u56fa\u5b9a\u5927\u5c0f(\u5b57\u8282)\n  size_t offset_;              // \u5728\u884c\u4e2d\u7684\u504f\u79fb\u91cf\n  size_t nullFlagPos_;         // NULL \u6807\u5fd7\u4f4d\u4f4d\u7f6e\n  cpp2::GeoShape geoShape_;    // \u5730\u7406\u7c7b\u578b\u5f62\u72b6\n};\n</code></pre> <p>\u4e3a\u4e86\u4fdd\u8bc1\u517c\u5bb9\u6027\uff0c\u9700\u8981\u5bf9 thrift \u6587\u4ef6\u6700\u5c0f\u5316\u4fee\u6539\uff0c\u6211\u4eec\u91c7\u7528\u4e86\u539f\u59cb\u5217\u548c\u5411\u91cf\u5217\u903b\u8f91\u4e0a\u5206\u79bb\u7684\u8bbe\u8ba1\uff1a</p> <ul> <li>\u539f\u59cb\u5217\uff08\u9664 VECTOR \u7c7b\u578b\u5916\u7684\u5176\u4ed6\u7c7b\u578b\uff09</li> <li>\u5411\u91cf\u5217\uff08\u4ec5\u9002\u7528\u4e8e VECTOR \u7c7b\u578b\uff09</li> <li>\u67b6\u6784\u5c5e\u6027\u9009\u9879\uff08TTL\u3001TTL_COL \u7b49\uff09</li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#why-design-like-this","title":"Why Design Like This?","text":"<ul> <li>\u53ef\u4ee5\u517c\u5bb9\u5df2\u6709\u7684 Schema \u8bbe\u8ba1\uff0c\u6700\u5c0f\u5316\u5bf9\u73b0\u6709\u4ee3\u7801\u7684\u6539\u52a8</li> <li>\u540e\u7eed\u6211\u4eec\u4f9d\u636e Schema \u8fdb\u884c\u6570\u636e\u8bfb\u53d6\u548c\u5199\u5165\u65f6\uff0c\u53ef\u4ee5\u6839\u636e\u5c5e\u6027\u7c7b\u578b\u533a\u5206\u539f\u59cb\u5217\u548c\u5411\u91cf\u5217\uff0c\u903b\u8f91\u66f4\u6e05\u6670</li> <li>\u5bf9\u540e\u7eed\u5411\u91cf\u7d22\u5f15\u7684\u521b\u5efa\u548c ann search\uff0c\u53ef\u4ee5\u66f4\u65b9\u4fbf\u5730\u5b9a\u4f4d\u5411\u91cf\u5c5e\u6027</li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#dml","title":"DML \u9002\u914d","text":"","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#dml-syntax","title":"DML Syntax","text":"","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#insert-vertex-sentence-for-vector-type","title":"Insert Vertex Sentence For Vector Type","text":"Cypher<pre><code>INSERT VERTEX tag1(id, vec1, vec2) VALUES 'v5':(5, vector (0.4, 0.5, 0.6), vector (0.1, 0.2, 0.3, 0.4)), 'v6':(6, vector (0.7, 0.8, 0.9), vector (0.2, 0.4, 0.6, 0.8));\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#delete-vertex-sentence-for-vector-type","title":"Delete Vertex Sentence For Vector Type","text":"Cypher<pre><code>Delete VERTEX on tag1 \"v5\" [with edge]\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#update-vertex-sentence-for-vector-type","title":"Update Vertex Sentence For Vector Type","text":"Cypher<pre><code>UPDATE VERTEX on tag1 'v5', 'v6' SET vec1 = vector (0.1, 0.2, 0.3), vec2 = vector (0.4, 0.5, 0.6, 0.7);\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#dml-processing","title":"DML Processing","text":"<p>\u6211\u4eec\u5148\u4ece\u6574\u4e2a\u6d41\u7a0b\u4e0a\u770b\u6211\u4eec\u6574\u4e2a Insert Vertex \u8bed\u53e5\u7684\u5904\u7406\u8fc7\u7a0b\uff1a</p> <ul> <li>\u5ba2\u6237\u7aef INSERT \u8bed\u53e5\u4f20\u5165 Graph \u5c42</li> <li>Graph \u5c42\u8fdb\u884c\u8bed\u6cd5\u89e3\u6790\u3001\u8bed\u4e49\u6821\u9a8c\u3001\u6267\u884c\u8ba1\u5212\u751f\u6210\u5e76\u6267\u884c <code>InsertVerticesExecutor</code>\uff0c\u8be5\u5904\u7406\u5668\u4f1a\u5c06\u6570\u636e\u6253\u5305\u6210 <code>AddVerticesRequest</code> \u8bf7\u6c42\u53d1\u9001\u5230 Storage \u5c42</li> <li>Storage \u5c42\u63a5\u6536\u5230\u8bf7\u6c42\u540e\uff0c\u6267\u884c <code>AddVerticesProcessor</code></li> <li>\u83b7\u53d6 Schema \u4fe1\u606f</li> <li>\u5206\u79bb\u5c5e\u6027\uff1aRegular vs Vector</li> <li>\u5bf9\u4e24\u79cd\u5c5e\u6027\u5206\u522b\u7f16\u7801\uff1a<ul> <li>Regular \u5c5e\u6027\u4f7f\u7528 RowWriterV2 \u7684\u5e38\u89c4\u6a21\u5f0f\u7f16\u7801</li> <li>Vector \u5c5e\u6027\u4f7f\u7528 RowWriterV2 \u7684 Vector \u6a21\u5f0f\u7f16\u7801</li> </ul> </li> <li>\u751f\u6210\u4e0d\u540c\u7684 Key-Value \u5bf9\uff1a<ul> <li>Regular: tagKey \u2192 regularData</li> <li>Vector: vectorTagKey \u2192 vectorData</li> </ul> </li> <li>\u6279\u91cf\u5199\u5165 RocksDB</li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#1-get-schema-from-meta-service","title":"1. Get Schema From Meta Service","text":"<p>\u4f20\u5165\u7684 <code>env</code> \u4e2d\u7684 <code>SchemaManager</code> \u7ef4\u62a4 schema \u7f13\u5b58\uff0c\u8be5\u7f13\u5b58\u4f1a\u5b9a\u671f\u4ece Meta \u670d\u52a1\u62c9\u53d6\u6700\u65b0\u7684 schema \u4fe1\u606f\uff0c\u4fdd\u8bc1 Storage \u5c42\u83b7\u53d6\u5230\u6700\u65b0\u7684 schema\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#how-it-works","title":"How It Works?","text":"<ul> <li> <p>Storaged \u62e5\u6709 meta \u5ba2\u6237\u7aef\uff0c\u5f53 meta service \u51c6\u5907\u5c31\u7eea\u65f6\uff0cstoraged \u5c06\u4ece metad \u83b7\u53d6\u5e8f\u5217\u5316\u540e\u7684 schema \u6570\u636e\u3002</p> </li> <li> <p>\u83b7\u53d6\u5230 schema \u540e\uff0cstorage service \u4e2d\u7684 meta client \u4f1a\u89e3\u6790\u4f20\u6765\u7684\u6570\u636e\u5e76\u91cd\u7ec4\u6210 <code>NebulaSchemaProvider</code> \u4f9b storage service \u540e\u7eed\u4f7f\u7528\u3002</p> </li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#2-encode-regular-vector-properties-separately","title":"2. Encode Regular &amp; Vector Properties Separately","text":"<p>\u6211\u4eec\u9700\u8981\u5bf9 Regular \u5c5e\u6027\u548c Vector \u5c5e\u6027\u5206\u522b\u7f16\u7801\uff0c\u5b9e\u9645\u4e0a\u8fd9\u662f\u7531 <code>RowWriterV2</code> \u6765\u5904\u7406\u7684</p> <ul> <li>Regular \u5c5e\u6027\u7f16\u7801\u65f6\uff0c<code>RowWriterV2</code> \u4ee5\u5e38\u89c4\u6a21\u5f0f\u5de5\u4f5c\uff0c\u76f4\u63a5\u83b7\u53d6\u6240\u6709 Regular \u5c5e\u6027\u5e76\u7f16\u7801\u5230\u540c\u4e00\u4e2a rowstr \u4e2d\u3002</li> <li>Vector \u5c5e\u6027\u7f16\u7801\u65f6\uff0c<code>RowWriterV2</code> \u4ee5 Vector \u6a21\u5f0f\u5de5\u4f5c\uff0c\u6bcf\u4e2a Vector \u5c5e\u6027\u5355\u72ec\u7f16\u7801\u6210\u4e00\u4e2a rowstr\uff0c\u901a\u8fc7\u4f20\u5165\u7684 <code>index</code> \u6765\u83b7\u53d6\u4e0d\u540c\u7684 Vector \u5c5e\u6027\u3002</li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#regular-encoding-code","title":"Regular Encoding Code","text":"<ul> <li>\u5206\u533a\u5e03\u5c40\uff1a\u4ee5 person(name:string, age:int, city:string) \u4e3a\u4f8b</li> </ul> Bash<pre><code>+--------+--------+-----------+--------------+---------------+-----------+\n| Header | Ver    | NullFlags | Fixed Data   | Variable Data | Timestamp |\n+--------+--------+-----------+--------------+---------------+-----------+\n| 1 byte | 0-7 B  | 0-N bytes | size  bytes  | \u53d8\u957f          | 8 bytes   |\n+--------+--------+-----------+--------------+---------------+-----------+\n\nFixed Data \u8be6\u7ec6\u5e03\u5c40:\n+----------------+----------------+----------------+\n| name (8 bytes) | age (8 bytes)  | city (8 bytes) |\n| [offset, len]  | [int64_t]      | [offset, len]  |\n+----------------+----------------+----------------+\n  \u2193                                  \u2193\n  \u6307\u5411 Variable Data                 \u6307\u5411 Variable Data\n\nVariable Data:\n+-------+-------+\n| Alice | Tokyo |\n+-------+-------+\n</code></pre> <ul> <li> <p>Regular \u5c5e\u6027\u7684\u7f16\u7801\u6211\u4eec\u6cbf\u7528\u4e4b\u524d\u7684\u903b\u8f91\u4e0d\u53d8\uff0c\u6240\u6709 Regular \u5c5e\u6027\u4f1a\u88ab\u7f16\u7801\u5230\u540c\u4e00\u4e2a rowstr \u4e2d\u3002</p> </li> <li> <p>\u5177\u4f53\u7f16\u7801\u8c03\u7528\u5982\u4e0b\uff1a<code>encodeRowVal()</code> -&gt; <code>RowWriterV2::setValue()</code> -&gt; <code>RowWriterV2::write()</code></p> </li> </ul> C++<pre><code>// BaseProcessor-inl.h - encodeRowVal()\nStatusOr&lt;std::string&gt; encodeRowVal(\n    const meta::NebulaSchemaProvider* schema,\n    const std::vector&lt;std::string&gt;&amp; propNames,\n    const std::vector&lt;Value&gt;&amp; props,\n    WriteResult&amp; wRet) {\n\n  // \u521b\u5efa\u5e38\u89c4 RowWriterV2 (isVectorColumns=false)\n  RowWriterV2 rowWrite(schema);\n\n  // \u9010\u4e2a\u8bbe\u7f6e\u5b57\u6bb5\u503c\n  for (size_t i = 0; i &lt; propNames.size(); i++) {\n    wRet = rowWrite.setValue(propNames[i], props[i]);\n  }\n\n  // \u5b8c\u6210\u7f16\u7801\n  wRet = rowWrite.finish();\n\n  // \u8fd4\u56de\u7f16\u7801\u540e\u7684\u5b57\u7b26\u4e32\n  return std::move(rowWrite).moveEncodedStr();\n}\n</code></pre> <ul> <li> <p><code>RowWriterV2::write()</code> \u5bf9\u56fa\u5b9a\u957f\u5ea6\u5c5e\u6027\u548c\u53d8\u957f\u5c5e\u6027\u5206\u522b\u5904\u7406\uff0c\u6700\u7ec8\u751f\u6210 rowstr</p> </li> <li> <p>\u56fa\u5b9a\u957f\u5ea6\u5c5e\u6027\uff1a\u76f4\u63a5\u5728\u9884\u5206\u914d\u7684\u7f13\u51b2\u533a\u5199\u5165\u5e76\u901a\u8fc7 schema \u7684 <code>offset()</code> \u76f4\u63a5\u8ba1\u7b97\u4f4d\u7f6e</p> </li> <li>\u53d8\u957f\u5c5e\u6027\uff1a<ul> <li>\u95f4\u63a5\u5b58\u50a8\uff1a\u56fa\u5b9a\u533a\u57df\u53ea\u5b58 8 \u5b57\u8282\u7684 [offset, length]</li> <li>\u540e\u8ffd\u52a0\uff1a\u6240\u6709\u53d8\u957f\u6570\u636e\u6309\u987a\u5e8f\u8ffd\u52a0\u5230\u672b\u5c3e</li> </ul> </li> </ul> C++<pre><code>// \u5199\u5165 INT64 \u793a\u4f8b\nWriteResult RowWriterV2::write(ssize_t index, int64_t v) {\n  auto field = schema_-&gt;field(index);\n  auto offset = headerLen_ +           // Header + Version\n                numNullBytes_ +        // NULL \u6807\u5fd7\n                field-&gt;offset();       // \u5b57\u6bb5\u5728\u56fa\u5b9a\u533a\u57df\u7684\u504f\u79fb\n  // 3. \u539f\u5730\u5199\u5165\uff08in-place\uff09\n  memcpy(&amp;buf_[offset], &amp;v, sizeof(int64_t));\n  // 4. \u6e05\u9664 NULL \u6807\u5fd7\n  if (field-&gt;nullable()) {\n    clearNullBit(field-&gt;nullFlagPos());\n  }\n  isSet_[index] = true;\n  return WriteResult::SUCCEEDED;\n}\n\nWriteResult RowWriterV2::write(ssize_t index, const std::string&amp; v) {\n  auto field = schema_-&gt;field(index);\n  // 1. \u8ba1\u7b97\u56fa\u5b9a\u533a\u57df\u7684\u504f\u79fb\uff08\u5b58\u50a8 offset + length\uff09\n  auto fixedOffset = headerLen_ + numNullBytes_ + field-&gt;offset();\n  // 2. \u5b57\u7b26\u4e32\u5b9e\u9645\u5b58\u50a8\u5728\u7f13\u51b2\u533a\u672b\u5c3e\n  int32_t strOffset = buf_.size();\n  int32_t strLen = v.size();\n  // 3. \u5728\u56fa\u5b9a\u533a\u57df\u5199\u5165\"\u6307\u9488\"\n  memcpy(&amp;buf_[fixedOffset], &amp;strOffset, sizeof(int32_t));\n  memcpy(&amp;buf_[fixedOffset + 4], &amp;strLen, sizeof(int32_t));\n  // 4. \u8ffd\u52a0\u5b9e\u9645\u6570\u636e\n  buf_.append(v.data(), v.size());\n  if (field-&gt;nullable()) {\n    clearNullBit(field-&gt;nullFlagPos());\n  }\n  isSet_[index] = true;\n  return WriteResult::SUCCEEDED;\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#vector-key-design","title":"Vector Key Design","text":"<ul> <li> <p>\u5728 <code>Type</code> \u4e2d\u65b0\u589e <code>VECTOR</code> \u7c7b\u578b\uff0c\u4fbf\u4e8e\u540e\u9762\u76f4\u63a5\u6839\u636e rowstr \u7684\u7b2c\u4e00\u5b57\u8282\u5224\u65ad\u5199\u5165 RocksDB \u7684\u54ea\u4e2a CF\u3002</p> </li> <li> <p>\u589e\u52a0 <code>PropId</code> \u6765\u533a\u5206\u4e0d\u540c\u7684 Vector \u5c5e\u6027\u3002</p> </li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#vector-encoding-code","title":"Vector Encoding Code","text":"<ul> <li> <p>\u4e0e\u53d8\u957f\u5c5e\u6027\u5904\u7406\u7c7b\u4f3c\uff0cVector \u5c5e\u6027\u5728 rowstr \u4e2d\u4e5f\u91c7\u7528\u95f4\u63a5\u5b58\u50a8\u7684\u65b9\u5f0f\uff1a</p> </li> <li> <p>\u56fa\u5b9a\u533a\u57df\u5b58\u50a8 8 \u5b57\u8282\u7684 [offset, length]</p> </li> <li>\u5b9e\u9645\u7684\u5411\u91cf\u6570\u636e\u8ffd\u52a0\u5230 rowstr \u7684\u672b\u5c3e</li> </ul> Bash<pre><code>+--------+--------+-----------+--------------+---------------+-----------+\n| Header | Ver    | NullFlag  | Offset + Len | Vector Data   | Timestamp |\n+--------+--------+-----------+--------------+---------------+-----------+\n| 1 byte | 0-7 B  | 0-1 byte  | 8 bytes      | \u53d8\u957f(N*4 B)   | 8 bytes   |\n+--------+--------+-----------+--------------+---------------+-----------+\n\n\u793a\u4f8b\uff1a128 \u7ef4\u5411\u91cf\n+-----------+------------------+-----------------------------+\n| [offset]  | [length]         | [f1, f2, ..., f128]        |\n| (4 bytes) | (4 bytes)        | (128 * 4 = 512 bytes)      |\n+-----------+------------------+-----------------------------+\n    \u2193             \u2193                      \u2193\n  \u6307\u5411\u6570\u636e      \u6570\u636e\u957f\u5ea6            \u539f\u59cb float \u6570\u7ec4\n</code></pre> <ul> <li>Vector \u5c5e\u6027\u7684\u7f16\u7801\u6211\u4eec\u65b0\u589e\u4e86\u4e00\u5957\u903b\u8f91\uff0c\u6bcf\u4e2a Vector \u5c5e\u6027\u4f1a\u88ab\u5355\u72ec\u7f16\u7801\u6210\u4e00\u4e2a rowstr\u3002</li> </ul> C++<pre><code>bool vectorPropNamesEmpty = vectorPropNames_.empty();\n\n// \u904d\u5386\u6bcf\u4e2a Vector \u5c5e\u6027\nfor (size_t i = 0; i &lt; vectorProps_.size(); ++i) {\n  // \u83b7\u53d6 vector \u5b57\u6bb5\u7d22\u5f15\n  int64_t vectorFieldIndex = vectorPropNamesEmpty\n      ? static_cast&lt;int64_t&gt;(i)\n      : schema-&gt;getVectorFieldIndex(vectorPropNames_[i]);\n\n  // \u751f\u6210 Vector \u4e13\u7528 Key\n  auto vectorKey = NebulaKeyUtils::vectorTagKey(\n      spaceVidLen_, partId, vid, tagId,\n      static_cast&lt;int32_t&gt;(vectorFieldIndex));\n\n  // \u7f16\u7801 Vector \u503c\n  auto vectorValue = encodeVectorRowVal(\n      schema, vectorProps_[i],\n      static_cast&lt;size_t&gt;(vectorFieldIndex), wRet);\n\n  // \u5b58\u50a8\n  data.emplace_back(std::move(vectorKey), std::move(vectorValue.value()));\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#3-write-to-rocksdb","title":"3. Write to RocksDB","text":"<p>\u5b8c\u6574\u7684\u901a\u8fc7 raft-wal \u5199\u5165 RocksDB \u6d41\u7a0b\u5982\u4e0b\u56fe\uff1a</p> <ul> <li>\u4e3a\u4e86\u786e\u4fdd DML \u64cd\u4f5c\u7684\u4e00\u81f4\u6027\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u4ec5\u4f7f\u7528\u4e00\u4e2a <code>MergeableAtomicOp</code> \u5f02\u6b65\u64cd\u4f5c <p>\u4e00\u4e2a INSERT/UPDATE/DELETE \u8bf7\u6c42\u5bf9\u5e94\u4e00\u4e2a\u539f\u5b50\u64cd\u4f5c\u5355\u5143</p> </li> <li>\u5199\u5165\u771f\u6b63\u7684\u6267\u884c\u5728 Raft commitLog</li> </ul> <p></p> <ul> <li>\u5b9e\u9645\u4e0a\u771f\u6b63\u5199\u5165\u7684\u65f6\u5019\uff0c\u6211\u4eec\u901a\u8fc7 Key \u7684 <code>type</code> \u5b57\u6bb5\u533a\u5206 Regular \u548c Vector \u6570\u636e\uff0c\u5199\u5165\u4e0d\u540c\u7684 Column Family <p>\u4ee5 batch \u5199\u5165\u4e3a\u4f8b\uff1a</p> </li> </ul> C++<pre><code>case OP_BATCH_WRITE: {\n    auto data = decodeBatchValue(log);\n    for (auto&amp; op : data) {\n        if (op.first == BatchLogType::OP_BATCH_PUT) {\n            if (NebulaKeyUtils::isVector(op.second.first.str())) {\n                // Vector \u6570\u636e\u5199\u5165\u4e13\u7528 Column Family\n                code = batch-&gt;put(\n                    NebulaKeyUtils::kVectorColumnFamilyName,\n                    op.second.first,\n                    op.second.second\n                );\n            } else {\n                code = batch-&gt;put(op.second.first, op.second.second);\n            }\n        }\n        // ... \u5176\u4ed6\u64cd\u4f5c\u7c7b\u578b\n    }\n    break;\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#update-special-processing","title":"Update Special Processing","text":"<p>Update \u8bed\u53e5\u5728 Storage \u5c42\u7684\u5904\u7406\uff0c\u76f8\u6bd4 Insert \u8bed\u53e5\u6709\u4e00\u4e9b\u7279\u6b8a\u4e4b\u5904\uff1a</p> <ul> <li>Update \u5728 Storage \u5c42\u751f\u6210\u7684\u8ba1\u5212\u6811\u5305\u542b <code>TagNode</code> \u8282\u70b9\uff0c\u8be5\u8282\u70b9\u8d1f\u8d23\u8bfb\u53d6\u5f53\u524d\u9876\u70b9\u7684\u5c5e\u6027\u503c</li> <li>\u4e3a\u4e86\u652f\u6301 Vector \u5c5e\u6027\uff0c\u6211\u4eec\u9700\u8981\u786e\u4fdd <code>TagNode</code> \u80fd\u6b63\u786e\u8bfb\u53d6\u591a\u4e2a Vector \u5c5e\u6027</li> </ul> <p></p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#_1","title":"\u5b8c\u6574\u6d41\u7a0b","text":"Bash<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. TagNode::doExecute(partId, vId)                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   \u2022 \u8bfb\u53d6\u5e38\u89c4 Tag \u6570\u636e: tagKey -&gt; value_                       \u2502\n\u2502   \u2022 \u68c0\u67e5 Schema \u662f\u5426\u5305\u542b Vector \u5b57\u6bb5                          \u2502\n\u2502   \u2022 \u904d\u5386\u6240\u6709\u5c5e\u6027,\u7b5b\u9009\u51fa Vector \u7c7b\u578b                           \u2502\n\u2502   \u2022 \u4e3a\u6bcf\u4e2a Vector \u5c5e\u6027:                                       \u2502\n\u2502     - \u83b7\u53d6\u5b57\u6bb5\u7d22\u5f15: getVectorFieldIndex(propName)             \u2502\n\u2502     - \u6784\u9020 Vector Key: vectorTagKey(vId, tagId, index)        \u2502\n\u2502     - \u8bfb\u53d6 Vector \u6570\u636e: kvstore_-&gt;get() -&gt; vectorValues_      \u2502\n\u2502   \u2022 \u521d\u59cb\u5316 RowReader:                                         \u2502\n\u2502     - reader_.reset(*schemas_, value_)                        \u2502\n\u2502     - vectorReaders_[i].reset(*schemas_, vectorValues_[i], true, index) \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2. FilterNode::doExecute()                                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   \u2022 \u68c0\u67e5\u8fc7\u6ee4\u6761\u4ef6                                              \u2502\n\u2502   \u2022 \u4f20\u9012 reader_ \u548c vectorReaders_ \u7ed9\u4e0b\u6e38                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 3. UpdateTagNode::doExecute()                                  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   \u2022 \u83b7\u53d6\u4e0a\u6e38\u7684 reader_ \u548c vectorReaders_                      \u2502\n\u2502   \u2022 collTagProp():                                             \u2502\n\u2502     - \u4ece reader_ \u8bfb\u53d6\u5e38\u89c4\u5c5e\u6027                                 \u2502\n\u2502     - \u4ece vectorReaders_[i] \u8bfb\u53d6 Vector \u5c5e\u6027                   \u2502\n\u2502     - \u6240\u6709\u5c5e\u6027\u7edf\u4e00\u5b58\u50a8\u5230 props_                               \u2502\n\u2502   \u2022 updateAndWriteBack():                                      \u2502\n\u2502     - \u8ba1\u7b97\u66f4\u65b0\u8868\u8fbe\u5f0f,\u66f4\u65b0 props_                              \u2502\n\u2502     - \u533a\u5206\u5199\u5165:                                               \u2502\n\u2502       * \u5e38\u89c4\u5c5e\u6027 -&gt; rowWriter_-&gt;setValue()                    \u2502\n\u2502       * Vector \u5c5e\u6027 -&gt; vectorRowWriters_[index]-&gt;setValueVec()\u2502\n\u2502     - \u5b8c\u6210\u7f16\u7801:                                               \u2502\n\u2502       * rowWriter_-&gt;finish() -&gt; nVal                          \u2502\n\u2502       * vectorRowWriters_[i]-&gt;finishVector() -&gt; vectorVals[i] \u2502\n\u2502     - \u6279\u91cf\u5199\u5165:                                               \u2502\n\u2502       * batchHolder-&gt;put(key_, nVal)                          \u2502\n\u2502       * batchHolder-&gt;put(vectorKeys_[i], vectorVals[i])       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 4. UpdateResNode::doExecute()                                  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502   \u2022 \u6839\u636e returnPropsExp_ \u63d0\u53d6\u8fd4\u56de\u5c5e\u6027                         \u2502\n\u2502   \u2022 \u6784\u9020 DataSet \u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#tagnode","title":"TagNode","text":"<ul> <li>\u72ec\u7acb\u8bfb\u53d6 Vector \u6570\u636e\u5230 <code>vectorValues_</code></li> <li>\u6211\u4eec\u5b9e\u9645\u4e0a\u4e3a\u4e86\u652f\u6301\u591a Vector \u5c5e\u6027\u7684\u8bfb\u53d6\uff0c\u65b0\u589e\u4e86 <code>vectorReaders_</code> \u6210\u5458\u53d8\u91cf\u6765\u5b58\u50a8\u591a\u4e2a Vector Reader <p>\u6bcf\u4e2a Vector \u5c5e\u6027\u5bf9\u5e94\u4e00\u4e2a Reader Vector \u5c5e\u6027\u521d\u59cb\u5316\u9700\u8981\u4f20\u5165 Vector \u6240\u5728\u7684\u7d22\u5f15</p> </li> </ul> C++<pre><code>// \u4e00\u4e2a\u4e3b Reader,N \u4e2a Vector Reader\nRowReaderWrapper reader_;                     // \u8bfb\u53d6\u5e38\u89c4\u5c5e\u6027\nstd::vector&lt;RowReaderWrapper&gt; vectorReaders_; // \u8bfb\u53d6 Vector \u5c5e\u6027\n\n// \u521d\u59cb\u5316\u65b9\u5f0f\u4e0d\u540c\nreader_.reset(*schemas_, value_);           // \u5e38\u89c4\u6a21\u5f0f\nvectorReaders_[i].reset(*schemas_, vecVal, true, idx); // Vector \u6a21\u5f0f\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#updatetagnode","title":"UpdateTagNode","text":"<ul> <li>\u4ece\u591a\u4e2a Vector Reader \u6536\u96c6\u6240\u6709\u5c5e\u6027</li> <li>\u5e38\u89c4\u5c5e\u6027\u4ece <code>reader_</code> \u8bfb\u53d6</li> <li>Vector \u5c5e\u6027\u4ece <code>vectorReaders_</code> \u8bfb\u53d6</li> <li>\u7edf\u4e00\u5230 <code>props_map</code> \u8fdb\u884c\u8868\u8fbe\u5f0f\u8ba1\u7b97</li> <li>\u4f7f\u7528\u591a\u4e2a <code>vectorRowWriters_</code> \u7f16\u7801\u56de\u5199</li> </ul> C++<pre><code>// 1. \u6536\u96c6\u5e38\u89c4\u5c5e\u6027\nfor (auto index = 0UL; index &lt; schema_-&gt;getNumFields(); index++) {\n    auto propName = std::string(schema_-&gt;getFieldName(index));\n    auto retVal = QueryUtils::readValue(reader_, propName, schema_);\n    if (!retVal.ok()) {\n      return nebula::cpp2::ErrorCode::E_TAG_PROP_NOT_FOUND;\n    }\n    props_[propName] = std::move(retVal.value());\n  }\n\n// 2. \u6536\u96c6 Vector \u5c5e\u6027\nfor (auto index = 0UL; index &lt; schema_-&gt;getVectorNumFields(); index++) {\n  auto vecPropName = std::string(schema_-&gt;getVectorFieldName(index));\n\n  auto retVal = QueryUtils::readVectorValue(vectorReaders_[index], vecPropName, schema_);\n  if (!retVal.ok()) {\n    return nebula::cpp2::ErrorCode::E_TAG_PROP_NOT_FOUND;\n  }\n  props_[vecPropName] = std::move(retVal.value());\n}\n\n// 3. \u521d\u59cb\u5316 Regular \u5c5e\u6027\u7684 RowWriter\nrowWriter_ = std::make_unique&lt;RowWriterV2&gt;(schema_);\nval_ = reader_-&gt;getData();\n\n// 4. \u4e3a\u6bcf\u4e2a Vector \u5c5e\u6027\u521b\u5efa\u72ec\u7acb\u7684 RowWriter\nfor (auto index = 0UL; index &lt; schema_-&gt;getVectorNumFields(); index++) {\n  vectorVals_.emplace_back(vectorReaders_[index]-&gt;getData());\n  vectorRowWriters_.emplace_back(\n      std::make_unique&lt;RowWriterV2&gt;(schema_, true, static_cast&lt;int32_t&gt;(index))\n  );\n}\n</code></pre>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#_2","title":"\u8e29\u8fc7\u7684\u5751","text":"<p>\u5728\u5b9e\u73b0\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u4e5f\u9047\u5230\u4e86\u4e00\u4e9b\u8bbe\u8ba1\u4e0a\u7684\u6311\u6218\u548c\u5751\uff0c\u4e0b\u9762\u5217\u4e3e\u51e0\u4e2a\u5178\u578b\u7684\u4f8b\u5b50\uff1a</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#1-parser-vector","title":"1. Parser \u5bf9 Vector \u8bed\u6cd5\u7684\u652f\u6301","text":"<p>v1: \u6700\u521d\u6211\u5c1d\u8bd5\u76f4\u63a5\u4f7f\u7528 <code>[1.0, 2.0, 3.0]</code> \u6765\u8868\u793a\u5411\u91cf\u503c\uff0c\u4f46\u53d1\u73b0\u8fd9\u6837\u4f1a\u4e0e<code>list</code>\u7c7b\u578b\u4ea7\u751f\u4e8c\u4e49\u6027\uff0c\u5bfc\u81f4\u8fdb\u884c tck \u6d4b\u8bd5\u65f6\u5bf9 <code>list</code> \u7c7b\u578b\u7684\u590d\u6742\u67e5\u8be2\u51fa\u73b0\u89e3\u6790\u9519\u8bef\u3002</p> <p>v2: \u540e\u6765\u6211\u5c1d\u8bd5\u4f7f\u7528 <code>(1.0;2.0;3.0)</code> \u7684\u8bed\u6cd5\uff0c\u4f46\u8fd9\u79cd\u65b9\u5f0f\u4f1a\u4e0e\u8ba1\u7b97\u8868\u8fbe\u5f0f\u4e2d\u7684\u62ec\u53f7\u51b2\u7a81\uff0c\u5bfc\u81f4\u89e3\u6790\u5668\u65e0\u6cd5\u6b63\u786e\u8bc6\u522b\u3002</p> <p>v3: \u540e\u6765\u7ecf\u8fc7\u548c mentor \u7684\u8ba8\u8bba\uff0c\u6700\u7ec8\u6211\u4eec\u8bbe\u8ba1\u4e86 <code>vector(1.0,2.0,3.0)</code> \u7684\u8bed\u6cd5\uff0c\u907f\u514d\u4e86\u4e0a\u9762\u7684\u89e3\u6790\u51b2\u7a81\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#2-schema","title":"2. Schema \u8bbe\u8ba1\u7684\u517c\u5bb9\u6027","text":"<p>v1: \u6700\u521d\u6211\u5c1d\u8bd5\u76f4\u63a5\u5728 <code>ColumnTypeDef</code> \u4e2d\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u5b57\u6bb5\u6765\u8868\u793a Vector \u7684\u7ef4\u5ea6\uff0c\u4f46\u8fd9\u6837\u4f1a\u5bfc\u81f4\u5bf9\u73b0\u6709\u4ee3\u7801\u7684\u6539\u52a8\u8fc7\u5927\uff0c\u5f71\u54cd\u4e86\u7cfb\u7edf\u7684\u7a33\u5b9a\u6027\u3002 v2: \u540e\u6765\u6211\u5c1d\u8bd5\u5c06 Vector \u5c5e\u6027\u548c Regular \u5c5e\u6027\u6df7\u5408\u5b58\u50a8\u5728\u540c\u4e00\u4e2a\u5b57\u6bb5\u5217\u8868\u4e2d\uff0c\u4f46\u8fd9\u6837\u4f1a\u5bfc\u81f4\u5728\u6570\u636e\u8bfb\u53d6\u548c\u5199\u5165\u65f6\u96be\u4ee5\u533a\u5206\u4e0d\u540c\u7c7b\u578b\u7684\u5c5e\u6027\uff0c\u589e\u52a0\u4e86\u5b9e\u73b0\u7684\u590d\u6742\u5ea6\u3002\u800c\u4e14\u4e5f\u4f1a\u5f71\u54cd\u540e\u9762\u5411\u91cf\u7d22\u5f15\u7684\u521b\u5efa\u548c\u67e5\u8be2\u3002 v3: \u6700\u7ec8\u6211\u4eec\u91c7\u7528\u4e86\u5c06 Vector \u5c5e\u6027\u548c Regular \u5c5e\u6027\u903b\u8f91\u4e0a\u5206\u79bb\u7684\u8bbe\u8ba1</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#3-dml","title":"3. DML \u5904\u7406\u4e2d\u7684\u591a\u5c5e\u6027\u652f\u6301","text":"<p>v1: \u6700\u521d\u6211\u7684\u60f3\u6cd5\u662f\u5c06 Regular \u548c Vector \u5c5e\u6027\u5199\u5165\u5206\u4e3a\u4e24\u4e2a\u539f\u5b50\u64cd\u4f5c\uff0c\u4f46\u662f\u8fd9\u6837\u4f1a\u7834\u574f\u64cd\u4f5c\u7684\u539f\u5b50\u6027 v2: \u540e\u9762\u6211\u5c1d\u8bd5\u5728 RowWriter \u548c RowReader \u4e2d\u5bf9\u4e0d\u540c\u7c7b\u578b\u5c5e\u6027\u8fdb\u884c\u5904\u7406\uff0c\u4f46\u662f\u5bf9 RocksEngine\uff0cbatch \u7b49\u5b58\u50a8\u5c42\u63a5\u53e3\u6539\u52a8\u8fc7\u5927\uff0c\u589e\u52a0\u5b9e\u73b0\u7684\u590d\u6742\u5ea6 v3: \u6700\u7ec8\u6211\u4eec\u901a\u8fc7\u5728 Key \u4e2d\u533a\u5206\u4e0d\u540c\u7c7b\u578b\u5c5e\u6027\uff0c\u5e76\u5728\u5199\u5165\u65f6\u6839\u636e\u7c7b\u578b\u9009\u62e9\u4e0d\u540c\u7684 Column Family\uff0c\u65e2\u4fdd\u8bc1\u4e86\u64cd\u4f5c\u7684\u539f\u5b50\u6027\uff0c\u53c8\u7b80\u5316\u4e86\u5b58\u50a8\u5c42\u7684\u5b9e\u73b0\u3002</p> <p>\u6211\u4eec\u53ea\u9700\u8981\u5728 <code>RaftPart::commitLogs()</code> \u4e2d\u6839\u636e Key \u7684\u7c7b\u578b\u9009\u62e9\u4e0d\u540c\u7684 CF \u5373\u53ef\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#4-update-vector","title":"4. Update \u8bed\u53e5\u4e2d\u591a Vector \u5c5e\u6027\u7684\u8bfb\u53d6\u548c\u5199\u5165","text":"<p>v1: \u6700\u521d\u6211\u7684\u60f3\u6cd5\u662f\u4e00\u4e2a filterNode \u53ef\u4ee5\u6709\u591a\u4e2a TagNode \u6765\u5206\u522b\u8bfb\u53d6\u4e0d\u540c\u7684 Vector \u5c5e\u6027\uff0c\u5b9e\u9645\u5b9e\u73b0\u65f6\u53d1\u73b0\u8fd9\u79cd\u65b9\u6848\u5b9e\u73b0\u590d\u6742\u5ea6\u8fc7\u9ad8\uff0c\u4e14\u4e0d\u6613\u7ef4\u62a4\u3002 v2: \u6700\u7ec8\u6211\u4eec\u9009\u62e9\u5728\u4e00\u4e2a TagNode \u4e2d\u8bfb\u53d6\u6240\u6709 Vector \u5c5e\u6027\uff0c\u5e76\u5728 UpdateTagNode \u4e2d\u7edf\u4e00\u5904\u7406\u6240\u6709\u5c5e\u6027\u7684\u66f4\u65b0\u548c\u5199\u5165\uff0c\u7b80\u5316\u4e86\u5b9e\u73b0\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#5-schema","title":"5. Schema \u7f13\u5b58\u7684\u4e00\u81f4\u6027\u95ee\u9898","text":"<p> \u5728\u6d4b\u8bd5\u4e2d\uff0c\u6211\u4eec\u53d1\u73b0 vector \u5c5e\u6027\u5728 Storage \u5c42\u8fdb\u884c\u64cd\u4f5c\u65f6\u4f1a\u5d29\u6e83\uff0c\u7ecf\u8fc7\u6392\u67e5\u53d1\u73b0\u662f\u56e0\u4e3a Storage \u5c42\u7684 Schema \u7f13\u5b58\u6ca1\u6709\u53ca\u65f6\u66f4\u65b0\uff0c\u5bfc\u81f4\u8bfb\u53d6\u5230\u7684 Schema \u4fe1\u606f\u4e0d\u4e00\u81f4\u3002</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a\u6211\u4eec\u786e\u4fdd Storage \u5c42\u7684 Schema \u7f13\u5b58\u53ef\u4ee5\u62c9\u53d6\u5230 vector \u7c7b\u578b\u7684\u5c5e\u6027\uff0c\u4fdd\u8bc1\u64cd\u4f5c\u65f6\u4f7f\u7528\u7684\u662f\u6700\u65b0\u7684 Schema\u3002</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#_3","title":"\u603b\u7ed3","text":"<p>\u73b0\u5728\u6211\u4eec\u6765\u56de\u7b54\u4e00\u4e0b\u5f00\u7bc7\u63d0\u51fa\u7684\u4e09\u4e2a\u95ee\u9898</p> <p> \u56de\u6536\u5f00\u5934</p>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#tagedge-schema-vector","title":"\u5982\u4f55\u5728\u5df2\u6709\u7684 Tag/Edge Schema \u4e2d\u6dfb\u52a0 Vector \u7c7b\u578b\u7684\u5c5e\u6027\uff1f","text":"<ul> <li>\u5728 DDL \u5c42\u6269\u5c55\u7c7b\u578b\u5b9a\u4e49\uff0c\u65b0\u589e VECTOR \u7c7b\u578b\u5e76\u4e14\u5728\u5b9a\u4e49\u65f6\u6307\u5b9a\u7ef4\u5ea6\uff08dimension\uff09\uff0c\u4f8b\u5982 vector(128)\u3002</li> <li>\u5728 schema \u7684\u5e8f\u5217\u5316\u7ed3\u6784\u4e2d\u590d\u7528\u73b0\u6709 <code>ColumnTypeDef</code> \u7684 <code>type_length</code> \u5b57\u6bb5\u8868\u793a Vector \u7684\u7ef4\u5ea6\uff08\u6700\u5c0f\u5316 Thrift \u6587\u4ef6\u6539\u52a8\uff09\u3002</li> <li>\u5728 meta\uff08Meta \u670d\u52a1\uff09\u4e2d\u4fdd\u5b58 schema \u7684\u5e8f\u5217\u5316\u8868\u793a\uff08<code>Key: SpaceId + TagId + Version\uff0cValue: Thrift \u5e8f\u5217\u5316\u7684 Schema</code>\uff09</li> <li>Storage \u4ece Meta \u62c9\u53d6\u8be5\u5e8f\u5217\u5316\u7ed3\u679c\u5e76\u6784\u5efa\u5185\u5b58 SchemaProvider\u3002</li> <li>\u5728\u5185\u5b58 SchemaProvider \u4e2d\u5bf9 Vector \u5b57\u6bb5\u5355\u72ec\u7ef4\u62a4\uff08\u4e0e\u5e38\u89c4\u5217\u903b\u8f91\u4e0a\u5206\u79bb\uff09\uff0c\u6bd4\u5982\u989d\u5916\u7684 <code>vectorFieldNameIndex_</code>\u3001<code>vector_fields_</code>\u3001<code>numVectorNullableFields_</code> \u7b49\u3002</li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#insertupdate-vector","title":"\u5982\u4f55\u5728 Insert/Update \u8bed\u53e5\u4e2d\u63d2\u5165\u548c\u66f4\u65b0 Vector \u7c7b\u578b\u7684\u5c5e\u6027\u503c\uff1f","text":"<ul> <li>\u5728 Parser/\u8bed\u4e49\u5c42\u52a0\u5165\u5bf9 vector \u5e38\u91cf\u7684\u652f\u6301\uff0c\u91c7\u7528\u4e13\u95e8\u8bed\u6cd5 <code>vector(0.1, 0.2, 0.3)</code> \u6765\u8868\u793a\u5411\u91cf\u5e38\u91cf\uff0c\u907f\u514d\u4e0e list \u7b49\u51b2\u7a81\u3002</li> <li>Graph \u5c42\u5728\u8bed\u4e49\u6821\u9a8c\u901a\u8fc7\u540e\u751f\u6210\u8bf7\u6c42\uff08\u4f8b\u5982 AddVerticesRequest / Update \u8bf7\u6c42\uff09\uff0c\u5c06 vector \u5c5e\u6027\u4e0e regular \u5c5e\u6027\u533a\u5206\u5e76\u6253\u5305\u5230\u8bf7\u6c42\u4e2d\u53d1\u9001\u7ed9 Storage \u5c42\u3002</li> <li>Storage \u5c42\u5904\u7406 DML \u65f6\uff0c\u5148\u4ece SchemaProvider \u83b7\u53d6 schema\uff0c\u7136\u540e\u201c\u5206\u79bb\u5c5e\u6027\u201d\uff1aRegular vs Vector\u3002</li> <li>Regular \u5c5e\u6027\u7edf\u4e00\u4f7f\u7528\u5df2\u6709\u7684 RowWriterV2 \u5e38\u89c4\u7f16\u7801\uff0c\u4e00\u4e2a rowstr \u5305\u542b\u6240\u6709 regular \u5b57\u6bb5\u3002</li> <li>\u6bcf\u4e2a Vector \u5c5e\u6027\u5355\u72ec\u4f7f\u7528 RowWriterV2 \u7684 Vector \u6a21\u5f0f\u7f16\u7801\uff08\u6bcf\u4e2a vector \u5c5e\u6027\u751f\u6210\u72ec\u7acb\u7684 rowstr\uff09\u3002</li> <li>Key \u8bbe\u8ba1\uff1a\u5bf9 Vector \u6570\u636e\u4f7f\u7528\u533a\u5206 type \u7684 Key\uff08\u5e76\u5e26\u4e0a PropId \u6216 vector field index\uff09\uff0c\u4ee5\u4fbf\u5199\u5165\u4e0d\u540c Column Family\uff08CF\uff09\u3002</li> <li>\u5199\u5165\uff1a\u5728\u7ec4\u88c5\u5199\u5165 Batch\uff08\u6216 Raft \u63d0\u4ea4\uff09\u65f6\uff0c\u6839\u636e Key \u5224\u65ad\u5199\u5165 CF\uff0c\u4fdd\u8bc1 Regular \u4e0e Vector \u6570\u636e\u53ef\u4ee5\u5728\u540c\u4e00\u539f\u5b50\u8bf7\u6c42\u4e2d\u5199\u5165\u4e0d\u540c CF\uff0c\u4ece\u800c\u4fdd\u6301\u64cd\u4f5c\u7684\u6574\u4f53\u539f\u5b50\u6027\uff08\u901a\u8fc7 raft-wal + batch\uff09\u3002</li> <li>\u66f4\u65b0\uff08UPDATE\uff09\uff1a</li> <li>Update \u7684\u8ba1\u5212\u4f1a\u8bfb\u53d6\u5f53\u524d regular row\uff08tagKey\uff09\u4ee5\u53ca\u6240\u6709 vector \u884c\uff08vectorTagKey\uff09\u2014\u2014TagNode \u8d1f\u8d23\u8bfb\u53d6\u5e38\u89c4\u548c vector \u6570\u636e\u5e76\u6784\u9020\u4e3b <code>reader_</code> \u4e0e\u591a\u4e2a <code>vectorReaders_</code>\u3002</li> <li>UpdateTagNode \u628a\u5e38\u89c4\u5b57\u6bb5\u4e0e\u591a\u4e2a vector \u5b57\u6bb5\u5408\u5e76\u5230 <code>props_map</code>\uff0c\u8ba1\u7b97\u8868\u8fbe\u5f0f\u540e\u5206\u522b\u7528 <code>rowWriter-&gt;setValue()</code> \u548c <code>vectorRowWriters[index]-&gt;setValueVec()</code> \u7f16\u7801\uff0c\u5e76\u4e00\u8d77 batch \u5199\u56de\uff08regular key + \u6240\u6709 vector keys\uff09\u3002</li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%B8%AD%E7%AF%87%EF%BC%9AVector%20%E7%B1%BB%E5%9E%8B%E7%9A%84%20DDL%26DML%20%E9%80%82%E9%85%8D/#storage-schema-vector","title":"\u5982\u4f55\u4fdd\u8bc1 Storage \u5c42\u83b7\u53d6\u6b63\u786e\u7684 Schema \u4fe1\u606f\uff0c\u5e76\u6b63\u786e\u5b58\u50a8\u548c\u8bfb\u53d6 Vector \u7c7b\u578b\u7684\u5c5e\u6027\u503c\uff1f","text":"<ul> <li>Schema \u5b58\u50a8\u4e0e\u4f20\u9012\uff1a</li> <li>Meta \u670d\u52a1\u4ee5 RocksDB \u5b58\u50a8 schema\uff08<code>Key: SpaceId + TagId + Version\uff1bValue: Thrift \u5e8f\u5217\u5316\u7684 Schema</code>\uff09\u3002</li> <li>Storage \u7aef\u6709 meta client\uff0c\u5b9a\u671f\u6216\u5728\u4e8b\u4ef6\u89e6\u53d1\u65f6\u4ece Meta \u62c9\u53d6\u5e8f\u5217\u5316\u7684 schema \u6570\u636e\uff0c\u7136\u540e\u89e3\u6790\u5e76\u91cd\u5efa\u4e3a NebulaSchemaProvider\uff08\u5185\u5b58\u8868\u793a\uff09\u3002</li> <li>SchemaProvider \u8bbe\u8ba1\uff1a</li> <li>\u5728\u5185\u5b58 SchemaProvider \u4e2d\u533a\u5206 regular \u5b57\u6bb5\u6570\u7ec4\u4e0e vector \u5b57\u6bb5\u6570\u7ec4\uff08<code>fieldNameIndex_</code> vs <code>vectorFieldNameIndex_</code>\uff09\u3002\u63d0\u4f9b\u65b9\u6cd5 <code>getFieldIndex</code>/<code>getVectorFieldIndex</code>\u3001<code>getNumFields</code>/<code>getVectorNumFields</code> \u7b49\u3002</li> <li>RowReader/RowWriter\uff1a</li> <li>Regular \u7684\u8bfb\u5199\u6cbf\u7528 RowReader/RowWriter \u65e2\u6709\u903b\u8f91\uff08\u5355\u4e2a rowstr\uff09\u3002</li> <li>Vector \u7684\u8bfb\u5199\u91c7\u7528 RowWriterV2 \u7684 Vector \u6a21\u5f0f\uff1a<ul> <li>\u56fa\u5b9a\u533a\u57df\u5b58\u653e [offset, length]\uff088 bytes\uff0c\u6216\u4e24\u4e2a 4-byte\uff09\uff0c\u5b9e\u9645 float \u6570\u7ec4\u8ffd\u52a0\u5728 rowstr \u5c3e\u90e8\uff08N * 4 bytes for float\uff09\u3002</li> </ul> </li> <li>\u6bcf\u4e2a vector \u5b57\u6bb5\u5bf9\u5e94\u5355\u72ec\u7684 rowstr\uff0c\u56e0\u6b64\u8bfb\u53d6\u65f6\u9700\u8981\u5355\u72ec\u53d1\u8d77 kv get\uff08\u4f7f\u7528 vectorKey\uff09\u3002</li> <li>TagNode\uff1a</li> <li>\u8bfb\u53d6\u6b63\u5e38 tagKey \u7684\u503c\u5e76\u521d\u59cb\u5316\u4e3b <code>reader_</code>\uff1b</li> <li>\u5982\u679c schema \u6709 vector \u5b57\u6bb5\uff0c\u9010\u4e2a\u6784\u9020 vectorKey \u5e76\u8bfb\u53d6\u5bf9\u5e94\u503c\uff0c\u521d\u59cb\u5316\u5bf9\u5e94\u7684 <code>vectorReaders_</code></li> </ul>","tags":["Database"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/","title":"\u4ece\u4ee3\u7801\u770b SGLang \u7684 KV Cache","text":"2025-11-022025-12-13 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#sglang-kv-cache","title":"\u4ece\u4ee3\u7801\u770b SGLang \u7684 KV Cache","text":"<p> \u7ea6 1092 \u4e2a\u5b57  49 \u884c\u4ee3\u7801  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> <p>\u5efa\u8bae\u9605\u8bfb SGLang Scheduler \u6280\u672f\u53d8\u8fc1\u540e\u8fdb\u884c\u9605\u8bfb\uff0c\u6548\u679c\u66f4\u597d</p> <p>\u5b9e\u9645\u4e0a SGLang \u7684 Cache \u7ba1\u7406\u7531\u4e09\u4e2a\u7ec4\u4ef6\u6784\u6210 <code>tree_cache</code> \u3001 <code>req_to_token_pool</code> \u548c <code>token_to_kv_pool_allocator</code> \u3002</p> <ul> <li> <p><code>tree_cache</code> \u5145\u5f53\u534f\u8c03\u5c42 \uff0c\u4f4d\u4e8e\u4e24\u4e2a\u5185\u5b58\u6c60\u4e4b\u4e0a\u3002</p> </li> <li> <p><code>req_to_token_pool</code> \u5b58\u50a8\u4e86\u4ece\u8bf7\u6c42\u5230\u4ee4\u724c\u4f4d\u7f6e\u7684\u903b\u8f91\u6620\u5c04</p> </li> <li> <p><code>token_to_kv_pool_allocator</code> \u7ba1\u7406 KV \u7f13\u5b58\u69fd\u7684\u7269\u7406\u5206\u914d</p> </li> </ul> <p><code>tree_cache</code> \u901a\u8fc7 <code>match_prefix()</code> \u8fd4\u56de\u73b0\u6709\u7684 KV \u7d22\u5f15(<code>out_cache_loc</code>)\uff0c\u4ece\u800c\u5b9e\u73b0\u524d\u7f00\u91cd\u7528 \uff0c\u907f\u514d\u4e86\u91cd\u65b0\u8ba1\u7b97\u548c\u91cd\u65b0\u5206\u914d\u3002</p> <p><code>tree_cache</code> \u901a\u8fc7 <code>cache_finished_req()</code> \u6216\u8005 <code>cache_unfinished_req()</code>(chunked prefill \u4f7f\u7528) \u6765\u91cd\u65b0\u63d2\u5165<code>prefix + new allocate</code> \u7684 <code>cache_loc</code>\uff0c\u7136\u540e\u91ca\u653e\u5197\u4f59\u7684 kv cache\u3002</p> <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#_1","title":"\u7ec4\u4ef6\u8be6\u89e3","text":"","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#req_to_token_pool","title":"req_to_token_pool","text":"<p>\u8fd9\u662f\u4ece\u8bf7\u6c42\u5230\u5176\u4ee4\u724c\u7684\u952e\u503c\u7f13\u5b58\u7d22\u5f15\u7684\u6620\u5c04\u3002\u8fd9\u5c31\u662f\u6211\u4eec\u5728\u6ce8\u610f\u529b\u540e\u7aef\u56fe\u4e2d\u63d0\u5230\u7684 <code>req_to_token</code> </p> <ul> <li>\u5f62\u72b6\uff1a\u6700\u5927\u5141\u8bb8\u8bf7\u6c42\u6570\uff08\u7531\u53c2\u6570 <code>max-running-requests</code> \u8bbe\u7f6e\uff0c\u7528\u4e8e\u6307\u5b9a\u53ef\u540c\u65f6\u8fd0\u884c\u7684\u6700\u5927\u8bf7\u6c42\u6570\uff09* \u6bcf\u4e2a\u8bf7\u6c42\u7684\u6700\u5927\u4e0a\u4e0b\u6587\u957f\u5ea6\uff08\u7531\u914d\u7f6e model_config.context_len \u8bbe\u7f6e\uff09</li> <li> <p>\u8bbf\u95ee\uff1a</p> </li> <li> <p>Dim0\uff1a <code>req_pool_indices</code> \u6807\u8bc6\u5177\u4f53\u8bf7\u6c42</p> </li> <li>Dim1\uff1a\u8bf7\u6c42\u4e2d\u6807\u8bb0\u7684\u4f4d\u7f6e\uff08\u4ece 0\u30011\u30012\u2026 \u5f00\u59cb\uff09\uff0c\u7528\u4e8e\u6807\u8bc6\u8bf7\u6c42\u4e2d\u7684\u7279\u5b9a\u6807\u8bb0\u3002</li> <li>Value: <code>out_cache_loc</code> \uff0c\u8868\u793a\u4ee4\u724c\u6307\u5411\u7531 Dim0 \u548c Dim1 \u6807\u8bc6\u7684\u4e0e\u8be5\u4ee4\u724c\u5173\u8054\u7684 KV \u7f13\u5b58\u7d22\u5f15\u3002</li> </ul>","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#token_to_kv_pool","title":"token_to_kv_pool","text":"<p><code>req_to_token_pool</code> \u7ef4\u62a4\u4e86 Request \u5230 token KV \u7f13\u5b58\u7d22\u5f15\u7684\u6620\u5c04\u5173\u7cfb\uff0c <code>token_to_kv_pool</code> \u8fdb\u4e00\u6b65\u5c06 token \u4ece\u5176 KV \u7f13\u5b58\u7d22\u5f15\u6620\u5c04\u5230\u5176\u5b9e\u9645\u7684 KV \u7f13\u5b58\u6570\u636e\u3002</p> <ul> <li>Layout: Number of Layers _ Max Allowed Tokens Number _ Number of Head * Head Dimension</li> <li>\u8bbf\u95ee\uff1a</li> <li>Dim0\uff1a<code>layer_id</code> \u6807\u8bc6\u7279\u5b9a\u56fe\u5c42</li> <li>Dim1\uff1a<code>out_cache_loc</code> \u6807\u8bc6\u7279\u5b9a\u7684 KV \u7f13\u5b58\u7d22\u5f15\uff08\u7a7a\u95f2\u69fd\u4f4d\uff09</li> <li>Dim2\uff1a<code>head</code></li> <li>Dim3\uff1a<code>head_dim</code></li> <li>Value: k_buffer \u7684\u503c\u4e3a cache_k \uff0cv_buffer \u7684\u503c\u4e3a cache_v \uff0c\u8868\u793a\u5b9e\u9645\u7684\u952e\u503c\u7f13\u5b58\u6570\u636e\u3002</li> </ul> <p>\u8bf7\u6ce8\u610f\uff0c\u6211\u4eec\u901a\u5e38\u4f1a\u4e00\u6b21\u6027\u68c0\u7d22\u6574\u4e2a\u5c42\u7684 KV \u7f13\u5b58\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u8bf7\u6c42\u4e2d\u6240\u6709\u5148\u524d token \u7684 KV \u624d\u80fd\u8fdb\u884c forward\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#example","title":"Example","text":"\u8bf7\u6c42 prefix \u65b0chunk decode \u72b6\u6001 req\u2080 [A, B, C] [D, E] \u751f\u6210 [F] \u540e\u7ed3\u675f \u2705\u5148\u7ed3\u675f req\u2081 [A, B, C]\uff08\u5171\u4eabprefix\uff09 [G, H] \u751f\u6210 [I, J] \u540e\u7ed3\u675f \u540e\u7ed3\u675f - \u7cfb\u7edf\u4e2d\u5df2\u7ecf\u6709\u4e00\u4e2a prefix cache\uff1a Python<pre><code>prefix_cache = {\n    \"ABC\": [0, 1, 2]  # KV\u69fd\u4f4d\n}\n\ntoken_to_kv_pool = {\n    0: (k_A, v_A),\n    1: (k_B, v_B),\n    2: (k_C, v_C),\n}\n</code></pre> <p>Chunked Prefill\uff08\u4ec5\u5206\u914d\u65b0chunk\u90e8\u5206\uff09</p> <ul> <li><code>req\u2080</code> \u65b0chunk: [D, E]</li> <li><code>req\u2081</code> \u65b0chunk: [G, H]</li> <li>prefix <code>[A,B,C]</code> \u4e0d\u518d\u91cd\u7b97\uff0c\u76f4\u63a5\u590d\u7528\u69fd\u4f4d <code>[0,1,2]</code>\u3002</li> </ul> Python<pre><code>req_to_token_pool = {\n    0: [0, 1, 2, 3, 4],\n    1: [0, 1, 2, 5, 6],\n}\n\ntoken_to_kv_pool.update({\n    3: (k_D, v_D),\n    4: (k_E, v_E),\n    5: (k_G, v_G),\n    6: (k_H, v_H),\n})\n</code></pre> <p>\u7b2c\u4e00\u6b21Decode</p> <ul> <li><code>req\u2080</code> \u751f\u6210\u65b0 token F\uff08\u69fd\u4f4d7\uff09</li> <li><code>req\u2081</code> \u751f\u6210\u65b0 token I\uff08\u69fd\u4f4d8\uff09</li> </ul> Python<pre><code>req_to_token_pool = {\n    0: [0, 1, 2, 3, 4, 7],\n    1: [0, 1, 2, 5, 6, 8],\n}\n\ntoken_to_kv_pool.update({\n    7: (k_F, v_F),\n    8: (k_I, v_I),\n})\n</code></pre> <p><code>req\u2080</code> \u5df2\u751f\u6210\u5b8c\u6bd5\uff0c\u56e0\u6b64\u7cfb\u7edf\u91ca\u653e\u5176 \u975eprefix\u69fd\u4f4d <code>[3,4,7]</code>\uff0cprefix <code>[0,1,2]</code> \u4fdd\u7559\u4ee5\u4f9b\u590d\u7528\u3002<code>req\u2081</code> \u7ee7\u7eed\u8fdb\u884c decode </p> Python<pre><code>req_to_token_pool = {\n    1: [0, 1, 2, 5, 6, 8]\n}\n\ntoken_to_kv_pool = {\n    0: (k_A, v_A),\n    1: (k_B, v_B),\n    2: (k_C, v_C),\n    5: (k_G, v_G),\n    6: (k_H, v_H),\n    8: (k_I, v_I),\n}\n</code></pre>","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#kv-cache","title":"\u6a21\u578b\u63a8\u7406\u4e2d\u7684 KV Cache \u7ba1\u7406\u6d41\u7a0b","text":"<p>\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5316\u63d0\u53d6\u5173\u952e\u6d41\u7a0b\uff0c\u6211\u4eec\u5047\u8bbe\u8bbe\u7f6e <code>page_size=1</code> \uff0c\u5373\u9010 token \u7cbe\u786e\u5339\u914d\u3002</p>","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#prefill","title":"Prefill","text":"<ol> <li>Step 1: Prefix Matching</li> </ol> <ul> <li>\u5f53\u6709\u65b0\u8bf7\u6c42\u5230\u8fbe\u65f6\uff0c <code>tree_cache.match_prefix()</code> \u65b9\u6cd5\u4f1a\u904d\u5386\u57fa\u6570\u6811\u4ee5\u627e\u5230\u6700\u957f\u7684\u7f13\u5b58\u524d\u7f00</li> <li><code>match_prefix()</code> \u51fd\u6570\u8fd4\u56de <code>prefix_indices</code> \uff08\u952e\u503c\u7f13\u5b58\u4f4d\u7f6e\u5f20\u91cf\uff09\u548c <code>last_node</code> \uff08\u8868\u793a\u5339\u914d\u524d\u7f00\u7684\u6811\u8282\u70b9\uff09\u3002\u8fd9\u4e9b <code>prefix_indices</code> \u76f4\u63a5\u6307\u5411\u53ef\u91cd\u7528\u7684\u7269\u7406\u952e\u503c\u7f13\u5b58\u69fd\u4f4d\u3002</li> </ul> <ol> <li>Step 2: Memory Allocation</li> </ol> <ul> <li>\u4e3a\u6279\u6b21\u5206\u914d\u952e\u503c\u7f13\u5b58\u65f6\uff0c\u7cfb\u7edf\u4f1a\u4f7f\u7528\u6811\u7f13\u5b58\u4e2d\u5df2\u7f13\u5b58\u7684<code>prefix_indices</code>\uff0c\u5e76\u4e14\u4ec5\u4e3a\u672a\u7f13\u5b58\u7684\u6807\u8bb0\u5206\u914d\u65b0\u7684\u7f13\u5b58</li> </ul> Python<pre><code># prefix reuse: \u4ece\u6811\u7f13\u5b58\u4e2d\u68c0\u7d22\u7f13\u5b58\u7684\u952e\u503c\u7d22\u5f15\nprefix_tensors = [r.prefix_indices for r in batch.reqs]\n# req_to_token_pool alloc: allocates slots for new tokens\nreq_pool_indices = alloc_req_slots(batch.req_to_token_pool, ...)\n# token_to_kv_pool alloc: kv cache allocation for new tokens\nout_cache_loc = alloc_token_slots(batch.tree_cache, ...)\n# mapping: writes both cached and new indices to req_to_token_pool\nwrite_cache_indices(...)\n</code></pre> <ol> <li>Step 3: Cache Insertion</li> </ol> <ul> <li>\u8ba1\u7b97\u5b8c\u6210\u540e\uff0c\u65b0\u7684\u952e\u503c\u7f13\u5b58\u901a\u8fc7 <code>cache_finished_req()</code> \u6216\u8005 <code>cache_unfinished_req()</code>\u88ab\u63d2\u5165\u56de\u6811\u7f13\u5b58\u4e2d\uff0c\u63d2\u5165\u8fc7\u7a0b\u4e2d\uff0c\u6811\u7f13\u5b58\uff1a<ul> <li>\u8bc6\u522b\u6811\u4e2d\u5df2\u5b58\u5728\u7684\u91cd\u590d\u524d\u7f00\uff08\u8fd4\u56de new_prefix_len \uff09</li> <li>\u901a\u8fc7 <code>token_to_kv_pool_allocator.free()</code> \u91ca\u653e\u91cd\u590d\u7684 KV \u7d22\u5f15</li> <li>\u4f7f\u7528\u65b0\u8282\u70b9\u66f4\u65b0 radix tree</li> <li>\u589e\u52a0/\u51cf\u5c11\u9501\u5f15\u7528\u4ee5\u4fdd\u62a4\u7f13\u5b58\u8282\u70b9\u514d\u53d7\u9a71\u9010</li> </ul> </li> </ul> <ol> <li> <p>Step 4\uff1a\u7ecf\u8fc7 Scheduler \u8c03\u5ea6\u540e\uff0cmodelrunner \u8fdb\u884c\u6a21\u578b\u771f\u6b63\u6267\u884c\uff0c\u8fd9\u91cc\u4ee5 flash attention \u4f5c\u4e3a\u540e\u7aef\u4e3a\u4f8b</p> <ul> <li>\u83b7\u53d6 metadata\uff0c\u6bd4\u5982\u591a\u4e2a\u5e8f\u5217 <code>cur_q_len</code>\uff0c<code>cur_q_len</code> \u4ee5\u53ca\u6bcf\u4e2a\u5e8f\u5217\u7684 token \u9700\u8981\u7684 KV cache \u7d22\u5f15</li> <li>\u8c03\u7528 <code>flash-attn.flash_attn_with_kvcache()</code>\uff0c\u5c06 page table \u548c meta data \u4f5c\u4e3a\u53c2\u6570\u4f20\u5165\uff0c\u5c31\u7ed3\u675f\u4e86 prefill \u7684\u8fc7\u7a0b</li> </ul> </li> </ol> <p>Decode \u7684\u6d41\u7a0b\u5b9e\u9645\u4e0a\u4e0e Prefill \u76f8\u4f3c\uff0c\u53ea\u662f\u5206\u914d\u5185\u5b58\u65f6\uff0c\u6bcf\u4e2a token \u53ea\u9700\u8981\u5206\u914d 1 \u4e2a\u5373\u53ef\uff0c\u5176\u4f59\u64cd\u4f5c\u57fa\u672c\u76f8\u540c</p>","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#decode","title":"Decode","text":"","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#summary","title":"Summary","text":"<p>\u501f\u7528<sup>1</sup> \u7684\u4e00\u5f20\u56fe\u4f5c\u4e3a\u603b\u7ed3</p> <p></p>","tags":["LLMInference"]},{"location":"blogs/posts/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#reference","title":"Reference","text":"<ol> <li> <p>KV Cache \u4ee3\u7801\u89e3\u6790 \u21a9</p> </li> </ol>","tags":["LLMInference"]},{"location":"links/","title":"Links","text":""},{"location":"links/#links","title":"Links \ud83e\udd70","text":"2025-12-022025-12-10 <p>Abstract</p> <p>My friends!</p> <p>\u5728\u4e0b\u65b9\u7559\u8a00\u7533\u8bf7\u52a0\u5165\u6211\u7684\u53cb\u94fe\uff0c\u6309\u5982\u4e0b\u683c\u5f0f\u63d0\u4f9b\u4fe1\u606f\uff1a</p> <ul><li>\u540d\u79f0\uff1atom-jerr's Site</li><li>\u7b80\u4ecb\uff1atomjerr </li><li>\u94fe\u63a5\uff1ahttps://tom-jerr.github.io/</li><li>\u56fe\u7247\uff1aLink of your avatar</li></ul>"},{"location":"notes/","title":"index","text":""},{"location":"notes/#notes","title":"Notes \ud83d\udcda","text":"2025-12-022025-12-10 <p>Abstract</p> <p>\u4e00\u4e9b\u6bd4\u8f83\u6210\u4f53\u7cfb\u7684\u7b14\u8bb0\u90fd\u505a\u5728\u8fd9\u91cc\uff0c\u65b9\u4fbf\u67e5\u9605\u3002</p> Text Only<pre><code>\u672c\u90e8\u5206\u5185\u5bb9\uff08\u9664\u7279\u522b\u58f0\u660e\u5916\uff09\u91c7\u7528 [**\u7f72\u540d-\u975e\u5546\u4e1a\u6027\u4f7f\u7528-\u4fdd\u6301\u4e00\u81f4 4.0 \u56fd\u9645 (CC BY-NC-SA 4.0)**](https://creativecommons.org/licenses/by-nc-sa/4.0/) \u8bb8\u53ef\u534f\u8bae\u8fdb\u884c\u8bb8\u53ef\u3002\n</code></pre>"},{"location":"notes/template/","title":"Template Note","text":"<p> \u7ea6 177 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-11-202025-12-10 <code>#LLMInference</code> <p>AI Summary powered by \u901a\u4e49\u5343\u95ee</p> <p>\u672c\u6587\u63a2\u8ba8\u4e86\u4eba\u5de5\u667a\u80fd\u5728\u533b\u7597\u9886\u57df\u7684\u5e94\u7528\uff0c\u5305\u62ec\u75be\u75c5\u8bca\u65ad\u3001\u836f\u7269\u7814\u53d1\u548c\u4e2a\u6027\u5316\u6cbb\u7597\u7b49\u65b9\u9762\u3002\u901a\u8fc7\u5206\u6790\u5927\u91cf\u533b\u7597\u6570\u636e\uff0cAI\u80fd\u591f\u63d0\u9ad8\u8bca\u65ad\u51c6\u786e\u6027\u5e76\u52a0\u5feb\u65b0\u836f\u5f00\u53d1\u8fdb\u7a0b\u3002\u540c\u65f6\uff0cAI\u8fd8\u652f\u6301\u4e2a\u6027\u5316\u6cbb\u7597\u65b9\u6848\u7684\u5236\u5b9a\uff0c\u63d0\u5347\u60a3\u8005\u6cbb\u7597\u6548\u679c\u3002\u6587\u7ae0\u6307\u51fa\uff0c\u5c3d\u7ba1AI\u5728\u533b\u7597\u4e2d\u5c55\u73b0\u51fa\u5de8\u5927\u6f5c\u529b\uff0c\u4f46\u4ecd\u9700\u89e3\u51b3\u6570\u636e\u9690\u79c1\u3001\u7b97\u6cd5\u900f\u660e\u5ea6\u7b49\u95ee\u9898\uff0c\u4ee5\u5b9e\u73b0\u66f4\u5e7f\u6cdb\u7684\u5e94\u7528\u4e0e\u63a8\u5e7f\u3002</p>","tags":["LLMInference"]},{"location":"notes/6.824/MapReduce/","title":"MapReduce","text":"2025-05-212025-12-10 <code>#Distributed System</code>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#implement-with-c-personal","title":"Implement with C++ personal","text":"<p> \u7ea6 1067 \u4e2a\u5b57  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> <p>PROJECT(not test carefully)</p>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#_1","title":"\u5e94\u7528\u7684\u57fa\u7840\u67b6\u6784","text":"<ul> <li>Storage</li> <li>Communication (Network)</li> <li>Compute</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#mapreduce","title":"MapReduce \u7f16\u7a0b\u6a21\u578b","text":"<ul> <li>Map: <code>map (k1,v1) \u2192 list(k2,v2)</code></li> <li>input: file or other input pair</li> <li>output: a set of intermediate key/value pairs</li> <li>Reduce: <code>reduce (k2,list(v2)) \u2192 list(v2)</code></li> <li>input: an intermediate key, a set of values for that key</li> <li>output: a possibly smaller set of values</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#mapreduce_1","title":"MapReduce \u5de5\u4f5c\u65b9\u5f0f","text":"","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#_2","title":"\u672f\u8bed","text":"<p>Job\u3002\u6574\u4e2a MapReduce \u8ba1\u7b97\u79f0\u4e3a Job\u3002</p> <ul> <li>\u5bf9\u4e8e\u4e00\u4e2a\u5b8c\u6574\u7684 MapReduce Job\uff0c\u5b83\u7531\u4e00\u4e9b Map Task \u548c\u4e00\u4e9b Reduce Task \u7ec4\u6210\\   Task\u3002\u6bcf\u4e00\u6b21 MapReduce \u8c03\u7528\u79f0\u4e3a Task\u3002\\   Shuffle\u3002MapReduce \u4e2d\u4ece\u4e00\u79cd\u5f62\u5f0f\u6570\u636e\u5230\u53e6\u4e00\u79cd\u6570\u636e\u5f62\u5f0f\u7684\u8f6c\u6362</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#_3","title":"\u6d41\u7a0b","text":"<ol> <li> <p>MapReduce \u542f\u52a8\u65f6\uff0c\u4f1a\u67e5\u627e Map \u51fd\u6570\u3002\u4e4b\u540e\uff0cMapReduce \u6846\u67b6\u4f1a\u4e3a\u6bcf\u4e2a\u8f93\u5165\u6587\u4ef6\u8fd0\u884c Map \u51fd\u6570\u3002\u8fd9\u91cc\u53ef\u4ee5\u5e76\u884c\u8fd0\u884c\u591a\u4e2a\u53ea\u5173\u6ce8\u8f93\u5165\u548c\u8f93\u51fa\u7684 Map \u51fd\u6570\u3002</p> </li> <li> <p>\u6240\u6709\u7684\u8f93\u5165\u6587\u4ef6\u90fd\u8fd0\u884c\u4e86 Map \u51fd\u6570\uff0c\u5e76\u5f97\u5230\u4e86\u8bba\u6587\u4e2d\u79f0\u4e4b\u4e3a\u4e2d\u95f4\u8f93\u51fa\uff08intermediate output\uff09\uff0c\u4e5f\u5c31\u662f\u6bcf\u4e2a Map \u51fd\u6570\u8f93\u51fa\u7684 key-value \u5bf9\u3002\u6b64\u65f6\u8fd9\u4e9b kv \u5bf9\u5728\u5185\u5b58 Buffer \u4e2d\u3002</p> </li> <li> <p>Buffered KV pairs \u4f1a\u901a\u8fc7\u5206\u533a\u51fd\u6570\u5b9a\u671f\u5237\u5199\u5230\u672c\u5730\u78c1\u76d8\u4e0a\uff0c\u672c\u5730\u78c1\u76d8\u4f1a\u6309\u7167 partitioning function \u8fdb\u884c\u903b\u8f91\u5206\u533a\u5206\u6210 R \u4e2a\u533a\u57df\uff0ckv paris \u5728\u78c1\u76d8\u4e2d\u7684\u4f4d\u7f6e\u544a\u77e5\u7ed9 master\uff0c\u540e\u7eed reduce worker \u9700\u8981\u77e5\u9053 kv pairs \u7684\u4f4d\u7f6e\u3002</p> </li> <li> <p>reduce worker \u4f7f\u7528 RPC \u83b7\u53d6\u67d0\u4e2a\u533a\u57df\u7684 kv pairs\uff0c\u5f53 reduce \u83b7\u53d6\u5230\u6240\u6709 map worker \u7684\u67d0\u4e2a\u5206\u533a\u7684 kv pair \u540e\uff0c\u6309\u7167 key \u6765\u6392\u5e8f\uff0c\u5982\u679c\u6392\u5e8f\u65e0\u6cd5\u5728\u5185\u5b58\u4e2d\u5b8c\u6210\uff0c\u4f7f\u7528\u5916\u90e8\u6392\u5e8f\u6765\u5b9e\u73b0\u3002</p> </li> <li> <p>reduce worker \u5bf9\u4e8e\u6bcf\u4e2a\u552f\u4e00\u7684 key\uff0c\u5c06 key \u548c\u5bf9\u5e94\u7684\u4e00\u7cfb\u5217 values \u4f20\u9012\u7ed9\u7528\u6237\u5b9a\u4e49\u7684 reduce \u51fd\u6570</p> </li> <li> <p>\u5f53\u6240\u6709 map \u4efb\u52a1\u548c reduce \u4efb\u52a1\u90fd\u5b8c\u6210\u540e\uff0cmaster \u4f1a\u5524\u9192\u7528\u6237\u8fdb\u7a0b\u3002</p> </li> </ol>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#_4","title":"\u6545\u969c\u5904\u7406","text":"","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#worker-failure","title":"Worker Failure","text":"<ul> <li>master \u7528\u5468\u671f\u6027\u5fc3\u8df3\u76d1\u542c worker \u662f\u5426\u5931\u6548\u3002</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#task-not-completed","title":"task not completed","text":"<ul> <li>\u5982\u679c task \u6ca1\u5b8c\u6210\uff0cworker \u5931\u6548\uff0c\u5c06 task \u6807\u8bb0\u4e3a idle\uff0c\u4ea4\u7ed9 master \u91cd\u65b0\u6765\u8c03\u5ea6\u7ed9\u5176\u4ed6\u53ef\u7528\u7684 worker</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#task-completed","title":"task completed","text":"<ul> <li>\u5df2\u7ecf\u5b8c\u6210\u7684 map task\uff0cworker failed \u9700\u8981\u91cd\u65b0\u6267\u884c\uff0c\u56e0\u4e3a\u4e2d\u95f4\u8f93\u51fa\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\uff1b\u800c\u5b8c\u6210\u7684 reduce task \u4e0d\u9700\u8981\uff0creduce task \u7684\u8f93\u51fa\u5728 global file system \u4e2d\u3002</li> <li>\u4e00\u65e6\u4e00\u4e2a map task \u7684 worker \u5207\u6362\uff0cmaster \u4f1a\u901a\u77e5\u8fd9\u4e2a\u6d88\u606f\u7ed9 reduce worker\u3002</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#master-failure","title":"Master Failure","text":"<ul> <li>\u56e0\u6b64\uff0c\u5982\u679c\u4e3b\u8282\u70b9\u5931\u8d25\uff0c\u6211\u4eec\u5f53\u524d\u7684\u5b9e\u65bd\u5c06\u4e2d\u6b62 MAPREDUCE \u8ba1\u7b97\u3002\u5ba2\u6237\u53ef\u4ee5\u68c0\u67e5\u6b64\u6761\u4ef6\u5e76\u6839\u636e\u9700\u8981\u91cd\u8bd5 MapReduce \u64cd\u4f5c\u3002</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#other-failure","title":"Other Failure","text":"","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#map","title":"\u5982\u679c\u534f\u8c03\u5668\u7ed9\u4e24\u4e2a\u5de5\u4f5c\u8282\u70b9\u5206\u914d\u76f8\u540c\u7684 Map() \u4efb\u52a1\u600e\u4e48\u529e?","text":"<ul> <li>Master \u5c06\u53ea\u5411 Reduce \u5de5\u4f5c\u8282\u70b9\u62a5\u544a\u5176\u4e2d\u4e00\u4e2a\u3002 <p>map task \u5b8c\u6210\u4efb\u52a1\u4f1a\u5728\u6d88\u606f\u4e2d\u5305\u542b\u4e2d\u95f4\u8f93\u51fa\u7684 R \u4e2a\u4e34\u65f6\u6587\u4ef6\u7684\u540d\u79f0\u3002\u5982\u679c\u4e3b master \u6536\u5230\u5df2\u7ecf\u5b8c\u6210\u7684 map task \u7684\u5b8c\u6210\u6d88\u606f\uff0c\u5219\u5ffd\u7565\u8be5\u6d88\u606f\u3002</p> </li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#reduce","title":"\u5982\u679c\u534f\u8c03\u5668\u7ed9\u4e24\u4e2a\u5de5\u4f5c\u8282\u70b9\u5206\u914d\u76f8\u540c\u7684 Reduce() \u4efb\u52a1\u600e\u4e48\u529e?","text":"<ul> <li>Reduce worker \u90fd\u4f1a\u5c1d\u8bd5\u5728 GFS \u4e0a\u5199\u5165\u540c\u4e00\u4e2a\u8f93\u51fa\u6587\u4ef6\uff01\u539f\u5b50 GFS \u91cd\u547d\u540d\u53ef\u4ee5\u9632\u6b62\u6df7\u5408\uff1b\u53ea\u6709\u4e00\u4e2a\u5b8c\u6574\u7684\u6587\u4ef6\u5c06\u53ef\u89c1\u3002 <p>reduce task \u5b8c\u6210\u540e\u4f1a\u5c06\u4e34\u65f6\u8f93\u51fa\u6587\u4ef6\u91cd\u547d\u540d\u4e3a\u6700\u7ec8\u8f93\u51fa\u6587\u4ef6\uff0c\u4f9d\u9760\u57fa\u7840\u6587\u4ef6\u7cfb\u7edf\u63d0\u4f9b\u7684\u539f\u5b50\u91cd\u547d\u540d\u64cd\u4f5c\u6765\u786e\u4fdd\u6700\u7ec8\u6587\u4ef6\u7cfb\u7edf\u72b6\u6001\u4ec5\u5305\u542b\u4e00\u4e2a\u7531\u51cf\u5c11\u4efb\u52a1\u6267\u884c\u4ea7\u751f\u7684\u6570\u636e</p> </li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#_5","title":"\u5982\u679c\u5355\u4e2a\u5de5\u4f5c\u8282\u70b9\u975e\u5e38\u6162\u2014\u2014\u4e00\u4e2a\u201c\u843d\u540e\u8005\u201d\uff1f","text":"<ul> <li>Master \u5907\u4efd\u6267\u884c\u5269\u4f59\u7684\u8fc7\u7a0b\u4e2d\u4efb\u52a1\u3002\u6bcf\u5f53 Master \u6267\u884c\u6216\u5907\u4efd\u6267\u884c\u5b8c\u6210\u65f6\uff0c\u4efb\u52a1\u88ab\u6807\u8bb0\u4e3a\u5b8c\u6210\u3002</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#_6","title":"\u74f6\u9888","text":"<ul> <li>\u7f51\u7edc\u5e26\u5bbd\u662f\u74f6\u9888\uff0c\u901a\u8fc7 GFS \u5c06\u8f93\u5165\u6587\u4ef6\u5b58\u50a8\u5728\u672c\u5730\u78c1\u76d8\u4e2d</li> <li>MapReduce Master \u8003\u8651\u4e86\u8f93\u5165\u6587\u4ef6\u7684\u4f4d\u7f6e\u4fe1\u606f\uff0c\u5e76\u8bd5\u56fe\u5728\u5305\u542b\u76f8\u5e94\u8f93\u5165\u6570\u636e\u590d\u5236\u7684\u8ba1\u7b97\u673a\u4e0a\u5b89\u6392 MAP \u4efb\u52a1\u3002</li> <li>\u6570\u636e\u4ec5\u4ec5\u5728 Reduce task \u65f6\u4ece map \u78c1\u76d8\u901a\u8fc7\u7f51\u7edc\u62f7\u8d1d\u5230 reduce worker \u7684\u673a\u5668\u4e2d\u3002</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.824/MapReduce/#_7","title":"\u8d1f\u8f7d\u5747\u8861","text":"<ul> <li>\u4efb\u52a1\u6bd4\u5de5\u4f5c\u673a\u5668\u591a\u5f97\u591a\u3002\u534f\u8c03\u5668\u5c06\u65b0\u4efb\u52a1\u5206\u914d\u7ed9\u5b8c\u6210\u5148\u524d\u4efb\u52a1\u7684\u5de5\u4f5c\u5668\u3002\u56e0\u6b64\uff0c\u8f83\u5feb\u7684\u670d\u52a1\u5668\u6267\u884c\u7684\u4efb\u52a1\u6bd4\u6162\u7684\u670d\u52a1\u5668\u591a\u3002\u5e76\u4e14\u6162\u7684\u670d\u52a1\u5668\u5206\u914d\u7684\u5de5\u4f5c\u91cf\u8f83\u5c11\uff0c\u4ece\u800c\u51cf\u5c11\u4e86\u5bf9\u63a5\u603b\u65f6\u95f4\u7684\u5f71\u54cd\u3002</li> </ul>","tags":["Distributed System"]},{"location":"notes/6.s081/1-OS%E7%9A%84%E9%9A%94%E7%A6%BB%E6%80%A7/","title":"1-OS\u7684\u9694\u79bb\u6027","text":"2023-09-112025-12-13 <code>#Operator System</code>","tags":["Operator System"]},{"location":"notes/6.s081/1-OS%E7%9A%84%E9%9A%94%E7%A6%BB%E6%80%A7/#os","title":"OS \u7684\u9694\u79bb\u6027","text":"<p> \u7ea6 458 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p> <ul> <li>\u9700\u8981\u4e0d\u540c\u7684\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u6709\u5f3a\u9694\u79bb\u6027</li> <li>\u9700\u8981 OS \u4e0e\u5e94\u7528\u7a0b\u5e8f\u95f4\u4e5f\u6709\u5f3a\u9694\u79bb\u6027</li> </ul> <p>OS \u9694\u79bb\u4fdd\u8bc1 multiplexing \u548c\u5185\u5b58\u9694\u79bb</p> <ul> <li>multiplexing\uff08CPU \u5728\u591a\u8fdb\u7a0b\u540c\u5206\u65f6\u590d\u7528\uff09\uff1a\u4e0d\u8bba\u5e94\u7528\u7a0b\u5e8f\u5728\u6267\u884c\u4ec0\u4e48\u64cd\u4f5c\uff0cmultiplexing \u90fd\u4f1a\u8feb\u4f7f\u5e94\u7528\u7a0b\u5e8f\u65f6\u4e0d\u65f6\u7684\u91ca\u653e CPU\uff0c\u8fd9\u6837\u5176\u4ed6\u7684\u5e94\u7528\u7a0b\u5e8f\u624d\u80fd\u8fd0\u884c\u3002</li> <li>\u4e0d\u540c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u7684\u5185\u5b58\u662f\u9694\u79bb\u7684\uff0c\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u4e0d\u4f1a\u76f8\u4e92\u8986\u76d6</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/1-OS%E7%9A%84%E9%9A%94%E7%A6%BB%E6%80%A7/#_1","title":"\u786c\u4ef6\u652f\u6301\u5f3a\u9694\u79bb","text":"<ul> <li>uer/kernel mode</li> <li>\u5728\u5904\u7406\u5668\u91cc\u9762\u6709\u4e00\u4e2a flag\u3002\u5728\u5904\u7406\u5668\u7684\u4e00\u4e2a bit\uff0c\u5f53\u5b83\u4e3a 1 \u7684\u65f6\u5019\u662f user mode\uff0c\u5f53\u5b83\u4e3a 0 \u65f6\u662f kernel mode\u3002\u5f53\u5904\u7406\u5668\u5728\u89e3\u6790\u6307\u4ee4\u65f6\uff0c\u5982\u679c\u6307\u4ee4\u662f\u7279\u6b8a\u6743\u9650\u6307\u4ee4\uff0c\u5e76\u4e14\u8be5 bit \u88ab\u8bbe\u7f6e\u4e3a 1</li> <li>virtual memory</li> <li>\u5904\u7406\u5668\u5305\u542b\u4e86 page table\uff0c\u800c page table \u5c06\u865a\u62df\u5185\u5b58\u5730\u5740\u4e0e\u7269\u7406\u5185\u5b58\u5730\u5740\u505a\u4e86\u5bf9\u5e94</li> <li>\u6bcf\u4e00\u4e2a\u8fdb\u7a0b\u53ea\u80fd\u8bbf\u95ee\u51fa\u73b0\u5728\u81ea\u5df1 page table \u4e2d\u7684\u7269\u7406\u5185\u5b58</li> <li>\u5185\u6838\uff1aTrusted Computing Base (TCB)</li> <li>\u5b8f\u5185\u6838\uff1a\u6240\u6709\u64cd\u4f5c\u7cfb\u7edf\u670d\u52a1\u90fd\u5728 kernel mode</li> <li>\u5fae\u5185\u6838\uff1a\u5c06\u5927\u90e8\u5206\u7684\u64cd\u4f5c\u7cfb\u7edf\u8fd0\u884c\u5728\u5185\u6838\u4e4b\u5916\uff1b\u4f7f\u7528 IPC \u8fdb\u884c\u901a\u4fe1<ul> <li>\u5728 user/kernel mode \u53cd\u590d\u8df3\u8f6c\u5e26\u6765\u7684\u6027\u80fd\u635f\u8017\u3002</li> <li>\u5728\u4e00\u4e2a\u7c7b\u4f3c\u5b8f\u5185\u6838\u7684\u7d27\u8026\u5408\u7cfb\u7edf\uff0c\u5404\u4e2a\u7ec4\u6210\u90e8\u5206\uff0c\u4f8b\u5982\u6587\u4ef6\u7cfb\u7edf\u548c\u865a\u62df\u5185\u5b58\u7cfb\u7edf\uff0c\u53ef\u4ee5\u5f88\u5bb9\u6613\u7684\u5171\u4eab page cache\u3002\u800c\u5728\u5fae\u5185\u6838\u4e2d\uff0c\u6bcf\u4e2a\u90e8\u5206\u4e4b\u95f4\u90fd\u5f88\u597d\u7684\u9694\u79bb\u5f00\u4e86\uff0c\u8fd9\u79cd\u5171\u4eab\u66f4\u96be\u5b9e\u73b0\u3002\u8fdb\u800c\u5bfc\u81f4\u66f4\u96be\u5728\u5fae\u5185\u6838\u4e2d\u5f97\u5230\u66f4\u9ad8\u7684\u6027\u80fd\u3002</li> </ul> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/1-OS%E7%9A%84%E9%9A%94%E7%A6%BB%E6%80%A7/#os_1","title":"OS \u7684\u9632\u5fa1\u6027","text":"<ul> <li>\u5fc5\u987b\u5177\u5907\u9632\u5fa1\u6027\u62b5\u5fa1\u6076\u610f\u7a0b\u5e8f\u7684\u653b\u51fb</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/","title":"2-\u865a\u62df\u5185\u5b58\u7684\u5b9e\u73b0","text":"2023-09-112025-12-13 <code>#Operator System</code>","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/#_1","title":"\u865a\u62df\u5185\u5b58\u5b9e\u73b0","text":"<p> \u7ea6 973 \u4e2a\u5b57  6 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p>","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/#_2","title":"\u9875\u8868","text":"<ul> <li> <p>\u786c\u4ef6\u901a\u8fc7\u5904\u7406\u5668\u548c MMU\uff08Memory Management Unit\uff09\u5b9e\u73b0</p> </li> <li> <p>\u4efb\u4f55\u4e00\u6761\u5730\u5740\u5e94\u8be5\u8ba4\u4e3a\u662f\u865a\u62df\u5185\u5b58\u5730\u5740\uff1b\u8be5\u5730\u5740\u4f1a\u8f6c\u5230 MMU\uff0cMMU \u7ffb\u8bd1\u4e3a\u7269\u7406\u5730\u5740\uff0c\u4ece\u7269\u7406\u5730\u5740\u52a0\u8f7d</p> </li> <li> <p>MMU \u53ea\u662f\u53bb\u67e5\u770b page table\uff0cpage table \u5b58\u5728\u4e8e\u5185\u5b58\u4e2d</p> </li> <li> <p>\u865a\u62df\u5185\u5b58\u5730\u5740\u53ea\u4f7f\u7528\u4e86\u4f4e 39bit\uff1b\u4f4e 12bit \u4f5c\u4e3a\u9875\u5185\u5730\u5740\u504f\u79fb\uff08offset\uff09\uff0c\u9ad8 27bit \u662f\u7d22\u5f15\u9875\u7684 index\uff0c\u5b9e\u9645\u4e0a\u662f\u7531 3 \u4e2a 9bit \u7684\u6570\u5b57\u7ec4\u6210\uff08L2\uff0cL1\uff0cL0\uff09\u3002\u524d 9 \u4e2a bit \u88ab\u7528\u6765\u7d22\u5f15\u6700\u9ad8\u7ea7\u7684 page directory\uff08\u6ce8\uff1a\u901a\u5e38 page directory \u662f\u7528\u6765\u7d22\u5f15 page table \u6216\u8005\u5176\u4ed6 page directory \u7269\u7406\u5730\u5740\u7684\u8868\u5355</p> </li> <li> <p>\u7528 44bit \u7684 PPN\uff0c\u518d\u52a0\u4e0a 12bit \u7684 0\uff0c\u8fd9\u6837\u5c31\u5f97\u5230\u4e86\u4e0b\u4e00\u7ea7 page directory \u7684 56bit \u7269\u7406\u5730\u5740\u3002\u8fd9\u91cc\u8981\u6c42\u6bcf\u4e2a page directory \u90fd\u4e0e\u7269\u7406 page \u5bf9\u9f50</p> </li> </ul> <p></p> <ul> <li>3 \u7ea7\u9875\u8868\u7531\u786c\u4ef6\u5b9e\u73b0\u7684\uff0c\u6240\u4ee5 3 \u7ea7 page table \u7684\u67e5\u627e\u90fd\u53d1\u751f\u5728\u786c\u4ef6\u4e2d\u3002MMU \u662f\u786c\u4ef6\u7684\u4e00\u90e8\u5206\u800c\u4e0d\u662f\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e00\u90e8\u5206\u3002</li> <li>\u5728 XV6 \u4e2d\uff0c\u6709\u4e00\u4e2a\u51fd\u6570\u4e5f\u5b9e\u73b0\u4e86 page table \u7684\u67e5\u627e\uff0c\u56e0\u4e3a\u65f6\u4e0d\u65f6\u7684 XV6 \u4e5f\u9700\u8981\u5b8c\u6210\u786c\u4ef6\u7684\u5de5\u4f5c\uff0c\u6240\u4ee5 XV6 \u6709\u8fd9\u4e2a\u53eb\u505a walk \u7684\u51fd\u6570\uff0c\u5b83\u5728\u8f6f\u4ef6\u4e2d\u5b9e\u73b0\u4e86 MMU \u786c\u4ef6\u76f8\u540c\u7684\u529f\u80fd\u3002</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/#pte","title":"PTE \u7ed3\u6784","text":"<ul> <li>\u7b2c\u4e00\u4e2a\u6807\u5fd7\u4f4d\u662f Valid\u3002\u5982\u679c Valid bit \u4f4d\u4e3a 1\uff0c\u90a3\u4e48\u8868\u660e\u8fd9\u662f\u4e00\u6761\u5408\u6cd5\u7684 PTE\uff0c\u4f60\u53ef\u4ee5\u7528\u5b83\u6765\u505a\u5730\u5740\u7ffb\u8bd1\u3002\u5bf9\u4e8e\u521a\u521a\u4e3e\u5f97\u90a3\u4e2a\u5c0f\u4f8b\u5b50\uff08\u5e94\u7528\u7a0b\u5e8f\u53ea\u7528\u4e86 1 \u4e2a page \u7684\u4f8b\u5b50\uff09\uff0c\u6211\u4eec\u53ea\u4f7f\u7528\u4e86 3 \u4e2a page directory\uff0c\u6bcf\u4e2a page directory \u4e2d\u53ea\u6709\u7b2c 0 \u4e2a PTE \u88ab\u4f7f\u7528\u4e86\uff0c\u6240\u4ee5\u53ea\u6709\u7b2c 0 \u4e2a PTE \u7684 Valid bit \u4f4d\u4f1a\u88ab\u8bbe\u7f6e\u6210 1\uff0c\u5176\u4ed6\u7684 511 \u4e2a PTE \u7684 Valid bit \u4e3a 0\u3002\u8fd9\u4e2a\u6807\u5fd7\u4f4d\u544a\u8bc9 MMU\uff0c\u4f60\u4e0d\u80fd\u4f7f\u7528\u8fd9\u6761 PTE\uff0c\u56e0\u4e3a\u8fd9\u6761 PTE \u5e76\u4e0d\u5305\u542b\u6709\u7528\u7684\u4fe1\u606f\u3002</li> <li>\u4e0b\u4e24\u4e2a\u6807\u5fd7\u4f4d\u5206\u522b\u662f Readable \u548c Writable\u3002\u8868\u660e\u4f60\u662f\u5426\u53ef\u4ee5\u8bfb/\u5199\u8fd9\u4e2a page\u3002</li> <li>Executable \u8868\u660e\u4f60\u53ef\u4ee5\u4ece\u8fd9\u4e2a page \u6267\u884c\u6307\u4ee4\u3002</li> <li>User \u8868\u660e\u8fd9\u4e2a page \u53ef\u4ee5\u88ab\u8fd0\u884c\u5728\u7528\u6237\u7a7a\u95f4\u7684\u8fdb\u7a0b\u8bbf\u95ee</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/#tlb","title":"TLB","text":"<ul> <li> <p>\u6bcf\u4e2a\u6838\u6709\u81ea\u5df1\u7684 MMU \u548c TLB</p> </li> <li> <p>\u5982\u679c\u5207\u6362 page table\uff0c\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u544a\u8bc9\u5904\u7406\u5668\u5f53\u524d\u6b63\u5728\u5207\u6362 page table\uff0c\u5904\u7406\u5668\u4f1a\u6e05\u7a7a TLB\u3002\u56e0\u4e3a\u672c\u8d28\u4e0a\u6765\u8bf4\uff0c\u5982\u679c\u4f60\u5207\u6362\u4e86 page table\uff0cTLB \u4e2d\u7684\u7f13\u5b58\u5c06\u4e0d\u518d\u6709\u7528\uff0c\u5b83\u4eec\u9700\u8981\u88ab\u6e05\u7a7a\uff0c\u5426\u5219\u5730\u5740\u7ffb\u8bd1\u53ef\u80fd\u4f1a\u51fa\u9519\u3002</p> </li> <li> <p>\u5728 RISC-V \u4e2d\uff0c\u6e05\u7a7a TLB \u7684\u6307\u4ee4\u662f sfence_vma</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/#_3","title":"\u865a\u62df\u5730\u5740\u6620\u5c04","text":"","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/#_4","title":"\u6620\u5c04\u8fc7\u7a0b","text":"<p>CPU \u5c06\u865a\u62df\u5730\u5740\u4f20\u5165 MMU\uff0cMMU \u6839\u636e SATP \u4e2d\u7684\u503c\u5224\u65ad\u662f\u5426\u8fdb\u884c\u865a\u62df\u5185\u5b58\u548c\u7269\u7406\u5185\u5b58\u7684\u6620\u5c04</p> <ul> <li>SATP=0\uff0c\u865a\u62df\u5730\u5740\u5c31\u662f\u7269\u7406\u5730\u5740</li> <li>SATP \u4e3a\u9875\u8868\u7684\u6839\u5730\u5740\uff0c\u8fdb\u884c\u7269\u7406\u9875\u7684\u7d22\u5f15</li> </ul> <p></p>","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/#_5","title":"\u5185\u6838","text":"<ul> <li> <p>free memory \u6765\u5b58\u653e\u7528\u6237\u8fdb\u7a0b\u7684 page table\uff0ctext \u548c data\u3002\u5982\u679c\u6211\u4eec\u8fd0\u884c\u4e86\u975e\u5e38\u591a\u7684\u7528\u6237\u8fdb\u7a0b\uff0c\u67d0\u4e2a\u65f6\u95f4\u70b9\u6211\u4eec\u4f1a\u8017\u5c3d\u8fd9\u6bb5\u5185\u5b58\uff0c\u8fd9\u4e2a\u65f6\u5019 fork \u6216\u8005 exec \u4f1a\u8fd4\u56de\u9519\u8bef\u3002</p> </li> <li> <p>\u5de6\u4fa7\u4f4e\u4e8e PHYSTOP \u7684\u865a\u62df\u5730\u5740\uff0c\u4e0e\u53f3\u4fa7\u4f7f\u7528\u7684\u7269\u7406\u5730\u5740\u662f\u4e00\u6837\u7684\u3002</p> </li> <li> <p>kernel stack \u4e4b\u4e0b\u6709\u4e00\u4e2a\u672a\u88ab\u6620\u5c04\u7684 Guard page\uff0c\u8fd9\u4e2a Guard page \u5bf9\u5e94\u7684 PTE \u7684 Valid \u6807\u5fd7\u4f4d\u6ca1\u6709\u8bbe\u7f6e\uff0c\u8fd9\u6837\uff0c\u5982\u679c kernel stack \u8017\u5c3d\u4e86\uff0c\u5b83\u4f1a\u6ea2\u51fa\u5230 Guard page\uff0c\u4f46\u662f\u56e0\u4e3a Guard page \u7684 PTE \u4e2d Valid \u6807\u5fd7\u4f4d\u672a\u8bbe\u7f6e\uff0c\u4f1a\u5bfc\u81f4\u7acb\u5373\u89e6\u53d1 page fault\uff1bGuard page \u4e0d\u4f1a\u6620\u5c04\u5230\u4efb\u4f55\u7269\u7406\u5185\u5b58\uff0c\u5b83\u53ea\u662f\u5360\u636e\u4e86\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7684\u4e00\u6bb5\u9760\u540e\u7684\u5730\u5740\u3002</p> </li> <li> <p>kernel stack \u88ab\u6620\u5c04\u4e86\u4e24\u6b21\uff0c\u5728\u9760\u540e\u7684\u865a\u62df\u5730\u5740\u6620\u5c04\u4e86\u4e00\u6b21\uff0c\u5728 PHYSTOP \u4e0b\u7684 Kernel data \u4e2d\u53c8\u6620\u5c04\u4e86\u4e00\u6b21\uff0c\u4f46\u662f\u5b9e\u9645\u4f7f\u7528\u7684\u65f6\u5019\u7528\u7684\u662f\u4e0a\u9762\u7684\u90e8\u5206\uff0c\u56e0\u4e3a\u6709 Guard page \u4f1a\u66f4\u52a0\u5b89\u5168\u3002</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/2-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%AE%9E%E7%8E%B0/#_6","title":"\u7528\u6237","text":"","tags":["Operator System"]},{"location":"notes/6.s081/3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8C%E9%99%B7%E5%85%A5/","title":"3-\u7cfb\u7edf\u8c03\u7528\u548c\u9677\u5165","text":"2023-09-112025-12-13 <code>#Operator System</code>","tags":["Operator System"]},{"location":"notes/6.s081/3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8C%E9%99%B7%E5%85%A5/#system-calls-and-trap","title":"System calls and Trap","text":"<p> \u7ea6 1394 \u4e2a\u5b57  5 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> <ul> <li>\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u7684\u5207\u6362\uff08trap\uff09</li> <li>\u7a0b\u5e8f\u6267\u884c\u7cfb\u7edf\u8c03\u7528\uff08System call\uff09</li> <li>\u7a0b\u5e8f\u51fa\u73b0\u4e86\u7c7b\u4f3c page fault\u3001\u9664 0 \u7b49\u5f02\u5e38\uff08\u8f6f\u4ef6\u4e2d\u65ad\uff09</li> <li>\u786c\u4ef6\u4e2d\u65ad\uff08IO \u8bbe\u5907\uff09</li> <li>RISC-V \u5bc4\u5b58\u5668</li> <li>32 \u4e2a\u901a\u7528\u5bc4\u5b58\u5668</li> <li>PC\uff08\u7a0b\u5e8f\u8ba1\u6570\u5668\uff09</li> <li>Mode\uff08\u8868\u660e\u4f4d\u4e8e\u4f55\u79cd\u72b6\u6001 user or supervisor\uff09</li> <li>SATP\uff08\u6307\u5411\u9875\u8868\u7684\u7269\u7406\u5730\u5740\uff09</li> <li>SEPC\uff08\u6307\u5411 trap \u6307\u4ee4\u7684\u8d77\u59cb\u5730\u5740\uff09</li> <li>STVEC \uff08\u4e5f\u5c31\u662f\u5904\u7406 trap \u7684\u5185\u6838\u6307\u4ee4\u5730\u5740\uff09</li> <li>SSRATCH\uff08\u4ea4\u6362\u9875\u8868\u548c a0 \u5730\u5740\uff09</li> <li>\u5185\u6838\u6001\u6743\u9650</li> <li>\u8bfb\u5199\u63a7\u5236\u5bc4\u5b58\u5668\uff1aSATP\u3001STVEC\u3001SEPC</li> <li>\u5b83\u53ef\u4ee5\u4f7f\u7528 PTE_U \u6807\u5fd7\u4f4d\u4e3a 0 \u7684 PTE</li> <li>supervisor mode \u4e2d\u7684\u4ee3\u7801\u5e76\u4e0d\u80fd\u8bfb\u5199\u4efb\u610f\u7269\u7406\u5730\u5740\uff0c\u901a\u8fc7 page table \u8bbf\u95ee\u5185\u5b58</li> <li>\u7528\u6237\u6001\u8df3\u5165\u5185\u6838\u6001\u524d</li> <li>\u4fdd\u5b58\u7528\u6237\u6001 32 \u4e2a\u5bc4\u5b58\u5668</li> <li>\u4fdd\u5b58 PC</li> <li>\u6539\u53d8 Mode \u4e3a Supervisor</li> <li>\u6539\u53d8 SATP \u5bc4\u5b58\u5668\u6307\u5411\u5185\u6838\u9875\u8868</li> <li>\u5c06\u5806\u6808\u5bc4\u5b58\u5668\u6307\u5411\u5185\u6838\u7684\u5730\u5740</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%92%8C%E9%99%B7%E5%85%A5/#trap","title":"Trap \u6267\u884c\u6d41\u7a0b","text":"<ul> <li> <p>\u5728\u4ece\u7528\u6237\u7a7a\u95f4\u8fdb\u5165\u5230\u5185\u6838\u7a7a\u95f4\u4e4b\u524d\uff0c\u5185\u6838\u4f1a\u8bbe\u7f6e\u597d STVEC \u5bc4\u5b58\u5668\u6307\u5411 trampoline page</p> </li> <li> <p>ecall\uff08CPU \u6307\u4ee4\uff09\u5207\u6362\u5230 Supervisor mode</p> </li> <li> <p>\u6b64\u65f6\u5e76\u672a\u5207\u6362 page table\uff0c\u4ecd\u7136\u662f\u7528\u6237\u9875\u8868\uff0c\u4ee3\u7801\u6b63\u5728 trampoline page \u7684\u6700\u5f00\u59cb</p> </li> <li>\u4fdd\u5b58 PC \u5230 SEPC \u5bc4\u5b58\u5668</li> <li>ecall \u4f1a\u8df3\u8f6c\u5230 STVEC \u5bc4\u5b58\u5668\u6307\u5411\u7684\u6307\u4ee4</li> </ul> <p>RISC-V \u79c9\u6301\u4e86\u8fd9\u6837\u4e00\u4e2a\u89c2\u70b9\uff1aecall \u53ea\u5b8c\u6210\u5c3d\u91cf\u5c11\u5fc5\u987b\u8981\u5b8c\u6210\u7684\u5de5\u4f5c\uff0c\u5176\u4ed6\u7684\u5de5\u4f5c\u90fd\u4ea4\u7ed9\u8f6f\u4ef6\u5b8c\u6210\u3002\u8fd9\u91cc\u7684\u539f\u56e0\u662f\uff0cRISC-V \u8bbe\u8ba1\u8005\u60f3\u8981\u4e3a\u8f6f\u4ef6\u548c\u64cd\u4f5c\u7cfb\u7edf\u7684\u7a0b\u5e8f\u5458\u63d0\u4f9b\u6700\u5927\u7684\u7075\u6d3b\u6027\uff0c\u8fd9\u6837\u4ed6\u4eec\u5c31\u80fd\u6309\u7167\u4ed6\u4eec\u60f3\u8981\u7684\u65b9\u5f0f\u5f00\u53d1\u64cd\u4f5c\u7cfb\u7edf</p> <ul> <li> <p>uservec\uff1a\u6c47\u7f16\u8bed\u8a00\u4ee3\u7801\uff0ctrampoline.s \u6587\u4ef6\u7684\u4e00\u90e8\u5206</p> </li> <li> <p>\u5185\u6838\u4f1a\u5c06 trapframe page \u7684\u5730\u5740\u4fdd\u5b58 SSCRATCH \u5bc4\u5b58\u5668</p> <p>\u7528\u6237\u6620\u5c04\u4e86 trapframe page\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u6709\u81ea\u5df1\u7684 trapframe page\uff1b\u7528\u8be5\u7ed3\u6784\u4fdd\u5b58 32 \u4e2a\u7528\u6237\u5bc4\u5b58\u5668</p> <p>\u5728\u5185\u6838\u524d\u4e00\u6b21\u5207\u6362\u56de\u7528\u6237\u7a7a\u95f4\u65f6\uff0c\u5185\u6838\u4f1a\u6267\u884c set sscratch \u6307\u4ee4\uff0c\u5c06\u8fd9\u4e2a\u5bc4\u5b58\u5668\u7684\u5185\u5bb9\u8bbe\u7f6e\u4e3a 0x3fffffe000\uff0c\u4e5f\u5c31\u662f trapframe page \u7684\u865a\u62df\u5730\u5740</p> <p>\u5728\u8fd4\u56de\u7528\u6237\u7a7a\u95f4\u524d\uff0c\u8bbe\u7f6e a0 \u4e3a trapframe page \u7684\u865a\u62df\u5730\u5740\uff0c\u540c\u65f6\u5207\u6362\u9875\u8868\u4e3a\u7528\u6237\u9875\u8868</p> C<pre><code>uint64 fn = TRAMPOLINE + (userret - trampoline);\n((void(*)(uint64,uint64))fn)(TRAPFRAME, satp);\n</code></pre> </li> <li> <p>\u5207\u6362\u5230\u5185\u6838\u9875\u8868\uff1b\u56e0\u4e3a\u4e8c\u8005\u6620\u5c04\u7684\u7269\u7406\u5730\u5740\u76f8\u540c\uff0c\u5207\u6362\u540e\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u800c\u4e0d\u5d29\u6e83</p> <p>trampoline page \u5728 user page table \u4e2d\u7684\u6620\u5c04\u4e0e kernel page table \u4e2d\u7684\u6620\u5c04\u662f\u5b8c\u5168\u4e00\u6837\u7684\u3002\u8fd9\u4e24\u4e2a page table \u4e2d\u5176\u4ed6\u6240\u6709\u7684\u6620\u5c04\u90fd\u662f\u4e0d\u540c\u7684\uff0c\u53ea\u6709 trampoline page \u7684\u6620\u5c04\u662f\u4e00\u6837\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u5728\u5207\u6362 page table \u65f6\uff0c\u5bfb\u5740\u7684\u7ed3\u679c\u4e0d\u4f1a\u6539\u53d8\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u5c31\u53ef\u4ee5\u7ee7\u7eed\u5728\u540c\u4e00\u4e2a\u4ee3\u7801\u5e8f\u5217\u4e2d\u6267\u884c\u7a0b\u5e8f\u800c\u4e0d\u5d29\u6e83</p> </li> <li> <p>\u8df3\u5165 usertrap \u51fd\u6570</p> </li> <li> <p>usertrap</p> </li> <li> <p>\u5148\u5c06 STVEC \u6307\u5411\u4e86 kernelvec \u53d8\u91cf\uff0c\u8fd9\u662f\u5185\u6838\u7a7a\u95f4 trap \u5904\u7406\u4ee3\u7801\u7684\u4f4d\u7f6e</p> <p>\u6211\u4eec\u9700\u8981\u77e5\u9053\u5f53\u524d\u8fd0\u884c\u7684\u662f\u4ec0\u4e48\u8fdb\u7a0b\uff0c\u6211\u4eec\u901a\u8fc7\u8c03\u7528 myproc \u51fd\u6570\u6765\u505a\u5230\u8fd9\u4e00\u70b9\u3002myproc \u51fd\u6570\u5b9e\u9645\u4e0a\u4f1a\u67e5\u627e\u4e00\u4e2a\u6839\u636e\u5f53\u524d CPU \u6838\u7684\u7f16\u53f7\u7d22\u5f15\u7684\u6570\u7ec4\uff0cCPU \u6838\u7684\u7f16\u53f7\u662f hartid\uff0c\u5982\u679c\u4f60\u8fd8\u8bb0\u5f97\uff0c\u6211\u4eec\u4e4b\u524d\u5728 uservec \u51fd\u6570\u4e2d\u5c06\u5b83\u5b58\u5728\u4e86 tp \u5bc4\u5b58\u5668\u3002\u8fd9\u662f myproc \u51fd\u6570\u627e\u51fa\u5f53\u524d\u8fd0\u884c\u8fdb\u7a0b\u7684\u65b9\u6cd5\u3002</p> </li> <li> <p>\u5f53\u7a0b\u5e8f\u8fd8\u5728\u5185\u6838\u4e2d\u6267\u884c\u65f6\uff0c\u6211\u4eec\u53ef\u80fd\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u5e76\u8fdb\u5165\u5230\u90a3\u4e2a\u7a0b\u5e8f\u7684\u7528\u6237\u7a7a\u95f4\uff0c\u7136\u540e\u90a3\u4e2a\u8fdb\u7a0b\u53ef\u80fd\u518d\u8c03\u7528\u4e00\u4e2a\u7cfb\u7edf\u8c03\u7528\u8fdb\u800c\u5bfc\u81f4 SEPC \u5bc4\u5b58\u5668\u7684\u5185\u5bb9\u88ab\u8986\u76d6\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u9700\u8981\u4fdd\u5b58\u5f53\u524d\u8fdb\u7a0b\u7684 SEPC \u5bc4\u5b58\u5668\u5230\u4e00\u4e2a\u4e0e\u8be5\u8fdb\u7a0b\u5173\u8054\u7684\u5185\u5b58\u4e2d</p> C<pre><code>p-&gt;trapframe-epc = r_sepc();\n</code></pre> </li> <li> <p>syscall</p> </li> <li> <p>\u6839\u636e\u7cfb\u7edf\u8c03\u7528\u7684\u7f16\u53f7\u67e5\u627e\u76f8\u5e94\u7684\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u3002Shell \u8c03\u7528\u7684 write \u51fd\u6570\u5c06 a7 \u8bbe\u7f6e\u6210\u4e86\u7cfb\u7edf\u8c03\u7528\u7f16\u53f7 16</p> </li> <li> <p>\u5411 trapframe \u4e2d\u7684 a0 \u8d4b\u503c\uff0c\u6240\u6709\u7684\u7cfb\u7edf\u8c03\u7528\u90fd\u6709\u4e00\u4e2a\u8fd4\u56de\u503c</p> </li> <li> <p>usertrapret</p> </li> <li> <p>\u5173\u95ed\u4e2d\u65ad</p> </li> <li>\u8bbe\u7f6e\u4e86 STVEC \u5bc4\u5b58\u5668\u6307\u5411 trampoline \u4ee3\u7801\uff0c\u5728\u90a3\u91cc\u6700\u7ec8\u4f1a\u6267\u884c sret \u6307\u4ee4\u8fd4\u56de\u5230\u7528\u6237\u7a7a\u95f4</li> <li>\u8bbe\u7f6e trapframe \u53c2\u6570\u4f9b\u4e0b\u4e00\u6b21 trap \u4f7f\u7528<ul> <li>\u5b58\u50a8\u4e86 kernel page table \u7684\u6307\u9488</li> <li>\u5b58\u50a8\u4e86\u5f53\u524d\u7528\u6237\u8fdb\u7a0b\u7684 kernel stack</li> <li>\u5b58\u50a8\u4e86 usertrap \u51fd\u6570\u7684\u6307\u9488\uff0c\u8fd9\u6837 trampoline \u4ee3\u7801\u624d\u80fd\u8df3\u8f6c\u5230\u8fd9\u4e2a\u51fd\u6570</li> <li>\u4ece tp \u5bc4\u5b58\u5668\u4e2d\u8bfb\u53d6\u5f53\u524d\u7684 CPU \u6838\u7f16\u53f7\uff0c\u5e76\u5b58\u50a8\u5728 trapframe \u4e2d\uff0c\u8fd9\u6837 trampoline \u4ee3\u7801\u624d\u80fd\u6062\u590d\u8fd9\u4e2a\u6570\u5b57\uff0c\u56e0\u4e3a\u7528\u6237\u4ee3\u7801\u53ef\u80fd\u4f1a\u4fee\u6539\u8fd9\u4e2a\u6570\u5b57</li> </ul> </li> <li>\u8bbe\u7f6e SSTATUS \u5bc4\u5b58\u5668</li> <li>SEPC \u5bc4\u5b58\u5668\u7684\u503c\u8bbe\u7f6e\u6210\u4e4b\u524d\u4fdd\u5b58\u7684\u7528\u6237\u7a0b\u5e8f\u8ba1\u6570\u5668\u7684\u503c</li> <li>\u6839\u636e user page table \u5730\u5740\u751f\u6210\u76f8\u5e94\u7684 SATP \u503c</li> <li>trapframe \u5730\u5740\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u53c2\u6570\uff1b\u5c06 page table \u6307\u9488\u51c6\u5907\u597d\uff0c\u5e76\u5c06\u8fd9\u4e2a\u6307\u9488\u4f5c\u4e3a\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4f20\u9012\u7ed9\u6c47\u7f16\u4ee3\u7801\uff0c\u8fd9\u4e2a\u53c2\u6570\u4f1a\u51fa\u73b0\u5728 a1 \u5bc4\u5b58\u5668\uff1bfn \u4e3a\u51fd\u6570\u8df3\u8f6c\u4f4d\u7f6e</li> </ul> C<pre><code>uint64 fn = TRAMPOLINE + (userret - trampoline);\n((void(*)(uint64,uint64))fn)(TRAPFRAME, satp);\n</code></pre> <ul> <li> <p>userret\uff0c\u4f4d\u4e8e trampoline.s \u6587\u4ef6</p> </li> <li> <p>\u5207\u6362\u4e3a\u7528\u6237\u9875\u8868</p> </li> <li> <p>\u4e4b\u524d\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\u7684\u503c\u52a0\u8f7d\u5230\u5bf9\u5e94\u7684\u5404\u4e2a\u5bc4\u5b58\u5668\u4e2d</p> </li> <li> <p>\u4ea4\u6362 SSCRATCH \u5bc4\u5b58\u5668\u548c a0 \u5bc4\u5b58\u5668\u7684\u503c\uff0c\u4fdd\u8bc1 SSCRATCH \u6301\u6709\u7684\u662f trapframe \u7684\u5730\u5740</p> </li> <li> <p>sret</p> <ul> <li>\u7a0b\u5e8f\u5207\u6362\u4e3a user mode</li> <li>SEPC \u7684\u503c\u62f7\u8d1d\u5230 PC</li> <li>\u5f00\u4e2d\u65ad</li> </ul> </li> </ul> <ul> <li>\u786c\u4ef6\u548c\u8f6f\u4ef6\u9700\u8981\u534f\u540c\u5de5\u4f5c\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u91cd\u65b0\u8bbe\u8ba1 XV6\uff0c\u91cd\u65b0\u8bbe\u8ba1 RISC-V \u6765\u4f7f\u5f97\u8fd9\u91cc\u7684\u5904\u7406\u6d41\u7a0b\u66f4\u52a0\u7b80\u5355\uff0c\u66f4\u52a0\u5feb\u901f\u3002</li> <li>\u53e6\u4e00\u4e2a\u9700\u8981\u65f6\u523b\u8bb0\u4f4f\u7684\u95ee\u9898\u662f\uff0c\u6076\u610f\u8f6f\u4ef6\u662f\u5426\u80fd\u6ee5\u7528\u8fd9\u91cc\u7684\u673a\u5236\u6765\u6253\u7834\u9694\u79bb\u6027\u3002</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/4-%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/","title":"4-\u7f3a\u9875\u4e2d\u65ad","text":"2023-09-112025-12-13 <code>#Operator System</code>","tags":["Operator System"]},{"location":"notes/6.s081/4-%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/#page-fault","title":"Page Fault","text":"<p> \u7ea6 976 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> <ul> <li> <p>\u901a\u8fc7 page fault \u53ef\u4ee5\u5b9e\u73b0\u7684\u4e00\u7cfb\u5217\u865a\u62df\u5185\u5b58\u529f\u80fd</p> </li> <li> <p>lazy allocation</p> </li> <li>copy-on-write fork</li> <li>demand paging</li> <li> <p>memory mapped files</p> </li> <li> <p>\u865a\u62df\u5185\u5b58\u597d\u5904</p> </li> <li> <p>isolation\uff0c\u9694\u79bb\u6027\uff1b\u865a\u62df\u5185\u5b58\u4f7f\u5f97\u64cd\u4f5c\u7cfb\u7edf\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u5c5e\u4e8e\u5b83\u4eec\u81ea\u5df1\u7684\u5730\u5740\u7a7a\u95f4</p> </li> <li> <p>level of indirection\uff0c\u63d0\u4f9b\u4e86\u4e00\u5c42\u62bd\u8c61\uff0c\u5904\u7406\u5668\u548c\u6240\u6709\u7684\u6307\u4ee4\u90fd\u53ef\u4ee5\u4f7f\u7528\u865a\u62df\u5730\u5740\uff0c\u5185\u6838\u4f1a\u5b9a\u4e49\u4ece\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\u5173\u7cfb</p> </li> <li> <p>page fault \u5f97\u5230\u7684\u4fe1\u606f</p> </li> <li> <p>\u5f15\u8d77 page fault \u7684\u5185\u5b58\u5730\u5740\uff08STVAL \u5bc4\u5b58\u5668\uff09</p> </li> <li>\u5f15\u8d77 page fault \u7684\u539f\u56e0\u7c7b\u578b\uff08SCAUSE \u5bc4\u5b58\u5668\uff09</li> <li>\u5f15\u8d77 page fault \u65f6\u7684\u7a0b\u5e8f\u8ba1\u6570\u5668\u503c\uff0c\u8fd9\u8868\u660e\u4e86 page fault \u5728\u7528\u6237\u7a7a\u95f4\u53d1\u751f\u7684\u4f4d\u7f6e\uff08SEPC \u5bc4\u5b58\u5668\u4e2d\uff0ctrapframe-&gt;epc\uff09</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/4-%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/#sbrk","title":"sbrk","text":"<ul> <li>\u5f53 sbrk \u5b9e\u9645\u53d1\u751f\u6216\u8005\u88ab\u8c03\u7528\u7684\u65f6\u5019\uff0c\u5185\u6838\u4f1a\u5206\u914d\u4e00\u4e9b\u7269\u7406\u5185\u5b58\uff0c\u5e76\u5c06\u8fd9\u4e9b\u5185\u5b58\u6620\u5c04\u5230\u7528\u6237\u5e94\u7528\u7a0b\u5e8f\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u7136\u540e\u5c06\u5185\u5b58\u5185\u5bb9\u521d\u59cb\u5316\u4e3a 0\uff0c\u518d\u8fd4\u56de sbrk \u7cfb\u7edf\u8c03\u7528\u3002\u8fd9\u6837\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u901a\u8fc7\u591a\u6b21 sbrk \u7cfb\u7edf\u8c03\u7528\u6765\u589e\u52a0\u5b83\u6240\u9700\u8981\u7684\u5185\u5b58\u3002\u7c7b\u4f3c\u7684\uff0c\u5e94\u7528\u7a0b\u5e8f\u8fd8\u53ef\u4ee5\u901a\u8fc7\u7ed9 sbrk \u4f20\u5165\u8d1f\u6570\u4f5c\u4e3a\u53c2\u6570\uff0c\u6765\u51cf\u5c11\u6216\u8005\u538b\u7f29\u5b83\u7684\u5730\u5740\u7a7a\u95f4\u3002</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/4-%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/#lazy-allocation","title":"lazy allocation","text":"<ul> <li>sbrk \u7cfb\u7edf\u8c03\u57fa\u672c\u4e0a\u4e0d\u505a\u4efb\u4f55\u4e8b\u60c5\uff0c\u552f\u4e00\u9700\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u63d0\u5347p-&gt;sz\uff0c\u5c06p-&gt;sz\u589e\u52a0 n\uff0c\u5176\u4e2d n \u662f\u9700\u8981\u65b0\u5206\u914d\u7684\u5185\u5b58 page \u6570\u91cf\u3002\u4f46\u662f\u5185\u6838\u5728\u8fd9\u4e2a\u65f6\u95f4\u70b9\u5e76\u4e0d\u4f1a\u5206\u914d\u4efb\u4f55\u7269\u7406\u5185\u5b58\u3002</li> <li>\u4e4b\u540e\u5728\u67d0\u4e2a\u65f6\u95f4\u70b9\uff0c\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u5230\u4e86\u65b0\u7533\u8bf7\u7684\u90a3\u90e8\u5206\u5185\u5b58\uff0c\u8fd9\u65f6\u4f1a\u89e6\u53d1 page fault\uff0c\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u5c06\u65b0\u7684\u5185\u5b58\u6620\u5c04\u5230 page table\u3002</li> <li>\u6240\u4ee5\uff0c\u5982\u679c\u6211\u4eec\u89e3\u6790\u4e00\u4e2a\u5927\u4e8e\u65e7\u7684p-&gt;sz\uff0c\u4f46\u662f\u53c8\u5c0f\u4e8e\u65b0\u7684*p-&gt;sz\uff08\u6ce8\uff0c\u4e5f\u5c31\u662f\u65e7\u7684 p-&gt;sz + n\uff09*\u7684\u865a\u62df\u5730\u5740\uff0c\u6211\u4eec\u5e0c\u671b\u5185\u6838\u80fd\u591f\u5206\u914d\u4e00\u4e2a\u5185\u5b58 page\uff0c\u5e76\u4e14\u91cd\u65b0\u6267\u884c\u6307\u4ee4\u3002</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/4-%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/#zero-fill-on-demand","title":"Zero Fill On Demand","text":"<ul> <li> <p>\u5728\u4e00\u4e2a\u6b63\u5e38\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u5982\u679c\u6267\u884c exec\uff0cexec \u4f1a\u7533\u8bf7\u5730\u5740\u7a7a\u95f4\uff0c\u91cc\u9762\u4f1a\u5b58\u653e text \u548c data\u3002\u56e0\u4e3a BSS \u91cc\u9762\u4fdd\u5b58\u4e86\u672a\u88ab\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\uff0c\u8fd9\u91cc\u6216\u8bb8\u6709\u8bb8\u591a\u8bb8\u591a\u4e2a page\uff0c\u4f46\u662f\u6240\u6709\u7684 page \u5185\u5bb9\u90fd\u4e3a 0\u3002</p> </li> <li> <p>\u901a\u5e38\u53ef\u4ee5\u8c03\u4f18\u7684\u5730\u65b9\u662f\uff0c\u6211\u6709\u5982\u6b64\u591a\u7684\u5185\u5bb9\u5168\u662f 0 \u7684 page\uff0c\u5728\u7269\u7406\u5185\u5b58\u4e2d\uff0c\u6211\u53ea\u9700\u8981\u5206\u914d\u4e00\u4e2a page\uff0c\u8fd9\u4e2a page \u7684\u5185\u5bb9\u5168\u662f 0\u3002\u7136\u540e\u5c06\u6240\u6709\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7684\u5168 0 \u7684 page \u90fd map \u5230\u8fd9\u4e00\u4e2a\u7269\u7406 page \u4e0a\u3002\u8fd9\u6837\u81f3\u5c11\u5728\u7a0b\u5e8f\u542f\u52a8\u7684\u65f6\u5019\u80fd\u8282\u7701\u5927\u91cf\u7684\u7269\u7406\u5185\u5b58\u5206\u914d\u3002</p> </li> <li> <p>\u53ea\u6709 BSS \u8fdb\u884c\u4fee\u6539\u624d\u91cd\u65b0\u5206\u914d\u4e00\u4e2a\u65b0\u7684\u9875\u9762</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/4-%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/#copy-on-write-fork","title":"Copy-on-Write Fork","text":"<ul> <li>\u521b\u5efa\u5b50\u8fdb\u7a0b\u65f6\uff0c\u76f4\u63a5\u5171\u4eab\u7236\u8fdb\u7a0b\u7684\u7269\u7406\u5185\u5b58 page\\</li> <li>\u66f4\u6539\u5185\u5bb9\u65f6\uff0c\u89e6\u53d1 page fault\uff0c\u5f97\u5230 page fault \u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u62f7\u8d1d\u76f8\u5e94\u7684\u7269\u7406 page</li> <li>\u9700\u8981\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u7269\u7406\u5185\u5b58 page \u7684\u5f15\u7528\u8fdb\u884c\u8ba1\u6570\uff0c\u5f53\u6211\u4eec\u91ca\u653e\u865a\u62df page \u65f6\uff0c\u6211\u4eec\u5c06\u7269\u7406\u5185\u5b58 page \u7684\u5f15\u7528\u6570\u51cf 1\uff0c\u5982\u679c\u5f15\u7528\u6570\u7b49\u4e8e 0\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u80fd\u91ca\u653e\u7269\u7406\u5185\u5b58 page</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/4-%E7%BC%BA%E9%A1%B5%E4%B8%AD%E6%96%AD/#memory-mapped-files","title":"Memory Mapped Files","text":"<ul> <li> <p>\u4e2a\u73b0\u4ee3\u7684\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u53eb\u505a mmap \u7684\u7cfb\u7edf\u8c03\u7528\u3002\u8fd9\u4e2a\u7cfb\u7edf\u8c03\u7528\u4f1a\u63a5\u6536\u4e00\u4e2a\u865a\u62df\u5185\u5b58\u5730\u5740\uff08VA\uff09\uff0c\u957f\u5ea6\uff08len\uff09\uff0cprotection\uff0c\u4e00\u4e9b\u6807\u5fd7\u4f4d\uff0c\u4e00\u4e2a\u6253\u5f00\u6587\u4ef6\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u548c\u504f\u79fb\u91cf\uff08offset\uff09</p> </li> <li> <p>\u4ece\u6587\u4ef6\u63cf\u8ff0\u7b26\u5bf9\u5e94\u7684\u6587\u4ef6\u7684\u504f\u79fb\u91cf\u7684\u4f4d\u7f6e\u5f00\u59cb\uff0c\u6620\u5c04\u957f\u5ea6\u4e3a len \u7684\u5185\u5bb9\u5230\u865a\u62df\u5185\u5b58\u5730\u5740 VA</p> </li> <li> <p>\u4fe1\u606f\u5728 VMA\uff08virtual memory area\uff09\u4e2d\u5b58\u50a8\uff1b\u5f53\u6211\u4eec\u5f97\u5230\u4e00\u4e2a\u4f4d\u4e8e VMA \u5730\u5740\u8303\u56f4\u7684 page fault \u65f6\uff0c\u5185\u6838\u53ef\u4ee5\u4ece\u78c1\u76d8\u4e2d\u8bfb\u6570\u636e\uff0c\u5e76\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u3002</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/","title":"5-\u786c\u4ef6\u4e2d\u65ad","text":"2023-09-112025-12-13 <code>#Operator System</code>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#interrupts","title":"Interrupts","text":"<p> \u7ea6 1622 \u4e2a\u5b57  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 8 \u5206\u949f</p> <ul> <li>\u4e2d\u65ad\u4e0e\u7cfb\u7edf\u8c03\u7528\u533a\u522b</li> <li>asynchronous\uff0c\u5f02\u6b65\uff0c\u4e0e\u5f53\u524d\u8fd0\u884c\u5728 CPU \u7684\u8fdb\u7a0b\u65e0\u5173</li> <li>concurrency\uff0cCPU \u548c\u4ea7\u751f\u4e2d\u65ad\u7684\u8bbe\u5907\u5e76\u884c\u8fd0\u884c</li> <li>program device\uff0c\u9700\u8981\u5173\u6ce8\u5916\u90e8\u8bbe\u5907</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#_1","title":"\u4e2d\u65ad\u5904\u7406\u2014\u2014\u786c\u4ef6","text":"<ul> <li>PLIC \u4f1a\u901a\u77e5\u5f53\u524d\u6709\u4e00\u4e2a\u5f85\u5904\u7406\u7684\u4e2d\u65ad</li> <li>\u5176\u4e2d\u4e00\u4e2a CPU \u6838\u4f1a Claim \u63a5\u6536\u4e2d\u65ad\uff0c\u8fd9\u6837 PLIC \u5c31\u4e0d\u4f1a\u628a\u4e2d\u65ad\u53d1\u7ed9\u5176\u4ed6\u7684 CPU \u5904\u7406</li> <li>CPU \u6838\u5904\u7406\u5b8c\u4e2d\u65ad\u4e4b\u540e\uff0cCPU \u4f1a\u901a\u77e5 PLIC</li> <li>PLIC \u5c06\u4e0d\u518d\u4fdd\u5b58\u4e2d\u65ad\u7684\u4fe1\u606f</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#_2","title":"\u4e2d\u65ad\u5904\u7406\u2014\u2014\u8f6f\u4ef6","text":"<p>\u4f7f\u7528\u9a71\u52a8\u7ba1\u7406\u8bbe\u5907</p> <ul> <li> <p>bottom\uff1a\u901a\u5e38\u662f Interrupt handler\u3002\u5f53\u4e00\u4e2a\u4e2d\u65ad\u9001\u5230\u4e86 CPU\uff0c\u5e76\u4e14 CPU \u8bbe\u7f6e\u63a5\u6536\u8fd9\u4e2a\u4e2d\u65ad\uff0cCPU \u4f1a\u8c03\u7528\u76f8\u5e94\u7684 Interrupt handler\u3002Interrupt handler \u5e76\u4e0d\u8fd0\u884c\u5728\u4efb\u4f55\u7279\u5b9a\u8fdb\u7a0b\u7684 context \u4e2d\uff0c\u5b83\u53ea\u662f\u5904\u7406\u4e2d\u65ad\u3002</p> </li> <li> <p>top\uff1a\u662f\u7528\u6237\u8fdb\u7a0b\uff0c\u6216\u8005\u5185\u6838\u7684\u5176\u4ed6\u90e8\u5206\u8c03\u7528\u7684\u63a5\u53e3\u3002\u5bf9\u4e8e UART \u6765\u8bf4\uff0c\u8fd9\u91cc\u6709 read/write \u63a5\u53e3\uff0c\u8fd9\u4e9b\u63a5\u53e3\u53ef\u4ee5\u88ab\u66f4\u9ad8\u5c42\u7ea7\u7684\u4ee3\u7801\u8c03\u7528\u3002</p> </li> <li> <p>\u9a71\u52a8\u4e2d\u4f1a\u6709\u4e00\u4e9b\u961f\u5217\uff08\u6216\u8005\u8bf4 buffer\uff09\uff0ctop \u90e8\u5206\u7684\u4ee3\u7801\u4f1a\u4ece\u961f\u5217\u4e2d\u8bfb\u5199\u6570\u636e\uff0c\u800c Interrupt handler\uff08bottom \u90e8\u5206\uff09\u540c\u65f6\u4e5f\u4f1a\u5411\u961f\u5217\u4e2d\u8bfb\u5199\u6570\u636e\u3002\u8fd9\u91cc\u7684\u961f\u5217\u53ef\u4ee5\u5c06\u5e76\u884c\u8fd0\u884c\u7684\u8bbe\u5907\u548c CPU \u89e3\u8026\u5f00\u6765</p> </li> </ul> <p></p> <ul> <li>\u6211\u4eec\u901a\u8fc7 load \u5c06\u6570\u636e\u5199\u5165\u5230 Transmit Holding Register \u4e2d\uff0c\u4e4b\u540e UART \u82af\u7247\u4f1a\u901a\u8fc7\u4e32\u53e3\u7ebf\u5c06\u8fd9\u4e2a Byte \u9001\u51fa\u3002\u5f53\u5b8c\u6210\u4e86\u53d1\u9001\uff0cUART \u4f1a\u751f\u6210\u4e00\u4e2a\u4e2d\u65ad\u7ed9\u5185\u6838\uff0c\u8fd9\u4e2a\u65f6\u5019\u624d\u80fd\u518d\u6b21\u5199\u5165\u4e0b\u4e00\u4e2a\u6570\u636e\u3002</li> <li>\u6240\u4ee5\u5185\u6838\u548c\u8bbe\u5907\u4e4b\u95f4\u9700\u8981\u9075\u5b88\u4e00\u4e9b\u534f\u8bae\u624d\u80fd\u786e\u4fdd\u4e00\u5207\u5de5\u4f5c\u6b63\u5e38\u3002\u4e0a\u56fe\u4e2d\u7684 UART \u82af\u7247\u4f1a\u6709\u4e00\u4e2a\u5bb9\u91cf\u662f 16 \u7684 FIFO\uff0c\u4f46\u662f\u4f60\u8fd8\u662f\u8981\u5c0f\u5fc3\uff0c\u56e0\u4e3a\u5982\u679c\u963b\u585e\u4e86 16 \u4e2a Byte \u4e4b\u540e\u518d\u6b21\u5199\u5165\u8fd8\u662f\u4f1a\u9020\u6210\u6570\u636e\u8986\u76d6</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#_3","title":"\u952e\u5165\u5b57\u7b26\u4e2d\u65ad\u8fc7\u7a0b","text":"<ul> <li>\u7528\u6237\u8f93\u5165\u7684\u5b57\u7b26\u3002\u952e\u76d8\u8fde\u63a5\u5230\u4e86 UART \u7684\u8f93\u5165\u7ebf\u8def\uff0c\u5f53\u4f60\u5728\u952e\u76d8\u4e0a\u6309\u4e0b\u4e00\u4e2a\u6309\u952e\uff0cUART \u82af\u7247\u4f1a\u5c06\u6309\u952e\u5b57\u7b26\u901a\u8fc7\u4e32\u53e3\u7ebf\u53d1\u9001\u5230\u53e6\u4e00\u7aef\u7684 UART \u82af\u7247\u3002</li> <li>\u53e6\u4e00\u7aef\u7684 UART \u82af\u7247\u5148\u5c06\u6570\u636e bit \u5408\u5e76\u6210\u4e00\u4e2a Byte\uff0c\u4e4b\u540e\u518d\u4ea7\u751f\u4e00\u4e2a\u4e2d\u65ad\uff0c\u5e76\u544a\u8bc9\u5904\u7406\u5668\u8bf4\u8fd9\u91cc\u6709\u4e00\u4e2a\u6765\u81ea\u4e8e\u952e\u76d8\u7684\u5b57\u7b26\u3002\u4e4b\u540e Interrupt handler \u4f1a\u5904\u7406\u6765\u81ea\u4e8e UART \u7684\u5b57\u7b26\u3002</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#_4","title":"\u4e2d\u65ad\u76f8\u5173\u5bc4\u5b58\u5668","text":"<ul> <li> <p>SIE\uff0c\u5bc4\u5b58\u5668\u4e2d\u6709\u4e00\u4e2a bit\uff08E\uff09\u4e13\u95e8\u9488\u5bf9\u4f8b\u5982 UART \u7684\u5916\u90e8\u8bbe\u5907\u7684\u4e2d\u65ad\uff1b\u6709\u4e00\u4e2a bit\uff08S\uff09\u4e13\u95e8\u9488\u5bf9\u8f6f\u4ef6\u4e2d\u65ad\uff0c\u8f6f\u4ef6\u4e2d\u65ad\u53ef\u80fd\u7531\u4e00\u4e2a CPU \u6838\u89e6\u53d1\u7ed9\u53e6\u4e00\u4e2a CPU \u6838\uff1b\u8fd8\u6709\u4e00\u4e2a bit\uff08T\uff09\u4e13\u95e8\u9488\u5bf9\u5b9a\u65f6\u5668\u4e2d\u65ad</p> </li> <li> <p>SSTATUS\uff1a\u6709\u4e00\u4e2a bit \u6765\u6253\u5f00\u6216\u8005\u5173\u95ed\u4e2d\u65ad\u3002\u6bcf\u4e00\u4e2a CPU \u6838\u90fd\u6709\u72ec\u7acb\u7684 SIE \u548c SSTATUS \u5bc4\u5b58\u5668\uff0c\u9664\u4e86\u901a\u8fc7 SIE \u5bc4\u5b58\u5668\u6765\u5355\u72ec\u63a7\u5236\u7279\u5b9a\u7684\u4e2d\u65ad\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 SSTATUS \u5bc4\u5b58\u5668\u4e2d\u7684\u4e00\u4e2a bit \u6765\u63a7\u5236\u6240\u6709\u7684\u4e2d\u65ad\u3002</p> </li> <li> <p>SIP\uff08Supervisor Interrupt Pending\uff09\u5bc4\u5b58\u5668\u3002\u5f53\u53d1\u751f\u4e2d\u65ad\u65f6\uff0c\u5904\u7406\u5668\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b\u8fd9\u4e2a\u5bc4\u5b58\u5668\u77e5\u9053\u5f53\u524d\u662f\u4ec0\u4e48\u7c7b\u578b\u7684\u4e2d\u65ad\u3002</p> </li> <li> <p>SCAUSE \u5bc4\u5b58\u5668\uff0c\u8fd9\u4e2a\u5bc4\u5b58\u5668\u6211\u4eec\u4e4b\u524d\u770b\u8fc7\u5f88\u591a\u6b21\u3002\u5b83\u4f1a\u8868\u660e\u5f53\u524d\u72b6\u6001\u7684\u539f\u56e0\u3002</p> </li> <li> <p>STVEC \u5bc4\u5b58\u5668\uff0c\u5b83\u4f1a\u4fdd\u5b58\u5f53 trap\uff0cpage fault \u6216\u8005\u4e2d\u65ad\u53d1\u751f\u65f6\uff0cCPU \u8fd0\u884c\u7684\u7528\u6237\u7a0b\u5e8f\u7684\u7a0b\u5e8f\u8ba1\u6570\u5668\uff0c\u8fd9\u6837\u624d\u80fd\u5728\u7a0d\u540e\u6062\u590d\u7a0b\u5e8f\u7684\u8fd0\u884c\u3002</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#_5","title":"\u63a7\u5236\u53f0\u521d\u59cb\u5316","text":"<ul> <li> <p>uartinit \u51fd\u6570\uff0c\u5173\u95ed\u4e2d\u65ad\uff0c\u8bbe\u7f6e\u6ce2\u7279\u7387\uff0c\u8bbe\u7f6e\u5b57\u7b26\u957f\u5ea6\u4e3a 8bit\uff0c\u91cd\u7f6e FIFO\uff0c\u6700\u540e\u91cd\u65b0\u6253\u5f00\u4e2d\u65ad</p> </li> <li> <p>\u9700\u8981\u8ba9\u4e2d\u65ad\u88ab CPU \u611f\u77e5\uff0c\u9700\u8981\u8c03\u7528 plicinit \u51fd\u6570</p> </li> <li> <p>PLIC \u4e0e\u5916\u8bbe\u4e00\u6837\uff0c\u4e5f\u5360\u7528\u4e86\u4e00\u4e2a I/O \u5730\u5740\uff080xC000_0000</p> </li> <li> <p>plicinithart \u51fd\u6570\u3002</p> </li> <li> <p>plicinit \u662f\u7531 0 \u53f7 CPU \u8fd0\u884c\uff0c\u4e4b\u540e\uff0c\u6bcf\u4e2a CPU \u7684\u6838\u90fd\u9700\u8981\u8c03\u7528 plicinithart \u51fd\u6570\u8868\u660e\u5bf9\u4e8e\u54ea\u4e9b\u5916\u8bbe\u4e2d\u65ad\u611f\u5174\u8da3\u3002</p> </li> <li> <p>\u6bcf\u4e2a CPU \u7684\u6838\u90fd\u8868\u660e\u81ea\u5df1\u5bf9\u6765\u81ea\u4e8e UART \u548c VIRTIO \u7684\u4e2d\u65ad\u611f\u5174\u8da3\u3002\u56e0\u4e3a\u6211\u4eec\u5ffd\u7565\u4e2d\u65ad\u7684\u4f18\u5148\u7ea7\uff0c\u6240\u4ee5\u6211\u4eec\u5c06\u4f18\u5148\u7ea7\u8bbe\u7f6e\u4e3a 0</p> </li> <li> <p>\u8bbe\u7f6e SSTATUS \u5bc4\u5b58\u5668\uff0c\u63a5\u6536\u4e2d\u65ad</p> </li> <li> <p>scheduler \u51fd\u6570\u4e2d\u5f00\u4e2d\u65ad</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#uart-driver-top","title":"uart driver top","text":"<ul> <li> <p>consolewrite()</p> </li> <li> <p>either_copyin \u5c06\u5b57\u7b26\u62f7\u5165\uff0c\u4e4b\u540e\u8c03\u7528 uartputc \u51fd\u6570\u3002uartputc \u51fd\u6570\u5c06\u5b57\u7b26\u5199\u5165\u7ed9 UART \u8bbe\u5907\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u8ba4\u4e3a consolewrite \u662f\u4e00\u4e2a UART \u9a71\u52a8\u7684 top \u90e8\u5206</p> </li> <li> <p>\u5728 UART \u7684\u5185\u90e8\u4f1a\u6709\u4e00\u4e2a buffer \u7528\u6765\u53d1\u9001\u6570\u636e\uff0cbuffer \u7684\u5927\u5c0f\u662f 32 \u4e2a\u5b57\u7b26\u3002\u540c\u65f6\u8fd8\u6709\u4e00\u4e2a\u4e3a consumer \u63d0\u4f9b\u7684\u8bfb\u6307\u9488\u548c\u4e3a producer \u63d0\u4f9b\u7684\u5199\u6307\u9488\uff0c\u6765\u6784\u5efa\u4e00\u4e2a\u73af\u5f62\u7684 buffer</p> </li> <li> <p>uartstart()</p> </li> <li> <p>\u9996\u5148\u662f\u68c0\u67e5\u5f53\u524d\u8bbe\u5907\u662f\u5426\u7a7a\u95f2\uff0c\u5982\u679c\u7a7a\u95f2\u7684\u8bdd\uff0c\u6211\u4eec\u4f1a\u4ece buffer \u4e2d\u8bfb\u51fa\u6570\u636e\uff0c\u7136\u540e\u5c06\u6570\u636e\u5199\u5165\u5230 THR\uff08Transmission Holding Register\uff09\u53d1\u9001\u5bc4\u5b58\u5668\u3002\u8fd9\u91cc\u76f8\u5f53\u4e8e\u544a\u8bc9\u8bbe\u5907\uff0c\u6211\u8fd9\u91cc\u6709\u4e00\u4e2a\u5b57\u8282\u9700\u8981\u4f60\u6765\u53d1\u9001\u3002</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#uart-driver-bottom","title":"uart driver bottom","text":"<ul> <li> <p>plic_claim \u51fd\u6570\u4f4d\u4e8e plic.c \u6587\u4ef6\u4e2d\u3002\u5728\u8fd9\u4e2a\u51fd\u6570\u4e2d\uff0c\u5f53\u524d CPU \u6838\u4f1a\u544a\u77e5 PLIC\uff0c\u81ea\u5df1\u8981\u5904\u7406\u4e2d\u65ad\uff0cPLIC_SCLAIM \u4f1a\u5c06\u4e2d\u65ad\u53f7\u8fd4\u56de\uff0c\u5bf9\u4e8e UART \u6765\u8bf4\uff0c\u8fd4\u56de\u7684\u4e2d\u65ad\u53f7\u662f 10\u3002</p> </li> <li> <p>\u4f4d\u4e8e uart.c \u6587\u4ef6\u7684 uartintr \u51fd\u6570\uff0c\u4f1a\u4ece UART \u7684\u63a5\u53d7\u5bc4\u5b58\u5668\u4e2d\u8bfb\u53d6\u6570\u636e\uff0c\u4e4b\u540e\u5c06\u83b7\u53d6\u5230\u7684\u6570\u636e\u4f20\u9012\u7ed9 consoleintr \u51fd\u6570\u3002\u6ca1\u6709\u901a\u8fc7\u952e\u76d8\u8f93\u5165\u4efb\u4f55\u6570\u636e\uff0c\u6240\u4ee5 UART \u7684\u63a5\u53d7\u5bc4\u5b58\u5668\u4e3a\u7a7a\uff0c\u8c03\u7528 uartstart \u5c06 buffer \u4e2d\u7684\u5b57\u7b26\u9001\u51fa</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#_6","title":"\u4e2d\u65ad\u5e76\u53d1","text":"<ul> <li>\u8bbe\u5907\u548c CPU \u5e76\u884c\uff0c\u5f53 UART \u5411 Console \u53d1\u9001\u5b57\u7b26\u7684\u65f6\u5019\uff0cCPU \u4f1a\u8fd4\u56de\u6267\u884c Shell\uff0c\u800c Shell \u53ef\u80fd\u4f1a\u518d\u6267\u884c\u4e00\u6b21\u7cfb\u7edf\u8c03\u7528\uff0c\u5411 buffer \u4e2d\u5199\u5165\u53e6\u4e00\u4e2a\u5b57\u7b26\uff0c\u8fd9\u4e9b\u90fd\u662f\u5728\u5e76\u884c\u7684\u6267\u884c\u3002\u8fd9\u91cc\u7684\u5e76\u884c\u79f0\u4e3a producer-consumer \u5e76\u884c\u3002</li> <li>\u4e2d\u65ad\u505c\u6b62\u8fd0\u884c\u5f53\u524d\u7a0b\u5e8f\uff0c\u5982\u679c\u4e0d\u80fd\u5728\u6267\u884c\u671f\u95f4\u88ab\u4e2d\u65ad\uff0c\u8fd9\u65f6\u5185\u6838\u9700\u8981\u4e34\u65f6\u5173\u95ed\u4e2d\u65ad\uff0c\u6765\u786e\u4fdd\u8fd9\u6bb5\u4ee3\u7801\u7684\u539f\u5b50\u6027</li> <li>\u9a71\u52a8\u7684 top \u548c bottom \u90e8\u5206\u662f\u5e76\u884c\u8fd0\u884c\u7684\uff0c\u6240\u4ee5\u4e00\u4e2a\u9a71\u52a8\u7684 top \u548c bottom \u90e8\u5206\u53ef\u4ee5\u5e76\u884c\u7684\u5728\u4e0d\u540c\u7684 CPU \u4e0a\u8fd0\u884c\u3002\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 lock \u6765\u7ba1\u7406\u5e76\u884c\u3002\u56e0\u4e3a\u8fd9\u91cc\u6709\u5171\u4eab\u7684\u6570\u636e\uff0c\u6211\u4eec\u60f3\u8981 buffer \u5728\u4e00\u4e2a\u65f6\u95f4\u53ea\u88ab\u4e00\u4e2a CPU \u6838\u6240\u64cd\u4f5c</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/5-%E7%A1%AC%E4%BB%B6%E4%B8%AD%E6%96%AD/#producer-consumer","title":"producer-consumer \u5e76\u53d1","text":"<ul> <li> <p>producer \u53ef\u4ee5\u4e00\u76f4\u5199\u5165\u6570\u636e\uff0c\u76f4\u5230\u5199\u6307\u9488 + 1 \u7b49\u4e8e\u8bfb\u6307\u9488</p> </li> <li> <p>uartintr \u51fd\u6570\u662f consumer\uff0c\u6bcf\u5f53\u6709\u4e00\u4e2a\u4e2d\u65ad\uff0c\u5e76\u4e14\u8bfb\u6307\u9488\u843d\u540e\u4e8e\u5199\u6307\u9488\uff0cuartintr \u51fd\u6570\u5c31\u4f1a\u4ece\u8bfb\u6307\u9488\u4e2d\u8bfb\u53d6\u4e00\u4e2a\u5b57\u7b26\u518d\u901a\u8fc7 UART \u8bbe\u5907\u53d1\u9001\uff0c\u5e76\u4e14\u5c06\u8bfb\u6307\u9488\u52a0 1</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/6-%E5%A4%9A%E6%A0%B8%E5%92%8C%E9%94%81/","title":"6-\u591a\u6838\u548c\u9501","text":"2023-09-112025-12-13 <code>#Operator System</code>","tags":["Operator System"]},{"location":"notes/6.s081/6-%E5%A4%9A%E6%A0%B8%E5%92%8C%E9%94%81/#multiprocessor-and-lock","title":"Multiprocessor and Lock","text":"<p> \u7ea6 1172 \u4e2a\u5b57  95 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> <ul> <li> <p>\u9501\u5c31\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u5c31\u50cf\u5176\u4ed6\u5728\u5185\u6838\u4e2d\u7684\u5bf9\u8c61\u4e00\u6837\u3002\u6709\u4e00\u4e2a\u7ed3\u6784\u4f53\u53eb\u505a lock\uff0c\u5b83\u5305\u542b\u4e86\u4e00\u4e9b\u5b57\u6bb5\uff0c\u8fd9\u4e9b\u5b57\u6bb5\u4e2d\u7ef4\u62a4\u4e86\u9501\u7684\u72b6\u6001\u3002\u9501\u6709\u975e\u5e38\u76f4\u89c2\u7684 API\uff1a</p> </li> <li> <p>acquire\uff0c\u63a5\u6536\u6307\u5411 lock \u7684\u6307\u9488\u4f5c\u4e3a\u53c2\u6570\u3002acquire \u786e\u4fdd\u4e86\u5728\u4efb\u4f55\u65f6\u95f4\uff0c\u53ea\u4f1a\u6709\u4e00\u4e2a\u8fdb\u7a0b\u80fd\u591f\u6210\u529f\u7684\u83b7\u53d6\u9501\u3002</p> </li> <li> <p>release\uff0c\u4e5f\u63a5\u6536\u6307\u5411 lock \u7684\u6307\u9488\u4f5c\u4e3a\u53c2\u6570\u3002\u5728\u540c\u4e00\u65f6\u95f4\u5c1d\u8bd5\u83b7\u53d6\u9501\u7684\u5176\u4ed6\u8fdb\u7a0b\u9700\u8981\u7b49\u5f85\uff0c\u76f4\u5230\u6301\u6709\u9501\u7684\u8fdb\u7a0b\u5bf9\u9501\u8c03\u7528 release\u3002</p> </li> <li> <p>\u9501\u5e94\u8be5\u4e0e\u64cd\u4f5c\u800c\u4e0d\u662f\u6570\u636e\u5173\u8054\uff0c\u6240\u4ee5\u81ea\u52a8\u52a0\u9501\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\u4f1a\u51fa\u95ee\u9898</p> </li> <li> <p>\u60f3\u8981\u7a0b\u5e8f\u7b80\u5355\u70b9\uff0c\u53ef\u4ee5\u901a\u8fc7 coarse-grain locking\uff08\u6ce8\uff0c\u4e5f\u5c31\u662f\u5927\u9501\uff09\uff0c\u4f46\u662f\u8fd9\u65f6\u4f60\u5c31\u5931\u53bb\u4e86\u6027\u80fd</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/6-%E5%A4%9A%E6%A0%B8%E5%92%8C%E9%94%81/#_1","title":"\u9501\u7684\u7279\u6027","text":"<ul> <li>\u907f\u514d\u4e22\u5931\u66f4\u65b0</li> <li>\u9501\u53ef\u4ee5\u6253\u5305\u591a\u4e2a\u64cd\u4f5c\uff0c\u4f7f\u5b83\u4eec\u5177\u6709\u539f\u5b50\u6027</li> <li>\u53ef\u4ee5\u7ef4\u62a4\u5171\u4eab\u6570\u636e\u7ed3\u6784\u7684\u4e0d\u53d8\u6027</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/6-%E5%A4%9A%E6%A0%B8%E5%92%8C%E9%94%81/#challenge","title":"challenge","text":"<ul> <li> <p>\u6b7b\u9501</p> </li> <li> <p>\u7834\u574f\u4e86\u7a0b\u5e8f\u7684\u6a21\u5757\u5316</p> </li> <li> <p>\u901a\u5e38\u6765\u8bf4\uff0c\u5f00\u53d1\u7684\u6d41\u7a0b\u662f\uff1a</p> </li> <li> <p>\u5148\u4ee5 coarse-grained lock\uff08\u6ce8\uff0c\u4e5f\u5c31\u662f\u5927\u9501\uff09\u5f00\u59cb\u3002</p> </li> <li>\u518d\u5bf9\u7a0b\u5e8f\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6765\u770b\u4e00\u4e0b\u7a0b\u5e8f\u662f\u5426\u80fd\u4f7f\u7528\u591a\u6838\u3002</li> <li>\u5982\u679c\u53ef\u4ee5\u7684\u8bdd\uff0c\u90a3\u4e48\u5de5\u4f5c\u5c31\u7ed3\u675f\u4e86\uff0c\u4f60\u5bf9\u4e8e\u9501\u7684\u8bbe\u8ba1\u8db3\u591f\u597d\u4e86\uff1b\u5982\u679c\u4e0d\u53ef\u4ee5\u7684\u8bdd\uff0c\u90a3\u610f\u5473\u7740\u9501\u5b58\u5728\u7ade\u4e89\uff0c\u591a\u4e2a\u8fdb\u7a0b\u4f1a\u5c1d\u8bd5\u83b7\u53d6\u540c\u4e00\u4e2a\u9501\uff0c\u56e0\u6b64\u5b83\u4eec\u5c06\u4f1a\u5e8f\u5217\u5316\u7684\u6267\u884c\uff0c\u6027\u80fd\u4e5f\u4e0a\u4e0d\u53bb\uff0c\u4e4b\u540e\u4f60\u5c31\u9700\u8981\u91cd\u6784\u7a0b\u5e8f\u3002</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/6-%E5%A4%9A%E6%A0%B8%E5%92%8C%E9%94%81/#uart","title":"uart \u4e2d\u7684\u9501","text":"<ul> <li>\u5411 buffer \u4e2d\u5199\u5165\u6570\u636e\u65f6\u52a0\u9501</li> </ul> C<pre><code>void\nuartputc(int c)\n{\n  acquire(&amp;uart_tx_lock);\n\n  if(panicked){\n    for(;;)\n      ;\n  }\n  while(uart_tx_w == uart_tx_r + UART_TX_BUF_SIZE){\n    // buffer is full.\n    // wait for uartstart() to open up space in the buffer.\n    sleep(&amp;uart_tx_r, &amp;uart_tx_lock);\n  }\n  uart_tx_buf[uart_tx_w % UART_TX_BUF_SIZE] = c;\n  uart_tx_w += 1;\n  uartstart();\n  release(&amp;uart_tx_lock);\n}\n</code></pre> <ul> <li>\u5f53 UART \u786c\u4ef6\u5b8c\u6210\u4f20\u8f93\uff0c\u4f1a\u4ea7\u751f\u4e00\u4e2a\u4e2d\u65ad\u3002\u5728\u524d\u9762\u7684\u4ee3\u7801\u4e2d\u6211\u4eec\u77e5\u9053\u4e86 uartstart \u7684\u8c03\u7528\u8005\u4f1a\u83b7\u5f97\u9501\u4ee5\u786e\u4fdd\u4e0d\u4f1a\u6709\u591a\u4e2a\u8fdb\u7a0b\u540c\u65f6\u5411 THR \u5bc4\u5b58\u5668\u5199\u6570\u636e\u3002\u4f46\u662f UART \u4e2d\u65ad\u672c\u8eab\u4e5f\u53ef\u80fd\u4e0e\u8c03\u7528 printf \u7684\u8fdb\u7a0b\u5e76\u884c\u6267\u884c\u3002\u5982\u679c\u4e00\u4e2a\u8fdb\u7a0b\u8c03\u7528\u4e86 printf\uff0c\u5b83\u8fd0\u884c\u5728 CPU0 \u4e0a\uff1bCPU1 \u5904\u7406\u4e86 UART \u4e2d\u65ad\uff0c\u90a3\u4e48 CPU1 \u4e5f\u4f1a\u8c03\u7528 uartstart\u3002\u56e0\u4e3a\u6211\u4eec\u60f3\u8981\u786e\u4fdd\u5bf9\u4e8e THR \u5bc4\u5b58\u5668\u53ea\u6709\u4e00\u4e2a\u5199\u5165\u8005\uff0c\u540c\u65f6\u4e5f\u786e\u4fdd\u4f20\u8f93\u7f13\u5b58\u7684\u7279\u6027\u4e0d\u53d8\uff08\u6ce8\uff0c\u8fd9\u91cc\u6307\u7684\u662f\u5728 uartstart \u4e2d\u5bf9\u4e8e uart_tx_r \u6307\u9488\u7684\u66f4\u65b0\uff09\uff0c\u6211\u4eec\u9700\u8981\u5728\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u4e2d\u4e5f\u83b7\u53d6\u9501\u3002</li> </ul> C<pre><code>void\nuartintr(void)\n{\n  // read and process incoming characters.\n  while(1){\n    int c = uartgetc();\n    if(c == -1)\n      break;\n    consoleintr(c);\n  }\n\n  // send buffered characters.\n  acquire(&amp;uart_tx_lock);\n  uartstart();\n  release(&amp;uart_tx_lock);\n}\n</code></pre>","tags":["Operator System"]},{"location":"notes/6.s081/6-%E5%A4%9A%E6%A0%B8%E5%92%8C%E9%94%81/#spin-lock","title":"spin lock","text":"<p>\u5b9e\u73b0\u65b9\u6cd5</p> <ul> <li>\u7279\u6b8a\u7684\u786c\u4ef6\u6307\u4ee4</li> <li>\u8fd9\u4e2a\u7279\u6b8a\u7684\u786c\u4ef6\u6307\u4ee4\u4f1a\u4fdd\u8bc1\u4e00\u6b21 test-and-set \u64cd\u4f5c\u7684\u539f\u5b50\u6027\u3002\u5728 RISC-V \u4e0a\uff0c\u8fd9\u4e2a\u7279\u6b8a\u7684\u6307\u4ee4\u5c31\u662f amoswap\uff08atomic memory swap\uff09\u3002</li> <li>\u8fd9\u4e2a\u6307\u4ee4\u63a5\u6536 3 \u4e2a\u53c2\u6570\uff0c\u5206\u522b\u662f address\uff0c\u5bc4\u5b58\u5668 r1\uff0c\u5bc4\u5b58\u5668 r2\u3002\u8fd9\u6761\u6307\u4ee4\u4f1a\u5148\u9501\u5b9a\u4f4f address\uff0c\u5c06 address \u4e2d\u7684\u6570\u636e\u4fdd\u5b58\u5728\u4e00\u4e2a\u4e34\u65f6\u53d8\u91cf\u4e2d\uff08tmp\uff09\uff0c\u4e4b\u540e\u5c06 r1 \u4e2d\u7684\u6570\u636e\u5199\u5165\u5230\u5730\u5740\u4e2d\uff0c\u4e4b\u540e\u518d\u5c06\u4fdd\u5b58\u5728\u4e34\u65f6\u53d8\u91cf\u4e2d\u7684\u6570\u636e\u5199\u5165\u5230 r2 \u4e2d\uff0c\u6700\u540e\u518d\u5bf9\u4e8e\u5730\u5740\u89e3\u9501\u3002</li> </ul> C<pre><code>struct spinlock {\n  uint locked;       // Is the lock held?\n\n  // For debugging:\n  char *name;        // Name of lock.\n  struct cpu *cpu;   // The cpu holding the lock.\n};\n\nvoid\nacquire(struct spinlock *lk)\n{\n  push_off(); // disable interrupts to avoid deadlock.\n  if(holding(lk))\n    panic(\"acquire\");\n\n  // On RISC-V, sync_lock_test_and_set turns into an atomic swap:\n  //   a5 = 1\n  //   s1 = &amp;lk-&gt;locked\n  //   amoswap.w.aq a5, a5, (s1)\n  while(__sync_lock_test_and_set(&amp;lk-&gt;locked, 1) != 0)\n    ;\n\n  // Tell the C compiler and the processor to not move loads or stores\n  // past this point, to ensure that the critical section's memory\n  // references happen strictly after the lock is acquired.\n  // On RISC-V, this emits a fence instruction.\n  __sync_synchronize();\n\n  // Record info about lock acquisition for holding() and debugging.\n  lk-&gt;cpu = mycpu();\n}\n\n// Release the lock.\nvoid\nrelease(struct spinlock *lk)\n{\n  if(!holding(lk))\n    panic(\"release\");\n\n  lk-&gt;cpu = 0;\n\n  // Tell the C compiler and the CPU to not move loads or stores\n  // past this point, to ensure that all the stores in the critical\n  // section are visible to other CPUs before the lock is released,\n  // and that loads in the critical section occur strictly before\n  // the lock is released.\n  // On RISC-V, this emits a fence instruction.\n  __sync_synchronize();\n\n  // Release the lock, equivalent to lk-&gt;locked = 0.\n  // This code doesn't use a C assignment, since the C standard\n  // implies that an assignment might be implemented with\n  // multiple store instructions.\n  // On RISC-V, sync_lock_release turns into an atomic swap:\n  //   s1 = &amp;lk-&gt;locked\n  //   amoswap.w zero, zero, (s1)\n  __sync_lock_release(&amp;lk-&gt;locked);\n\n  pop_off();\n}\n</code></pre>","tags":["Operator System"]},{"location":"notes/6.s081/6-%E5%A4%9A%E6%A0%B8%E5%92%8C%E9%94%81/#spin-lock_1","title":"spin lock \u7684\u4e09\u4e2a\u7ec6\u8282","text":"<ul> <li> <p>\u4e00\u4e2a store \u6307\u4ee4\u5e76\u4e0d\u603b\u662f\u4e00\u4e2a\u539f\u5b50\u6307\u4ee4\uff0c\u53d6\u51b3\u4e8e\u5177\u4f53\u7684\u5b9e\u73b0</p> </li> <li> <p>\u5bf9\u4e8e CPU \u5185\u7684\u7f13\u5b58\uff0c\u6bcf\u4e00\u4e2a cache line \u7684\u5927\u5c0f\u53ef\u80fd\u5927\u4e8e\u4e00\u4e2a\u6574\u6570\uff0c\u90a3\u4e48 store \u6307\u4ee4\u5b9e\u9645\u7684\u8fc7\u7a0b\u5c06\u4f1a\u662f\uff1a\u9996\u5148\u4f1a\u52a0\u8f7d cache line\uff0c\u4e4b\u540e\u518d\u66f4\u65b0 cache line\u3002\u6240\u4ee5\u5bf9\u4e8e store \u6307\u4ee4\u6765\u8bf4\uff0c\u91cc\u9762\u5305\u542b\u4e86\u4e24\u4e2a\u5fae\u6307\u4ee4\u3002\u8fd9\u6837\u7684\u8bdd\u5c31\u6709\u53ef\u80fd\u5f97\u5230\u9519\u8bef\u7684\u7ed3\u679c\u3002\u6240\u4ee5\u4e3a\u4e86\u907f\u514d\u7406\u89e3\u786c\u4ef6\u5b9e\u73b0\u7684\u6240\u6709\u7ec6\u8282\uff0c\u4f8b\u5982\u6574\u6570\u64cd\u4f5c\u4e0d\u662f\u539f\u5b50\u7684\uff0c\u6216\u8005\u5411\u4e00\u4e2a 64bit \u7684\u5185\u5b58\u503c\u5199\u6570\u636e\u662f\u4e0d\u662f\u539f\u5b50\u7684\uff0c\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u4e00\u4e2a RISC-V \u63d0\u4f9b\u7684\u786e\u4fdd\u539f\u5b50\u6027\u7684\u6307\u4ee4\u6765\u5c06 locked \u5b57\u6bb5\u5199\u4e3a 0\u3002</p> </li> <li> <p>spinlock \u9700\u8981\u5904\u7406\u4e24\u7c7b\u5e76\u53d1\uff0c\u4e00\u7c7b\u662f\u4e0d\u540c CPU \u4e4b\u95f4\u7684\u5e76\u53d1\uff0c\u4e00\u7c7b\u662f\u76f8\u540c CPU \u4e0a\u4e2d\u65ad\u548c\u666e\u901a\u7a0b\u5e8f\u4e4b\u95f4\u7684\u5e76\u53d1\u3002\u9488\u5bf9\u540e\u4e00\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u9700\u8981\u5728 acquire \u4e2d\u5173\u95ed\u4e2d\u65ad\u3002\u4e2d\u65ad\u4f1a\u5728 release \u7684\u7ed3\u675f\u4f4d\u7f6e\u518d\u6b21\u6253\u5f00\uff0c\u56e0\u4e3a\u5728\u8fd9\u4e2a\u4f4d\u7f6e\u624d\u80fd\u518d\u6b21\u5b89\u5168\u7684\u63a5\u6536\u4e2d\u65ad</p> </li> <li> <p>\u7b2c\u4e09\u4e2a\u7ec6\u8282\u5c31\u662f memory ordering\u3002</p> </li> <li> <p>\u5047\u8bbe\u6211\u4eec\u5148\u901a\u8fc7\u5c06 locked \u5b57\u6bb5\u8bbe\u7f6e\u4e3a 1 \u6765\u83b7\u53d6\u9501\uff0c\u4e4b\u540e\u5bf9 x \u52a0 1\uff0c\u6700\u540e\u518d\u5c06 locked \u5b57\u6bb5\u8bbe\u7f6e 0 \u6765\u91ca\u653e\u9501\uff1b\u7f16\u8bd1\u5668\u4f1a\u4f18\u5316\u6307\u4ee4\u987a\u5e8f\u6765\u63d0\u9ad8\u6027\u80fd</p> </li> <li> <p>\u4e3a\u4e86\u7981\u6b62\uff0c\u6216\u8005\u8bf4\u4e3a\u4e86\u544a\u8bc9\u7f16\u8bd1\u5668\u548c\u786c\u4ef6\u4e0d\u8981\u8fd9\u6837\u505a\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 memory fence \u6216\u8005\u53eb\u505a synchronize \u6307\u4ee4\uff0c\u6765\u786e\u5b9a\u6307\u4ee4\u7684\u79fb\u52a8\u8303\u56f4\u3002\u5bf9\u4e8e synchronize \u6307\u4ee4\uff0c\u4efb\u4f55\u5728\u5b83\u4e4b\u524d\u7684 load/store \u6307\u4ee4\uff0c\u90fd\u4e0d\u80fd\u79fb\u52a8\u5230\u5b83\u4e4b\u540e\u3002\u9501\u7684 acquire \u548c release \u51fd\u6570\u90fd\u5305\u542b\u4e86 synchronize \u6307\u4ee4\u3002</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/7-%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2/","title":"7-\u8fdb\u7a0b\u5207\u6362","text":"2023-09-152025-12-13 <code>#Operator System</code>","tags":["Operator System"]},{"location":"notes/6.s081/7-%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2/#_1","title":"\u8fdb\u7a0b\u5207\u6362","text":"<p> \u7ea6 266 \u4e2a\u5b57  50 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p> <ul> <li> <p>P1 \u8fdb\u5165\u5185\u6838\uff0c\u5207\u6362\u5230\u8c03\u5ea6\u5668\u8fdb\u7a0b\uff0c\u8c03\u5ea6\u5668\u8fdb\u7a0b\u5207\u6362\u5230 P2</p> </li> <li> <p>\u6838\u5fc3\u51fd\u6570\u4e3a swtch()\u51fd\u6570\uff1b\u8be5\u51fd\u6570\u4fdd\u5b58\u5e76\u52a0\u8f7d\u90e8\u5206\u5bc4\u5b58\u5668\u7684\u503c\uff08RISC-V \u4e2d\u5b58\u5728\u8c03\u7528\u8005\u4fdd\u5b58\u5e76\u6062\u590d\u7684\u5bc4\u5b58\u5668\uff08caller-saved registers\uff09\uff0c\u4e0d\u9700\u8981\u4fdd\u5b58\u5168\u90e8\u5bc4\u5b58\u5668\uff09</p> </li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/7-%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2/#_2","title":"\u5207\u6362\u8fc7\u7a0b","text":"<ul> <li> <p>yield \u8c03\u7528\u4e86 sched \u51fd\u6570</p> </li> <li> <p>sched \u51fd\u6570\u8fdb\u884c\u5408\u7406\u6027\u68c0\u67e5\uff0c\u6700\u540e\u8c03\u7528 swtch \u51fd\u6570\u4ea4\u6362\u5f53\u524d\u8fdb\u7a0b\u7684\u4e0a\u4e0b\u6587\u548c CPU \u8c03\u5ea6\u7ebf\u7a0b\u7684\u4e0a\u4e0b\u6587\uff0c\u8fd4\u56de\u5730\u5740\u4e3a\u5207\u6362\u540e\u4e0a\u4e0b\u6587\u7684 ra \u5bc4\u5b58\u5668\u5b58\u7684\u503c\uff1b\u5b9e\u9645\u4e0a\u662f scheduler \u51fd\u6570</p> </li> </ul> C<pre><code>void\nsched(void)\n{\n  int intena;\n  struct proc *p = myproc();\n\n  if(!holding(&amp;p-&gt;lock))\n    panic(\"sched p-&gt;lock\");\n  if(mycpu()-&gt;noff != 1)\n    panic(\"sched locks\");\n  if(p-&gt;state == RUNNING)\n    panic(\"sched running\");\n  if(intr_get())\n    panic(\"sched interruptible\");\n\n  intena = mycpu()-&gt;intena;\n  swtch(&amp;p-&gt;context, &amp;mycpu()-&gt;context);\n  mycpu()-&gt;intena = intena;\n}\n</code></pre> <ul> <li>\u8c03\u5ea6\u5668\u627e\u5230\u4e00\u4e2a\u53ef\u8fd0\u884c\u7684\u8fdb\u7a0b\uff0c\u518d\u6b21\u8fd0\u884c swtch \u51fd\u6570\u5207\u6362\u4e0a\u4e0b\u6587\uff0c \u6b64\u65f6\u7684 ra \u5bc4\u5b58\u5668\u662f\u4e4b\u524d\u662f\u88ab\u5b9a\u65f6\u5668\u4e2d\u65ad\u901a\u8fc7 sched \u51fd\u6570\u6302\u8d77\u7684</li> </ul> C<pre><code>void\nscheduler(void)\n{\n  struct proc *p;\n  struct cpu *c = mycpu();\n\n  c-&gt;proc = 0;\n  for(;;){\n    // The most recent process to run may have had interrupts\n    // turned off; enable them to avoid a deadlock if all\n    // processes are waiting.\n    intr_on();\n\n    for(p = proc; p &lt; &amp;proc[NPROC]; p++) {\n      acquire(&amp;p-&gt;lock);\n      if(p-&gt;state == RUNNABLE) {\n        // Switch to chosen process.  It is the process's job\n        // to release its lock and then reacquire it\n        // before jumping back to us.\n        p-&gt;state = RUNNING;\n        c-&gt;proc = p;\n        swtch(&amp;c-&gt;context, &amp;p-&gt;context);\n\n        // Process is done running for now.\n        // It should have changed its p-&gt;state before coming back.\n        c-&gt;proc = 0;\n      }\n      release(&amp;p-&gt;lock);\n    }\n  }\n}\n</code></pre> <ul> <li>\u7b2c\u4e00\u6b21\u5207\u6362\u8fdb\u7a0b\u65f6\uff0c\u6784\u9020\u4e00\u4e2a forkret\uff0callocproc \u8bbe\u7f6e\u4e86 ra \u548c sp \u5bc4\u5b58\u5668\uff0cforkret \u672c\u8eab\u53ea\u91ca\u653e\u9501\uff0c\u8c03\u7528 usertrapret</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/8-%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92/","title":"8-Coordination","text":"2023-09-162025-12-13 <code>#Operator System</code>","tags":["Operator System"]},{"location":"notes/6.s081/8-%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92/#coordination","title":"Coordination","text":"<p> \u7ea6 1154 \u4e2a\u5b57  63 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p>","tags":["Operator System"]},{"location":"notes/6.s081/8-%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92/#1","title":"1 \u8fdb\u7a0b\u5207\u6362\u8fc7\u7a0b","text":"<ol> <li>\u4e00\u4e2a\u8fdb\u7a0b\u51fa\u4e8e\u67d0\u79cd\u539f\u56e0\u60f3\u8981\u8fdb\u5165\u4f11\u7720\u72b6\u6001\uff0c\u6bd4\u5982\u8bf4\u51fa\u8ba9 CPU \u6216\u8005\u7b49\u5f85\u6570\u636e\uff0c\u5b83\u4f1a\u5148\u83b7\u53d6\u81ea\u5df1\u7684\u9501\uff1b</li> <li>\u4e4b\u540e\u8fdb\u7a0b\u5c06\u81ea\u5df1\u7684\u72b6\u6001\u4ece RUNNING \u8bbe\u7f6e\u4e3a RUNNABLE\uff1b</li> <li>\u4e4b\u540e\u8fdb\u7a0b\u8c03\u7528 switch \u51fd\u6570\uff0c\u5176\u5b9e\u662f\u8c03\u7528 sched \u51fd\u6570\u5728 sched \u51fd\u6570\u4e2d\u518d\u8c03\u7528\u7684 switch \u51fd\u6570\uff1b</li> <li>switch \u51fd\u6570\u5c06\u5f53\u524d\u7684\u7ebf\u7a0b\u5207\u6362\u5230\u8c03\u5ea6\u5668\u7ebf\u7a0b\uff1b</li> <li>\u8c03\u5ea6\u5668\u7ebf\u7a0b\u4e4b\u524d\u4e5f\u8c03\u7528\u4e86 switch \u51fd\u6570\uff0c\u73b0\u5728\u6062\u590d\u6267\u884c\u4f1a\u4ece\u81ea\u5df1\u7684 switch \u51fd\u6570\u8fd4\u56de\uff1b</li> <li>\u8fd4\u56de\u4e4b\u540e\uff0c\u8c03\u5ea6\u5668\u7ebf\u7a0b\u4f1a\u91ca\u653e\u521a\u521a\u51fa\u8ba9\u4e86 CPU \u7684\u8fdb\u7a0b\u7684\u9501</li> </ol> C<pre><code>// \u9700\u8981\u5207\u6362\u7684\u8fdb\u7a0b\nacquire(&amp;p-&gt;lock);\np-&gt;state = RUNNABLE;\nswtch();\n// \u8c03\u5ea6\u5668\u8fdb\u7a0b\nswtch();\nrelease(&amp;p-&gt;lock);\n</code></pre> <ul> <li> <p>\u5728\u8fdb\u7a0b\u5207\u6362\u7684\u6700\u5f00\u59cb\uff0c\u8fdb\u7a0b\u5148\u83b7\u53d6\u81ea\u5df1\u7684\u9501\uff0c\u5e76\u4e14\u76f4\u5230\u8c03\u7528 swtch \u51fd\u6570\u65f6\u4e5f\u4e0d\u91ca\u653e\u9501\u3002\u800c\u53e6\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u4e5f\u5c31\u662f\u8c03\u5ea6\u5668\u7ebf\u7a0b\u4f1a\u5728\u8fdb\u7a0b\u7684\u7ebf\u7a0b\u5b8c\u5168\u505c\u6b62\u4f7f\u7528\u81ea\u5df1\u7684\u6808\u4e4b\u540e\uff0c\u518d\u91ca\u653e\u8fdb\u7a0b\u7684\u9501\u3002</p> </li> <li> <p>\u5982\u679c\u5728 swtch()\u524d\u91ca\u653e\u9501\uff0c\u53ef\u80fd\u6709\u53e6\u4e00\u4e2a CPU \u6838\u5fc3\u8fd0\u884c\u540c\u6837\u7684\u8fdb\u7a0b\uff1b\u4f1a\u9020\u6210\u7a0b\u5e8f\u5d29\u6e83</p> </li> <li> <p>XV6 \u4e2d\uff0c\u4e0d\u5141\u8bb8\u8fdb\u7a0b\u5728\u6267\u884c switch \u51fd\u6570\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6301\u6709\u4efb\u4f55\u5176\u4ed6\u7684\u9501\u3002</p> </li> <li> <p>\u5982\u679c p1 \u6301\u6709\u53e6\u4e00\u4e2a\u9501 l1\uff0c\u5f53 p1 \u5207\u6362\u5230 p2 \u65f6\uff1bp1 \u7684 l1 \u672a\u91ca\u653e\uff0c\u800c\u5982\u679c p2 \u9700\u8981 l1\uff1b\u4f1a\u9020\u6210\u6b7b\u9501\uff1ap2 \u9700\u8981 l1 \u6765\u8fdb\u884c\u8fdb\u7a0b\u5207\u6362\uff0cp1 \u62e5\u6709 l1\uff0c\u4f46\u4e0d\u80fd\u8fdb\u884c\u8fdb\u7a0b\u5207\u6362</p> </li> <li>\u6211\u4eec\u4e0d\u80fd\u5728\u7b49\u5f85\u9501\u7684\u65f6\u5019\u5904\u7406\u4e2d\u65ad\uff1b\u6240\u4ee5\u5b9a\u65f6\u5668\u4e2d\u65ad (\u8c03\u7528 yield\uff0c\u8ba9\u8fdb\u7a0b\u51fa\u8ba9 CPU) \u4e0d\u80fd\u6253\u7834\u6b7b\u9501</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/8-%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92/#2-sleep-wakeup","title":"2 Sleep &amp; Wakeup","text":"<ul> <li>\u901a\u8fc7\u5faa\u73af\u7b49\u5f85\u786c\u4ef6\u8bbe\u5907\u5728\u73b0\u5728\u7b49\u5f85\u7684\u65f6\u95f4\u662f\u4e0d\u53ef\u63a5\u53d7\u7684\uff1b</li> <li>xv6 \u4e2d\u901a\u8fc7 uart \u786c\u4ef6\u8fdb\u884c\u8bfb\u53d6\u5b57\u7b26\u5230\u63a7\u5236\u53f0\uff1b\u5f53\u5199\u5165\u4e00\u4e2a\u5b57\u7b26\u540e\u5199\u5165\u8fdb\u7a0b sleep\uff0c\u89e6\u53d1\u4e2d\u65ad uartintr\uff1b\u4e2d\u65ad\u5224\u65ad\u662f\u5426\u5df2\u7ecf\u5199\u5165\u5b8c\u6210\uff0c\u5982\u679c\u5199\u5165\u5b8c\u6210\uff0c\u5524\u9192\u5199\u5165\u8fdb\u7a0b\u8fdb\u884c\u4e0b\u4e00\u6b21\u5199\u5165</li> <li>sleep \u548c wakeup \u9700\u8981\u7279\u5b9a\u7684\u53c2\u6570\u4e00\u4e2a channel\uff1bsleep \u9700\u8981\u4f20\u9012\u4e00\u4e2a\u9501</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/8-%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92/#21-lose-wakeup","title":"2.1 lose wakeup","text":"<ul> <li>\u4f7f\u7528\u4e0b\u9762\u7684 sleep \u548c wakeup\uff1b\u4f1a\u9020\u6210\u4e22\u5931\u5524\u9192\u95ee\u9898</li> <li>\u53ef\u80fd\u5728\u8fdb\u7a0b\u672a sleep \u524d\uff0c\u4e2d\u65ad\u4f8b\u7a0b\u6267\u884c\u6210\u529f\uff0cwakeup \u672a\u5524\u9192\u4efb\u4f55\u8fdb\u7a0b</li> </ul> C<pre><code>void broken_sleep(chan) {\n  p-&gt;state = SLEEPING;\n  p-&gt;chan = chan;\n  swtch();\n}\nvoid wakeup(chan) {\n  for(each p in prics[]) {\n    if(p-&gt;state == SLEEPING&amp;&amp;p-&gt;chan == chan) {\n      p-&gt;state = RUNNABLE;\n    }\n  }\n}\n\nvoid uartwrite(buf) {\n  for each c in buf:\n    lock;\n    while not done;\n      unlock;\n      // \u4e2d\u65ad\u53d1\u751f\u5730\n      sleep(&amp;tx_chan);\n      // \u518d\u6b21\u83b7\u5f97\u9501\u8fdb\u884c\u4e0b\u4e00\u6b65\u64cd\u4f5c\n      lock\n    send c;\n    done = 0;\n    unlock;\n}\n\nvoid uartintr() {\n  lock;\n  done = 1;\n  wakeup(&amp;tx_chan);\n  unlock;\n}\n</code></pre> <ul> <li>sleep \u9700\u8981\u4f20\u5165\u4e00\u4e2a\u4fdd\u62a4\u6761\u4ef6\u7684\u9501\uff1b\u8c03\u7528 sleep \u65f6\uff0c\u9501\u88ab\u5f53\u524d\u7ebf\u7a0b\u6301\u6709\uff0c\u4e4b\u540e\u8fd9\u4e2a\u9501\u88ab\u4f20\u9012\u7ed9 sleep</li> <li>wakeup \u5fc5\u987b\u5728\u6301\u6709\u6761\u4ef6\u9501\uff08\u8fdb\u7a0b\u7684\u9501\uff09\u65f6\u624d\u80fd\u5524\u9192\u8fdb\u7a0b</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/8-%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92/#22-exit","title":"2.2 exit","text":"<ul> <li>\u5173\u95ed\u6240\u6709\u6253\u5f00\u7684\u6587\u4ef6\uff1b\u7236\u8fdb\u7a0b\u9000\u51fa\uff0c\u5b50\u8fdb\u7a0b\u7531 init \u8fdb\u7a0b\u7ba1\u7406\uff1b\u5c06\u81ea\u5df1\u53d8\u4e3a\u50f5\u5c38\u8fdb\u7a0b\uff1b\u8fdb\u5165 sched()\u51fd\u6570</li> <li>\u4e00\u4e2a\u8fdb\u7a0b exit \u540e\uff0c\u7236\u8fdb\u7a0b\u5982\u679c\u8c03\u7528\u4e86 wait\uff0c\u7236\u8fdb\u7a0b\u4f1a\u8fd4\u56de\u5b50\u8fdb\u7a0b\u9000\u51fa\u503c</li> <li>\u626b\u63cf\u8fdb\u7a0b\u8868\uff0c\u627e\u5230\u5b50\u8fdb\u7a0b\u4e3a\u50f5\u5c38\u8fdb\u7a0b\u7684\u8fdb\u7a0b\uff1b\u8c03\u7528 freeproc()</li> </ul> C<pre><code>static void\nfreeproc(struct proc *p) {\n  if(p-&gt;trapframe)\n    kfree((void*)p-&gt;trapframe);\n  p-&gt;trapframe = 0;\n  if(p-&gt;pagetable)\n    proc_freepagetable(p-&gt;pagetable, p-&gt;sz);\n  p-&gt;pagetable = 0;\n  p-&gt;sz = 0;\n  p-&gt;pid = 0;\n  p-&gt;parent = 0;\n  p-&gt;name[0] = 0;\n  p-&gt;chan = 0;\n  p-&gt;killed = 0;\n  p-&gt;xstate = 0;\n  p-&gt;state = UNUSED;\n}\n</code></pre> <ul> <li>\u5728 Unix \u4e2d\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u9000\u51fa\u7684\u8fdb\u7a0b\uff0c\u90fd\u9700\u8981\u6709\u4e00\u4e2a\u5bf9\u5e94\u7684 wait \u7cfb\u7edf\u8c03\u7528</li> </ul>","tags":["Operator System"]},{"location":"notes/6.s081/8-%E7%9D%A1%E7%9C%A0%E5%92%8C%E5%94%A4%E9%86%92/#23-kill","title":"2.3 kill","text":"<ul> <li>Unix \u4e2d\u7684\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u5c06\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u7684 ID \u4f20\u9012\u7ed9 kill \u7cfb\u7edf\u8c03\u7528\uff0c\u5e76\u8ba9\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u505c\u6b62\u8fd0\u884c</li> <li>\u5b83\u5148\u626b\u63cf\u8fdb\u7a0b\u8868\u5355\uff0c\u627e\u5230\u76ee\u6807\u8fdb\u7a0b\u3002\u7136\u540e\u53ea\u662f\u5c06\u8fdb\u7a0b\u7684 proc \u7ed3\u6784\u4f53\u4e2d killed \u6807\u5fd7\u4f4d\u8bbe\u7f6e\u4e3a 1\u3002\u5982\u679c\u8fdb\u7a0b\u6b63\u5728 SLEEPING \u72b6\u6001\uff0c\u5c06\u5176\u8bbe\u7f6e\u4e3a RUNNABLE\u3002\u8fd9\u91cc\u53ea\u662f\u5c06 killed \u6807\u5fd7\u4f4d\u8bbe\u7f6e\u4e3a 1\uff0c\u5e76\u6ca1\u6709\u505c\u6b62\u8fdb\u7a0b\u7684\u8fd0\u884c\u3002\u6240\u4ee5 kill \u7cfb\u7edf\u8c03\u7528\u672c\u8eab\u8fd8\u662f\u5f88\u6e29\u548c\u7684\u3002</li> <li>\u800c\u76ee\u6807\u8fdb\u7a0b\u8fd0\u884c\u5230\u5185\u6838\u4ee3\u7801\u4e2d\u80fd\u5b89\u5168\u505c\u6b62\u8fd0\u884c\u7684\u4f4d\u7f6e\u65f6\uff0c\u4f1a\u68c0\u67e5\u81ea\u5df1\u7684 killed \u6807\u5fd7\u4f4d\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a 1\uff0c\u76ee\u6807\u8fdb\u7a0b\u4f1a\u81ea\u613f\u7684\u6267\u884c exit \u7cfb\u7edf\u8c03\u7528</li> <li>\u5982\u679c\u8fdb\u7a0b\u5728\u7528\u6237\u7a7a\u95f4\uff0c\u90a3\u4e48\u4e0b\u4e00\u6b21\u5b83\u6267\u884c\u7cfb\u7edf\u8c03\u7528\u5b83\u5c31\u4f1a\u9000\u51fa\uff0c\u53c8\u6216\u8005\u76ee\u6807\u8fdb\u7a0b\u6b63\u5728\u6267\u884c\u7528\u6237\u4ee3\u7801\uff0c\u5f53\u65f6\u4e0b\u4e00\u6b21\u5b9a\u65f6\u5668\u4e2d\u65ad\u6216\u8005\u5176\u4ed6\u4e2d\u65ad\u89e6\u53d1\u4e86\uff0c\u8fdb\u7a0b\u624d\u4f1a\u9000\u51fa\u3002\u6240\u4ee5\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u8c03\u7528 kill\uff0c\u5230\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u771f\u6b63\u9000\u51fa\uff0c\u4e2d\u95f4\u53ef\u80fd\u6709\u5f88\u660e\u663e\u7684\u5ef6\u65f6</li> <li>\u5728\u5185\u6838\u6001 kill \u8fdb\u7a0b\uff0c\u4f1a\u5c06\u8fdb\u7a0b\u5524\u9192\uff1b\u5728 sleep \u5faa\u73af\u4e2d\u8fdb\u884c killed \u6807\u5fd7\u4f4d\u7684\u68c0\u67e5</li> <li>\u5728\u9a71\u52a8\u4e2d\uff0c\u6211\u4eec\u671f\u671b\u6587\u4ef6\u64cd\u4f5c\u4e0d\u4f1a\u4e2d\u65ad\uff1b\u6240\u4ee5\u4e0d\u4f1a\u5728 sleep \u5faa\u73af\u4e2d\u8fdb\u884c killed \u6807\u5fd7\u4f4d\u7684\u68c0\u67e5</li> <li>init \u8fdb\u7a0b\u7684\u76ee\u6807\u5c31\u662f\u4e0d\u9000\u51fa\uff0c\u5b83\u5c31\u662f\u5728\u4e00\u4e2a\u5faa\u73af\u4e2d\u4e0d\u505c\u7684\u8c03\u7528 wait\u3002\u5982\u679c init \u8fdb\u7a0b\u9000\u51fa\u4e86\uff0c\u6211\u8ba4\u4e3a\u8fd9\u662f\u4e00\u4e2a Fatal \u7ea7\u522b\u7684\u9519\u8bef\uff0c\u7136\u540e\u7cfb\u7edf\u4f1a\u5d29\u6e83\u3002\u5728 exit \u51fd\u6570\u7684\u6700\u5f00\u59cb\u5c31\u4f1a\u6709\u5982\u4e0b\u68c0\u67e5</li> </ul> C<pre><code>void\nexit(int status) {\n  struct proc *p = myproc();\n  if(p == initproc)\n    panic(\"init exiting\");\n}\n</code></pre>","tags":["Operator System"]},{"location":"notes/C%2B%2B/1-Container/","title":"1-Container","text":""},{"location":"notes/C%2B%2B/1-Container/#1-container","title":"1 Container","text":"<p> \u7ea6 25 \u4e2a\u5b57  1 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"notes/C%2B%2B/1-Container/#11-stdvector","title":"1.1 std::vector","text":"<ul> <li>\u8fed\u4ee3\u5668\u5728vector\u63d2\u5165\u8d85\u8fc7\u5bb9\u91cf\u540e\uff0c\u81ea\u52a8\u6269\u5bb9\u65f6\u5931\u6548 <code>admonish info   \u5f15\u7528\u8bed\u4e49\u5728\u4f7f\u7528 span \u65f6\u5fc5\u987b\u8c28\u614e\u3002\u5c06\u4e00\u4e2a\u65b0\u5143\u7d20\u63d2\u5165 vector \u4e2d,\u8be5 vector \u4e2d\u4fdd\u5b58\u4e86\u8de8\u5ea6\u6240\u5f15\u7528\u7684\u5143\u7d20\u3002\u7531\u4e8e span \u7684\u5f15\u7528\u8bed\u4e49,\u82e5 vector \u5206\u914d\u65b0\u7684\u5185\u5b58\uff0c\u4f1a\u4f7f\u6240\u6709\u8fed\u4ee3\u5668\u548c\u6307\u5411\u5176\u5143\u7d20\u7684\u6307\u9488\u65e0\u6548,\u6240\u4ee5\u91cd\u65b0\u5206\u914d\u4e5f\u4f1a\u4f7f\u5f15\u7528 vector \u5143\u7d20\u7684 span \u5931\u6548\u3002span \u6307\u5411\u4e86\u4e0d\u518d\u5b58\u5728\u7684\u5143\u7d20\u3002  \u51fa\u4e8e\u8fd9\u4e2a\u539f\u56e0,\u9700\u8981\u5728\u63d2\u5165\u524d\u540e\u90fd\u8981\u4ed4\u7ec6\u68c0\u67e5\u5bb9\u91cf (\u5206\u914d\u5185\u5b58\u7684\u6700\u5927\u5143\u7d20\u6570\u91cf)\u3002\u82e5\u5bb9\u91cf\u53d1\u751f\u53d8\u5316,\u5219\u91cd\u65b0\u521d\u59cb\u5316 span</code></li> </ul>"},{"location":"notes/C%2B%2B/2-Algorithm/","title":"2-Algorithm","text":""},{"location":"notes/C%2B%2B/2-Algorithm/#2-algorithm","title":"2 Algorithm","text":"<p> \u7ea6 751 \u4e2a\u5b57  293 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"notes/C%2B%2B/2-Algorithm/#21-stdtransform","title":"2.1 std::transform","text":"<ul> <li>std::transform applies the given function to the elements of the given input range(s), and stores the result in an output range starting from d_first.</li> </ul>"},{"location":"notes/C%2B%2B/2-Algorithm/#parameters","title":"parameters","text":"<p>```admonish info first1, last1: the pair of iterators defining the source range of elements to transform ; first2: the beginning of the second range of elements to transform, (3,4) only; d_first: the beginning of the destination range, may be equal to first1 or first2; policy: the execution policy to use; unary_op: Ret fun(const Type &amp;a); binary_op: Ret fun(const Type1 &amp;a, const Type2 &amp;b); </p>Text Only<pre><code>## possible implementation\n\n```c++\ntemplate&lt;class InputIt, class OutputIt, class UnaryOp&gt;\nconstexpr //&lt; since C++20\nOutputIt transform(InputIt first1, InputIt last1,\n                   OutputIt d_first, UnaryOp unary_op)\n{\n    for (; first1 != last1; ++d_first, ++first1)\n        *d_first = unary_op(*first1);\n\n    return d_first;\n}\n\ntemplate&lt;class InputIt1, class InputIt2, \n         class OutputIt, class BinaryOp&gt;\nconstexpr //&lt; since C++20\nOutputIt transform(InputIt1 first1, InputIt1 last1, InputIt2 first2,\n                   OutputIt d_first, BinaryOp binary_op)\n{\n    for (; first1 != last1; ++d_first, ++first1, ++first2)\n        *d_first = binary_op(*first1, *first2);\n\n    return d_first;\n}\n</code></pre><p></p>"},{"location":"notes/C%2B%2B/2-Algorithm/#example","title":"example","text":"C++<pre><code>#include &lt;algorithm&gt;\n#include &lt;cctype&gt;\n#include &lt;iomanip&gt;\n#include &lt;iostream&gt;\n#include &lt;string&gt;\n#include &lt;utility&gt;\n#include &lt;vector&gt;\n\nvoid print_ordinals(const std::vector&lt;unsigned&gt;&amp; ordinals)\n{\n    std::cout &lt;&lt; \"ordinals: \";\n    for (unsigned ord : ordinals)\n        std::cout &lt;&lt; std::setw(3) &lt;&lt; ord &lt;&lt; ' ';\n    std::cout &lt;&lt; '\\n';\n}\n\nchar to_uppercase(unsigned char c)\n{\n    return std::toupper(c);\n}\n\nvoid to_uppercase_inplace(char&amp; c)\n{\n    c = to_uppercase(c);\n}\n\nvoid unary_transform_example(std::string&amp; hello, std::string world)\n{\n    // Transform string to uppercase in-place\n\n    std::transform(hello.cbegin(), hello.cend(), hello.begin(), to_uppercase);\n    std::cout &lt;&lt; \"hello = \" &lt;&lt; std::quoted(hello) &lt;&lt; '\\n';\n\n    // for_each version (see Notes above)\n    std::for_each(world.begin(), world.end(), to_uppercase_inplace);\n    std::cout &lt;&lt; \"world = \" &lt;&lt; std::quoted(world) &lt;&lt; '\\n';\n}\n\nvoid binary_transform_example(std::vector&lt;unsigned&gt; ordinals)\n{\n    // Transform numbers to doubled values\n\n    print_ordinals(ordinals);\n\n    std::transform(ordinals.cbegin(), ordinals.cend(), ordinals.cbegin(),\n                   ordinals.begin(), std::plus&lt;&gt;{});\n\n    print_ordinals(ordinals);\n}\n\nint main()\n{\n    std::string hello(\"hello\");\n    unary_transform_example(hello, \"world\");\n\n    std::vector&lt;unsigned&gt; ordinals;\n    std::copy(hello.cbegin(), hello.cend(), std::back_inserter(ordinals));\n    binary_transform_example(std::move(ordinals));\n}\n// OUTPUT\n// hello = \"HELLO\"\n// world = \"WORLD\"\n// ordinals:  72  69  76  76  79 \n// ordinals: 144 138 152 152 158\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#22-stdaccumulate","title":"2.2 std::accumulate","text":"<p>```admonish info Computes the sum of the given value init and the elements in the range [first, last). </p>Text Only<pre><code>## parameters\n\n- first, last - the pair of iterators defining the range of elements to accumulate\n- init - initial value of the accumulate\n- op - Ret fun(const Type1 &amp;a, const Type2 &amp;b);\n  ```admonish example\n  \u5982\u6807\u51c6\u5e93\u4e2d\u7684std::plus&lt;&gt;\n  ```\n\n## possible implementation\n\n```c++\n\naccumulate (1)\ntemplate&lt;class InputIt, class T&gt;\nconstexpr // since C++20\nT accumulate(InputIt first, InputIt last, T init)\n{\n    for (; first != last; ++first)\n        init = std::move(init) + *first; // std::move since C++20\n\n    return init;\n}\n\ntemplate&lt;class InputIt, class T, class BinaryOperation&gt;\nconstexpr // since C++20\nT accumulate(InputIt first, InputIt last, T init, BinaryOperation op)\n{\n    for (; first != last; ++first)\n        init = op(std::move(init), *first); // std::move since C++20\n\n    return init;\n}\n</code></pre><p></p>"},{"location":"notes/C%2B%2B/2-Algorithm/#23-stdoptinal","title":"2.3 std::optinal","text":"<ul> <li>std::optional\u6700\u9ad8\u6548\u7684\u5199\u6cd5\u662f\u89e6\u53d1RVO\u7684\u5199\u6cd5\uff0c\u5373\uff1a</li> </ul> C++<pre><code>optional&lt;A&gt; optional_best(int n) {\n    optional&lt;A&gt; temp(someFn(n));\n    return temp;\n}\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#24-stdmove","title":"2.4 std::move","text":"<ul> <li>\u5c06 <code>[first, last)</code> \u8303\u56f4\u5185\u7684\u5143\u7d20\u79fb\u52a8\u5230\u4ee5 d_first \u5f00\u59cb\u7684\u76ee\u6807\u8303\u56f4</li> </ul> C++<pre><code>template &lt;typename InputIt, typename OutputIt&gt;\nOutputIt std::move(InputIt first, InputIt last, OutputIt d_first);\n</code></pre> <ul> <li>\u8fd4\u56de\u4e00\u4e2a\u8fed\u4ee3\u5668\uff0c\u6307\u5411\u76ee\u6807\u8303\u56f4\u79fb\u52a8\u540e\u7684\u7ed3\u675f\u4f4d\u7f6e\uff08\u5373 d_first + (last - first)\uff09\u3002</li> </ul> \u53c2\u6570 \u7c7b\u578b \u63cf\u8ff0 first InputIt \u6e90\u8303\u56f4\u7684\u8d77\u59cb\u8fed\u4ee3\u5668\uff08\u6307\u5411\u8981\u79fb\u52a8\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\uff09 last InputIt \u6e90\u8303\u56f4\u7684\u7ed3\u675f\u8fed\u4ee3\u5668\uff08\u6307\u5411\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u7684\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\uff09 d_first OutputIt \u76ee\u6807\u8303\u56f4\u7684\u8d77\u59cb\u8fed\u4ee3\u5668\uff08\u6307\u5411\u79fb\u52a8\u540e\u7b2c\u4e00\u4e2a\u5143\u7d20\u4f4d\u7f6e\uff09"},{"location":"notes/C%2B%2B/2-Algorithm/#25-stdmove_backward","title":"2.5 std::move_backward","text":"<ul> <li>\u76ee\u6807\u4f4d\u7f6e\uff1a\u5143\u7d20\u4f1a\u88ab\u79fb\u52a8\u5230\u4ee5 d_last \u4e3a\u7ed3\u675f\u7684\u76ee\u6807\u8303\u56f4\uff0c\u5373\u76ee\u6807\u8303\u56f4\u662f <code>[d_last - N, d_last)</code>\uff0c\u5176\u4e2d N = last - first\u3002</li> </ul> C++<pre><code>template &lt;class BidirIt1, class BidirIt2&gt;\nBidirIt2 std::move_backward(BidirIt1 first, BidirIt1 last, BidirIt2 d_last);\n</code></pre> <ul> <li>\u8fd4\u56de\u4e00\u4e2a\u8fed\u4ee3\u5668\uff0c\u6307\u5411\u76ee\u6807\u8303\u56f4\u79fb\u52a8\u540e\u7684\u8d77\u59cb\u4f4d\u7f6e\uff08\u5373 d_last - (last - first)\uff09</li> </ul> \u53c2\u6570 \u7c7b\u578b \u63cf\u8ff0 first BidirIt1 \u6e90\u8303\u56f4\u7684\u8d77\u59cb\u8fed\u4ee3\u5668\uff08\u6307\u5411\u8981\u79fb\u52a8\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\uff09 last BidirIt1 \u6e90\u8303\u56f4\u7684\u7ed3\u675f\u8fed\u4ee3\u5668\uff08\u6307\u5411\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u7684\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\uff09 d_last BidirIt2 \u76ee\u6807\u8303\u56f4\u7684\u7ed3\u675f\u8fed\u4ee3\u5668\uff08\u6307\u5411\u79fb\u52a8\u540e\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u7684\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\uff09"},{"location":"notes/C%2B%2B/2-Algorithm/#26-stdlower_bound-stdupper_bound","title":"2.6 std::lower_bound \u548c std::upper_bound","text":"<ul> <li>\u5b9e\u9645\u4e0a\u662f\u4e8c\u5206\u67e5\u627e\u7684\u5b9e\u73b0</li> </ul> <p>```admonish info std::lower_bound: \u8fd4\u56de\u7b2c\u4e00\u4e2a\u4e0d\u5c0f\u4e8e\u7ed9\u5b9a\u503c\u7684\u5143\u7d20\u4f4d\u7f6e\u3002 \u8fd4\u56de\u503c: \u6307\u5411\u7b2c\u4e00\u4e2a\u6ee1\u8db3 *it &gt;= value \u7684\u5143\u7d20\u7684\u8fed\u4ee3\u5668\u3002\u82e5\u6ca1\u6709\u8fd9\u6837\u7684\u5143\u7d20\uff0c\u5219\u8fd4\u56de end() </p>Text Only<pre><code>```admonish info\nstd::upper_bound: \u8fd4\u56de\u7b2c\u4e00\u4e2a\u5927\u4e8e\u7ed9\u5b9a\u503c\u7684\u5143\u7d20\u4f4d\u7f6e\u3002\n\u8fd4\u56de\u503c: \u6307\u5411\u7b2c\u4e00\u4e2a\u6ee1\u8db3 *it &gt; value \u7684\u5143\u7d20\u7684\u8fed\u4ee3\u5668\u3002\u82e5\u6ca1\u6709\u8fd9\u6837\u7684\u5143\u7d20\uff0c\u5219\u8fd4\u56de end()\u3002\n</code></pre><p></p>"},{"location":"notes/C%2B%2B/2-Algorithm/#27-stddistance","title":"2.7 std::distance","text":"<p>```admonish info std::distance \u8fd4\u56de\u4ece\u7b2c\u4e00\u4e2a\u8fed\u4ee3\u5668\u5230\u7b2c\u4e8c\u4e2a\u8fed\u4ee3\u5668\u4e4b\u95f4\u7684\u5143\u7d20\u6570\u91cf\u3002\u5bf9\u4e8e\u968f\u673a\u8bbf\u95ee\u8fed\u4ee3\u5668\uff08\u5982 std::vector\u3001std::deque\u3001std::array \u7684\u8fed\u4ee3\u5668\uff09\uff0c\u5b83\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f O(1)\uff1b\u5bf9\u4e8e\u5176\u4ed6\u7c7b\u578b\u7684\u8fed\u4ee3\u5668\uff08\u5982 std::list\u3001std::forward_list \u7684\u8fed\u4ee3\u5668\uff09\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u662f O(n)\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u9010\u4e2a\u904d\u5386\u5143\u7d20\u3002 </p>Text Only<pre><code>```c++\ntemplate&lt;class InputIterator&gt;\ntypename std::iterator_traits&lt;InputIterator&gt;::difference_type\n    std::distance(InputIterator first, InputIterator last);\n</code></pre><p></p>"},{"location":"notes/C%2B%2B/2-Algorithm/#28-stdall_of-stdany_of-stdnone_of","title":"2.8 std::all_of, std::any_of, std::none_of","text":"Text Only<pre><code>std::all_of: \u68c0\u67e5\u6240\u6709\u5143\u7d20\u662f\u5426\u90fd\u6ee1\u8db3\u6761\u4ef6\uff08Predicate \u8fd4\u56de true\uff09\u3002  \nstd::any_of: \u68c0\u67e5\u662f\u5426\u81f3\u5c11\u6709\u4e00\u4e2a\u5143\u7d20\u6ee1\u8db3\u6761\u4ef6\u3002  \nstd::non_of: \u68c0\u67e5\u662f\u5426\u5168\u90e8\u4e0d\u6ee1\u8db3\u6761\u4ef6\n</code></pre> <ul> <li>\u53c2\u6570\u8bf4\u660e   |\u53c2\u6570| \u8bf4\u660e|   |---|---|   |first| \u8d77\u59cb\u8fed\u4ee3\u5668\uff0c\u6307\u5411\u5f85\u68c0\u67e5\u8303\u56f4\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\u3002|   |last| \u7ec8\u6b62\u8fed\u4ee3\u5668\uff0c\u6307\u5411\u5f85\u68c0\u67e5\u8303\u56f4\u7684\u672b\u5c3e\uff08\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u7684\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\uff09\u3002|   |p| \u8c13\u8bcd\uff08Predicate\uff09\uff0c\u63a5\u53d7\u4e00\u4e2a\u5143\u7d20\u7c7b\u578b\u7684\u53c2\u6570\uff0c\u8fd4\u56de bool \u7c7b\u578b\u7684\u6761\u4ef6\u7ed3\u679c\u3002|</li> </ul>"},{"location":"notes/C%2B%2B/2-Algorithm/#29-stdcount-stdcount_if","title":"2.9 std::count, std::count_if","text":"<ul> <li>std::count</li> </ul> Text Only<pre><code>\u7edf\u8ba1\u503c\u4e3a value \u7684\u5143\u7d20\u4e2a\u6570\n</code></pre> C++<pre><code>template&lt;class InputIt, class T&gt;\ntypename iterator_traits&lt;InputIt&gt;::difference_type\n      count(InputIt first, InputIt last, const T&amp; value);\n</code></pre> <ul> <li>std::count_if</li> </ul> Text Only<pre><code>\u7edf\u8ba1\u7b26\u5408\u6761\u4ef6\u7684\u5143\u7d20\u4e2a\u6570\n</code></pre> C++<pre><code>template&lt;class InputIt, class Predicate&gt;\ntypename iterator_traits&lt;InputIt&gt;::difference_type\n  count_if(InputIt first, InputIt last, Predicate p);\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#210-stdfind-stdfind_if","title":"2.10 std::find, std::find_if","text":"<ul> <li>std::find: \u8fd4\u56de\u7b2c\u4e00\u4e2a\u7b49\u4e8e value \u7684\u8fed\u4ee3\u5668</li> </ul> Text Only<pre><code>\u81ea\u5b9a\u4e49\u5bf9\u8c61\u4f7f\u7528std::find\uff0c\u9700\u91cd\u8f7d operator==\n</code></pre> C++<pre><code>template&lt;class InputIt, class T&gt;\nInputIt find(InputIt first, InputIt last, const T&amp; value);\n</code></pre> <ul> <li>std::find_if: \u5728\u8303\u56f4\u5185\u67e5\u627e\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u8c13\u8bcd\u6761\u4ef6\u7684\u5143\u7d20\u3002</li> </ul> C++<pre><code>template&lt;class InputIt, class Predicate&gt;\nInputIt find_if(InputIt first, InputIt last, Predicate p);\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#211-stdcopy-stdcopy_if","title":"2.11 std::copy, std::copy_if","text":"<ul> <li>std::copy: \u5b8c\u5168\u590d\u5236\u6240\u6709\u5143\u7d20</li> </ul> C++<pre><code>template&lt;class InputIt, class OutputIt, class Predicate&gt;\nOutputIt copy(InputIt first, InputIt last, OutputIt d_first);\n</code></pre> <ul> <li>std::copy_if: \u9009\u62e9\u6027\u590d\u5236\u5143\u7d20</li> </ul> C++<pre><code>template&lt;class InputIt, class OutputIt, class Predicate&gt;\nOutputIt copy_if(InputIt first, InputIt last, OutputIt d_first, Predicate pred);\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#212-stdfill-stdgenerate","title":"2.12 std::fill, std::generate","text":"<ul> <li>std::fill: \u7528\u56fa\u5b9a\u503c\u586b\u5145\u8303\u56f4 C++<pre><code>template&lt;class ForwardIt, class T&gt;\nvoid fill(ForwardIt first, ForwardIt last, const T&amp; value);\n</code></pre></li> <li>std::generate: \u7528\u751f\u6210\u5668\u51fd\u6570\u586b\u5145\u8303\u56f4 C++<pre><code>template&lt;class ForwardIt, class Generator&gt;\nvoid generate(ForwardIt first, ForwardIt last, Generator gen);\n</code></pre></li> </ul> <p>```admonish example \u53ef\u4ee5\u4f7f\u7528\u968f\u673a\u6570\u751f\u6210\u5668\u6765\u8fdb\u884c\u586b\u5145 </p>Text Only<pre><code>```c++\n#include &lt;vector&gt;\n#include &lt;algorithm&gt;\n#include &lt;random&gt;\n\nstd::vector&lt;int&gt; v(5);\nint counter = 0;\nstd::generate(v.begin(), v.end(), [&amp;counter]() {\n    return counter++; // \u751f\u6210 0, 1, 2, 3, 4\n});\n\n// \u751f\u6210\u968f\u673a\u6570\nstd::random_device rd;\nstd::mt19937 rng(rd());\nstd::uniform_int_distribution&lt;int&gt; dist(1, 10);\nstd::generate(v.begin(), v.end(), [&amp;]() { return dist(rng); });\n</code></pre><p></p>"},{"location":"notes/C%2B%2B/2-Algorithm/#213-stdsearch-stdmismatch","title":"2.13 std::search, std::mismatch","text":"<ul> <li>std::search: \u5728\u5e8f\u5217\u4e2d\u641c\u7d22\u5b50\u5e8f\u5217\u3002</li> </ul> C++<pre><code>  template&lt;class ForwardIt1, class ForwardIt2&gt;\n  ForwardIt1 search(ForwardIt1 first1, ForwardIt1 last1, ForwardIt2 first2, ForwardIt2 last2);\n\n  // \u793a\u4f8b\uff1a\u5728 v1 \u4e2d\u67e5\u627e\u5b50\u5e8f\u5217 v2\n  std::vector&lt;int&gt; v1 = {1, 2, 3, 4, 5, 6};\n  std::vector&lt;int&gt; v2 = {3, 4};\n  auto it = std::search(v1.begin(), v1.end(), v2.begin(), v2.end()); // \u8fd4\u56de\u6307\u54113\u7684\u8fed\u4ee3\u5668\n</code></pre> <ul> <li>std::mismatch: \u5728\u6bd4\u8f83\u4e24\u4e2a\u5e8f\u5217\uff0c\u8fd4\u56de\u7b2c\u4e00\u4e2a\u4e0d\u5339\u914d\u7684\u4f4d\u7f6e\u3002</li> </ul> C++<pre><code>  template&lt;class InputIt1, class InputIt2&gt;\n  std::pair&lt;InputIt1, InputIt2&gt; mismatch(InputIt1 first1, InputIt1 last1, InputIt2 first2);\n\n  // \u793a\u4f8b\uff1a\u6bd4\u8f83\u4e24\u4e2a\u5b57\u7b26\u4e32\n  std::string s1 = \"hello\", s2 = \"hxllo\";\n  auto [it1, it2] = std::mismatch(s1.begin(), s1.end(), s2.begin()); \n  // it1\u6307\u5411s1\u7684'e', it2\u6307\u5411s2\u7684'x'\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#214-stdreplace-stdreplace_if","title":"2.14 std::replace, std::replace_if","text":"<ul> <li>std::replace: \u66ff\u6362\u6240\u6709\u7b49\u4e8e old_value \u7684\u5143\u7d20\u3002</li> </ul> C++<pre><code>template&lt;class ForwardIt, class T&gt;\nvoid replace(ForwardIt first, ForwardIt last, const T&amp; old_value, const T&amp; new_value);\n\n// \u793a\u4f8b\uff1a\u66ff\u6362\u6240\u67093\u4e3a5\nstd::vector&lt;int&gt; v = {1, 2, 3, 3, 4};\nstd::replace(v.begin(), v.end(), 3, 5); // v\u53d8\u4e3a{1, 2, 5, 5, 4}\n</code></pre> <ul> <li>std::replace_if: \u66ff\u6362\u6ee1\u8db3\u8c13\u8bcd\u7684\u5143\u7d20</li> </ul> C++<pre><code>template&lt;class ForwardIt, class Predicate, class T&gt;\nvoid replace_if(ForwardIt first, ForwardIt last, Predicate pred, const T&amp; new_value);\n\n// \u793a\u4f8b\uff1a\u66ff\u6362\u6240\u6709\u5076\u6570\u4e3a0\nstd::replace_if(v.begin(), v.end(), [](int x) { return x % 2 == 0; }, 0);\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#215-stdremove-stdremove_if","title":"2.15 std::remove / std::remove_if","text":"Text Only<pre><code>\u79fb\u52a8\u6ee1\u8db3\u6761\u4ef6\u7684\u5143\u7d20\u5230\u672b\u5c3e\uff0c\u8fd4\u56de\u65b0\u903b\u8f91\u7ed3\u5c3e\u3002\n</code></pre> C++<pre><code>template&lt;class ForwardIt, class T&gt;\nForwardIt remove(ForwardIt first, ForwardIt last, const T&amp; value);\n\ntemplate&lt;class ForwardIt, class Predicate&gt;\nForwardIt remove_if(ForwardIt first, ForwardIt last, Predicate pred);\n\n// \u793a\u4f8b\uff1a\u5220\u9664\u6240\u67093\uff08\u9700\u7ed3\u5408erase\uff09\nstd::vector&lt;int&gt; v = {1, 2, 3, 4, 3};\nauto new_end = std::remove(v.begin(), v.end(), 3);\nv.erase(new_end, v.end()); // v\u53d8\u4e3a{1, 2, 4}\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#216-stdreverse","title":"2.16 std::reverse","text":"<ul> <li>\u53cd\u8f6c\u6574\u4e2a\u5e8f\u5217</li> </ul> C++<pre><code>template&lt;class BidirIt&gt;\nvoid reverse(BidirIt first, BidirIt last);\n\n// \u793a\u4f8b\uff1a\u53cd\u8f6cvector\nstd::reverse(v.begin(), v.end()); // {1, 2, 3} \u2192 {3, 2, 1}\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#217-stdrotate","title":"2.17 std::rotate","text":"<ul> <li>\u628amiddle\u65cb\u8f6c\u5230\u5f00\u5934</li> </ul> C++<pre><code>template&lt;class ForwardIt&gt;\nForwardIt rotate(ForwardIt first, ForwardIt middle, ForwardIt last);\n\n// \u793a\u4f8b\uff1a\u5c06\u4e2d\u95f4\u5143\u7d20\u65cb\u8f6c\u5230\u5f00\u5934\nstd::vector&lt;int&gt; v = {1, 2, 3, 4, 5};\nstd::rotate(v.begin(), v.begin() + 2, v.end()); // v\u53d8\u4e3a{3, 4, 5, 1, 2}\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#218-stdshuffle","title":"2.18 std::shuffle","text":"<ul> <li>\u4f7f\u7528\u4e00\u4e2a\u968f\u673a\u751f\u6210\u5668\uff0c\u6253\u4e71\u5e8f\u5217</li> </ul> C++<pre><code>template&lt;class RandomIt, class RandomGen&gt;\nvoid shuffle(RandomIt first, RandomIt last, RandomGen&amp;&amp; g);\n\n// \u793a\u4f8b\uff1a\u4f7f\u7528\u968f\u673a\u5f15\u64ce\n#include &lt;random&gt;\nstd::vector&lt;int&gt; v = {1, 2, 3, 4};\nstd::random_device rd;\nstd::mt19937 rng(rd());\nstd::shuffle(v.begin(), v.end(), rng); // \u968f\u673a\u6392\u5217\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#219-stdunique","title":"2.19 std::unique","text":"Text Only<pre><code>\u5220\u9664\u76f8\u90bb\u91cd\u590d\u5143\u7d20\uff08\u9700\u5148\u6392\u5e8f\uff09\u3002\n</code></pre> C++<pre><code>template&lt;class ForwardIt&gt;\nForwardIt unique(ForwardIt first, ForwardIt last);\n\n// \u793a\u4f8b\uff1a\u5220\u9664\u76f8\u90bb\u91cd\u590d\u9879\nstd::vector&lt;int&gt; v = {1, 1, 2, 3, 3};\nauto last = std::unique(v.begin(), v.end());\nv.erase(last, v.end()); // v\u53d8\u4e3a{1, 2, 3}\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#220-stdsort-stdstable_sort-stdpartial_sort","title":"2.20 std::sort, std::stable_sort, std::partial_sort","text":"<ul> <li>std::partial_sort\u662f\u90e8\u5206\u6392\u5e8f</li> </ul> C++<pre><code>template&lt;class RandomIt&gt;\nvoid sort(RandomIt first, RandomIt last);\n\ntemplate&lt;class RandomIt&gt;\nvoid stable_sort(RandomIt first, RandomIt last);\n\n// \u793a\u4f8b\uff1a\u964d\u5e8f\u6392\u5e8f\nstd::sort(v.begin(), v.end(), [](int a, int b) { return a &gt; b; });\n\ntemplate&lt;class RandomIt&gt;\nvoid partial_sort(RandomIt first, RandomIt middle, RandomIt last);\n\n// \u793a\u4f8b\uff1a\u627e\u5230\u524d3\u5c0f\u7684\u5143\u7d20\nstd::vector&lt;int&gt; v = {5, 3, 1, 4, 2};\nstd::partial_sort(v.begin(), v.begin() + 3, v.end()); // \u524d3\u4e2a\u5143\u7d20\u4e3a{1, 2, 3}\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#221-stdnth_element","title":"2.21 std::nth_element","text":"<ul> <li>\u5c06\u7b2cn\u4e2a\u5143\u7d20\u6392\u5e8f\u5230\u6b63\u786e\u7684\u4f4d\u7f6e\u4e0a</li> </ul> C++<pre><code>template&lt;class RandomIt&gt;\nvoid nth_element(RandomIt first, RandomIt nth, RandomIt last);\n\n// \u793a\u4f8b\uff1a\u627e\u5230\u7b2c3\u5c0f\u7684\u5143\u7d20\nstd::nth_element(v.begin(), v.begin() + 2, v.end()); \n// v = 3\uff0c\u5176\u4ed6\u5143\u7d20\u76f8\u5bf9\u65e0\u5e8f\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#222-stdmerge","title":"2.22 std::merge","text":"<ul> <li>\u5408\u5e76\u4e24\u4e2a\u6709\u5e8f\u5e8f\u5217</li> </ul> C++<pre><code>template&lt;class InputIt1, class InputIt2, class OutputIt&gt;\nOutputIt merge(InputIt1 first1, InputIt1 last1, InputIt2 first2, InputIt2 last2, OutputIt d_first);\n\n// \u793a\u4f8b\uff1a\u5408\u5e76\u4e24\u4e2a\u6709\u5e8fvector\nstd::vector&lt;int&gt; v1 = {1, 3, 5}, v2 = {2, 4, 6}, result;\nstd::merge(v1.begin(), v1.end(), v2.begin(), v2.end(), std::back_inserter(result)); \n// result = {1, 2, 3, 4, 5, 6}\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#223-stdpartition-stdstable_partition-stdpartition_point","title":"2.23 std::partition, std::stable_partition, std::partition_point","text":"<ul> <li>std::partition: \u5c06\u6ee1\u8db3\u6761\u4ef6\u7684\u5143\u7d20\u79fb\u52a8\u5230\u524d\u7aef</li> </ul> C++<pre><code>template&lt;class ForwardIt, class Predicate&gt;\nForwardIt partition(ForwardIt first, ForwardIt last, Predicate pred);\n\n// \u793a\u4f8b\uff1a\u6309\u5947\u5076\u5206\u533a\nstd::vector&lt;int&gt; v = {1, 2, 3, 4, 5};\nauto it = std::partition(v.begin(), v.end(), [](int x) { return x % 2 != 0; });\n// \u5947\u6570\u5728\u524d\uff0c\u5076\u6570\u5728\u540e\uff08\u53ef\u80fd\u6539\u53d8\u76f8\u5bf9\u987a\u5e8f\uff09\n</code></pre> <ul> <li>std::partition_point: \u8fd4\u56de\u5206\u533a\u70b9</li> </ul> C++<pre><code>template&lt;class ForwardIt, class Predicate&gt;\nForwardIt partition_point(ForwardIt first, ForwardIt last, Predicate pred);\n\n// \u793a\u4f8b\uff1a\u627e\u5230\u5206\u533a\u70b9\nauto it = std::partition_point(v.begin(), v.end(), [](int x) { return x % 2 != 0; });\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#224-stdminelement-stdmaxelement-stdclamp","title":"2.24 std::minelement, std::maxelement, std::clamp","text":"C++<pre><code>template&lt;class ForwardIt&gt;\nForwardIt min_element(ForwardIt first, ForwardIt last);\n\n// \u793a\u4f8b\uff1a\u627e\u5230\u6700\u5927\u503c\nauto it = std::max_element(v.begin(), v.end());\n</code></pre> <ul> <li>std: \u5c06\u5143\u7d20\u9650\u5236\u5728\u8303\u56f4\u5185</li> </ul> C++<pre><code>template&lt;class T&gt;\nconst T&amp; clamp(const T&amp; value, const T&amp; lo, const T&amp; hi);\n\n// \u793a\u4f8b\uff1a\u9650\u5236\u6570\u503c\u5728[0, 100]\nint x = 150;\nx = std::clamp(x, 0, 100); // x\u53d8\u4e3a100\n</code></pre>"},{"location":"notes/C%2B%2B/2-Algorithm/#225-stdsample","title":"2.25 std::sample","text":"<ul> <li>\u968f\u673a\u91c7\u6837\uff0c\u9700\u8981\u63d2\u5165\u8fed\u4ee3\u5668</li> </ul> C++<pre><code>template&lt;class PopulationIt, class SampleIt, class Distance, class UniformRandomBitGenerator&gt;\nSampleIt sample(PopulationIt first, PopulationIt last, SampleIt out, Distance n, UniformRandomBitGenerator&amp;&amp; g);\n\n// \u793a\u4f8b\uff1a\u968f\u673a\u91c7\u68373\u4e2a\u5143\u7d20\nstd::vector&lt;int&gt; src = {1, 2, 3, 4, 5}, dest;\nstd::sample(src.begin(), src.end(), std::back_inserter(dest), 3, std::mt19937{});\n</code></pre>"},{"location":"notes/C%2B%2B/3-Iterator/","title":"3-Iterator","text":""},{"location":"notes/C%2B%2B/3-Iterator/#3-iterator","title":"3 Iterator","text":"<p> \u7ea6 444 \u4e2a\u5b57  45 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p> 2025-12-022025-12-10 <ul> <li>\u8f93\u5165\u8fed\u4ee3\u5668\uff1a\u53ea\u80fd\u7528\u6765\u8bfb\u53d6\u6307\u5411\u7684\u503c\uff1b\u5f53\u8be5\u8fed\u4ee3\u5668\u81ea\u52a0\u65f6\uff0c\u4e4b\u524d\u6307\u5411\u7684\u503c\u5c31\u4e0d\u53ef\u8bbf\u95ee\u3002 <code>admonish example   std::istream_iterator \u5c31\u662f\u8fd9\u6837\u7684\u8fed\u4ee3\u5668\u3002</code></li> <li>\u524d\u5411\u8fed\u4ee3\u5668\uff1a\u7c7b\u4f3c\u4e8e\u8f93\u5165\u8fed\u4ee3\u5668\uff0c\u53ef\u4ee5\u5728\u6307\u793a\u8303\u56f4\u8fed\u4ee3\u591a\u6b21 <code>admonish example   std::forward_list \u5c31\u662f\u8fd9\u6837\u7684\u8fed\u4ee3\u5668\u3002\u5c31\u50cf\u4e00\u4e2a\u5355\u5411\u94fe\u8868\u4e00\u6837\uff0c\u53ea\u80fd\u5411\u524d\u904d\u5386\uff0c\u4e0d\u80fd\u5411\u540e\u904d\u5386\uff0c\u4f46\u53ef\u4ee5\u53cd\u590d\u8fed\u4ee3\u3002</code></li> <li>\u53cc\u5411\u8fed\u4ee3\u5668\uff1a\u8fd9\u4e2a\u8fed\u4ee3\u5668\u53ef\u4ee5\u81ea\u589e\uff0c\u4e5f\u53ef\u4ee5\u81ea\u51cf\uff0c\u8fed\u4ee3\u5668\u53ef\u4ee5\u5411\u524d\u6216\u5411\u540e\u8fed\u4ee3\u3002 <code>admonish example   std::list, std::set \u548c std::map \u90fd\u652f\u6301\u53cc\u5411\u8fed\u4ee3\u5668\u3002</code></li> <li>\u968f\u673a\u8bbf\u95ee\u8fed\u4ee3\u5668\uff1a\u4e0e\u5176\u4ed6\u8fed\u4ee3\u5668\u4e0d\u540c\uff0c\u968f\u673a\u8bbf\u95ee\u8fed\u4ee3\u5668\u4e00\u6b21\u53ef\u4ee5\u8df3\u8f6c\u5230\u4efb\u4f55\u5bb9\u5668\u4e2d\u7684\u5143\u7d20\u4e0a\uff0c\u800c\u975e\u4e4b\u524d\u7684\u8fed\u4ee3\u5668\uff0c\u4e00\u6b21\u53ea\u80fd\u79fb\u52a8\u4e00\u683c\u3002 <code>admonish example   std::vector \u548c std::deque \u7684\u8fed\u4ee3\u5668\u5c31\u662f\u8fd9\u79cd\u7c7b\u578b\u3002</code></li> <li>\u8fde\u7eed\u8fed\u4ee3\u5668\uff1a\u8fd9\u79cd\u8fed\u4ee3\u5668\u5177\u6709\u524d\u8ff0\u51e0\u79cd\u8fed\u4ee3\u5668\u7684\u6240\u6709\u7279\u6027\uff0c\u4e0d\u8fc7\u9700\u8981\u5bb9\u5668\u5185\u5bb9\u5728\u5185\u5b58\u4e0a\u662f\u8fde\u7eed\u7684\uff0c\u7c7b\u4f3c\u4e00\u4e2a\u6570\u7ec4\u6216 std::vector \u3002</li> <li>\u8f93\u51fa\u8fed\u4ee3\u5668\uff1a\u8be5\u8fed\u4ee3\u5668\u4e0e\u5176\u4ed6\u8fed\u4ee3\u5668\u4e0d\u540c\u3002\u56e0\u4e3a\u8fd9\u662f\u4e00\u4e2a\u5355\u7eaf\u7528\u4e8e\u5199\u51fa\u7684\u8fed\u4ee3\u5668\uff0c\u5176\u53ea\u80fd\u589e\u52a0\uff0c\u5e76\u4e14\u5c06\u5bf9\u5e94\u5185\u5bb9\u5199\u5165\u6587\u4ef6\u5f53\u4e2d\u3002\u5982\u679c\u8981\u8bfb\u53d6\u8fd9\u4e2a\u8fed\u4ee3\u4e2d\u7684\u6570\u636e\uff0c\u90a3\u4e48\u8bfb\u53d6\u5230\u7684\u503c\u5c31\u662f\u672a\u5b9a\u4e49\u7684</li> <li>\u53ef\u53d8\u8fed\u4ee3\u5668\uff1a\u5982\u679c\u4e00\u4e2a\u8fed\u4ee3\u5668\u65e2\u6709\u8f93\u51fa\u8fed\u4ee3\u5668\u7684\u7279\u6027\uff0c\u53c8\u6709\u5176\u4ed6\u8fed\u4ee3\u5668\u7684\u7279\u6027\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8fed\u4ee3\u5668\u5c31\u662f\u53ef\u53d8\u8fed\u4ee3\u5668\u3002 <code>admonish example   \u8be5\u8fed\u4ee3\u5668\u53ef\u8bfb\u53ef\u5199\u3002\u5982\u679c\u6211\u4eec\u4ece\u4e00\u4e2a\u975e\u5e38\u91cf\u5bb9\u5668\u7684\u5b9e\u4f8b\u4e2d\u83b7\u53d6\u4e00\u4e2a\u8fed\u4ee3\u5668\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8fed\u4ee3\u5668\u901a\u5e38\u90fd\u662f\u53ef\u53d8\u8fed\u4ee3\u5668\u3002</code></li> </ul>"},{"location":"notes/C%2B%2B/3-Iterator/#31-stdback_insert_iterator","title":"3.1 std::back_insert_iterator","text":"<ul> <li>\u5185\u90e8\u8c03\u7528\u5bb9\u5668\u7684<code>push_back</code>\u65b9\u6cd5</li> </ul> C++<pre><code>// \u4f7f\u7528 back_insert_iterator \u5728 destination \u7684\u672b\u5c3e\u63d2\u5165\u5143\u7d20\nstd::copy(source.begin(), source.end(), std::back_inserter(destination));\n</code></pre>"},{"location":"notes/C%2B%2B/3-Iterator/#32-stdfront_insert_iterator","title":"3.2 std::front_insert_iterator","text":"<ul> <li>\u5185\u90e8\u8c03\u7528\u5bb9\u5668\u7684<code>push_front</code>\u65b9\u6cd5</li> </ul> C++<pre><code>// \u4f7f\u7528 front_insert_iterator \u5728 destination \u7684\u5f00\u5934\u63d2\u5165\u5143\u7d20\nstd::copy(source.begin(), source.end(), std::front_inserter(destination));  \n</code></pre>"},{"location":"notes/C%2B%2B/3-Iterator/#33-stdinsert_iterator","title":"3.3 std::insert_iterator","text":"<ul> <li>std::insert_iterator \u662f\u4e00\u4e2a\u901a\u7528\u7684\u63d2\u5165\u8fed\u4ee3\u5668\uff0c\u53ef\u4ee5\u5728\u5bb9\u5668\u7684\u4efb\u610f\u4f4d\u7f6e\u63d2\u5165\u5143\u7d20\u3002\u5b83\u9700\u8981\u4e00\u4e2a\u5bb9\u5668\u548c\u4e00\u4e2a\u63d2\u5165\u4f4d\u7f6e\u3002</li> </ul> C++<pre><code>// \u5728 destination \u7684\u7b2c\u4e8c\u4e2a\u4f4d\u7f6e\u63d2\u5165 source \u7684\u5143\u7d20\nstd::copy(source.begin(), source.end(), std::inserter(destination, destination.begin() + 1));\n</code></pre>"},{"location":"notes/C%2B%2B/3-Iterator/#34-stdistream_iterator","title":"3.4 std::istream_iterator","text":""},{"location":"notes/C%2B%2B/3-Iterator/#-stdistream_iterator-stdcin","title":"- std::istream_iterator \u662f\u4e00\u4e2a\u8f93\u5165\u6d41\u8fed\u4ee3\u5668\uff0c\u7528\u4e8e\u4ece\u8f93\u5165\u6d41\uff08\u5982 std::cin\uff09\u8bfb\u53d6\u6570\u636e","text":"C++<pre><code>#include &lt;iostream&gt;\n#include &lt;vector&gt;\n#include &lt;iterator&gt;\n#include &lt;algorithm&gt; // std::copy\n\nint main() {\n    std::vector&lt;int&gt; numbers;\n\n    std::cout &lt;&lt; \"Enter some integers (end with EOF):\" &lt;&lt; std::endl;\n\n    // \u4f7f\u7528 istream_iterator \u4ece std::cin \u8bfb\u53d6\u6574\u6570\n    std::copy(std::istream_iterator&lt;int&gt;(std::cin), std::istream_iterator&lt;int&gt;(), std::back_inserter(numbers));\n\n    std::cout &lt;&lt; \"You entered:\" &lt;&lt; std::endl;\n    for (int num : numbers) {\n        std::cout &lt;&lt; num &lt;&lt; \" \";\n    }\n    // \u8f93\u51fa\u7528\u6237\u8f93\u5165\u7684\u6574\u6570\n    return 0;\n}\n</code></pre>"},{"location":"notes/C%2B%2B/3-Iterator/#35-stdostream_iterator","title":"3.5 std::ostream_iterator","text":"<ul> <li>std::ostream_iterator \u662f\u4e00\u4e2a\u8f93\u51fa\u6d41\u8fed\u4ee3\u5668\uff0c\u7528\u4e8e\u5c06\u6570\u636e\u5199\u5165\u8f93\u51fa\u6d41\uff08\u5982 std::cout\uff09</li> </ul> C++<pre><code>#include &lt;iostream&gt;\n#include &lt;vector&gt;\n#include &lt;iterator&gt;\n#include &lt;algorithm&gt; // std::copy\n\nint main() {\n    std::vector&lt;int&gt; numbers = {1, 2, 3, 4, 5};\n\n    // \u4f7f\u7528 ostream_iterator \u5c06 numbers \u5199\u5165 std::cout\uff0c\u6bcf\u4e2a\u5143\u7d20\u540e\u52a0\u7a7a\u683c\n    std::copy(numbers.begin(), numbers.end(), std::ostream_iterator&lt;int&gt;(std::cout, \" \"));\n\n    // \u8f93\u51fa: 1 2 3 4 5\n    return 0;\n}\n</code></pre>"},{"location":"notes/C%2B%2B/4-Filesystem/","title":"4 Filesystem","text":"<p> \u7ea6 828 \u4e2a\u5b57  243 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"notes/C%2B%2B/4-Filesystem/#4-filesystem","title":"4 FileSystem","text":"<ul> <li>\u6587\u4ef6\u7cfb\u7edf\u5e93\u63d0\u4f9b\u5bf9\u6587\u4ef6\u7cfb\u7edf\u53ca\u5176\u7ec4\u4ef6\uff08\u4f8b\u5982\u8def\u5f84\u3001\u5e38\u89c4\u6587\u4ef6\u548c\u76ee\u5f55\uff09\u6267\u884c\u64cd\u4f5c\u7684\u5de5\u5177\u3002</li> </ul> <p><code>admonish info   \u6587\u4ef6\u7cfb\u7edf\u5e93\u6700\u521d\u5f00\u53d1\u4e3aboost.filesystem \uff0c\u5e76\u4f5c\u4e3a\u6280\u672f\u89c4\u8303 ISO/IEC TS 18822:2015\u53d1\u5e03\uff0c\u6700\u7ec8\u4e8e C++17 \u5408\u5e76\u5230 ISO C++ \u4e2d\u3002\u76ee\u524d\uff0cboost \u5b9e\u73b0\u5728\u6bd4 C++17 \u5e93\u66f4\u591a\u7684\u7f16\u8bd1\u5668\u548c\u5e73\u53f0\u4e0a\u53ef\u7528\u3002</code></p> <ul> <li>\u5982\u679c\u5bf9\u6b64\u5e93\u4e2d\u7684\u51fd\u6570\u7684\u8c03\u7528\u5f15\u53d1\u6587\u4ef6\u7cfb\u7edf\u7ade\u4e89\uff0c\u5373\u5f53\u591a\u4e2a\u7ebf\u7a0b\u3001\u8fdb\u7a0b\u6216\u8ba1\u7b97\u673a\u4ea4\u9519\u8bbf\u95ee\u548c\u4fee\u6539\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u540c\u4e00\u5bf9\u8c61\u65f6\uff0c\u5219\u884c\u4e3a\u672a\u5b9a\u4e49\u3002</li> </ul>"},{"location":"notes/C%2B%2B/4-Filesystem/#41","title":"4.1 \u5b9a\u4e49","text":"<ul> <li>file\uff1a\u4fdd\u5b58\u6570\u636e\u7684\u6587\u4ef6\u7cfb\u7edf\u5bf9\u8c61\uff0c\u53ef\u4ee5\u5199\u5165\u3001\u8bfb\u53d6\u6216\u4e24\u8005\u517c\u800c\u6709\u4e4b\u3002\u6587\u4ef6\u5177\u6709\u540d\u79f0\u3001\u5c5e\u6027\uff0c\u5176\u4e2d\u4e4b\u4e00\u662f\u6587\u4ef6\u7c7b\u578b\uff1a</li> <li>\u76ee\u5f55\uff1a\u5145\u5f53\u76ee\u5f55\u6761\u76ee\u5bb9\u5668\u7684\u6587\u4ef6\uff0c\u7528\u4e8e\u6807\u8bc6\u5176\u4ed6\u6587\u4ef6\uff08\u5176\u4e2d\u4e00\u4e9b\u53ef\u80fd\u662f\u5176\u4ed6\u5d4c\u5957\u76ee\u5f55\uff09\u3002\u5728\u8ba8\u8bba\u7279\u5b9a\u6587\u4ef6\u65f6\uff0c\u8be5\u6587\u4ef6\u4f5c\u4e3a\u6761\u76ee\u51fa\u73b0\u7684\u76ee\u5f55\u662f\u5176\u7236\u76ee\u5f55\u3002\u7236\u76ee\u5f55\u53ef\u4ee5\u7528\u76f8\u5bf9\u8def\u5f84\u540d\u8868\u793a\u201c\u2026\u2026\u201d\u3002</li> <li>\u5e38\u89c4\u6587\u4ef6\uff1a\u5c06\u540d\u79f0\u4e0e\u73b0\u6709\u6587\u4ef6\u5173\u8054\u7684\u76ee\u5f55\u6761\u76ee\uff08\u5373\u786c\u94fe\u63a5\uff09\u3002\u5982\u679c\u652f\u6301\u591a\u4e2a\u786c\u94fe\u63a5\uff0c\u5219\u5728\u5220\u9664\u6307\u5411\u8be5\u6587\u4ef6\u7684\u6700\u540e\u4e00\u4e2a\u786c\u94fe\u63a5\u540e\uff0c\u8be5\u6587\u4ef6\u5c06\u88ab\u5220\u9664\u3002</li> <li>\u7b26\u53f7\u94fe\u63a5\uff1a\u5c06\u540d\u79f0\u4e0e\u8def\u5f84\u76f8\u5173\u8054\u7684\u76ee\u5f55\u6761\u76ee\uff0c\u8be5\u8def\u5f84\u53ef\u80fd\u5b58\u5728\u4e5f\u53ef\u80fd\u4e0d\u5b58\u5728\u3002</li> <li>\u5176\u4ed6\u7279\u6b8a\u6587\u4ef6\u7c7b\u578b\uff1a\u5757\u3001\u5b57\u7b26\u3001fifo\u3001\u5957\u63a5\u5b57\u3002</li> <li>\u6587\u4ef6\u540d\uff1a\u7528\u4e8e\u547d\u540d\u6587\u4ef6\u7684\u5b57\u7b26\u4e32\u3002\u5141\u8bb8\u7684\u5b57\u7b26\u3001\u533a\u5206\u5927\u5c0f\u5199\u3001\u6700\u5927\u957f\u5ea6\u548c\u4e0d\u5141\u8bb8\u7684\u540d\u79f0\u7531\u5b9e\u73b0\u5b9a\u4e49\u3002\u540d\u79f0\u201c.\u201d\u548c\u201c..\u201d\u5728\u5e93\u5c42\u9762\u5177\u6709\u7279\u6b8a\u542b\u4e49\u3002</li> <li>\u8def\u5f84\uff1a\u6807\u8bc6\u6587\u4ef6\u7684\u5143\u7d20\u5e8f\u5217\u3002\u5b83\u4ee5\u53ef\u9009\u7684\u6839\u540d\u79f0\u5f00\u5934\u200b\u200b\uff08\u4f8b\u5982\u201cC\uff1a\u201d\u6216\u8005\u201c//server\u201d\u5728 Windows \u4e0a\uff09\uff0c\u7136\u540e\u662f\u53ef\u9009\u7684\u6839\u76ee\u5f55\uff08\u4f8b\u5982\u201c/\u201d\u5728 Unix \u4e0a\uff09\uff0c\u540e\u8ddf\u96f6\u4e2a\u6216\u591a\u4e2a\u6587\u4ef6\u540d\u5e8f\u5217\uff08\u9664\u6700\u540e\u4e00\u4e2a\u6587\u4ef6\u540d\u5916\uff0c\u5176\u4ed6\u6587\u4ef6\u540d\u90fd\u5fc5\u987b\u662f\u76ee\u5f55\u6216\u76ee\u5f55\u94fe\u63a5\uff09\u3002\u8def\u5f84 (pathname )\u7684\u5b57\u7b26\u4e32\u8868\u793a\u7684\u672c\u673a\u683c\u5f0f\uff08\u4f8b\u5982\uff0c\u4f7f\u7528\u54ea\u4e9b\u5b57\u7b26\u4f5c\u4e3a\u5206\u9694\u7b26\uff09\u548c\u5b57\u7b26\u7f16\u7801\u662f\u5b9e\u73b0\u5b9a\u4e49\u7684\uff0c\u6b64\u5e93\u63d0\u4f9b\u53ef\u79fb\u690d\u7684\u8def\u5f84\u8868\u793a\u3002</li> <li>\u7edd\u5bf9\u8def\u5f84\uff1a\u660e\u786e\u6807\u8bc6\u6587\u4ef6\u4f4d\u7f6e\u7684\u8def\u5f84\u3002</li> <li>\u89c4\u8303\u8def\u5f84\uff1a\u4e0d\u5305\u542b\u7b26\u53f7\u94fe\u63a5\u7684\u7edd\u5bf9\u8def\u5f84\uff0c\u201c.\u201d\u6216\u8005\u201c..\u201d\u5143\u7d20\u3002</li> <li>\u76f8\u5bf9\u8def\u5f84\uff1a\u7528\u4e8e\u6807\u8bc6\u6587\u4ef6\u76f8\u5bf9\u4e8e\u6587\u4ef6\u7cfb\u7edf\u4e0a\u67d0\u4e2a\u4f4d\u7f6e\u7684\u4f4d\u7f6e\u7684\u8def\u5f84\u3002\u7279\u6b8a\u8def\u5f84\u540d\u201c.\u201d\uff08\u70b9\uff0c\u201c\u5f53\u524d\u76ee\u5f55\u201d\uff09\u548c\u201c..\u201d\uff08\u70b9\u70b9\uff0c\u201c\u7236\u76ee\u5f55\u201d\uff09\u662f\u76f8\u5bf9\u8def\u5f84\u3002</li> </ul>"},{"location":"notes/C%2B%2B/4-Filesystem/#42-directory","title":"4.2 directory","text":"C++<pre><code>#include &lt;algorithm&gt;\n#include &lt;filesystem&gt;\n#include &lt;fstream&gt;\n#include &lt;iostream&gt;\n\nint main()\n{\n    const std::filesystem::path sandbox{\"sandbox\"};\n    std::filesystem::create_directories(sandbox/\"dir1\"/\"dir2\");\n    std::ofstream{sandbox/\"file1.txt\"};\n    std::ofstream{sandbox/\"file2.txt\"};\n\n    std::cout &lt;&lt; \"directory_iterator:\\n\";\n    // directory_iterator can be iterated using a range-for loop\n    for (auto const&amp; dir_entry : std::filesystem::directory_iterator{sandbox}) \n        std::cout &lt;&lt; dir_entry.path() &lt;&lt; '\\n';\n\n    std::cout &lt;&lt; \"\\ndirectory_iterator as a range:\\n\";\n    // directory_iterator behaves as a range in other ways, too\n    std::ranges::for_each(\n        std::filesystem::directory_iterator{sandbox},\n        [](const auto&amp; dir_entry) { std::cout &lt;&lt; dir_entry &lt;&lt; '\\n'; });\n\n    std::cout &lt;&lt; \"\\nrecursive_directory_iterator:\\n\";\n    for (auto const&amp; dir_entry : std::filesystem::recursive_directory_iterator{sandbox}) \n        std::cout &lt;&lt; dir_entry &lt;&lt; '\\n';\n\n    // delete the sandbox dir and all contents within it, including subdirs\n    std::filesystem::remove_all(sandbox);\n}\n// Possible output:\n// directory_iterator:\n// \"sandbox/file2.txt\"\n// \"sandbox/file1.txt\"\n// \"sandbox/dir1\"\n\n// directory_iterator as a range:\n// \"sandbox/file2.txt\"\n// \"sandbox/file1.txt\"\n// \"sandbox/dir1\"\n\n// recursive_directory_iterator:\n// \"sandbox/file2.txt\"\n// \"sandbox/file1.txt\"\n// \"sandbox/dir1\"\n// \"sandbox/dir1/dir2\"\n</code></pre>"},{"location":"notes/C%2B%2B/4-Filesystem/#43-space_info","title":"4.3 space_info","text":"<ul> <li> <p>\u786e\u5b9a\u8def\u5f84\u540d\u6240\u5728\u7684\u6587\u4ef6\u7cfb\u7edf\u7684\u4fe1\u606f\u9875\u4f4d\u4e8e\uff0c\u5982\u540c\u901a\u8fc7 POSIX \u7684 statvfs \u64cd\u4f5c\u4e00\u6837\u3002</p> </li> <li> <p>\u8be5\u5bf9\u8c61\u7531 POSIX struct statvfs \u5185\u5bb9\u8fdb\u884c\u586b\u5145\u5982\u4e0b\u6240\u793a\uff1a</p> </li> <li> <p>space_info.capacity\u8bbe\u7f6e\u4e3af_blocks * f_frsize\u3002</p> </li> <li>space_info.free\u8bbe\u7f6e\u4e3af_bfree * f_frsize\u3002</li> <li>space_info.available\u8bbe\u7f6e\u4e3af_bavail * f_frsize\u3002</li> <li>\u4efb\u4f55\u65e0\u6cd5\u786e\u5b9a\u7684\u6210\u5458\u90fd\u8bbe\u7f6e\u4e3astatic_cast(-1)</li> </ul> C++<pre><code>#include &lt;cstdint&gt;\n#include &lt;filesystem&gt;\n#include &lt;iostream&gt;\n#include &lt;locale&gt;\n\nstd::uintmax_t disk_usage_percent(const std::filesystem::space_info&amp; si,\n                                  bool is_privileged = false) noexcept\n{\n    if (constexpr std::uintmax_t X(-1);\n        si.capacity == 0 || si.free == 0 || si.available == 0 ||\n        si.capacity == X || si.free == X || si.available == X\n    )\n        return 100;\n\n    std::uintmax_t unused_space = si.free, capacity = si.capacity;\n    if (!is_privileged)\n    {\n        const std::uintmax_t privileged_only_space = si.free - si.available;\n        unused_space -= privileged_only_space;\n        capacity -= privileged_only_space;\n    }\n    const std::uintmax_t used_space{capacity - unused_space};\n    return 100 * used_space / capacity;\n}\n\nvoid print_disk_space_info(auto const&amp; dirs, int width = 14)\n{\n    (std::cout &lt;&lt; std::left).imbue(std::locale(\"en_US.UTF-8\"));\n\n    for (const auto s : {\"Capacity\", \"Free\", \"Available\", \"Use%\", \"Dir\"})\n        std::cout &lt;&lt; \"\u2502 \" &lt;&lt; std::setw(width) &lt;&lt; s &lt;&lt; ' ';\n\n    for (std::cout &lt;&lt; '\\n'; auto const&amp; dir : dirs)\n    {\n        std::error_code ec;\n        const std::filesystem::space_info si = std::filesystem::space(dir, ec);\n        for (auto x : {si.capacity, si.free, si.available, disk_usage_percent(si)})\n            std::cout &lt;&lt; \"\u2502 \" &lt;&lt; std::setw(width) &lt;&lt; static_cast&lt;std::intmax_t&gt;(x) &lt;&lt; ' ';\n        std::cout &lt;&lt; \"\u2502 \" &lt;&lt; dir &lt;&lt; '\\n';\n    }\n}\n\nint main()\n{\n    const auto dirs = {\"/dev/null\", \"/tmp\", \"/home\", \"/proc\", \"/null\"};\n    print_disk_space_info(dirs);\n}\n// Possible output:\n\n// \u2502 Capacity       \u2502 Free           \u2502 Available      \u2502 Use%           \u2502 Dir            \n// \u2502 84,417,331,200 \u2502 42,732,986,368 \u2502 40,156,028,928 \u2502 50             \u2502 /dev/null\n// \u2502 84,417,331,200 \u2502 42,732,986,368 \u2502 40,156,028,928 \u2502 50             \u2502 /tmp\n// \u2502 -1             \u2502 -1             \u2502 -1             \u2502 100            \u2502 /home\n// \u2502 0              \u2502 0              \u2502 0              \u2502 100            \u2502 /proc\n// \u2502 -1             \u2502 -1             \u2502 -1             \u2502 100            \u2502 /null\n</code></pre>"},{"location":"notes/C%2B%2B/4-Filesystem/#44-symlink","title":"4.4 symlink","text":"<ul> <li>\u8f6f\u94fe\u63a5\u4e5f\u53eb\u7b26\u53f7\u94fe\u63a5\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684inode\u5757\uff0c\u91cc\u9762\u7684\u6570\u636e\u5185\u5bb9\u662f\u94fe\u63a5\u7684\u6587\u4ef6\u540d\u79f0</li> <li>\u521b\u5efa\u4e00\u4e2a\u8f6f\u94fe\u63a5</li> </ul> C++<pre><code>#include &lt;cassert&gt;\n#include &lt;filesystem&gt;\n#include &lt;iostream&gt;\nnamespace fs = std::filesystem;\n\nint main()\n{\n    fs::create_directories(\"sandbox/subdir\");\n    fs::create_symlink(\"target\", \"sandbox/sym1\");\n    fs::create_directory_symlink(\"subdir\", \"sandbox/sym2\");\n\n    for (auto it = fs::directory_iterator(\"sandbox\"); it != fs::directory_iterator(); ++it)\n        if (is_symlink(it-&gt;symlink_status()))\n            std::cout &lt;&lt; *it &lt;&lt; \"-&gt;\" &lt;&lt; read_symlink(*it) &lt;&lt; '\\n';\n\n    assert(std::filesystem::equivalent(\"sandbox/sym2\", \"sandbox/subdir\"));\n    fs::remove_all(\"sandbox\");\n}\n\n// Possible output:\n\n// \"sandbox/sym1\"-&gt;\"target\"\n// \"sandbox/sym2\"-&gt;\"subdir\"\n</code></pre> <p>```admonish info \u8bfb\u53d6\u8f6f\u94fe\u63a5\u6587\u4ef6\uff0c\u4f1a\u83b7\u53d6\u5230\u88ab\u94fe\u63a5\u7684\u6587\u4ef6\u672c\u8eab </p>Text Only<pre><code>```c++\n#include &lt;filesystem&gt;\n#include &lt;iostream&gt;\n\nnamespace fs = std::filesystem;\n\nint main()\n{\n    for (fs::path p : {\"/usr/bin/gcc\", \"/bin/cat\", \"/bin/mouse\"})\n    {\n        std::cout &lt;&lt; p;\n        fs::exists(p) ?\n            fs::is_symlink(p) ?\n                std::cout &lt;&lt; \" -&gt; \" &lt;&lt; fs::read_symlink(p) &lt;&lt; '\\n' :\n                std::cout &lt;&lt; \" exists but it is not a symlink\\n\" :\n            std::cout &lt;&lt; \" does not exist\\n\";\n    }\n}\n\n// Possible output:\n\n// \"/usr/bin/gcc\" -&gt; \"gcc-5\"\n// \"/bin/cat\" exists but it is not a symlink\n// \"/bin/mouse\" does not exist\n</code></pre><p></p>"},{"location":"notes/C%2B%2B/4-Filesystem/#45-status","title":"4.5 status","text":"<p>```admonish info \u5c31\u50cfPOSIX\u4e2d stat \u83b7\u53d6\u6587\u4ef6\u65b9\u5f0f\u7c7b\u4f3c </p>Text Only<pre><code>```c++\n#include &lt;cstdio&gt;\n#include &lt;cstring&gt;\n#include &lt;filesystem&gt;\n#include &lt;fstream&gt;\n#include &lt;iostream&gt;\n#include &lt;sys/socket.h&gt;\n#include &lt;sys/stat.h&gt;\n#include &lt;sys/un.h&gt;\n#include &lt;unistd.h&gt;\n\nnamespace fs = std::filesystem;\n\nvoid demo_status(const fs::path&amp; p, fs::file_status s)\n{\n    std::cout &lt;&lt; p;\n    // alternative: switch(s.type()) { case fs::file_type::regular: ...}\n    if (fs::is_regular_file(s))\n        std::cout &lt;&lt; \" is a regular file\\n\";\n    if (fs::is_directory(s))\n        std::cout &lt;&lt; \" is a directory\\n\";\n    if (fs::is_block_file(s))\n        std::cout &lt;&lt; \" is a block device\\n\";\n    if (fs::is_character_file(s))\n        std::cout &lt;&lt; \" is a character device\\n\";\n    if (fs::is_fifo(s))\n        std::cout &lt;&lt; \" is a named IPC pipe\\n\";\n    if (fs::is_socket(s))\n        std::cout &lt;&lt; \" is a named IPC socket\\n\";\n    if (fs::is_symlink(s))\n        std::cout &lt;&lt; \" is a symlink\\n\";\n    if (!fs::exists(s))\n        std::cout &lt;&lt; \" does not exist\\n\";\n}\n\nint main()\n{\n    // create files of different kinds\n    fs::create_directory(\"sandbox\");\n    fs::create_directory(\"sandbox/dir\");\n    std::ofstream{\"sandbox/file\"}; // create regular file\n    fs::create_symlink(\"file\", \"sandbox/symlink\");\n\n    mkfifo(\"sandbox/pipe\", 0644);\n    sockaddr_un addr;\n    addr.sun_family = AF_UNIX;\n    std::strcpy(addr.sun_path, \"sandbox/sock\");\n    int fd = socket(PF_UNIX, SOCK_STREAM, 0);\n    bind(fd, reinterpret_cast&lt;sockaddr*&gt;(&amp;addr), sizeof addr);\n\n    // demo different status accessors\n    for (auto it{fs::directory_iterator(\"sandbox\")}; it != fs::directory_iterator(); ++it)\n        demo_status(*it, it-&gt;symlink_status()); // use cached status from directory entry\n    demo_status(\"/dev/null\", fs::status(\"/dev/null\")); // direct calls to status\n    demo_status(\"/dev/sda\", fs::status(\"/dev/sda\"));\n    demo_status(\"sandbox/no\", fs::status(\"/sandbox/no\"));\n\n    // cleanup (prefer std::unique_ptr-based custom deleters)\n    close(fd);\n    fs::remove_all(\"sandbox\");\n}\n// Possible output:\n\n// \"sandbox/file\" is a regular file\n// \"sandbox/dir\" is a directory\n// \"sandbox/pipe\" is a named IPC pipe\n// \"sandbox/sock\" is a named IPC socket\n// \"sandbox/symlink\" is a symlink\n// \"/dev/null\" is a character device\n// \"/dev/sda\" is a block device\n// \"sandbox/no\" does not exist\n</code></pre><p></p>"},{"location":"notes/C%2B%2B/4-Filesystem/#46-hard-link","title":"4.6 hard link","text":"<ul> <li> <p>\u5728POSIX\u7cfb\u7edf\u4e2d\uff0c\u6bcf\u4e2a\u76ee\u5f55\u81f3\u5c11\u6709\u4e24\u4e2a\u786c\u94fe\u63a5\uff0c\u81ea\u5df1\u4ee5\u53ca\".\"</p> </li> <li> <p>\"..\"\u6709\u4e09\u4e2a\u786c\u94fe\u63a5\uff0c\u76ee\u5f55\u672c\u8eab\uff0c\".\"\u4ee5\u53ca\"..\"</p> </li> <li> <p>\u591a\u4e2a\u6587\u4ef6\u540d\u540c\u65f6\u6307\u5411\u540c\u4e00\u4e2a\u7d22\u5f15\u8282\u70b9\uff08Inode\uff09\uff0c\u53ea\u589e\u52a0i_nlink\u786c\u94fe\u63a5\u8ba1\u6570\u3002</p> </li> </ul> <p><code>admonish info   \u53ea\u8981\u6587\u4ef6\u7684\u7d22\u5f15\u8282\u70b9\u8fd8\u5b58\u5728\u4e00\u4e2a\u4ee5\u4e0a\u7684\u94fe\u63a5\uff0c\u5220\u9664\u5176\u4e2d\u4e00\u4e2a\u94fe\u63a5\u5e76\u4e0d\u5f71\u54cd\u7d22\u5f15\u8282\u70b9\u672c\u8eab\u548c\u5176\u4ed6\u7684\u94fe\u63a5\uff08\u4e5f\u5c31\u662f\u8bf4\u8be5\u6587\u4ef6\u7684\u5b9e\u4f53\u5e76\u672a\u5220\u9664\uff09\uff0c\u800c\u53ea\u6709\u5f53\u6700\u540e\u4e00\u4e2a\u94fe\u63a5\u88ab\u5220\u9664\u540e\uff0c\u4e14\u6b64\u65f6\u6709\u65b0\u6570\u636e\u8981\u5b58\u50a8\u5230\u78c1\u76d8\u4e0a\uff0c\u90a3\u4e48\u88ab\u5220\u9664\u7684\u6587\u4ef6\u7684\u6570\u636e\u5757\u53ca\u76ee\u5f55\u7684\u94fe\u63a5\u624d\u4f1a\u88ab\u91ca\u653e\uff0c\u5b58\u50a8\u7a7a\u95f4\u624d\u4f1a\u88ab\u65b0\u6570\u636e\u6240\u8986\u76d6\u3002\u56e0\u6b64\uff0c\u8be5\u673a\u5236\u53ef\u4ee5\u6709\u6548\u7684\u9632\u6b62\u8bef\u5220\u64cd\u4f5c\u3002</code></p> <ul> <li> \u786c\u94fe\u63a5\u53ea\u80fd\u5728\u540c\u4e00\u7c7b\u578b\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u8fdb\u884c\u94fe\u63a5\uff0c\u4e0d\u80fd\u8de8\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u65f6\u5b83\u53ea\u80fd\u5bf9\u6587\u4ef6\u8fdb\u884c\u94fe\u63a5\uff0c\u4e0d\u80fd\u94fe\u63a5\u76ee\u5f55\u3002</li> </ul> C++<pre><code>#include &lt;filesystem&gt;\n#include &lt;iostream&gt;\nnamespace fs = std::filesystem;\n\nint main()\n{\n    // On a POSIX-style filesystem, each directory has at least 2 hard links:\n    // itself and the special member pathname \".\"\n    fs::path p = fs::current_path();\n    std::cout &lt;&lt; \"Number of hard links for current path is \"\n              &lt;&lt; fs::hard_link_count(p) &lt;&lt; '\\n';\n\n    // Each \"..\" is a hard link to the parent directory, so the total number\n    // of hard links for any directory is 2 plus number of direct subdirectories\n    p = fs::current_path() / \"..\"; // Each dot-dot is a hard link to parent\n    std::cout &lt;&lt; \"Number of hard links for .. is \"\n              &lt;&lt; fs::hard_link_count(p) &lt;&lt; '\\n';\n}\n// Possible output:\n\n// Number of hard links for current path is 2\n// Number of hard links for .. is 3\n</code></pre>"},{"location":"notes/C%2B%2B/5-View/","title":"5-View","text":""},{"location":"notes/C%2B%2B/5-View/#5-view","title":"5 View","text":"<p> \u7ea6 83 \u4e2a\u5b57  30 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-022025-12-10 <p>```admonish info \u901a\u5e38\u82e5\u5f15\u7528\u8303\u56f4\u7684\u5143\u7d20\u4fee\u6539,\u5219\u89c6\u56fe\u7684\u5143\u7d20\u4e5f\u4f1a\u4fee\u6539\u3002 \u82e5\u89c6\u56fe\u7684\u5143\u7d20\u4fee\u6539,\u5219\u5f15\u7528\u8303\u56f4\u7684\u5143\u7d20\u4e5f\u4f1a\u4fee\u6539\u3002 </p>Text Only<pre><code>```admonish example\n\u89c6\u56fe\u901a\u5e38\u7528\u4e8e\u5728\u7279\u5b9a\u7684\u57fa\u7840\u4e0a,\u5904\u7406\u57fa\u7840\u8303\u56f4\u7684\u5143\u7d20\u5b50\u96c6\u548c/\u6216\u7ecf\u8fc7\u4e00\u4e9b\u53ef\u9009\u8f6c\u6362\u540e\u7684\u503c\u3002\u4f8b \u5982,\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u89c6\u56fe\u6765\u8fed\u4ee3\u4e00\u4e2a\u8303\u56f4\u7684\u524d\u4e94\u4e2a\u5143\u7d20\n</code></pre><p></p> C++<pre><code>for (const auto&amp; elem : std::views::take(coll, 5)) {  ...  }\n</code></pre> <ul> <li>\u7ba1\u9053\u8bed\u6cd5\u4e2d\u8ba9\u89c6\u56fe\u5bf9\u8303\u56f4\u8fdb\u884c\u64cd\u4f5c\u3002\u901a\u8fc7\u4f7f\u7528\u64cd\u4f5c\u7b26 |,\u53ef\u4ee5\u521b\u5efa\u89c6\u56fe\u7684\u7ba1\u9053:</li> </ul> C++<pre><code>auto v = coll \n      | std::views::filter([](auto elem){return elem % 3 == 0;}) \n      | std::views::transform([](auto elem){return elem * elem;}) \n      |std::views::take(3);\n</code></pre> <ul> <li>\u901a\u8fc7\u7c7b\u6a21\u677f\u6307\u5b9a\u8303\u56f4\u7ed3\u675f\u7684\u503c</li> </ul> C++<pre><code>template&lt;auto End&gt;\nstruct EndValue {\n  bool operator== (auto pos) const {\n      return *pos == End;  // end is where iterator points to End\n  }\n};\n\nint main() {\n  std::vector coll = {42, 8, 0, 15, 7, -1};\n  std::ranges::subrange range{coll.begin(), EndValue&lt;7&gt;{}};\n  std::ranges::sort(range);\n  std::ranges::for_each(coll.begin(), EndValue&lt;-1&gt;{}, \n                        [](auto value){std::cout &lt;&lt; ' ' &lt;&lt; value;})\n}\n</code></pre> <ul> <li>\u652f\u6301\u6295\u5f71\u529f\u80fd\uff0c\u907f\u514d\u5199\u663e\u793a\u7684\u6bd4\u8f83\u5668\uff0c\u76f4\u63a5\u901a\u8fc7\u6295\u5f71\u7684\u65b9\u5f0f\u6307\u5b9a\u4f7f\u7528Person\u7684age\u8fdb\u884c\u6392\u5e8f</li> </ul> C++<pre><code>struct Person {\n  std::string name;\n  int age;\n};\nstd::vector&lt;Person&gt; people = {{\"Alice\", 25}, {\"Bob\", 30}, {\"Charlie\", 20}};\nstd::sort(people.begin(), people.end(), \n          [](const Person&amp; a, const Person&amp; b) { return a.age &lt; b.age; });\nstd::ranges::sort(people, std::less&lt;int&gt;{}, &amp;Person::age);\n</code></pre>"},{"location":"notes/C%2B%2B/6-Span/","title":"6-Span","text":""},{"location":"notes/C%2B%2B/6-Span/#6-span","title":"6 Span","text":"<p> \u7ea6 4 \u4e2a\u5b57  4 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p> 2025-12-022025-12-10 <p>```admonish danger  \u8fd9\u6bb5\u4ee3\u7801\u4f1a\u5bfc\u81f4\u672a\u5b9a\u4e49\u7684\u884c\u4e3a,\u56e0\u4e3a\u57fa\u4e8e\u8303\u56f4\u7684 for \u5faa\u73af\u4e2d\u5b58\u5728\u4e00\u4e2a bug,\u5728\u5bf9\u4e34\u65f6\u5bf9\u8c61\u7684\u5f15\u7528\u4e0a\u8fdb\u884c\u8fed\u4ee3\u65f6\u4f1a\u4f7f\u7528\u5df2\u7ecf\u9500\u6bc1\u7684\u503c </p>Text Only<pre><code>```c++\n// for the last 3 returned elements:\nfor (auto s : std::span{arrayOfConst()}.last(3)) \n// fatal runtime ERROR  \n</code></pre><p></p>"},{"location":"notes/C%2B%2BConcurrency/1-thread/","title":"std::thread & std::jthread","text":"2025-06-102025-12-10 <code>#C++</code>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/1-thread/#stdthread","title":"std::thread","text":"<p> \u7ea6 797 \u4e2a\u5b57  176 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/1-thread/#thread","title":"thread \u4f20\u9012\u53c2\u6570","text":"<ul> <li>\u6709\u53c2\u6570\u7684\u51fd\u6570\u4e5f\u80fd\u4f20\u7ed9 std::thread\uff0c\u53c2\u6570\u7684\u9ed8\u8ba4\u5b9e\u53c2\u4f1a\u88ab\u5ffd\u7565</li> </ul> C++<pre><code>#include &lt;thread&gt;\n\nvoid f(int i = 1) {}\n\nint main() {\n  std::thread t{f, 42};  // std::thread t{f} \u5219\u4f1a\u51fa\u9519\uff0c\u56e0\u4e3a\u9ed8\u8ba4\u5b9e\u53c2\u4f1a\u88ab\u5ffd\u7565\n  t.join();\n}\n</code></pre> <ul> <li>\u5982\u679c thread \u6267\u884c\u7684\u51fd\u6570\u53c2\u6570\u662f\u4e00\u4e2a\u5f15\u7528\u7684\u8bdd\uff0c\u9700\u8981<code>std::ref</code></li> </ul> C++<pre><code> void update_data_for_widget(widget_id w,widget_data&amp; data); // 1\n void oops_again(widget_id w)  {\n  widget_data data;  std::thread t(update_data_for_widget,w,std::ref(data)); // 2\n  display_status();\n  t.join();\n  process_widget_data(data);\n }\n</code></pre> <ul> <li> <p>\u8fd9\u4f9d\u8d56\u4e8e std::thread \u5b9e\u4f8b\u7684\u53ef\u79fb\u52a8\u4e14\u4e0d\u53ef\u590d\u5236\u6027\u3002\u4e0d\u53ef\u590d\u5236\u6027\u8868\u793a\u5728\u67d0\u4e00\u65f6\u95f4\u70b9,\u4e00\u4e2a std::thread \u5b9e\u4f8b\u53ea\u80fd\u5173\u8054\u4e00\u4e2a\u6267\u884c\u7ebf\u7a0b\u3002\u53ef\u79fb\u52a8\u6027\u4f7f\u5f97\u5f00\u53d1\u8005\u53ef\u4ee5\u81ea\u5df1\u51b3\u5b9a,\u54ea\u4e2a\u5b9e\u4f8b\u62e5\u6709\u7ebf\u7a0b\u5b9e\u9645\u6267\u884c\u7684\u6240\u6709\u6743</p> </li> <li> <p><code>std::thread::hardware_concurrency()</code> \u4f1a\u8fd4\u56de\u5e76\u53d1\u7ebf\u7a0b\u7684\u6570\u91cf\u3002\u4f8b\u5982,\u591a\u6838\u7cfb\u7edf\u4e2d, \u8fd4\u56de\u503c\u53ef\u4ee5\u662f CPU \u6838\u82af\u7684\u6570\u91cf\u3002\u8fd4\u56de\u503c\u4e5f\u4ec5\u4ec5\u662f\u4e00\u4e2a\u6807\u8bc6,\u5f53\u65e0\u6cd5\u83b7\u53d6\u65f6,\u51fd\u6570\u8fd4\u56de 0\u3002</p> </li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/1-thread/#accumlate","title":"\u5e76\u53d1 accumlate \u7684\u4f8b\u5b50","text":"C++<pre><code>// parallel accumulate\ntemplate&lt;typename Iterator,typename T&gt;\nstruct accumulate_block  {\n  void operator()(Iterator first,Iterator last,T&amp; result)  {  result=std::accumulate(first,last,result);\n  }\n};\ntemplate&lt;typename Iterator,typename T&gt;\nT parallel_accumulate(Iterator first,Iterator last,T init)\n{\n  unsigned long const length=std::distance(first,last);\n  if(!length) // 1\n      return init;\n  unsigned long const min_per_thread=25;\n  unsigned long const max_threads=  (length+min_per_thread-1)/min_per_thread; // 2\n  unsigned long const hardware_threads=  std::thread::hardware_concurrency();  unsigned long const num_threads= // 3\n  std::min(hardware_threads != 0 ? hardware_threads : 2, max_threads);  unsigned long const block_size=length/num_threads; // 4\n  std::vector&lt;T&gt; results(num_threads);\n  std::vector&lt;std::thread&gt; threads(num_threads-1); // 5\n  Iterator block_start=first;\n  for(unsigned long i=0; i &lt; (num_threads-1); ++i)\n  {\n      Iterator block_end=block_start;\n      std::advance(block_end,block_size); // 6\n      threads[i]=std::thread( // 7\n          accumulate_block&lt;Iterator,T&gt;(),\n          block_start,block_end,std::ref(results[i]));\n      block_start=block_end; // 8\n  }\n  accumulate_block&lt;Iterator,T&gt;()(  block_start,last,results[num_threads-1]); // 9\n  for (auto&amp; entry : threads)  entry.join(); // 10\n  return std::accumulate(results.begin(),results.end(),init); // 11\n}\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/1-thread/#jthread","title":"jthread","text":"<ul> <li>C++11 \u5f15\u5165\u4e86 std::thread \u7c7b\u578b,\u5176\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u7ebf\u7a0b\u5bf9\u5e94,\u4f46\u8be5\u7c7b\u578b\u6709\u4e00\u4e2a\u4e25\u91cd\u7684\u8bbe\u8ba1\u7f3a\u9677: \u4e0d\u662f RAII \u7c7b\u578b\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/1-thread/#thread_1","title":"thread \u5b58\u5728\u7684\u95ee\u9898","text":"<p>std::thread \u8981\u6c42\u5728\u5176\u751f\u547d\u5468\u671f\u7ed3\u675f\u65f6,\u82e5\u8868\u793a\u6b63\u5728\u8fd0\u884c\u7684\u7ebf\u7a0b,\u5219\u8c03\u7528 join()(\u7b49\u5f85\u7ebf\u7a0b\u7ed3\u675f) \u6216 detach()(\u8ba9\u7ebf\u7a0b\u5728\u540e\u53f0\u8fd0\u884c)\u3002\u82e5\u4e24\u8005\u90fd\u6ca1\u6709\u8c03\u7528,\u6790\u6784\u51fd\u6570\u4f1a\u7acb\u5373\u5bfc\u81f4\u5f02\u5e38\u7684\u7a0b\u5e8f\u7ec8\u6b62(std::terminate)\u3002</p> <p>\u5982\u679c\u901a\u8fc7\u786e\u4fdd\u5728\u79bb\u5f00\u4f5c\u7528\u57df\u65f6\u8c03\u7528 join() \u6765\u5bf9\u5f02\u5e38\u4f5c\u51fa\u53cd\u5e94,\u800c\u4e0d\u89e3\u51b3\u5f02\u5e38\u3002\u4e0d\u5e78\u7684\u662f,\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u963b\u585e (\u6c38\u8fdc)\u3002\u7136\u800c,\u8c03\u7528 detach() \u4e5f\u662f\u4e00\u4e2a\u95ee\u9898,\u56e0\u4e3a\u7ebf\u7a0b\u5728\u7a0b\u5e8f\u7684\u540e\u53f0\u7ee7\u7eed\u8fd0\u884c,\u4f7f\u7528 CPU \u65f6\u95f4\u548c\u8d44\u6e90,\u800c\u8fd9\u4e9b\u65f6\u95f4\u548c\u8d44\u6e90\u73b0\u5728\u53ef\u80fd\u4f1a\u9500\u6bc1\u3002\u82e5\u5728\u66f4\u590d\u6742\u7684\u4e0a\u4e0b\u6587\u4e2d\u4f7f\u7528\u591a\u4e2a\u7ebf\u7a0b,\u95ee\u9898\u4f1a\u53d8\u5f97\u66f4\u7cdf,\u5e76\u4e14\u4f1a\u4ea7\u751f\u975e\u5e38\u7cdf\u7cd5\u7684\u4ee3\u7801\u3002</p> C++<pre><code>void foo(){\n  std::thread t1{task1, name, val};\n  std::thread t2;\n  try {\n    t2 = std::thread{task2, name, val};\n    ...\n  }\n  catch(...){\n    t1.join();\n    if(t2.joinable()) {\n      t2.join();\n    }\n    throw;\n  }\n\n  t1.join();\n  t2.join();\n}\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/1-thread/#stdjthread","title":"std::jthread","text":"<ul> <li>std::jthread \u89e3\u51b3\u4e86\u8fd9\u4e9b\u95ee\u9898,\u5b83\u662f RAII \u7c7b\u578b\u3002\u82e5\u7ebf\u7a0b\u662f\u53ef\u6c47\u5165\u7684 (\u201cj\u201d\u4ee3\u8868\u201c\u6c47\u5165\u201d),\u6790\u6784\u51fd\u6570\u4f1a\u81ea\u52a8\u8c03\u7528 join()\u3002</li> <li>\u5185\u7f6e\u505c\u6b62\u673a\u5236\uff1astd::jthread \u4e0e std::stop_token \u96c6\u6210\uff0c\u652f\u6301\u76f4\u63a5\u8bf7\u6c42\u505c\u6b62\u7ebf\u7a0b</li> </ul> C++<pre><code>void foo(){\n  std::jthread t1{task1, name, val};\n  std::jthread t2{task2, name, val};\n  ...\n\n  t1.join();\n  t2.join();\n}\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/1-thread/#jthread_1","title":"jthread \u7684\u505c\u6b62\u4ee4\u724c\u548c\u505c\u6b62\u56de\u8c03","text":"<ul> <li>\u81ea\u52a8\u7ba1\u7406\u505c\u6b62\u4ee4\u724c\uff1a\u5f53\u4f7f\u7528 std::jthread \u65f6\uff0c\u4e0d\u9700\u8981\u624b\u52a8\u521b\u5efa std::stop_source\u3002std::jthread \u81ea\u52a8\u5305\u542b\u4e00\u4e2a\u5185\u90e8\u7684 std::stop_source\uff0c\u5e76\u5728\u542f\u52a8\u7ebf\u7a0b\u65f6\u5c06\u76f8\u5173\u7684 std::stop_token \u4f20\u9012\u7ed9\u7ebf\u7a0b\u51fd\u6570\u3002</li> <li>\u63a5\u6536\u505c\u6b62\u4ee4\u724c\uff1a\u7ebf\u7a0b\u51fd\u6570\u53ef\u4ee5\u76f4\u63a5\u63a5\u53d7\u4e00\u4e2a std::stop_token \u53c2\u6570\uff0c\u8be5\u4ee4\u724c\u7531 std::jthread \u63d0\u4f9b\uff0c\u786e\u4fdd\u4e0e\u7ebf\u7a0b\u7684\u5185\u90e8\u505c\u6b62\u673a\u5236\u540c\u6b65\u3002</li> <li>\u5b9a\u671f\u68c0\u67e5\u505c\u6b62\u8bf7\u6c42\uff1a\u5728\u7ebf\u7a0b\u51fd\u6570\u4e2d\uff0c\u5e94\u5b9a\u671f\u8c03\u7528 std::stop_token::stop_requested() \u6765\u68c0\u67e5\u662f\u5426\u63a5\u6536\u5230\u505c\u6b62\u8bf7\u6c42\u3002\u8fd9\u4e3a\u5b89\u5168\u4e14\u53ca\u65f6\u5730\u505c\u6b62\u6267\u884c\u63d0\u4f9b\u4e86\u673a\u5236\u3002</li> <li>\u54cd\u5e94\u505c\u6b62\u8bf7\u6c42\uff1a\u4e00\u65e6 std::stop_token \u8868\u660e\u505c\u6b62\u5df2\u88ab\u8bf7\u6c42\uff0c\u7ebf\u7a0b\u51fd\u6570\u5e94\u91c7\u53d6\u5fc5\u8981\u7684\u6b65\u9aa4\u6765\u5b89\u5168\u5730\u7ec8\u6b62\uff0c\u8fd9\u53ef\u80fd\u5305\u62ec\u8d44\u6e90\u7684\u6e05\u7406\u548c\u72b6\u6001\u7684\u4fdd\u5b58\u3002</li> </ul> C++<pre><code>#include &lt;iostream&gt;\n#include &lt;chrono&gt;\n#include &lt;thread&gt;\n\n// \u4f7f\u7528 std::jthread \u8fd0\u884c\u7684\u51fd\u6570\nvoid task(std::stop_token stoken) {\n    while (!stoken.stop_requested()) {\n        std::cout &lt;&lt; \"\u4efb\u52a1\u6b63\u5728\u8fd0\u884c...\" &lt;&lt; std::endl;\n        // \u6a21\u62df\u4e00\u4e9b\u5de5\u4f5c\n        std::this_thread::sleep_for(std::chrono::seconds(1));\n    }\n    std::cout &lt;&lt; \"\u4efb\u52a1\u5df2\u6536\u5230\u505c\u6b62\u8bf7\u6c42\uff0c\u73b0\u5728\u505c\u6b62\u8fd0\u884c\u3002\" &lt;&lt; std::endl;\n}\n\nint main() {\n    // \u521b\u5efa std::jthread\uff0c\u81ea\u52a8\u5904\u7406\u505c\u6b62\u4ee4\u724c\n    std::jthread worker(task);\n\n    // \u6a21\u62df\u4e3b\u7ebf\u7a0b\u8fd0\u884c\u4e00\u6bb5\u65f6\u95f4\u540e\u9700\u8981\u505c\u6b62\u5b50\u7ebf\u7a0b\n    std::this_thread::sleep_for(std::chrono::seconds(5));\n    std::cout &lt;&lt; \"\u4e3b\u7ebf\u7a0b\u8bf7\u6c42\u505c\u6b62\u5b50\u7ebf\u7a0b...\" &lt;&lt; std::endl;\n\n    // \u89e6\u53d1\u505c\u6b62\u8bf7\u6c42\n    worker.request_stop();\n\n    // std::jthread \u5728\u6790\u6784\u65f6\u81ea\u52a8\u52a0\u5165\n    return 0;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/1-thread/#stdstop_token-stdstop_callback","title":"std::stop_token \u548c std::stop_callback \u7684\u5176\u4ed6\u4f7f\u7528\u6848\u4f8b;","text":"<p>\u53e6\u5916, std::stop_token \u548c std::stop_callback \u5e76\u4e0d\u5c40\u9650\u4e8e\u4e0e\u7ebf\u7a0b\uff08\u5982 std::jthread\uff09\u7684\u4f7f\u7528,\u5b83\u4eec\u72ec\u7acb\u4e8e\u7ebf\u7a0b\u7684\uff0c\u7528\u4e8e\u7a0b\u5e8f\u4e2d\u7684\u4efb\u4f55\u5730\u65b9\uff0c\u4ee5\u63d0\u4f9b\u4e00\u79cd\u7075\u6d3b\u7684\u505c\u6b62\u4fe1\u53f7\u5904\u7406\u673a\u5236\u3002</p> C++<pre><code>#include &lt;iostream&gt;\n#include &lt;chrono&gt;\n#include &lt;stop_token&gt;\n\nint main() {\n    std::stop_source source;\n    std::stop_token token = source.get_token();\n\n    // \u6a21\u62df\u4e00\u4e9b\u53ef\u4ee5\u88ab\u53d6\u6d88\u7684\u5de5\u4f5c\n    auto startTime = std::chrono::steady_clock::now();\n    auto endTime = startTime + std::chrono::seconds(10);  // \u8bbe\u5b9a10\u79d2\u540e\u7ed3\u675f\u4efb\u52a1\n\n    while (std::chrono::steady_clock::now() &lt; endTime) {\n        if (token.stop_requested()) {\n            std::cout &lt;&lt; \"Task was canceled!\" &lt;&lt; std::endl;\n            break;\n        }\n        std::cout &lt;&lt; \"Working...\" &lt;&lt; std::endl;\n        std::this_thread::sleep_for(std::chrono::seconds(1));\n\n        // \u6a21\u62df\u5728\u67d0\u4e2a\u6761\u4ef6\u4e0b\u8bf7\u6c42\u505c\u6b62\n        if (std::chrono::steady_clock::now() &gt; startTime + std::chrono::seconds(5)) {\n            source.request_stop();\n        }\n    }\n\n    if (!token.stop_requested()) {\n        std::cout &lt;&lt; \"Task completed normally.\" &lt;&lt; std::endl;\n    }\n\n    return 0;\n}\n\n// result\nWorking...\nWorking...\nWorking...\nWorking...\nWorking...\nTask was canceled!\n</code></pre> <ul> <li>stop_token \u4e0e std::thread \u7ed3\u5408</li> </ul> C++<pre><code>#include &lt;iostream&gt;\n#include &lt;thread&gt;\n#include &lt;stop_token&gt;\n#include &lt;chrono&gt;\n\nvoid threadFunction(std::stop_token stoken) {\n    std::stop_callback callback(stoken, []() {\n        std::cout &lt;&lt; \"Stop request received.\\n\";\n    });\n   // 4. \u5b9a\u671f\u68c0\u67e5\u505c\u6b62\u8bf7\u6c42\n    while (!stoken.stop_requested()) {\n        std::cout &lt;&lt; \"Running...\\n\";\n        std::this_thread::sleep_for(std::chrono::seconds(1));\n    }\n   // 5. \u54cd\u5e94\u53d6\u6d88\u8bf7\u6c42\n    std::cout &lt;&lt; \"Thread finishing.\\n\";\n}\n\nint main() {\n     // 1. \u521b\u5efa\u5e76\u53d1\u8d77\u53d6\u6d88\u8bf7\u6c42\u7684\u6e90\n    std::stop_source stopSource;\n     // 2. \u751f\u6210\u505c\u6b62\u4ee4\u724c\n    std::stop_token stoken = stopSource.get_token();\n    // 3. \u4f20\u9012\u505c\u6b62\u4ee4\u724c\n    std::thread t(threadFunction, stoken);\n\n    std::this_thread::sleep_for(std::chrono::seconds(5));\n     // \u89e6\u53d1\u505c\u6b62\u8bf7\u6c42\n    stopSource.request_stop();\n\n    t.join();\n    std::cout &lt;&lt; \"Thread stopped.\\n\";\n    return 0;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/","title":"C++ \u5185\u5b58\u5e8f","text":"2025-06-102025-12-10 <code>#C++</code>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#_1","title":"\u5185\u5b58\u6a21\u578b","text":"<p> \u7ea6 2018 \u4e2a\u5b57  150 \u884c\u4ee3\u7801  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 12 \u5206\u949f</p> <ul> <li><code>volatile</code>\u8bbf\u95ee\u4e0d\u4f1a\u5efa\u7acb\u7ebf\u7a0b\u95f4\u7684\u540c\u6b65\u3002</li> <li>\u6b64\u5916\uff0c<code>volatile</code>\u8bbf\u95ee\u4e0d\u662f\u539f\u5b50\u7684\uff08\u5e76\u53d1\u8bfb\u5199\u662f\u4e00\u4e2a\u6570\u636e\u7ade\u4e89\u95ee\u9898\uff09\uff0c\u5e76\u4e14\u4e0d\u4f1a\u5bf9\u5185\u5b58\u8fdb\u884c\u6392\u5e8f\uff08\u975e<code>volatile</code>\u7684\u5185\u5b58\u8bbf\u95ee\u53ef\u4ee5\u81ea\u7531\u5730\u5728<code>volatile</code>\u8bbf\u95ee\u5468\u56f4\u91cd\u65b0\u6392\u5e8f\uff09\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#_2","title":"\u534f\u8bae\u7ea7\u522b","text":"<ul> <li>\u539f\u5b50\u64cd\u4f5c\u7684\u987a\u5e8f\u4e00\u81f4\u8bed\u4e49\u88ab\u79f0\u4e3a\u5f3a\u5185\u5b58\u6a21\u578b\uff0c\u539f\u5b50\u64cd\u4f5c\u7684\u81ea\u7531\u8bed\u4e49\u88ab\u79f0\u4e3a\u5f31\u5185\u5b58\u6a21\u578b\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#c","title":"C++ \u7684\u5185\u5b58\u5e8f","text":"<p>\u539f\u5b50\u64cd\u4f5c\u9ed8\u8ba4\u7684\u5185\u5b58\u5e8f\u662f std::memory_order_seq_cst\uff0c\u987a\u5e8f\u4e00\u81f4\u6027</p> C++<pre><code>enum memory_order{\n  memory_order_relaxed,\n  memory_order_consume,\n  memory_order_acquire,\n  memory_order_release,\n  memory_order_acq_rel,\n  memory_order_seq_cst\n}\n</code></pre> <ul> <li> <p>\u987a\u5e8f\u4e00\u81f4: <code>memory_order_seq_cst</code></p> </li> <li> <p>\u83b7\u53d6-\u91ca\u653e(Acquire-release)\uff1a<code>memory_order_consume</code> , <code>memory_order_acquire</code> ,<code>memory_order_release</code>\u548c<code>memory_order_acq_rel</code></p> </li> <li> <p>\u81ea\u7531\u5e8f(Relaxed): <code>memory_order_relaxed</code></p> </li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#sequentially-consistent-ordering","title":"Sequentially-consistent ordering","text":"<p>\u987a\u5e8f\u4e00\u81f4\u4e2d\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u770b\u5230\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u7684\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u53ef\u4ee5\u770b\u5230\u6240\u6709\u5176\u4ed6\u7ebf\u7a0b\u7684\u64cd\u4f5c\u3002\u5982\u679c\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c\u7684\u83b7\u53d6-\u91ca\u653e\u8bed\u4e49\uff0c\u90a3\u4e48\u987a\u5e8f\u4e00\u81f4\u5c31\u4e0d\u6210\u7acb\u4e86\u3002</p> <ul> <li>\u6807\u8bb0\u4e3a memory_order_seq_cst \u7684\u539f\u5b50\u64cd\u4f5c\u4e0d\u4ec5\u50cf\u91ca\u653e/\u83b7\u53d6\u987a\u5e8f\u90a3\u6837\u5bf9\u5185\u5b58\u8fdb\u884c\u6392\u5e8f\uff08\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u5728\u5b58\u50a8\u64cd\u4f5c\u4e4b\u524d\u53d1\u751f\u7684\u6240\u6709\u4e8b\u60c5\u90fd\u6210\u4e3a\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u52a0\u8f7d\u64cd\u4f5c\u7684\u53ef\u89c1\u526f\u4f5c\u7528\uff09\uff0c\u800c\u4e14\u5efa\u7acb\u4e86\u4e00\u4e2a\u6240\u6709\u8fd9\u6837\u6807\u8bb0\u7684\u539f\u5b50\u64cd\u4f5c\u7684\u5355\u4e00\u603b\u4fee\u6539\u987a\u5e8f\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#release-acquire-ordering","title":"Release-Acquire ordering","text":"<ul> <li> <p>\u5982\u679c\u7ebf\u7a0b A \u4e2d\u7684\u539f\u5b50\u5b58\u50a8\u64cd\u4f5c\u6807\u8bb0\u4e3a<code>memory_order_release</code>\uff0c\u800c\u7ebf\u7a0b B \u4e2d\u5bf9\u540c\u4e00\u53d8\u91cf\u7684\u539f\u5b50\u52a0\u8f7d\u64cd\u4f5c\u6807\u8bb0\u4e3a<code>memory_order_acquire</code>\uff0c\u5e76\u4e14\u7ebf\u7a0b B \u4e2d\u7684\u52a0\u8f7d\u64cd\u4f5c\u8bfb\u53d6\u4e86\u7ebf\u7a0b A \u4e2d\u5b58\u50a8\u64cd\u4f5c\u5199\u5165\u7684\u503c\uff0c\u90a3\u4e48\u7ebf\u7a0b A \u4e2d\u7684\u5b58\u50a8\u64cd\u4f5c\u4e0e\u7ebf\u7a0b B \u4e2d\u7684\u52a0\u8f7d\u64cd\u4f5c\u4e4b\u95f4\u5c31\u5efa\u7acb\u4e86\u540c\u6b65\u5173\u7cfb\uff08synchronizes-with\uff09\u3002   \u6240\u6709\u5728\u539f\u5b50\u5b58\u50a8\u64cd\u4f5c\u4e4b\u524d\u53d1\u751f\uff08\u4ece\u7ebf\u7a0b A \u7684\u89d2\u5ea6\u770b\uff09\u7684\u5185\u5b58\u5199\u5165\u64cd\u4f5c\uff08\u5305\u62ec\u975e\u539f\u5b50\u64cd\u4f5c\u548c\u6807\u8bb0\u4e3a<code>memory_order_relaxed</code>\u7684\u539f\u5b50\u64cd\u4f5c\uff09\u90fd\u5c06\u6210\u4e3a\u7ebf\u7a0b B \u4e2d\u53ef\u89c1\u7684\u526f\u4f5c\u7528\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u4e00\u65e6\u539f\u5b50\u52a0\u8f7d\u64cd\u4f5c\u5b8c\u6210\uff0c\u7ebf\u7a0b B \u5c06\u80fd\u591f\u770b\u5230\u7ebf\u7a0b A \u5199\u5165\u7684\u6240\u6709\u5185\u5bb9\u3002\u8fd9\u79cd\u4fdd\u8bc1\u4ec5\u5728 B \u5b9e\u9645\u8fd4\u56de\u7ebf\u7a0b A \u5b58\u50a8\u7684\u503c\uff0c\u6216\u8005\u8fd4\u56de\u91ca\u653e\u5e8f\u5217\u4e2d\u66f4\u665a\u7684\u503c\u65f6\u624d\u6210\u7acb\u3002</p> </li> <li> <p>\u8fd9\u79cd\u540c\u6b65\u4ec5\u5728\u91ca\u653e\u548c\u83b7\u53d6\u540c\u4e00\u539f\u5b50\u53d8\u91cf\u7684\u7ebf\u7a0b\u4e4b\u95f4\u5efa\u7acb\u3002\u5176\u4ed6\u7ebf\u7a0b\u53ef\u80fd\u4f1a\u770b\u5230\u4e0e\u540c\u6b65\u7ebf\u7a0b\u4e4b\u4e00\u6216\u4e24\u8005\u90fd\u4e0d\u540c\u7684\u5185\u5b58\u8bbf\u95ee\u987a\u5e8f\u3002\u3002</p> </li> </ul> <p>\u4e92\u65a5\u9501\uff08\u5982 std::mutex \u6216\u539f\u5b50\u81ea\u65cb\u9501\uff09\u662f\u91ca\u653e-\u83b7\u53d6\u540c\u6b65\u7684\u4e00\u4e2a\u4f8b\u5b50\uff1a\u5f53\u7ebf\u7a0b A \u91ca\u653e\u9501\uff0c\u7ebf\u7a0b B \u83b7\u53d6\u9501\u65f6\uff0c\u7ebf\u7a0b A \u5728\u91ca\u653e\u9501\u4e4b\u524d\u5728\u4e34\u754c\u533a\u4e2d\u53d1\u751f\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u5fc5\u987b\u5bf9\u7ebf\u7a0b B \u53ef\u89c1\uff08\u7ebf\u7a0b B \u5728\u83b7\u53d6\u9501\u4e4b\u540e\u6267\u884c\u76f8\u540c\u7684\u4e34\u754c\u533a\uff09\u3002 \u540c\u6837\u7684\u539f\u7406\u4e5f\u9002\u7528\u4e8e\u7ebf\u7a0b\u7684\u542f\u52a8\u548c\u6c47\u5165\u3002\u8fd9\u4e24\u79cd\u64cd\u4f5c\u90fd\u662f\u83b7\u53d6-\u91ca\u653e\u64cd\u4f5c\u3002\u63a5\u4e0b\u6765\u662f wait \u548c notify_one \u5bf9\u6761\u4ef6\u53d8\u91cf\u7684\u8c03\u7528\uff1bwait \u662f\u83b7\u53d6\u64cd\u4f5c\uff0cnotify_one \u662f\u91ca\u653e\u64cd\u4f5c\u3002\u90a3 notify_all \u5462\uff1f\u5f53\u7136\uff0c\u4e5f\u662f\u4e00\u4e2a\u91ca\u653e\u64cd\u4f5c\u3002</p> <ul> <li>\u5728\u4e00\u4e2a\u91ca\u653e\u5e8f\u5217\u4e2d\uff0c\u5373\u4f7f RMW \u64cd\u4f5c\u4f7f\u7528\u4e86 memory_order_relaxed\uff0c\u5b83\u4e5f\u4e0d\u4f1a\u7834\u574f\u91ca\u653e\u5e8f\u5217\u7684\u540c\u6b65\u6548\u679c\u3002</li> </ul> <p>RMW (Read-Modify-Write) \u662f\u4e00\u4e2a\u5305\u542b\u201c\u8bfb\u53d6-\u4fee\u6539-\u5199\u5165\u201d\u4e09\u6b65\u9aa4\u7684\u590d\u5408\u64cd\u4f5c\u3002</p> C++<pre><code>#include &lt;atomic&gt;\n#include &lt;cassert&gt;\n#include &lt;thread&gt;\n#include &lt;vector&gt;\n\nstd::vector&lt;int&gt; data;\nstd::atomic&lt;int&gt; flag = {0};\n\nvoid thread_1()\n{\n    data.push_back(42);\n    flag.store(1, std::memory_order_release);\n}\n\nvoid thread_2()\n{\n    int expected = 1;\n    // memory_order_relaxed is okay because this is an RMW,\n    // and RMWs (with any ordering) following a release form a release sequence\n    while (!flag.compare_exchange_strong(expected, 2, std::memory_order_relaxed))\n    {\n        expected = 1;\n    }\n}\n\nvoid thread_3()\n{\n    while (flag.load(std::memory_order_acquire) &lt; 2)\n        ;\n    // if we read the value 2 from the atomic flag, we see 42 in the vector\n    assert(data.at(0) == 42); // will never fire\n}\n\nint main()\n{\n    std::thread a(thread_1);\n    std::thread b(thread_2);\n    std::thread c(thread_3);\n    a.join(); b.join(); c.join();\n}\n</code></pre> <ul> <li>\u9519\u8bef\u6848\u4f8b\uff1a\u5fc5\u987b\u4f7f\u7528\u539f\u5b50\u7684 compare_and_exchange \u6765\u8fdb\u884c flag \u66f4\u6539\u3002 <p>dataProduced.store(true, std::memory_order_release) \u4e0e dataProduced.load(std::memory_order_acquire)\u540c\u6b65\u3002\u4e0d\u8fc7\uff0c\u5e76\u4e0d\u610f\u5473\u7740\u83b7\u53d6\u64cd\u4f5c\u8981\u5bf9\u91ca\u653e\u64cd\u4f5c\u8fdb\u884c\u7b49\u5f85\uff0c\u800c\u8fd9\u6b63\u662f\u4e0b\u56fe\u4e2d\u7684\u5185\u5bb9\u3002\u56fe\u4e2d\uff0cdataProduced.load(std::memory_order_acquire) \u5728\u6307\u4ee4 dataProduced.store(true, std::memory_order_release)\u4e4b\u524d\uff0c\u6240\u4ee5\u8fd9\u91cc\u6ca1\u6709\u540c\u6b65\u5173\u7cfb\u3002</p> </li> </ul> <p></p> C++<pre><code>// acquireReleaseWithoutWaiting.cpp\n\n#include &lt;atomic&gt;\n#include &lt;iostream&gt;\n#include &lt;thread&gt;\n#include &lt;vector&gt;\n\nstd::vector&lt;int&gt; mySharedWork;\nstd::atomic&lt;bool&gt; dataProduced(false);\n\nvoid dataProducer(){\n  mySharedWork = {1,0,3};\n  dataProduced.store(true, std::memory_order_release);\n}\n\nvoid dataConsumer(){\n     dataProduced.load(std::memory_order_acquire);\n  myShraedWork[1] = 2;\n}\n\nint main(){\n\n  std::cout &lt;&lt; std::endl;\n\n  std::thread t1(dataConsumer);\n  std::thread t2(dataProducer);\n\n  t1.join();\n  t2.join();\n\n  for (auto v : mySharedWork){\n    std::cout &lt;&lt; v &lt;&lt; \" \";\n  }\n\n  std::cout &lt;&lt; \"\\n\\n\";\n\n}\n</code></pre> <ul> <li>\u5f53 dataProduced.store(true, std::memory_order_release) \u5148\u884c\u4e8e dataProduced.load(std::memory_order_acquire)\uff0c\u90a3\u4e48 dataProduced.store(true, std::memory_order_release) \u4e4b\u524d\u548c dataProduced.load(std::memory_order_acquire) \u4e4b\u540e\u6267\u884c\u7684\u64cd\u4f5c\u662f\u6240\u6709\u7ebf\u7a0b\u53ef\u89c1\u7684\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#relax-ordering","title":"Relax Ordering","text":"<p>Typical use for relaxed memory ordering is incrementing counters, such as the reference counters of std::shared_ptr, since this only requires atomicity, but not ordering or synchronization (note that decrementing the std::shared_ptr counters requires acquire-release synchronization with the destructor).</p> C++<pre><code>#include &lt;atomic&gt;\n#include &lt;iostream&gt;\n#include &lt;thread&gt;\n#include &lt;vector&gt;\n\nstd::atomic&lt;int&gt; cnt = {0};\n\nvoid f()\n{\n    for (int n = 0; n &lt; 1000; ++n)\n        cnt.fetch_add(1, std::memory_order_relaxed);\n}\n\nint main()\n{\n    std::vector&lt;std::thread&gt; v;\n    for (int n = 0; n &lt; 10; ++n)\n        v.emplace_back(f);\n    for (auto&amp; t : v)\n        t.join();\n    std::cout &lt;&lt; \"Final counter value is \" &lt;&lt; cnt &lt;&lt; '\\n';\n}\n// always 10000\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#atomic","title":"Atomic","text":"<p>\u5b9e\u73b0\u539f\u5b50\u64cd\u4f5c\u6709\u4e24\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff1a</p> <ol> <li>lock-free: \u8fd9\u662f std::atomic \u7684\u7406\u60f3\u5b9e\u73b0\u65b9\u5f0f\u3002\u5b83\u4e0d\u4f9d\u8d56\u4e8e\u4e92\u65a5\u9501\uff08mutex\uff09\u6216\u5176\u4ed6\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u7684\u540c\u6b65\u539f\u8bed\u3002\u76f8\u53cd\uff0c\u5b83\u76f4\u63a5\u5229\u7528 CPU \u63d0\u4f9b\u7684\u539f\u5b50\u6307\u4ee4\u3002</li> <li>lock-based: std::atomic \u5bf9\u8c61\u5185\u90e8\u4f1a\u5305\u542b\u4e00\u4e2a\u9690\u85cf\u7684\u4e92\u65a5\u9501\uff08mutex\uff09\u3002\u5bf9\u8fd9\u4e2a std::atomic \u7684\u6bcf\u4e00\u6b21\u64cd\u4f5c\uff0c\u5b9e\u9645\u4e0a\u90fd\u4f1a\u7ecf\u5386\u4ee5\u4e0b\u6b65\u9aa4\uff1a</li> </ol> <ul> <li>\u52a0\u9501: \u5bf9\u5185\u90e8\u7684\u4e92\u65a5\u9501\u8fdb\u884c\u52a0\u9501\u3002</li> <li>\u6267\u884c\u64cd\u4f5c: \u5728\u9501\u7684\u4fdd\u62a4\u4e0b\uff0c\u6267\u884c\u666e\u901a\u7684\u6570\u636e\u64cd\u4f5c\uff08\u5982\u8bfb\u53d6\u3001\u4fee\u6539\u3001\u5199\u5165\uff09\u3002</li> <li>\u89e3\u9501: \u91ca\u653e\u4e92\u65a5\u9501\u3002</li> </ul> <p>\u5b9e\u9645\u4e0a mutex \u7684\u5b9e\u73b0\u5185\u90e8\u4e5f\u662f\u4f7f\u7528 CPU \u7684\u539f\u5b50\u6307\u4ee4\uff0c\u5982 pthread_mutex_t\uff0c\u5b58\u5728 fast-path \u548c slow-path</p> <ul> <li>fast path:</li> </ul> <ol> <li>\u539f\u5b50\u5730\u5c1d\u8bd5\u83b7\u53d6\u9501: \u4ee3\u7801\u4f1a\u4f7f\u7528\u4e00\u4e2a CPU \u539f\u5b50\u6307\u4ee4\uff08\u4f8b\u5982 CMPXCHG - Compare-and-Exchange\uff09\u6765\u5c1d\u8bd5\u5c06 __lock_status \u4ece 0 (\u672a\u9501\u5b9a) \u53d8\u4e3a 1 (\u5df2\u9501\u5b9a)</li> <li>\u6210\u529f: \u5982\u679c\u539f\u5b50\u64cd\u4f5c\u6210\u529f\uff0c\u610f\u5473\u7740\u5728\u8fd9\u4e00\u77ac\u95f4\uff0c\u9501\u662f\u672a\u88ab\u5360\u6709\u7684\u3002\u5f53\u524d\u7ebf\u7a0b\u73b0\u5728\u6210\u529f\u83b7\u53d6\u4e86\u9501\u3002</li> <li>\u5931\u8d25: \u5982\u679c\u539f\u5b50\u64cd\u4f5c\u5931\u8d25\uff0c\u610f\u5473\u7740 __lock_status \u7684\u503c\u4e0d\u662f 0\u3002\u8fd9\u8bf4\u660e\u9501\u5df2\u7ecf\u88ab\u5176\u4ed6\u7ebf\u7a0b\u6301\u6709\u3002\u6b64\u65f6\uff0c\u6211\u4eec\u4e0d\u80fd\u518d\u7b80\u5355\u5730\u91cd\u8bd5\uff0c\u5fc5\u987b\u8fdb\u5165\u6162\u901f\u8def\u5f84\u3002</li> </ol> <ul> <li> <p>\u5728\u771f\u6b63\u8fdb\u5165\u5185\u6838\u524d\uff0c\u7ebf\u7a0b\u4f1a\u5148\u8fdb\u884c\u4e00\u5c0f\u6bb5\u65f6\u95f4\u7684\u7528\u6237\u6001\u81ea\u65cb\u3002</p> </li> <li> <p>slow path</p> </li> </ul> <ol> <li>\u518d\u6b21\u68c0\u67e5 (Double-Check): \u5728\u51c6\u5907\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u4e4b\u524d\uff0c\u4ee3\u7801\u53ef\u80fd\u4f1a\u518d\u6b21\u68c0\u67e5\u9501\u7684\u72b6\u6001\u3002\u8fd9\u662f\u4e00\u79cd\u4f18\u5316\uff0c\u9632\u6b62\u5728\u4ece\u5feb\u901f\u8def\u5f84\u8f6c\u6362\u5230\u6162\u901f\u8def\u5f84\u7684\u77ed\u6682\u95f4\u9699\u4e2d\uff0c\u9501\u6070\u597d\u88ab\u91ca\u653e\u4e86\u3002</li> <li>\u8c03\u7528\u7cfb\u7edf\u8c03\u7528\u8fdb\u5165\u5185\u6838: \u5982\u679c\u9501\u4ecd\u7136\u88ab\u5360\u7528\uff0c\u7ebf\u7a0b\u4f1a\u6267\u884c\u4e00\u4e2a\u7cfb\u7edf\u8c03\u7528\uff08\u5728 Linux \u4e2d\uff0c\u8fd9\u662f\u901a\u8fc7 futex \u7cfb\u7edf\u8c03\u7528\u5b8c\u6210\u7684\uff09\u3002pthread_mutex_lock \u4f1a\u8c03\u7528 futex(FUTEX_WAIT, ...)\u3002</li> <li>\u5728\u5185\u6838\u4e2d\u7b49\u5f85: \u5185\u6838\u4f1a\u5c06\u8be5\u7ebf\u7a0b\u7684\u72b6\u6001\u4ece\u201c\u8fd0\u884c\u4e2d\u201d\u53d8\u4e3a\u201c\u963b\u585e\u201d\uff0c\u5e76\u5c06\u5176\u4ece\u8c03\u5ea6\u5668\u7684\u8fd0\u884c\u961f\u5217\u4e2d\u79fb\u9664\u3002\u8fd9\u4e2a\u7ebf\u7a0b\u5c06\u4e0d\u518d\u6d88\u8017\u4efb\u4f55 CPU\uff0c\u9759\u9759\u5730\u7b49\u5f85\u88ab\u5524\u9192\u3002</li> </ol> C++<pre><code>// \u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5316\u7684\u6982\u5ff5\u6a21\u578b\uff0c\u771f\u5b9e\u7ed3\u6784\u66f4\u590d\u6742\nstruct pthread_mutex_t {\n    // \u6838\u5fc3\u72b6\u6001\u5b57\uff0c\u901a\u5e38\u662f\u4e00\u4e2a\u6574\u6570\u3002\n    // \u5b83\u7684\u4e0d\u540c\u503c/\u4f4d\u4ee3\u8868\u4e0d\u540c\u7684\u72b6\u6001\u3002\n    // 0: \u672a\u9501\u5b9a (Unlocked)\n    // 1: \u5df2\u9501\u5b9a\uff0c\u65e0\u7b49\u5f85\u8005 (Locked, no waiters)\n    // 2: \u5df2\u9501\u5b9a\uff0c\u6709\u7b49\u5f85\u8005 (Locked, with waiters)\n    int __lock_status;\n\n    // \u5176\u4ed6\u5b57\u6bb5\uff0c\u5982\uff1a\n    int __kind;      // \u9501\u7684\u7c7b\u578b (normal, recursive, error-checking)\n    int __owner_tid; // \u5f53\u524d\u6301\u6709\u9501\u7684\u7ebf\u7a0bID (\u7528\u4e8e\u9012\u5f52\u9501\u548c\u9519\u8bef\u68c0\u67e5)\n    int __recursion_count; // \u9012\u5f52\u8ba1\u6570\u503c\n    // \u53ef\u80fd\u8fd8\u6709\u7528\u4e8e\u81ea\u65cb\u7684\u8ba1\u6570\u5668\u7b49\n};\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#futex","title":"futex","text":"<p>\u5b9e\u9645\u4e0a\u4e3b\u8981\u903b\u8f91\u5206\u4e3a wait(do_futex_wait)\u4ee5\u53ca wake(do_futex_wake)</p>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#do_futex_wait","title":"do_futex_wait","text":"<ol> <li>\u9501\u5b9a\u5185\u6838\u6570\u636e\u7ed3\u6784\uff1a\u83b7\u53d6\u7ba1\u7406\u8be5 uaddr \u7684\u5185\u90e8\u9501\u3002</li> <li>\u9a8c\u8bc1\u6761\u4ef6: \u518d\u6b21\u4ece\u7528\u6237\u7a7a\u95f4\u8bfb\u53d6 *uaddr \u7684\u503c\uff0c\u5e76\u4e0e\u7528\u6237\u4f20\u5165\u7684 val \u6bd4\u8f83\u3002\u8fd9\u662f\u81f3\u5173\u91cd\u8981\u7684\u201c\u539f\u5b50\u6027\u201d\u4fdd\u8bc1\u3002\u5982\u679c\u5728\u7528\u6237\u6001\u68c0\u67e5\u540e\u3001\u8fdb\u5165\u5185\u6838\u524d\uff0c\u9501\u7684\u72b6\u6001\u6539\u53d8\u4e86\uff0c\u8fd9\u4e00\u6b65\u53ef\u4ee5\u53d1\u73b0\uff0c\u5e76\u7acb\u5373\u8fd4\u56de\uff0c\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u4f11\u7720\u3002</li> <li>\u52a0\u5165\u7b49\u5f85\u961f\u5217: \u5982\u679c\u6761\u4ef6\u4ecd\u7136\u6ee1\u8db3\uff0c\u5c06\u5f53\u524d\u7ebf\u7a0b\u5c01\u88c5\u6210\u4e00\u4e2a\u7b49\u5f85\u8282\u70b9\uff0c\u52a0\u5165\u5230 uaddr \u5bf9\u5e94\u7684\u54c8\u5e0c\u7b49\u5f85\u961f\u5217\u4e2d\u3002</li> <li>\u4f11\u7720: \u8c03\u7528\u8c03\u5ea6\u5668 schedule()\uff0c\u653e\u5f03 CPU\uff0c\u8fdb\u5165\u7761\u7720\u72b6\u6001\u3002</li> <li>\u5524\u9192\u540e\u6e05\u7406: \u88ab FUTEX_WAKE \u5524\u9192\u540e\uff0c\u4ece\u7b49\u5f85\u961f\u5217\u4e2d\u79fb\u9664\u81ea\u5df1\uff0c\u7136\u540e\u8fd4\u56de\u7528\u6237\u7a7a\u95f4\u3002</li> </ol>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#do_futex_wake","title":"do_futex_wake","text":"<ol> <li>\u9501\u5b9a\u5185\u6838\u6570\u636e\u7ed3\u6784\uff1a\u627e\u5230 uaddr \u5bf9\u5e94\u7684\u7b49\u5f85\u961f\u5217\u3002</li> <li>\u904d\u5386\u961f\u5217: \u904d\u5386\u7b49\u5f85\u961f\u5217\u4e2d\u7684\u7ebf\u7a0b\u3002</li> <li>\u5524\u9192\u7ebf\u7a0b: \u5bf9\u6bcf\u4e2a\u8981\u5524\u9192\u7684\u7ebf\u7a0b\u8c03\u7528 wake_up_process()\u3002\u8fd9\u4e2a\u51fd\u6570\u662f\u5185\u6838\u8c03\u5ea6\u5b50\u7cfb\u7edf\u7684\u6838\u5fc3\u90e8\u5206\uff0c\u5b83\u4f1a\u6539\u53d8\u7ebf\u7a0b\u7684\u72b6\u6001\uff0c\u4f7f\u5176\u6709\u8d44\u683c\u518d\u6b21\u88ab CPU \u8c03\u5ea6\u3002</li> <li>\u8fd4\u56de: \u8fd4\u56de\u88ab\u6210\u529f\u5524\u9192\u7684\u7ebf\u7a0b\u6570\u91cf\u3002</li> </ol>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#stdatomic_flag","title":"std::atomic_flag","text":"<ul> <li><code>std::atomic_flag</code> \u662f\u4e00\u4e2a\u539f\u5b50\u7684\u5e03\u5c14\u7c7b\u578b\uff0c\u4e5f\u662f\u552f\u4e00\u4fdd\u8bc1 lock-free \u7684\u539f\u5b50\u7c7b\u578b\uff0c\u53ea\u80fd\u7528<code>ATOMIC_FLAG_INIT</code> \u521d\u59cb\u5316\u4e3a false</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#example-1","title":"example 1","text":"<p>\u7528 std::atomic_flag \u5b9e\u73b0\u81ea\u65cb\u9501</p> C++<pre><code>class Spinlock {\n public:\n  void lock() {\n    while (flag_.test_and_set(std::memory_order_acquire)) {\n    }\n  }\n\n  void unlock() { flag_.clear(std::memory_order_release); }\n\n private:\n  std::atomic_flag flag_ = ATOMIC_FLAG_INIT;\n};\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#example-2","title":"example 2","text":"<p>\u7528\u6574\u578b\u539f\u5b50\u7c7b\u578b\u5b9e\u73b0 Spinlock</p> C++<pre><code>class Spinlock {\n public:\n  void lock() {\n    int expected = 0;\n    while (!flag_.compare_exchange_weak(expected, 1, std::memory_order_release,\n                                        std::memory_order_relaxed)) {\n      expected = 0;\n    }\n  }\n\n  void unlock() { flag_.store(0, std::memory_order_release); }\n\n private:\n  std::atomic&lt;int&gt; flag_ = 0;\n};\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/2-Memory%20Model/#requirement","title":"requirement","text":"<ul> <li>\u5982\u679c\u539f\u5b50\u7c7b\u578b\u662f\u81ea\u5b9a\u4e49\u7c7b\u578b\uff0c\u8be5\u81ea\u5b9a\u4e49\u7c7b\u578b\u5fc5\u987b\u53ef\u5e73\u51e1\u590d\u5236\uff08trivially copyable\uff09\uff0c\u4e5f\u5c31\u610f\u5473\u7740\u8be5\u7c7b\u578b\u4e0d\u80fd\u6709\u865a\u51fd\u6570\u6216\u865a\u57fa\u7c7b\u3002\u8fd9\u53ef\u4ee5\u7528 is_trivially_copyable \u68c0\u9a8c\u3002</li> <li>\u81ea\u5b9a\u4e49\u7c7b\u578b\u7684\u539f\u5b50\u7c7b\u578b\u4e0d\u5141\u8bb8\u8fd0\u7b97\u64cd\u4f5c\uff0c\u53ea\u5141\u8bb8 is_lock_free\u3001load\u3001store\u3001exchange\u3001compare_exchange_weak\u3001compare_exchange_strong\uff0c\u4ee5\u53ca\u8d4b\u503c\u64cd\u4f5c\u548c\u5411\u81ea\u5b9a\u4e49\u7c7b\u578b\u8f6c\u6362\u7684\u64cd\u4f5c\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/3-shared%20data%20protection/","title":"Thread Shared Data Protection","text":"2025-06-102025-12-10 <code>#C++</code>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/3-shared%20data%20protection/#mutex","title":"Mutex","text":"<p> \u7ea6 655 \u4e2a\u5b57  42 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <ul> <li>\u4f7f\u7528 mutex \u5728\u8bbf\u95ee\u5171\u4eab\u6570\u636e\u524d\u52a0\u9501\uff0c\u8bbf\u95ee\u7ed3\u675f\u540e\u89e3\u9501\u3002\u4e00\u4e2a\u7ebf\u7a0b\u7528\u7279\u5b9a\u7684 mutex \u9501\u5b9a\u540e\uff0c\u5176\u4ed6\u7ebf\u7a0b\u5fc5\u987b\u7b49\u5f85\u8be5\u7ebf\u7a0b\u7684 mutex \u89e3\u9501\u624d\u80fd\u8bbf\u95ee\u5171\u4eab\u6570\u636e</li> <li><code>std::lock_guard</code> \u53ef\u4ee5\u81ea\u52a8\u5904\u7406 std::mutex \u7684\u52a0\u9501\u4e0e\u89e3\u9501\uff0c\u5b83\u5728\u6784\u9020\u65f6\u63a5\u53d7\u4e00\u4e2a mutex\uff0c\u5e76\u4f1a\u8c03\u7528 mutex.lock()\uff0c\u6790\u6784\u65f6\u4f1a\u8c03\u7528 mutex.unlock()</li> <li><code>std::scoped_lock</code> \u5b83\u53ef\u4ee5\u63a5\u53d7\u4efb\u610f\u6570\u91cf\u7684 mutex\uff0c\u5e76\u5c06\u8fd9\u4e9b mutex \u4f20\u7ed9 std::lock \u6765\u540c\u65f6\u4e0a\u9501\uff0c\u5b83\u4f1a\u5bf9\u5176\u4e2d\u4e00\u4e2a mutex \u8c03\u7528 lock()\uff0c\u5bf9\u5176\u4ed6\u8c03\u7528 try_lock()\uff0c\u82e5 try_lock() \u8fd4\u56de false\uff0c\u5219\u5bf9\u5df2\u7ecf\u4e0a\u9501\u7684 mutex \u8c03\u7528 unlock()\uff0c\u7136\u540e\u91cd\u65b0\u8fdb\u884c\u4e0b\u4e00\u8f6e\u4e0a\u9501\uff0c\u6807\u51c6\u672a\u89c4\u5b9a\u4e0b\u4e00\u8f6e\u7684\u4e0a\u9501\u987a\u5e8f\uff0c\u53ef\u80fd\u4e0d\u4e00\u81f4\uff0c\u91cd\u590d\u6b64\u8fc7\u7a0b\u76f4\u5230\u6240\u6709 mutex \u4e0a\u9501\uff0c\u4ece\u800c\u8fbe\u5230\u540c\u65f6\u4e0a\u9501\u7684\u6548\u679c\u3002</li> <li><code>std::unique_lock</code> \u5728\u6784\u9020\u65f6\u63a5\u53d7\u4e00\u4e2a mutex\uff0c\u5e76\u4f1a\u8c03\u7528 mutex.lock()\uff0c\u6790\u6784\u65f6\u4f1a\u8c03\u7528 mutex.unlock()\uff0cunique_lock \u5141\u8bb8\u6211\u4eec\u5728\u4e2d\u95f4\u8fc7\u7a0b\u53bb\u89e3\u9501\u5e76\u91cd\u65b0\u4e0a\u9501\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/3-shared%20data%20protection/#reader-writer-mutex","title":"Reader-Writer Mutex","text":"<ul> <li>\u8bfb\u9501\uff1a\u5982\u679c\u591a\u4e2a\u7ebf\u7a0b\u8c03\u7528 shared_mutex.lock_shared()\uff0c\u591a\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u540c\u65f6\u8bfb\u3002</li> <li>\u5199\u9501\uff1a\u4e00\u4e2a\u5199\u7ebf\u7a0b\u8c03\u7528 shared_mutex.lock()\uff0c\u5219\u8bfb\u7ebf\u7a0b\u5747\u4f1a\u7b49\u5f85\u8be5\u5199\u7ebf\u7a0b\u91ca\u653e\u9501\u540e\u624d\u4e0a\u9501\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/3-shared%20data%20protection/#recursive-mutex","title":"Recursive Mutex","text":"<ul> <li>\u5b83\u53ef\u4ee5\u5728\u4e00\u4e2a\u7ebf\u7a0b\u4e0a\u591a\u6b21\u83b7\u53d6\u9501\uff0c\u4f46\u5728\u5176\u4ed6\u7ebf\u7a0b\u83b7\u53d6\u9501\u4e4b\u524d\u5fc5\u987b\u91ca\u653e\u6240\u6709\u7684\u9501\u3002</li> <li>\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u9700\u8981\u9012\u5f52\u9501\uff0c\u8bf4\u660e\u4ee3\u7801\u8bbe\u8ba1\u5b58\u5728\u95ee\u9898\u3002\u6bd4\u5982\u4e00\u4e2a\u7c7b\u7684\u6bcf\u4e2a\u6210\u5458\u51fd\u6570\u90fd\u4f1a\u4e0a\u9501\uff0c\u4e00\u4e2a\u6210\u5458\u51fd\u6570\u8c03\u7528\u53e6\u4e00\u4e2a\u6210\u5458\u51fd\u6570\uff0c\u5c31\u53ef\u80fd\u591a\u6b21\u4e0a\u9501\uff0c\u8fd9\u79cd\u60c5\u51b5\u7528\u9012\u5f52\u9501\u5c31\u53ef\u4ee5\u907f\u514d\u4ea7\u751f\u672a\u5b9a\u4e49\u884c\u4e3a\u3002\u4f46\u663e\u7136\u8fd9\u4e2a\u8bbe\u8ba1\u672c\u8eab\u662f\u6709\u95ee\u9898\u7684\uff0c\u66f4\u597d\u7684\u529e\u6cd5\u662f\u63d0\u53d6\u5176\u4e2d\u4e00\u4e2a\u51fd\u6570\u4f5c\u4e3a private \u6210\u5458\u5e76\u4e14\u4e0d\u4e0a\u9501\uff0c\u5176\u4ed6\u6210\u5458\u5148\u4e0a\u9501\u518d\u8c03\u7528\u8be5\u51fd\u6570</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/3-shared%20data%20protection/#initialize-protect","title":"Initialize Protect","text":"<ul> <li>std::once_flag \u548c std::call_once \u6765\u4fdd\u8bc1\u5bf9\u67d0\u4e2a\u64cd\u4f5c\u53ea\u6267\u884c\u4e00\u6b21</li> </ul> C++<pre><code>#include &lt;iostream&gt;\n#include &lt;mutex&gt;\n#include &lt;thread&gt;\n\nclass A {\npublic:\n  void f() {\n    std::call_once(flag_, &amp;A::print, this);\n    std::cout &lt;&lt; 2;\n  }\n\nprivate:\n  void print() { std::cout &lt;&lt; 1; }\n\nprivate:\n  std::once_flag flag_;\n};\n\nint main() {\n  A a;\n  std::thread t1{&amp;A::f, &amp;a};\n  std::thread t2{&amp;A::f, &amp;a};\n  t1.join();\n  t2.join();\n}  // 122\n</code></pre> <ul> <li>static \u5c40\u90e8\u53d8\u91cf\u5728\u58f0\u660e\u540e\u5c31\u5b8c\u6210\u4e86\u521d\u59cb\u5316\uff0c\u8fd9\u5b58\u5728\u6f5c\u5728\u7684 race condition\uff0c\u5982\u679c\u591a\u7ebf\u7a0b\u7684\u63a7\u5236\u6d41\u540c\u65f6\u5230\u8fbe static \u5c40\u90e8\u53d8\u91cf\u7684\u58f0\u660e\u5904\uff0c\u5373\u4f7f\u53d8\u91cf\u5df2\u5728\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u521d\u59cb\u5316\uff0c\u5176\u4ed6\u7ebf\u7a0b\u5e76\u4e0d\u77e5\u6653\uff0c\u4ecd\u4f1a\u5bf9\u5176\u5c1d\u8bd5\u521d\u59cb\u5316\u3002\u4e3a\u6b64\uff0cC++11 \u89c4\u5b9a\uff0c\u5982\u679c static \u5c40\u90e8\u53d8\u91cf\u6b63\u5728\u521d\u59cb\u5316\uff0c\u7ebf\u7a0b\u5230\u8fbe\u6b64\u5904\u65f6\uff0c\u5c06\u7b49\u5f85\u5176\u5b8c\u6210\uff0c\u4ece\u800c\u907f\u514d\u4e86 race condition\u3002\u53ea\u6709\u4e00\u4e2a\u5168\u5c40\u5b9e\u4f8b\u65f6\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528 static \u800c\u4e0d\u9700\u8981 <code>std::call_once</code></li> </ul> C++<pre><code>template &lt;typename T&gt;\nclass Singleton {\npublic:\n  static T&amp; Instance();\n  Singleton(const Singleton&amp;) = delete;\n  Singleton&amp; operator=(const Singleton&amp;) = delete;\n\nprivate:\n  Singleton() = default;\n  ~Singleton() = default;\n};\n\ntemplate &lt;typename T&gt;\nT&amp; Singleton&lt;T&gt;::Instance() {\n  static T instance;\n  return instance;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/4-sync%20concurrency/","title":"Synchronizing concurrent operation","text":"2025-06-102025-12-10 <code>#C++</code>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/4-sync%20concurrency/#condition-variable","title":"Condition Variable","text":"<p> \u7ea6 437 \u4e2a\u5b57  116 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <ul> <li> <p>\u5728\u5e76\u53d1\u7f16\u7a0b\u4e2d\uff0c\u4e00\u79cd\u5e38\u89c1\u7684\u9700\u6c42\u662f\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u7b49\u5f85\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5b8c\u6210\u67d0\u4e2a\u4e8b\u4ef6\u540e\uff0c\u518d\u7ee7\u7eed\u6267\u884c\u4efb\u52a1\u3002\u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\uff0c\u6807\u51c6\u5e93\u63d0\u4f9b\u4e86 std::condition_variable</p> </li> <li> <p>\u4f46\u662f std::condition_variable \u53ea\u80fd\u4e0e std::unique_lock \u534f\u4f5c\uff0cstd::condition_variable_any \u53ef\u4ee5\u548c\u5176\u4ed6\u7c7b\u578b\u7684\u9501\u6765\u534f\u4f5c\u3002</p> </li> <li> <p>\u6709\u591a\u4e2a\u80fd\u5524\u9192\u7684\u4efb\u52a1\u65f6\uff0cnotify_one() \u4f1a\u968f\u673a\u5524\u9192\u4e00\u4e2a</p> </li> </ul> C++<pre><code>#include &lt;condition_variable&gt;\n#include &lt;iostream&gt;\n#include &lt;mutex&gt;\n#include &lt;thread&gt;\n\nclass A {\npublic:\n  void step1() {\n    {\n      std::lock_guard&lt;std::mutex&gt; l(m_);\n      step1_done_ = true;\n    }\n    std::cout &lt;&lt; 1;\n    cv_.notify_one();\n  }\n\n  void step2() {\n    std::unique_lock&lt;std::mutex&gt; l(m_);\n    cv_.wait(l, [this] { return step1_done_; });\n    step2_done_ = true;\n    std::cout &lt;&lt; 2;\n    cv_.notify_one();\n  }\n\n  void step3() {\n    std::unique_lock&lt;std::mutex&gt; l(m_);\n    cv_.wait(l, [this] { return step2_done_; });\n    std::cout &lt;&lt; 3;\n  }\n\nprivate:\n  std::mutex m_;\n  std::condition_variable cv_;\n  bool step1_done_ = false;\n  bool step2_done_ = false;\n};\n\nint main() {\n  A a;\n  std::thread t1(&amp;A::step1, &amp;a);\n  std::thread t2(&amp;A::step2, &amp;a);\n  std::thread t3(&amp;A::step3, &amp;a);\n  t1.join();\n  t2.join();\n  t3.join();\n}  // maybe: 123, 213, 231, 1-block\n</code></pre> C++<pre><code>// condition_variable_any\n#include &lt;condition_variable&gt;\n#include &lt;iostream&gt;\n#include &lt;mutex&gt;\n#include &lt;thread&gt;\n\nclass Mutex {\npublic:\n  void lock() {}\n  void unlock() {}\n};\n\nclass A {\npublic:\n  void signal() {\n    std::cout &lt;&lt; 1;\n    cv_.notify_one();\n  }\n\n  void wait() {\n    Mutex m;\n    cv_.wait(m);\n    std::cout &lt;&lt; 2;\n  }\n\nprivate:\n  std::condition_variable_any cv_;\n};\n\nint main() {\n  A a;\n  std::thread t1(&amp;A::signal, &amp;a);\n  std::thread t2(&amp;A::wait, &amp;a);\n  t1.join();\n  t2.join();\n}  // 12\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/4-sync%20concurrency/#semaphore","title":"Semaphore","text":"<p>\u5373\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684 PV \u64cd\u4f5c\uff0cP \u64cd\u4f5c\u5bf9\u4fe1\u53f7\u91cf\u51cf\u4e00\uff0c\u5982\u679c\u51cf\u5230 0 \u5219\u963b\u585e\uff1bV \u64cd\u4f5c\u5bf9\u4fe1\u53f7\u91cf\u52a0\u4e00\u3002</p> <ul> <li><code>std::counting_semaphore</code>(C++20)\u6a21\u62df\u4fe1\u53f7\u91cf\uff0c\u51fd\u6570\u4f20\u53c2\u8bbe\u7f6e\u4fe1\u53f7\u91cf\u521d\u59cb\u503c</li> <li><code>acquire()</code>\u662f P \u64cd\u4f5c\u3002</li> <li><code>release()</code>\u662f V \u64cd\u4f5c\u3002</li> <li><code>std::binary_semaphore</code> \u662f\u6700\u5927\u503c\u4e3a 1 \u7684\u4fe1\u53f7\u91cf\uff0c\u5373<code>std::counting_semaphore&lt;1&gt;</code></li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/4-sync%20concurrency/#barrier","title":"Barrier","text":"<p>\u963b\u585e\u6240\u6709\u7684\u7ebf\u7a0b\u6267\u884c\u8be5\u6307\u4ee4\u540e\u9762\u7684\u6307\u4ee4\uff0c\u4e00\u822c\u662f\u786c\u4ef6\u6307\u4ee4\uff0cLinux \u63d0\u4f9b\u4e86\u7cfb\u7edf\u8c03\u7528\u63a5\u53e3\u3002</p> <ul> <li><code>std::barrier</code>(C++20)\u5b83\u7528\u4e00\u4e2a\u503c\u4f5c\u4e3a\u8981\u7b49\u5f85\u7684\u7ebf\u7a0b\u7684\u6570\u91cf\u6765\u6784\u9020.</li> <li><code>std::barrier::arrive_and_wait</code>\uff1a\u4f1a\u963b\u585e\u81f3\u6240\u6709\u7ebf\u7a0b\u5b8c\u6210\u4efb\u52a1\uff0c\u5f53\u6700\u540e\u4e00\u4e2a\u7ebf\u7a0b\u5b8c\u6210\u4efb\u52a1\u65f6\uff0c\u6240\u6709\u7ebf\u7a0b\u88ab\u91ca\u653e\uff0cbarrier \u88ab\u91cd\u7f6e\u3002</li> <li>\u6784\u9020 std::barrier \u65f6\u53ef\u4ee5\u989d\u5916\u8bbe\u7f6e\u4e00\u4e2a noexcept \u51fd\u6570\uff0c\u5f53\u6240\u6709\u7ebf\u7a0b\u5230\u8fbe\u963b\u585e\u70b9\u65f6\uff0c\u7531\u5176\u4e2d\u4e00\u4e2a\u7ebf\u7a0b\u8fd0\u884c\u8be5\u51fd\u6570\u3002\u5982\u679c\u60f3\u4ece\u7ebf\u7a0b\u96c6\u4e2d\u79fb\u9664\u7ebf\u7a0b\uff0c\u5219\u5728\u8be5\u7ebf\u7a0b\u4e2d\u5bf9 barrier \u8c03\u7528 <code>std::barrier::arrive_and_drop</code>\u3002</li> <li><code>std::latch</code>(C++20)\u662f\u4e00\u6b21\u6027\u5c4f\u969c\uff0c\u5b83\u7528\u4e00\u4e2a\u503c\u4f5c\u4e3a\u8ba1\u6570\u5668\u7684\u521d\u59cb\u503c\u6765\u6784\u9020\u3002</li> <li><code>std::latch::count_down</code> \u5c06\u8ba1\u6570\u5668\u51cf 1\u3002</li> <li><code>std::latch::wait</code> \u5c06\u963b\u585e\u81f3\u8ba1\u6570\u5668\u4e3a 0\uff0c\u5982\u679c\u60f3\u8ba9\u8ba1\u6570\u5668\u51cf\u4e00\u5e76\u963b\u585e\u81f3\u4e3a 0 \u5219\u53ef\u4ee5\u8c03\u7528 <code>std::latch::arrive_and_wait</code>\u3002</li> </ul> C++<pre><code>#include &lt;barrier&gt;\n#include &lt;cassert&gt;\n#include &lt;iostream&gt;\n#include &lt;thread&gt;\n\nclass A {\n public:\n  void f() {\n    std::barrier sync_point{3, [&amp;]() noexcept { ++i_; }};\n    for (auto&amp; x : tasks_) {\n      x = std::thread([&amp;] {\n        std::cout &lt;&lt; 1;\n        sync_point.arrive_and_wait();\n        assert(i_ == 1);\n        std::cout &lt;&lt; 2;\n        sync_point.arrive_and_wait();\n        assert(i_ == 2);\n        std::cout &lt;&lt; 3;\n      });\n    }\n    for (auto&amp; x : tasks_) {\n      x.join();  // \u6790\u6784 barrier \u524d join \u6240\u6709\u4f7f\u7528\u4e86 barrier \u7684\u7ebf\u7a0b\n    }  // \u6790\u6784 barrier \u65f6\uff0c\u7ebf\u7a0b\u518d\u8c03\u7528 barrier \u7684\u6210\u5458\u51fd\u6570\u662f undefined behavior\n  }\n\n private:\n  std::thread tasks_[3] = {};\n  int i_ = 0;\n};\n\nint main() {\n  A a;\n  a.f();\n}\n</code></pre>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/5.Non-blocking%20DataStructure/","title":"Non-blocking DataStructure","text":"2025-06-102025-12-10 <code>#C++</code>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/5.Non-blocking%20DataStructure/#_1","title":"\u963b\u585e\u4e0e\u975e\u963b\u585e\u7b97\u6cd5 &amp; \u6570\u636e\u7ed3\u6784","text":"<p> \u7ea6 1676 \u4e2a\u5b57  25 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 9 \u5206\u949f</p> <ul> <li>\u963b\u585e\u7684\u7b97\u6cd5\u548c\u6570\u636e\u7ed3\u6784\u4f7f\u7528 mutex\u3001\u6761\u4ef6\u53d8\u91cf\u3001\u671f\u503c\u6765\u540c\u6b65\u6570\u636e\uff0c\u4f46\u975e\u963b\u585e\u4e0d\u7b49\u4ef7\u4e8e lock-free\uff0c\u6bd4\u5982\u81ea\u65cb\u9501\u6ca1\u6709\u4f7f\u7528\u4efb\u4f55\u963b\u585e\u51fd\u6570\u7684\u8c03\u7528\uff0c\u662f\u975e\u963b\u585e\u7684\uff0c\u4f46\u5e76\u975e lock-free</li> <li>\u975e\u963b\u585e\u6570\u636e\u7ed3\u6784\u7531\u677e\u5230\u4e25\u53ef\u5206\u4e3a\u4e09\u4e2a\u7b49\u7ea7\uff1a</li> <li>obstruction-free\uff08\u65e0\u969c\u788d\uff09\uff1a\u5982\u679c\u5176\u4ed6\u7ebf\u7a0b\u90fd\u6682\u505c\u4e86\uff0c\u4efb\u4f55\u4e00\u4e2a\u7ed9\u5b9a\u7684\u7ebf\u7a0b\u90fd\u4f1a\u5728\u6709\u9650\u6b65\u6570\u5185\u5b8c\u6210\u64cd\u4f5c\u3002\u4e0a\u4f8b\u5c31\u662f\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f46\u8fd9\u79cd\u60c5\u51b5\u5f88\u5c11\u89c1\uff0c\u6240\u4ee5\u6ee1\u8db3\u8fd9\u4e2a\u6761\u4ef6\u53ea\u80fd\u7b97\u4e00\u4e2a\u5931\u8d25\u7684 lock-free \u5b9e\u73b0\u3002</li> <li>lock-free\uff08\u65e0\u9501\uff09\uff1a\u5982\u679c\u591a\u7ebf\u7a0b\u5728\u540c\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u4e0a\u64cd\u4f5c\uff0c\u5176\u4e2d\u4e00\u4e2a\u5c06\u5728\u6709\u9650\u6b65\u6570\u5185\u5b8c\u6210\u64cd\u4f5c\u3002\u6ee1\u8db3 lock-free \u5fc5\u5b9a\u6ee1\u8db3 obstruction-free\u3002</li> <li>wait-free\uff08\u65e0\u7b49\u5f85\uff09\uff1a\u5982\u679c\u591a\u7ebf\u7a0b\u5728\u540c\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u4e0a\u64cd\u4f5c\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u4f1a\u5728\u6709\u9650\u6b65\u6570\u5185\u5b8c\u6210\u64cd\u4f5c\u3002\u6ee1\u8db3 wait-free \u5fc5\u5b9a\u6ee1\u8db3 lock-free\uff0c\u4f46 wait-free \u5f88\u96be\u5b9e\u73b0\uff0c\u56e0\u4e3a\u8981\u4fdd\u8bc1\u6709\u9650\u6b65\u6570\u5185\u5b8c\u6210\u64cd\u4f5c\uff0c\u5c31\u8981\u4fdd\u8bc1\u64cd\u4f5c\u4e00\u6b21\u901a\u8fc7\uff0c\u5e76\u4e14\u6267\u884c\u5230\u67d0\u4e00\u6b65\u4e0d\u80fd\u5bfc\u81f4\u5176\u4ed6\u7ebf\u7a0b\u64cd\u4f5c\u5931\u8d25\u3002</li> <li>lock-free \u6570\u636e\u7ed3\u6784\u5fc5\u987b\u5141\u8bb8\u591a\u7ebf\u7a0b\u5e76\u53d1\u8bbf\u95ee\uff0c\u4f46\u5b83\u4eec\u4e0d\u80fd\u505a\u76f8\u540c\u64cd\u4f5c\uff0c\u6bd4\u5982\u4e00\u4e2a lock-free \u7684 queue \u5141\u8bb8\u4e00\u4e2a\u7ebf\u7a0b push\u3001\u53e6\u4e00\u4e2a\u7ebf\u7a0b pop\uff0c\u4f46\u4e0d\u5141\u8bb8\u4e24\u4e2a\u7ebf\u7a0b\u540c\u65f6 push\u3002\u6b64\u5916\uff0c\u5982\u679c\u4e00\u4e2a\u8bbf\u95ee lock-free \u6570\u636e\u7ed3\u6784\u7684\u7ebf\u7a0b\u88ab\u4e2d\u9014\u6302\u8d77\uff0c\u5176\u4ed6\u7ebf\u7a0b\u5fc5\u987b\u80fd\u5b8c\u6210\u64cd\u4f5c\u800c\u4e0d\u9700\u8981\u7b49\u5f85\u6302\u8d77\u7684\u7ebf\u7a0b\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/5.Non-blocking%20DataStructure/#lock-free-thread-safe-stack","title":"lock-free thread-safe stack","text":"<ul> <li>pop \u8fd4\u56de\u503c\u5e94\u8be5\u8fd4\u56de\u667a\u80fd\u6307\u9488\u3002</li> <li>\u5982\u679c\u76f4\u63a5\u8fd4\u56de\u503c\uff0c\u8fd4\u56de\u524d\u4e00\u5b9a\u4f1a\u5148\u79fb\u9664\u5143\u7d20\uff0c\u5982\u679c\u62f7\u8d1d\u8fd4\u56de\u503c\u65f6\u629b\u51fa\u5f02\u5e38\uff0c\u79fb\u9664\u7684\u5143\u7d20\u5c31\u4e22\u5931\u4e86\u3002</li> <li>\u5982\u679c\u4f20\u5f15\u7528\uff0c\u5176\u4ed6\u7ebf\u7a0b\u79fb\u9664\u4e86\u8282\u70b9\uff0c\u88ab\u79fb\u9664\u7684\u8282\u70b9\u4e0d\u80fd\u88ab\u89e3\u5f15\u7528\uff0c\u5f53\u524d\u7ebf\u7a0b\u5c31\u65e0\u6cd5\u5b89\u5168\u5730\u62f7\u8d1d\u6570\u636e\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/5.Non-blocking%20DataStructure/#safety-memory-garbage-collection","title":"Safety Memory Garbage Collection","text":"<p>\u5728\u6709\u9501\u7684\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u5185\u5b58\u56de\u6536\u5f88\u7b80\u5355\uff1a\u5f53\u4e00\u4e2a\u8282\u70b9\u88ab\u4ece\u6570\u636e\u7ed3\u6784\u4e2d\u79fb\u9664\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u7acb\u5373 delete \u5b83\uff0c\u56e0\u4e3a\u6301\u6709\u9501\u7684\u7ebf\u7a0b\u662f\u552f\u4e00\u80fd\u8bbf\u95ee\u8fd9\u4e2a\u8282\u70b9\u7684\u7ebf\u7a0b\u3002</p> <p>\u4f46\u5728\u65e0\u9501\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u60c5\u51b5\u5b8c\u5168\u4e0d\u540c\uff1a</p> <ol> <li>\u7ebf\u7a0b A \u60f3\u8981\u4ece\u6808\u4e2d pop \u4e00\u4e2a\u8282\u70b9\uff08\u6bd4\u5982 Node* old_top\uff09\u3002</li> <li>\u5728\u7ebf\u7a0b A \u771f\u6b63 delete old_top \u4e4b\u524d\uff0c\u5b83\u7684\u65f6\u95f4\u7247\u7528\u5b8c\u4e86\uff0c\u88ab\u6302\u8d77\u3002</li> <li>\u7ebf\u7a0b B \u6b64\u65f6\u53ef\u80fd\u4ecd\u7136\u6301\u6709\u4e00\u4e2a\u6307\u5411 old_top \u7684\u6307\u9488\uff0c\u56e0\u4e3a\u5b83\u5728\u7ebf\u7a0b A pop \u64cd\u4f5c\u5f00\u59cb\u65f6\u4e5f\u6b63\u5728\u8bbf\u95ee\u6808\u9876\u3002</li> <li>\u5982\u679c\u7ebf\u7a0b A \u5728\u6062\u590d\u6267\u884c\u540e\u7acb\u5373 delete old_top\uff0c\u7ebf\u7a0b B \u5c31\u4f1a\u8bbf\u95ee\u4e00\u4e2a\u5df2\u7ecf\u88ab\u91ca\u653e\u7684\u5185\u5b58\uff08\u60ac\u6302\u6307\u9488\uff09\uff0c\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\u3002</li> </ol> <p>\u6240\u4ee5\u6211\u4eec\u91ca\u653e\u5185\u5b58\u5f53\u4e14\u4ec5\u5f53\u6ca1\u6709\u4efb\u4f55\u7ebf\u7a0b\u6b63\u5728\u8bbf\u95ee\u5b83\u65f6\u3002</p>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/5.Non-blocking%20DataStructure/#hazard-pointers","title":"Hazard Pointers","text":"<p>code implement</p> <p>\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u201c\u98ce\u9669\u6307\u9488\u5217\u8868\u201d</p> C++<pre><code>// \u5168\u5c40\u98ce\u9669\u6307\u9488\u6570\u7ec4\uff0c\u5b58\u50a8\u6bcf\u4e2a\u7ebf\u7a0b\u7684\u98ce\u9669\u6307\u9488\nstatic std::atomic&lt;void *&gt; g_hazard_pointers[MAX_THREADS];\n// \u5168\u5c40\u6807\u5fd7\uff0c\u8bb0\u5f55\u54ea\u4e2a\u69fd\u88ab\u54ea\u4e2a\u7ebf\u7a0b\u5360\u7528\nstatic std::atomic_flag g_hp_owner_flags[MAX_THREADS];\n</code></pre> <ul> <li>\u7cfb\u7edf\u4e3a\u6bcf\u4e00\u4e2a\u53c2\u4e0e\u65e0\u9501\u64cd\u4f5c\u7684\u7ebf\u7a0b\u5206\u914d\u4e00\u4e2a\uff08\u6216\u591a\u4e2a\uff09\u98ce\u9669\u6307\u9488 (Hazard Pointer)\u3002</li> <li>\u8fd9\u4e9b\u98ce\u9669\u6307\u9488\u901a\u5e38\u5b58\u50a8\u5728\u4e00\u4e2a\u5168\u5c40\u7684\u3001\u6240\u6709\u7ebf\u7a0b\u90fd\u53ef\u4ee5\u8bfb\u53d6\u7684\u5217\u8868\u4e2d\u3002</li> <li>\u4e00\u4e2a\u98ce\u9669\u6307\u9488\u5c31\u662f\u4e00\u4e2a void* \u6216 Node*\uff0c\u5b83\u6307\u5411\u4e00\u4e2a\u5185\u5b58\u5730\u5740\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/5.Non-blocking%20DataStructure/#_2","title":"\u201c\u5ba3\u544a\u98ce\u9669\u201d\u7684\u64cd\u4f5c\u6d41\u7a0b","text":"<p>\u5f53\u4e00\u4e2a\u7ebf\u7a0b\uff08\u6bd4\u5982\u7ebf\u7a0b A\uff09\u8981\u8bbf\u95ee\u4e00\u4e2a\u53ef\u80fd\u88ab\u5176\u4ed6\u7ebf\u7a0b\u5220\u9664\u7684\u5171\u4eab\u8282\u70b9\uff08\u6bd4\u5982 node_p\uff09\u65f6\uff0c\u5b83\u5fc5\u987b\u9075\u5faa\u4ee5\u4e0b\u6d41\u7a0b\uff1a</p> <ol> <li>\u83b7\u53d6\u8282\u70b9\u6307\u9488: \u7ebf\u7a0b A \u9996\u5148\u4ee5\u67d0\u79cd\u65b9\u5f0f\u83b7\u53d6\u4e86 node_p \u7684\u6307\u9488\uff08\u4f8b\u5982\uff0c\u901a\u8fc7\u539f\u5b50\u5730\u8bfb\u53d6 stack.top\uff09\u3002</li> <li>\u8bbe\u7f6e\u98ce\u9669\u6307\u9488 (Set Hazard Pointer): \u5728\u771f\u6b63\u89e3\u5f15\u7528 node_p \u4e4b\u524d\uff0c\u7ebf\u7a0b A \u5fc5\u987b**\u201c\u5ba3\u544a\u201d\u5b83\u5c06\u8981\u8bbf\u95ee\u8fd9\u4e2a\u8282\u70b9\u3002\u5b83\u4f1a\u628a node_p \u7684\u5730\u5740\u5199\u5165\u5230\u5b83\u81ea\u5df1\u7684**\u98ce\u9669\u6307\u9488\u4e2d\u3002</li> <li>\u9a8c\u8bc1 (Validation): \u8fd9\u662f\u81f3\u5173\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u7528\u4e8e\u89e3\u51b3 ABA \u95ee\u9898\u3002\u8bbe\u7f6e\u5b8c\u98ce\u9669\u6307\u9488\u540e\uff0c\u7ebf\u7a0b A \u5fc5\u987b\u518d\u6b21\u68c0\u67e5\u5b83\u60f3\u8981\u8bbf\u95ee\u7684\u8282\u70b9\u662f\u5426\u8fd8\u662f\u539f\u6765\u7684\u90a3\u4e2a\u3002\u5982\u679c\u9a8c\u8bc1\u901a\u8fc7\uff0c\u7ebf\u7a0b A \u5c31\u53ef\u4ee5\u5b89\u5168\u5730\u8bbf\u95ee node_p \u4e86\uff0c\u56e0\u4e3a\u5b83\u5df2\u7ecf\u786e\u4fdd\u4e86\u5728\u5b83\u5ba3\u544a\u98ce\u9669\u4e4b\u540e\uff0c\u8fd9\u4e2a\u8282\u70b9\u6ca1\u6709\u88ab\u5176\u4ed6\u7ebf\u7a0b\u79fb\u9664\u3002</li> </ol> C++<pre><code>// \u518d\u6b21\u8bfb\u53d6\u6808\u9876\uff0c\u770b\u5b83\u662f\u5426\u5df2\u7ecf\u53d8\u4e86\nif (stack.top.load() != node_p) {\n  // \u5982\u679c\u53d8\u4e86\uff0c\u8bf4\u660e\u5728\u6211\u5ba3\u544a\u98ce\u9669\u7684\u77ac\u95f4\uff0c\u8282\u70b9\u5df2\u7ecf\u88ab pop \u4e86\u3002\n  // \u6211\u5ba3\u544a\u7684\u98ce\u9669\u65e0\u6548\uff0c\u5fc5\u987b\u4ece\u5934\u518d\u6765\u3002\n  thread_local_hazard_pointer.store(nullptr); // \u6e05\u9664\u98ce\u9669\u5ba3\u544a\n  goto retry_loop;\n}\n</code></pre> <ol> <li>\u6267\u884c\u64cd\u4f5c: \u7ebf\u7a0b A \u73b0\u5728\u53ef\u4ee5\u5b89\u5168\u5730\u89e3\u5f15\u7528 node_p \u5e76\u8fdb\u884c\u64cd\u4f5c\uff08\u4f8b\u5982\uff0c\u8bfb\u53d6\u5b83\u7684 value \u548c next \u6307\u9488\uff09\u3002</li> <li>\u6e05\u9664\u98ce\u9669\u6307\u9488 (Clear Hazard Pointer): \u5f53\u7ebf\u7a0b A \u4e0d\u518d\u9700\u8981\u8bbf\u95ee node_p \u65f6\uff0c\u5b83\u5fc5\u987b\u6e05\u9664\u81ea\u5df1\u7684\u98ce\u9669\u6307\u9488\uff0c\u544a\u8bc9\u5927\u5bb6\u5b83\u5df2\u7ecf\u7528\u5b8c\u4e86\u3002</li> </ol>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/5.Non-blocking%20DataStructure/#_3","title":"\u5b89\u5168\u5220\u9664\u8282\u70b9\u7684\u6d41\u7a0b","text":"<p>\u5f53\u4e00\u4e2a\u7ebf\u7a0b\uff08\u6bd4\u5982\u7ebf\u7a0b C\uff09\u6210\u529f\u5730\u4ece\u6570\u636e\u7ed3\u6784\u4e2d\u79fb\u9664\u4e86\u4e00\u4e2a\u8282\u70b9\uff08\u6bd4\u5982 removed_node\uff09\u540e\uff0c\u5b83\u4e0d\u80fd\u7acb\u5373 delete \u8fd9\u4e2a\u8282\u70b9\u3002 \u5b83\u9700\u8981\u505a\u7684\u662f\uff1a</p> <ol> <li>(Retire List)\u201d: \u7ebf\u7a0b C \u5c06 removed_node \u7684\u6307\u9488\u6dfb\u52a0\u5230\u4e00\u4e2a\u5c5e\u4e8e\u5b83\u81ea\u5df1\u7684\u3001\u79c1\u6709\u7684\u201c\u5f85\u5220\u9664\u5217\u8868\u201d\u4e2d\u3002</li> </ol> C++<pre><code>static thread_local std::vector&lt;Node *&gt; retired_list_;\n</code></pre> <ol> <li>\u5b9a\u671f\u626b\u63cf\u548c\u6e05\u7406 (Scan and Reclaim): \u7ebf\u7a0b C \u4f1a\u5728\u67d0\u4e2a\u65f6\u523b\uff08\u6bd4\u5982\uff0c\u5f53\u5b83\u7684\u5f85\u5220\u9664\u5217\u8868\u8fbe\u5230\u4e00\u5b9a\u5927\u5c0f\u65f6\uff09\u89e6\u53d1\u4e00\u6b21\u6e05\u7406\u64cd\u4f5c\u3002</li> </ol> <ul> <li>\u83b7\u53d6\u6240\u6709\u98ce\u9669\u6307\u9488: \u5b83\u4f1a\u904d\u5386\u5168\u5c40\u7684\u98ce\u9669\u6307\u9488\u5217\u8868\uff0c\u6536\u96c6\u6240\u6709\u7ebf\u7a0b\u5f53\u524d\u5ba3\u544a\u7684\u6240\u6709\u98ce\u9669\u6307\u9488\uff0c\u5e76\u5c06\u5b83\u4eec\u653e\u5165\u4e00\u4e2a\u96c6\u5408\u4e2d\u3002 C++<pre><code>// \u5168\u5c40\u51fd\u6570\uff1a\u626b\u63cf\u6240\u6709\u98ce\u9669\u6307\u9488\uff0c\u8fd4\u56de\u4e00\u4e2a\u5305\u542b\u6240\u6709\u53d7\u4fdd\u62a4\u6307\u9488\u7684\u96c6\u5408\nstd::vector&lt;void *&gt; get_all_hazard_pointers() {\n  std::vector&lt;void *&gt; pointers;\n  for (unsigned i = 0; i &lt; MAX_THREADS; ++i) {\n      void *p =\n          HazardPointer::g_hazard_pointers[i].load(std::memory_order_acquire);\n      if (p) {\n          pointers.push_back(p);\n      }\n  }\n  return pointers;\n}\n</code></pre></li> <li>\u68c0\u67e5\u5e76\u5220\u9664: \u7136\u540e\uff0c\u5b83\u904d\u5386\u81ea\u5df1\u7684\u201c\u5f85\u5220\u9664\u5217\u8868\u201d\u3002\u5bf9\u4e8e\u5217\u8868\u4e2d\u7684\u6bcf\u4e00\u4e2a node_to_delete\uff0c\u5b83\u68c0\u67e5\u8fd9\u4e2a node_to_delete \u662f\u5426\u5b58\u5728\u4e8e\u521a\u521a\u6536\u96c6\u7684\u98ce\u9669\u6307\u9488\u96c6\u5408\u4e2d\uff1a   1. \u5982\u679c\u4e0d\u5b58\u5728\uff0c\u8bf4\u660e\u5f53\u524d\u6ca1\u6709\u4efb\u4f55\u7ebf\u7a0b\u6b63\u5728\u8bbf\u95ee\u8fd9\u4e2a\u8282\u70b9\uff0c\u53ef\u4ee5\u5b89\u5168\u5730 delete \u5b83\u3002   1. \u5982\u679c\u5b58\u5728\uff0c\u8bf4\u660e\u6709\u5176\u4ed6\u7ebf\u7a0b\u6b63\u5728\u8bbf\u95ee\u5b83\uff0c\u4e0d\u80fd\u5220\u9664\u3002\u8fd9\u4e2a\u8282\u70b9\u4f1a\u88ab\u4fdd\u7559\u5728\u5f85\u5220\u9664\u5217\u8868\u4e2d\uff0c\u7b49\u5f85\u4e0b\u4e00\u6b21\u6e05\u7406\u3002</li> </ul>","tags":["C++"]},{"location":"notes/C%2B%2BConcurrency/5.Non-blocking%20DataStructure/#reference-count","title":"Reference Count","text":"<p>\u4e3a\u6bcf\u4e2a\u8282\u70b9\u589e\u52a0\u4e00\u4e2a\u539f\u5b50\u5f15\u7528\u8ba1\u6570 (Atomic Reference Counter): std::shared_ptr \u7684\u64cd\u4f5c\u662f\u539f\u5b50\u7684\uff0c\u4f46\u8981\u68c0\u67e5\u662f\u5426 lock-free</p> <ul> <li>\u83b7\u53d6\u6307\u9488\u65f6\u589e\u52a0\u8ba1\u6570: \u5f53\u4e00\u4e2a\u7ebf\u7a0b\u8981\u8bbf\u95ee\u4e00\u4e2a\u8282\u70b9\u65f6\uff0c\u5b83\u4f1a\u539f\u5b50\u5730\u589e\u52a0\u8be5\u8282\u70b9\u7684\u5f15\u7528\u8ba1\u6570\u3002</li> <li>\u4f7f\u7528\u5b8c\u6bd5\u540e\u51cf\u5c11\u8ba1\u6570: \u5f53\u7ebf\u7a0b\u4e0d\u518d\u9700\u8981\u8bbf\u95ee\u8be5\u8282\u70b9\u65f6\uff0c\u5b83\u4f1a\u539f\u5b50\u5730\u51cf\u5c11\u8be5\u8282\u70b9\u7684\u5f15\u7528\u8ba1\u6570\u3002</li> <li>\u5220\u9664\u65f6\u68c0\u67e5\u8ba1\u6570: \u5f53\u4e00\u4e2a\u8282\u70b9\u4ece\u6570\u636e\u7ed3\u6784\u4e2d\u88ab\u903b\u8f91\u4e0a\u79fb\u9664\uff08\u4f8b\u5982\uff0c\u4ece\u6808\u9876 pop \u51fa\u6765\uff09\u540e\uff0c\u6267\u884c\u79fb\u9664\u64cd\u4f5c\u7684\u7ebf\u7a0b\u4f1a\u51cf\u5c11\u5176\u5f15\u7528\u8ba1\u6570\u3002\u5982\u679c\u6b64\u65f6\u5f15\u7528\u8ba1\u6570\u53d8\u4e3a 0\uff0c\u5219\u8bf4\u660e\u6ca1\u6709\u4efb\u4f55\u7ebf\u7a0b\uff08\u5305\u62ec\u5b83\u81ea\u5df1\uff09\u5728\u5f15\u7528\u8fd9\u4e2a\u8282\u70b9\uff0c\u6b64\u65f6\u53ef\u4ee5\u5b89\u5168\u5730 delete \u5b83\u3002</li> </ul>","tags":["C++"]},{"location":"notes/CMU15445/10-Join%20Algorithm/","title":"10-Join Algorithm","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#10-join-algorithm","title":"10-Join Algorithm","text":"<p> \u7ea6 351 \u4e2a\u5b57  22 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#101-join-algorithms","title":"10.1 join algorithms","text":"<p>\u5c3d\u53ef\u80fd\u9009\u62e9\u8f83\u5c0f\u7684\u8868\u4f5c\u4e3a\u5916\u56f4\u8868</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#102-join-opetators","title":"10.2 Join opetators","text":"","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#output","title":"Output","text":"","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#data","title":"data","text":"","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#cost-analysis-criteria","title":"Cost Analysis Criteria","text":"","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#nested-loop-join","title":"Nested Loop Join","text":"","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#nested-loop-join_1","title":"Nested Loop Join","text":"<p>\u5df2\u77e5\u8868\u975e\u5e38\u5c0f\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528 nested loop join\uff0c\u53ef\u4ee5\u9002\u914d L3 \u7f13\u5b58</p> <p></p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#index-nested-loop-join","title":"Index Nested Loop Join","text":"","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#block-nested-loop-join","title":"Block Nested loop join","text":"","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#nested-loop-join-summary","title":"Nested Loop Join Summary","text":"<p>Key Takeaways</p> <p>\u9009\u62e9\u66f4\u5c0f\u7684\u8868\u4f5c\u4e3a Outer table\\ \u5c3d\u53ef\u80fd\u5728 bufferpool \u4e2d\u7f13\u5b58 outer table\\ \u4f7f\u7528\u7d22\u5f15\u5feb\u901f\u8bbf\u95ee inner table</p> <p>Algorithms</p> <p>Naive\\ Block\\ Index</p>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#sort-merge-join","title":"Sort-Merge Join","text":"<ol> <li>Sort</li> </ol> <ol> <li>Merge</li> </ol> <p>\u6b64\u65f6 R \u4e2d id \u4e3a 200\uff1bS \u7684 id \u6bd4 200 \u5927\uff0c\u9700\u8981\u56de\u6eaf\uff0c\u4f46\u662f\u7531\u4e8e\u8868\u662f\u6709\u5e8f\u7684\uff0c\u4e0d\u5fc5\u50cf nested loop join \u56de\u6eaf\u5230\u5f00\u5934\u53ea\u9700\u8981\u56de\u6eaf\u5230\u4e0a\u4e00\u4e2a\u4e0d\u5927\u4e8e R.id \u7684\u503c\u5c31\u53ef\u4ee5 </p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#when-is-sort-merge-join-useful","title":"when is sort-merge join useful","text":"<ol> <li>\u5176\u4e2d\u4e00\u4e2a\u6216\u591a\u4e2a\u8868\u5728 Join key \u4e0a\u5df2\u7ecf\u6392\u5e8f</li> <li>\u8f93\u51fa\u5fc5\u987b\u5728 join key \u4e0a\u6392\u5e8f</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#hash-join","title":"Hash Join","text":"","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#simple-hash-join-algorithm","title":"simple hash join algorithm","text":"<p>\u53ef\u4ee5\u5728 probe \u9636\u6bb5\u4f7f\u7528 bloom filter \u8fdb\u884c\u4f18\u5316\uff1b\u9996\u5148\u6982\u7387\u6027\u5730\u67e5\u627e\u662f\u5426\u5b58\u5728\u8fd9\u4e2a Key</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#partitioned-hash-join","title":"Partitioned hash join","text":"<ol> <li>partiion phase</li> <li>probe phase</li> </ol> <p>\u5982\u679c\u5176\u4e2d\u7684\u6876\u4ecd\u7136\u6ea2\u51fa\uff0c\u4f7f\u7528\u7b2c\u4e8c\u4e2a\u54c8\u5e0c\u51fd\u6570\u8fdb\u884c rehash </p>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#hybird-hash-join","title":"Hybird hash join","text":"<p>\u4ec5\u4ec5\u5728\u6570\u636e\u5206\u5e03\u53ca\u5176\u503e\u659c\u7684\u65f6\u5019\u4f7f\u7528\uff1b\u5c06\u5927\u91cf\u4f7f\u7528\u7684 hash \u6876\u4fdd\u5b58\u5728\u5185\u5b58 </p>","tags":["Database"]},{"location":"notes/CMU15445/10-Join%20Algorithm/#join-algorithms-summary","title":"Join algorithms summary","text":"<p>hashing is almost always better than sorting for operator executino\\ sorting is better on non-uniform data\\ sorting si better when result needs to be sorted</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/","title":"11 Query Execution","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#11-query-execution","title":"11. Query Execution","text":"<p> \u7ea6 422 \u4e2a\u5b57  32 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#processing-models","title":"Processing Models","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#iterator-model","title":"Iterator Model","text":"<p>\u8fed\u4ee3\u5668\u6a21\u578b\uff0c\u4e5f\u53eb\u505a\u706b\u5c71\u6216\u8005\u6d41\u6c34\u7ebf\u6a21\u578b</p> <p>\u5927\u91cf\u51fd\u6570\u8c03\u7528\uff0c\u6307\u4ee4\u7f13\u5b58\u4f1a\u5f88\u5feb\u5931\u6548</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#materialization-model","title":"Materialization Model","text":"<p>\u751f\u6210\u6240\u6709\u6570\u636e\u7136\u540e\u8fd4\u56de\u7ed9\u4e0a\u5c42</p> <p>\u5bf9\u4e8e OLTP \u8868\u73b0\u4e0d\u9519\uff0c\u56e0\u4e3a\u6ca1\u6709\u5f88\u5927\u7684\u8868\u9700\u8981\u4f20\u9012</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#vectorizedbatch-model","title":"Vectorized/Batch MOdel","text":"<p>\u5728\u7269\u5316\u6a21\u578b\u548c\u706b\u5c71\u6a21\u578b\u95f4\u662f\u4e00\u4e2a\u826f\u597d\u7684\u5e73\u8861\\ \u53ef\u4ee5\u4f7f\u7528 SIMD \u6307\u4ee4\u52a0\u901f</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#plan-processing-direction","title":"Plan Processing Direction","text":"<p>\u81ea\u4e0a\u800c\u4e0b\u5bf9\u4e8e\u4e0a\u9762\u7684\u6a21\u578b\u6765\u8bf4\u66f4\u52a0\u81ea\u7136</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#access-methods","title":"Access Methods","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#sequential-scan","title":"Sequential Scan","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#optimization","title":"Optimization","text":"<ul> <li>Prefetching</li> <li>Buffer Pool Bypass</li> <li>Parallelization</li> <li>Heap Clustering</li> <li>\u53ea\u662f\u53d6\u56de RID\uff0c\u6700\u540e\u624d\u53d6\u56de\u771f\u6b63\u7684\u6570\u636e</li> <li>Late Materialization</li> <li>Data Skipping</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#data-sipping","title":"Data Sipping","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#zone-maps","title":"ZONE MAPS","text":"<p>one zone map in one zone\uff0czone \u7684\u5927\u5c0f\u53d6\u51b3\u4e8e\u6211\u4eec\u7684\u5b9e\u73b0\uff0c\u4e00\u822c\u4e3a\u9875\\ \u5f53 zone map \u5b58\u50a8\u5728\u533a\u57df\u4e4b\u5916\uff0c\u4e0e\u7d22\u5f15\u7684\u5de5\u4f5c\u6d41\u7a0b\u5f88\u50cf</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#index-scan","title":"Index Scan","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#multi-index-scan","title":"Multi-Index Scan","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#modification-queries","title":"Modification Queries","text":"<p>Halloween problem: \u8ddf\u8e2a\u5df2\u7ecf\u4fee\u6539\u8fc7\u7684 record id\uff0c\u4e00\u822c\u5728\u64cd\u4f5c\u7b26\u5185\u90e8\u4f7f\u7528\u6570\u636e\u7ed3\u6784\u6765\u8ddf\u8e2a\uff0c\u907f\u514d\u4e0b\u4e00\u6b21\u518d\u6b21\u4fee\u6539 materailization \u4e0d\u4f1a\u6709\u8fd9\u6837\u7684\u95ee\u9898</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#expression-evaluation","title":"Expression Evaluation","text":"<p>JIT compilation \u53ef\u4ee5\u9ad8\u6548\u5730\u8bc4\u4f30\u8868\u8fbe\u5f0f\uff1b\u8868\u8fbe\u5f0f\u4f1a\u88ab\u7f16\u8bd1\u6210\u5e38\u91cf\u6216\u51fd\u6570</p> <p></p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#scheduler","title":"Scheduler","text":"<p>quickstep \u7684 scheduler \u539f\u578b\uff1b\u5de5\u4f5c\u7ebf\u7a0b\u6c60\u662f\u65e0\u72b6\u6001\u7684\u3001\u5f39\u6027\u53ef\u4f38\u7f29\u7684\uff0c\u53ef\u4ee5\u5bf9\u67e5\u8be2\u8fdb\u884c\u4f18\u5148\u7ea7\u7684\u6267\u884c</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#process-models","title":"Process Models","text":"<ol> <li>Process per DBMS Worker </li> <li>Thread per DBMS Worker </li> <li>Embedded DBMS </li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#execution-parallelism","title":"Execution Parallelism","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#inter-query-parallelism","title":"Inter-query Parallelism","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#intra-query-parallelism","title":"Intra-query Parallelism","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#intra-operatorhorizontal","title":"Intra-Operator(Horizontal)","text":"<p>\u901a\u8fc7\u786c\u4ef6\u5e76\u884c\u6027\u52a8\u6001\u786e\u5b9a\uff0c\u73b0\u5728\u4e00\u822c\u901a\u8fc7\u8c03\u5ea6\u5668\u6765\u5b9e\u73b0</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#inter-operatorvertical","title":"Inter-Operator(Vertical)","text":"<p>\u6295\u5f71\u8fd0\u7b97\u7b26\u5728\u4e0b\u5c42\u8fd0\u7b97\u7b26\u8fd8\u6ca1\u6709\u6267\u884c\u5b8c\u6210\u65f6\uff0c\u5c31\u5f00\u59cb\u5de5\u4f5c</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#bushy","title":"Bushy","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#io-parallelism","title":"I/O Parallelism","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#multi-disk-parallelism","title":"Multi-Disk Parallelism","text":"","tags":["Database"]},{"location":"notes/CMU15445/11-Query_Execution/#database-partitioning","title":"Database Partitioning","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/","title":"12 Query Planning and Optimization","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#query-planning-and-optimization","title":"Query Planning and Optimization","text":"<p> \u7ea6 310 \u4e2a\u5b57  33 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p> <p>catalog \u662f\u4e00\u4e2a\u8bb0\u5f55\u5143\u6570\u636e\u4fe1\u606f\u7684\u6587\u4ef6</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#the-physical-plan","title":"The Physical Plan","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#query-optimizationqo","title":"Query Optimization(QO)","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#heuristicsrules","title":"Heuristics/Rules","text":"<ul> <li>\u91cd\u5199\u67e5\u8be2\u6765\u53bb\u9664\u90a3\u4e9b\u65e0\u6548\u7684\u6761\u4ef6</li> <li>\u8fd9\u4e9b\u6280\u5de7\u9700\u8981\u8bbf\u95ee catalog\uff0c\u4f46\u662f\u5b83\u4eec\u4e0d\u9700\u8981\u8bbf\u95ee\u6570\u636e</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#predicate-pushdown","title":"Predicate Pushdown","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#replace-cartesian-product","title":"Replace Cartesian Product","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#projection-pushdown","title":"Projection Pushdown","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#equivalence","title":"Equivalence","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#architecture-overview","title":"Architecture Overview","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#cost-based-search","title":"Cost-based Search","text":"<ul> <li>\u4f7f\u7528\u4e00\u4e2a\u6a21\u578b\u6765\u9884\u6d4b\u6267\u884c\u4e00\u4e2a\u8ba1\u5212\u7684\u6210\u672c</li> <li>\u904d\u5386\u591a\u79cd\u8ba1\u5212\uff0c\u9009\u62e9\u4e00\u4e2a\u6210\u672c\u6700\u5c0f\u7684\u8ba1\u5212\u6765\u6267\u884c</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#bottom-up-optimization","title":"Bottom-up Optimization","text":"<p>\u4f7f\u7528\u52a8\u6001\u89c4\u5212\uff0c\u81ea\u5e95\u5411\u4e0a\u6784\u5efa\u67e5\u8be2\u8ba1\u5212\u6210\u672c\u6700\u4f4e\u7684\u8ba1\u5212</p> <p></p> <ul> <li>single-relation query palnning</li> </ul> <p></p> <p>system R optimization \u5c06\u903b\u8f91\u8ba1\u5212\u6784\u5efa\u4e3a\u5de6\u6df1\u6811</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#top-down-optimization","title":"Top-Down Optimization","text":"<p>\u81ea\u9876\u5411\u4e0b\u7684\u4f18\u5316\u63a7\u5236\u6743\u66f4\u591a\uff0c\u6211\u4eec\u53ef\u4ee5\u4ece\u4e00\u4e2a\u8ba1\u5212\u5f00\u59cb\u9010\u6b65\u7ec6\u5316\u8fc7\u7a0b</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#nested-sub-queries","title":"Nested Sub-queries","text":"<p>\u76f8\u5173\u5b50\u67e5\u8be2\u5f88\u5bb9\u6613\u88ab\u6241\u5e73\u5316\u4e3a join \u7684\u67e5\u8be2\\ \u4e0d\u76f8\u5173\u7684\u5b50\u67e5\u53ef\u4ee5\u62c6\u5206\u6210\u4e0d\u540c\u7684\u8bed\u53e5\u8fdb\u884c\u6267\u884c</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#rewrite","title":"Rewrite","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#decomposing-queries","title":"Decomposing Queries","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#expression-rerwriteing","title":"Expression rerwriteing","text":"","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#cost-estimation","title":"Cost Estimation","text":"<ul> <li>Physical Costs</li> </ul> <p>predict CPU-cycles, I/O, cache misses, RAM consumption, network messages...\\ Depends heavily on hardware</p> <ul> <li>Logical Costs</li> </ul> <p>estimate output size per operator\\ independent of the operator algorithm\\ need estimations for operator result sizes</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#selection-cardinality","title":"selection cardinality","text":"<p>\u53ef\u4ee5\u4f7f\u7528 selection cardinality \u6765\u63a8\u6d4b\u8f93\u51fa\u7684\u5927\u5c0f</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/12-Query_Plan%26Optimization/#statistics","title":"Statistics","text":"","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/","title":"13 Concurrency Control Theory","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#concurrency-control-theory","title":"Concurrency Control Theory","text":"<p> \u7ea6 231 \u4e2a\u5b57  16 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#transaction-in-sql","title":"Transaction in sql","text":"","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#acid","title":"ACID","text":"","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#mechanisms-for-ensuring-atomicity","title":"Mechanisms for ensuring atomicity","text":"","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#logging","title":"Logging","text":"<p>LSM tree \u662f\u9488\u5bf9\u5355\u4e2a\u8868\u6587\u4ef6\u914d\u7f6e\u7684\uff1b\u800c logging \u662f\u9488\u5bf9\u5168\u5c40\u8de8\u6587\u4ef6\u8bbe\u7f6e\u7684</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#shadow-paging","title":"Shadow Paging","text":"<p>\u5373\u4f7f\u6539\u53d8\u51e0\u5b57\u8282\uff0c\u4e5f\u4f1a\u590d\u5236\u6574\u4e2a\u9875</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#consistency","title":"Consistency","text":"<p>\u5f88\u591a\u7cfb\u7edf\u91c7\u7528\u6700\u7ec8\u4e00\u81f4\u6027\uff0c\u4f46\u5728\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u51fa\u73b0\u4e0d\u4e00\u81f4\u7684\u60c5\u51b5</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#mechanisms-for-ensuring-isolation","title":"Mechanisms for ensuring isolation","text":"","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#formal-properties-of-schedules","title":"Formal Properties of schedules","text":"","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#unreaptable-read","title":"Unreaptable Read","text":"<p>\u8bfb\u5199\u51b2\u7a81\u7684\u60c5\u51b5\u4e0b\uff0c\u540c\u4e00\u4e8b\u52a1\u5728\u4e24\u6b21\u8bfb\u53d6\u540c\u4e00\u4e2a\u503c\u65f6\u8bfb\u5230\u4e24\u4e2a\u4e0d\u540c\u7684\u503c</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#dirty-read","title":"Dirty Read","text":"<p>\u5199\u8bfb\u51b2\u7a81\u4e0b\uff0c\u53e6\u4e00\u4e2a\u4e8b\u52a1\u8bfb\u53d6\u4e86\u5176\u4ed6\u4e8b\u52a1\u5e76\u672a\u63d0\u4ea4\u7684\u503c\u5e76\u63d0\u4ea4</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#lost-update","title":"Lost Update","text":"<p>\u5199\u5199\u51b2\u7a81\u5bfc\u81f4\u4e8b\u52a1\u66f4\u65b0\u503c\u6d88\u5931</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#dependency-graph-confict-serializable","title":"Dependency Graph &amp; Confict Serializable","text":"<p>\u5927\u591a\u6570 DBMS \u5b9e\u73b0\u51b2\u7a81\u53ef\u4e32\u884c\u5316 \u5982\u679c\u56fe\u4e2d\u51fa\u73b0\u73af\u8def\uff0c\u8bf4\u660e\u8fd9\u4e2a\u8c03\u5ea6\u662f bad schedule</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/13-Concurrency_Control_Theory/#transaction-durability","title":"Transaction Durability","text":"","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/","title":"14 Two Phase Lock","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#two-phase-lock-concurrency-control","title":"Two Phase Lock Concurrency Control","text":"<p> \u7ea6 664 \u4e2a\u5b57  19 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#executing-with-locks","title":"Executing with locks","text":"<p>\u4e8b\u52a1\u9700\u8981\u9501(upgrade) \u9501\u7ba1\u7406\u5668\u4e3a\u8bf7\u6c42\u7533\u8bf7\u9501\\ \u4e8b\u52a1\u91ca\u653e\u9501\\ \u9501\u7ba1\u7406\u5668\u66f4\u65b0\u5185\u90e8\u7684 lock table\\ lock table \u8ddf\u8e2a\u6bcf\u4e2a\u4e8b\u52a1\u6301\u6709\u4ec0\u4e48\u9501\uff0c\u5e76\u6b63\u5728\u7b49\u5f85\u4ec0\u4e48\u9501</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#locks-vs-latches","title":"Locks vs. Latches","text":"<p>locks \u4fdd\u62a4\u6570\u636e\u5e93\u78c1\u76d8\u4e0a\u7684\u5bf9\u8c61\uff1block manager \u662f\u5185\u5b58\u6570\u636e\u7ed3\u6784\uff0c\u8be5\u7ed3\u6784\u4f7f\u7528 latch \u8fdb\u884c\u4fdd\u62a4</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#basic-lock-types","title":"Basic Lock Types","text":"<ul> <li>S-LOCK: shared locks for reads</li> <li>X-LOCK: Exclusive lock for writes</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#two-phase-locking2pl","title":"Two-Phase locking(2PL)","text":"<p>\u662f\u4e00\u79cd\u5e76\u53d1\u63a7\u5236\u534f\u8bae\\ \u8be5\u534f\u8bae\u4e0d\u9700\u8981\u77e5\u9053\u4e8b\u52a1\u5c06\u8981\u6267\u884c\u7684\u6240\u6709\u67e5\u8be2\\ \u4e24\u9636\u6bb5\u9501\u534f\u8bae\u53ef\u80fd\u4f1a\u53d1\u751f\u6b7b\u9501\uff0c\u4f46\u53ef\u4ee5\u901a\u8fc7\u9002\u5f53\u7684\u7b56\u7565\uff08\u5982\u6b7b\u9501\u68c0\u6d4b\u548c\u9884\u9632\uff09\u6765\u5904\u7406\u548c\u907f\u514d\u3002</p> <ol> <li>Growing</li> </ol> <p>\u6bcf\u4e2a\u4e8b\u52a1\u5411 DBMS \u7684\u9501\u7ba1\u7406\u5668\u8bf7\u6c42\u5b83\u6240\u9700\u8981\u7684\u9501\\ \u9501\u7ba1\u7406\u5668\u540c\u610f\u6216\u62d2\u7edd\u9501\u8bf7\u6c42</p> <ol> <li>Shrinking</li> </ol> <p>\u4e8b\u52a1\u5728\u8be5\u9636\u6bb5\u4ec5\u4ec5\u91ca\u653e\u6216\u8005\u5bf9\u9501\u964d\u7ea7\\ \u4e0d\u53ef\u4ee5\u518d\u6b21\u7533\u8bf7\u9501</p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#executing-with-2pl","title":"Executing with 2PL","text":"<p>\u9501\u673a\u5236\u5b9e\u9645\u4e0a\u662f\u5728\u6253\u7834 dependency graph \u7684\u5faa\u73af\u4f9d\u8d56\\ \u4f46\u662f\u5b83\u4f1a\u51fa\u73b0\u7ea7\u8054\u7ec8\u6b62\u95ee\u9898</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#cascading-aborts","title":"Cascading aborts","text":"<p>\u5f53 T1 \u4e8b\u52a1\u91ca\u653e\u9501\u540e abort\uff0cT2 \u4e8b\u52a1\u5df2\u7ecf\u83b7\u53d6\u4e86 T1 \u4e2d\u7684 A \u9501\uff0c\u9020\u6210\u810f\u8bfb</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#strong-strict-two-phase-locking","title":"Strong strict two-phase locking","text":"<p>\u4ec5\u4ec5\u5f53\u4e8b\u52a1 commit \u6216\u8005 abort \u624d\u80fd\u91ca\u653e\u9501</p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#2pl-deadlocks","title":"2PL Deadlocks","text":"<p>\u4e24\u79cd\u89e3\u51b3\u65b9\u6848\uff1a\u6b7b\u9501\u68c0\u6d4b\u6216\u8005\u6b7b\u9501\u907f\u514d</p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#deadlock-detection","title":"Deadlock detection","text":"<p>node \u662f\u4e8b\u52a1\\ \\(T\\_{i}\\)\u5230\\(T\\_{j}\\)\u7684\u8fb9\u8868\u793a\\(T\\_{i}\\)\u7b49\u5f85\\(T\\_{j}\\)\u91ca\u653e\u9501\\ \u8fd9\u4e2a\u7cfb\u7edf\u68c0\u67e5 waits-for graph \u7684 cycle \u5e76\u51b3\u5b9a\u5982\u4f55\u6253\u7834\u5b83</p> <p></p> <p>\u5f53 DBMS \u53d1\u73b0\u4e00\u4e2a\u6b7b\u9501\uff0c\u5b83\u4f1a\u9009\u62e9\u4e00\u4e2a victim \u4e8b\u52a1\u53ca\u9006\u884c\u56de\u6eda\u6765\u6253\u7834\u601d\u7d22\\ victim \u4e8b\u52a1\u901a\u5e38\u4f1a\u91cd\u542f\u6216\u8005 abort\\ \u5728\u68c0\u6d4b\u6b7b\u9501\u9891\u7387\u4ee5\u53ca\u4e8b\u52a1\u5728\u6b7b\u9501\u524d\u7b49\u5f85\u65f6\u95f4\u662f\u4e00\u4e2a trade-off \u95ee\u9898</p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#rollback-length","title":"Rollback length","text":"","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#deadlock-prevention","title":"Deadlock prevention","text":"<p>Wait-Die: \u5982\u679c\u7b49\u5f85\u9501\u7684\u4e8b\u52a1\u66f4\u65e9\u5f00\u59cb\uff0c\u53ef\u4ee5\u7b49\u5f85\u6301\u6709\u9501\u7684\u4e8b\u52a1\u91ca\u653e\u9501\uff1b\u5426\u5219\u7b49\u5f85\u9501\u7684\u4e8b\u52a1\u76f4\u63a5 abort\\ Wound-Die: \u5982\u679c\u7b49\u5f85\u9501\u7684\u4e8b\u52a1\u66f4\u65e9\u5f00\u59cb\uff0c\u53ef\u4ee5\u62a2\u593a\u6301\u6709\u9501\u7684\u4e8b\u52a1\u7684\u9501\u4f7f\u5176 abort\uff1b\u5426\u5219\u7b49\u5f85\u9501\u7684\u4e8b\u52a1 wait </p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#lock-granularities","title":"Lock Granularities(\u9501\u7c92\u5ea6)","text":"","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#intention-locks","title":"intention locks(\u610f\u5411\u9501)","text":"<p>\u5982\u679c\u53ea\u662f\u4e00\u4e2a\u53ea\u8bfb\u4e8b\u52a1\uff0c\u53ea\u4f1a\u5728\u8868\u4e0a\u83b7\u53d6 S \u9501\uff0c\u800c\u4e0d\u662f\u610f\u5411\u9501</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#example","title":"example","text":"<p>\u4f7f\u7528\u610f\u5411\u9501\uff0c\u5fc5\u987b\u5728 tuple \u4e2d\u83b7\u53d6\u6700\u7ec8\u7684 S \u6216 X \u9501\uff1b\u5b83\u7684\u7236\u8282\u70b9\u5fc5\u987b\u662f IS\u3001IX \u6216\u8005 SIX \u9501</p> <p></p> <p></p> <p>\u5347\u7ea7\u9501\u7684\u8bf7\u6c42\u53ef\u80fd\u62e5\u6709\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7</p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#lock-escalation","title":"Lock Escalation(\u9501\u5347\u7ea7)","text":"<p>\u5728\u4f4e\u5c42\u7ea7\u7684\u8bb8\u591a\u9501\u90fd\u662f X \u9501\uff1b\u5b83\u7684\u7236\u8282\u70b9\u7684\u5c42\u7ea7\u9501\u4e5f\u4f1a\u53d8\u4e3a X \u9501</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/14-Two_Phase_Lock/#postgresql-lock-table","title":"PostgreSQL lock table","text":"","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/","title":"15 Timestamp Ordering Concurrency Control","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#timestamp-ordering-concurrency-control","title":"Timestamp Ordering Concurrency Control","text":"<p> \u7ea6 846 \u4e2a\u5b57  29 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <p>2PL \u548c\u65f6\u95f4\u6233\u6392\u5e8f\u7b97\u6cd5\u662f\u60b2\u89c2\u5e76\u53d1\u63a7\u5236\u7b97\u6cd5\\ \u8fd8\u6709\u4e50\u89c2\u5e76\u53d1\u63a7\u5236\u7b97\u6cd5</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#to-concurrency-control","title":"T/O Concurrency Control","text":"<p>\u4f7f\u7528\u65f6\u95f4\u6233\u6765\u786e\u4fdd\u4e8b\u52a1\u6267\u884c\u7684\u987a\u5e8f \u5982\u679c TS(\\(T_I\\)) &lt; TS(\\(T_j\\))\uff0cDBMS \u9700\u8981\u786e\u4fdd\u6267\u884c\u7684\u8c03\u5ea6\u5fc5\u987b\u548c\\(T_i\\)\u53d1\u751f\u5728\\(T_j\\)\u524d\u7684\u4e32\u884c\u5316\u8c03\u5ea6\u76f8\u540c</p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#timestamp-allocation","title":"Timestamp allocation","text":"<ol> <li>System/Wall Clock</li> <li>Logical Counter</li> <li>Hybrid</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#basic-to","title":"Basic T/O","text":"<p>\u4e8b\u52a1\u8bfb\u53d6\u548c\u5199\u5165\u5bf9\u8c61\u4e0d\u9700\u8981\u9501</p> <p>W-TS(X)\uff1a\u662f\u6700\u540e\u6210\u529f\u5199\u5165\u7684\u4e8b\u52a1\u7684\u65f6\u95f4\u6233</p> <p>R-TS(X)\uff1a\u662f\u6700\u540e\u6210\u529f\u8bfb\u53d6\u7684\u4e8b\u52a1\u7684\u65f6\u95f4\u6233</p> <p>\u5982\u679c\u4e8b\u52a1\u5c1d\u8bd5\u83b7\u53d6\u65f6\u95f4\u6233\u5728\u81ea\u5df1\u4e4b\u540e\u7684\u5bf9\u8c61\uff0c\u4f1a abort \u7136\u540e restart</p> <p>\u4e3a\u6bcf\u4e2a\u4e8b\u52a1\u4fdd\u5b58\u6570\u636e\u526f\u672c\u5f00\u9500\u5f88\u5927\uff1b\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u4e8b\u52a1\u5f88\u53ef\u80fd\u4f1a\u88ab\u997f\u6b7b\uff0c\u65b0\u4e8b\u52a1\u53ef\u80fd\u4f1a\u4f7f\u5f97\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u4e8b\u52a1 abort \u5e76 restart</p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#reads","title":"Reads","text":"<p>\u4f1a\u4e3a X \u521b\u5efa\u4e00\u4e2a\u672c\u5730\u526f\u672c\u6765\u786e\u4fdd\\(T_i\\)\u53ef\u91cd\u590d\u8bfb</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#writes","title":"Writes","text":"","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#optimistic-concurrency-control","title":"Optimistic Concurrency Control","text":"<p>\u4e8b\u52a1\u5bf9\u6570\u636e\u7684\u4fee\u6539\u53ea\u53d1\u751f\u5728\u4e8b\u52a1\u672c\u5730\u7684 workspace</p> <p></p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#occ-validation","title":"occ validation","text":"","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#occ-write-phase","title":"occ write phase","text":"<p>\u4e32\u884c\u63d0\u4ea4\uff0c\u6bcf\u6b21\u53ea\u5141\u8bb8\u4e00\u4e2a\u4e8b\u52a1\u5904\u4e8e validation/write \u9636\u6bb5</p> <p></p> <p>OCC \u5728\u51b2\u7a81\u6bd4\u8f83\u5c11\u7684\u60c5\u51b5\u4e0b\u5de5\u4f5c\u6bd4\u8f83\u597d\uff1a\\ \u6240\u6709\u7684\u4e8b\u52a1\u90fd\u662f\u53ea\u8bfb\u7684(ideal)\\ \u4e8b\u52a1\u8bbf\u95ee\u7684\u6570\u636e\u6ca1\u6709\u4ea4\u96c6</p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#occ-performance-issues","title":"OCC-performance issues","text":"<ol> <li>\u672c\u5730\u590d\u5236\u6570\u636e\u7684\u9ad8\u6210\u672c</li> <li>Validation/Write \u9636\u6bb5\u7684\u74f6\u9888</li> <li>abort \u6bd4 2PL \u66f4\u52a0\u6d6a\u8d39(\u56e0\u4e3a\u53d1\u751f\u5728\u4e8b\u52a1\u5df2\u7ecf\u6267\u884c\u540e\u624d\u8fdb\u884c abort)</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#the-phantom-problem","title":"The phantom Problem(\u5e7b\u8bfb\u95ee\u9898)","text":"<p>\\(T_1\\)\u4ec5\u5bf9\u5df2\u7ecf\u5b58\u5728\u7684\u8bb0\u5f55\u8fdb\u884c\u9501\u5b9a\uff0c\u65e0\u6cd5\u770b\u5230\u65b0\u63d2\u5165\u7684\u8bb0\u5f55\uff08\u4f7f\u7528 table-level \u7684\u9501\u65e0\u95ee\u9898\uff1b\u4f7f\u7528 record-level \u9501\u4f1a\u51fa\u73b0\u4e0a\u8ff0\u95ee\u9898\uff09</p> <p>2PL, OCC \u90fd\u662f\u521b\u5efa\u672c\u5730\u526f\u672c\uff0c\u4ecd\u7136\u65e0\u6cd5\u770b\u5230\u4e8b\u52a1\u8fd0\u884c\u540e\u5176\u5b83\u4e8b\u52a1\u65b0\u63d2\u5165\u7684\u8bb0\u5f55</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#solution","title":"solution","text":"<ol> <li>\u5b8c\u6210\u4e8b\u52a1\u4e4b\u524d\uff0c\u91cd\u65b0\u8bfb\u53d6\u67e5\u8be2\u6307\u5b9a\u7684\u6240\u6709\u6570\u636e</li> <li>\u8c13\u8bcd\u9501\uff1a\u5728\u67e5\u8be2\u771f\u6b63\u5f00\u59cb\u8fd0\u884c\u4e4b\u524d\u903b\u8f91\u4e0a\u51b3\u5b9a\u8986\u76d6\u54ea\u4e9b\u8c13\u8bcd</li> <li>\u7d22\u5f15\u9501\uff1a\u7c7b\u4f3c\u8c13\u8bcd\u9501</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#re-execute-scans","title":"Re-execute scans","text":"","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#preidcate-locking","title":"Preidcate Locking","text":"<p>\u8c13\u8bcd\u9501\u7684\u5de5\u4f5c\u539f\u7406\u53ef\u4ee5\u6982\u8ff0\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u6b65\u9aa4\uff1a</p> <ol> <li>\u5b9a\u4e49\u8c13\u8bcd\uff1a\u5728\u6267\u884c\u67e5\u8be2\u6216\u66f4\u65b0\u64cd\u4f5c\u65f6\uff0c\u5b9a\u4e49\u4e00\u4e2a\u8c13\u8bcd\u6761\u4ef6\uff08\u5982 age &gt; 18\uff09\uff0c\u63cf\u8ff0\u60f3\u8981\u9501\u5b9a\u7684\u6761\u4ef6\u3002\u8fd9\u4e00\u8c13\u8bcd\u4f1a\u6839\u636e\u67e5\u8be2\u6216\u64cd\u4f5c\u6d89\u53ca\u7684\u6570\u636e\u8303\u56f4\u800c\u53d8\u5316\u3002</li> <li>\u5e94\u7528\u8c13\u8bcd\u9501\uff1a\u6570\u636e\u5e93\u5c06\u8fd9\u4e00\u8c13\u8bcd\u5e94\u7528\u4e8e\u5f53\u524d\u6570\u636e\u8868\u7684\u8303\u56f4\uff0c\u6807\u8bb0\u51fa\u7b26\u5408\u6761\u4ef6\u7684\u6570\u636e\u9879\uff08\u5982\u5e74\u9f84\u5927\u4e8e 18 \u7684\u6240\u6709\u884c\uff09\u3002\u5728\u6ca1\u6709\u5177\u4f53\u6570\u636e\u4fe1\u606f\u65f6\uff0c\u5b83\u5e76\u4e0d\u662f\u76f4\u63a5\u9501\u4f4f\u67d0\u4e00\u884c\uff0c\u800c\u662f\u9501\u4f4f\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u533a\u57df\u3002</li> <li>\u5224\u65ad\u51b2\u7a81\uff1a\u5f53\u5176\u4ed6\u4e8b\u52a1\u5c1d\u8bd5\u8bbf\u95ee\u6570\u636e\u5e93\u65f6\uff0c\u7cfb\u7edf\u4f1a\u68c0\u67e5\u5b83\u4eec\u662f\u5426\u6d89\u53ca\u5230\u5df2\u7ecf\u88ab\u8c13\u8bcd\u9501\u9501\u5b9a\u7684\u533a\u57df\u3002\u5982\u679c\u5176\u4ed6\u4e8b\u52a1\u7684\u8c13\u8bcd\u6761\u4ef6\u4e0e\u5f53\u524d\u9501\u4ea7\u751f\u51b2\u7a81\uff0c\u7cfb\u7edf\u4f1a\u963b\u6b62\u8be5\u4e8b\u52a1\u7ee7\u7eed\uff0c\u76f4\u81f3\u9501\u91ca\u653e\u3002</li> <li>\u9501\u91ca\u653e\uff1a\u5b8c\u6210\u5bf9\u88ab\u9501\u5b9a\u533a\u57df\u7684\u64cd\u4f5c\u540e\uff0c\u4e8b\u52a1\u63d0\u4ea4\u6216\u56de\u6eda\uff0c\u7cfb\u7edf\u968f\u5373\u91ca\u653e\u8c13\u8bcd\u9501\u3002</li> </ol> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#index-locking","title":"Index Locking","text":"<p>\u901a\u8fc7\u95f4\u9699\u9501\u6765\u9632\u6b62\u5176\u4ed6\u4e8b\u52a1\u63d2\u5165\u51fa\u73b0\u95ee\u9898</p> <p></p> <p>\u4e0b\u9762\u8fd9\u4e24\u79cd\u65b9\u5f0f\u53ea\u80fd\u5b9e\u73b0\u4e00\u79cd\uff0c\u5982\u679c\u4e24\u79cd\u90fd\u5b9e\u73b0\u4f1a\u53d1\u751f\u6b7b\u9501</p> <p> </p> <p>\u5c42\u6b21\u9501</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#locking-without-an-index","title":"Locking without an index","text":"<p>\u4f7f\u7528\u7c97\u7c92\u5ea6\u7684\u9501\uff08page lock or table lock\uff09\uff0c\u635f\u5931\u5e76\u884c\u5ea6</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/15-Timestamp_Ordering_Concurrency/#isolation-levels","title":"Isolation levels","text":"<p>\u8bfb\u5df2\u63d0\u4ea4\u5e76\u6ca1\u6709\u4e25\u683c\u9075\u5b88 2PL \u534f\u8bae\uff0c\u800c\u662f\u8bfb\u53d6\u540e\u76f4\u63a5\u91ca\u653e\u5171\u4eab\u9501</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/","title":"16 Multi-Version Concurrency","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#mutli-version-concurrency","title":"Mutli-Version Concurrency","text":"<p> \u7ea6 552 \u4e2a\u5b57  18 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p> <p>DBMS \u6709\u591a\u4e2a\u7269\u7406\u7248\u672c\u548c\u4e00\u4e2a\u903b\u8f91\u7248\u672c</p> <p>\u4e00\u4e2a\u4e8b\u52a1\u5199\u5165\u65f6\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7248\u672c\uff1b\u8bfb\u53d6\u65f6\u4f1a\u8bfb\u53d6\u8be5\u4e8b\u52a1\u5f00\u59cb\u65f6\u6700\u65b0\u7684\u7248\u672c</p> <p>MVCC \u5b9e\u9645\u4e0a\u662f\u7ef4\u62a4\u591a\u4e2a\u7248\u672c\u7684\u673a\u5236\uff1b\u800c\u7248\u672c\u4e4b\u95f4\u7684\u5e76\u53d1\u6b63\u786e\u6027\u4ecd\u7136\u9700\u8981\u5e76\u53d1\u63a7\u5236\u534f\u8bae\u6765\u7ef4\u62a4</p> <p></p> <p>writers do not block readers and readers do not block writers</p> <p>\u53ea\u8bfb\u4e8b\u52a1\u53ef\u4ee5\u4e0d\u83b7\u53d6\u9501\u8bfb\u53d6\u4e00\u4e2a\u4e00\u81f4\u6027\u7684\u5feb\u7167</p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#mvcc-example","title":"MVCC example","text":"","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#write-skew-anomaly","title":"Write Skew Anomaly","text":"<p>\u5feb\u7167\u9694\u79bb\u5e76\u4e0d\u80fd\u786e\u4fdd\u53ef\u4e32\u884c\u6027\uff1b\u53ef\u80fd\u51fa\u73b0\u8fd9\u79cd\u5199\u504f\u659c\u95ee\u9898</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#version-storage","title":"Version Storage","text":"","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#append-only-storage","title":"Append-Only Storage","text":"<p>\u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u4e2a\u591a\u7248\u672c\u7684\u5355\u94fe\u8868</p> <ol> <li>Oldest to Newest(O2N)</li> <li>Newest to Oldest(N2O)</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#time-travel-storage","title":"Time-Travel Storage","text":"<p>\u4e3a\u672c\u6765\u6ca1\u6709\u505a MVCC \u7684\u7cfb\u7edf\u63d0\u4f9b\u7684\u4e00\u79cd MVCC \u673a\u5236</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#delta-storage","title":"Delta Storage","text":"<p>\u589e\u91cf\u5b58\u50a8\uff1a\u53ea\u5b58\u50a8\u66f4\u6539\u540e\u7684\u5217</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#garbage-collection","title":"Garbage Collection","text":"","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#tuple-level-gc","title":"Tuple-level GC","text":"<p>\u540e\u53f0\u6e05\u7406\uff1a\u53ea\u626b\u63cf\u88ab\u4fee\u6539\u7684\u9875\uff0c\u5bfb\u627e\u5230\u4e0d\u5728\u88ab\u5f15\u7528\u7684\u9875\u7684\u7248\u672c\uff0c\u5c06\u8fd9\u4e9b tuple \u901a\u8fc7\u540e\u53f0\u8fdb\u7a0b\u5904\u7406\u6389</p> <p></p> <p>\u534f\u540c\u6e05\u7406\uff1a\u7d22\u5f15\u53ef\u80fd\u6307\u5411 O2N \u7684\u94fe\uff0c\u4e8b\u52a1\u5728\u627e\u5230\u5f53\u524d\u9700\u8981\u7684\u7248\u672c\u65f6\u4f1a\u540c\u65f6\u6e05\u7406\u4e0d\u518d\u9700\u8981\u7684\u7248\u672c\u53f7</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#transaction-level-gc","title":"Transaction-level GC","text":"<p>\u6bcf\u4e2a\u4e8b\u52a1\u4f1a\u8ddf\u8e2a\u4ed6\u81ea\u5df1\u7684\u8bfb\u5199\u96c6\u5408\u5e76\u4ea4\u7ed9 GC worker</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#index-management","title":"Index Management","text":"","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#secondary-indexes","title":"Secondary Indexes","text":"<ol> <li>Logical Pointers: \u4e0d\u4f1a\u76f4\u63a5\u6307\u5411\u771f\u5b9e\u6570\u636e\uff0c\u800c\u662f\u6307\u5411\u4e00\u4e2a\u95f4\u63a5\u5c42\uff1b\u4e00\u822c\u6307\u5411\u4e3b\u952e\u7d22\u5f15</li> </ol> <ol> <li>Physical Pointers: \u76f4\u63a5\u6307\u5411\u7248\u672c\u94fe\u7684\u5934\u90e8</li> </ol> <p>\u5982\u679c\u6211\u8981\u66f4\u65b0\u7248\u672c\u94fe\uff0c\u6211\u4f1a\u66f4\u65b0\u591a\u4e2a\u6307\u9488\u7684\u6307\u5411\uff1b\u5f00\u9500\u8fc7\u5927</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#mvcc-indexes","title":"MVCC Indexes","text":"<ol> <li>\u6bcf\u4e2a\u7d22\u5f15\u5fc5\u987b\u652f\u6301\u91cd\u590d\u7684\u952e\u6765\u6307\u5411\u4e0d\u540c\u7684\u5feb\u7167 <p>\u76f8\u540c\u7684 key \u5728\u4e0d\u540c\u7684\u5feb\u7167\u4e2d\u6307\u5411\u4e0d\u540c\u7684\u903b\u8f91 tuples</p> </li> </ol> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/16-Mult-Version_Concurrency/#mvcc-deletes","title":"MVCC Deletes","text":"<p>\u903b\u8f91\u5220\u9664\uff1a\\ \u5728\u67d0\u4e9b MVCC \u5b9e\u73b0\u4e2d\uff0c\u5220\u9664\u64cd\u4f5c\u53ef\u80fd\u53ea\u662f\u5c06\u6570\u636e\u6807\u8bb0\u4e3a\u201c\u5df2\u5220\u9664\u201d\uff0c\u800c\u4e0d\u662f\u7269\u7406\u79fb\u9664\u3002\u8fd9\u610f\u5473\u7740\u6570\u636e\u4ecd\u7136\u5b58\u5728\u4e8e\u6570\u636e\u5e93\u4e2d\uff0c\u4f46\u5728\u67e5\u8be2\u65f6\u4e0d\u4f1a\u88ab\u8fd4\u56de\u3002 \u8fd9\u6837\u53ef\u4ee5\u4fdd\u6301\u6570\u636e\u7684\u4e00\u81f4\u6027\u548c\u53ef\u8ffd\u6eaf\u6027\u3002\\ \u771f\u6b63\u7684\u7269\u7406\u5220\u9664\u7531\u540e\u53f0\u7ebf\u7a0b\u81ea\u52a8\u6e05\u7406\u8fc7\u671f\u7684\u7248\u672c</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/","title":"17 Database Logging","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#database-logging","title":"Database Logging","text":"<p> \u7ea6 588 \u4e2a\u5b57  13 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#crash-recovery","title":"Crash Recovery","text":"<ol> <li>Actions during normal txn processing to ensure that the DBMS can recover from a failure</li> <li>Actions after a failure to recovver the database to a state that ensures atomicity, consistency, and durability</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#failure-classification","title":"Failure Classification","text":"","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#transaction-failures","title":"Transaction Failures","text":"<ol> <li>Logical Errors: \u4e8b\u52a1\u56e0\u4e3a\u4e00\u4e9b\u5185\u90e8\u539f\u56e0\u6ca1\u6709\u5b8c\u6210\uff08\u5b8c\u6574\u6027\u7ea6\u675f\u5931\u6548\uff09</li> <li>Internal State Errors: DBMS \u5fc5\u987b\u7ec8\u6b62\u4e00\u4e2a\u6d3b\u8dc3\u7684\u4e8b\u52a1\u56e0\u4e3a\u4e00\u4e2a\u9519\u8bef\u7684\u6761\u4ef6\uff08\u6b7b\u9501\uff09</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#system-failures","title":"System Failures","text":"<ol> <li>Software Failure: OS \u6216\u8005 DBMS \u5b9e\u73b0\u7684\u9519\u8bef</li> <li>Hardware Failure: <p>the computer hosting the DBMS crahsed(\u7535\u6e90\u7ebf\u88ab\u62c9\u4e86)\\ Fail-stop Assumption: \u975e\u6613\u5931\u6027\u5b58\u50a8\u7684\u5185\u5bb9\u88ab\u5047\u8bbe\u4e0d\u4f1a\u88ab system crash \u7834\u574f</p> </li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#storage-media-failures","title":"Storage Media Failures","text":"<p>Non-Repairable\uff08\u65e0\u6cd5\u4fee\u590d\u7684\uff09 Hardware Failure</p> <ol> <li>head crash \u6216\u8005\u76f8\u4f3c\u7684\u78c1\u76d8 failure \u7834\u574f\u4e86\u6240\u6709\u6216\u8005\u90e8\u5206\u7684 non-volatile storage</li> <li>\u91cd\u5efa\u88ab\u5047\u8bbe\u53ef\u4ee5\u88ab detectable(\u78c1\u76d8\u63a7\u5236\u5668\u4f7f\u7528\u6821\u9a8c\u548c\u6765\u68c0\u6d4b\u9519\u8bef)</li> </ol> <p>\u6570\u636e\u5e93\u4e0d\u80fd\u4ece\u8fd9\u79cd\u9519\u8bef\u4e2d\u6062\u590d\u6570\u636e</p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#undo-vs-redo","title":"UNDO VS. REDO","text":"","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#steal-policy","title":"Steal Policy","text":"<p>\u4f3c\u4e4e\u5426\u5141\u8bb8 DBMS \u5141\u8bb8\u4e00\u4e2a\u672a\u63d0\u4ea4\u7684\u4e8b\u52a1\u8986\u76d6\u6700\u8fd1\u63d0\u4ea4\u7684\u6570\u636e</p> <p>Steal: is allowed No-steal: is not allowed</p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#force-policy","title":"Force Policy","text":"<p>\u662f\u5426\u4e00\u4e2a DBMS \u8981\u6c42\u4e8b\u52a1\u7684\u6240\u6709\u66f4\u65b0\u90fd\u5728\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u524d\u53cd\u5e94\u5230 non-valaile \u5b58\u50a8\u4e2d</p> <p>Force: is required NO-force: is not required</p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#combination","title":"Combination","text":"","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#no-steal-force","title":"NO-STEAL + FORCE","text":"<p>\u4e0d\u5fc5 undo\uff0c\u56e0\u4e3a\u6539\u53d8\u8fd8\u672a\u5199\u5165\u78c1\u76d8\uff1b\\ \u4e0d\u5fc5 redo\uff0c\u56e0\u4e3a\u6240\u6709\u7684\u6539\u53d8\u5728\u63d0\u4ea4\u65f6\u5df2\u7ecf\u786e\u4fdd\u5199\u5165\u78c1\u76d8</p> <p></p> <p>Shadow Paging \u5b9e\u9645\u4e0a\u5728\u526f\u672c\u4e0a\u8fdb\u884c\u4fee\u6539\uff0c\u4e8b\u52a1 commit \u540e\uff0c\u5c06 master \u6e05\u7a7a\u5e76\u5c06 shadow \u4f5c\u4e3a\u65b0\u7684 master</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#steal-no-force","title":"STEAL + NO-FORCE","text":"<p>\u7ef4\u62a4\u4e00\u4e2a log \u5305\u542b\u4e86\u4e8b\u52a1\u5bf9\u6570\u636e\u5e93\u7684\u6539\u53d8</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#wal-protocol","title":"WAL PROTOCOL","text":"<p>\u5728\u6570\u636e\u5199\u5165\u78c1\u76d8\u524d\uff0c\u5bf9\u6570\u636e\u8fdb\u884c\u64cd\u4f5c\u7684\u65e5\u5fd7\u5fc5\u987b\u5148\u843d\u76d8</p> <p></p> <p>\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u9700\u8981\u7b49\u5f85 log \u843d\u76d8\uff0c\u8fd9\u53ef\u80fd\u4f1a\u6210\u4e3a\u74f6\u9888\uff1b\u6240\u4ee5 DBMS \u4f7f\u7528 group commit optimization \u6765 batch multiple log flushed\uff1b\u8fd9\u4f1a\u63d0\u9ad8\u541e\u5410\u91cf</p> <ol> <li>\u5982\u679c buffer \u6ee1\u4e86\uff0c\u5199\u78c1\u76d8</li> <li>\u5982\u679c\u8d85\u65f6\u4e86\uff0c\u5199\u78c1\u76d8\uff085ms\uff09</li> </ol> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#logging-schemes","title":"Logging Schemes","text":"<p>\u903b\u8f91\u65e5\u5fd7\u9700\u8981\u91cd\u65b0\u6267\u884c\u8bed\u53e5\uff0c\u6210\u672c\u8fc7\u4e8e\u9ad8\u6602\uff1bPhysiological \u5728\u9875\u7ea7\u522b\u662f\u7269\u7406\u7684\uff0c\u4f46\u662f\u9875\u5185\u90e8\u53ea\u8bb0\u5f55\u4fee\u6539\u7684\u6570\u636e</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#checkpoints","title":"Checkpoints","text":"<p>\u591a\u9891\u7e41\u5730\u8fdb\u884c\u68c0\u67e5\u70b9\u7684\u8bbe\u7f6e\u662f\u4e00\u4e2a tradeoff</p>","tags":["Database"]},{"location":"notes/CMU15445/17-Database_Logging/#blockingconsistent-checkpoint-protocol","title":"Blocking/Consistent Checkpoint Protocol","text":"<ol> <li>\u6682\u505c\u6240\u6709\u67e5\u8be2</li> <li>\u5c06\u6240\u6709\u7684 WAL \u8bb0\u5f55\u843d\u76d8</li> <li>\u5c06\u6240\u6709\u5728 Buffer Pool \u4e2d\u7684\u66f4\u6539\u7684\u9875\u843d\u76d8</li> <li>\u5728 WAL \u4e2d\u5199\u5165\u5e76\u843d\u76d8</li> <li>\u6062\u590d\u67e5\u8be2</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/","title":"18 Database Recovery","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#database-recovery","title":"Database Recovery","text":"<p> \u7ea6 431 \u4e2a\u5b57  28 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#aries","title":"ARIES","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#log-sequence-numbers","title":"Log Sequence Numbers","text":"<p>MasterRecord \u88ab\u786c\u7f16\u7801\u5230 DBMS\uff0c\u6240\u4ee5\u6211\u4eec\u6062\u590d\u65f6\u8fd9\u4e2a\u9875\u9762\u4f1a\u5148\u88ab\u62c9\u5230\u5185\u5b58\u4e2d</p> <p></p> <p>\u4ec5\u4ec5\u5f53 pageLSN \\&lt;= flushLSN\uff0c\u624d\u80fd\u5c06 log \u5237\u5165\u78c1\u76d8\\ \u6240\u6709\u7684\u8bb0\u5f55\u90fd\u6709\u4e00\u4e2a LSN\\ \u6bcf\u6b21\u4e00\u4e2a\u4e8b\u52a1\u4fee\u6539\u4e00\u4e2a\u9875\u4e0a\u7684 record\uff0cpageLSN \u4f1a\u6539\u53d8\\ \u6bcf\u6b21 DBMS \u5c06 WAL buffer \u4e2d\u7684\u4e1c\u897f\u5199\u5165\u78c1\u76d8\uff0cflushedLSN \u4f1a\u66f4\u65b0</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#normal-execution","title":"Normal Execution","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#transaction-commit","title":"Transaction Commit","text":"<p>\u6211\u4eec\u53ea\u9700\u8981\u4fdd\u8bc1\u5728\u5237\u65b0 flushLSN \u4e4b\u524d\u5148\u5c06\u65e5\u5fd7\u8bb0\u5f55\u5237\u65b0\u5230\u78c1\u76d8\u5373\u53ef\\ TXN-END \u5199\u5165\u540e\u8bf4\u660e commit \u5df2\u7ecf\u6210\u529f\uff0c\u6240\u4ee5 wal \u53ef\u4ee5\u6e05\u9664\u6ca1\u6709\u7528\u7684 Log</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#transaction-abort","title":"Transaction Abort","text":"<p>prevLSN \u7ef4\u62a4\u4e00\u4e2a\u94fe\u8868\u5141\u8bb8\u6211\u4eec\u8ffd\u8e2a abort \u4e8b\u52a1\u7684\u8bb0\u5f55\u94fe\u8868</p> <p></p> <p>\u6211\u4eec\u5728 abort \u548c end \u4e4b\u95f4\u53ef\u80fd\u5b58\u5728\u5176\u4ed6\u65e5\u5fd7\uff0c\u6211\u4eec\u9700\u8981\u7ef4\u62a4\u8fd9\u4e9b\u65e5\u5fd7\uff1b\u6211\u4eec\u4e0d\u4f1a\u5728 abort \u65f6\u7acb\u5373\u5c06\u8fd9\u4e9b\u8bb0\u5f55\u5237\u5199\u5230\u78c1\u76d8</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#compensation-log-records","title":"Compensation Log records","text":"<p>\u662f\u5bf9 update \u7684\u64a4\u9500\u64cd\u4f5c\\ undoNextLSN \u662f\u4e00\u4e2a\u6548\u7387\u4f18\u5316\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u6838\u5fc3\u4f18\u5316</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#abort-algorithm","title":"Abort Algorithm","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#checkpoints","title":"Checkpoints","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#non-fuzzy-checkpoints","title":"Non-Fuzzy Checkpoints","text":"<ol> <li>\u4efb\u4f55\u65b0\u4e8b\u52a1\u5f00\u59cb\u90fd\u4f1a\u88ab\u505c\u6b62</li> <li>\u6240\u6709\u6d3b\u8dc3\u7684\u4e8b\u52a1\u7b49\u5f85\u76f4\u5230 checkpoint \u6267\u884c\u5b8c\u6210</li> <li>\u5c06\u6240\u6709\u7684\u810f\u9875\u5237\u65b0\u5230\u78c1\u76d8</li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#slightly-better-checkpoints","title":"Slightly better Checkpoints","text":"<p>\u6682\u505c\u4e8b\u52a1\uff0c\u7136\u540e\u5c06\u90e8\u5206\u63d0\u4ea4\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\uff1b\\ \u7f29\u77ed\u4e86\u7b49\u5f85\u65f6\u95f4\uff0c\u4f46\u662f\u78c1\u76d8\u4e0a\u5b58\u50a8\u7684\u5e76\u975e\u662f\u7a33\u5b9a\u5feb\u7167</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#active-transaction-tableatt","title":"Active Transaction Table(ATT)","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#dirty-page-tabledpt","title":"Dirty Page Table(DPT)","text":"<p>ATT \u548c DPT \u5fc5\u987b\u5237\u8fdb\u78c1\u76d8\u540e\u518d\u6062\u590d\u4e8b\u52a1\u6267\u884c</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#fuzzy-checkpoints","title":"Fuzzy Checkpoints","text":"<p>\u590d\u5236\u4e86 ATT \u548c DPT \u7684\u526f\u672c\u5728\u5185\u5b58\u4e2d</p> <p></p> <p>\u4efb\u4f55\u5728\u4e4b\u540e\u5f00\u59cb\u7684\u4e8b\u52a1\u4f1a\u88ab\u7684 ATT \u6392\u9664</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#aries-recovery-algorithm","title":"ARIES - Recovery Algorithm","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#overview","title":"Overview","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#analysis-phase","title":"Analysis Phase","text":"<p>analysis \u7684\u8fc7\u7a0b\u4ec5\u4ec5\u662f\u786e\u5b9a ATT \u548c DPT</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#redo-phase","title":"Redo Phase","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#undo-phase","title":"Undo Phase","text":"","tags":["Database"]},{"location":"notes/CMU15445/18-Database_Recovery/#additional-crash-issues","title":"Additional Crash Issues","text":"","tags":["Database"]},{"location":"notes/CMU15445/19-Introducd_to_distributed_database/","title":"19 Introduction to distributed database","text":"2024-10-312025-12-10 <code>#Database</code> <code>#Distributed System</code>","tags":["Database","Distributed System"]},{"location":"notes/CMU15445/19-Introducd_to_distributed_database/#introduction-to-distributed-database","title":"Introduction to distributed database","text":"<p> \u7ea6 38 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p>","tags":["Database","Distributed System"]},{"location":"notes/CMU15445/3-Database%20Storage/","title":"3_Database_Storage I","text":"2023-09-112025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#3-database-storage-i","title":"3-Database Storage I","text":"<p> \u7ea6 1252 \u4e2a\u5b57  14 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#1-disk-based-architecture","title":"1 DISK-BASED ARCHITECTURE","text":"<ul> <li>\u6613\u5931\u6027\u5b58\u50a8\u548c\u975e\u6613\u5931\u6027\u5b58\u50a8\u76f8\u7ed3\u5408</li> <li>Volatile\uff1aRandom Access Byte-Addressable \uff08DRAM \u4e4b\u4e0a\uff09</li> <li>Non-Volatile\uff1aSequential Access Block-Addressable\uff08SSD \u4e4b\u4e0b \uff09</li> <li>SSD \u4ee5\u4e0b\u53ea\u80fd\u6309\u5757\u6765\u5b58\u53d6</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#_1","title":"\u987a\u5e8f\u8bbf\u95ee\u548c\u968f\u673a\u8bbf\u95ee","text":"<ul> <li>\u975e\u6613\u5931\u6027\u5b58\u50a8\u4e2d\u987a\u5e8f\u8bbf\u95ee\u6bd4\u968f\u673a\u8bbf\u95ee\u5feb\u5f97\u591a</li> <li>\u4e00\u822c\u6570\u636e\u5b58\u50a8\u5728\u8fde\u7eed\u7684\u5757\u4e2d\uff0c\u540c\u65f6\u5206\u914d\u591a\u4e2a\u7269\u7406\u9875\u53eb\u533a</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#2-dbms","title":"2 DBMS \u8bbe\u8ba1\u76ee\u6807","text":"<ul> <li>\u5141\u8bb8\u7ba1\u7406\u6bd4\u53ef\u7528\u5185\u5b58\u5927\u7684\u6570\u636e\u5e93</li> <li>\u8bfb\u5199\u78c1\u76d8\u4ee3\u4ef7\u9ad8\u6602\uff0c\u5c3d\u53ef\u80fd\u907f\u514d\u5927\u7684\u505c\u987f\u548c\u6027\u80fd\u4e0b\u964d</li> <li>DBMS \u5e0c\u671b\u6700\u5927\u5316\u987a\u5e8f\u8bfb\u5199</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#3-os","title":"3 \u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 OS","text":"<ul> <li> <p>The DBMS can use memory mapping (mmap) to store the contents of a file into the address space of a program.</p> </li> <li> <p>The OS is responsible for moving the pages of the file in and out of memory, so the DBMS doesn\u2019t need to worry about it.</p> </li> </ul> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#os","title":"\u4f7f\u7528 OS \u53ef\u80fd\u51fa\u73b0\u95ee\u9898","text":"<ul> <li>\u5982\u679c\u6b64\u65f6\u7269\u7406\u5185\u5b58\u5df2\u7ecf\u5360\u6ee1\uff0c\u9700\u8981\u6dd8\u6c70\u4e00\u4e2a\u7269\u7406\u9875\uff0c\u9020\u6210\u963b\u585e</li> <li>\u591a\u7ebf\u7a0b\u5e76\u53d1\u8bfb\u5199\u53ef\u80fd\u51fa\u73b0\u95ee\u9898</li> <li>\u9519\u8bef\u5904\u7406</li> <li>\u6027\u80fd\u95ee\u9898\uff1aOS \u7684\u7ed3\u6784\u6210\u4e3a\u6027\u80fd\u74f6\u9888</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#os_1","title":"OS \u89e3\u51b3\u65b9\u6848","text":"<ul> <li>\u6309\u6b63\u786e\u7684\u987a\u5e8f\u5c06\u810f\u9875\u5237\u65b0\u5230\u78c1\u76d8\u4e2d</li> <li>\u7279\u6b8a\u7684\u9884\u7f13\u5b58\u60c5\u51b5\uff0c\u8fd9\u6837\u6267\u884c\u5668\u5c31\u4e0d\u7528\u7b49\u5f85\u7279\u5b9a\u7684\u9875\u52a0\u8f7d\u5230\u7f13\u51b2\u6c60\u4e2d</li> <li>\u7f13\u51b2\u66ff\u6362\u7b56\u7565</li> <li>\u7ebf\u7a0b\u3001\u8fdb\u7a0b\u8c03\u5ea6</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#4-file-storage","title":"4 File Storage","text":"<ul> <li> <p>Table \u53ef\u4ee5\u770b\u4e3a\u662f tuple \u7684\u96c6\u5408\uff0c\u5728\u78c1\u76d8\u4e2d\u4e0e\u4e4b\u5bf9\u5e94\u7684\u5355\u4f4d\u662f\u6587\u4ef6\u3002\u4e00\u4e2a\u6587\u4ef6\u4e2d\u4f1a\u4fdd\u5b58\u591a\u4e2a page\uff0c\u800c page \u4e2d\u4f1a\u5b58\u50a8\u591a\u4e2a tuple\u3002</p> </li> <li> <p>DBMS \u5728\u78c1\u76d8\u4e0a\uff0c\u7528\u4e00\u4e2a\u6216\u591a\u4e2a\u6587\u4ef6\uff0c\u4ee5\u7279\u5b9a\u7684\u683c\u5f0f\u5b58\u50a8\u6570\u636e\u5e93</p> </li> <li> <p>OS \u4e0d\u5173\u5fc3\u4e5f\u4e0d\u77e5\u9053\u8fd9\u4e9b\u6587\u4ef6\u7684\u5185\u5bb9</p> </li> <li> <p>1980 \u5e74\u4ee3\u7684 \u4e00\u4e9b DBMS \u5728\u539f\u59cb\u5b58\u50a8\uff08Raw Storage\uff09\u4e0a\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u6587\u4ef6\u7cfb\u7edf</p> </li> <li> <p>\u73b0\u5728\u7684\u4e00\u4e9b\u5546\u4e1a DBMS \u8fd8\u5728\u8fd9\u4e48\u5e72</p> </li> <li>\u5927\u591a\u6570\u65b0\u51fa\u6765\u7684 DBMS \u4e0d\u8fd9\u4e48\u505a\u4e86</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#41-storage-manager","title":"4.1 storage manager","text":"<ul> <li>\u8c03\u5ea6\u8bfb\u5199\u64cd\u4f5c\u63d0\u9ad8\u7a7a\u95f4\u548c\u65f6\u95f4\u5c40\u90e8\u6027</li> <li>\u5c06\u6587\u4ef6\u7ec4\u7ec7\u6210\u9875\u7684\u96c6\u5408</li> <li>\u8ddf\u8e2a\u5df2\u7ecf\u8bfb\u548c\u5199\u7684\u9875</li> <li>\u8ddf\u8e2a\u7a7a\u95f2\u9875</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#42-database-pages","title":"4.2 Database Pages","text":"<p>\u56e0\u4e3a\u6570\u636e\u5e93\u6587\u4ef6\u53ef\u80fd\u5f88\u5927\uff0c\u9700\u8981\u5207\u5206\u6210\u591a\u4e2a\u5757</p> <ul> <li> <p>\u4e00\u9875\u662f\u5f88\u591a\u4e2a block \u7ec4\u6210\u7684\u96c6\u5408</p> </li> <li> <p>\u9875\u91cc\u53ef\u80fd\u5b58\u7740\u5143\u7ec4\u3001\u5143\u6570\u636e\u3001\u7d22\u5f15\u3001\u65e5\u5fd7\u8bb0\u5f55...</p> </li> <li>\u5927\u591a\u6570\u7cfb\u7edf\u5bf9\u4e8e\u9875\u7684\u4f7f\u7528\u90fd\u662f\u56fa\u5b9a\u7684\uff0c\u6bd4\u5982\u5b58\u50a8\u7d22\u5f15\u7684\u9875\u4e0d\u4f1a\u7528\u6765\u5b58\u6570\u636e</li> <li> <p>\u5927\u591a\u6570\u7cfb\u7edf\u9700\u8981\u9875\u662f\u81ea\u7ec4\u7ec7\uff08self-contained\uff09\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u9875\u7684 Header \u91cc\u6807\u8bc6\u4e86\u8fd9\u4e2a\u9875\u7684\u7c7b\u578b</p> </li> <li> <p>\u6bcf\u4e2a\u9875\u90fd\u6709\u4e00\u4e2a\u72ec\u7279\u7684\u6807\u8bc6\u7b26</p> </li> <li> <p>DBMS \u4f7f\u7528\u975e\u76f4\u63a5\u7684\u5c42\u6765\u628a page id \u6620\u5c04\u5230\u7269\u7406\u4f4d\u7f6e\u786c\u76d8\u9875</p> </li> <li>\u6700\u5c0f\u80fd\u4fdd\u8bc1\u539f\u5b50\u64cd\u4f5c\u7684\u5355\u4f4d</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#_2","title":"\u4e0d\u540c\u7684\u9875\u6982\u5ff5","text":"<ul> <li> <p>\u786c\u4ef6\u9875\uff08\u5982\u574f\u5757\uff09\uff1a4KB</p> </li> <li> <p>\u64cd\u4f5c\u7cfb\u7edf\u9875\uff08\u4e00\u822c\u4e3a 4kb\uff09\u64cd\u4f5c\u7cfb\u7edf\u8bfb\u5199\u786c\u76d8\u7684\u6700\u5c0f\u5355\u4f4d</p> </li> <li> <p>\u6570\u636e\u5e93\u9875\uff08512b ~ 16kb\uff09</p> </li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#43-page-storage-architecture","title":"4.3 Page Storage Architecture","text":"<ul> <li>heap file organization</li> <li>tree file organization</li> <li>sequential/sorted file organization (ISAM)</li> <li>hashing file organization</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#heap-file","title":"heap file","text":"<ul> <li>\u65e0\u5e8f\u5b58\u653e\u9875\uff0c\u5bb9\u6613\u5bfb\u627e\u5355\u4e2a\u6587\u4ef6</li> <li>\u53ef\u4ee5 create, get, write, delete \u9875</li> <li>\u5fc5\u987b\u652f\u6301\u8fed\u4ee3\u6240\u6709\u7684\u9875</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#_3","title":"\u5b9e\u73b0\u65b9\u5f0f","text":"<ul> <li> <p>page directory (\u8bbe\u7f6e\u4e00\u9875\u4e3a directory)</p> </li> <li> <p>pagedirectory \u548c data page \u8981\u540c\u6b65\u66f4\u65b0</p> </li> <li>The directory also records meta-data about available space:     \u2192 The number of free slots per page.     \u2192 List of free / empty pages</li> </ul> <p></p> <ul> <li> <p>linked list</p> </li> <li> <p>\u4e00\u4e2a header page\uff0c\u7ef4\u62a4\u4e24\u4e2a\u94fe\u8868\u5934\u8282\u70b9\uff1bfree page list, data page list</p> </li> </ul> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#44-page-layout","title":"4.4 page layout","text":"","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#page-header","title":"page header","text":"<ul> <li>page \u5185\u5bb9\u7684\u5143\u4fe1\u606f</li> <li>page size</li> <li>checknum\uff08\u9875\u7684\u6821\u9a8c\u548c\uff09</li> <li>DBMS version</li> <li>Transaction Visibility\uff08\u5e76\u53d1\u662f\u5426\u9501\u4f4f\u8be5\u9875\uff09</li> <li>Compression Information\uff08\u538b\u7f29\u4fe1\u606f\uff09</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#data-inside-of-the-page","title":"data inside of the page","text":"<ul> <li>tuple-oriented</li> <li>Log-strctured</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#1-tuple-storage-in-page","title":"1 tuple storage in page","text":"<ul> <li>Keep track of the number of tuples in a page and then just append a new tuple to the end.</li> </ul> <ul> <li>\u4e0a\u56fe\u6240\u793a\u7684\u662f\u4e00\u79cd\u6734\u7d20\u7684\u505a\u6cd5\uff0c\u7c7b\u4f3c\u6570\u7ec4\u7684\u65b9\u5f0f\u53bb\u5b58\u50a8\uff0cheader \u7ef4\u62a4\u4e00\u4e2a\u6570\u7ec4\u7684\u4fe1\u606f\u3002</li> <li>\u4e3b\u8981\u95ee\u9898\uff1a\u5220\u9664\u65f6\u4ea7\u751f\u5185\u5b58\u788e\u7247\uff0c\u6587\u4ef6\u7684\u4e0d\u8fde\u7eed\u7b49\u7b49\uff08\u5982\u679c\u662f\u53d8\u957f\u7684 tuple \u5c06\u4f1a\u6709\u66f4\u591a\u95ee\u9898\uff09\uff0ctuple \u7684\u67e5\u627e\u4e5f\u662f\u4e00\u4e2a\u5f88\u5927\u7684\u5f00\u9500</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#2-slotted-pages","title":"2 slotted pages\uff08\u9875\u69fd\uff09","text":"<ul> <li>\u5c06\u7279\u5b9a slot \u6620\u5c04\u5230 page \u67d0\u4e2a\u7279\u5b9a\u504f\u79fb\u91cf\u4e0a\u7684\u6570\u636e\u7ed3\u6784\uff0c\u8fd9\u6837\u4e00\u4e2a\u5143\u7ec4\u5c31\u662f\u7531\u4e00\u4e2a page id \u548c slot id \u6765\u552f\u4e00\u5b9a\u4f4d\uff0c\u5e76\u4e14 tuple \u662f\u5012\u5e8f\u5b58\u50a8\u7684\u3002\u8fd9\u6837\u5f53\u7136\u53ef\u80fd\u4f1a\u5728\u4e2d\u95f4\u6709\u90e8\u5206\u6570\u636e\u7684\u6d6a\u8d39\uff0c\u4f46\u662f\u4e3a\u4e86\u652f\u6301\u53d8\u957f\u7684\u5143\u7d20\u6211\u4eec\u4e0d\u5f97\u4e0d\u8fd9\u4e48\u505a\u3002\u5f53\u7136\uff0c\u6709\u529e\u6cd5\u53bb\u5e94\u5bf9\uff0c\u53ef\u4ee5\u53bb\u6574\u7406\u6216\u8005\u538b\u7f29</li> <li>header keeps track of</li> <li>used slots</li> <li>the offset of the starting location of the last slot used</li> </ul> <ul> <li>\u6bcf\u4e2a tuple \u9700\u8981\u4e00\u4e2a\u72ec\u4e00\u65e0\u4e8c\u7684\u8bb0\u5f55\u53f7\uff1apage_id + offset/slot</li> <li>\u7528\u6237\u4e0d\u80fd\u4f7f\u7528 record ID \u6765\u4f7f\u7528</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#45-tuple-layout","title":"4.5 tuple layout","text":"<ul> <li>tuple \u662f\u78c1\u76d8\u4e0a\u7684\u4e8c\u8fdb\u5236\u6d41\u6570\u636e</li> </ul> <ul> <li>header contaions meta-data about tuple</li> <li>visibility info (concurrency control)</li> <li>Bit Map for NULL values</li> <li>\u5b58\u50a8\u6570\u636e\u65e0\u5206\u9694\u7b26\uff0c\u9700\u8981\u8bb0\u5f55 NULL \u4fe1\u606f</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/3-Database%20Storage/#denormalized-tuple-data","title":"denormalized tuple data","text":"<ul> <li>\u7269\u7406\u5b58\u50a8\u4e0a\u53cd\u89c4\u8303\u5316\uff0c\u5c06\u6709\u5173\u8054\u7684\u5143\u7ec4\u5b58\u50a8\u5728\u540c\u4e00\u9875\u4e0a\uff1b\u76f8\u5f53\u4e8e\u63d0\u524d\u5c06\u8868\u5173\u8054 join</li> <li>\u51cf\u5c11 IO \u6570\u91cf</li> <li>\u66f4\u65b0\u7684\u4ee3\u4ef7\u5de8\u5927</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/","title":"4_Database_Storage II","text":"2023-09-152025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#4-database-storage-ii","title":"4 Database Storage II","text":"<p> \u7ea6 1072 \u4e2a\u5b57  17 \u884c\u4ee3\u7801  13 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> <ul> <li>\u6570\u636e\u5e93\u8d1f\u8d23\u5c06\u975e\u6613\u5931\u6027\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u548c\u5185\u5b58\u8fdb\u884c\u4ea4\u4e92</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#41-problem-with-slotted-page-design","title":"4.1 problem with slotted page design","text":"<ul> <li>Fragmentation (\u788e\u7247)</li> <li>Useless Disk I/O</li> <li>Random Disk I/O (update 20 tuples on 20 pages)</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#42-log-structed-storage","title":"4.2 Log-structed storage","text":"<p>\u66f4\u591a\u4f7f\u7528 KV \u6570\u636e\u5e93\u4e0a\uff0c\u53ea\u6709\u4e00\u4e2a\u952e\u4e00\u4e2a\u503c</p> <ul> <li> <p>\u4e0d\u5b58\u6570\u636e\uff0c\u5b58\u653e\u6570\u636e\u7684\u64cd\u4f5c\uff08insert, delete, update\uff09</p> </li> <li> <p>\u76f4\u63a5\u5728\u540e\u9762\u52a0\u4e0a\u65b0\u64cd\u4f5c\uff0c\u4e0d\u68c0\u67e5\u524d\u9762\u7684\u6240\u6709\u64cd\u4f5c\u662f\u5426\u6b63\u786e</p> </li> </ul> <p></p> <ul> <li>\u8bfb\u53d6\u4e00\u4e2a\u8bb0\u5f55\uff0c\u4ece\u540e\u5411\u524d\u8fdb\u884c\u626b\u63cf\u8bb0\u5f55\uff1b\u627e\u5230\u9700\u8981\u7684\u6570\u636e</li> </ul> <p></p> <ul> <li>\u8003\u8651\u5bf9\u76f8\u540c id \u7684 log record \u8fdb\u884c\u7d22\u5f15</li> </ul> <p></p> <ul> <li>\u56e0\u4e3a Log \u6570\u636e\u4f1a\u975e\u5e38\u5927\uff0c\u9700\u8981\u5468\u671f\u6027\u5bf9\u9875\u5185\u8fdb\u884c\u538b\u7f29</li> </ul> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#log-structured-compaction","title":"Log-Structured Compaction","text":"<ul> <li> <p>Level Compaction</p> </li> <li> <p>\u5c06\u4e0d\u540c\u7684\u5757\u4e2d\u8bb0\u5f55\u8fde\u63a5\u8d77\u6765\uff0c\u5c06\u538b\u7f29\u540e\u7684\u7ed3\u679c\u5b58\u5165\u4e0b\u4e00\u5c42</p> </li> <li>\u4ece level0 \u5f00\u59cb\u5411\u4e0b\u8bfb\uff0c\u4e00\u76f4\u5230\u6700\u540e\u4e00\u5c42</li> </ul> <p></p> <ul> <li> <p>Universal Compaction</p> </li> <li> <p>\u5c3d\u53ef\u80fd\u5c06\u5468\u8fb9\u7684\u5757\u5408\u5e76\uff1b\u5728\u540c\u4e00\u5c42</p> </li> </ul> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#_1","title":"\u4f18\u52bf","text":"<ul> <li>\u5c06\u968f\u673a\u5199\u53d8\u6210\u987a\u5e8f\u5199\uff0cIO \u6548\u7387\u9ad8\uff0c\u4f46\u662f\u67e5\u627e\u4ee3\u4ef7\u5f88\u9ad8</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#add-log-structured-merge-tree","title":"add: Log-Structured Merge Tree","text":"<ul> <li>\u9996\u5148\u662f\u5185\u5b58\u7684 C0 \u5c42\uff0c\u4fdd\u5b58\u4e86\u6240\u6709\u6700\u8fd1\u5199\u5165\u7684 \uff08k\uff0cv\uff09\uff0c\u8fd9\u4e2a\u5185\u5b58\u7ed3\u6784\u662f\u6709\u5e8f\u7684\uff0c\u5e76\u4e14\u53ef\u4ee5\u968f\u65f6\u539f\u5730\u66f4\u65b0\uff0c\u540c\u65f6\u652f\u6301\u968f\u65f6\u67e5\u8be2\u3002\u5269\u4e0b\u7684 C1 \u5230 Ck \u5c42\u90fd\u5728\u78c1\u76d8\u4e0a\uff0c\u6bcf\u4e00\u5c42\u90fd\u662f\u4e00\u4e2a\u5728 key \u4e0a\u6709\u5e8f\u7684\u7ed3\u6784\u3002</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#_2","title":"\u5199\u5165\u6d41\u7a0b","text":"<ul> <li> <p>\u9996\u5148\u5c06\u5199\u5165\u64cd\u4f5c\u52a0\u5230\u5199\u524d\u65e5\u5fd7\u4e2d\uff0c\u63a5\u4e0b\u6765\u628a\u6570\u636e\u5199\u5230 memtable \u4e2d\uff0c\u5f53 memtable \u6ee1\u4e86\uff0c\u5c31\u5c06\u8fd9\u4e2a memtable \u5207\u6362\u4e3a\u4e0d\u53ef\u66f4\u6539\u7684 immutable memtable\uff0c\u5e76\u65b0\u5f00\u4e00\u4e2a memtable \u63a5\u6536\u65b0\u7684\u5199\u5165\u8bf7\u6c42\u3002\u800c\u8fd9\u4e2a immutable memtable \u5c31\u53ef\u4ee5\u5237\u78c1\u76d8\u4e86\u3002\u8fd9\u91cc\u5237\u78c1\u76d8\u662f\u76f4\u63a5\u5237\u6210 L0 \u5c42\u7684 SSTable \u6587\u4ef6\uff0c\u5e76\u4e0d\u76f4\u63a5\u8ddf L0 \u5c42\u7684\u6587\u4ef6\u5408\u5e76\u3002</p> </li> <li> <p>\u6bcf\u4e00\u5c42\u7684\u6240\u6709\u6587\u4ef6\u603b\u5927\u5c0f\u662f\u6709\u9650\u5236\u7684\uff0c\u6bcf\u4e0b\u4e00\u5c42\u5927\u5341\u500d\u3002\u4e00\u65e6\u67d0\u4e00\u5c42\u7684\u603b\u5927\u5c0f\u8d85\u8fc7\u9608\u503c\u4e86\uff0c\u5c31\u9009\u62e9\u4e00\u4e2a\u6587\u4ef6\u548c\u4e0b\u4e00\u5c42\u7684\u6587\u4ef6\u5408\u5e76\u3002\u5c31\u50cf\u73a9 2048 \u4e00\u6837\uff0c\u6bcf\u6b21\u80fd\u89e6\u53d1\u5408\u5e76\u90fd\u4f1a\u89e6\u53d1\uff0c\u8fd9\u5728 2048 \u91cc\u662f\u6700\u723d\u7684\uff0c\u4f46\u662f\u5728\u7cfb\u7edf\u91cc\u662f\u633a\u9ebb\u70e6\u7684\u4e8b\uff0c\u56e0\u4e3a\u9700\u8981\u5012\u817e\u7684\u6570\u636e\u591a\uff0c\u4f46\u662f\u4e5f\u4e0d\u662f\u574f\u4e8b\uff0c\u56e0\u4e3a\u8fd9\u6837\u53ef\u4ee5\u52a0\u901f\u67e5\u8be2\u3002</p> </li> <li> <p>\u8fd9\u91cc\u6ce8\u610f\uff0c\u6240\u6709\u4e0b\u4e00\u5c42\u88ab\u5f71\u54cd\u5230\u7684\u6587\u4ef6\u90fd\u4f1a\u53c2\u4e0e Compaction\u3002\u5408\u5e76\u4e4b\u540e\uff0c\u4fdd\u8bc1 L1 \u5230 L6 \u5c42\u7684\u6bcf\u4e00\u5c42\u7684\u6570\u636e\u90fd\u662f\u5728 key \u4e0a\u5168\u5c40\u6709\u5e8f\u7684\u3002\u800c L0 \u5c42\u662f\u53ef\u4ee5\u6709\u91cd\u53e0\u7684\u3002</p> </li> </ul> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#_3","title":"\u67e5\u8be2\u6d41\u7a0b","text":"<ul> <li> <p>\u5148\u67e5 memtable\uff0c\u518d\u67e5 immutable memtable\uff0c\u7136\u540e\u67e5 L0 \u5c42\u7684\u6240\u6709\u6587\u4ef6\uff0c\u6700\u540e\u4e00\u5c42\u4e00\u5c42\u5f80\u4e0b\u67e5\u3002</p> </li> <li> <p>\u4e3a\u4e86\u52a0\u901f\u67e5\u8be2\uff0c\u56e0\u4e3a\u6bcf\u4e2a key \u5728\u6bcf\u5c42\u81f3\u591a\u51fa\u73b0\u4e00\u6b21\uff1b\u6240\u4ee5\u67e5\u8be2\u53ef\u4ee5\u4f7f\u7528\u5e03\u9686\u8fc7\u6ee4\u5668\u8fdb\u884c\u4f18\u5316</p> </li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#43-data-representation","title":"4.3 Data Representation","text":"<ul> <li>\u6d6e\u70b9\u6570\u7684\u7cbe\u786e\u503c\u6709\u95ee\u9898</li> <li>\u6570\u636e\u5e93\u4e2d\u5b58\u50a8\u6570\u636e\uff0c\u5c06\u6570\u636e\u7684\u503c\u53d8\u6210\u5b57\u7b26\u4e32\u6765\u5b58\uff0c\u4fdd\u8bc1\u7cbe\u5ea6</li> </ul> C<pre><code>// POSTGRES\ntypedef unsigned char NumericDigit;\ntypedef struct {\n    int ndigits;            // \u6570\u636e\u4f4d\u6570\n    int weight;             // \u6743\u91cd\n    int scale;              // \u6307\u6570\n    int sign;\n    NumericDigit *digits;\n}numeric;\n\n// MYSQL\ntypedef int32 decimal_digit_t;\nstruct decimal_t {\n  int intg, frac, len;  // \u5c0f\u6570\u70b9\u524d\u4f4d\u6570\uff0c\u5c0f\u6570\u70b9\u540e\u7684\u4f4d\u6570\uff0c\u603b\u4f4d\u6570\n  bool sign;\n  decimal_digit_t *buf;\n};\n</code></pre>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#large-values","title":"Large Values","text":"<ul> <li>\u5b58\u50a8\u7684\u503c\u8fc7\u5927\uff0c\u4f7f\u7528 overflow page\uff0c\u539f\u6765\u5b58\u653e\u503c\u7684\u4f4d\u7f6e\u5b58\u653e\u6307\u5411\u8be5\u9875\u7684\u6307\u9488</li> <li>\u6ea2\u51fa\u9875\u53ef\u4ee5\u7ee7\u7eed\u6307\u5411\u6ea2\u51fa\u9875\uff0c\u6210\u4e3a\u94fe\u8868</li> </ul> <ul> <li>\u5b58\u50a8\u5916\u90e8\u6587\u4ef6\u7684\u6307\u9488\uff1b\u4f46\u662f\u65e0\u6cd5\u4fdd\u8bc1\u5916\u90e8\u6587\u4ef6\u662f\u5426\u88ab\u4fee\u6539</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#system-catalogs","title":"System Catalogs","text":"<p>DBMS \u628a\u6570\u636e\u5e93\u5143\u6570\u636e\u5b58\u653e\u5728 internal catalog \u4e2d\uff1b\u6570\u636e\u5e93\u5c06\u5176\u5b58\u4e3a\u8868\uff0c\u81ea\u5df1\u7ba1\u7406\u81ea\u5df1\u7684\u5143\u6570\u636e</p> <ul> <li>tables, colums, indexs, views</li> <li>users, permissions</li> <li>internal statistics</li> </ul> <p>\u6bd4\u5982<code>information_schema</code>\u5b58\u653e\u6570\u636e\u5e93\u5143\u6570\u636e\uff1b\u5c06\u5143\u6570\u636e\u5b58\u653e\u6210\u8868</p>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#database-workloads","title":"Database workloads","text":"<ul> <li> <p>On-Line Transaction Processing (OLTP)</p> </li> <li> <p>\u5feb\u901f\u8bfb\u5199\u5c0f\u6570\u636e</p> </li> <li> <p>On-Line Analytical Processing (OLAP)</p> </li> <li> <p>\u590d\u6742\u67e5\u8be2\uff0c\u5bf9\u6570\u636e\u8fdb\u884c\u5206\u6790</p> </li> <li> <p>Hybrid (\u6df7\u5408) Transaction + Analytical Processing</p> </li> <li> <p>OLTP + OLAP</p> </li> <li> <p>OLTP \u6536\u96c6\u6570\u636e\uff0c\u63d0\u53d6\u540e\u8fdb\u884c\u6570\u636e\u53d8\u6362\u548c\u52a0\u8f7d\uff1b\u5b58\u5165 OLAP\uff0cOLAP \u8fdb\u884c\u5206\u6790\u540e\u53ef\u4ee5\u5199\u56de OLTP</p> </li> </ul> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#44-decompositon-storage-model","title":"4.4 Decompositon Storage Model (\u5217\u5b58\u50a8)","text":"<ul> <li> <p>N-ary Storage Model (\u884c\u5b58\u50a8)\uff1b\u5bf9\u5c0f\u6570\u636e\u66f4\u65b0\u548c\u67e5\u8be2\u5341\u5206\u6709\u6548\uff0c\u6548\u7387\u5f88\u9ad8</p> </li> <li> <p>\u590d\u6742\u67e5\u8be2\u5927\u91cf\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u5217\u5b58\u50a8\uff1b\u5982\u679c\u4f7f\u7528\u884c\u5b58\u50a8\uff0c\u9700\u8981\u626b\u63cf\u6240\u6709\u6570\u636e\uff0c\u4ec5\u4ec5\u53d6\u51fa\u67d0\u51e0\u4e2a\u5c5e\u6027\uff1b\u6d6a\u8d39\u5927\u91cf\u65f6\u95f4\u8fdb\u884c\u626b\u63cf\uff1b</p> </li> <li> <p>\u5217\u5b58\u50a8\u66f4\u9002\u5408\u5206\u6790\u6570\u636e\u7684\u60c5\u51b5</p> </li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/4-Database_Storage_II/#tuple-edentification","title":"tuple edentification","text":"<ul> <li>Fixed-length Offsets\uff1a\u76f8\u540c\u7684\u504f\u79fb\u5373\u5b58\u7684\u662f\u540c\u4e00\u884c\u7684\u5c5e\u6027</li> <li>Embedded Tuple Ids\uff1a\u589e\u52a0\u7d22\u5f15\uff1b\u9020\u6210\u5b58\u50a8\u7684\u5f00\u9500\uff0c\u4f46\u662f\u65b9\u4fbf\u5b58\u50a8</li> </ul> <p>OLTP = \u884c\u5b58\u50a8</p> <p>OLAP = \u5217\u5b58\u50a8</p>","tags":["Database"]},{"location":"notes/CMU15445/5-Buffer%20Pool/","title":"5-Buffer Pool","text":"2025-12-022025-12-10 <p>title: 5_Database_Storage created: 2023-09-16</p> <ul> <li>Database</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#5-buffer-pool","title":"5 Buffer Pool","text":"<p> \u7ea6 1331 \u4e2a\u5b57  11 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> <ul> <li>\u5728\u78c1\u76d8\u4e2d\u5c06\u6587\u4ef6\u5207\u6210\u4e00\u4e2a\u4e2a\u9875</li> <li>\u5728\u5185\u5b58\u4e2d\u5f00\u8f9f\u4e00\u4e2a\u7f13\u5b58\u6c60\uff1b\u52a0\u5feb\u5bf9\u9875\u7684\u8bbf\u95ee</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#51-buffer-pool","title":"5.1 Buffer Pool","text":""},{"location":"notes/CMU15445/5-Buffer%20Pool/#organization","title":"Organization","text":"<ul> <li> <p>\u662f\u4e00\u4e2a\u6709\u7740\u56fa\u5b9a\u9875\u6570\u7684\u6570\u7ec4\uff1b\u6bcf\u4e2a\u6570\u7ec4\u5143\u7d20\u53eb frame (\u5e27)</p> </li> <li> <p>\u901a\u8fc7 page table \u53bb\u7d22\u5f15\u5185\u5b58\u6c60\u4e2d\u7684\u9875</p> </li> <li> <p>page table \u53ef\u4ee5 pin \u67d0\u4e2a\u9875\uff0c\u4e5f\u53ef\u4ee5\u9501\u4f4f\u67d0\u4e2a\u7d22\u5f15</p> </li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#mete-data","title":"Mete-Data","text":"<ul> <li> <p>\u9875\u8868\u8ddf\u8e2a\u73b0\u5728\u5728\u5185\u5b58\u4e2d\u7684\u9875</p> </li> <li> <p>Dirty flag</p> </li> <li> <p>Pin/Reference Counter</p> </li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#locks-vs-latches","title":"locks vs latches","text":"<ul> <li>locks</li> <li>\u4fdd\u62a4\u4e8b\u52a1\u4e2d\u7684\u5185\u5bb9</li> <li>\u5728\u4e8b\u52a1\u671f\u95f4\u6301\u6709\u9501</li> <li>\u9700\u8981\u56de\u6eda</li> <li>latches</li> <li>\u4fdd\u62a4\u4e34\u754c\u533a\u6570\u636e\u7ed3\u6784</li> <li>\u5728\u64cd\u4f5c\u671f\u95f4\u6301\u6709\u9501</li> <li>\u4e0d\u5fc5\u56de\u6eda\u6539\u53d8</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#page-dictionary-vs-page-table","title":"page dictionary vs. page table","text":"<ul> <li>page dic</li> <li>\u5728\u78c1\u76d8\u4e2d\uff0c\u6807\u8bb0\u6bcf\u4e2a\u9875\u5728\u90a3\u4e2a\u6587\u4ef6\u4e2d</li> <li>page table</li> <li>\u5728\u5185\u5b58\u4e2d\uff0c\u6807\u8bb0\u9875\u5728 Buffer Pool \u7684\u4ec0\u4e48\u4f4d\u7f6e</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#52-allocation-policies","title":"5.2 Allocation Policies","text":"<ul> <li>\u5168\u5c40\uff1a\u540c\u4e00\u5b89\u6392\u7a7a\u95f4</li> <li>\u5c40\u90e8\uff1a\u4e3a\u67d0\u4e2a\u7ebf\u7a0b\u5206\u914d\u5e27\u4e0d\u8003\u8651\u5e76\u53d1\u7684\u5176\u4ed6\u7ebf\u7a0b</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#53-buffer-pool-optimizations","title":"5.3 Buffer Pool Optimizations","text":""},{"location":"notes/CMU15445/5-Buffer%20Pool/#multiple-buffer-pools","title":"Multiple Buffer Pools","text":"<ul> <li> <p>DBMS \u4f7f\u7528\u591a\u4e2a buffer pool\uff0c\u6bcf\u79cd Buffer pool \u53ef\u4ee5\u9488\u5bf9\u4e0d\u540c\u76ee\u7684</p> </li> <li> <p>Two approaches to mapping desired pages to a buffer pool are object IDs and hashing</p> </li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#pre-fetching","title":"Pre-fetching","text":"<ul> <li>\u5728\u6570\u636e\u6267\u884c\u8ba1\u5212\u65f6\u8fdb\u884c\u9884\u53d6</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#_1","title":"\u987a\u5e8f\u9884\u53d6","text":""},{"location":"notes/CMU15445/5-Buffer%20Pool/#scan-sharing","title":"Scan-Sharing","text":"<ul> <li> <p>If a query wants to scan a table and another query is already doing this, then the DBMS will attach the second query's cursor to the existing cursor.</p> </li> <li> <p>\u5982\u679c\u7b2c\u4e8c\u4e2a\u67e5\u8be2\u4e0e\u7b2c\u4e00\u4e2a\u67e5\u8be2\u7684\u8868\u76f8\u540c\uff0c\u5148\u8ddf\u7740\u7b2c\u4e00\u4e2a\u67e5\u8be2\u4e00\u8d77\u67e5\u8be2\uff1b\u6700\u540e\u67e5\u8be2\u8fd8\u672a\u67e5\u8be2\u7684 page</p> </li> </ul> <p></p> <p></p> <p></p>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#buffer-pool-bypass","title":"Buffer Pool Bypass","text":"<ul> <li>\u5728\u4e00\u4e9b\u7279\u6b8a\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u80fd\u5e76\u4e0d\u9700\u8981 Buffer Pool\uff0c\u4f8b\u5982\u987a\u5e8f\u626b\u63cf\u78c1\u76d8 page\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u52a0\u8f7d\u7684\u78c1\u76d8 page \u7684\u5206\u5e03\u662f\u8fde\u7eed\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u52a0\u8f7d\u78c1\u76d8\u6570\u636e\uff0c\u56e0\u4e3a\u662f\u987a\u5e8f IO\uff0c\u6027\u80fd\u4ecd\u7136\u80fd\u591f\u4e0d\u9519\uff0c\u5e76\u4e14\u7701\u53bb\u4e86 Buffer Pool \u6362\u5165\u6362\u51fa\u7684\u5f00\u9500\u3002</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#buffer-pool","title":"Buffer Pool \u6dd8\u6c70\u7b56\u7565","text":"<ul> <li>LRU</li> <li>CLOCK</li> <li>LRU-K</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#lru-k","title":"LRU-K \u7b97\u6cd5","text":"<ul> <li>\u6700\u8fd1 K \u6b21\u8bbf\u95ee\u6700\u5c11\uff1b\u6570\u636e\u5728\u8bbf\u95ee\u5386\u53f2\u5217\u8868\u91cc\u540e\u6ca1\u6709\u8fbe\u5230 K \u6b21\u8bbf\u95ee\uff0c\u5219\u6309\u7167\u4e00\u5b9a\u89c4\u5219\uff08FIFO\uff0cLRU\uff09\u6dd8\u6c70\uff1b\u5386\u53f2\u961f\u5217\u4e2d\u7684\u6570\u636e\u8bbf\u95ee\u6b21\u6570\u8fbe\u5230 K \u6b21\u540e\uff0c\u5c06\u6570\u636e\u7d22\u5f15\u4ece\u5386\u53f2\u961f\u5217\u5220\u9664\uff0c\u5c06\u6570\u636e\u79fb\u5230\u7f13\u5b58\u961f\u5217\u4e2d\uff0c\u5e76\u7f13\u5b58\u6b64\u6570\u636e\uff0c\u7f13\u5b58\u961f\u5217\u91cd\u65b0\u6309\u7167\u65f6\u95f4\u6392\u5e8f\uff1b\u6dd8\u6c70\u7f13\u5b58\u961f\u5217\u672b\u5c3e\u7684\u5143\u7d20</li> <li>LRU-K \u9700\u8981\u591a\u7ef4\u62a4\u4e00\u4e2a\u961f\u5217\uff0c\u7528\u4e8e\u8bb0\u5f55\u6240\u6709\u7f13\u5b58\u6570\u636e\u88ab\u8bbf\u95ee\u7684\u5386\u53f2\u3002\u53ea\u6709\u5f53\u6570\u636e\u7684\u8bbf\u95ee\u6b21\u6570\u8fbe\u5230 K \u6b21\u7684\u65f6\u5019\uff0c\u624d\u5c06\u6570\u636e\u653e\u5165\u7f13\u5b58</li> <li>\u4f7f\u7528 List \u8fdb\u884c\u6570\u636e\u5220\u9664\u65f6\uff0c\u4f7f\u7528 erase \u9700\u8981 list \u7684\u8fed\u4ee3\u5668\uff1b\u540c\u65f6\u9700\u8981\u4e00\u4e2a map \u8fdb\u884c\u8fed\u4ee3\u5668\u7684\u5b58\u50a8</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#54-buffer-replacement-policies","title":"5.4 Buffer Replacement Policies","text":"<p>\u76ee\u6807\uff1a\u6b63\u786e\u3001\u51c6\u786e\u3001\u5feb\u901f\u3001\u66f4\u65b0\u5143\u6570\u636e</p>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#least-recently-used","title":"Least-recently Used","text":"<ul> <li>\u4fdd\u5b58\u6bcf\u4e2a\u9875\u6700\u8fd1\u8bbf\u95ee\u7684\u65f6\u95f4\u6233</li> <li>\u67e5\u8be2\u6d2a\u6cdb\u95ee\u9898</li> <li>\u70ed\u70b9\u9875\u591a\u6b21\u88ab\u6362\u5165\u6362\u51fa</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#clock","title":"Clock","text":"<ul> <li>\u6a21\u7cca\u7684 LRU \u4e0d\u9700\u8981\u6bcf\u4e2a\u9875\u6709\u65f6\u95f4\u6233</li> <li>\u6bcf\u4e2a\u9875\u6709\u4e00\u4e2a\u5f15\u7528\u4f4d</li> <li>\u5f53\u4e00\u4e2a\u9875\u88ab\u8bbf\u95ee\u4e86\uff0c\u5f15\u7528\u4f4d\u7f6e\u4e3a 1</li> <li>\u626b\u63cf\u6574\u4e2a\u7f13\u5b58\u6c60\uff1b\u5982\u679c ref bit = 1\uff0c\u7f6e\u4e3a 0\uff1b\u5982\u679c ref bit = 0\uff0c\u76f4\u63a5\u9a71\u9010</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#better-polices-lru-k","title":"Better polices: LRU-K","text":"<ul> <li>LRU \u548c CLOCK \u65b9\u6cd5\u4ec5\u4ec5\u53ea\u8003\u8651\u4e86\u8bbf\u95ee\u65f6\u95f4\u800c\u6ca1\u6709\u8003\u8651\u8bbf\u95ee\u9891\u7387\uff0c\u6613\u53d7\u5230\u987a\u5e8f\u6d2a\u6cdb\u7684\u5f71\u54cd</li> <li>\u6700\u8fd1 K \u6b21\u8bbf\u95ee\u6700\u5c11\uff1b\u6570\u636e\u5728\u8bbf\u95ee\u5386\u53f2\u5217\u8868\u91cc\u540e\u6ca1\u6709\u8fbe\u5230 K \u6b21\u8bbf\u95ee\uff0c\u5219\u6309\u7167\u4e00\u5b9a\u89c4\u5219\uff08FIFO\uff0cLRU\uff09\u6dd8\u6c70\uff1b\u5386\u53f2\u961f\u5217\u4e2d\u7684\u6570\u636e\u8bbf\u95ee\u6b21\u6570\u8fbe\u5230 K \u6b21\u540e\uff0c\u5c06\u6570\u636e\u7d22\u5f15\u4ece\u5386\u53f2\u961f\u5217\u5220\u9664\uff0c\u5c06\u6570\u636e\u79fb\u5230\u7f13\u5b58\u961f\u5217\u4e2d\uff0c\u5e76\u7f13\u5b58\u6b64\u6570\u636e\uff0c\u7f13\u5b58\u961f\u5217\u91cd\u65b0\u6309\u7167\u65f6\u95f4\u6392\u5e8f\uff1b\u6dd8\u6c70\u7f13\u5b58\u961f\u5217\u672b\u5c3e\u7684\u5143\u7d20</li> <li>LRU-K \u9700\u8981\u591a\u7ef4\u62a4\u4e00\u4e2a\u961f\u5217\uff0c\u7528\u4e8e\u8bb0\u5f55\u6240\u6709\u7f13\u5b58\u6570\u636e\u88ab\u8bbf\u95ee\u7684\u5386\u53f2\u3002\u53ea\u6709\u5f53\u6570\u636e\u7684\u8bbf\u95ee\u6b21\u6570\u8fbe\u5230 K \u6b21\u7684\u65f6\u5019\uff0c\u624d\u5c06\u6570\u636e\u653e\u5165\u7f13\u5b58</li> <li>\u4f7f\u7528 List \u8fdb\u884c\u6570\u636e\u5220\u9664\u65f6\uff0c\u4f7f\u7528 erase \u9700\u8981 list \u7684\u8fed\u4ee3\u5668\uff1b\u540c\u65f6\u9700\u8981\u4e00\u4e2a map \u8fdb\u884c\u8fed\u4ee3\u5668\u7684\u5b58\u50a8</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#mysql-lru-k","title":"mysql \u7684 LRU-K \u7684\u66ff\u4ee3\u65b9\u5f0f","text":"<ul> <li>\u4ece\u672a\u51fa\u73b0\u8fc7\u7684 Page \u653e\u5165 old list \u7684 HEAD\uff0c\u5df2\u7ecf\u51fa\u73b0\u5728 Old list \u7684 page \u518d\u6b21\u8bbf\u95ee\uff0c\u653e\u5165 young list \u7684 HEAD </li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#better-polices-localization","title":"Better polices: Localization","text":"<ul> <li>\u53ea\u9a71\u9010\u81ea\u5df1\u4f7f\u7528\u7684\u9875\uff0c\u5982\u679c\u522b\u4eba\u4e5f\u4f7f\u7528\u8be5\u9875\uff0c\u4e0d\u4f1a\u9a71\u9010</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#better-polices-priority-hints","title":"Better polices: Priority Hints","text":"<p>\u5728 LRU \u57fa\u7840\u4e0a\u8fdb\u884c\u7684\u4f18\u5316</p> <ul> <li>\u5728\u67e5\u8be2\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u4e86\u89e3\u6bcf\u4e2a\u9875\u7684\u5185\u5bb9</li> <li>\u63d0\u4f9b hint \u53bb\u5224\u65ad\u5185\u5b58\u6c60\u4e2d\u9875\u662f\u5426\u91cd\u8981</li> <li>\u73b0\u4ee3\u6570\u636e\u5e93\u4e00\u822c\u542f\u52a8\u65f6\u5c06\u6839\u7ed3\u70b9\u52a0\u5165\u5185\u5b58\u6c60</li> </ul> <p></p>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#55-dirty-pages","title":"5.5 Dirty pages","text":"<ul> <li>Fast Path\uff1a\u5982\u679c page \u975e dirty\uff0c\u76f4\u63a5\u9a71\u9010</li> <li>Slow Path\uff1a\u5982\u679c page \u662f dirty\uff0c\u5fc5\u987b\u5148\u5c06\u810f\u9875\u56de\u5199\u5230\u78c1\u76d8</li> <li>WAL\uff1a\u5148\u5199\u65e5\u5fd7\u5230\u78c1\u76d8\uff0c\u518d\u5c06\u810f\u9875\u5199\u5165\u78c1\u76d8\uff08\u4f7f\u7528 dirty flag\uff09</li> </ul>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#background-writing","title":"Background Writing","text":"<p>DBMS \u5b9a\u671f\u5c06\u810f\u9875\u56de\u5199\u5230\u78c1\u76d8</p> <p>\u5982\u679c\u810f\u9875\u5df2\u7ecf\u5b89\u5168\u88ab\u5199\u5165\uff0cDBMS \u4f1a\u9a71\u9010\u8be5\u9875\u6216\u8005 unset dirty flag</p> <p>\u5728\u65e5\u5fd7\u6ca1\u6709\u843d\u76d8\u524d\uff0c\u4e0d\u5e94\u8be5\u5199\u5165\u810f\u9875\u4e2d\u7684\u4efb\u4f55\u6570\u636e</p>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#56-disk-io-scheduling","title":"5.6 DISK I/O SCHEDULING","text":"<p>OS/hardware \u901a\u8fc7\u91cd\u6392\u548c\u5bf9 IO \u8fdb\u884c\u6279\u91cf\u64cd\u4f5c\u6765\u5206\u644a\u5199\u5165\u7684\u6210\u672c</p> <p>\u4f46\u662f OS \u4e0d\u786e\u5b9a\u54ea\u4e2a IO \u662f\u66f4\u91cd\u8981\u7684\uff1b\u6211\u4eec\u9700\u8981\u629b\u5f03 OS \u7684\u6570\u636e\u5199\u5165\u63a7\u5236\u800c\u7531 DBMS \u6765\u63a5\u7ba1</p> <p></p>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#os-page-cache","title":"OS PAGE CACHE","text":"<p>\u6b63\u5e38\u7684 IO \u64cd\u4f5c\u4f1a\u7ecf\u8fc7 OS PAGE CACHE\uff0c\u4f46\u662f DBMS \u5e0c\u671b\u76f4\u63a5\u5bf9 IO \u8fdb\u884c\u63a7\u5236\uff0c\u6240\u4ee5\u91c7\u7528 direct I/O\uff0c\u7ed5\u8fc7 OS page cache</p> <p></p>"},{"location":"notes/CMU15445/5-Buffer%20Pool/#fsync-problems","title":"fsync problems","text":""},{"location":"notes/CMU15445/6-Hash%20Table/","title":"6_Hash_Table","text":"2023-09-212025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#6-hash-table","title":"6 Hash Table","text":"<p> \u7ea6 1066 \u4e2a\u5b57  12 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> <p>\u4f7f\u7528\u8303\u56f4</p> <ul> <li>Internal Meta-data</li> <li>Core Data Storage</li> <li>Temporary Data Structures (join \u8054\u8868\u67e5\u8be2)</li> <li>Table Indexes</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#61-design-decisions","title":"6.1 Design Decisions","text":"<ul> <li>Data Organization</li> <li>Concurrency</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#unrealistic-assumptions","title":"unrealistic assumptions","text":"<ul> <li> <p>Hash Function</p> </li> <li> <p>\u8ba1\u7b97\u901f\u5ea6\u548c\u78b0\u649e\u7387\u7684\u53d6\u820d</p> </li> <li> <p>Hashing Scheme</p> </li> <li> <p>\u9759\u6001\u54c8\u5e0c\u8868</p> </li> <li>\u53ef\u6269\u5c55\u54c8\u5e0c\u8868</li> </ul>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#62-hash-functions","title":"6.2 hash functions","text":"","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#63-static-hashing-schemes","title":"6.3 static Hashing Schemes","text":"","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#linear-probe-hashing","title":"Linear probe hashing (\u7ebf\u6027\u63a2\u6d4b\u54c8\u5e0c)","text":"<p>\u5982\u679c\u78b0\u649e\uff0c\u5b58\u653e\u5230\u4e0b\u4e00\u4e2a\u7a7a\u95f2\u7684\u69fd\uff1b\u53ef\u80fd\u51fa\u73b0\u539f\u6765\u5b58\u5728\u51b2\u7a81\u7684\u503c\u88ab\u5220\u9664</p> <p>Tombstone (\u5893\u7891)\uff1a\u6807\u8bb0\u8be5\u4f4d\u7f6e\u6709\u503c\u88ab\u5220\u9664</p> <p>Movement\uff1a\u5c06\u7a7a\u69fd\u4e4b\u540e\u7684\u6570\u636e\u8fdb\u884c\u6574\u7406</p> <p>\u91cd\u590d\u7684\u952e\u95ee\u9898</p> <p>Separate Linked List\uff1a\u628a\u6bcf\u4e2a\u952e\u5bf9\u5e94\u7684\u952e\u503c\u5b58\u5728\u7279\u6b8a\u7ed3\u6784\u4e2d\uff0chash \u8868\u4e2d\u5b58\u653e\u6307\u5411\u8be5\u7ed3\u6784\u7684\u6307\u9488</p> <p>Redundant Keys\uff1a\u5c06\u952e\u503c\u4e00\u8d77\u4f5c\u4e3a\u952e\uff0c\u5b58\u653e\u5728\u54c8\u5e0c\u8868\u4e2d</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#optimization","title":"optimization","text":"<ul> <li> <p>\u6309\u7167\u7c7b\u578b\u548c\u5927\u5c0f\u5bf9\u54c8\u5e0c\u8868\u8fdb\u884c\u7279\u4f8b\u5316\u5b9e\u73b0</p> </li> <li> <p>\u4f7f\u7528 hash table \u5b58\u50a8\u5143\u6570\u636e</p> </li> <li> <p>\u4f7f\u7528 table+slot+version \u6765\u5feb\u901f\u5bf9 hash table \u4e2d\u7684\u6240\u6709\u6761\u76ee\u8fdb\u884c Invalid</p> </li> </ul> <p>\u5982\u679c table \u7684 version \u4e0e slot \u7684 version \u4e0d\u5339\u914d\uff0c\u5c06\u8be5 slot \u4f5c\u4e3a\u7a7a slot \u5904\u7406</p>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#robin-hood-hashing","title":"Robin Hood hashing","text":"<p>\u57fa\u4e8e\u5f00\u653e\u5730\u5740\u54c8\u5e0c\u7684\u6539\u8fdb\u7248,\u57fa\u672c\u601d\u8def\u662f\"\u52ab\u5bcc\u6d4e\u8d2b\", \u8bb0\u5f55\u6bcf\u4e2a\u5143\u7d20\u7684\u504f\u79fb\u91cf. \u6bcf\u6b21\u6bd4\u8f83\u662f\u6bd4\u8f83\u6bcf\u4e2a key \u8ddd\u79bb\u81ea\u5df1\u539f\u672c\u4f4d\u7f6e\u7684\u8ddd\u79bb(\u8d8a\u8fd1\u8d8a\u5bcc\u88d5), \u5982\u679c\u9047\u5230\u4e00\u4e2a\u5df2\u7ecf\u88ab\u5360\u7528\u7684 slot \u4e14\u5b83\u6bd4\u81ea\u5df1\u5bcc\u88d5, \u5c31\u4ee3\u66ff\u5b83\u7684\u4f4d\u7f6e, \u7136\u540e\u628a\u5b83\u987a\u5ef6\u5230\u65b0\u7684\u4f4d\u7f6e</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#cuckoo-hashing","title":"Cuckoo hashing\uff08\u5e03\u8c37\u9e1f\u54c8\u5e0c\uff09","text":"<p>linear hash \u662f\u987a\u5e8f IO \u800c cukoo hash \u662f\u968f\u673a IO</p> <p>\u5efa\u7acb\u591a\u4e2a\u6563\u5217\u8868, \u4f7f\u7528\u4e0d\u540c\u7684\u54c8\u5e0c\u51fd\u6570. \u5728\u63d2\u5165\u65f6\uff0c\u68c0\u67e5\u6bcf\u4e2a\u8868\u5e76\u9009\u62e9\u4efb\u4f55\u6709\u7a7a\u95f2\u63d2\u69fd\u7684\u8868\u3002\u5982\u679c\u6ca1\u6709\u8868\u6709\u7a7a\u95f2\u63d2\u69fd\uff0c\u5219\u4ece\u5176\u4e2d\u4e00\u4e2a\u4e2d\u5220\u9664\u8be5\u5143\u7d20\uff0c\u7136\u540e\u91cd\u65b0\u6563\u5217\u5b83\u4ee5\u627e\u5230\u65b0\u4f4d\u7f6e\u3002</p> <p>\u9632\u6b62\u65e0\u9650\u5faa\u73af: \u5faa\u73af\u8d77\u6765\u65f6\u7528\u65b0\u7684\u6563\u5217\u51fd\u6570\u91cd\u5efa\u6574\u4e2a\u6563\u5217\u8868</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#_1","title":"\u9759\u6001\u54c8\u5e0c\u7ed3\u6784\u7f3a\u9677","text":"<p>\u8981\u6c42\u4f7f\u7528\u8005\u80fd\u591f\u9884\u5224\u6240\u5b58\u6570\u636e\u7684\u603b\u91cf\uff0c\u5426\u5219\u6bcf\u6b21\u6570\u91cf\u8d85\u8fc7\u8303\u56f4\u65f6\u90fd\u9700\u8981\u91cd\u5efa Hash Table\u3002</p> <p>\u52a8\u6001\u54c8\u5e0c\u7ed3\u6784\u5c31\u53ef\u4ee5 resize themselves on demand.</p>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#dynamic-hash-table","title":"Dynamic Hash Table","text":"<p>\u652f\u6301\u52a8\u6001\u6309\u9700\u6269\u5bb9\u7f29\u5bb9</p>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#chained-hashing","title":"Chained Hashing","text":"<p>\u6bcf\u4e2a key \u5bf9\u5e94\u4e00\u4e2a\u94fe\u8868, \u6bcf\u4e2a\u8282\u70b9\u662f\u4e00\u4e2a bucket(\u53ef\u4ee5\u5b58\u50a8\u591a\u4e2a\u5143\u7d20).bucket \u6ee1\u4e86\u5c31\u5728\u540e\u9762\u518d\u6302\u4e00\u4e2a bucket</p> <p>\u8981\u5904\u7406\u5e76\u53d1\u6027: \u5728\u6876\u4e0a\u8bbe\u7f6e\u4e00\u4e2a latch</p> <p></p> <p>Java \u4e2d\u7684\u5b9e\u73b0\u5219\u662f\u505a\u4e86\u7b80\u5316, \u6bcf\u4e2a bucket \u76f8\u5f53\u4e8e\u53ea\u5b58\u653e\u4e00\u4e2a\u5143\u7d20. \u95ee\u9898\u5728\u4e8e\u5143\u7d20\u5f88\u591a\u4e8b\u94fe\u8868\u4f1a\u5f88\u957f, \u6240\u4ee5\u8fdb\u884c\u7684\u4f18\u5316(\u538b\u7f29\u6210\u7ea2\u9ed1\u6811)</p> <p>\u53ef\u4ee5\u5728 bucket pointers \u4e2d\u52a0\u5165 bloom filter \u6765\u52a0\u5feb\u67e5\u627e\u65f6\u7684\u901f\u5ea6</p> <p>\u5982\u679c\u4e0d\u5b58\u5728\uff0cBloom filter \u4f1a\u8fd4\u56de false\uff0c\u4e0d\u5fc5\u7ee7\u7eed\u8fdb\u884c\u987a\u5e8f\u67e5\u627e</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#extendible-hashing","title":"Extendible Hashing","text":"<p>\u57fa\u672c\u601d\u8def\u662f\u4e00\u8fb9\u6269\u5bb9\uff0c\u4e00\u8fb9 rehash.</p> <p>\u54c8\u5e0c\u51fd\u6570\u5f97\u5230\u4e8c\u8fdb\u5236, \u6839\u636e\u5168\u5c40\u6807\u5fd7\u4f4d\u51b3\u5b9a\u770b hash \u503c\u7684\u4e8c\u8fdb\u5236\u524d\u51e0\u4f4d, \u6839\u636e\u8fd9\u4e2a\u4f4d\u6570\u53bb\u51b3\u5b9a\u6254\u5230\u54ea\u4e2a\u6876\u91cc;</p> <p></p> <p>PS: \u8fd9\u91cc\u7684\u6876\u4ee3\u8868\u7b2c\u4e00\u4f4d\u662f 0, \u524d\u4e24\u4f4d\u662f 10, 11...</p> <p>\u4e00\u65e6\u6876\u6ee1\u4e86\u5c31\u8ba9\u5168\u5c40\u6807\u5fd7\u4f4d++, \u7136\u540e\u5404\u4e2a\u6876\u518d rehash(\u6876\u7684\u6570\u91cf\u8981\u53d8\u591a)</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/6-Hash%20Table/#linear-hashing","title":"Linear Hashing","text":"<p>\u7ef4\u62a4\u4e00\u4e2a split \u6307\u9488\uff0c\u6307\u5411\u4e0b\u4e00\u4e2a\u5c06\u88ab\u62c6\u5206\u7684 bucket\uff0c\u521d\u59cb split \u6307\u9488\u6307\u5411 0 \u53f7\u6876</p> <p>\u6bcf\u5f53\u4efb\u610f\u4e00\u4e2a bucket \u6ea2\u51fa\uff08\u6807\u51c6\u81ea\u5b9a\uff0c\u5982\u5229\u7528\u7387\u5230\u8fbe\u9608\u503c\u7b49\uff09\u65f6\uff0c\u5c06\u6307\u9488\u6307\u5411\u7684 bucket \u62c6\u5206\u3002</p> <p>\u62c6\u5206\u540e\u4f7f\u7528\u65b0\u7684 hash function \u5bf9 split \u6307\u5411\u7684\u5143\u7d20\u8fdb\u884c rehash\uff1b\u6bcf\u6b21\u6ea2\u51fa\u589e\u52a0\u4e00\u4e2a bucket pointer</p> <p>\u8fdb\u884c\u67e5\u627e\u65f6\uff0c\u5982\u679c\u67e5\u627e\u7684\u5143\u7d20\u5728 split pointer \u4e0b\u9762\uff0c\u4f7f\u7528\u539f\u59cb\u7684 hash function\uff0c\u5426\u5219\u4f7f\u7528\u65b0\u7684 hash function</p> <p></p> <p>\u73b0\u5728 17 \u5e94\u8be5\u88ab\u63d2\u5165\u7b2c\u4e8c\u4e2a\u6876, \u4f46\u662f\u5df2\u7ecf\u6ee1\u4e86,\u53c8\u4e0d\u60f3\u6302\u65b0\u7684\u6876. \u90a3\u4e48\u5bf9\u6307\u9488\u6307\u5411\u7684\u6876(0 \u53f7)\u8fdb\u884c\u5206\u88c2, \u5bf9\u5206\u5272\u70b9\u6307\u5411\u7684\u6876\u6240\u5305\u542b\u7684 key \u91c7\u7528\u65b0\u7684 hash \u51fd\u6570\u8fdb\u884c\u5206\u5272(\u539f\u6765\u662f a % n, \u6539\u6210 a % 2n). 17 \u4e5f\u653e\u5728\u65b0\u7684\u6876\u91cc</p> <p>\u4e4b\u524d\u6240\u6709\u7684\"\u586b\u6ee1\"\u4e0d\u4e00\u5b9a\u662f\u5b8c\u5168\u6ee1, \u53ef\u4ee5\u662f\u6bd4\u5982\u5230\u4e86 75%\u4e4b\u7c7b\u7684...</p> <p>\u5f53\u65b0\u589e\u52a0\u7684\u6876\u4e2d\u6ca1\u6709\u5143\u7d20\uff0c\u6211\u4eec\u53ef\u4ee5\u9009\u62e9\u538b\u7f29/\u5408\u5e76\u6876\uff0c\u51cf\u5c0f\u5b58\u50a8\u7684\u7a7a\u95f4</p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/","title":"7_B+Tree Indexes","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#7-btree-indexes","title":"7-B+Tree Indexes","text":"<p> \u7ea6 1255 \u4e2a\u5b57  25 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#71-b-tree-family","title":"7.1 B-Tree Family","text":"","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#71-tree-indexes","title":"7.1 Tree Indexes","text":"<p>DBMS \u5728\u6267\u884c\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u66f4\u591a\u662f\u67e5\u8be2\u7d22\u5f15\u800c\u4e0d\u662f\u67e5\u8be2\u6570\u636e\u5e93\u4e2d\u7684\u8868 \u7d22\u5f15\u95ee\u9898</p> <p>\u5b58\u50a8\u5f00\u9500</p> <p>\u7ef4\u62a4\u7d22\u5f15\u5f00\u9500</p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#72-b-tree","title":"7.2 B+ Tree","text":"<p>\u662f\u4e00\u4e2a\u81ea\u5e73\u8861\u6811\u3002\u8fd9\u662f\u4e00\u79cd\u63d2\u5165\u3001\u5220\u9664\u5747\u4e3a O(log n)\u7684\u6570\u636e\u7ed3\u6784\u3002\u53ef\u4ee5\u652f\u6301\u7ebf\u6027\u904d\u5386\uff08\u54c8\u5e0c\u8868\u4e0d\u80fd\u505a\u5230\uff09</p> <p>\u76f8\u6bd4 Hash Table\uff0c\u6700\u597d\u7684\u6027\u80fd\u662f O(1)\uff0c\u6700\u5dee\u65f6\u9000\u5316\u5230 O(n)\u3002\u56e0\u4e3a\u5e73\u8861\uff0c\u6240\u4ee5\u4efb\u610f\u4e00\u4e2a\u53f6\u5b50\u7ed3\u70b9\u5230\u6839\u7ed3\u70b9\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5747\u4e3a O(log n)</p> <p>\u5bf9\u4e8e\u8bfb\u5199\u78c1\u76d8\u4e0a\u6574\u9875\u6570\u636e\u5177\u6709\u5176\u4ed6\u6570\u636e\u7ed3\u6784\u4e0d\u5177\u5907\u7684\u4f18\u52bf</p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#721-b-tree-properties","title":"7.2.1 B+ Tree Properties","text":"<p>\\(M\\)\u9636\u641c\u7d22\u6811</p> <ul> <li> \\[ \\\\frac{M}{2} - 1 \\\\le keys \\\\le M - 1\\] </li> <li>\u6bcf\u4e2a\u4e2d\u95f4\u7ed3\u70b9\uff0c\\(k\\)\u4e2a\u5173\u952e\u5b57\u6709\\(k+1\\)\u4e2a\u975e\u7a7a\u5b69\u5b50</li> <li>\u53f6\u5b50\u7ed3\u70b9\u5b58\u653e\u5173\u952e\u5b57\u548c\u6570\u636e</li> </ul> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#node","title":"Node","text":"<p>key \u7ee7\u627f\u81ea\u7d22\u5f15\u4f9d\u8d56\u7684\u5c5e\u6027</p> <p>value</p> <p>inner node \u4e2d value \u662f\u4e0b\u4e00\u4e2a\u8282\u70b9\u7684\u6307\u9488\uff1bleaf node \u4e2d\u662f\u5b58\u653e\u6570\u636e\u7684\u5730\u5740\u6216\u8005\u6570\u636e\u672c\u8eab</p> <p>\u6240\u6709\u7684 NULL \u503c\u8981\u4e48\u5b58\u653e\u5728 first leaf node\uff0c\u8981\u4e48\u662f last leaf node</p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#leaf-node","title":"Leaf Node","text":"<p>\u5e38\u89c1\u7684\u53f6\u5b50\u7ed3\u70b9\u5177\u4f53\u5b9e\u73b0\u5982\u56fe\u6240\u793a\uff1a</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#b-tree-vs-btree","title":"B-Tree VS. B+Tree","text":"<p>\u5c06 key \u6570\u7ec4\u548c values \u5206\u5f00\u4fdd\u5b58\u800c\u4e0d\u662f\u653e\u5728\u4e00\u8d77\u4fdd\u5b58\uff0c\u662f\u56e0\u4e3a\u67e5\u8be2\u65f6\u5e38\u9700\u8981\u626b\u63cf\u5927\u91cf key\uff0ckey \u7684\u957f\u5ea6\u56fa\u5b9a\uff0c\u6709\u52a9\u4e8e CPU cache hit\uff1b</p> <p>\u67e5\u8be2\u65f6\u53ea\u9700\u8981\u626b\u63cf key\uff0c\u5c31\u4e0d\u7528\u5728\u7f13\u5b58\u91cc\u8bfb\u53d6 value \u7684\u4fe1\u606f\u3002\u5f53\u67e5\u8be2\u5230\u5177\u4f53\u7684 key \u65f6\uff0c\u901a\u8fc7 offset \u80fd\u591f\u76f4\u63a5\u627e\u5230 values \u6570\u7ec4\u4e2d\u7684\u503c\u3002</p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#leaf-node-value","title":"leaf node value","text":"<ol> <li>Record IDs <p>\u5b58\u653e tuple \u7684\u6307\u9488</p> </li> <li>Tuple Data <p>\u76f4\u63a5\u5b58\u653e tuple \u7684\u5185\u5bb9</p> </li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#b-insert-delete","title":"B+\u6811 Insert / Delete","text":"","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#insert","title":"Insert","text":"","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#delete","title":"Delete","text":"","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#722-b-tree-selection-conditions","title":"7.2.2 B+ Tree Selection conditions","text":"<p>\u53ea\u6709\u5c11\u6570\u7cfb\u7edf\u652f\u6301\u524d\u7f00\u67e5\u627e\u53ca\u540e\u7f00\u67e5\u627e</p> <p>\\(Find \\\\ Key=(A,B), Find \\\\ Key=(A, *)\\)\uff1b\u5f88\u591a\u6570\u636e\u5e93\u4e0d\u652f\u6301\u5339\u914d\\(Find \\\\ Key=(*, B)\\)\uff1b\u8be5\u67e5\u8be2\u53ef\u80fd\u9700\u8981\u904d\u5386\u6574\u5f20\u8868</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#723-duplicate-keys","title":"7.2.3 Duplicate Keys","text":"<ol> <li> <p>append recordID: \u8054\u5408\u4e3b\u952e\uff08\\\uff09</p> </li> <li> <p>overflow leaf nodes: \u5916\u63a5\u4e00\u4e2a\u6ea2\u51fa(overflow)\u53f6\u5b50\u7ed3\u70b9\uff1b\u5c06\u91cd\u590d\u7684\u952e\u653e\u7f6e\u5728\u6ea2\u51fa\u53f6\u5b50\u7ed3\u70b9\u4e0a </p> </li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#724-clustered-indexs","title":"7.2.4 clustered indexs","text":"<ul> <li>\u6570\u636e\u6309\u7167\u4e3b\u952e\u7d22\u5f15\u6765\u7ec4\u7ec7</li> <li>\u7d22\u5f15\u4e0e\u6587\u4ef6\u4e00\u4e00\u5bf9\u5e94\uff0c\u5bf9\u4e8e\u7ebf\u6027\u904d\u5386\u6709\u597d\u5904</li> </ul> <p>\u975e\u805a\u7c07\u7d22\u5f15\uff0c\u904d\u5386\u53ef\u4ee5\u4f18\u5316</p> <p>\u626b\u63cf\u53f6\u8282\u70b9\u4e0d\u7acb\u5373\u68c0\u7d22\u5143\u7ec4\uff0c\u800c\u662f\u627e\u5230\u5b83\u4eec\u540e\u518d\u8fdb\u884c\u68c0\u7d22</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#725-node-size","title":"7.2.5 Node size","text":"<p>\u6162\u901f\u8bbe\u5907 B+\u6811\u7ed3\u70b9\u5e94\u8be5\u8bbe\u8ba1\u7684\u8d8a\u5927\uff0c\u4e00\u6b21 IO \u8bfb\u56de\u7684\u6570\u636e\u8d8a\u591a</p> <p>\u9ad8\u901f\u8bbe\u5907 SSD \u6216 Main memory \u5e94\u8be5\u8bbe\u8ba1\u7684\u66f4\u5c0f\uff0c\u4e0d\u9700\u8981\u592a\u591a\u7684\u5197\u4f59\u6570\u636e</p> <p>\u7ed3\u70b9\u7684\u5927\u5c0f\u4e5f\u53d6\u51b3\u4e8e\u8d1f\u8f7d</p> <p>AP \u578b\u6570\u636e\u5e93\uff1aLeaf Node Scans \u5927\u8282\u70b9</p> <p>TP \u578b\u6570\u636e\u5e93\uff1aRoot-to-Leaf Traversals (\u70b9\u67e5\u8be2) \u5c0f\u8282\u70b9</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#726-merge-threshold","title":"7.2.6 Merge Threshold","text":"<p>\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u9608\u503c\u6765\u5ef6\u540e\u5206\u5272/\u5408\u5e76\u64cd\u4f5c </p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#726-variable-length-keys","title":"7.2.6 Variable-length Keys","text":"<ol> <li>\u5b58\u653e Key \u7684\u6307\u9488 <p>\u5927\u91cf\u975e\u987a\u5e8f IO \u64cd\u4f5c\uff0c\u67e5\u627e\u6210\u672c\u592a\u9ad8</p> </li> <li>\u4f7f\u7528\u53d8\u957f\u7ed3\u70b9</li> <li>Padding</li> <li>Key Map / Indirection <p>\u5728\u7ed3\u70b9\u5185\u90e8\u4f7f\u7528\u6307\u9488\u6765\u5bf9\u5e94 KV</p> </li> </ol> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#727-intra-node-search","title":"7.2.7 Intra-Node Search","text":"<ol> <li>Linear\uff1a\u4ece\u5f00\u59cb\u5230\u7ed3\u5c3e\u7ebf\u6027\u641c\u7d22\uff1b\u4f7f\u7528 SIMD \u8fdb\u884c\u5411\u91cf\u5316\u6bd4\u8f83 </li> <li>Binary\uff1a\u4e8c\u5206\u67e5\u627e</li> <li>Interpolation\uff1a\u63a8\u65ad\u9700\u8981\u67e5\u627e\u5173\u952e\u5b57\u7684\u4f4d\u7f6e(\u5355\u8c03\u9012\u589e\u4e14\u65e0\u95f4\u9699) </li> </ol>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#728-optimization","title":"7.2.8 Optimization","text":"<p>Prefix compression</p> <p>\u524d\u7f00\u538b\u7f29\u2014\u2014\u5b58\u653e\u5728\u76f8\u540c\u53f6\u5b50\u7ed3\u70b9\u4e2d\u7684\u6570\u636e\u5e94\u8be5\u5177\u6709\u76f8\u540c\u7684\u524d\u7f00</p> <p></p> <p>Deduplication</p> <p>\u5c06\u5197\u4f59\u7684\u952e\u538b\u7f29</p> <p></p> <p>suffix truncation</p> <p>\u540e\u7f00\u622a\u65ad</p> <p></p> <p>\u5f53\u7528\u4e8e\u786e\u8ba4\u65b9\u5411\u7684\u8def\u6807\u5f88\u957f\uff0c\u4f46\u662f\u8fe5\u7136\u4e0d\u540c\u65f6\uff0c\u4e5f\u6ca1\u6709\u5fc5\u8981\u5b58\u5b8c\u6574\u7684 key\uff0cabcdefg...\u5b58\u50a8\u4e3a abc\uff0clmnopq...\u5b58\u50a8\u4e3a lmn \u5373\u53ef\u3002\u8fd9\u79cd\u65b9\u5f0f\u5728\u6811\u4e0d\u4f1a\u7ecf\u5e38\u6539\u53d8\u65f6\u5f88\u6709\u7528\uff0c\u603b\u4f53\u4e0a\u7528\u7684\u6bd4\u524d\u7f00\u538b\u7f29\u8981\u5c11\u3002 </p> <p>bulk insert</p> <p>\u6279\u91cf\u63d2\u5165</p> <p>\u5f53\u63d0\u524d\u77e5\u9053\u9700\u8981\u63d2\u5165\u7684\u6240\u6709 key \u65f6\uff0c\u53ef\u4ee5\u9884\u5148\u5bf9 key \u4eec\u6392\u5e8f\uff0c\u7136\u540e\u81ea\u4e0b\u800c\u4e0a\u5730\u6784\u5efa\u6574\u9897\u6811\u3002\u8fd9\u5f88\u5feb\u3002</p> <p></p> <p>pointer swizzling</p> <p>\u5b58\u653e\u9875\u6307\u9488\u800c\u4e0d\u662f\u9875\u53f7</p> <p></p> <p>\u5f53\u786e\u4fdd\u9700\u8981\u904d\u5386\u7684\u7ed3\u70b9\u6240\u5728\u7684 page \u90fd\u88ab pin \u5728 buffer pool \u4e2d\u65f6\uff0c\u7ed3\u70b9\u95f4\u6307\u9488\u5c31\u4e0d\u7528\u518d(\u4ec5)\u5b58 page id\uff0c\u800c\u662f\u53ef\u4ee5\u76f4\u63a5(\u989d\u5916)\u5b58\u539f\u59cb\u6307\u9488\uff0c\u904d\u5386\u8fd9\u4e9b node \u65f6\u5c31\u80fd\u907f\u514d\u53bb\u8bbf\u95ee buffer pool \u7684\u65f6\u5ef6\u3002</p> <p>\u8fd9\u4e2a\u6280\u672f (Pointer swizzling - Wikipedia) \u7684\u672c\u610f\u662f\u7531\u4e8e\u6301\u4e45\u5316\u4fdd\u5b58(\u94fe\u8868\u7b49\u6570\u636e\u7ed3\u6784\u7684)\u6307\u9488\u903b\u8f91\u5730\u5740\u6ca1\u6709\u610f\u4e49\uff0c\u56e0\u4e3a\u628a\u903b\u8f91\u5730\u5740\u5199\u5230\u78c1\u76d8\u91cc\uff0c\u4f46\u662f\u518d\u8bfb\u51fa\u6765\u7684\u65f6\u5019\u903b\u8f91\u5730\u5740\u5c31\u4ec0\u4e48\u4e5f\u4e0d\u662f\u4e86\uff0c\u6240\u4ee5\u4fdd\u5b58\u4e0b\u4e00\u4e2a node \u7684 id \u800c\u4e0d\u662f\u5730\u5740\u503c\u5145\u5f53\u6307\u9488\u7684\u4f5c\u7528\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u53eb unswizzling\u3002\u5728\u6570\u636e\u5e93\u4e2d\u53cd\u5176\u9053\u800c\u884c\u4e4b\uff0c\u5982\u679c DBMS \u786e\u4fdd\u90fd\u4f1a\u5728\u5185\u5b58\u91cc\u64cd\u4f5c\uff0c\u5c31\u53ef\u4ee5\u4e13\u95e8\u5b58\u5730\u5740\u7684\u539f\u59cb\u503c\u800c\u4e0d\u662f page id</p> <p>\u56e0\u4e3a\u6811\u7684\u9ad8\u5c42\u7ed3\u70b9\u4f7f\u7528\u9891\u7387\u975e\u5e38\u9ad8\uff0c\u5b83\u4eec pin \u5728 buffer pool \u91cc\u662f\u5e38\u89c1\u7684\u4e8b\u60c5\uff0c\u8fd9\u4e2a\u6280\u672f\u4f7f\u7528\u573a\u666f\u6bd4\u8f83\u591a\u3002</p>","tags":["Database"]},{"location":"notes/CMU15445/7-B%2BTree/#729-write-optimized-btree","title":"7.2.9 Write-Optimized B+Tree","text":"<p>\u5728\u5230\u8fbe\u53f6\u5b50\u8282\u70b9\u4e4b\u524d\uff0c\u6811\u7684\u7ed3\u6784\u4e0d\u53d1\u751f\u4efb\u4f55\u6539\u53d8</p> <p>\u65e5\u5fd7\u66f4\u6539\u662f\u589e\u91cf\u7ea7\u8054\u6539\u53d8</p> <p> </p>","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/","title":"8_Index Concurrency","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#8-index-concurrency","title":"8-Index Concurrency","text":"<p> \u7ea6 438 \u4e2a\u5b57  4 \u884c\u4ee3\u7801  14 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#80-concurrency-control","title":"8.0 Concurrency control","text":"","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#81-latch","title":"8.1 Latch","text":"","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#810-locks-vs-latches","title":"8.1.0 LOCKS VS. LATCHES","text":"","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#811-latch-modes","title":"8.1.1 Latch Modes","text":"","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#812-latch-implementations","title":"8.1.2 Latch implementations","text":"<p>Test-and-Set Spin Latch (TAS)\uff1b\u6bd4\u5982 std::atomic</p> <p>\u6709\u6548\uff0c\u4e0d\u80fd\u652f\u6301\u5927\u89c4\u6a21\u5e76\u53d1\uff1b\u5bf9\u7f13\u5b58\u4e0d\u53cb\u597d\uff1b\u5bf9 OS \u4e0d\u53cb\u597d</p> <p>CPU \u7a7a\u8f6c\uff0c\u56e0\u4e3a NUMA \u4e4b\u95f4\u7684\u901a\u4fe1\uff0c\u4f1a\u589e\u52a0\u786c\u4ef6\u901a\u4fe1\u6d41\u91cf\u6210\u672c</p> C++<pre><code>std::atomic_flag latch;\nwhile(latch.test_and_set(...){\n  // Retry? Yield? Abort?\n})\n</code></pre> <p></p> <p>Blocking OS Mutex\uff1a\u963b\u585e\u5f0f\u5b9e\u73b0\uff1b\u4e0d\u80fd\u5927\u89c4\u6a21\u5e76\u53d1\uff1bstd::mutex</p> <p>OS \u652f\u6301\uff0c\u7ade\u4e89\u7ebf\u7a0b\u8fdb\u5165\u5185\u6838\u6001\u7c7b\u4f3c sleep</p> <p>\u6d89\u53ca\u5230 OS \u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u53ef\u80fd\u4f1a\u62d6\u6162\u6574\u4e2a\u7cfb\u7edf\u7684\u901f\u5ea6</p> <p></p> <p>Reader-Writer Latches</p> <p>\u5141\u8bb8\u5e76\u53d1\u8bfb</p> <p>\u4f9d\u636e spin latches \u5b9e\u73b0</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#82-hash-table-latching","title":"8.2 Hash table latching","text":"<ul> <li>\u5bf9\u4e00\u4e2a\u54c8\u5e0c\u7ed3\u6784\u52a0\u9501</li> <li>\u5bf9\u4e00\u4e2a\u54c8\u5e0c\u69fd\u8fdb\u884c\u52a0\u9501</li> </ul> <p>Compare-and-swap (CAS)</p> <p>\u539f\u5b50\u64cd\u4f5c\uff0c\u5bf9\u53d8\u91cf\u5730\u5740\u4e2d\u7684\u503c\u8fdb\u884c\u6539\u53d8</p>","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#83-b-tree-concurrency-control","title":"8.3 B+ Tree Concurrency Control","text":"","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#latch-crabbingcoupling","title":"latch crabbing/coupling","text":"<p>\u91ca\u653e Latch \u65f6\uff0c\u6211\u4eec\u5e0c\u671b\u5c3d\u53ef\u80fd\u5c06\u963b\u585e\u66f4\u591a\u7ebf\u7a0b\u7684 latch \u91ca\u653e\uff0c\u6240\u4ee5\u6211\u4eec\u603b\u662f\u81ea\u9876\u5411\u4e0b\u91ca\u653e latch</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#better-latching-algorithm","title":"Better Latching Algorithm","text":"<p>\u662f\u4e50\u89c2\u673a\u5236\uff1b\u5728 split \u548c merge \u53d1\u751f\u60c5\u51b5\u8f83\u5c11\u4e0b\u6548\u679c\u66f4\u597d\u3002</p> <p>\u5148\u91c7\u7528\u4e00\u8def\u8bfb\u9501\u5230\u53f6\u5b50\u8282\u70b9\u7684\u4e0a\u4e00\u4e2a\u8282\u70b9\uff0c\u5982\u679c\u51fa\u73b0 split \u6216 merge\uff0c\u91cd\u65b0\u4ece\u5934\u5f00\u59cb\u8fdb\u884c\u60b2\u89c2\u9501\u52a0\u9501</p> <p></p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/8-Index%20Concurrency/#multithread","title":"multithread \u5e76\u53d1\u51b2\u7a81","text":"<p>\u6216\u8005\u6211\u4eec\u53ef\u4ee5\u6309\u7167\u540c\u4e00\u79cd\u987a\u5e8f\u52a0\u9501\uff0c\u6c38\u8fdc\u4ece\u5de6\u5411\u53f3\u52a0\u9501</p> <p>T2 \u4e0d\u77e5\u9053 T1 \u53d1\u751f\u4e86\u4ec0\u4e48\uff0c\u786e\u5b9a T1 \u7684\u5b8c\u6210\u65f6\u95f4\u5e76\u7b49\u5f85\u662f\u4e0d\u73b0\u5b9e\u7684\uff1b\u5b9e\u73b0\u7ebf\u7a0b\u95f4\u901a\u4fe1\u4e5f\u662f\u6210\u672c\u5f88\u9ad8\u7684\uff1b\u6700\u4f73\u9009\u62e9\u662f\u7ec8\u6b62\u81ea\u5df1\u7684\u4e8b\u52a1\u5e76\u91cd\u65b0\u5f00\u59cb</p> <p></p> <p>\u8fd9\u79cd\u7ade\u6001\u6761\u4ef6\u51fa\u73b0\u8f83\u4e3a\u7f55\u89c1\uff1b\u800c\u4e14\u9884\u9632\u8be5\u79cd\u7ade\u6001\u6761\u4ef6\u6210\u672c\u9ad8\u6602\uff0c\u4e00\u822c\u65b9\u5f0f\u91c7\u7528\u53cc\u65b9\u4e8b\u52a1\u90fd\u76f4\u63a5\u7ec8\u6b62\u5e76\u91cd\u542f</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/","title":"9-Sort && Aggregation Algorithm","text":"2024-10-312025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#9-sort-aggregation-algorithm","title":"9-Sort &amp;&amp; Aggregation Algorithm","text":"<p> \u7ea6 445 \u4e2a\u5b57  17 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#90-query-plan","title":"9.0 Query Plan","text":"<p>\u64cd\u4f5c\u7b26\u53ef\u4ee5\u5904\u7406\u6bd4\u5185\u5b58\u66f4\u591a\u7684\u6570\u636e</p> <p>\u5c3d\u53ef\u80fd\u9ad8\u6548\u5730\u5229\u7528 buffer pool</p> <p>\u8bbf\u95ee\u78c1\u76d8\u7528\u5c3d\u53ef\u80fd\u591a\u7684\u987a\u5e8f IO</p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#91-sort","title":"9.1 Sort","text":"","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#911-why-do-we-need-to-sort","title":"9.1.1 Why do we need to sort","text":"<p>\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u57fa\u4e8e\u54c8\u5e0c\u7684\u65b9\u5f0f\u6bd4\u57fa\u4e8e\u6392\u5e8f\u7684\u65b9\u5f0f\u66f4\u4f18\uff1b\u4f46\u662f\u5bf9\u4e8e\u9884\u5148\u6392\u5e8f\u7684\u6570\u636e\u57fa\u4e8e\u6392\u5e8f\u7684\u65b9\u5f0f\u53ef\u80fd\u66f4\u4f18</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#912-in-memory-sorting","title":"9.1.2 IN-MEMORY SORTING","text":"","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#913-top-n-heap-sort","title":"9.1.3 TOP-N HEAP SORT","text":"<p>\u5982\u679c\u51fa\u73b0\u76f8\u7b49\u7684\u503c\uff0c\u5c31\u6269\u5c55\u5806\u6570\u7ec4\u7684\u5927\u5c0f</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#914-external-merge-sort","title":"9.1.4 EXTERNAL MERGE SORT","text":"","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#sorted-run","title":"sorted run","text":"<p>\u884c\u5b58\u50a8\u4e00\u822c\u91c7\u53d6\u65e9\u671f\u7269\u5316\uff0c\u5217\u5b58\u50a8\u9009\u62e9\u5ef6\u8fdf\u7269\u5316\uff0c\u5148\u5b58\u50a8 record ID </p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#2-way-external-merge-sort","title":"2-way external merge sort","text":"<p>\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u5220\u9664\u6392\u5e8f\u524d\u7684\u6e90\u6587\u4ef6\u6765\u6e05\u7406\u78c1\u76d8\u7a7a\u95f4</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#general-external-merge-sort","title":"general external merge sort","text":"","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#915-double-buffering","title":"9.1.5 Double Buffering","text":"<p>general external merge \u5728\u540c\u4e00\u65f6\u523b\uff0cCPU \u548c\u78c1\u76d8\u603b\u6709\u4e00\u4e2a\u4f1a\u7a7a\u95f2\uff0c\u6240\u4ee5 Double buffering \u5c06 Buffer pool \u4e2d\u7684\u7a7a\u95f2\u5e27\u5206\u4e3a\u4e24\u90e8\u5206(buffer and shadow buffer)\uff0c\u53ef\u4ee5\u63d0\u9ad8\u5e76\u884c\u5ea6</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#916-comparison-optimizations","title":"9.1.6 Comparison Optimizations","text":"<p>\u6bd4\u8f83\u5b57\u7b26\u4e32\u53ef\u4ee5\u4f7f\u7528\u524d\u7f00\u5b57\u7b26\u4e32\u7f16\u7801\u6bd4\u8f83\uff1b\u4ec5\u5f53\u524d\u7f00\u5b57\u7b26\u4e32\u7f16\u7801\u76f8\u7b49\u624d\u8fdb\u884c\u5b8c\u6574\u5b57\u7b26\u4e32\u7684\u6bd4\u8f83</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#917-using-btree-for-sorting","title":"9.1.7 using B+tree for sorting","text":"<p>\u5982\u679c\u6392\u5e8f\u7684 Key \u4e0a\u6709\u805a\u7c07 B+Tree\uff0c\u4f7f\u7528\u5b83\u6765\u6392\u5e8f\uff1b\u53ea\u9700\u8981\u5bf9 B+\u6811\u53f6\u5b50\u8282\u70b9\u626b\u63cf\u4e00\u904d</p> <p>\u5982\u679c\u662f\u975e\u805a\u7c07\u7d22\u5f15\uff0c\u9700\u8981\u591a\u6b21\u8bbf\u95ee\u540c\u4e00\u9875\u9762\u5e76\u53cd\u590d\u8df3\u8f6c\u9875\u9762\uff0c\u662f\u968f\u673a IO\uff1b\u5e94\u8be5\u4f7f\u7528\u5916\u90e8\u6392\u5e8f</p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#92-aggregations","title":"9.2 Aggregations","text":"","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#921-sorting-aggregation","title":"9.2.1 Sorting Aggregation","text":"<p>\u5728\u6392\u5e8f\u540e\u53bb\u91cd\u53ef\u4ee5\u4f18\u5316\uff1a\u5728\u5916\u90e8\u6392\u5e8f\u7b97\u6cd5\u4e2d\u8fdb\u884c\u53bb\u91cd</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#922-hashing-aggregation","title":"9.2.2 Hashing Aggregation","text":"<p>\u53ef\u4ee5\u8fdb\u884c\u5206\u533a\u540e\u81ea\u4e3b\u8fdb\u884c\u9009\u62e9\u57fa\u4e8e hash \u8fd8\u662f\u57fa\u4e8e sort \u8fdb\u884c\u540e\u7eed\u64cd\u4f5c</p> <p></p>","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#partition","title":"partition","text":"","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#rehash","title":"rehash","text":"","tags":["Database"]},{"location":"notes/CMU15445/9-Sort%26Aggregation/#hashing-summarization","title":"hashing summarization","text":"","tags":["Database"]},{"location":"notes/CS61C/lecture10_Combinational%20Logic/","title":"lecture10_Combinational_Logic","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture10_Combinational%20Logic/#combinational-logic","title":"Combinational Logic","text":"<p> \u7ea6 42 \u4e2a\u5b57  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture10_Combinational%20Logic/#cmos","title":"CMOS","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture10_Combinational%20Logic/#boolean-algebra","title":"Boolean algebra","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture10_Combinational%20Logic/#arithmetic-logic-unit-alu","title":"Arithmetic Logic Unit (ALU)","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/","title":"lecture11_FSMs","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#fsms-synchronous-digital-systems","title":"FSMs, Synchronous Digital Systems","text":"<p> \u7ea6 159 \u4e2a\u5b57  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#fsm-finite-state-machine","title":"FSM: Finite State Machine","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#state-transition-diagram","title":"state transition diagram","text":"<ul> <li>s0 \u521d\u59cb\u72b6\u6001\uff1binput/output\uff1b\u7bad\u5934\u6307\u5411\u662f next state</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#clock-and-registers","title":"clock and registers","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#flip-flop","title":"Flip-Flop","text":"<ul> <li>\u65f6\u949f\u4e0a\u5347\u6cbf\uff1bQ = D\uff0c\u5176\u4f59\u65f6\u523b\u4ec0\u4e48\u4e5f\u4e0d\u505a</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#register-delay","title":"register delay","text":"<ul> <li>clk-to-q delay</li> <li>Registers can\u2019t transfer the D input to Q output instantly</li> <li>clk-to-q delay: Time it takes after the rising edge for the Q output to change</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#register-constraints","title":"register constraints","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#setup-time","title":"setup time","text":"<ul> <li>Setup time: Time before rising edge when the D input must be stable</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#hold-time","title":"hold time","text":"<ul> <li>D input cannot change before this, so the register can read a stable value.</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture11_FSMs/#maximizing-clock-frequency","title":"maximizing clock frequency","text":"<ul> <li> <p><code>Clock period \u2265 clk-to-q delay + longest combinational delay + setup time</code></p> </li> <li> <p><code>Hold time \u2264 clk-to-q delay + shortest combinational delay</code></p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture14_Datapath/","title":"lecture14_DataPath_Hazards","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture14_Datapath/#hazards","title":"Hazards","text":"<p> \u7ea6 266 \u4e2a\u5b57  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture14_Datapath/#structural-hazards","title":"Structural Hazards","text":"<ul> <li>\u4e24\u6761\u6216\u66f4\u591a\u6307\u4ee4\u5728\u6d41\u6c34\u7ebf\u9700\u8981\u8bbf\u95ee\u540c\u4e00\u4e2a\u7269\u7406\u5355\u5143</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture14_Datapath/#solutions","title":"Solutions","text":"<ul> <li>\u6307\u4ee4\u8f6e\u6d41\u4f7f\u7528\u7269\u7406\u8d44\u6e90</li> <li>\u589e\u52a0\u989d\u5916\u7684\u786c\u4ef6\u8d44\u6e90</li> <li>\u8bbe\u8ba1\u6307\u4ee4\u96c6\u907f\u514d\u7ed3\u6784\u5192\u9669</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture14_Datapath/#data-hazards","title":"Data Hazards","text":"<ul> <li>Some regfiles support writing a new value to a register, then reading the new value, in the same cycle.</li> <li>a register being written to is read from later.</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture14_Datapath/#solutions_1","title":"Solutions","text":"<ul> <li> <p>Stalling</p> </li> <li> <p>Wait for the first instruction to write its result before the second instruction reads the     value</p> </li> </ul> <p></p> <ul> <li> <p>Forwarding</p> </li> <li> <p>Add hardware to send the result back to earlier stages before the result is written</p> </li> <li>Requires extra connections in the datapath</li> </ul> <p></p> <ul> <li> <p>Code Scheduling</p> </li> <li> <p>Rearrange instructions to avoid data hazards</p> </li> <li>Compiler can put an unrelated instruction in the nop slot</li> </ul> <p></p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture14_Datapath/#control-hazards","title":"Control Hazards","text":"<ul> <li> <p>If branch is not taken:</p> </li> <li> <p>Instructions fetched sequentially after branch are correct</p> </li> <li> <p>No control hazard</p> </li> <li> <p>If branch is taken, or there\u2019s a jump:</p> </li> <li> <p>The next two instructions still in the pipeline are incorrect</p> </li> <li>Need to convert incorrect instructions in the pipeline to nops</li> <li>Called \u201cflushing\u201d the pipeline</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture14_Datapath/#solutions_2","title":"Solutions","text":"<ul> <li> <p>Branch Prediction to Reduce Penalties\uff08\u5206\u652f\u9884\u6d4b\uff09</p> </li> <li> <p>Early in the pipeline, guess which way branches will go.</p> </li> <li> <p>Flush pipeline if the guess was incorrect.</p> </li> <li> <p>Naive branch prediction: just predict branch \u201cnot taken\u201d, which always fetches PC+4</p> </li> </ul> <p></p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture15_Data-LevelParallelism/","title":"lecture15_Data_Level_Parallelism","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture15_Data-LevelParallelism/#data-level-parallelism","title":"Data-Level Parallelism","text":"<p> \u7ea6 100 \u4e2a\u5b57  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture15_Data-LevelParallelism/#simd","title":"SIMD","text":"<ul> <li>single instruction, multiple data or vector instructions</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture15_Data-LevelParallelism/#simd_1","title":"SIMD \u5b9e\u73b0\u77e9\u9635\u4e58\u6cd5","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture15_Data-LevelParallelism/#common-mistake","title":"common mistake","text":"<ul> <li>\u76f4\u63a5\u4f7f\u7528 32-bit \u7684 SIMD vector\uff08\u5bc4\u5b58\u5668\u4e0e\u5185\u5b58\u4e0d\u540c\uff09</li> <li>\u4f7f\u7528_mm_load or _mm_store \u65f6\u91c7\u7528\u672a\u5bf9\u9f50\u7684\u5185\u5b58</li> <li>\u5fd8\u8bb0\u5904\u7406\u5c3e\u90e8\u7279\u6b8a\u60c5\u51b5</li> <li>\u4f7f\u7528\u592a\u591a\u7684 vector</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture16_Thread-LevelParallelism/","title":"lecture16_Thread_Level_Parallelism","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture16_Thread-LevelParallelism/#thread-level-parallelism","title":"Thread-Level Parallelism","text":"<p> \u7ea6 374 \u4e2a\u5b57  1 \u884c\u4ee3\u7801  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p> <ul> <li>SISD\uff1a\u7ebf\u6027\u6267\u884c\u6307\u4ee4\uff0c\u6ca1\u6709\u5e76\u884c</li> <li>RISC-V \u5355\u5468\u671f CPU</li> <li>SIMD\uff1a\u5355\u6307\u4ee4\u6d41\uff0c\u591a\u6570\u636e\u6d41</li> <li>Intel instrinsics</li> <li>GPUS</li> <li>MISD\uff1a\u591a\u6307\u4ee4\u6d41\uff0c\u5355\u6570\u636e\u6d41</li> <li>Deep learning acceleration chips</li> <li>MIMD\uff1a\u591a\u6307\u4ee4\u6d41\uff0c\u591a\u6570\u636e\u6d41</li> <li>Modern processors</li> </ul> <p></p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture16_Thread-LevelParallelism/#_1","title":"\u591a\u6838\u6267\u884c\u6a21\u578b","text":"<ul> <li>\u72ec\u7acb\u8d44\u6e90</li> <li>Datapath (PC, registers, ALU)</li> <li>Highest level caches (L1, L2 cache)</li> <li>\u5171\u4eab\u8d44\u6e90</li> <li>Memory (DRAM)</li> <li>3<sup>rd</sup> level cache</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture16_Thread-LevelParallelism/#_2","title":"\u7ebf\u7a0b","text":"<ul> <li>\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u53ef\u4ee5\u5206\u88c2\u6216\u8005 fork \u51fa\u65b0\u7ebf\u7a0b\uff1b\u8fd9\u4e9b\u7ebf\u7a0b\u53ef\u4ee5\u540c\u65f6\u8fd0\u884c</li> <li>\u5bf9\u4e8e\u5355\u6838\u6765\u8bf4\uff0cCPU \u5206\u65f6\u8fd0\u884c\u7ebf\u7a0b</li> </ul> <ul> <li>\u6bcf\u4e2a CPU \u6838\u63d0\u4f9b\u4e00\u4e2a\u6216\u591a\u4e2a\u786c\u4ef6\u7684\u7ebf\u7a0b\u6765\u6267\u884c\u6307\u4ee4</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture16_Thread-LevelParallelism/#_3","title":"\u786c\u4ef6\u591a\u7ebf\u7a0b","text":"<ul> <li>\u5728\u5904\u7406\u5668\u786c\u4ef6\u4e2d\u6709\u4e24\u4e2a PC \u6838\u5bf9\u5e94\u7684\u5bc4\u5b58\u5668\u7ec4</li> <li>simultaneous multithreading (SMT) or hyperthreading (HT)</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture16_Thread-LevelParallelism/#biglittle-processors","title":"Big/little Processors","text":"<ul> <li>\u5927\u6838\u6709\u66f4\u9ad8\u7684\u6027\u80fd</li> <li>higher frequency, more superscalar pipelines, larger caches</li> <li>\u73b0\u4ee3\u5904\u7406\u5668\u8bbe\u8ba1</li> <li>i9\uff0c8 performance cores + 16 efficiency cores</li> <li>8 Gen 2, 1 big core, 4 medium cores, 3 little cores</li> <li>M1 Pro, 8 performance cores, 2 efficiency cores</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture16_Thread-LevelParallelism/#thread-level-parallelism-tlp","title":"Thread-Level Parallelism (TLP)","text":"<ul> <li> <p>\u4e0d\u540c\u7684\u6307\u4ee4\u5728\u540c\u4e00\u4e2a\u6838\u4e0a\u8fd0\u884c</p> </li> <li> <p>\u7ebf\u7a0b\u5171\u4eab\u5185\u5b58</p> </li> <li> <p>\u7ebf\u7a0b\u5bb9\u6613\u901a\u4fe1</p> </li> <li> <p>Multithreading Framework</p> </li> <li> <p>Registers</p> </li> <li>PC</li> <li> <p>Stach</p> </li> <li> <p>Threads of same process share:</p> </li> <li> <p>Heap</p> </li> <li> <p>\u6ce8\u610f\u8d1f\u8f7d\u5747\u8861</p> </li> <li> <p>\u5728\u5faa\u73af\u4e2d\u9700\u8981\u786e\u5b9a\u7ebf\u7a0b\u7684\u6267\u884c\u987a\u5e8f\uff1b\u9700\u8981\u4fdd\u8bc1 cache \u7684\u9ad8\u547d\u4e2d\u7387</p> </li> </ul> C<pre><code>for(int i = tid*250000;i&lt;(tid+1)*250000;i++)\n</code></pre>","tags":["System Arch"]},{"location":"notes/CS61C/lecture16_Thread-LevelParallelism/#data-races","title":"Data Races","text":"<ul> <li>\u4e0d\u540c\u7ebf\u7a0b\u7ade\u4e89\u5171\u4eab\u7684\u5185\u5b58\uff0c\u53ef\u80fd\u51fa\u73b0\u9519\u8bef</li> <li>\u9700\u8981\u8bbe\u7f6e\u4e34\u754c\u533a\uff0c\u540c\u4e00\u65f6\u95f4\u53ea\u80fd\u6709\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u8be5\u90e8\u5206\u4ee3\u7801</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture17_Process_LevelParallelism/","title":"lecture17_Process_Level_Parallelism","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture17_Process_LevelParallelism/#process-level-parallelism","title":"Process-Level Parallelism","text":"<p> \u7ea6 149 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture17_Process_LevelParallelism/#multiprocess-framework","title":"Multiprocess Framework","text":"<ul> <li> <p>\u4e0d\u540c\u7684\u6838\u4e0d\u5206\u4eab\u5185\u5b58\uff0c\u4f46\u662f\u5171\u4eab\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf</p> </li> <li> <p>\u5728\u591a\u7ebf\u7a0b\u7a0b\u5e8f\u8fd0\u884c\u65f6\uff0c\u4e00\u4e2a\u7ebf\u7a0b crash\uff0c\u6574\u4e2a\u7a0b\u5e8f\u53ef\u80fd crash\uff1b\u4f46\u662f\u591a\u6838\u7a0b\u5e8f\uff0c\u6bcf\u4e2a\u6838\u4e4b\u95f4\u662f\u72ec\u7acb\u7684\uff0c\u5982\u679c\u4e00\u4e2a\u6838 crash\uff0c\u5176\u4ed6\u7684\u6838\u53ef\u4ee5\u7ee7\u7eed\u8fd0\u884c</p> </li> <li> <p>\u4e0d\u540c\u7684\u6838\u4ea4\u6d41\u5360\u7528\u5927\u91cf\u65f6\u95f4</p> </li> <li> <p>\u5c06\u4e00\u4e2a\u5927\u95ee\u9898\u5206\u89e3\u6210\u72ec\u7acb\u7684\u5c0f\u95ee\u9898\uff1b\u4ee5\u6b64\u6765\u51cf\u5c11\u6570\u636e\u7684\u4f20\u8f93\u65f6\u95f4\u635f\u8017</p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/","title":"lecture18_Caches","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#caches","title":"Caches","text":"<p> \u7ea6 751 \u4e2a\u5b57  9 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <p></p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#memory-hierarchy","title":"Memory Hierarchy (\u5c42\u6b21\u5316\u5185\u5b58)","text":"<ul> <li>\u5bc4\u5b58\u5668\u79bb CPU \u6700\u8fd1\uff0c\u4f7f\u7528\u4e5f\u6700\u5feb\uff1b\u4f46\u662f\u5f88\u8d35\uff1b\u6bcf\u4e2a CPU \u53ea\u6709\u5c11\u91cf\u5bc4\u5b58\u5668</li> <li>DRAM \u66f4\u9002\u5408\u5b58\u50a8\u5927\u91cf\u6570\u636e\uff0c\u4f46\u662f\u901f\u5ea6\u66f4\u6162</li> <li>\u9700\u8981\u6570\u636e\u603b\u7ebf\u8fdb\u884c\u4f20\u8f93</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#_1","title":"\u52a0\u901f\u65b9\u5f0f","text":"<ul> <li> <p>Hardware Multithreaing</p> </li> <li> <p>\u5728\u7b49\u5f85\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u8fdb\u884c\u53bb\u6267\u884c\u4efb\u52a1</p> </li> <li> <p>\u6bcf\u4e2a\u7269\u7406\u6838\u542b\u6709\u4e24\u4e2a PC \u6838\u5bc4\u5b58\u5668\u7ec4\uff0c\u6240\u4ee5\u4e0a\u4e0b\u6587\u5207\u6362\u5f88\u5feb</p> </li> <li> <p>Prefetching</p> </li> <li> <p>\u6bcf\u4e2a\u5468\u671f\u9884\u53d6\u6307\u4ee4\u548c\u6570\u636e</p> </li> <li> <p>Caching</p> </li> <li> <p>\u5229\u7528\u7a7a\u95f4\u5c40\u90e8\u6027\u548c\u65f6\u95f4\u5c40\u90e8\u6027\uff0c\u51cf\u5c11\u548c\u4e3b\u5b58\u4e4b\u95f4\u7684\u6570\u636e\u4f20\u8f93</p> </li> <li> <p>\u7f13\u5b58\u4e2d\u5b58\u653e\u88ab\u4e3b\u5b58\u4f7f\u7528\u7684\u6570\u636e\u526f\u672c</p> </li> <li> <p>\u4e3b\u5b58\u4e2d\u5b58\u653e\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u526f\u672c</p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#_2","title":"\u5c42\u6b21\u5316\u7ba1\u7406","text":"<ul> <li>Registers \\&lt;---&gt; Memory</li> <li>\u901a\u8fc7\u7f16\u8bd1\u5668\u6216\u8005\u6c47\u7f16\u7ea7\u522b\u7f16\u7a0b</li> <li>Cache \\&lt;---&gt; \u4e3b\u5b58</li> <li>\u901a\u8fc7\u7f13\u5b58\u63a7\u5236\u786c\u4ef6</li> <li>Main Memory \\&lt;---&gt; Disks</li> <li>\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\uff08\u865a\u62df\u5185\u5b58\uff09</li> <li>\u901a\u8fc7\u7f16\u7a0b\u8005 (files)</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#cache","title":"Cache \u4e09\u79cd\u6620\u5c04","text":"<ul> <li> <p>\u5168\u76f8\u8054\u6620\u5c04</p> </li> <li> <p>\u6bcf\u4e2a\u6570\u636e\u53ef\u4ee5\u88ab\u6620\u5c04\u5230 n \u4e2a\u4f4d\u7f6e</p> </li> <li> <p>\u7269\u7406\u5730\u5740\u88ab\u5206\u4e3a tag and offset</p> </li> </ul> <p></p> <ul> <li> <p>\u76f4\u63a5\u6620\u5c04</p> </li> <li> <p>\u6bcf\u4e2a\u6570\u636e\u53ea\u80fd\u6620\u5c04\u5230\u56fa\u5b9a\u7684\u4e00\u4e2a\u4f4d\u7f6e</p> </li> </ul> <p></p> <ul> <li> <p>\u7ec4\u76f8\u8054\u6620\u5c04</p> </li> <li> <p>\u5206\u4e3a m \u4e2a\u7ec4\uff1b\u6bcf\u4e2a\u6570\u636e\u53ef\u4ee5\u88ab\u6620\u5c04\u5230\u6bcf\u4e2a\u7ec4\u7ec4\u5185\u7684\u4efb\u610f\u4f4d\u7f6e</p> </li> <li>\u6bcf\u4e2a\u5730\u5740\u88ab\u5206\u4e3a tag + index\uff08\u7ec4\u7684\u7d22\u5f15\uff09 + offset\uff08\u5757\u5927\u5c0f\uff09</li> </ul> <p></p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#_3","title":"\u66ff\u6362\u7b56\u7565","text":"<ul> <li>LRU</li> <li>\u6700\u8fd1\u6700\u5c11\u7528\u7684\u5757\u88ab\u9a71\u9010\u51fa\u7f13\u5b58</li> <li>MRU</li> <li>\u6700\u8fd1\u4f7f\u7528\u8fc7\u7684\u5757\u88ab\u9a71\u9010</li> <li>FIFO</li> <li>\u6700\u8001\u7684\u5757\u88ab\u9a71\u9010\uff08queue\uff09</li> <li>LIFO</li> <li>\u6700\u65b0\u7684\u5757\u88ab\u9a71\u9010\uff08stack\uff09</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#_4","title":"\u5199\u7b56\u7565","text":"<ul> <li>\u56de\u5199\u7b56\u7565</li> <li>\u6570\u636e\u6539\u53d8\uff0c\u9a6c\u4e0a\u66f4\u65b0 cache \u548c memory \u7684\u6570\u636e</li> <li>\u5199\u56de</li> <li>\u6bcf\u6b21\u53ea\u66f4\u65b0 cache \u7684\u6570\u636e</li> <li>\u76f4\u5230\u8be5\u5757\u88ab\u9a71\u9010\uff0c\u68c0\u67e5 dirty flag\uff0c\u5c06\u6539\u53d8\u5199\u56de main memory</li> <li>\u6bd4\u56de\u5199\u5feb</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#_5","title":"\u591a\u7ea7\u7f13\u5b58","text":"<ul> <li>\u6bcf\u7ea7\u7f13\u5b58\u6bd4\u524d\u4e00\u7ea7\u66f4\u5927\uff0c\u7f13\u5b58\u7684\u6570\u636e\u66f4\u591a</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#caching-with-multithreading","title":"caching with multithreading","text":"<ul> <li> <p>\u6bcf\u4e2a\u6838\u6709\u81ea\u5df1\u7684 L1\u3001L2 \u7f13\u5b58</p> </li> <li> <p>\u4e0d\u540c\u7684\u6838\u8fdb\u884c\u8bfb\u53d6\u6838\u5199\u5165\u65f6\u53ef\u80fd\u53d1\u751f\u7f13\u5b58\u7684\u4e0d\u4e00\u81f4\u95ee\u9898</p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#msi-protocol","title":"MSI Protocol (\u7f13\u5b58\u4e00\u81f4\u6027)","text":"<ul> <li>\u8bfb\u53d6\u65f6\uff0c\u68c0\u67e5\u5176\u4ed6\u7684\u6838\u5fc3\u8be5\u5757\u662f\u5426\u662f\u810f\u5757\uff0c\u5982\u679c\u662f\u56de\u5199\u8be5\u6539\u52a8</li> <li>\u5199\u5165\u65f6\uff0c\u5982\u679c\u8be5\u5757\u5728\u5176\u4ed6\u6838\u4e2d\u53ef\u7528\uff0c\u4f7f\u5176\u4e0d\u53ef\u7528\uff08\u5982\u679c\u662f\u810f\u5757\uff0c\u56de\u5199\u6570\u636e\uff09</li> <li>Invalid\uff1a\u8be5\u5757\u4e0d\u5728\u7f13\u5b58</li> <li>Shared\uff1a\u8be5\u5757\u5728\u5176\u4ed6\u6838\u5fc3\uff1b\u8fd8\u672a\u8fdb\u884c\u66f4\u6539\uff0c\u5982\u679c\u8981\u66f4\u6539\uff0c\u9a71\u9010\u6bcf\u4e2a\u4eba\u7f13\u5b58\u4e2d\u7684\u8be5\u5757\uff0c\u8f6c\u5316\u4e3a modified</li> <li>Modified\uff1a\u8be5\u5757\u5df2\u7ecf\u88ab\u8bfb\u548c\u4fee\u6539\uff1b\u7a0d\u540e\u5176\u4ed6\u7f13\u5b58\u4e0d\u5728\u62e5\u6709\u8be5\u5757</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#moesi","title":"MOESI","text":"<ul> <li> <p>Exclusive: Same as valid bit on, dirty bit off in regular cache</p> </li> <li> <p>The block has been read, but not modified</p> </li> <li> <p>Further, no other cache has this block</p> </li> <li> <p>Owner:</p> </li> <li> <p>The block is in some other cache</p> </li> <li>If we make modifications, it's our responsibility to tell all the other caches in shared state about thesechanges</li> <li>Allows for writing while other threads read the same data.</li> </ul> <p></p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture18_Caches/#coherence-missed-miss","title":"Coherence Missed (\u4e00\u81f4\u6027 miss)","text":"<ul> <li>\u4e24\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5199\u76f8\u540c\u7684\u5757</li> <li>\u53ef\u80fd\u9020\u6210\u9519\u8bef\u5171\u4eab</li> <li>The entire block is invalidated and must be reloaded, even though technically no data is shared.</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/","title":"lecture2_Intro_to_C","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#intro-to-c","title":"Intro to C","text":"<p> \u7ea6 334 \u4e2a\u5b57  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#great-idea-in-computer-architecture","title":"Great idea in Computer Architecture","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#1-abstraction","title":"1. Abstraction","text":"<ul> <li>(Layers of Representation/Interpretation)</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#2-moores-law","title":"2. Moore's Law\uff08\u6469\u5c14\u5b9a\u5f8b\uff09","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#3-principle-of-localitymemory-hierarchy","title":"3. Principle of Locality/Memory Hierarchy\uff08\u5c40\u90e8\u6027\u548c\u5185\u5b58\u5c42\u6b21\u6027\u539f\u5219\uff09","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#4-parallelism","title":"4. Parallelism\uff08\u5e76\u884c\uff09","text":"<ul> <li>\u52a0\u901f\u9891\u7e41\u4e8b\u4ef6\uff08Amdahl's law\uff09</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#5-performance-measurement-improvement","title":"5. Performance Measurement &amp; Improvement","text":"","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#6-dependability-via-redundancy","title":"6. Dependability via redundancy\uff08\u5197\u4f59\u5b9e\u73b0\u53ef\u9760\u6027\uff09","text":"<ul> <li> <p>RAID...</p> </li> <li> <p>\u5931\u53bb\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\uff0c\u4f46\u662f\u6574\u4e2a\u7f51\u7edc\u4e0d\u4f1a\u5b95\u673a</p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#compiled-interpreted","title":"Compiled &amp; Interpreted\uff08\u7f16\u8bd1\u548c\u89e3\u91ca\uff09","text":"<ul> <li> <p>Translation happens in two ways   \u25cb Compilation   \u25cb Interpretation   \u25cb Some languages use both!</p> </li> <li> <p>C compilers map C programs directly into architecture-specific machinecode (string of 1s and 0s)</p> </li> <li> <p>Java converts to architecture-independent bytecode which is then compiled by a just-in-time (JIT) compiler.</p> </li> <li> <p>Python environments converts to Python bytecode at runtime instead of at compile-time.</p> </li> <li> <p>Runtime versus JIT compilation differ in when the program is converted to low-level assembly language that is eventually translated into machine code.</p> </li> <li> <p>With C, there is generally a 3-part process in handling a .c file</p> </li> <li> <p>.c files are compiled into .s files \u21d2 compilation by the compiler</p> </li> <li>.s files are assembled into .o files \u21d2 assembly by the assembler (this step is generally hidden, so most of the time we directly convert .c files into .o files)</li> <li>.o files are linked together to create an executable \u21d2 linking by the linker</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture2-Intro%20to%20C/#_1","title":"\u7f16\u8bd1\u7684\u4f18\u70b9\u548c\u7f3a\u70b9","text":"<ul> <li> <p>\u4f18\u70b9</p> </li> <li> <p>\u5f88\u597d\u7684\u8fd0\u884c\u65f6\u8868\u73b0(because it optimizes for a given architecture)</p> </li> <li> <p>\u7f3a\u70b9</p> </li> <li> <p>\u4f9d\u8d56\u7279\u5b9a\u7684\u786c\u4ef6\u5e73\u53f0</p> </li> <li>\u5728\u65b0\u7cfb\u7edf\u4e0a\u5fc5\u987b\u91cd\u65b0 build</li> <li>\u201cChange \u2192 Compile \u2192 Run [repeat]\u201d iteration cycle can be slow during development<ul> <li>but make only rebuilds changed pieces, and can compile in parallel: make -j</li> <li>linker is sequential though \u2192 Amdahl\u2019s Law</li> </ul> </li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture21_Virtual_Memory/","title":"lecture21_Virtual_Memory","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture21_Virtual_Memory/#virtual-memory","title":"Virtual Memory","text":"<p> \u7ea6 154 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> <p>\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u5185\u5b58\u95ee\u9898</p> <ul> <li>\u6ca1\u6709\u8db3\u591f\u7a7a\u95f4\uff1bRISC-V \u53ea\u63d0\u4f9b 32bit \u7a7a\u95f4\u5373 4GB</li> <li>\u5730\u5740\u7a7a\u95f4\u6709\u7a7a\u6d1e</li> <li>\u4e0d\u80fd\u4fdd\u8bc1\u5176\u4ed6\u7a0b\u5e8f\u4e0d\u8bbf\u95ee\u540c\u4e00\u5757\u5185\u5b58</li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture21_Virtual_Memory/#benefits","title":"Benefits","text":"<ul> <li> <p>\u5141\u8bb8\u8fd0\u884c\u81ea\u8eab\u5927\u5c0f\u6bd4\u4e3b\u5b58\u5927\u5f97\u591a\u7684\u7a0b\u5e8f\uff1b\u53ea\u6709\u5de5\u4f5c\u7684\u9875\u653e\u5728\u4e3b\u5b58\uff0c\u5176\u4ed6\u9875\u653e\u5728\u78c1\u76d8\uff1b\u7531 OS \u8fdb\u884c\u9875\u7684\u8bf7\u6c42\u548c\u7f6e\u6362</p> </li> <li> <p>OS \u53ef\u4ee5\u5171\u4eab\u5185\u5b58\u5e76\u5b9e\u73b0\u7a0b\u5e8f\u7684\u4e92\u76f8\u4fdd\u62a4</p> </li> <li> <p>\u9690\u85cf\u673a\u5668\u7ea7\u7684\u4e0d\u540c</p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture4_C%20Memory%20Endianness/","title":"lecture4_C_Memory","text":"2023-09-112025-12-10 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CS61C/lecture4_C%20Memory%20Endianness/#c-memory","title":"C Memory","text":"<p> \u7ea6 130 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CS61C/lecture4_C%20Memory%20Endianness/#memory-alignment","title":"memory alignment\uff08\u5185\u5b58\u5bf9\u9f50\uff09","text":"<ul> <li> <p>Memory alignment: a system-dependent rule that tells us where data   can be stored (usually not at every byte)</p> </li> <li> <p>Can be accomplished with the \"aligned\" attribute <code>__attribute__((aligned(n)));</code></p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CS61C/lecture4_C%20Memory%20Endianness/#strings","title":"Strings","text":"<ul> <li> <p>Example: The string \u201cHi\u201d is stored in memory as an array of characters. This array would look like: {\u2018H\u2019, \u2018i\u2019, \u2018\\0\u2019}</p> </li> <li> <p>If the null terminator is missing, C will continue to read memory as if   it was part of the string until it comes across a byte that happens to have value 0.</p> </li> <li> <p>This is a very common source of bugs.</p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/","title":"csapp-5-\u4f18\u5316\u7a0b\u5e8f\u6027\u80fd","text":"2023-09-122025-12-13 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#chapter-5","title":"Chapter 5 \u4f18\u5316\u7a0b\u5e8f\u6027\u80fd","text":"<p> \u7ea6 696 \u4e2a\u5b57  22 \u884c\u4ee3\u7801  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#_1","title":"\u7f16\u8bd1\u5668\u7684\u80fd\u529b\u548c\u5c40\u9650\u6027","text":"<ul> <li>\u5185\u5b58\u522b\u540d\u4f7f\u7528\uff1a\u4e24\u4e2a\u6307\u9488\u53ef\u80fd\u6307\u5411\u540c\u4e00\u4e2a\u5185\u5b58\u4f4d\u7f6e</li> <li>\u53ef\u80fd\u51fa\u73b0\u8fd9\u79cd\u95ee\u9898\uff0c\u7f16\u8bd1\u5668\u5fc5\u987b\u8fdb\u884c\u68c0\u67e5\u548c\u5904\u7406\uff0c\u8fd9\u9650\u5236\u4e86\u53ef\u80fd\u7684\u4f18\u5316</li> <li>restrict \u5173\u952e\u5b57\uff0c\u53ef\u4ee5\u544a\u77e5\u7f16\u8bd1\u5668\u4e24\u4e2a\u6307\u9488\u4e0d\u80fd\u6307\u5411\u540c\u4e00\u5757\u5185\u5b58\uff0c\u7f16\u8bd1\u5668\u53ef\u4ee5\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u4f18\u5316</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#inline-substitution","title":"\u5185\u8054\u51fd\u6570\u66ff\u6362\uff08inline substitution\uff09","text":"<ul> <li>\u5c06\u51fd\u6570\u8c03\u7528\u66ff\u6362\u6210\u51fd\u6570\u4f53\uff1b\u51cf\u8f7b\u8c03\u7528\u7684\u6df1\u5ea6</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#_2","title":"\u6d88\u9664\u5faa\u73af\u4e2d\u7684\u4f4e\u6548\u7387","text":"<ul> <li>\u6bd4\u5982\u5c06\u590d\u6742\u7684\u51fd\u6570\u52a0\u5165\u5faa\u73af\uff1b\u6b64\u65f6\u8003\u8651\u8bbe\u7f6e\u5c40\u90e8\u53d8\u91cf</li> <li>\u6d88\u9664\u5faa\u73af\u4e2d\u7684\u8fc7\u7a0b\u8c03\u7528\uff1b\u8003\u8651\u8fd4\u56de\u503c\u6765\u4f18\u5316</li> </ul> C<pre><code>void combine3(vec_ptr v, data_t* dest) {\n  long i;\n  long length = vec_length(v);\n  // \u6d88\u9664\u8fc7\u7a0b\u8c03\u7528\n  data_t* data = get_vec_start(v);\n\n  *dest = IDENT;\n  for(int i = 0; i &lt; length; ++i) {\n    *dest = *dest OP data[i];\n  }\n}\n</code></pre> <ul> <li>\u4e0a\u8ff0\u8fc7\u7a0b\u6c47\u7f16\u662f\u4f1a\u53d1\u73b0\uff0c\u6bcf\u6b21\u7d2f\u79ef\u53d8\u91cf\u7684\u6570\u503c\u90fd\u8981\u8bfb\u5165\u5185\u5b58\u518d\u5199\u56de\u5185\u5b58</li> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u5f15\u5165\u4e34\u65f6\u53d8\u91cf\uff0c\u8be5\u4e34\u65f6\u53d8\u91cf\u4f7f\u7528\u5bc4\u5b58\u5668\u5b58\u50a8\uff1b\u6700\u540e\u53ea\u5199\u5165\u4e00\u6b21\u5185\u5b58</li> </ul> C<pre><code>void combine3(vec_ptr v, data_t* dest) {\n  long i;\n  long length = vec_length(v);\n  // \u6d88\u9664\u8fc7\u7a0b\u8c03\u7528\n  data_t* data = get_vec_start(v);\n  data_t acc = IDENT;\n  for(int i = 0; i &lt; length; ++i) {\n    acc = acc OP data[i];\n  }\n  *dest = acc;\n}\n</code></pre>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#_3","title":"\u5904\u7406\u5668\u64cd\u4f5c\u7684\u62bd\u8c61\u6a21\u578b","text":"","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#_4","title":"\u6570\u636e\u6d41\u56fe","text":"<ul> <li>\u53ef\u4ee5\u628a\u5faa\u73af\u5bc4\u5b58\u5668\u5355\u72ec\u62ff\u51fa\u6765\uff1b\u6839\u636e\u4e0d\u540c\u5faa\u73af\u64cd\u4f5c\u7684\u5468\u671f\u53ef\u4ee5\u5927\u6982\u4f30\u8ba1\u51fa\u8be5\u7a0b\u5e8f\u6027\u80fd\u74f6\u9888\u4f4d\u7f6e</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#_5","title":"\u5faa\u73af\u5c55\u5f00","text":"<ul> <li>\u901a\u8fc7\u589e\u52a0\u6bcf\u6b21\u8fed\u4ee3\u8ba1\u7b97\u7684\u6570\u91cf\uff1b\u51cf\u5c11\u5faa\u73af\u7684\u8fed\u4ee3\u6b21\u6570</li> <li>\u4f46\u662f\u5faa\u73af\u5c55\u5f00\u53ef\u80fd\u4f18\u5316\u7a0b\u5ea6\u6709\u9650\uff1b\u53d6\u51b3\u4e8e\u5173\u952e\u8def\u5f84\u7684\u6267\u884c\u8fc7\u7a0b</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#_6","title":"\u63d0\u9ad8\u5e76\u884c\u6027","text":"<ul> <li>\u6574\u6570\u8fd0\u7b97\u53ef\u4ee5\uff1b\u4f46\u662f\u6d6e\u70b9\u6570\u7684\u52a0\u6cd5\u548c\u4e58\u6cd5\u4e0d\u80fd\u7ed3\u5408\uff1b\u7531\u4e8e\u6d6e\u70b9\u6570\u7684\u820d\u5165\u548c\u6ea2\u51fa\u53ef\u80fd\u9020\u6210\u4e0d\u540c\u7684\u7ed3\u679c</li> </ul> <ul> <li>\u91cd\u65b0\u7ed3\u5408\u53d8\u6362\uff0c\u5c06\u62ec\u53f7\u7684\u4f4d\u7f6e\u6539\u53d8\uff1b\u53ef\u80fd\u53ef\u4ee5\u7ee7\u7eed\u4f18\u5316\u7a0b\u5e8f\u7684\u6027\u80fd</li> </ul> <p>\u5faa\u73af\u5c55\u5f00\u548c\u5e76\u884c\u79ef\u7d2f\u5728\u591a\u4e2a\u503c\u4e2d\uff0c\u662f\u63d0\u9ad8\u7a0b\u5e8f\u6027\u80fd\u7684\u66f4\u53ef\u9760\u65b9\u6cd5</p> <ul> <li>SIMD\uff1a\u5355\u6307\u4ee4\u6d41\u591a\u6570\u636e\u6d41\u65b9\u5f0f\u6267\u884c\u7a0b\u5e8f\uff1b\u6bcf\u6b21\u8fd0\u7b97\u6267\u884c\u5411\u91cf\u7684\u8ba1\u7b97</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#_7","title":"\u9650\u5236\u56e0\u7d20","text":"<ul> <li>\u5bc4\u5b58\u5668\u6ea2\u51fa\uff1a\u5982\u679c\u6ea2\u51fa\uff0c\u5c06\u4e24\u4e2a\u6570\u76f8\u4e58\u76f4\u63a5\u4fdd\u5b58\u5728\u5bc4\u5b58\u5668\u7684\u4f18\u52bf\u6d88\u5931</li> <li>\u5206\u652f\u9884\u6d4b\u548c\u9884\u6d4b\u9519\u8bef\u60e9\u7f5a\uff1a\u60e9\u7f5a\u662f 19 \u4e2a\u65f6\u949f\u5468\u671f</li> <li>\u5faa\u73af\u5206\u652f\u88ab\u9884\u6d4b\u4e3a\u9009\u62e9\u5206\u652f\uff0c\u53ea\u5728\u6700\u540e\u4e00\u6b21\u5bfc\u81f4\u9884\u6d4b\u9519\u8bef\u60e9\u7f5a</li> <li>\u4e66\u5199\u9002\u5408\u7528\u6761\u4ef6\u4f20\u9001\u5b9e\u73b0\u7684\u4ee3\u7801\uff1a\u4e09\u5143\u64cd\u4f5c\u7b26\u4ee3\u66ff if-else</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/5-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/#_8","title":"\u5185\u5b58\u6027\u80fd","text":"<ul> <li> <p>\u52a0\u8f7d\u7684\u6027\u80fd\uff1a\u9664\u5f00\u4f7f\u7528 cache\uff0c\u6bcf\u6b21\u8fdb\u884c\u53d6\u53d6\u64cd\u4f5c\u6570\uff0c\u90fd\u9700\u8981\u8bbf\u5b58</p> </li> <li> <p>\u5b58\u50a8\u7684\u6027\u80fd\uff1a\u6bcf\u6b21\u5b58\u653e\u7ed3\u679c\uff0c\u4e5f\u9700\u8981\u8bbf\u5b58</p> </li> <li> <p>\u6ce8\u610f\u7a0b\u5e8f\u4e2d\u53ef\u80fd\u5b58\u5728\u6f5c\u5728\u7684\u52a0\u8f7d-\u5b58\u50a8\u76f8\u5173\u7684\u64cd\u4f5c\uff08src \u548c dest \u6307\u5411\u76f8\u540c\u7684\u5730\u5740\u6216\u8005 dest \u4f9d\u8d56\u4e8e src \u8ba1\u7b97\u540e\u5b58\u50a8\u7684\u65b0\u7ed3\u679c\uff09</p> </li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/","title":"csapp-6-\u5b58\u50a8\u5668\u5c42\u6b21\u7ed3\u6784","text":"2023-09-122025-12-13 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/#chapter-6","title":"Chapter 6 \u5b58\u50a8\u5668\u5c42\u6b21\u7ed3\u6784","text":"<p> \u7ea6 443 \u4e2a\u5b57  7 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/#ram","title":"RAM\uff08\u968f\u673a\u8bbf\u95ee\u5b58\u50a8\u5668\uff09","text":"<ul> <li>SRAM\uff1a\u5feb\u4f46\u8d35\uff1b\u4f5c\u4e3a\u9ad8\u901f\u7f13\u5b58</li> <li>DRAM\uff1a\u4f5c\u4e3a\u4e3b\u5b58</li> <li>\u5206\u65f6\u590d\u7528\u5730\u5740\u7ebf\uff1b\u51cf\u5c11\u5f15\u811a\u6570\u91cf\uff0c\u589e\u52a0\u8bbf\u95ee\u65f6\u95f4</li> <li>\u9996\u5148\u5c06\u4e00\u6574\u884c\u590d\u5236\u5230\u4e00\u4e2a\u5185\u90e8\u884c\u7f13\u51b2\u533a\uff1b\u63a5\u7740\u518d\u4ece\u884c\u7f13\u51b2\u533a\u4e2d\u590d\u5236\u51fa\u4e00\u4e2a\u5355\u5143</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/#_1","title":"\u975e\u6613\u5931\u6027\u5b58\u50a8\u5668","text":"<ul> <li>\u4e3b\u8981\u662f ROM\uff0c\u4f46\u662f ROM \u4e2d\u6709\u7684\u7c7b\u578b\u5b9e\u9645\u4e0a\u65e2\u53ef\u4ee5\u8bfb\u4e5f\u53ef\u4ee5\u5199</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/#_2","title":"\u56fa\u6001\u786c\u76d8","text":"<ul> <li>Solid State Disk (SSD)\uff0c\u662f\u57fa\u4e8e\u95ea\u5b58\u7684\u5b58\u50a8\u6280\u672f</li> <li>\u95ea\u5b58\u82af\u7247\u66ff\u4ee3\u4f20\u7edf\u65cb\u8f6c\u78c1\u76d8\u4e2d\u7684\u673a\u68b0\u9a71\u52a8\u5668</li> <li>\u95ea\u5b58\u7ffb\u8bd1\u5c42\u662f\u4e00\u4e2a\u786c\u4ef6/\u56fa\u4ef6\u8bbe\u5907\uff0c\u5c06\u5bf9\u903b\u8f91\u5757\u7684\u8bf7\u6c42\u7ffb\u8bd1\u6210\u5bf9\u5e95\u5c42\u7269\u7406\u8bbe\u5907\u7684\u8bbf\u95ee</li> <li>SSD \u4ee5\u9875\u4e3a\u8bfb\u5199\u5355\u4f4d</li> <li>\u5c06\u64e6\u9664\u5e73\u5747\u5206\u5e03\u5230\u6240\u6709\u7684\u5757\u4e0a</li> </ul> <ul> <li>\u968f\u673a\u5199\u5f88\u6162\u7684\u539f\u56e0</li> <li>\u64e6\u9664\u5757\u9700\u8981\u76f8\u5bf9\u8f83\u957f\u7684\u65f6\u95f4</li> <li>\u5982\u679c\u9700\u8981\u4fee\u6539\u6570\u636e\uff0c\u9700\u8981\u628a\u6240\u6709\u5e26\u6709\u7528\u6570\u636e\u7684\u9875\u590d\u5236\u5230\u4e00\u4e2a\u65b0\u7684\u5757\u4e0a\u540e\uff1b\u91cd\u65b0\u8fdb\u884c\u8bfb\u5199</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/#_3","title":"\u5b58\u50a8\u5668\u5b58\u50a8\u7ed3\u6784","text":"","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/#cache","title":"cache","text":"<ul> <li>\u5728 CPU \u5bc4\u5b58\u5668\u548c\u4e3b\u5b58\u4e2d\u63d2\u5165\u4e86\u4e00\u4e2a\u5c0f\u7684 SRAM \u9ad8\u901f\u7f13\u5b58\u5b58\u50a8\u5668\uff0c\u79f0\u4e3a L1 cache\uff1b4 clock</li> <li>\u5728 L1 cache \u548c main memory \u4e2d\u63d2\u5165 L2 cache\uff0c10 clock</li> <li>\u5728 L2 cache \u548c L3 cache \u4e2d\u63d2\u5165 L3 cache\uff0c50 clock</li> </ul> <ul> <li>\u4f7f\u7528\u4e2d\u95f4\u7684\u4f4d\u6765\u7d22\u5f15\uff1b\u5982\u679c\u7528\u9ad8\u4f4d\u6765\u7d22\u5f15\uff0c\u76f8\u90bb\u7684\u5757\u57fa\u672c\u4f1a\u88ab\u6620\u5c04\u5230\u540c\u4e00\u4e2a cache \u884c\uff0ccache \u547d\u4e2d\u5927\u5927\u51cf\u5c11</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/#core-cache","title":"core \u4e2d\u7684 cache","text":"","tags":["System Arch"]},{"location":"notes/CSAPP/6-%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84/#_4","title":"\u7f16\u5199\u9ad8\u901f\u7f13\u5b58\u53cb\u597d\u7684\u4ee3\u7801","text":"<ul> <li>\u8ba9\u6700\u5e38\u89c1\u7684\u60c5\u51b5\u8fd0\u884c\u5f97\u5feb</li> <li>\u5c3d\u91cf\u51cf\u5c11\u6bcf\u4e2a\u5faa\u73af\u5185\u90e8\u7684\u7f13\u5b58\u4e0d\u547d\u4e2d\u6570\u91cf</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/","title":"csapp-7-\u94fe\u63a5","text":"2023-09-182025-12-13 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#chapter-7","title":"Chapter 7 \u94fe\u63a5","text":"<p> \u7ea6 557 \u4e2a\u5b57  7 \u884c\u4ee3\u7801  6 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#_1","title":"\u9759\u6001\u94fe\u63a5","text":"<ul> <li>\u7b26\u53f7\u89e3\u6790</li> <li>\u91cd\u5b9a\u4f4d</li> <li>\u7f16\u8bd1\u5668\u548c\u6c47\u7f16\u5668\u751f\u6210.text \u548c.data</li> <li>\u94fe\u63a5\u5668\u901a\u8fc7\u628a\u6bcf\u4e2a\u7b26\u53f7\u5b9a\u4e49\u548c\u4e00\u4e2a\u5185\u5b58\u4f4d\u7f6e\u5173\u8054\uff0c\u5bf9\u8fd9\u4e9b\u8282\u8fdb\u884c\u91cd\u5b9a\u4f4d\uff1b\u4fee\u6539\u5f15\u7528\uff0c\u8ba9\u7b26\u53f7\u6307\u5411\u8fd9\u4e2a\u5185\u5b58\u4f4d\u7f6e</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#_2","title":"\u53ef\u91cd\u5b9a\u4f4d\u76ee\u6807\u6587\u4ef6","text":"<ul> <li>.rel.*\uff1a\u4e0d\u540c\u8282\u7684\u91cd\u5b9a\u4f4d\u4fe1\u606f</li> <li>.line\uff1a\u539f\u59cb C \u7a0b\u5e8f\u548c.text \u8282\u4e2d\u673a\u5668\u6307\u4ee4\u7684\u6620\u5c04\uff0c\"-g\"\u5f97\u5230</li> </ul> <ul> <li>.bss\uff1a\u672a\u521d\u59cb\u5316\u7684\u9759\u6001\u53d8\u91cf\uff0c\u4ee5\u53ca\u521d\u59cb\u5316\u4e3a 0 \u7684\u5168\u5c40\u6216\u9759\u6001\u53d8\u91cf</li> <li>COMMON\uff1a\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#_3","title":"\u89e3\u6790\u591a\u91cd\u5b9a\u4e49\u7b26\u53f7","text":"<ul> <li>\u4e0d\u5141\u8bb8\u6709\u591a\u4e2a\u540c\u540d\u7684\u5f3a\u7b26\u53f7\uff08\u5b9a\u4e49\u5e76\u521d\u59cb\u5316\uff09</li> <li>\u5f3a\u5f31\u540c\u5728\uff0c\u9009\u5f3a\u7b26\u53f7</li> <li>\u53ea\u6709\u5f31\u7b26\u53f7\uff0c\u968f\u4fbf\u9009\u4e00\u4e2a\u5f31\u7b26\u53f7</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#_4","title":"\u91cd\u5b9a\u4f4d","text":"<ul> <li>\u91cd\u5b9a\u4f4d\u8282\u548c\u7b26\u53f7\u5b9a\u4e49</li> <li>\u5c06\u76f8\u540c\u7c7b\u578b\u7684\u8282\u5408\u5e76\u4e3a\u540c\u4e00\u7c7b\u578b\u7684\u65b0\u7684\u805a\u5408\u8282</li> <li>\u6bcf\u6761\u6307\u4ee4\u548c\u5168\u5c40\u53d8\u91cf\u6709\u552f\u4e00\u7684\u8fd0\u884c\u65f6\u5185\u5b58\u5730\u5740</li> <li>\u91cd\u5b9a\u4f4d\u8282\u7684\u7b26\u53f7\u5f15\u7528</li> <li>\u4fee\u6539\u4ee3\u7801\u8282\u548c\u6570\u636e\u8282\u4e2d\u7684\u5bf9\u7b26\u53f7\u7684\u5f15\u7528\uff0c\u6307\u5411\u6b63\u786e\u7684\u8fd0\u884c\u65f6\u5730\u5740</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#_5","title":"\u91cd\u5b9a\u4f4d\u7b97\u6cd5","text":"C<pre><code>// relocation entry\ntypedef struct {\n    long offset;    // \u91cd\u5b9a\u4f4d\u7684\u504f\u79fb\n    long type:32,   // \u91cd\u5b9a\u4f4d\u7c7b\u578b\n        symbol:32;  // \u7b26\u53f7\u8868\u7d22\u5f15\n    long addend;    // \u6709\u7b26\u53f7\u5e38\u6570\uff0c\u7528\u4e8e\u504f\u79fb\u8c03\u6574\n};\n</code></pre>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#_6","title":"\u53ef\u6267\u884c\u76ee\u6807\u6587\u4ef6","text":"","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#_7","title":"\u4f4d\u7f6e\u65e0\u5173\u4ee3\u7801","text":"<ul> <li>\u52a0\u8f7d\u4f46\u662f\u4e0d\u9700\u8981\u91cd\u5b9a\u4f4d\u4ee3\u7801\u2014\u2014\u4f4d\u7f6e\u65e0\u5173\u4ee3\u7801\uff08PIC\uff09</li> <li>gcc -fpic\uff0c\u5171\u4eab\u5e93\u7f16\u8bd1\u9700\u8981\u4f7f\u7528</li> <li>\u57fa\u4e8e.text \u548c.data \u7684\u8ddd\u79bb\u603b\u662f\u4fdd\u6301\u4e0d\u53d8</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#pic","title":"PIC \u6570\u636e\u5f15\u7528","text":"<ul> <li>\u5728\u6570\u636e\u6bb5\u5f00\u59cb\u521b\u5efa\u4e00\u4e2a\u8868\uff0c\u5168\u5c40\u504f\u79fb\u91cf\u8868\uff08Global Offset Table\uff09</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#pic_1","title":"PIC \u51fd\u6570\u8c03\u7528","text":"<ul> <li>\u5ef6\u8fdf\u7ed1\u5b9a\uff0c\u5c06\u8fc7\u7a0b\u5730\u5740\u7684\u7ed1\u5b9a\u63a8\u8fdf\u5230\u7b2c\u4e00\u6b21\u8c03\u7528\u8be5\u8fc7\u7a0b\u65f6</li> <li>\u901a\u8fc7 GOT \u548c PLT\uff08\u8fc7\u7a0b\u94fe\u63a5\u8868\uff09\u6765\u5b9e\u73b0\uff1bPLT \u662f\u4ee3\u7801\u6bb5\u7684\u8868\uff0cGOT \u662f\u6570\u636e\u6bb5\u7684\u8868</li> <li>\u901a\u8fc7\u4e24\u4e2a\u8868\u7684\u8df3\u8f6c\uff0c\u5c06\u51fd\u6570\u7684 ID \u548c\u52a8\u6001\u94fe\u63a5\u5668\u7684\u53c2\u6570\u538b\u5165\u6808\u4e2d\uff0c\u8fdb\u5165\u52a8\u6001\u94fe\u63a5\u5668\u8fdb\u884c\u91cd\u5b9a\u4f4d\u548c\u4fee\u590d\u7b26\u53f7\u6267\u884c\u7684\u5730\u5740</li> <li>\u7b2c\u4e00\u6761 PLT \u6307\u4ee4\u901a\u8fc7 GOT[4]\u8fdb\u884c\u95f4\u63a5\u8df3\u8f6c\uff1b\u8df3\u8f6c\u53ea\u662f\u8df3\u5230\u4e0b\u4e00\u6761\u6307\u4ee4</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/7-%E9%93%BE%E6%8E%A5/#_8","title":"\u5e93\u6253\u6869\u673a\u5236","text":"<ul> <li>\u8fd0\u884c\u622a\u83b7\u5bf9\u5171\u4eab\u5e93\u51fd\u6570\u7684\u8c03\u7528\uff0c\u7528\u81ea\u5df1\u7684\u51fd\u6570\u8fdb\u884c\u53d6\u4ee3</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/","title":"csapp-8-\u5f02\u5e38\u63a7\u5236\u6d41","text":"2023-09-182025-12-13 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CSAPP/8-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/#chapter-8","title":"Chapter 8 \u5f02\u5e38\u63a7\u5236\u6d41","text":"<p> \u7ea6 39 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CSAPP/%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/","title":"csapp-\u5728\u7cfb\u7edf\u4e0a\u8fd0\u884c\u7a0b\u5e8f","text":"2023-09-182025-12-13 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CSAPP/%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/#_1","title":"\u5728\u7cfb\u7edf\u4e0a\u8fd0\u884c\u7a0b\u5e8f","text":"<p> \u7ea6 395 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CSAPP/%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/#_2","title":"\u94fe\u63a5","text":"<ul> <li>gcc \u7f16\u8bd1\u94fe\u63a5\u7a0b\u5e8f\uff1acpp \u9884\u5904\u7406\u5668\u9884\u5904\u7406\u6e90\u6587\u4ef6\uff0ccc1 \u7f16\u8bd1\u5668\u7f16\u8bd1.i \u6587\u4ef6\u4e3a.S \u6587\u4ef6\uff0cas \u6c47\u7f16\u5668\u5c06.S \u6587\u4ef6\u53d8\u4e3a\u53ef\u91cd\u5b9a\u4f4d\u76ee\u6807\u6587\u4ef6.o\uff0c\u6700\u540e\u8fd0\u884c ld \u94fe\u63a5\u5668\uff0c\u521b\u5efa\u4e00\u4e2a\u53ef\u6267\u884c\u7a0b\u5e8f</li> <li>\u6267\u884c./a.out\uff0cshell \u8c03\u7528\u52a0\u8f7d\u5668\u51fd\u6570\uff0c\u5c06\u53ef\u6267\u884c\u6587\u4ef6\u7684.text \u548c.data \u590d\u5236\u5230\u5185\u5b58\u5e76\u8df3\u8f6c\u5230\u8be5\u7a0b\u5e8f\u5f00\u5934</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/#_3","title":"\u89e3\u6790\u591a\u91cd\u5b9a\u4e49\u7684\u5168\u5c40\u7b26\u53f7","text":"<ul> <li>\u89c4\u5219   1. \u4e0d\u5141\u8bb8\u591a\u4e2a\u540c\u540d\u7684\u5f3a\u7b26\u53f7   1. \u5982\u679c\u6709\u4e00\u4e2a\u5f3a\u7b26\u53f7\u548c\u591a\u4e2a\u5f31\u7b26\u53f7\u540c\u540d\uff0c\u9009\u62e9\u5f31\u7b26\u53f7   1. \u5982\u679c\u6709\u591a\u4e2a\u5f31\u7b26\u53f7\u540c\u540d\uff0c\u9009\u62e9\u5176\u4e2d\u4efb\u610f\u4e00\u4e2a</li> <li>\u94fe\u63a5\u5668\u4e0d\u4f1a\u8868\u793a\u68c0\u6d4b\u5230\u7b26\u53f7\u7684\u591a\u91cd\u5b9a\u4e49</li> <li>\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u4ea4\u7ed9 COMMON \u6bb5\uff0c\u5c06\u53ef\u80fd\u5b58\u5728\u591a\u91cd\u5b9a\u4e49\u7684\u53d8\u91cf\u4ea4\u7ed9\u94fe\u63a5\u5668\u8fdb\u884c\u88c1\u51b3</li> <li>\u672a\u521d\u59cb\u5316\u7684\u9759\u6001\u53d8\u91cf\uff0c\u521d\u59cb\u5316\u4e3a 0 \u7684\u9759\u6001\u6216\u5168\u5c40\u53d8\u91cf\u5728.bss \u6bb5\uff1b\u5168\u5c40\u53d8\u91cf\u521d\u59cb\u5316\u4e3a 0 \u662f\u4e00\u4e2a\u5f3a\u7b26\u53f7</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/#_4","title":"\u4e0e\u9759\u6001\u94fe\u63a5\u5e93\u94fe\u63a5","text":"<ul> <li>\u94fe\u63a5\u5668\u5c06\u53ea\u590d\u5236\u88ab\u7a0b\u5e8f\u5f15\u7528\u7684\u76ee\u6807\u6a21\u5757</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F/#_5","title":"\u52a8\u6001\u94fe\u63a5\u5171\u4eab\u5e93","text":"<ul> <li>\u94fe\u63a5\u5668\u590d\u5236\u4e86.so \u6587\u4ef6\u7684\u91cd\u5b9a\u4f4d\u548c\u7b26\u53f7\u8868\u4fe1\u606f</li> <li>\u5728\u53ef\u6267\u884c\u6587\u4ef6\u52a0\u8f7d\u540e\uff0c\u5b58\u5728.interp \u8282\uff0c\u52a0\u8f7d\u52a8\u6001\u94fe\u63a5\u5668(ld-linux.so)\uff1b\u52a8\u6001\u94fe\u63a5\u5668\u672c\u8eab\u4e0d\u80fd\u4f9d\u8d56\u4efb\u4f55\u52a8\u6001\u5e93\uff0c\u6240\u6709\u5b83\u662f\u9759\u6001\u94fe\u63a5\u7684</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%BB%93%E6%9E%84%E5%92%8C%E6%89%A7%E8%A1%8C/","title":"csapp-\u7a0b\u5e8f\u7684\u7ed3\u6784\u548c\u6267\u884c","text":"2023-09-182025-12-13 <code>#System Arch</code>","tags":["System Arch"]},{"location":"notes/CSAPP/%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%BB%93%E6%9E%84%E5%92%8C%E6%89%A7%E8%A1%8C/#_1","title":"\u7a0b\u5e8f\u7684\u7ed3\u6784\u548c\u6267\u884c","text":"<p> \u7ea6 364 \u4e2a\u5b57  33 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["System Arch"]},{"location":"notes/CSAPP/%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%BB%93%E6%9E%84%E5%92%8C%E6%89%A7%E8%A1%8C/#_2","title":"\u7a0b\u5e8f\u7684\u673a\u5668\u7ea7\u8868\u793a","text":"<ul> <li>\u4f7f\u7528\u57fa\u4e8e\u6761\u4ef6\u7684\u6570\u636e\u4f20\u9001\u66ff\u4ee3\u57fa\u4e8e\u6761\u4ef6\u7684\u63a7\u5236\u8f6c\u79fb</li> </ul> C<pre><code>// \u57fa\u4e8e\u6761\u4ef6\u7684\u6570\u636e\u4f20\u9001\nint ntest = x &gt;= y;\nif (ntest) {\n    ...\n} else {\n    ...\n}\n\n// \u57fa\u4e8e\u6761\u4ef6\u7684\u63a7\u5236\u8f6c\u79fb\nif (x &gt;y) {\n\n} else {\n\n}\n</code></pre> <ul> <li> <p>while \u7684\u4e24\u79cd\u6c47\u7f16\u5f62\u5f0f</p> </li> <li> <p>jump to the middle</p> C<pre><code>    go to test;\nloop:\n    body\ntest:\n    t = test-expr;\n    if (t){\n        goto loop;\n    }\n</code></pre> </li> <li> <p>guarded-do</p> C<pre><code>t = test-expr;\nif(!t){\n    goto done;\n}\nloop:\n    body\n    t = test-expr;\n    if(t) {\n        goto loop;\n    }\ndone:\n</code></pre> </li> <li> <p>\u5bf9\u6297\u7f13\u51b2\u533a\u6ea2\u51fa\u653b\u51fb</p> </li> <li> <p>\u5730\u5740\u7a7a\u95f4\u5e03\u5c40\u968f\u673a\u5316\uff1a\u6808\u968f\u673a\u5316\uff0c\u6bcf\u6b21\u5148\u5728\u6808\u4e0a\u968f\u673a\u5206\u914d\u4e00\u5927\u5757\u7a7a\u95f4\uff1b\u7a0b\u5e8f\u6bcf\u6b21\u52a0\u8f7d\u5730\u5740\u4e0d\u540c</p> </li> <li>\u6808\u7834\u574f\u68c0\u6d4b\uff1a\u5728\u6808\u5e27\u4e0e\u6808\u72b6\u6001\u95f4\u5b58\u653e\u4e00\u4e2a\u7279\u6b8a\u7684<code>\u91d1\u4e1d\u96c0</code>\u503c</li> <li>\u9650\u5236\u53ef\u6267\u884c\u4ee3\u7801\u533a\u57df</li> </ul>","tags":["System Arch"]},{"location":"notes/CSAPP/%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%BB%93%E6%9E%84%E5%92%8C%E6%89%A7%E8%A1%8C/#_3","title":"\u4f18\u5316\u7a0b\u5e8f\u6027\u80fd","text":"<ul> <li>\u4f18\u5316\u7f16\u8bd1\u5668\u7684\u80fd\u529b\u548c\u5c40\u9650\u6027</li> <li>\u786e\u5b9a\u4e24\u4e2a\u6307\u9488\u662f\u5426\u6307\u5411\u4e0d\u540c\u7684\u5185\u5b58<code>restrict</code>\u5173\u952e\u5b57</li> <li>\u5185\u8054\u51fd\u6570\u66ff\u6362\u51fd\u6570\u8c03\u7528</li> <li>\u6d88\u9664\u5faa\u73af\u7684\u4f4e\u6548\u7387</li> <li>\u5c06\u67d0\u4e9b\u5b9a\u957f\u7684\u5e93\u51fd\u6570\u7ed3\u679c\u79fb\u9664\u5faa\u73af</li> <li>\u51cf\u5c11\u8fc7\u7a0b\u8c03\u7528</li> <li>\u6d88\u9664\u4e0d\u5fc5\u8981\u7684\u5185\u5b58\u5f15\u7528</li> <li>\u4f7f\u7528\u4e34\u65f6\u53d8\u91cf\u66ff\u4ee3\u6307\u9488</li> <li>\u5faa\u73af\u5c55\u5f00</li> <li>\u63d0\u9ad8\u7a0b\u5e8f\u5e76\u884c\u6027\uff1a\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 SIMD \u5411\u91cf\u6307\u4ee4</li> <li>\u5bf9 dst \u548c src \u5730\u5740\u76f8\u540c\u7684\u53d6\u503c\u64cd\u4f5c\uff0c\u9020\u6210\u5199/\u8bfb\u76f8\u5173\u95ee\u9898</li> <li>\u5b58\u50a8\u5355\u5143\u4e2d\u5b58\u5728\u5b58\u50a8\u7f13\u51b2\u533a\uff0c\u6bcf\u4e2a\u7f13\u5b58\u533a\u7531\u5730\u5740<code>s_addr</code>\u548c\u6570\u636e<code>s_data</code>\u7ec4\u6210\uff1b<code>src</code>\u548c<code>dst</code>\u4e0d\u540c\u65f6\uff0c\u6570\u636e\u548c\u5730\u5740\u53ef\u4ee5\u5e76\u884c\u53d6\u51fa\uff0c\u5982\u679c\u76f8\u540c\uff0c\u5fc5\u987b\u4fdd\u8bc1<code>s_addr</code>\u5728<code>s_data</code>\u524d\u5b8c\u6210</li> </ul>","tags":["System Arch"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/","title":"C++-\u6cdb\u578b\u7b97\u6cd5","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_1","title":"\u6cdb\u578b\u7b97\u6cd5","text":"<p> \u7ea6 949 \u4e2a\u5b57  24 \u884c\u4ee3\u7801  9 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_2","title":"\u6982\u8ff0","text":"<ul> <li>\u4e0d\u76f4\u63a5\u64cd\u4f5c\u5bb9\u5668\uff0c\u904d\u5386\u7531\u4e24\u4e2a\u8fed\u4ee3\u5668\u6307\u5b9a\u7684\u4e00\u4e2a\u5143\u7d20\u8303\u56f4\u8fdb\u884c\u64cd\u4f5c</li> <li>\u8fed\u4ee3\u5668\u4ee4\u7b97\u6cd5\u4e0d\u4f9d\u8d56\u4e8e\u5bb9\u5668</li> <li>\u7b97\u6cd5\u4f9d\u8d56\u4e8e\u5143\u7d20\u7c7b\u578b\u7684\u64cd\u4f5c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_3","title":"\u521d\u8bc6\u6cdb\u578b\u7b97\u6cd5","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_4","title":"\u53ea\u8bfb\u7b97\u6cd5","text":"<ul> <li> <p>find</p> </li> <li> <p>accumulate</p> </li> </ul> C++<pre><code>int sum = accumulate(vec.begin(),vec.end(), 0);   // \u7b2c\u4e09\u4e2a\u53c2\u6570\u662f\u548c\u7684\u521d\u503c\nstring sum = accumulate(v.cbegin(), v.cend(), string(\"\")); // string\u5b9a\u4e49\u4e86+\u8fd0\u7b97\u7b26\n</code></pre> <ul> <li> <p>count</p> </li> <li> <p>equal\uff1a\u786e\u5b9a\u4e24\u4e2a\u5e8f\u5217\u662f\u5426\u4fdd\u5b58\u76f8\u540c\u7684\u503c\uff0c\u63a5\u53d7\u4e09\u4e2a\u8fed\u4ee3\u5668\uff1b\u5047\u5b9a\u6bcf\u4e2a\u5143\u7d20\u5728\u7b2c\u4e8c\u4e2a\u5e8f\u5217\u4e2d\u90fd\u6709\u4e00\u4e2a\u4e0e\u4e4b\u5bf9\u5e94\u7684\u5143\u7d20\uff08\u7b2c\u4e8c\u4e2a\u5e8f\u5217\u81f3\u5c11\u4e0e\u7b2c\u4e00\u4e2a\u5e8f\u5217\u4e00\u6837\u957f\uff09</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_5","title":"\u5199\u5bb9\u5668\u7b97\u6cd5","text":"<ul> <li>fill\uff1a\u63a5\u53d7\u4e00\u5bf9\u8fed\u4ee3\u5668\u8868\u793a\u4e00\u4e2a\u8303\u56f4\uff0c\u8fd8\u63a5\u6536\u4e00\u4e2a\u503c\u4f5c\u4e3a\u7b2c\u4e09\u4e2a\u53c2\u6570\uff1bfill\u5c06\u7b2c\u4e09\u4e2a\u503c\u8d4b\u4e88\u8f93\u5165\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20</li> </ul> C++<pre><code>fill(vec.begin(), vec.end(), 0);\n</code></pre> <ul> <li>\u4f7f\u7528\u63d2\u5165\u8fed\u4ee3\u5668\u6765\u4fdd\u8bc1\u7b97\u6cd5\u6709\u8db3\u591f\u5143\u7d20\u7a7a\u95f4\u6765\u5bb9\u7eb3\u8f93\u51fa\u6570\u636e\u7684\u65b9\u6cd5</li> </ul> C++<pre><code>vector&lt;int&gt; vec;\nfill_n(back_iterator(vec), 10, 0);\n// \u6bcf\u6b21\u8d4b\u503c\u5c06\u5728vec\u4e0a\u8c03\u7528push_back\uff0c\u6bcf\u4e2a\u5143\u7d20\u503c\u4e3a0\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_6","title":"\u62f7\u8d1d\u7b97\u6cd5","text":"<ul> <li>\u63a5\u53d7\u4e09\u4e2a\u53c2\u6570\uff0c\u524d\u4e24\u4e2a\u8868\u793a\u4e00\u4e2a\u8f93\u5165\u8303\u56f4\uff0c\u7b2c\u4e09\u4e2a\u8868\u793a\u76ee\u7684\u5e8f\u5217\u7684\u8d77\u59cb\u4f4d\u7f6e</li> </ul> C++<pre><code>int a1[] = {0,1,2,3,4,5,6,7,8,9};\nint a2[sizeof(a1) / sizeof(*a1)];\nauto ret = copy(begin(a1), end(a1), a2);\n// copy\u8fd4\u56de\u7684\u662f\u76ee\u7684\u4f4d\u7f6e\u8fed\u4ee3\u5668\uff08\u9012\u589e\u540e\uff09\u7684\u503c\uff1b\u5c3e\u5143\u7d20\u540e\u9762\u7684\u4f4d\u7f6e\n</code></pre> <ul> <li>replace(ilist.begin(), ilist.end(), 0, 42)\uff1a\u5c06\u6240\u67090\u7684\u5143\u7d20\u6539\u4e3a42</li> <li>replace_copy(ilist.cbegin(), ilist.cend(), back_iterator(ivec), 0, 42)\uff1a\u4e0d\u6539\u53d8\u539f\u6765\u7684\u5e8f\u5217\uff0c\u5728ivec\u4e2d\u4e3a0\u7684\u5143\u7d20\u6539\u4e3a42</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_7","title":"\u91cd\u6392\u5bb9\u5668\u5143\u7d20\u7684\u7b97\u6cd5","text":"<ul> <li>sort(words.begin(), words.end())</li> <li>unique\uff1a\u91cd\u6392\u8f93\u5165\u5e8f\u5217\uff0c\u5c06\u76f8\u90bb\u7684\u91cd\u590d\u9879\u201c\u6d88\u9664\u201d\uff1b\u8fd4\u56de\u4e00\u4e2a\u6307\u5411\u4e0d\u91cd\u590d\u503c\u8303\u56f4\u672b\u5c3e\u7684\u8fed\u4ee3\u5668\uff08\u6700\u540e\u4e00\u4e2a\u4e0d\u91cd\u590d\u5143\u7d20\u4e4b\u540e\u7684\u4f4d\u7f6e\uff09</li> </ul> <p>\u7b97\u6cd5\u6839\u672c\u4e0d\u77e5\u9053\u5bb9\u5668\u7684\u5b58\u5728\uff0c\u7b97\u6cd5\u5728\u8fed\u4ee3\u5668\u4e0a\u8fdb\u884c\u64cd\u4f5c\uff1bfill_n\u5bf9\u5bb9\u5668\u8fdb\u884c\u63d2\u5165\uff0c\u4e5f\u662f\u5728back_iterator\u4e0a\u8fdb\u884c\u7684\uff0c\u800c\u8be5\u8fed\u4ee3\u5668\u5411\u5bb9\u5668\u63d2\u5165\u5143\u7d20</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_8","title":"\u5b9a\u5236\u64cd\u4f5c","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_9","title":"\u5411\u7b97\u6cd5\u4f20\u9012\u53c2\u6570","text":"<ul> <li>\u8c13\u8bcd\uff1a\u4e00\u4e2a\u53ef\u8c03\u7528\u7684\u8868\u8fbe\u5f0f\uff0c\u8fd4\u56de\u7ed3\u679c\u662f\u4e00\u4e2a\u80fd\u7528\u4f5c\u6761\u4ef6\u7684\u503c\u3002\u6807\u51c6\u5e93\u6240\u7528\u7b97\u6cd5\u5206\u4e3a\u4e00\u5143\u8c13\u8bcd\u548c\u4e8c\u5143\u8c13\u8bcd</li> </ul> C++<pre><code>bool cmp(const string &amp;s1, const string &amp;s2) {\n    return s1.size() &lt; s2.size();\n}\nsort(words.begin(), words.end(), cmp);\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#lambda","title":"lambda\u8868\u8fbe\u5f0f","text":"<ul> <li>\u4e00\u4e2alambda\u53ea\u6709\u5728\u6355\u83b7\u5217\u8868\u4e2d\u6355\u83b7\u4e00\u4e2a\u5b83\u6240\u5728\u51fd\u6570\u4e2d\u7684\u5c40\u90e8\u53d8\u91cf\uff0c\u624d\u80fd\u5728\u51fd\u6570\u4f53\u4e2d\u4f7f\u7528\u8be5\u53d8\u91cf</li> <li>\u5c3d\u91cf\u4fdd\u6301lambda\u7684\u53d8\u91cf\u6355\u83b7\u7b80\u5355\u5316</li> <li>\u6355\u83b7\u4e00\u4e2a\u666e\u901a\u53d8\u91cf\uff0c\u5982int\uff0cstring\u6216\u5176\u4ed6\u975e\u6307\u9488\u7c7b\u578b\uff1b\u53ef\u4ee5\u91c7\u7528\u7b80\u5355\u7684\u503c\u6355\u83b7</li> <li>\u6355\u83b7\u4e00\u4e2a\u6307\u9488\u6216\u8fed\u4ee3\u5668\uff0c\u6216\u91c7\u7528\u5f15\u7528\u6355\u83b7\u65b9\u5f0f\uff0c\u5fc5\u987b\u786e\u4fdd\u5728lambda\u6267\u884c\u65f6\uff1b\u7ed1\u5b9a\u5230\u8fed\u4ee3\u5668\u3001\u6307\u9488\u6216\u5f15\u7528\u7684\u5bf9\u8c61\u4ecd\u7136\u5b58\u5728\u540c\u65f6\u4fdd\u8bc1\u5bf9\u8c61\u5177\u6709\u9884\u671f\u7684\u503c\uff1b\u5e94\u8be5\u907f\u514d\u6355\u83b7\u5f15\u7528\u548c\u6307\u9488</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#lambda_1","title":"\u53ef\u53d8lambda","text":"<ul> <li>\u5bf9\u4e8e\u4e00\u4e2a\u503c\u88ab\u62f7\u8d1d\u7684\u53d8\u91cf\uff0clambda\u4e0d\u4f1a\u6539\u53d8\u5176\u503c\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u6539\u53d8\u4e00\u4e2a\u88ab\u6355\u83b7\u7684\u53d8\u91cf\u7684\u503c\uff1b\u5fc5\u987b\u5728\u53c2\u6570\u5217\u8868\u9996\u52a0\u4e0amutable</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#lambda_2","title":"\u6307\u5b9alambda\u8fd4\u56de\u503c\u7c7b\u578b","text":"C++<pre><code>transform(vi.begin(), vi.end(), [](int i)-&gt;int {if(i &gt; 0) return -i; else return i;});\n    auto lambda = [&amp;ncref = n, n](auto a, auto b, auto /*unused*/)\n    {\n        f(b, 42, a, ncref, n);\n    };\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_10","title":"\u53c2\u6570\u7ed1\u5b9a","text":"<ul> <li>bind\u6807\u51c6\u5e93\u51fd\u6570\uff0c\u5b9a\u4e49\u5728\u5934\u6587\u4ef6functional\u4e2d\uff1b</li> <li>\u53ef\u4ee5\u770b\u4f5c\u901a\u7528\u7684\u51fd\u6570\u9002\u914d\u5668\uff1b\u63a5\u53d7\u4e00\u4e2a\u53ef\u8c03\u7528\u5bf9\u8c61\uff0c\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u53ef\u8c03\u7528\u5bf9\u8c61</li> </ul> C++<pre><code>auto newCallable = bind(callable, arg_list);\n</code></pre> <ul> <li>\u4f7f\u7528placeholders\u547d\u540d\u7a7a\u95f4\uff0c_1, _2..._n</li> <li>\u51fd\u6570\u6a21\u677f <code>std::mem_fn</code> \u751f\u6210\u6307\u5411\u6210\u5458\u6307\u9488\u7684\u5305\u88c5\u5bf9\u8c61\uff0c\u5b83\u53ef\u4ee5\u5b58\u50a8\u3001\u590d\u5236\u53ca\u8c03\u7528\u6307\u5411\u6210\u5458\u6307\u9488\u3002\u5230\u5bf9\u8c61\u7684\u5f15\u7528\u548c\u6307\u9488\uff08\u542b\u667a\u80fd\u6307\u9488\uff09\u53ef\u5728\u8c03\u7528 <code>std::mem_fn</code> \u65f6\u4f7f\u7528\u3002</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_11","title":"\u518d\u63a2\u8fed\u4ee3\u5668","text":"<ul> <li>\u63d2\u5165\u8fed\u4ee3\u5668</li> <li>\u6d41\u8fed\u4ee3\u5668\uff1a\u7ed1\u5b9a\u5230\u8f93\u5165\u6216\u8f93\u51fa\u6d41\u4e0a</li> <li>\u53cd\u5411\u8fed\u4ee3\u5668\uff1a\u5411\u540e\u79fb\u52a8</li> <li>\u79fb\u52a8\u8fed\u4ee3\u5668\uff1a\u4e0d\u62f7\u8d1d\u5143\u7d20\u800c\u662f\u79fb\u52a8\u5143\u7d20</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_12","title":"\u63d2\u5165\u8fed\u4ee3\u5668","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#iostream","title":"iostream\u8fed\u4ee3\u5668","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_13","title":"\u53cd\u5411\u8fed\u4ee3\u5668","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_14","title":"\u6cdb\u578b\u7b97\u6cd5\u7ed3\u6784","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_15","title":"\u7279\u5b9a\u5bb9\u5668\u7b97\u6cd5","text":"<ul> <li>\u5bf9\u4e8elist\u548cforward_list\uff0c\u5e94\u8be5\u4f18\u5148\u4f7f\u7528\u6210\u5458\u51fd\u6570\u7248\u672c\u7684\u7b97\u6cd5\u800c\u4e0d\u662f\u901a\u7528\u7b97\u6cd5</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#splice","title":"splice\u6210\u5458","text":"<ul> <li>\u94fe\u8868\u6570\u636e\u7ed3\u6784\u6240\u7279\u6709\u7684</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_16","title":"\u94fe\u8868\u7279\u6709\u64cd\u4f5c\u4f1a\u6539\u53d8\u5bb9\u5668","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/10_%E6%B3%9B%E5%9E%8B%E7%AE%97%E6%B3%95/#_17","title":"\u53ef\u53d8\u53c2\u6570\u6a21\u677f","text":"C++<pre><code>    template&lt;typename... Args&gt; int add_many(Args... args)\n    {\n        return data + (args + ...);\n    }\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/","title":"C++-\u5173\u8054\u5bb9\u5668","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_1","title":"\u5173\u8054\u5bb9\u5668","text":"<p> \u7ea6 561 \u4e2a\u5b57  60 \u884c\u4ee3\u7801  10 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <ul> <li>\u5173\u8054\u5bb9\u5668\u652f\u6301\u9ad8\u6548\u7684\u5173\u952e\u5b57\u67e5\u627e\u548c\u8bbf\u95ee\uff1b\u4e3b\u8981\u7684\u4e24\u4e2a\u5173\u8054\u5bb9\u5668\u662fmap\u548cset</li> </ul> <p></p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_2","title":"\u4f7f\u7528\u5173\u8054\u5bb9\u5668","text":"<ul> <li>set\u548cmap\u7684\u4f7f\u7528</li> </ul> C++<pre><code>map&lt;string, size_t&gt; word_cnt;\nset&lt;string&gt; exclude = {\"The\", \"But\"};\n\nstring word;\nwhile(cin &gt;&gt; word)\n    // \u53ea\u7edf\u8ba1\u4e0d\u5728exclude\u4e2d\u7684\u5355\u8bcd\n    if(exclude.find(word) == exclude.end())\n        ++word_cnt[word];\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_3","title":"\u6982\u8ff0","text":"<ul> <li>\u5173\u8054\u5bb9\u5668\u4e0d\u652f\u6301\u987a\u5e8f\u5bb9\u5668\u7684\u4f4d\u7f6e\u76f8\u5173\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982push_front\u6216push_back\uff1b\u56e0\u4e3a\u5173\u8054\u5bb9\u5668\u662f\u901a\u8fc7\u5173\u952e\u5b57\u5b58\u50a8\u7684</li> <li>\u5173\u8054\u5bb9\u5668\u4e0d\u652f\u6301\u6784\u9020\u51fd\u6570\u6216\u63d2\u5165\u64cd\u4f5c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_4","title":"\u5173\u952e\u5b57\u7c7b\u578b\u8981\u6c42","text":"<ul> <li>\u6709\u5e8f\u5bb9\u5668\uff1a\u4e25\u683c\u5f31\u5e8f\uff1b\u53ef\u4ee5\u770b\u4f5c\u5c0f\u4e8e\u7b49\u4e8e</li> <li>\u4f7f\u7528\u81ea\u5df1\u7684\u5b9a\u4e49\u64cd\u4f5c\uff0c\u5b9a\u4e49\u65f6\u9700\u8981\u4f20\u9012\u7b2c\u4e8c\u4e2a\u53c2\u6570\uff08\u4e00\u79cd\u51fd\u6570\u6307\u9488\uff09</li> </ul> C++<pre><code>bool cmp(const Sales_data &amp;lhs, const Sales_data &amp;rhs)\n{\n    return lhs.isbn() &lt; rhs.isbn();\n}\n// \u6216\u8005\u4f7f\u7528\u4e00\u4e2a\u4eff\u51fd\u6570\u8fdb\u884c\u6bd4\u8f83\u64cd\u4f5c(\u53c2\u6570\u548c\u8fd4\u56de\u503c\u90fd\u5fc5\u987b\u4f7f\u7528const\u4fee\u9970)\nstruct cmp {\n    bool operator()(const int a, const int b) const {\n        return a &gt; b;\n    }\n};\nset&lt;int, cmp&gt; st;\nmap&lt;int, int, cmp&gt; mp;\n\nmultiset&lt;Sales_data, decltype(cmp)*&gt; bookstore(cmp);\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#pair","title":"pair\u7c7b\u578b","text":"C++<pre><code>pair&lt;string, int&gt; process(vector&lt;string&gt; &amp;v)\n{\n    if(!v.empty())\n        return {v.back(), v.back().size()};\n    else \n        return pair&lt;string, int&gt;(); // \u9690\u5f0f\u6784\u9020\u8fd4\u56de\u503c\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_5","title":"\u5173\u8054\u5bb9\u5668\u64cd\u4f5c","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_6","title":"\u5173\u8054\u5bb9\u5668\u8fed\u4ee3\u5668","text":"<ul> <li>\u89e3\u5f15\u7528\u5f97\u5230\u4e00\u4e2avalue_type\u7684\u503c\u7684\u5f15\u7528\uff1b\u4e0d\u80fd\u6539\u53d8\u5173\u952e\u5b57\u6210\u5458</li> <li>set\u7684\u8fed\u4ee3\u5668\u662fconst\u7684</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_7","title":"\u904d\u5386\u5173\u8054\u5bb9\u5668","text":"C++<pre><code>// \u83b7\u5f97\u4e00\u4e2a\u6307\u5411\u9996\u5143\u7d20\u7684\u8fed\u4ee3\u5668\nauto map_it = word_cnt.cbegin();\nwhile(map_it != word_cnt.cend())\n{\n    cout &lt;&lt; map_it-&gt;first &lt;&lt; map_it-&gt;second &lt;&lt; endl;\n    ++map_it;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_8","title":"\u6dfb\u52a0\u5143\u7d20","text":"<p>```c++ se vector ivec = {2,2,3,4}; set set2; set2.insert(ivec.cbegin(), ivec.cend());    // set2 has 3 elements set2.insert({1,1,2,3});                     // set2 has 4 elements</p> <p>// map\u64cd\u4f5c\uff0c\u6dfb\u52a0\u5143\u7d20\u7684\u7c7b\u578b\u662fpair word_count.insert({word, 1}); word_count.insert(make_pair(word, 1)); word_count.insert(pair(word, 1)); word_count.insert(map::value_type(word, 1)); </p>Text Only<pre><code>![](https://github.com/tom-jerr/MyblogImg/raw/main/C++/IO/insert_related_iter.png)\n\n- insert\u8fd4\u56de\u503c\u662f\u4e00\u4e2apair\uff0c\u7b2c\u4e00\u4e2a\u503c\u662f\u4e00\u4e2a\u8fed\u4ee3\u5668\uff0c\u6307\u5411\u5177\u6709\u5173\u952e\u5b57\u7684\u5143\u7d20\uff1b\u7b2c\u4e8c\u4e2a\u662f\u4e00\u4e2abool\u503c\n\n```c++\npair&lt;map&lt;string, size_t&gt;::iterator, bool&gt; ret = word_cnt.insert(make_pair(word, 1));\n</code></pre><p></p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_9","title":"\u5220\u9664\u5143\u7d20","text":"<ul> <li>\u63a5\u53d7\u4e00\u4e2a\u8fed\u4ee3\u5668\uff0c\u4e00\u5bf9\u8fed\u4ee3\u5668\u548c\u4e00\u4e2akey_type\u7684\u53c2\u6570</li> <li>erase</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#map","title":"map\u7684\u4e0b\u6807\u64cd\u4f5c","text":"<ul> <li>\u63d0\u4f9b\u4e86\u4e0b\u6807\u8fd0\u7b97\u7b26\u548cat\u64cd\u4f5c</li> </ul> <ul> <li>map\u89e3\u5f15\u7528\u8fd4\u56devalue_type\u5bf9\u8c61\uff1b\u4e0b\u6807\u8fd4\u56demapped_type\u5bf9\u8c61</li> <li>\u7531\u4e8e\u4e0b\u6807\u8fd0\u7b97\u7b26\u53ef\u80fd\u4f1a\u63d2\u5165\u4e00\u4e2a\u65b0\u5143\u7d20\uff0c\u53ea\u80fd\u5bf9\u975econst\u7684map\u4f7f\u7528\u4e0b\u6807\u64cd\u4f5c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_10","title":"\u8bbf\u95ee\u5143\u7d20","text":"<ul> <li>\u5982\u679clower_bound\u548cupper_bound\u8fd4\u56de\u76f8\u540c\u7684\u8fed\u4ee3\u5668\uff0c\u7ed9\u5b9a\u5173\u952e\u5b57\u4e0d\u5728\u5bb9\u5668\u4e2d</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_11","title":"\u65e0\u5e8f\u5bb9\u5668","text":"<ul> <li>\u4e0d\u4f7f\u7528\u6bd4\u8f83\u8fd0\u7b97\u7b26\u7ec4\u7ec7\u5143\u7d20\uff0c\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u54c8\u5e0c\u51fd\u6570\u548c\u5173\u952e\u5b57\u7c7b\u578b\u7684==\u8fd0\u7b97\u7b26\u6765\u7ec4\u7ec7\u5143\u7d20</li> <li>\u5982\u679c\u5173\u952e\u5b57\u672c\u8eab\u65e0\u5e8f\uff0c\u53ef\u4ee5\u7528\u54c8\u5e0c\u89e3\u51b3\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u65e0\u5e8f\u5bb9\u5668</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_12","title":"\u7ba1\u7406\u6876","text":"<ul> <li>\u65e0\u5e8f\u5bb9\u5668\u5b58\u50a8\u4e0a\u7ec4\u7ec7\u4e3a\u4e00\u7ec4\u6876\uff0c\u6bcf\u4e2a\u6876\u4fdd\u5b580\u6216\u591a\u4e2a\u5143\u7d20</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_13","title":"\u65e0\u5e8f\u5bb9\u5668\u5bf9\u5173\u952e\u5b57\u7c7b\u578b\u7684\u8981\u6c42","text":"<ul> <li>\u4f7f\u7528\u4e00\u4e2ahash\\\u7c7b\u578b\u7684\u5bf9\u8c61\u6765\u751f\u6210\u6bcf\u4e2a\u5143\u7d20\u7684hash\u503c</li> </ul> C++<pre><code>// \u9700\u8981\u63d0\u4f9b\u51fd\u6570\u66ff\u4ee3==\u8fd0\u7b97\u7b26\u548chash\u503c\u8ba1\u7b97\u51fd\u6570\nsize_t hasher(const Sales_data &amp;sd)\n{\n    return hash&lt;string&gt;() (sd.isbn());\n}\n\nbool eqOp(const Sales_data &amp;lhs, const Sales_data &amp;rhs)\n{\n    return lhs.isbn() == rhs.isbn();\n}\n\nusing SD_multiset = unordered_multiset&lt;Sales_data, decltype(hasher)*, decltype(eqOp)*&gt;;\nSD_multiset bookstore(42, hasher, eqOp);\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/11_%E5%85%B3%E8%81%94%E5%AE%B9%E5%99%A8/#_14","title":"\u65e0\u5e8f\u5bb9\u5668\u548c\u6709\u5e8f\u7248\u672c\u4f18\u52bf","text":"<ul> <li>\u65e0\u5e8f\u7248\u672c\u6027\u80fd\u66f4\u597d\uff0c\u4f7f\u7528\u66f4\u7b80\u5355</li> <li>\u6709\u5e8f\u7248\u672c\u7ef4\u62a4\u4e86\u5173\u952e\u5b57\u7684\u5e8f</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/","title":"C++-\u52a8\u6001\u5185\u5b58","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_1","title":"\u52a8\u6001\u5185\u5b58","text":"<p> \u7ea6 1804 \u4e2a\u5b57  270 \u884c\u4ee3\u7801  8 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 12 \u5206\u949f</p> <ul> <li>\u9759\u6001\u5185\u5b58\u4fdd\u5b58\u5c40\u90e8static\u5bf9\u8c61\uff0c\u7c7bstatic\u6570\u636e\u6210\u5458\u4ee5\u53ca\u4efb\u4f55\u5b9a\u4e49\u5728\u4efb\u4f55\u51fd\u6570\u4e4b\u5916\u7684\u53d8\u91cf</li> <li>\u5168\u5c40\u5bf9\u8c61\u7a0b\u5e8f\u542f\u52a8\u65f6\u5206\u914d\uff0c\u5728\u7a0b\u5e8f\u7ed3\u675f\u65f6\u9500\u6bc1</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_2","title":"\u52a8\u6001\u5185\u5b58\u4e0e\u667a\u80fd\u6307\u9488","text":"<ul> <li> <p>\u6bcf\u4e2a\u7a0b\u5e8f\u6709\u4e00\u4e2a\u5185\u5b58\u6c60\uff0c\u53eb\u505a\u81ea\u7531\u7a7a\u95f4\u6216\u5806</p> </li> <li> <p>\u52a8\u6001\u5bf9\u8c61\u7684\u751f\u5b58\u671f\u7531\u7a0b\u5e8f\u6765\u63a7\u5236</p> </li> <li> <p>\u667a\u80fd\u6307\u9488\u8d1f\u8d23\u81ea\u52a8\u91ca\u653e\u6240\u6307\u5411\u7684\u5bf9\u8c61</p> </li> <li> <p>share_ptr\u5141\u8bb8\u591a\u4e2a\u6307\u9488\u6307\u5411\u540c\u4e00\u4e2a\u5bf9\u8c61</p> </li> <li>unique_ptr\u5219\u201c\u72ec\u5360\u201d\u6240\u6307\u5411\u7684\u5bf9\u8c61</li> <li>weak_ptr\u662f\u4e00\u79cd\u5f31\u5f15\u7528\uff0c\u6307\u5411shared_ptr\u6240\u7ba1\u7406\u7684\u5bf9\u8c61</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#shared_ptr","title":"shared_ptr\u7c7b","text":"<ul> <li>\u662f\u4e00\u4e2a\u6a21\u677f\uff0c\u9ed8\u8ba4\u521d\u59cb\u5316\u7684\u667a\u80fd\u6307\u9488\u4e2d\u4fdd\u5b58\u7740\u4e00\u4e2a\u7a7a\u6307\u9488</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#make_shared","title":"make_shared","text":"<ul> <li>\u6700\u5b89\u5168\u7684\u5206\u914d\u548c\u4f7f\u7528\u52a8\u6001\u5185\u5b58\u7684\u65b9\u6cd5</li> <li>\u5728\u52a8\u6001\u5185\u5b58\u4e2d\u5206\u914d\u4e00\u4e2a\u5bf9\u8c61\u5e76\u521d\u59cb\u5316\u5b83\uff1b\u8fd4\u56de\u6307\u5411\u8be5\u5bf9\u8c61\u7684shared_ptr</li> </ul> C++<pre><code>shared_ptr&lt;int&gt; p3 = make_shared&lt;int&gt;(42);\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#shared_ptr_1","title":"shared_ptr\u7684\u62f7\u8d1d\u548c\u8d4b\u503c","text":"<ul> <li>\u8fdb\u884c\u62f7\u8d1d\u6216\u8d4b\u503c\u64cd\u4f5c\u65f6\uff0c\u6bcf\u4e2ashared_ptr\u4f1a\u8bb0\u5f55\u6709\u591a\u5c11\u4e2a\u5176\u4ed6shared_ptr\u6307\u5411\u76f8\u540c\u7684\u5bf9\u8c61</li> </ul> C++<pre><code>auto p = make_shared&lt;int&gt;(42);  // p\u6307\u5411\u7684\u5bf9\u8c61\u53ea\u6709p\u4e00\u4e2a\u5f15\u7528\u8005\nauto q(p);                      // p\u548cq\u6307\u5411\u76f8\u540c\u5bf9\u8c61\uff1b\u8be5\u5bf9\u8c61\u6709\u4e24\u4e2a\u5f15\u7528\u8005\n</code></pre> <ul> <li>\u7528\u4e00\u4e2ashared_ptr\u521d\u59cb\u5316\u53e6\u4e00\u4e2ashared_ptr\uff0c\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\uff0c\u4f5c\u4e3a\u8fd4\u56de\u503c\u8fd4\u56de\uff1b\u6240\u5173\u8054\u7684\u8ba1\u6570\u5668\u4f1a\u9012\u589e</li> <li>\u4e3ashared_ptr\u8d4b\u65b0\u503c\uff0cshared_ptr\u88ab\u9500\u6bc1\uff1b\u8ba1\u6570\u5668\u9012\u51cf\uff1b\u8ba1\u6570\u5668\u53d8\u4e3a0\uff0c\u6307\u9488\u81ea\u52a8\u91ca\u653e\u5bf9\u8c61</li> <li>shared_ptr\u81ea\u52a8\u9500\u6bc1\u7ba1\u7406\u7684\u5bf9\u8c61\uff1b\u81ea\u52a8\u91ca\u653e\u76f8\u5173\u8054\u7684\u5185\u5b58</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_3","title":"\u5f15\u7528\u8ba1\u6570\u589e\u52a0","text":"<ul> <li>\u4e00\u4e2ashared_ptr\u521d\u59cb\u5316\u53e6\u4e00\u4e2ashared_ptr\uff0c\u65b0\u7684shared_ptr\u589e\u52a0</li> <li>\u53c2\u6570\u4f20\u9012</li> <li>\u8fd4\u56de\u4e00\u4e2ashared_ptr</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_4","title":"\u5f15\u7528\u8ba1\u6570\u51cf\u5c11","text":"<ul> <li>\u4e00\u4e2ashared_ptr\u521d\u59cb\u5316\u53e6\u4e00\u4e2ashared_ptr\uff0c\u65e7\u7684shared_ptr\u8f83\u5c11</li> <li>\u88ab\u9500\u6bc1</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_5","title":"\u76f4\u63a5\u7ba1\u7406\u5185\u5b58","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#new","title":"new","text":"<ul> <li>\u52a8\u6001\u5206\u914dconst\u5bf9\u8c61\uff0c\u5fc5\u987b\u8fdb\u884c\u521d\u59cb\u5316\uff1b\u8fd4\u56de\u7684\u6307\u9488\u662f\u4e00\u4e2a\u6307\u5411\u5e38\u91cf\u7684\u6307\u9488</li> </ul> C++<pre><code>const int *pci = new const int(1024);\nconst string *pcs = new const string\uff1b\n</code></pre> <ul> <li>\u9700\u8981\u663e\u793a\u5730\u91ca\u653e\u5185\u5b58</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#share_ptrnew","title":"share_ptr\u4e0enew\u7ed3\u5408","text":"<ul> <li>\u4f7f\u7528\u4e00\u4e2a\u5185\u7f6e\u6307\u9488\u8bbf\u95ee\u4e00\u4e2a\u667a\u80fd\u6307\u9488\u6240\u8d1f\u8d23\u7684\u5bf9\u8c61\u662f\u5371\u9669\u7684</li> <li>\u4e0d\u8981\u4f7f\u7528get\u521d\u59cb\u5316\u53e6\u4e00\u4e2a\u667a\u80fd\u6307\u9488\u6216\u4e3a\u667a\u80fd\u6307\u9488\u8d4b\u503c</li> </ul> C++<pre><code>shared_ptr&lt;int&gt; p(new int(42));\nint *q = p.get();   // \u4e0d\u8981\u8ba9q\u7ba1\u7406\u7684\u6307\u9488\u88ab\u91ca\u653e\n{\n    shared_ptr&lt;int&gt; (q);    // \u4e24\u4e2a\u72ec\u7acb\u7684shared_ptr\u6307\u5411\u76f8\u540c\u7684\u5185\u5b58\n}   // \u7a0b\u5e8f\u5757\u7ed3\u675f\uff1bq\u6307\u5411\u7684\u5185\u5b58\u88ab\u91ca\u653e\nint foo = *p;   // p\u7684\u5185\u5b58\u5df2\u7ecf\u88ab\u91ca\u653e\u4e86\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_6","title":"\u667a\u80fd\u6307\u9488\u548c\u5f02\u5e38","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_7","title":"\u5220\u9664\u5668","text":"<ul> <li>\u5b8c\u6210\u5bf9share_ptr\u4e2d\u4fdd\u5b58\u7684\u6307\u9488\u8fdb\u884c\u91ca\u653e</li> </ul> C++<pre><code>void end_connection(connection *p) { disconnect(*p); }\nvoid f(destination &amp;d) \n{\n    connection c = connect(&amp;d);\n    share_ptr&lt;connection&gt; p(&amp;c, end_connection);\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_8","title":"\u667a\u80fd\u6307\u9488\u9677\u9631","text":"<ul> <li>\u4e0d\u4f7f\u7528\u76f8\u540c\u7684\u5185\u7f6e\u6307\u9488\u503c\u521d\u59cb\u5316\u6216reset\u591a\u4e2a\u667a\u80fd\u6307\u9488</li> <li>\u4e0d\u4f7f\u7528get\u521d\u59cb\u5316\u6216reset\u53e6\u4e00\u4e2a\u667a\u80fd\u6307\u9488</li> <li>\u4f7f\u7528get\u8fd4\u56de\u7684\u6307\u9488\uff0c\u6700\u540e\u4e00\u4e2a\u5bf9\u5e94\u7684\u667a\u80fd\u6307\u9488\u9500\u6bc1\u540e\uff0c\u6307\u9488\u53d8\u4e3a\u65e0\u6548</li> <li>\u4f7f\u7528\u667a\u80fd\u6307\u9488\u7ba1\u7406\u7684\u8d44\u6e90\u4e0d\u662fnew\u5206\u914d\u7684\u5185\u5b58\uff1b\u4f20\u9012\u4e00\u4e2a\u5220\u9664\u5668</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#unique_ptr","title":"unique_ptr","text":"<ul> <li>\u67d0\u4e2a\u65f6\u523b\u667a\u80fd\u6709\u4e00\u4e2aunique_ptr\u6307\u5411\u4e00\u4e2a\u7ed9\u5b9a\u5bf9\u8c61</li> </ul> C++<pre><code>unique_ptr&lt;double&gt; p1;\nunique_ptr&lt;int&gt; p2(new int(42));\n</code></pre> <ul> <li>unique_ptr\u4e0d\u652f\u6301\u62f7\u8d1d\u548c\u8d4b\u503c\uff1b\u53ea\u6307\u5411\u4e00\u4e2a\u5bf9\u8c61</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_9","title":"\u6240\u6709\u6743\u8f6c\u79fb","text":"C++<pre><code>// \u6240\u6709\u6743\u4ecep1\u8f6c\u7ed9p2\nunique_ptr&lt;string&gt; p2(p1.release());\nunique_ptr&lt;string&gt; p3(new string(\"Trex\"));\n// \u6240\u6709\u6743\u4ecep3\u8f6c\u7ed9p2\np2.reset(p3.release()); // reset\u91ca\u653e\u4e86p2\u539f\u6765\u6307\u5411\u7684\u5185\u5b58\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#unique_ptrunique_ptr","title":"\u4f20\u9012unique_ptr\u548c\u8fd4\u56deunique_ptr","text":"<ul> <li>\u6211\u4eec\u53ef\u4ee5\u62f7\u8d1d\u6216\u8d4b\u503c\u4e00\u4e2a\u5c06\u8981\u88ab\u9500\u6bc1\u7684unique_ptr</li> </ul> C++<pre><code>unique_ptr&lt;int&gt; clone(int p)\n{\n    return unique_ptr&lt;int&gt; (new int(p));\n}\n\n// \u8fd4\u56de\u5c40\u90e8\u5bf9\u8c61\u7684\u62f7\u8d1d\nunique_ptr&lt;int&gt; clone(int p)\n{\n    unique_ptr&lt;int&gt; ret(new int(p));\n    ...\n    return ret;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#unique_ptr_1","title":"\u5411unique_ptr\u4f20\u9012\u5220\u9664\u5668","text":"<ul> <li>\u4f7f\u7528\u4e86\u51fd\u6570\u6307\u9488\u7c7b\u578b</li> </ul> C++<pre><code>void f(destiation &amp;d)\n{\n    connection c = connect(&amp;d);\n    unique_ptr&lt;connection, decltype(end_connection)*&gt; p(&amp;c, end_connection);\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#weak_ptr","title":"weak_ptr","text":"<ul> <li> <p>\u786e\u5b9ashared_ptr\u662f\u5426\u4f1a\u88ab\u91ca\u653e\u6389\uff1b\u4f7f\u7528lock\u6765\u68c0\u6d4b</p> </li> <li> <p>\u4e0d\u63a7\u5236\u5bf9\u8c61\u751f\u5b58\u671f\uff1b\u6307\u5411\u4e00\u4e2ashared_ptr\u7ba1\u7406\u7684\u5bf9\u8c61</p> </li> </ul> <p></p> <ul> <li>\u521d\u59cb\u5316\u7528shared_ptr\u6765\u521d\u59cb\u5316\uff1bwp\u4e0d\u4f1a\u6539\u53d8p\u7684\u5f15\u7528\u8ba1\u6570\uff0cwp\u6307\u5411\u7684\u5bf9\u8c61\u53ef\u80fd\u88ab\u91ca\u653e\u6389</li> </ul> C++<pre><code>auto p = make_shared&lt;int&gt;(42);\nweak_ptr&lt;int&gt; wp(p);\n</code></pre> <ul> <li>\u4e0d\u80fd\u4f7f\u7528weak_ptr\u76f4\u63a5\u8bbf\u95ee\u5bf9\u8c61\uff1b\u8c03\u7528lock</li> <li>lock\u51fd\u6570\u68c0\u67e5weak_ptr\u6307\u5411\u7684\u5bf9\u8c61\u662f\u5426\u5b58\u5728</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_10","title":"\u8bbe\u8ba1\u4f18\u52bf","text":"<ul> <li> <p>\u65b9\u4fbf\u5224\u65ad\u67d0\u4e00\u65f6\u523b<code>shared_ptr</code>\u4e2d\u662f\u5426\u5df2\u7ecf\u91ca\u653e\u5bf9\u8c61\uff1b\u907f\u514d\u591a\u6b21\u91ca\u653e</p> </li> <li> <p>\u89e3\u51b3shared_ptr\u73af\u5f62\u5f15\u7528\u95ee\u9898</p> </li> <li> <p>\u89e3\u51b3\u8fd9\u79cd\u72b6\u51b5\u7684\u529e\u6cd5\u5c31\u662f\u5c06\u4e24\u4e2a\u7c7b\u4e2d\u7684\u4e00\u4e2a\u6210\u5458\u53d8\u91cf\u6539\u4e3a<code>weak_ptr</code>\u5bf9\u8c61\uff0c\u56e0\u4e3a<code>weak_ptr</code>\u4e0d\u4f1a\u589e\u52a0\u5f15\u7528\u8ba1\u6570\uff0c\u4f7f\u5f97\u5f15\u7528\u5f62\u4e0d\u6210\u73af\uff0c\u6700\u540e\u5c31\u53ef\u4ee5\u6b63\u5e38\u7684\u91ca\u653e\u5185\u90e8\u7684\u5bf9\u8c61\uff0c\u4e0d\u4f1a\u9020\u6210\u5185\u5b58\u6cc4\u6f0f\uff0c\u6bd4\u5982\u5c06<code>CB</code>\u4e2d\u7684\u6210\u5458\u53d8\u91cf\u6539\u4e3a<code>weak_ptr</code>\u5bf9</p> </li> </ul> <p></p> C++<pre><code>#include &lt;memory&gt;\n#include &lt;iostream&gt;\n\nclass B;\nclass A {\npublic:\n    ~A() {\n        std::cout &lt;&lt; \"~A\" &lt;&lt; std::endl;\n    }\n\n    void setPtr(std::shared_ptr&lt;B&gt;&amp; b) {\n        bPtr_ = b;\n    }\n\nprivate:\n    std::shared_ptr&lt;B&gt; bPtr_;\n};\n\nclass B {\npublic:\n    ~B() {\n        std::cout &lt;&lt; \"~B\" &lt;&lt; std::endl;\n    }\n\n    void setPtr(std::shared_ptr&lt;A&gt;&amp; a) {\n        aPtr_ = a;\n    }\n\nprivate:\n    std::shared_ptr&lt;A&gt; aPtr_;\n};\n\n// \u89e3\u51b3\u65b9\u6848\n// \u5c06B\u4e2d\u7684\u667a\u80fd\u6307\u9488\u6362\u6210weak_ptr\nint main() {\n    std::shared_ptr&lt;A&gt; aShared = std::make_shared&lt;A&gt;();\n    std::shared_ptr&lt;B&gt; bShared = std::make_shared&lt;B&gt;();\n\n    aShared-&gt;setPtr(bShared);\n    bShared-&gt;setPtr(aShared);\n\n    return 0;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_11","title":"\u52a8\u6001\u6570\u7ec4","text":"<ul> <li>\u52a8\u6001\u5206\u914d\u4e00\u4e2a\u7a7a\u6570\u7ec4\u662f\u5408\u6cd5\u7684</li> <li>\u5f97\u5230\u7684\u662f\u4e00\u4e2a\u6307\u9488\uff1b\u4e0d\u80fd\u4f7f\u7528begin()\u6216end()</li> </ul> C++<pre><code>size_t n = get_size();\nint* p = new int[n];\nfor(int * q = p; q != p + n; ++q)\n    /* \u5904\u7406\u6570\u7ec4 */\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_12","title":"\u667a\u80fd\u6307\u9488\u548c\u52a8\u6001\u6570\u7ec4","text":"<ul> <li>\u4e0d\u80fd\u4f7f\u7528.\u6216-&gt;\uff0c\u4f7f\u7528\u4e0b\u6807\u6765\u8bbf\u95ee</li> </ul> C++<pre><code>unique_ptr&lt;int[]&gt; up(new int[10]);\nup.release(); // \u81ea\u52a8\u8c03\u7528delete []\nfor(size_t i = 0; i != 10; ++i)\n    up[i] = i;\n</code></pre> <ul> <li>shared_ptr\u4e0d\u76f4\u63a5\u652f\u6301\u52a8\u6001\u6570\u7ec4\u7ba1\u7406</li> <li>\u5fc5\u987b\u81ea\u5df1\u5b9a\u4e49\u5220\u9664\u5668\u6765\u64cd\u4f5c</li> </ul> C++<pre><code>shared_ptr&lt;int&gt; sp(new int[10], [](int *p){delete[] p;});   // \u5b9a\u4e49\u5220\u9664\u5668\nfor(size_t i = 0; i != 10; ++i)\n    *(sp.get() + i) = i;    // \u4f7f\u7528get\u83b7\u53d6\u4e00\u4e2a\u5185\u7f6e\u6307\u9488\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#allocator","title":"allocator\u7c7b","text":"<ul> <li>\u5206\u914d\u7684\u5185\u5b58\u662f\u539f\u59cb\u7684\uff0c\u672a\u6784\u9020\u7684</li> <li>\u6839\u636e\u7ed9\u5b9a\u7684\u5bf9\u8c61\u7c7b\u578b\u6765\u786e\u5b9a\u6070\u5f53\u7684\u5185\u5b58\u5927\u5c0f\u548c\u5bf9\u9f50\u4f4d\u7f6e</li> </ul> C++<pre><code>allocator&lt;string&gt; alloc;\nauto const p = alloc.allocate(n);\n</code></pre> C++<pre><code>auto q = p; // q\u6307\u5411\u6700\u540e\u6784\u9020\u7684\u5143\u7d20\u4e4b\u540e\u7684\u4f4d\u7f6e\nalloc.construct(q++);           // *q is \"\"\nalloc.construct(q++, 2, 'c');   // *q is \"cc\"\nalloc.construct(q++, \"hi!\");    // *q is \"hi!\"\n</code></pre> <ul> <li>\u4f7f\u7528allocate\u8fd4\u56de\u7684\u5185\u5b58\uff0c\u5fc5\u987b\u7528constuct\u6784\u9020\u5bf9\u8c61\uff1b\u4f7f\u7528\u672a\u6784\u9020\u7684\u5185\u5b58\uff0c\u884c\u4e3a\u662f\u672a\u5b9a\u4e49\u7684</li> </ul> C++<pre><code>while(q != p)\n    alloc.destroy(--q);\n</code></pre> <ul> <li>\u53ea\u80fd\u5bf9\u771f\u6b63\u6784\u9020\u7684\u5143\u7d20\u8fdb\u884cdestroy\u64cd\u4f5c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_13","title":"\u62f7\u8d1d\u548c\u586b\u5145\u672a\u521d\u59cb\u5316\u5185\u5b58\u7b97\u6cd5","text":"C++<pre><code>auto p = alloc.allocate(vi.size() * 2);\nauto q = uninitialized_copy(vi.begin(), vi.end(), p);\nauto q = uninitialized_fill_n(q, vi.size(), 42);\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_14","title":"\u6e90\u7801","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#unique_ptr_2","title":"unique_ptr","text":"<ul> <li>\u6709\u4e24\u4e2a\u53c2\u6570\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u6307\u9488\u6240\u6307\u7684\u7c7b\u578b\uff1b\u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f\u5220\u9664\u5668\uff0c\u89c4\u5b9a\u6307\u9488\u91ca\u653e\u65f6\u7684\u64cd\u4f5c</li> <li>\u7981\u6b62\u5de6\u503c\u8d4b\u503c\u548c\u62f7\u8d1d</li> <li>\u5b9a\u4e49\u7684\u53d8\u91cf\u7c7b\u578b\u4ee5\u53ca\u51fd\u6570\u5e94\u8be5\u5728<code>__uniq_ptr_impl</code>\u7c7b\u4e2d</li> </ul> C++<pre><code>// \u6210\u5458\u53d8\u91cf\n__uniq_ptr_impl&lt;_Tp, _Dp&gt; _M_t;\n\n// Disable copy from lvalue.\nunique_ptr(const unique_ptr&amp;) = delete;\nunique_ptr&amp; operator=(const unique_ptr&amp;) = delete;\n// \u53d8\u91cf\u7c7b\u578b\nusing pointer = typename __uniq_ptr_impl&lt;_Tp,_Dp&gt;::pointer;\nusing element_type  = _Tp;\nusing deleter_type  = _Dp;\n// \u6210\u5458\u51fd\u6570\n/// Return the stored pointer.\npointer get() const noexcept\n{ return _M_t._M_ptr(); }\n\n/// Return a reference to the stored deleter.\ndeleter_type&amp; get_deleter() noexcept\n{ return _M_t._M_deleter(); }\n\n/// Return a reference to the stored deleter.\nconst deleter_type&amp; get_deleter() const noexcept\n{ return _M_t._M_deleter(); }\n\n/// Return @c true if the stored pointer is not null.\nexplicit operator bool() const noexcept\n{ return get() == pointer() ? false : true; }\n\n/// Release ownership of any stored pointer.\npointer release() noexcept\n{\n    pointer __p = get();\n    _M_t._M_ptr() = pointer();\n    return __p;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#class-__uniq_ptr_impl","title":"class __uniq_ptr_impl","text":"<ul> <li>\u5b58\u653e\u6307\u9488\u548c\u5220\u9664\u5668\u7684\u4e00\u4e2a\u7ed3\u6784</li> </ul> C++<pre><code>  template &lt;typename _Tp, typename _Dp&gt;\n    class __uniq_ptr_impl\n    {\n      // \u7528\u6765\u5f97\u5230\u6307\u9488\u7c7b\u578b\n      template &lt;typename _Up, typename _Ep, typename = void&gt;\n    struct _Ptr\n    {\n      using type = _Up*;\n    };\n    public:\n      // Constructor\n      // \u83b7\u53d6tuple\u4e2d\u7684\u5143\u7d20\n      pointer&amp;   _M_ptr() { return std::get&lt;0&gt;(_M_t); }\n      pointer    _M_ptr() const { return std::get&lt;0&gt;(_M_t); }\n      _Dp&amp;       _M_deleter() { return std::get&lt;1&gt;(_M_t); }\n      const _Dp&amp; _M_deleter() const { return std::get&lt;1&gt;(_M_t); }\n    private:\n      tuple&lt;pointer, _Dp&gt; _M_t;\n    };\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#shared_ptr_2","title":"shared_ptr","text":"<ul> <li>\u6784\u9020\u51fd\u6570\u8c03\u7528\u7684__shared_ptr\u7684\u6784\u9020\u51fd\u6570</li> <li>\u8be5\u7c7b\u6ca1\u6709\u91cd\u8f7d<code>*</code>\u548c<code>-&gt;</code>\u8fd0\u7b97\u7b26\uff0c\u4ece\u8fd9\u70b9\u770b<code>shared_ptr</code>\u4f3c\u4e4e\u65e0\u6cd5\u5b9e\u73b0\u666e\u901a\u6307\u9488\u7684\u529f\u80fd</li> <li>\u8be5\u7c7b\u6ca1\u6709\u6790\u6784\u51fd\u6570</li> <li>\u53ea\u6709\u4e00\u4e2a\u53cb\u5143\u7c7bweak_ptr</li> </ul> C++<pre><code> class shared_ptr : public __shared_ptr&lt;_Tp&gt;\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#__shared_ptr__shared_ptr_access","title":"<code>__shared_ptr&amp;__shared_ptr_access</code>","text":"<ul> <li>\u6709\u4e24\u4e2a\u7c7b\u6210\u5458\uff1a<code>_M_ptr</code>(\u7531\u667a\u80fd\u6307\u9488\u63a5\u7ba1\u7684\u666e\u901a\u6307\u9488)\u3001<code>_M_refcount</code>(\u5f15\u7528\u8ba1\u6570\u5668\uff0c\u7c7b\u578b\u4e3a<code>__shared_count</code>)   \u4ece\u6784\u9020\u51fd\u6570\u770b\uff0c<code>_M_ptr</code>\u83b7\u5f97\u4e86\u63a5\u7ba1\u7684\u666e\u901a\u6307\u9488\u7684\u503c\uff0c\u800c<code>_M_refcount</code>\u7684\u6784\u9020\u4e5f\u540c\u6837\u9700\u8981\u8fd9\u4e2a\u503c</li> <li>\u91cd\u8f7d\u4e86*\u548c-&gt;\u8fd0\u7b97\u7b26\uff0c\u7531shared_ptr\u7ee7\u627f\u4f7f\u7528\uff0c\u4f7f\u5f97\u667a\u80fd\u6307\u9488\u6700\u7ec8\u80fd\u62e5\u6709\u548c\u666e\u901a\u6307\u9488\u4e00\u6837\u884c\u4e3a\uff0c\u5c3d\u7ba1\u667a\u80fd\u6307\u9488\u672c\u8d28\u4e0a\u662f\u4e00\u4e2a\u5bf9\u8c61   \u4ece\u6790\u6784\u51fd\u6570\u6765\u770b\uff0c\u91cc\u9762\u5565\u4e5f\u6ca1\u505a\uff0c\u8bf4\u660e\u63a5\u7ba1\u7684\u666e\u901a\u6307\u9488\u4e5f\u4e0d\u662f\u5728\u8fd9\u91cc\u91ca\u653e\u7684\uff0c\u6240\u4ee5\u6709\u53ef\u80fd\u662f\u7531_M_refcount\u6765\u5b8c\u6210\u91ca\u653e\u5185\u5b58\u8fd9\u4e2a\u5de5\u4f5c\uff0c\u4e0b\u9762\u5206\u6790__shared_count\u7684\u5b9e\u73b0</li> <li>\u5c06weak_ptr\u4f5c\u4e3a\u53cb\u5143</li> </ul> C++<pre><code> // Define operator-&gt; for shared_ptr&lt;cv void&gt;.\n // __shared_ptr_access&lt;_Tp, _Lp, false, true&gt;\n      using element_type = _Tp;\n\n      element_type*\n      operator-&gt;() const noexcept\n      {\n    auto __ptr = static_cast&lt;const __shared_ptr&lt;_Tp, _Lp&gt;*&gt;(this)-&gt;get();\n    _GLIBCXX_DEBUG_PEDASSERT(__ptr != nullptr);\n    return __ptr;\n      }\n\n// __shared_ptr\nelement_type*      _M_ptr;         // Contained pointer.\n__shared_count&lt;_Lp&gt;  _M_refcount;    // Reference counter.\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#__shared_count","title":"__shared_count","text":"<ul> <li>\u5728<code>__Sp_counted_ptr</code>\u4e2d\u7ee7\u627f<code>__M_dispose</code>\u51fd\u6570\u548c<code>__M_destroy</code>\u51fd\u6570</li> <li><code>__shared_count</code>\u4e2d\u7684<code>_Sp_counted_base&lt;_Lp&gt;*  _M_pi</code>\u6210\u5458\u7531<code>__Sp_counted_ptr</code>\u6765\u521d\u59cb\u5316</li> </ul> C++<pre><code>// __Sp_counted_ptr\n// user_count = 0;\u5220\u9664\u6307\u9488\u4ee5\u53ca\u6574\u4e2a\u7a7a\u95f4\nvirtual void\n_M_dispose() noexcept\n{ delete _M_ptr; }\n// weak_count = 0;\u91ca\u653e__Sp_counted_ptr\u5bf9\u8c61\nvirtual void\n_M_destroy() noexcept\n{ delete this; }\n\n// __shared_count\n_M_pi = new _Sp_counted_ptr&lt;_Ptr, _Lp&gt;(__p);\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#__sp_counted_base__sp_counted_ptr","title":"__Sp_counted_base&amp;&amp;__Sp_counted_ptr","text":"<ul> <li>\u5b9e\u73b0\u8ba1\u6570\u5668\u7684\u589e\u51cf</li> <li>\u63d0\u4f9b\u4e86\u91ca\u653e\u6307\u9488\u548c\u91ca\u653e\u8ba1\u6570\u5668\u5bf9\u8c61\u7684\u865a\u51fd\u6570</li> </ul> C++<pre><code>// \u5b9e\u73b0\u8ba1\u6570\u5668\u7684\u589e\u51cf\u548c\u5bf9\u8c61\u7684\u9500\u6bc1(user_count)\n// user_count and weak_count\n\n      // Called when _M_use_count drops to zero, to release the resources\n      // managed by *this.\n      virtual void\n      _M_dispose() noexcept = 0;\n\n      // Called when _M_weak_count drops to zero.\n      virtual void\n      _M_destroy() noexcept\n      { delete this; }\n\n  template&lt;&gt;\n    inline void\n    _Sp_counted_base&lt;_S_single&gt;::_M_add_ref_copy()\n    { ++_M_use_count; }\n\n  template&lt;&gt;\n    inline void\n    _Sp_counted_base&lt;_S_single&gt;::_M_release() noexcept\n    {\n      if (--_M_use_count == 0)\n        {\n          _M_dispose();\n          if (--_M_weak_count == 0)\n            _M_destroy();\n        }\n    }\n\n  template&lt;&gt;\n    inline void\n    _Sp_counted_base&lt;_S_single&gt;::_M_weak_add_ref() noexcept\n    { ++_M_weak_count; }\n\n  template&lt;&gt;\n    inline void\n    _Sp_counted_base&lt;_S_single&gt;::_M_weak_release() noexcept\n    {\n      if (--_M_weak_count == 0)\n        _M_destroy();\n    }\n\n  template&lt;&gt;\n    inline long\n    _Sp_counted_base&lt;_S_single&gt;::_M_get_use_count() const noexcept\n    { return _M_use_count; }\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#weak_ptr_1","title":"weak_ptr","text":"<ul> <li>\u6709\u4e00\u4e2a__weak_count\u548c\u4e00\u4e2a\u6307\u9488</li> </ul> C++<pre><code>// \u6210\u5458\nelement_type*    _M_ptr;         // Contained pointer.\n__weak_count&lt;_Lp&gt;  _M_refcount;    // Reference counter.\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#__weak_count","title":"__weak_count","text":"<ul> <li>\u4e0eshared_count\u76f8\u4f3c\uff0c\u7ee7\u627f\u7236\u7c7b\u51fd\u6570\u8fdb\u884c\u5f15\u7528\u8ba1\u6570\u7684\u52a0\u51cf</li> </ul> C++<pre><code>_Sp_counted_base&lt;_Lp&gt;*  _M_pi;\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#__enable_shared_from_this","title":"__enable_shared_from_this","text":"<ul> <li>\u5c06weak_ptr\u8f6c\u5316\u4e3ashared_ptr</li> </ul> C++<pre><code>__shared_ptr&lt;_Tp, _Lp&gt;\nshared_from_this()\n{ return __shared_ptr&lt;_Tp, _Lp&gt;(this-&gt;_M_weak_this); }\n\n__shared_ptr&lt;const _Tp, _Lp&gt;\nshared_from_this() const\n{ return __shared_ptr&lt;const _Tp, _Lp&gt;(this-&gt;_M_weak_this); }\n\nfriend const __enable_shared_from_this*\n__enable_shared_from_this_base(const __shared_count&lt;_Lp&gt;&amp;,\nconst __enable_shared_from_this* __p)\n{ return __p; }\n\n// \u6210\u5458\u53d8\u91cf\nmutable __weak_ptr&lt;_Tp, _Lp&gt;  _M_weak_this;\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#enable_shared_from_this","title":"enable_shared_from_this","text":"C++<pre><code>shared_ptr&lt;_Tp&gt;\nshared_from_this()\n{ return shared_ptr&lt;_Tp&gt;(this-&gt;_M_weak_this); }\n\nshared_ptr&lt;const _Tp&gt;\nshared_from_this() const\n{ return shared_ptr&lt;const _Tp&gt;(this-&gt;_M_weak_this); }\n\nfriend const __enable_shared_from_this*\n__enable_shared_from_this_base(const __shared_count&lt;_Lp&gt;&amp;,\nconst __enable_shared_from_this* __p)\n{ return __p; }\n\n// \u6210\u5458\u53d8\u91cf\nmutable __weak_ptr&lt;_Tp, _Lp&gt;  _M_weak_this;\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#delete-this","title":"delete this","text":"<ul> <li>\u91ca\u653e\u7ba1\u7406\u7684\u5bf9\u8c61</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/12_%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98/#_15","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u4f60\u5fc5\u987b100%\u7edd\u5bf9\u786e\u4fdd\u201dthis\u201d\u5bf9\u8c61\u662f\u901a\u8fc7new\u5206\u914d\u7684\uff08\u4e0d\u662f\u901a\u8fc7new[]\uff0c\u4e0d\u662fplacement new\uff0c\u4e0d\u662f\u6808\u4e0a\u7684\u5c40\u90e8\u5bf9\u8c61\uff0c\u4e0d\u662f\u5168\u5c40\u5bf9\u8c61\uff0c\u4e0d\u662f\u53e6\u4e00\u4e2a\u5bf9\u8c61\u7684\u6570\u636e\u6210\u5458\uff1b\u4ec5\u4ec5\u53ea\u662f\u901a\u8fc7\u539f\u59cb\u7684new\u8fd0\u7b97\u7b26\uff09</li> <li>\u4f60\u5fc5\u987b100%\u7edd\u5bf9\u786e\u4fdd\u8c03\u7528\u201ddelete this\u201d\u64cd\u4f5c\u7684\u6210\u5458\u51fd\u6570\u662f\u6700\u540e\u8c03\u7528\u7684\u6210\u5458\u51fd\u6570</li> <li>\u4f60\u5fc5\u987b100%\u7edd\u5bf9\u786e\u4fdd\u5728\u5f53\u524d\u51fd\u6570\u4e2d\u201ddelete this\u201d\u540e\uff0c\u8c03\u7528\u7684\u5176\u4ed6\u6210\u5458\u51fd\u6570\u4e0d\u4f1a\u8bfb\u53d6\u201dthis\u201d\u5bf9\u8c61\u3002</li> <li>\u4f60\u5fc5\u987b100%\u786e\u4fdd\u518d\u4e5f\u4e0d\u4f1a\u4f7f\u7528\u201dthis\u201d\u6307\u9488\u3002\u5373\u4f7f\u4f60\u4f7f\u7528this\u6307\u9488\u548c\u5176\u4ed6\u6307\u9488\u6bd4\u8f83\uff0c\u4f8b\u5982nullptr\uff0c\u6253\u5370this\u6307\u9488\uff0c\u8f6c\u6362this\u6307\u9488\u7b49\u7b49\u3002</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/","title":"C++-\u62f7\u8d1d\u63a7\u5236","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_1","title":"\u62f7\u8d1d\u63a7\u5236","text":"<p> \u7ea6 2094 \u4e2a\u5b57  140 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 12 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_2","title":"\u62f7\u8d1d\u3001\u8d4b\u503c\u4e0e\u9500\u6bc1","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_3","title":"\u62f7\u8d1d\u6784\u9020\u51fd\u6570","text":"<ul> <li> <p>\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u81ea\u8eab\u7c7b\u7c7b\u578b\u7684\u5f15\u7528\uff0c\u6240\u6709\u5176\u4ed6\u53c2\u6570\u5747\u6709\u9ed8\u8ba4\u503c</p> </li> <li> <p>\u9010\u4e2a\u62f7\u8d1d\u975estatic\u6210\u5458\uff1b\u5185\u7f6e\u7c7b\u578b\u6210\u5458\u76f4\u63a5\u5185\u5b58\u62f7\u8d1d\uff1b\u7c7b\u7c7b\u578b\u6210\u5458\uff0c\u8c03\u7528\u62f7\u8d1d\u6784\u9020\u51fd\u6570\u62f7\u8d1d</p> </li> </ul> C++<pre><code>string dots(10, '.');   // \u76f4\u63a5\u521d\u59cb\u5316\nstring s(dots);         // \u76f4\u63a5\u521d\u59cb\u5316\nstring s2 = dots;       // \u62f7\u8d1d\u521d\u59cb\u5316\nstring null_book = \"99\" // \u62f7\u8d1d\u521d\u59cb\u5316 \n</code></pre> <ul> <li> <p>\u62f7\u8d1d\u521d\u59cb\u5316</p> </li> <li> <p>\u201c=\u201d</p> </li> <li>\u4e00\u4e2a\u5bf9\u8c61\u4f5c\u4e3a\u5b9e\u53c2\u4f20\u9012\u7ed9\u4e00\u4e2a\u975e\u5f15\u7528\u7c7b\u578b\u7684\u5f62\u53c2</li> <li>\u4ece\u4e00\u4e2a\u8fd4\u56de\u7c7b\u578b\u4e3a\u975e\u5f15\u7528\u7c7b\u578b\u7684\u51fd\u6570\u8fd4\u56de\u4e00\u4e2a\u5bf9\u8c61</li> <li>\u7528\u82b1\u62ec\u53f7\u5217\u8868\u521d\u59cb\u5316\u4e00\u4e2a\u6570\u7ec4\u4e2d\u7684\u5143\u7d20\u6216\u4e00\u4e2a\u805a\u5408\u7c7b\u7684\u6210\u5458</li> <li> <p>\u5bb9\u5668\u8c03\u7528insert\u6216push\u64cd\u4f5c\u65f6</p> </li> <li> <p>\u62f7\u8d1d\u6784\u9020\u51fd\u6570\u7684\u5f62\u53c2\u5fc5\u987b\u662f\u5f15\u7528\u7c7b\u578b</p> </li> <li> <p>\u7f16\u8bd1\u5668\u53ef\u4ee5\u7ed5\u8fc7\u62f7\u8d1d\u6784\u9020\u51fd\u6570</p> </li> </ul> C++<pre><code>string null_book = \"9-99\";\n// \u6539\u5199\u4e3a\nstring null_book(\"9-99\"); // \u7f16\u8bd1\u5668\u7565\u8fc7\u4e86\u62f7\u8d1d\u6784\u9020\u51fd\u6570\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_4","title":"\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26","text":"<ul> <li>\u8d4b\u503c\u8fd0\u7b97\u7b26\u901a\u5e38\u8fd4\u56de\u4e00\u4e2a\u6307\u5411\u5176\u5de6\u4fa7\u8fd0\u7b97\u5bf9\u8c61\u7684\u5f15\u7528</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_5","title":"\u5408\u6210\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26","text":"<ul> <li>\u7c7b\u672a\u5b9a\u4e49\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26\uff0c\u7f16\u8bd1\u5668\u4f1a\u751f\u6210\u4e00\u4e2a\u5408\u6210\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26</li> <li>\u5c06\u53f3\u4fa7\u8fd0\u7b97\u5bf9\u8c61\u7684\u6bcf\u4e2a\u975estatic\u6210\u5458\u8d4b\u4e88\u5de6\u4fa7\u8fd0\u7b97\u5bf9\u8c61\u7684\u5bf9\u5e94\u6210\u5458</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_6","title":"\u6790\u6784\u51fd\u6570","text":"<ul> <li>\u91ca\u653e\u5bf9\u8c61\u4f7f\u7528\u7684\u8d44\u6e90\uff0c\u9500\u6bc1\u5bf9\u8c61\u7684\u975estatic\u6570\u636e\u6210\u5458</li> <li>\u4e0d\u63a5\u53d7\u53c2\u6570\uff0c\u4e0d\u80fd\u88ab\u91cd\u8f7d</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_7","title":"\u5b8c\u6210\u5de5\u4f5c","text":"<ul> <li>\u6267\u884c\u51fd\u6570\u4f53\uff1b\u9500\u6bc1\u6210\u5458\uff0c\u6309\u521d\u59cb\u5316\u987a\u5e8f\u7684\u9006\u5e8f\u9500\u6bc1</li> <li>\u9690\u5f0f\u9500\u6bc1\u4e00\u4e2a\u5185\u7f6e\u6307\u9488\u7c7b\u578b\u7684\u6210\u5458\u4e0d\u4f1adelete\u5b83\u6240\u6307\u5411\u7684\u5bf9\u8c61</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_8","title":"\u8c03\u7528\u65f6\u673a","text":"<ul> <li>\u5bf9\u8c61\u88ab\u9500\u6bc1\uff0c\u81ea\u52a8\u8c03\u7528\u5176\u6790\u6784\u51fd\u6570</li> <li>\u6307\u5411\u4e00\u4e2a\u5bf9\u8c61\u7684\u5f15\u7528\u6216\u6307\u9488\u79bb\u5f00\u4f5c\u7528\u57df\uff0c\u6790\u6784\u51fd\u6570\u4e0d\u4f1a\u6267\u884c\uff08delete \u5bf9\u8c61\u6307\u9488\uff09</li> </ul> C++<pre><code>bool fcn(const Sales_data *trans, Sales_data accum)\n{\n    Sales_data item(*trans), item2(accum);\n    return item1.isbn() != item2.isbn();\n}\n// \u8c03\u75283\u6b21\u6790\u6784\u51fd\u6570\n// item1, item2, accum\n// trans\u662f\u6307\u9488\uff0c\u4e0d\u6267\u884c\u6790\u6784\u51fd\u6570\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_9","title":"\u4e09/\u4e94\u6cd5\u5219","text":"<ul> <li>\u9700\u8981\u6790\u6784\u51fd\u6570\u7684\u7c7b\u4e5f\u9700\u8981\u62f7\u8d1d\u548c\u8d4b\u503c\u64cd\u4f5c</li> <li>\u9700\u8981\u62f7\u8d1d\u7684\u7c7b\u4e5f\u9700\u8981\u8d4b\u503c\u64cd\u4f5c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#default","title":"\u4f7f\u7528=default","text":"<ul> <li>\u663e\u793a\u8981\u6c42\u7f16\u8bd1\u5668\u751f\u6210\u5408\u6210\u7248\u672c\u7684\u51fd\u6570</li> </ul> C++<pre><code>class Sales_data\n{\npublic:\n    Sales_data()=default;\n    Sales_data(const Sales_data&amp;)=default;\n    Sales_data&amp; operator=(const Sales_data&amp;);\n    ~Sales_data()=default;\n};\nSales_data&amp; Sales_data::operator=(const Sales_data&amp;)=default;\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_10","title":"\u963b\u6b62\u62f7\u8d1d","text":"<ul> <li> <p>\u5b9a\u4e49\u5220\u9664\u7684\u51fd\u6570\uff1a=delete\uff1b\u6211\u4eec\u53ef\u4ee5\u5bf9\u4efb\u4f55\u51fd\u6570\u6307\u5b9a=delete</p> </li> <li> <p>\u4e0d\u80fd\u5220\u9664\u6790\u6784\u51fd\u6570</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_11","title":"\u5408\u6210\u7684\u62f7\u8d1d\u63a7\u5236\u6210\u5458\u53ef\u80fd\u662f\u5220\u9664\u7684","text":"<ul> <li>\u4e00\u4e2a\u7c7b\u6709\u6570\u636e\u6210\u5458\u4e0d\u80fd\u9ed8\u8ba4\u6784\u9020\u3001\u62f7\u8d1d\u3001\u590d\u5236\u6216\u9500\u6bc1\uff0c\u5bf9\u5e94\u7684\u6210\u5458\u51fd\u6570\u5c06\u88ab\u5b9a\u4e49\u4e3a\u5220\u9664\u7684</li> <li>\u4e00\u4e2a\u7c7b\u6709const\u6210\u5458\uff0c\u4e0d\u80fd\u4f7f\u7528\u5408\u6210\u7684\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26\uff1b\u5408\u6210\u7684\u8bd5\u56fe\u8d4b\u503c\u6240\u6709\u6210\u5458</li> <li>\u4e00\u4e2a\u7c7b\u6709\u5f15\u7528\u6210\u5458\uff0c\u4e0d\u4f7f\u7528\u5408\u6210\u7684\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26\uff1b\u5408\u6210\u7684\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26\u53ea\u662f\u4fee\u6539\u5f15\u7528\u6307\u5411\u7684\u5bf9\u8c61\u7684\u503c\uff0c\u6ca1\u6709\u6539\u53d8\u5f15\u7528\u5bf9\u8c61\uff1b</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#private","title":"private\u62f7\u8d1d\u63a7\u5236","text":"<ul> <li>\u963b\u6b62\u62f7\u8d1d\uff1a\u5c06\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26\uff0c\u62f7\u8d1d\u6784\u9020\u51fd\u6570\u58f0\u660e\u4e3aprivate\u7684\uff1b</li> <li>\u4e3a\u4e86\u653e\u7f6e\u53cb\u5143\u4f7f\u7528\uff0c\u53ea\u58f0\u660e\u4f46\u4e0d\u5b9a\u4e49</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_12","title":"\u62f7\u8d1d\u63a7\u5236\u548c\u8d44\u6e90\u7ba1\u7406","text":"<ul> <li>\u5b9a\u4e49\u4e00\u4e2a\u7c7b\u7684\u62f7\u8d1d\u64cd\u4f5c\uff0c\u7c7b\u7684\u884c\u4e3a\u50cf\u4e00\u4e2a\u503c\u6216\u50cf\u4e00\u4e2a\u6307\u9488</li> <li>\u7c7b\u7684\u884c\u4e3a\u50cf\u4e00\u4e2a\u503c\uff1a</li> <li>\u62e5\u6709\u81ea\u5df1\u7684\u72b6\u6001\uff1b\u526f\u672c\u548c\u539f\u5bf9\u8c61\u662f\u5b8c\u5168\u72ec\u7acb\u7684\uff0c\u6539\u53d8\u526f\u672c\u4e0d\u4f1a\u5bf9\u539f\u5bf9\u8c61\u6709\u4efb\u4f55\u5f71\u54cd</li> <li>\u7c7b\u884c\u4e3a\u50cf\u6307\u9488\uff1a</li> <li>\u5171\u4eab\u72b6\u6001\uff1b\u526f\u672c\u548c\u539f\u5bf9\u8c61\u4f7f\u7528\u76f8\u540c\u7684\u5e95\u5c42\u6570\u636e</li> <li>string\u7c7b\u548c\u6807\u51c6\u5e93\u5bb9\u5668\u7c7b\u7684\u884c\u4e3a\u50cf\u4e00\u4e2a\u503c\uff1bshared_ptr\u7c7b\u63d0\u4f9b\u7c7b\u4f3c\u6307\u9488\u7684\u884c\u4e3a</li> <li>IO\u7c7b\u578b\u548cunique_ptr\u4e0d\u5141\u8bb8\u62f7\u8d1d\u548c\u8d4b\u503c\uff0c\u884c\u4e3a\u65e2\u4e0d\u50cf\u503c\u4e5f\u4e0d\u50cf\u6307\u9488</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_13","title":"\u884c\u4e3a\u50cf\u503c\u7684\u7c7b","text":"<ul> <li>\u5b9a\u4e49\u4e00\u4e2a\u62f7\u8d1d\u6784\u9020\u51fd\u6570\uff1b\u5b8c\u6210string\u7684\u62f7\u8d1d\uff1b\u800c\u4e0d\u662f\u6307\u9488\u7684\u62f7\u8d1d</li> <li>\u5b9a\u4e49\u4e00\u4e2a\u6790\u6784\u51fd\u6570\u91ca\u653estring</li> <li>\u5b9a\u4e49\u4e00\u4e2a\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26\u91ca\u653e\u5f53\u524dstring\uff0c\u5e76\u4ece\u53f3\u4fa7\u8fd0\u7b97\u5bf9\u8c61\u62f7\u8d1dstring</li> </ul> C++<pre><code>class HasPtr\n{\npublic:\n    HasPtr(const std::string &amp;s = std::string()): \\\n        ps(new std::string(s), i(0)){}\n    HasPtr(const HasPtr &amp;p) : ps(new std::string(*p.ps)), i(p.i){}\n    HasPtr&amp; operator=(const HasPtr &amp;);\n    ~HasPtr(){delete ps;}\nprivate:\n    std::string *ps;\n    int i;\n};\n\nHasPtr&amp; HasPtr::operator=(const HasPtr &amp;rhs)\n{\n    auto newp = new string(*rhs.ps);\n    delete ps;\n    ps = newp;\n    i = rhs.i;\n    return *this;\n}\n</code></pre> <ul> <li>\u8d4b\u503c\u8fd0\u7b97\u7b26\uff1a\u5148\u5c06\u53f3\u4fa7\u8fd0\u7b97\u5bf9\u8c61\u62f7\u8d1d\u5230\u4e00\u4e2a\u5c40\u90e8\u4e34\u65f6\u5bf9\u8c61\u4e2d\uff1b\u5c06\u4e34\u65f6\u5bf9\u8c61\u4e2d\u7684\u6210\u5458\u62f7\u8d1d\u5230\u5de6\u4fa7\u8fd0\u7b97\u5bf9\u8c61\u6210\u5458\u4e2d</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_14","title":"\u5b9a\u4e49\u884c\u4e3a\u4e0a\u50cf\u6307\u9488\u7684\u7c7b","text":"<ul> <li>\u6700\u597d\u65b9\u6cd5\u662f\u4f7f\u7528shared_ptr\u7ba1\u7406\u7c7b\u4e2d\u7684\u8d44\u6e90</li> <li>\u5e0c\u671b\u76f4\u63a5\u7ba1\u7406\u8d44\u6e90\uff0c\u4f7f\u7528\u5f15\u7528\u8ba1\u6570</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_15","title":"\u5f15\u7528\u8ba1\u6570","text":"<ul> <li>\u521d\u59cb\u5316\u5bf9\u8c61\u5916\uff0c\u6bcf\u4e2a\u6784\u9020\u51fd\u6570\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5f15\u7528\u8ba1\u6570</li> <li>\u62f7\u8d1d\u6784\u9020\u51fd\u6570\u4e0d\u5206\u914d\u65b0\u7684\u8ba1\u6570\u5668\uff1b\u9012\u589e\u5171\u4eab\u7684\u8ba1\u6570\u5668</li> <li>\u6790\u6784\u51fd\u6570\u9012\u51cf\u8ba1\u6570\u5668</li> <li>\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26\u9012\u589e\u53f3\u4fa7\u5bf9\u8c61\u8ba1\u6570\u5668\uff0c\u9012\u51cf\u5de6\u4fa7\u5bf9\u8c61\u8ba1\u6570\u5668</li> <li>\u5c06\u8ba1\u6570\u5668\u4fdd\u5b58\u5728\u52a8\u6001\u5185\u5b58\u4e2d\uff1b\u62f7\u8d1d\u6307\u5411\u8ba1\u6570\u5668\u7684\u6307\u9488</li> </ul> C++<pre><code>class HasPtr {\npublic:\n    HasPtr(const string&amp; s = string()) :\n        ps(new string(s)), i(0), use(new size_t(1)){}\n    HasPtr(const HasPtr&amp; p): ps(p.ps), i(p.i), use(++*use);\n    HasPtr&amp; operator=(const HasPtr&amp;);\n    ~HasPtr;\nprivate:\n    string *ps;\n    int i;\n    size_t *use;\n};\n\nHasPtr::~HasPtr() {\n    if(--*use == 0) {\n        delete ps;\n        delete use;\n    }\n}\n\nHasPtr&amp; HasPtr::operator=(const HasPtr&amp; rhs) {\n    ++*rhs.use;\n    if(--*use == 0) {\n        delete ps;\n        delete use;\n    }\n    ps = rhs.ps;\n    i = rhs.i;\n    use = rhs.use;\n    return *this;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_16","title":"\u4ea4\u6362\u64cd\u4f5c","text":"<ul> <li>\u9ed8\u8ba4swap\u4ea4\u6362\u4e24\u4e2a\u5bf9\u8c61\u7684\u975e\u9759\u6001\u6210\u5458\uff1bv1\u4e24\u6b21\u88ab\u62f7\u8d1d\uff0c\u8fd9\u4e9b\u62f7\u8d1d\u4e0d\u662f\u5fc5\u8981\u7684</li> </ul> C++<pre><code>HasPtr tmp = v1;\nv1 = v2;\nv2 = tmp;\n</code></pre> <ul> <li>\u6211\u4eec\u6709\u65f6\u5e0c\u671bswap\u4ea4\u6362\u6307\u9488\uff0c\u800c\u4e0d\u662f\u5206\u914d\u65b0\u526f\u672c\uff1b\u53ef\u4ee5\u7f16\u5199\u6211\u4eec\u81ea\u5df1\u7684swap\u51fd\u6570</li> </ul> C++<pre><code>friend void swap(HasPtr&amp;, HasPtr&amp;);\n\ninline void swap(HasPtr&amp; lhs, HasPtr&amp; rhs) {\n    using std::swap;\n    swap(lhs.ps, rhs.ps);\n    swap(lhs.i, rhs.i);\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#swap","title":"\u8d4b\u503c\u8fd0\u7b97\u7b26\u4e2d\u4f7f\u7528swap","text":"<ul> <li>\u62f7\u8d1d\u5e76\u4ea4\u6362\uff1a\uff08\u53c2\u6570\u6309\u503c\u4f20\u9012\uff0c\u8fdb\u884c\u62f7\u8d1d\uff09</li> <li>rhs\u662f\u53f3\u4fa7\u5bf9\u8c61\u7684\u4e00\u4e2a\u526f\u672c\uff1b\u4f7f\u7528swap\u4ea4\u6362*this\u548crhs\u7684\u6570\u636e\u6210\u5458\uff1b\u662f\u5f02\u5e38\u5b89\u5168\u7684\uff0c\u53ef\u4ee5\u6b63\u786e\u5904\u7406\u81ea\u8d4b\u503c</li> </ul> C++<pre><code>// rhs\u662f\u6309\u503c\u4f20\u9012\u7684\uff0cHasPtr\u7684\u62f7\u8d1d\u6784\u9020\u51fd\u6570\nHasPtr&amp; HasPtr::operator=(HasPtr rhs)\n{\n    swap(*this, rhs);\n    return *this; // rhs\u88ab\u9500\u6bc1\uff0cdelete\u4e86rhs\u4e2d\u7684\u6307\u9488\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_17","title":"\u62f7\u8d1d\u63a7\u5236\uff08\u89c1\u4e66\u4e2d\u4ee3\u7801\uff09","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_18","title":"\u52a8\u6001\u5185\u5b58\u7ba1\u7406\u7c7b","text":"<ul> <li>\u67d0\u4e9b\u7c7b\u9700\u8981\u81ea\u5df1\u8fdb\u884c\u5185\u5b58\u5206\u914d\uff1b\u4e00\u822c\u5b9a\u4e49\u81ea\u5df1\u7684\u62f7\u8d1d\u63a7\u5236\u6210\u5458\u6765\u7ba1\u7406\u5206\u914d\u7684\u5185\u5b58</li> <li>\u91cd\u65b0\u5206\u914d\u5185\u5b58\u7684\u8fc7\u7a0b\u4e2d\u79fb\u52a8\u800c\u4e0d\u662f\u62f7\u8d1d\u5143\u7d20</li> <li>\u4f7f\u7528allocator\u83b7\u5f97\u539f\u59cb\u5185\u5b58</li> <li>\u4e09\u4e2a\u6307\u9488\u6210\u5458\u6307\u5411\u5143\u7d20\u4f7f\u7528\u7684\u5185\u5b58</li> <li>elements\uff1a\u5206\u914d\u5185\u5b58\u4e2d\u7684\u9996\u5143\u7d20</li> <li>first_free\uff1a\u6700\u540e\u4e00\u4e2a\u5b9e\u9645\u5143\u7d20\u7684\u4f4d\u7f6e</li> <li>cap\uff1a\u5206\u914d\u5185\u5b58\u672b\u5c3e\u7684\u4f4d\u7f6e</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#stdmove","title":"\u79fb\u52a8\u6784\u9020\u548cstd::move","text":"<ul> <li>\u4f7f\u7528\u79fb\u52a8\u6784\u9020\u51fd\u6570\uff0cstring\u7ba1\u7406\u7684\u5185\u5b58\u4e0d\u4f1a\u88ab\u62f7\u8d1d\uff1b\u4f1a\u88ab\u6784\u9020\u7684\u65b0\u7684\u5143\u7d20\u63a5\u7ba1\u5185\u5b58\u7684\u6240\u6709\u6743</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_19","title":"\u5bf9\u8c61\u79fb\u52a8","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_20","title":"\u53f3\u503c\u5f15\u7528","text":"<ul> <li>\u5fc5\u987b\u7ed1\u5b9a\u5230\u53f3\u503c\u7684\u5f15\u7528\uff1b\u53ea\u80fd\u7ed1\u5b9a\u5230\u5c06\u8981\u9500\u6bc1\u7684\u5bf9\u8c61</li> <li>const\u5de6\u503c\u5f15\u7528\u53ef\u4ee5\u7ed1\u5b9a\u5230\u53f3\u503c\u4e0a</li> <li>\u6240\u5f15\u7528\u7684\u5bf9\u8c61\u5c06\u8981\u88ab\u9500\u6bc1\uff1b\u5bf9\u8c61\u6ca1\u6709\u5176\u4ed6\u7528\u6237</li> <li>\u4f7f\u7528noexcept\u544a\u77e5\u6807\u51c6\u5e93\u6211\u4eec\u7684\u79fb\u52a8\u6784\u9020\u51fd\u6570\u53ef\u4ee5\u5b89\u5168\u4f7f\u7528</li> <li>\u79fb\u52a8\u540e\u6e90\u5bf9\u8c61\u5fc5\u987b\u53ef\u6790\u6784\uff1a\u5c06\u79fb\u540e\u6e90\u5bf9\u8c61\u6307\u9488\u8d4b\u503cnullptr</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#move","title":"move\u51fd\u6570","text":"<ul> <li> <p>\u5c06\u4e00\u4e2a\u5de6\u503c\u8f6c\u6362\u4e3a\u76f8\u5e94\u7684\u53f3\u503c\u5f15\u7528\u7c7b\u578b</p> </li> <li> <p>\u5185\u90e8\u5b9e\u73b0\uff1a\u4f7f\u7528\u5f15\u7528\u6298\u53e0\u548cstatic_cast\u5f3a\u5236\u8f6c\u6362\u6210\u53f3\u503c\u5f15\u7528\u7c7b\u578b</p> </li> <li> <p>\u4f7f\u7528remove_reference</p> C++<pre><code>template&lt;typename _Tp&gt;\nstruct remove_reference\n{ typedef _Tp   type; };\n\n// \u7279\u5316\u7248\u672c\ntemplate&lt;typename _Tp&gt;\nstruct remove_reference&lt;_Tp&amp;&gt;\n{ typedef _Tp   type; };\n\ntemplate&lt;typename _Tp&gt;\nstruct remove_reference&lt;_Tp&amp;&amp;&gt;\n{ typedef _Tp   type; };\n</code></pre> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_21","title":"\u79fb\u52a8\u6784\u9020\u51fd\u6570\u548c\u79fb\u52a8\u8d4b\u503c\u8fd0\u7b97\u7b26","text":"<ul> <li>\u5b8c\u6210\u8d44\u6e90\u79fb\u52a8\u540e\uff0c\u4ee5\u54e6\u5bf9\u90a3\u4e2a\u6784\u9020\u51fd\u6570\u786e\u4fdd\u79fb\u52a8\u540e\u6e90\u5bf9\u8c61\u4e0d\u518d\u6307\u5411\u88ab\u79fb\u52a8\u7684\u8d44\u6e90</li> </ul> C++<pre><code>StrVec::StrVec(StrVec &amp;&amp;s) noexcept \\\n: elements(s.elements), first_free(s.first_free), cap(s.cap)\n{\n    s.elements = s.first_free = s.cap = nullptr;\n}\n\nStrVec&amp; StrVec::operator=(StrVec &amp;&amp;rhs) noexcept \\\n{\n    if(this != &amp;rhs)\n    {\n        free(); // \u91ca\u653e\u5df2\u6709\u5143\u7d20\n        elements = rhs.elements;\n        first_free = rhs.first_free;\n        cap = rhs.cap;\n        rhs.elements = rhs.first_free = rhs.cap = nullptr;\n    }\n    return *this;\n}\n</code></pre> <ul> <li>\u79fb\u52a8\u540e\u6e90\u5bf9\u8c61\u5fc5\u987b\u53ef\u6790\u6784\uff1b\u5c06\u6e90\u5bf9\u8c61\u7684\u6307\u9488\u7f6e\u4e3a\u7a7a</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_22","title":"\u5408\u6210\u79fb\u52a8\u64cd\u4f5c","text":"<ul> <li>\u53ea\u6709\u4e00\u4e2a\u7c7b\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u81ea\u5df1\u7248\u672c\u7684\u62f7\u8d1d\u63a7\u5236\u6210\u5458\uff1b\u4e14\u6bcf\u4e2a\u975estatic\u6210\u5458\u90fd\u53ef\u4ee5\u79fb\u52a8\u65f6\u624d\u5408\u6210\u79fb\u52a8\u6784\u9020\u51fd\u6570\u548c\u79fb\u52a8\u8d4b\u503c\u8fd0\u7b97\u7b26</li> <li>\u5982\u679c\u7528\u6237=default\uff0c\u4f46\u662f\u6709\u6210\u5458\u4e0d\u80fd\u79fb\u52a8\uff0c\u7f16\u8bd1\u5668\u5c06\u79fb\u52a8\u64cd\u4f5c\u5b9a\u4e49\u4e3a=delete</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_23","title":"\u5408\u6210\u79fb\u52a8\u64cd\u4f5c\u5b9a\u4e49\u4e3a\u5220\u9664","text":"<ul> <li>\u5b9a\u4e49\u4e86\u79fb\u52a8\u6784\u9020\u6216\u79fb\u52a8\u8d4b\u503c\u8fd0\u7b97\u7b26\u7684\u7c7b\u5fc5\u987b\u5b9a\u4e49\u81ea\u5df1\u7684\u62f7\u8d1d\u64cd\u4f5c\uff0c\u5426\u5219\u8fd9\u4e9b\u6210\u5458\u9ed8\u8ba4=delete</li> <li>\u7c7b\u6210\u5458\u6709const\u6216\u5f15\u7528\uff0c\u5b9a\u4e49\u4e3adelete</li> <li>\u6790\u6784=delete\u6216\u4e0d\u80fd\u8bbf\u95ee\uff0c\u5b9a\u4e49\u4e3adelete</li> <li>\u79fb\u52a8\u6784\u9020\u6216\u79fb\u52a8\u8d4b\u503c\u8fd0\u7b97\u7b26\u5b9a\u4e49\u4e3a\u5220\u9664\u6216\u4e0d\u53ef\u8bbf\u95ee</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_24","title":"\u62f7\u8d1d\u5e76\u4ea4\u6362\u8d4b\u503c\u8fd0\u7b97\u7b26\u548c\u79fb\u52a8\u64cd\u4f5c","text":"C++<pre><code>HasPtr(HasPtr&amp;&amp; p) noexcept:ps(p.ps), i(p.i) {p.ps = 0;}\n// \u65e2\u662f\u79fb\u52a8\u8d4b\u503c\u53c8\u662f\u62f7\u8d1d\u8d4b\u503c\nHasPtr&amp; operator=(HasPtr rhs) {\n    swap(*this, rhs);\n    return *this;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_25","title":"\u79fb\u52a8\u8fed\u4ee3\u5668","text":"<ul> <li>make_move_iteraotr\uff1a\u5c06\u4e00\u4e2a\u666e\u901a\u8fed\u4ee3\u5668\u8f6c\u6362\u4e3a\u4e00\u4e2a\u79fb\u52a8\u8fed\u4ee3\u5668</li> <li>\u4e0d\u8981\u968f\u610f\u4f7f\u7528\u79fb\u52a8\u64cd\u4f5c</li> <li>\u53ea\u6709\u5728\u786e\u4fe1\u7b97\u6cd5\u5728\u4e3a\u4e00\u4e2a\u5143\u7d20\u8d4b\u503c\u6216\u5c06\u5176\u4f20\u9012\u7ed9\u4e00\u4e2a\u7528\u6237\u5b9a\u4e49\u7684\u51fd\u6570\u540e\u4e0d\u518d\u8bbf\u95ee\uff0c\u624d\u80fd\u5c06\u79fb\u52a8\u8fed\u4ee3\u5668\u4f20\u9012</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_26","title":"\u53f3\u503c\u5f15\u7528\u548c\u6210\u5458\u51fd\u6570","text":"C++<pre><code>void push_back(const X&amp;); // \u7ed1\u5b9a\u5230\u4efb\u610f\u7c7b\u578b\u7684X\nvoid push_back(X&amp;&amp;);      // \u7ed1\u5b9a\u5230\u7c7b\u578bX\u7684\u53ef\u4fee\u6539\u53f3\u503c\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#_27","title":"\u53f3\u503c\u548c\u5de6\u503c\u5f15\u7528\u6210\u5458\u51fd\u6570","text":"<ul> <li> <p>\u5728\u53c2\u6570\u5217\u8868\u540e\u9762\u653e\u7f6e\u4e00\u4e2a\u5f15\u7528\u9650\u5b9a\u7b26\uff1a</p> </li> <li> <p>\u9650\u5236\u67d0\u4e9b\u65b9\u6cd5\u53ea\u80fd\u5de6\u503c\u5bf9\u8c61\u8c03\uff0c\u6216\u8005\u53ea\u80fd\u53f3\u503c\u5bf9\u8c61\u8c03</p> </li> </ul> C++<pre><code>// \u5bf9\u8c61\u662f\u53f3\u503c\uff0c\u8bf4\u660e\u6ca1\u6709\u5176\u4ed6\u7528\u6237\uff0c\u53ef\u4ee5\u6539\u53d8\u5bf9\u8c61\nFoo Foo:sorted() &amp;&amp; {\n    sort(data.begin(), data.end());\n    return *this;\n}\n</code></pre> <ul> <li> <p>\u8868\u793athis\u6307\u5411\u4e00\u4e2a\u5de6\u503c\u6216\u53f3\u503c</p> </li> <li> <p>\u5f15\u7528\u9650\u5b9a\u7b26\u5fc5\u987b\u8ddf\u968f\u5728const\u9650\u5b9a\u7b26\u4e4b\u540e</p> </li> <li> <p>\u5982\u679c\u4e00\u4e2a\u6210\u5458\u51fd\u6570\u6709\u5f15\u7528\u9650\u5b9a\u7b26\uff0c\u5177\u6709\u76f8\u540c\u53c2\u6570\u5217\u8868\u7684\u6240\u6709\u7248\u672c\u5fc5\u987b\u6709\u5f15\u7528\u9650\u5b9a\u7b26</p> </li> </ul> C++<pre><code>Foo Foo::sorted() const &amp; {\n    Foo ret(*this);\n    return ret.sorted();\n    // \u5bfc\u81f4\u9012\u5f52\u8c03\u7528\u5de6\u503csorted()\uff1b\u4ea7\u751f\u9012\u5f52\u5faa\u73af\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/13_%E6%8B%B7%E8%B4%9D%E6%8E%A7%E5%88%B6/#or","title":"\u5de6\u503cOR\u53f3\u503c","text":"<ul> <li>have identity and cannot be moved from are called lvalue expressions;</li> <li>have identity and can be moved from are called xvalue expressions;</li> <li>do not have identity and can be moved from are called prvalue (\"pure rvalue\") expressions;</li> <li>do not have identity and cannot be moved from are not used[6].</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/","title":"C++-\u91cd\u8f7d\u8fd0\u7b97\u548c\u7c7b\u578b\u8f6c\u6362","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_1","title":"\u91cd\u8f7d\u8fd0\u7b97\u548c\u7c7b\u578b\u8f6c\u6362","text":"<p> \u7ea6 1028 \u4e2a\u5b57  108 \u884c\u4ee3\u7801  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_2","title":"\u57fa\u672c\u6982\u5ff5","text":"<ul> <li> <p>\u91cd\u8f7d\u7684\u8fd0\u7b97\u7b26\u662f\u6210\u5458\u51fd\u6570\u65f6\uff0cthis\u7ed1\u5b9a\u5230\u5de6\u4fa7\u8fd0\u7b97\u5bf9\u8c61\uff1b\u6210\u5458\u8fd0\u7b97\u7b26\u51fd\u6570\u7684\u663e\u5f0f\u53c2\u6570\u6570\u91cf\u6bd4\u8fd0\u7b97\u5bf9\u8c61\u7684\u6570\u91cf\u5c11\u4e00\u4e2a</p> </li> <li> <p>\u5bf9\u4e8e\u4e00\u4e2a\u8fd0\u7b97\u7b26\u51fd\u6570\u6765\u8bf4\uff0c\u5b83\u6216\u8005\u662f\u7c7b\u7684\u6210\u5458\u6216\u8005\u81f3\u5c11\u542b\u6709\u4e00\u4e2a\u7c7b\u7c7b\u578b\u7684\u53c2\u6570</p> </li> </ul> <p></p> C++<pre><code>// \u8c03\u7528\u4e86\u975e\u6210\u5458\u51fd\u6570\ndata + data2;\noperator+(data, data2);\n\n// \u8c03\u7528\u4e86\u6210\u5458\u51fd\u6570\ndata1 += data2;\ndata1.operator+=(data2);\n</code></pre> <ul> <li>\u4f7f\u7528\u4e0e\u5185\u7f6e\u7c7b\u578b\u4e00\u81f4\u7684\u542b\u4e49</li> <li>IO\u7c7b\u578b\u4fdd\u6301\u4e00\u81f4</li> <li>\u5982\u679c\u5b9a\u4e49\u4e86operator==\uff0c\u5e94\u8be5\u5b9a\u4e49operator!=</li> <li>\u5305\u542b\u4e00\u4e2a\u5185\u5728\u7684\u5355\u5e8f\u6bd4\u8f83\uff0c\u5b9a\u4e49operator \\&lt;, operator&gt;...</li> <li>\u903b\u8f91\u8fd0\u7b97\u7b26\u8fd4\u56debool\uff1b\u7b97\u672f\u8fd0\u7b97\u7b26\u8fd4\u56de\u4e00\u4e2a\u7c7b\u7c7b\u578b\u7684\u503c\uff1b\u8d4b\u503c\u8fd0\u7b97\u7b26\u8fd4\u56de\u5de6\u4fa7\u8fd0\u7b97\u5bf9\u8c61\u7684\u4e00\u4e2a\u5f15\u7528</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_3","title":"\u9009\u62e9\u4f5c\u4e3a\u6210\u5458\u6216\u975e\u6210\u5458","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_4","title":"\u8f93\u5165\u548c\u8f93\u51fa\u8fd0\u7b97\u7b26","text":"C++<pre><code>ostream&amp; operator&lt;&lt;(ostream&amp; os, const Sales_data &amp;item)\n{\n    os &lt;&lt; item.isbn();\n    return os;\n}\n</code></pre> <ul> <li> <p>\u5c3d\u91cf\u51cf\u5c11\u683c\u5f0f\u5316\u64cd\u4f5c</p> </li> <li> <p>\u8f93\u5165\u8f93\u51fa\u8fd0\u7b97\u7b26\u5fc5\u987b\u662f\u975e\u6210\u5458\u51fd\u6570\uff1b\u4e00\u822c\u58f0\u660e\u4e3a\u7c7b\u7684\u53cb\u5143</p> </li> <li> <p>\u8bfb\u53d6\u64cd\u4f5c\u53d1\u751f\u9519\u8bef\u65f6\uff0c\u8f93\u5165\u8fd0\u7b97\u7b26\u8d1f\u8d23\u4ece\u9519\u8bef\u4e2d\u6062\u590d</p> </li> <li> <p>IO\u6807\u51c6\u5e93\u6807\u8bc6\u9519\u8bef</p> </li> <li> <p>failbit</p> </li> <li>eofbit\u8868\u793a\u6587\u4ef6\u8017\u5c3d</li> <li>badbit\u8868\u793a\u6d41\u88ab\u7834\u574f</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_5","title":"\u7b97\u672f\u548c\u5173\u7cfb\u8fd0\u7b97\u7b26","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_6","title":"\u8d4b\u503c\u8fd0\u7b97\u7b26","text":"<ul> <li>\u53ef\u4ee5\u5b9a\u4e49\u5176\u4ed6\u8d4b\u503c\u8fd0\u7b97\u7b26\u4f7f\u7528\u522b\u7684\u7c7b\u578b\u4f5c\u4e3a\u53f3\u4fa7\u8fd0\u7b97\u7b26\u5bf9\u8c61</li> </ul> C++<pre><code>StrVec&amp; StrVec::operator=(initializer_list&lt;string&gt; il)\n{\n    auto data = alloc_n_copy(il.begin(), il.end());\n    free();\n    elements = data.first;\n    first_free = data.second;\n    return *this;\n}\n</code></pre> <ul> <li>\u590d\u5408\u8d4b\u503c\u8fd0\u7b97\u7b26\uff1a\u53ef\u4ee5\u4e0d\u5b9a\u4e49\u5728\u7c7b\u5185\uff1b\u4f46\u6700\u597d\u5b9a\u4e49\u5728\u7c7b\u5185\uff0c\u8fd4\u56de\u7c7b\u578b\u4e0e\u8d4b\u503c\u8fd0\u7b97\u7b26\u76f8\u540c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_7","title":"\u4e0b\u6807\u8fd0\u7b97\u7b26","text":"<ul> <li>\u5fc5\u987b\u4e3a\u6210\u5458\u51fd\u6570</li> <li>\u4ee5\u6240\u8bbf\u95ee\u5143\u7d20\u7684\u5f15\u7528\u4f5c\u4e3a\u8fd4\u56de\u503c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_8","title":"\u9012\u589e\u548c\u9012\u51cf\u8fd0\u7b97\u7b26","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_9","title":"\u6210\u5458\u8bbf\u95ee\u8fd0\u7b97\u7b26","text":"C++<pre><code>class StrBlobPtr {\npublic:\n    std::string&amp; operator*() const\n    {\n        auto p = check(curr, \"end\");\n        return (*p)[curr];\n    }\n\n    std::string* operator-&gt;() const\n    {\n        return &amp;this-&gt;operator*();\n    }\n};\n</code></pre> <ul> <li>\u91cd\u8f7d\u7684\u7bad\u5934\u8fd0\u7b97\u7b26\u5fc5\u987b\u8fd4\u56de\u7c7b\u7684\u6307\u9488\u6216\u8005\u81ea\u5b9a\u4e49\u4e86\u7bad\u5934\u8fd0\u7b97\u7b26\u7684\u67d0\u4e2a\u7c7b\u7684\u5bf9\u8c61</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_10","title":"\u51fd\u6570\u8c03\u7528\u8fd0\u7b97\u7b26","text":"C++<pre><code>struct absInt {\n    int operator()(int val) const {\n        return val &lt; 0 ? -val : val;\n    }\n};\n</code></pre> <ul> <li>\u5fc5\u987b\u662f\u6210\u5458\u51fd\u6570\uff1b\u8be5\u7c7b\u7684\u5bf9\u8c61\u4e58\u5750\u51fd\u6570\u5bf9\u8c61</li> <li>\u51fd\u6570\u5bf9\u8c61\u5e38\u5e38\u4f5c\u4e3a\u6cdb\u578b\u7b97\u6cd5\u7684\u5b9e\u53c2</li> </ul> C++<pre><code>class PrintString {\npublic:\n    PrintString(ostream&amp; o = cout, char c = ' '):os(o),sep(c) {}\n    void operator()(const string&amp; s) const {os &lt;&lt; s &lt;&lt; sep;}\nprivate:\n    ostream &amp;os;\n    char sep;\n};\n// \u5148\u521d\u59cb\u5316\u4e34\u65f6\u5bf9\u8c61\uff1b\u8c03\u7528operator()\nfor_each(vs.begin(), vs.end(), PrintString(cerr, '\\n'));\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#lambda","title":"lambda\u662f\u51fd\u6570\u5bf9\u8c61","text":"C++<pre><code>[](const string &amp; a, const string &amp;b){return a.size() &lt; b.size();}\n// is equal to\n\nclass ShorterString {\npublic:\n    bool operator()(const string&amp; a, const string&amp; b) const{\n        return a.size() &lt; b.size();\n    }\n};\n</code></pre> <ul> <li>\u901a\u8fc7\u5f15\u7528\u6355\u83b7\u53d8\u91cf\uff0c\u7a0b\u5e8f\u4fdd\u8bc1\u5bf9\u8c61\u5b58\u5728\uff1b\u7f16\u8bd1\u5668\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8be5\u5f15\u7528</li> <li>\u901a\u8fc7\u503c\u6355\u83b7\uff0c\u9700\u8981\u5efa\u7acb\u6355\u83b7\u53d8\u91cf\u7684\u6570\u636e\u6210\u5458\uff0c\u540c\u65f6\u521b\u5efa\u6784\u9020\u51fd\u6570</li> </ul> C++<pre><code>[sz](const string &amp;a){return a.size() &lt; sz;}\n// is equal to\nclass SizeComp {\nprivate:\n    size_t sz;\npublic:\n    SizeComp(size_t n):sz(n){}\n    bool operator()(const string &amp;a) const }{return a.size() &lt; sz;}\n};\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_11","title":"\u6807\u51c6\u5e93\u51fd\u6570\u5bf9\u8c61","text":"C++<pre><code>// bind1st, bind2nd\u5c06\u4e00\u4e2a\u4e8c\u5143\u51fd\u6570\u53d8\u4e3a\u4e00\u5143\u51fd\u6570\ncount_if(vec.begin(), vec.end(), bind2nd(greater&lt;int&gt;(), 1024));\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#function","title":"\u53ef\u8c03\u7528\u51fd\u6570\u4e0efunction","text":"<ul> <li>\u4e0d\u540c\u7c7b\u578b\u53ef\u80fd\u5177\u6709\u76f8\u540c\u7684\u8c03\u7528\u5f62\u5f0f</li> <li>\u4f46\u6bcf\u4e2alambda\u6709\u81ea\u5df1\u7684\u7c7b\u7c7b\u578b\uff0c\u4e0e\u51fd\u6570\u6307\u9488\u7c7b\u578b\u4e0d\u76f8\u540c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#function_1","title":"\u6807\u51c6\u5e93function\u7c7b\u578b","text":"C++<pre><code>function&lt;int(int,int)&gt; f1 = add;        // \u51fd\u6570\u6307\u9488\nfunction&lt;int(int,int)&gt; f2 = divide();   // \u51fd\u6570\u5bf9\u8c61\u7c7b\u7684\u5bf9\u8c61\nfunction&lt;int(int,int)&gt; f3 = [](int i, int j){return i*j;}   // lambda\n</code></pre> <ul> <li>\u4e0d\u80fd\u5c06\u91cd\u8f7d\u51fd\u6570\u540d\u5b57\u5b58\u50a8\u5728function\u7c7b\u578b\u5bf9\u8c61\u4e2d\uff1b\u4f7f\u7528\u51fd\u6570\u6307\u9488</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_12","title":"\u91cd\u8f7d\u7c7b\u578b\u8f6c\u6362\u4e0e\u8fd0\u7b97\u7b26","text":"<ul> <li> <p><code>operator type() const;</code></p> </li> <li> <p>\u7c7b\u578b\u8f6c\u6362\u7b26\u65f6\u9690\u5f0f\u6267\u884c\u7684\uff0c\u65e0\u6cd5\u7ed9\u51fd\u6570\u4f20\u9012\u5b9e\u53c2\uff1b\u4e0d\u80fd\u5728\u5b9a\u4e49\u4e2d\u4f7f\u7528\u4efb\u4f55\u5f62\u53c2\uff1b\u4f46\u4f1a\u8fd4\u56de\u4e00\u4e2a\u5bf9\u5e94\u7c7b\u578b\u7684\u503c</p> </li> <li> <p>\u4e0d\u6307\u5b9a\u8fd4\u56de\u7c7b\u578b</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_13","title":"\u663e\u793a\u7684\u7c7b\u578b\u8f6c\u6362\u8fd0\u7b97\u7b26","text":"<ul> <li>\u9690\u5f0f\u8f6c\u6362\u53ef\u80fd\u56e0\u4e3a\u6574\u578b\u63d0\u5347\u9020\u6210\u610f\u6599\u4e4b\u5916\u7684\u7ed3\u679c</li> </ul> C++<pre><code>class SmallInt {\n    public:\n    explicit operator int() const {return val;}\n};\n\nstatic_cast&lt;int&gt;(si) + 3; // \u5fc5\u987b\u663e\u793a\u5730\u8bf7\u6c42\u7c7b\u578b\u8f6c\u6362\n</code></pre> <ul> <li>IO\u6807\u51c6\u5e93\u5b9a\u4e49\u4e00\u4e2a\u5411bool\u7684\u663e\u793a\u8f6c\u6362\uff08<code>while (std::cin &gt;&gt; value)</code>\uff09</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_14","title":"\u907f\u514d\u4e8c\u4e49\u6027\u7684\u7c7b\u578b\u8f6c\u6362","text":"<ul> <li>\u4e0d\u8981\u4e3a\u7c7b\u5b9a\u4e49\u76f8\u540c\u7684\u7c7b\u578b\u8f6c\u6362\uff1b\u4e0d\u8981\u5b9a\u4e49\u4e24\u4e2a\u53ca\u4ee5\u4e0a\u8f6c\u6362\u76ee\u6807\u662f\u7b97\u672f\u7c7b\u578b\u7684\u8f6c\u6362</li> <li>\u4e0d\u8981\u5728\u4e24\u4e2a\u7c7b\u4e4b\u95f4\u6784\u5efa\u76f8\u540c\u7684\u7c7b\u578b\u8f6c\u6362</li> <li>\u5982\u679c\u7c7b\u5b9a\u4e49\u4e86\u4e00\u7ec4\u7c7b\u578b\u8f6c\u6362\uff0c\u4ed6\u4eec\u7684\u8f6c\u6362\u6e90\u6216\u8005\u8f6c\u6362\u76ee\u6807\u7c7b\u578b\u672c\u8eab\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u7c7b\u578b\u8f6c\u6362\u8054\u7cfb\u5728\u4e00\u8d77\u4f1a\u9020\u6210\u4e8c\u4e49\u6027\u95ee\u9898</li> </ul> C++<pre><code>struct A {\n    A(int i = 0);\n    A(double);\n};\nlong lg;\nA a2(lg);   // \u4e8c\u4e49\u6027\u9519\u8bef\uff1blong-&gt;double or long-&gt;int\n</code></pre> <ul> <li>\u4f7f\u7528\u4e24\u4e2a\u7528\u6237\u5b9a\u4e49\u7684\u7c7b\u578b\u8f6c\u6362\u65f6\uff0c\u5982\u679c\u8f6c\u6362\u51fd\u6570\u4e4b\u524d\u6216\u4e4b\u540e\u5b58\u5728\u6807\u51c6\u7c7b\u578b\u8f6c\u6362\uff0c\u6807\u51c6\u7c7b\u578b\u8f6c\u6362\u51b3\u5b9a\u6700\u4f73\u5339\u914d</li> <li>\u5982\u679c\u4e24\u4e2a\u7c7b\u578b\u8f6c\u6362\u63d0\u4f9b\u4e86\u540c\u4e00\u79cd\u53ef\u884c\u5339\u914d\uff0c\u7c7b\u578b\u8f6c\u6362\u4e00\u6837\u597d</li> </ul> C++<pre><code>struct C {C(int);};\nstruct D {D(int);};\n\nvoid manip(const C&amp; c);\nvoid manip(const D&amp; e);\nmanip(10);  // \u4e8c\u4e49\u6027\u9519\u8bef\n</code></pre> <ul> <li>\u5982\u679c\u4e24\u4e2a\u7528\u6237\u5b9a\u4e49\u7684\u7c7b\u578b\u8f6c\u6362\u90fd\u63d0\u4f9b\u4e86\u53ef\u884c\u5339\u914d\uff1b\u4e0d\u8003\u8651\u6807\u51c6\u7c7b\u578b\u8f6c\u6362\u7ea7\u522b</li> </ul> C++<pre><code>struct C {C(int);};\nstruct E {E(double);};\n\nvoid manip(const C&amp; c);\nvoid manip(const E&amp; e);\nmanip(10);  // \u4e8c\u4e49\u6027\u9519\u8bef\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/14_%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E5%92%8C%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/#_15","title":"\u51fd\u6570\u5339\u914d\u4e0e\u91cd\u8f7d\u8fd0\u7b97\u7b26","text":"<ul> <li>\u4e0d\u80fd\u901a\u8fc7\u8c03\u7528\u7684\u5f62\u5f0f\u6765\u533a\u5206\u6210\u5458\u51fd\u6570\u6216\u975e\u6210\u5458\u51fd\u6570</li> <li>\u540c\u4e00\u540d\u5b57\u7684\u6210\u5458\u51fd\u6570\u548c\u975e\u6210\u5458\u51fd\u6570\u4e0d\u4f1a\u5f7c\u6b64\u91cd\u8f7d\uff0c\u8fd0\u7b97\u7b26\u7684\u5019\u9009\u51fd\u6570\u96c6\u9700\u8981\u5305\u542b\u4e8c\u8005</li> </ul> C++<pre><code>class SmallInt {\nfriend SmallInt operator+(const SmallInt&amp;, const SmallInt&amp;);\npublic:\n    SmallInt(int i = 0);\n    operator int() const {return val;}\nprivate:\n    std::size_t val;\n};\nSmallInt s1,s2;\nSmallInt s3 = s1 + s2;\nint i = s3 + 0; // \u4e8c\u4e49\u6027\u9519\u8bef\n// \u53ef\u4ee5\u628a0\u8f6c\u5316\u4e3aSmallInt\u4f7f\u7528operator+\uff1b\n// \u4e5f\u53ef\u4ee5\u628as3\u8f6c\u5316\u4e3aint\uff0c\u6267\u884c\u5185\u7f6e\u7684\u52a0\u6cd5\u8fd0\u7b97\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/15_%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/","title":"15_\u9762\u5411\u5bf9\u8c61\u7a0b\u5e8f\u8bbe\u8ba1","text":""},{"location":"notes/c%2B%2Bprimer/15_%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/#oop","title":"OOP","text":"<p> \u7ea6 2 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/","title":"C++-\u53d8\u91cf\u548c\u57fa\u672c\u7c7b\u578b","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_1","title":"\u53d8\u91cf\u548c\u57fa\u672c\u7c7b\u578b","text":"<p> \u7ea6 803 \u4e2a\u5b57  16 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#1","title":"1.\u57fa\u672c\u5185\u7f6e\u7c7b\u578b","text":"<ul> <li>\u7b97\u6570\u7c7b\u578b\u548c\u7a7a\u7c7b\u578b</li> <li><code>bool, char, wchar_t, char16_t, char32_t, short, int, long, long  long, fliat, double, long double</code></li> <li>w_char_t\u786e\u4fdd\u53ef\u4ee5\u5b58\u653e\u673a\u5668\u6700\u5927\u6269\u5c55\u5b57\u7b26\u96c6\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u5b57\u7b26</li> <li>char16_t\uff0cchar32_t\u4e3aUnicode\u5b57\u7b26\u96c6\u670d\u52a1</li> <li>\u4e00\u822cfloat 32bit\uff0cdouble 64bit\uff0clong double 96/128bit</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_2","title":"\u5e26\u7b26\u53f7\u7c7b\u578b\u548c\u65e0\u7b26\u53f7\u7c7b\u578b","text":"<ul> <li>int, short, long, long long\u524d\u76f4\u63a5\u52a0unsigned</li> <li>signed char\u548cunsigned char\uff1bchar\u8868\u73b0\u4e3a\u4e0a\u8ff0\u4e24\u79cd\u4e4b\u4e00</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_3","title":"\u5982\u4f55\u9009\u62e9\u7c7b\u578b","text":"<ul> <li>\u6570\u503c\u4e0d\u4e3a\u8d1f\u65f6\uff0c\u9009\u7528\u65e0\u7b26\u53f7\u7c7b\u578b</li> <li>int\u6267\u884c\u6574\u6570\u8fd0\u7b97\uff1b\u5982\u679c\u8d85\u8fc7int\uff0c\u4f7f\u7528long long</li> <li>\u7b97\u672f\u8868\u8fbe\u5f0f\u4e2d\u4e0d\u8981\u4f7f\u7528char\u548cbool\uff0cchar\u53ef\u80fd\u6709\u7b26\u53f7\uff1b\u660e\u786e\u6307\u660esigned char\u6216unsigned char</li> <li>\u6d6e\u70b9\u6570\u8fd0\u7b97\u9009\u7528double\u7c7b\u578b</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_4","title":"\u7c7b\u578b\u8f6c\u6362","text":"<ul> <li>\u542b\u6709\u65e0\u7b26\u53f7\u53d8\u91cf\u65f6\u8981\u5341\u5206\u6ce8\u610f\uff0c\u6709\u7b26\u53f7\u53d8\u91cf\u4f1a\u81ea\u52a8\u5730\u8f6c\u6362\u6210\u65e0\u7b26\u53f7\u6570</li> <li>\u524d\u7f00\uff08\u5b57\u7b26\uff09\u548c\u540e\u7f00\uff08\u6574\u6570\u6216\u6d6e\u70b9\u6570\uff09</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#2","title":"2.\u53d8\u91cf","text":"<ul> <li><code>initializer_list&lt;string&gt;</code>\uff1a\u5141\u8bb8\u8fdb\u884c\u5217\u8868\u521d\u59cb\u5316</li> </ul> C++<pre><code>struct myclass {\n  myclass (int,int);\n  myclass (initializer_list&lt;int&gt;);\n};\n\nmyclass foo {10,20};  // calls initializer_list ctor\nmyclass bar (10,20);\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_5","title":"\u521d\u59cb\u503c","text":"<ul> <li>\u521d\u59cb\u5316\u4e0d\u662f\u8d4b\u503c\uff0c\u53ea\u662f\u521b\u5efa\u5bf9\u8c61\u662f\u8d4b\u4e00\u4e2a\u521d\u59cb\u503c\uff1b\u8d4b\u503c\u662f\u5c06\u5f53\u524d\u503c\u64e6\u9664\uff0c\u7528\u4e00\u4e2a\u65b0\u503c\u4ee3\u66ff</li> <li>\u4f7f\u7528\u82b1\u62ec\u53f7\u8fdb\u884c\u5217\u8868\u521d\u59cb\u5316\uff0c\u5b58\u5728\u4e22\u5931\u4fe1\u606f\u7684\u98ce\u9669\uff0c\u7f16\u8bd1\u5668\u62a5\u9519</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_6","title":"\u590d\u5408\u7c7b\u578b","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_7","title":"\u5f15\u7528","text":"<ul> <li>\u5f15\u7528\u5fc5\u987b\u88ab\u521d\u59cb\u5316\uff1b\u6307\u5411\u53d8\u91cf\uff08\u662f\u53d8\u91cf\u7684\u53e6\u4e00\u4e2a\u540d\u5b57\uff09</li> <li>\u5c06\u5f15\u7528\u548c\u521d\u59cb\u503c\u7ed1\u5b9a\uff08bind\uff09\u5728\u4e00\u8d77</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_8","title":"\u6307\u9488","text":"<ul> <li>\u7a7a\u6307\u9488\uff1anullptr, 0, NULL\uff08\u9884\u5904\u7406\u53d8\u91cf\uff0c\u503c\u5c31\u662f0\uff09</li> <li>\u4e0d\u80fd\u628aint\u53d8\u91cf\u76f4\u63a5\u8d4b\u7ed9\u6307\u9488\uff0c\u5373\u4f7f\u662f0\u4e5f\u4e0d\u884c</li> <li>int *&amp;r\uff1b\u4ece\u53f3\u5411\u5de6\u7406\u89e3r\u7684\u5b9a\u4e49\uff0c\u662f\u4e00\u4e2a\u5f15\u7528\uff0c\u5f15\u7528\u7684\u5bf9\u8c61\u662f\u4e00\u4e2a\u6307\u9488</li> <li>(void*)obj\uff1a\u7c7b\u4f3c\u8fd4\u56dep-&gt;next</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#const","title":"const\u4fee\u9970\u7b26","text":"<ul> <li>\u7528\u4e00\u4e2a\u5bf9\u8c61\u53bb\u521d\u59cb\u5316\u53e6\u4e00\u4e2a\u5bf9\u8c61\uff0c\u662f\u4e0d\u662fconst\u90fd\u65e0\u5173\u7d27\u8981</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cconst\u5bf9\u8c61\u4ec5\u5728\u6587\u4ef6\u4e2d\u6709\u6548</li> <li>\u5982\u679c\u60f3\u5728\u591a\u4e2a\u6587\u4ef6\u4e4b\u95f4\u5171\u4eabconst\u5bf9\u8c61\uff0c\u4f7f\u7528extern</li> </ul> C++<pre><code>double dval = 3.14;\nconst int &amp;ri = dval;\n\n// \u7f16\u8bd1\u5668\u5c06ri\u7ed1\u5b9a\u5728\u4e00\u4e2a\u4e34\u65f6\u5bf9\u8c61\u4e0a\nconst int tmp = dval;\nconst int &amp;ri = tmp;\n</code></pre> <ul> <li> <p>\u5bf9const\u7684\u5f15\u7528\u53ef\u80fd\u5f15\u7528\u4e00\u4e2a\u5e76\u975econst\u7684\u5bf9\u8c61</p> </li> <li> <p>\u5e38\u91cf\u6307\u9488\u5fc5\u987b\u521d\u59cb\u5316\uff08int* const p = &amp;ri;\uff09\uff0c\u521d\u59cb\u5316\u540e\u4e0d\u80fd\u88ab\u8d4b\u503c\uff1b\u5e38\u91cf\u5fc5\u987b\u521d\u59cb\u5316\uff08const int i = 3;\uff09</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#const_1","title":"\u9876\u5c42const","text":"<ul> <li>\u9876\u5c42const\u8868\u793a\u6307\u9488\u672c\u8eab\u662f\u4e2a\u5e38\u91cf\uff0c\u5e95\u5c42const\u8868\u793a\u6307\u9488\u6240\u6307\u7684\u5bf9\u8c61\u662f\u4e00\u4e2a\u5e38\u91cf</li> <li>\u6267\u884c\u5bf9\u8c61\u7684\u62f7\u8d1d\u64cd\u4f5c\u65f6\uff0c\u5982\u679c\u662f\u9876\u5c42const\uff0c\u4e0d\u53d7\u5f71\u54cd</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#constexpr","title":"constexpr\u548c\u5e38\u91cf\u8868\u8fbe\u5f0f","text":"<ul> <li>constexpr\u7f16\u8bd1\u5668\u9a8c\u8bc1\u53d8\u91cf\u7684\u503c\u662f\u5426\u662f\u4e00\u4e2a\u5e38\u91cf\u8868\u8fbe\u5f0f</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#_9","title":"\u5904\u7406\u7c7b\u578b","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#auto","title":"auto","text":"<ul> <li>\u53ea\u4fdd\u7559\u5e95\u5c42const\uff0c\u5ffd\u7565\u9876\u5c42const</li> </ul> C++<pre><code>const auto f = ci;\nauto &amp;g = ci;\nconst auto &amp;j = 32;\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#decltype","title":"decltype","text":"<ul> <li>\u7f16\u8bd1\u5668\u5206\u6790\u8868\u8fbe\u5f0f\u5f97\u5230\u7c7b\u578b\uff0c\u4f46\u4e0d\u8ba1\u7b97\u8868\u8fbe\u5f0f\u7684\u503c</li> <li>\u8fd4\u56de\u8be5\u53d8\u91cf\u7684\u7c7b\u578b\uff08\u5305\u62ec\u9876\u5c42const\u548c\u5f15\u7528\uff09</li> <li>\u8868\u8fbe\u5f0f\u5185\u5bb9\u662f\u89e3\u5f15\u7528\u64cd\u4f5c\uff0c\u8fd4\u56de\u7684\u662f\u5f15\u7528\u7c7b\u578b</li> <li>\u5982\u679c\u7ed9\u53d8\u91cf\u52a0\u4e0a\u591a\u5c42\u62ec\u53f7\uff0c\u4f1a\u5f97\u5230\u5f15\u7528\u7c7b\u578b</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/2_%E5%8F%98%E9%87%8F%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/#autodecltype","title":"auto\u4e0edecltype\u533a\u522b","text":"<ul> <li>auto\u8ba1\u7b97\u53d8\u91cf\u7684\u521d\u59cb\u503c\u6765\u63a8\u65ad\u7c7b\u578b\uff1bdecltype\u5206\u6790\u8868\u8fbe\u5f0f\u4f46\u4e0d\u8ba1\u7b97\u5b9e\u9645\u8868\u8fbe\u5f0f\u7684\u503c</li> <li>auto\u7c7b\u578b\u548c\u521d\u59cb\u503c\u4e0d\u5b8c\u5168\u4e00\u81f4\uff0c</li> <li>decltype\u7684\u7ed3\u679c\u7c7b\u578b\u548c\u8868\u8fbe\u5f0f\u5f62\u5f0f\u5bc6\u5207\u76f8\u5173\uff0c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/","title":"C++-\u5b57\u7b26\u4e32\u3001\u5411\u91cf\u3001\u6570\u7ec4","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/#_1","title":"\u5b57\u7b26\u4e32\u3001\u5411\u91cf\u3001\u6570\u7ec4","text":"<p> \u7ea6 401 \u4e2a\u5b57  1 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/#using","title":"using\u58f0\u660e","text":"<ul> <li>\u4e00\u822c\u5934\u6587\u4ef6\u4e0d\u5e94\u8be5\u5305\u542busing\u58f0\u660e</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/#string","title":"String","text":"<ul> <li> <p>\u76f4\u63a5\u521d\u59cb\u5316\u548c\u62f7\u8d1d\u521d\u59cb\u5316</p> </li> <li> <p>\u7b49\u6027\u5224\u65ad\u5bf9\u5b57\u6bcd\u7684\u5927\u5c0f\u5199\u654f\u611f</p> </li> <li> <p>\u5982\u679c\u8868\u8fbe\u5f0f\u4e2d\u4f7f\u7528size()\uff08\u8fd4\u56de\u4e00\u4e2a\u65e0\u7b26\u53f7\u6574\u6570\uff09\uff0c\u907f\u514d\u4f7f\u7528int</p> </li> <li> <p>\u5b57\u9762\u503c\u548c\u5bf9\u8c61\u76f8\u52a0\u81f3\u5c11+\u53f7\u4e24\u8fb9\u6709\u4e00\u4e2a\u662fstring\u5bf9\u8c61</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/#vector","title":"Vector","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/#_2","title":"\u8fed\u4ee3\u5668","text":"<ul> <li>begin()\uff1a\u8868\u793a\u7b2c\u4e00\u4e2a\u5143\u7d20, end()\uff1a\u8868\u793a\u5c3e\u5143\u7d20\u7684\u4e0b\u4e00\u4e2a\u5143\u7d20\uff0c\u6307\u793a\u7684\u662f\u6839\u672c\u4e0d\u5b58\u5728\u7684\u5c3e\u540e\u5143\u7d20</li> <li>==, !=\u5982\u679c\u4e24\u4e2a\u8fed\u4ee3\u5668\u6307\u5411\u76f8\u540c\u7684\u5143\u7d20\u6216\u8005\u90fd\u662f\u540c\u4e00\u4e2a\u5bb9\u5668\u7684\u5c3e\u540e\u8fed\u4ee3\u5668\u5219\u76f8\u7b49</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/#_3","title":"\u8fed\u4ee3\u5668\u7c7b\u578b","text":"<ul> <li> <p>iterator\u662f\u53ef\u4ee5\u64cd\u7eb5\u7684\u7c7b\u578b</p> </li> <li> <p>const_iterator\u80fd\u8bfb\u53d6\u4f46\u4e0d\u80fd\u4fee\u6539\u8be5\u8fed\u4ee3\u5668\u6307\u5411\u7684\u5143\u7d20\u503c</p> </li> <li> <p>\u4efb\u4f55\u6539\u53d8vector\u5bb9\u91cf\u7684\u64cd\u4f5c\u4f1a\u4f7f\u5f97\u8fed\u4ee3\u5668\u5931\u6548</p> </li> <li> <p><code>begin();end()</code>\u6b63\u5e8f\u8fed\u4ee3\u5668</p> </li> <li> <p><code>cbegin();cend()</code> \u8fd4\u56de <code>const</code> \u7684<code>begin();end()</code></p> </li> <li> <p><code>rbegin();rend()</code> \u9006\u5e8f\u8fed\u4ee3\u5668</p> </li> <li> <p><code>crbegin();crend()</code> \u8fd4\u56de <code>const</code> \u7684 <code>rbegin();rend()</code></p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/#_4","title":"\u8fed\u4ee3\u5668\u8fd0\u7b97","text":"<ul> <li>iter - n</li> <li>iter + n</li> <li>iter1 += n</li> <li>iter1 -= n</li> <li>iter1 - iter2</li> <li>\u6bd4\u8f83\u5927\u5c0f</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/3_%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%90%91%E9%87%8F%E6%95%B0%E7%BB%84/#_5","title":"\u6570\u7ec4","text":"<ul> <li> <p>\u4e0d\u5141\u8bb8\u62f7\u8d1d\u548c\u8d4b\u503c</p> </li> <li> <p>string\u9ed8\u8ba4\u521d\u59cb\u5316\u4e3a\u7a7a\u4e32</p> </li> <li> <p>\u5185\u7f6e\u7c7b\u578bint\uff0c\u5b9a\u4e49\u4e3a\u5168\u5c40\u9ed8\u8ba4\u4e3a0\uff0c\u5b9a\u4e49\u5728main\u51fd\u6570\u5185\u90e8\uff0c\uff0c\u4e0d\u88ab\u521d\u59cb\u5316\uff0c\u53ef\u80fd\u9047\u5230\u672a\u5b9a\u4e49\u7684\u5947\u5f02\u503c</p> </li> <li> <p>\u5b57\u7b26\u6570\u7ec4\u521d\u59cb\u5316\uff1a\u5217\u8868\u521d\u59cb\u5316\u65b9\u5f0f\u8d4b\u503c\u7684C\u98ce\u683c\u5b57\u7b26\u4e32\u672b\u5c3e\u65e0'\\0'\uff0c\u5b57\u7b26\u4e32\u5b57\u9762\u503c\u8d4b\u503c\u6709'\\0'</p> </li> <li> <p>\u53ef\u4ee5\u7528\u6570\u7ec4\u76f4\u63a5\u521d\u59cb\u5316vector</p> </li> </ul> C++<pre><code>vector&lt;int&gt; vInt(begin(a), end(a));\n</code></pre> <ul> <li>strcpy, strcmp, strcat</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/","title":"C++-\u8868\u8fbe\u5f0f","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#_1","title":"\u8868\u8fbe\u5f0f","text":"<p> \u7ea6 1382 \u4e2a\u5b57  25 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#_2","title":"\u5de6\u503c\u548c\u53f3\u503c","text":"<ul> <li>C++\u8868\u8fbe\u5f0f\u8981\u4e48\u4e3a\u5de6\u503c\u8981\u4e48\u4e3a\u53f3\u503c</li> <li>\u8d4b\u503c\u8fd0\u7b97\u7b26\u9700\u8981\u4e00\u4e2a\u5de6\u503c\u4f5c\u4e3a\u5de6\u4fa7\u8fd0\u7b97\u5bf9\u8c61\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u4ecd\u7136\u662f\u4e00\u4e2a\u5de6\u503c</li> <li>\u53d6\u5730\u5740\u7b26\uff1a\u5f97\u5230\u7684\u6307\u9488\u662f\u4e00\u4e2a\u53f3\u503c</li> <li>\u5185\u7f6e\u89e3\u5f15\u7528\u7b26\u548c\u4e0b\u6807\u8fd0\u7b97\u7b26\uff0c\u8fed\u4ee3\u5668\u89e3\u5f15\u7528\u7b26\uff0cstring &amp; vector\u7684\u4e0b\u6807\u8fd0\u7b97\u7b26\u5747\u662f\u5de6\u503c</li> <li>\u5185\u7f6e\u7c7b\u578b\u548c\u8fed\u4ee3\u5668\u7684\u9012\u589e\u9012\u51cf\u8fd0\u7b97\u7b26\u4f5c\u7528\u4e8e\u5de6\u503c\u8fd0\u7b97\u5bf9\u8c61</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#_3","title":"\u9012\u589e\u548c\u9012\u51cf\u8fd0\u7b97\u7b26","text":"<ul> <li>\u4f5c\u7528\u4e8e\u5de6\u503c\u8fd0\u7b97\u5bf9\u8c61\uff0c\u524d\u7f6e\u7248\u672c\u5c06\u5bf9\u8c61\u672c\u8eab\u4f5c\u4e3a\u5de6\u503c\u8fd4\u56de\uff1b\u540e\u7f6e\u7248\u672c\u4f5c\u4e3a\u53f3\u503c\u8fd4\u56de</li> <li>\u4e0d\u5efa\u8bae\u4f7f\u7528\u540e\u7f6e\u7248\u672c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#_4","title":"\u7c7b\u578b\u8f6c\u6362","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#_5","title":"\u7b97\u6570\u8f6c\u6362","text":"<ul> <li>\u6574\u578b\u63d0\u5347\uff1a\u628a\u5c0f\u6574\u6570\u7c7b\u578b\u8f6c\u6362\u6210\u8f83\u5927\u7684\u6574\u6570\u7c7b\u578b</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#_6","title":"\u5176\u4ed6\u9690\u5f0f\u7c7b\u578b\u8f6c\u6362","text":"<ul> <li> <p>\u6570\u7ec4\u8f6c\u6362\u6210\u6307\u9488</p> </li> <li> <p>\u6307\u9488\u7684\u8f6c\u6362\u8f6c\u6362\u6210bool</p> </li> <li> <p>\u8f6c\u6362\u6210\u5e38\u91cf</p> </li> <li> <p>\u7c7b\u7c7b\u578b\u5b9a\u4e49\u7684\u8f6c\u6362</p> </li> </ul> C++<pre><code>string s,t = \"a value\";   // \u5b57\u7b26\u4e32\u5b57\u9762\u503c\u8f6c\u5316\u4e3astring\u7c7b\u578b\nwhile(cin &gt;&gt; s)           // while\u628acin\u8f6c\u5316\u4e3aBool\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#_7","title":"\u7c7b\u578b\u8f6c\u6362\u7b26","text":"<ul> <li> <p>const_cast</p> </li> <li> <p>const_cast\u53ea\u9488\u5bf9\u6307\u9488\u3001\u5f15\u7528\uff0c\u5f53\u7136\uff0cthis\u6307\u9488\u4e5f\u662f\u5176\u4e2d\u4e4b\u4e00</p> </li> <li>const_cast\u7684\u5927\u90e8\u5206\u4f7f\u7528\u4e3b\u8981\u662f\u5c06\u5e38\u91cf\u6307\u9488\u8f6c\u6362\u4e3a\u5e38\u6307\u9488\u3002\u5e38\u91cf\u6307\u9488\u6307\u5411\u7684\u7a7a\u95f4\u7684\u5185\u5bb9\u4e0d\u5141\u8bb8\u88ab\u4fee\u6539\uff0c\u4f46\u662f\u4f7f\u7528const_cast\u8fdb\u884c\u5f3a\u5236\u8f6c\u6362\u5c31\u53ef\u4ee5\u4fee\u6539\u3002</li> <li> <p>const_cast\u53ea\u80fd\u8c03\u8282\u7c7b\u578b\u9650\u5b9a\u7b26\uff0c\u4e0d\u80fd\u4fee\u6539\u57fa\u672c\u7c7b\u578b\u3002</p> </li> <li> <p>static_cast</p> </li> <li> <p>static_cast\u7684\u4f7f\u7528\u57fa\u672c\u7b49\u4ef7\u4e8e\u9690\u5f0f\u8f6c\u6362\u7684\u4e00\u79cd\u7c7b\u578b\u8f6c\u5316\u8fd0\u7b97\u7b26\uff0c\u53ef\u4f7f\u7528\u4e8e\u9700\u8981\u660e\u786e\u9690\u5f0f\u8f6c\u6362\u7684\u5730\u65b9\u3002\u5c31\u76f8\u5f53\u4e8e\u628a\u9690\u5f0f\u8f6c\u6362\u7ed9\u660e\u786e\u5199\u4e86\u51fa\u6765\u800c\u5df2</p> </li> <li> <p>\u53ef\u7528\u4e8e\u4f4e\u98ce\u9669\u8f6c\u6362\uff0c\u9ad8\u98ce\u9669\u8f6c\u6362\u4e0d\u884c</p> </li> <li> <p>dynamic_cast</p> </li> <li> <p>\u7528\u4e8e\u5177\u6709\u865a\u51fd\u6570\u7684\u57fa\u7c7b\u4e0e\u6d3e\u751f\u7c7b\u4e4b\u95f4\u7684\u6307\u9488\u6216\u5f15\u7528\u7684\u8f6c\u6362\u3002</p> </li> <li>\u57fa\u7c7b\u5fc5\u987b\u5177\u6709\u865a\u51fd\u6570\u3002dynamic_cast\u662f\u8fd0\u884c\u65f6\u7c7b\u578b\u4fe1\u606f\uff08RTTI\uff09\uff0c\u800c\u8fd9\u4e2a\u4fe1\u606f\u662f\u5b58\u50a8\u4e0e\u7c7b\u7684\u865a\u51fd\u6570\u8868\u5173\u7cfb\u7d27\u5bc6\u7684\u4fe1\u606f\uff0c\u53ea\u6709\u4e00\u4e2a\u7c7b\u5b9a\u4e49\u4e86\u865a\u51fd\u6570\uff0c\u624d\u4f1a\u6709\u865a\u51fd\u6570\u8868\u3002\u8fd0\u884c\u65f6\u68c0\u67e5\uff0c\u8f6c\u578b\u4e0d\u6210\u529f\u5219\u8fd4\u56de\u4e00\u4e2a\u7a7a\u6307\u9488,\u975e\u5fc5\u8981\u4e0d\u4f7f\u7528dynamic_cast\uff0c\u56e0\u4e3a\u6709\u989d\u5916\u7684\u5f00\u9500\u3002</li> <li>\u5e38\u7528\u7684\u8f6c\u6362\u65b9\u5f0f     \u57fa\u7c7b\u6307\u9488\u6216\u5f15\u7528\u8f6c\u6d3e\u751f\u7c7b\u6307\u9488\uff08\u5fc5\u987b\u4f7f\u7528dynamic_cast\uff09     \u6d3e\u751f\u7c7b\u6307\u9488\u6216\u5f15\u7528\u8f6c\u57fa\u7c7b\u6307\u9488\uff08\u53ef\u4ee5\u4f7f\u7528dynamic_cast,\u4f46\u662f\u66f4\u63a8\u8350\u7528static_cast\uff09</li> </ul> C++<pre><code>B *pb; // B is base class\nD *pd, md; // D is \u6d3e\u751f class\npb=&amp;md; \npd=dynamic&lt;D*&gt;(pb);\n</code></pre> <ul> <li> <p>reinterpret_cast</p> </li> <li> <p>\u5f3a\u5236\u8f6c\u6362</p> </li> </ul> C++<pre><code>const std::string&amp; StrVector::at(size_t index) const {\n return static_cast&lt;const\nstd::string&amp;&gt;(const_cast&lt;StrVector*&gt;(this)-&gt;at(index));\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#rtti","title":"RTTI","text":"<ul> <li>Run Time Type Identification\uff1a\u8fd0\u884c\u65f6\u7c7b\u578b\u8bc6\u522b\uff1b\u7a0b\u5e8f\u4f7f\u7528\u57fa\u7c7b\u7684\u6307\u9488\u6216\u5f15\u7528\u68c0\u67e5\u8fd9\u4e9b\u6307\u9488\u6216\u5f15\u7528\u6240\u6307\u5bf9\u8c61\u7684\u5b9e\u9645\u6d3e\u751f\u7c7b\u578b</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#typeid","title":"typeid\u8fd0\u7b97\u7b26","text":"<ul> <li> <p>typeid\u8fd0\u7b97\u7b26\uff0c\u540e\u63a5\u4e00\u4e2a\u7c7b\u578b\u540d\u6216\u4e00\u4e2a\u8868\u8fbe\u5f0f\uff0c\u8be5\u8fd0\u7b97\u7b26\u8fd4\u56de\u4e00\u4e2a\u7c7b\u578b\u4e3astd::tpeinfo\u7684\u5bf9\u8c61\u7684const\u5f15\u7528\u3002type_info\u662fstd\u4e2d\u7684\u4e00\u4e2a\u7c7b\uff0c\u5b83\u7528\u4e8e\u8bb0\u5f55\u4e0e\u7c7b\u578b\u76f8\u5173\u7684\u4fe1\u606f\u3002</p> </li> <li> <p>typeid\u8bc6\u522b\u9759\u6001\u7c7b\u578b</p> </li> </ul> <p>\u5f53typeid\u4e2d\u7684\u64cd\u4f5c\u6570\u662f\u5982\u4e0b\u60c5\u51b5\u4e4b\u4e00\u65f6\uff0ctypeid\u8fd0\u7b97\u7b26\u6307\u51fa\u64cd\u4f5c\u6570\u7684\u9759\u6001\u7c7b\u578b\uff0c\u5373\u7f16\u8bd1\u65f6\u7684\u7c7b\u578b\u3002</p> <p>\uff081\uff09\u7c7b\u578b\u540d</p> <p>\uff082\uff09\u4e00\u4e2a\u57fa\u672c\u7c7b\u578b\u7684\u53d8\u91cf</p> <p>\uff083\uff09\u4e00\u4e2a\u5177\u4f53\u7684\u5bf9\u8c61</p> <p>\uff084\uff09\u4e00\u4e2a\u6307\u5411\u4e0d\u542b\u6709virtual\u51fd\u6570\u7684\u7c7b\u5bf9\u8c61\u7684\u6307\u9488\u7684\u89e3\u5f15\u7528</p> <p>\uff085\uff09\u4e00\u4e2a\u6307\u5411\u4e0d\u542b\u6709virtual\u51fd\u6570\u7684\u7c7b\u5bf9\u8c61\u7684\u5f15\u7528</p> <p>\u9759\u6001\u7c7b\u578b\u5728\u7a0b\u5e8f\u7684\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u5e76\u4e0d\u4f1a\u6539\u53d8\uff0c\u6240\u4ee5\u5e76\u4e0d\u9700\u8981\u5728\u7a0b\u5e8f\u8fd0\u884c\u65f6\u8ba1\u7b97\u7c7b\u578b\uff0c\u5728\u7f16\u8bd1\u65f6\u5c31\u80fd\u6839\u636e\u64cd\u4f5c\u6570\u7684\u9759\u6001\u7c7b\u578b\uff0c\u63a8\u5bfc\u51fa\u5176\u7c7b\u578b\u4fe1\u606f\u3002</p> <ul> <li>typeid\u8bc6\u522b\u591a\u6001\u7c7b\u578b</li> </ul> <p>\u5f53typeid\u4e2d\u7684\u64cd\u4f5c\u6570\u662f\u5982\u4e0b\u60c5\u51b5\u4e4b\u4e00\u65f6\uff0ctypeid\u8fd0\u7b97\u7b26\u9700\u8981\u5728\u7a0b\u5e8f\u8fd0\u884c\u65f6\u8ba1\u7b97\u7c7b\u578b\uff0c\u56e0\u4e3a\u5176\u5176\u64cd\u4f5c\u6570\u7684\u7c7b\u578b\u5728\u7f16\u8bd1\u65f6\u671f\u662f\u4e0d\u80fd\u88ab\u786e\u5b9a\u7684\u3002</p> <p>\uff081\uff09\u4e00\u4e2a\u6307\u5411\u4e0d\u542b\u6709virtual\u51fd\u6570\u7684\u7c7b\u5bf9\u8c61\u7684\u6307\u9488\u7684\u89e3\u5f15\u7528</p> <p>\uff082\uff09\u4e00\u4e2a\u6307\u5411\u4e0d\u542b\u6709virtual\u51fd\u6570\u7684\u7c7b\u5bf9\u8c61\u7684\u5f15\u7528</p> <p>\u591a\u6001\u7684\u7c7b\u578b\u662f\u53ef\u4ee5\u5728\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u88ab\u6539\u53d8\u7684\uff0c\u4f8b\u5982\uff0c\u4e00\u4e2a\u57fa\u7c7b\u7684\u6307\u9488\uff0c\u5728\u7a0b\u5e8f\u8fd0\u884c\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5b83\u53ef\u4ee5\u6307\u5411\u4e00\u4e2a\u57fa\u7c7b\u5bf9\u8c61\uff0c\u4e5f\u53ef\u4ee5\u6307\u5411\u8be5\u57fa\u7c7b\u7684\u6d3e\u751f\u7c7b\u7684\u5bf9\u8c61\uff0c\u800ctypeid\u8fd0\u7b97\u7b26\u9700\u8981\u5728\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u8bc6\u522b\u51fa\u8be5\u57fa\u7c7b\u6307\u9488\u6240\u6307\u5411\u7684\u5bf9\u8c61\u7684\u5b9e\u9645\u7c7b\u578b\uff0c\u8fd9\u5c31\u9700\u8981typeid\u8fd0\u7b97\u7b26\u5728\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u8ba1\u7b97\u5176\u6307\u5411\u7684\u5bf9\u8c61\u7684\u5b9e\u9645\u7c7b\u578b\u3002</p> <ul> <li> <p>\u5173\u4e8e\u591a\u6001\u7c7b\u578b\u7684\u8ba1\u7b97\u662f\u901a\u8fc7\u57fa\u7c7b\u6307\u9488\u6216\u5f15\u7528\u6307\u5411\u7684\u5bf9\u8c61\uff08\u5b50\u5bf9\u8c61\uff09\u7684\u865a\u51fd\u6570\u8868\u83b7\u5f97\u7684</p> </li> <li> <p>\u7136\u800c\u5728C++\u4e2d\u5373\u4f7f\u4e00\u4e2a\u7c7b\u4e0d\u5177\u6709\u591a\u6001\u7684\u6027\u8d28\uff0c\u4ecd\u7136\u5141\u8bb8\u628a\u4e00\u4e2a\u6d3e\u751f\u7c7b\u7684\u6307\u9488\u8d4b\u503c\u7ed9\u4e00\u4e2a\u57fa\u7c7b\u7684\u6307\u9488\uff0c\u6240\u4ee5\u8fd9\u4e2a\u9519\u8bef\u6bd4\u8f83\u9690\u6666\u3002</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#_8","title":"\u524d\u5411\u58f0\u660e","text":"<ul> <li>A forward declaration allows us to tell the compiler about the existence of an identifier before actually defining the identifier.</li> </ul> C++<pre><code>#include &lt;iostream&gt;\n\nint add(int x, int y); // forward declaration of add() (using a function declaration)\n\nint main()\n{\n    std::cout &lt;&lt; \"The sum of 3 and 4 is: \" &lt;&lt; add(3, 4) &lt;&lt; '\\n'; // this works because we forward declared add() above\n    return 0;\n}\n\nint add(int x, int y) // even though the body of add() isn't defined until here\n{\n    return x + y;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#declarations-vs-definitions","title":"Declarations vs. definitions","text":"<ul> <li>A declaration is a statement that tells the compiler about the existence of an identifier and its associated type information. Here are some examples of declarations:</li> </ul> C++<pre><code>int add(int x, int y); // tells the compiler about a function named \"add\" that takes two int parameters and returns an int.  No body!\nint x;                 // tells the compiler about an integer variable named x\n</code></pre> <ul> <li>In C++, all definitions also serve as declarations</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/4_%E8%A1%A8%E8%BE%BE%E5%BC%8F/#the-one-definition-ruleodr","title":"The one definition rule(ODR)","text":"<ul> <li> <p>The one definition rule (or ODR for short) is a well-known rule in C++. The ODR has three parts:</p> </li> <li> <p>Within a given file, a function, variable, type, or template can only have one definition.</p> </li> <li> <p>Within a given program, a variable or normal function can only have one definition. This distinction is made because programs can have more than one file (we\u2019ll cover this in the next lesson).</p> </li> <li> <p>Types, templates, inline functions, and inline variables are allowed to have identical definitions in different files. We haven\u2019t covered what most of these things are yet, so don\u2019t worry about this for now -- we\u2019ll bring it back up when it\u2019s relevant.</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/","title":"C++-\u8bed\u53e5","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/#_1","title":"\u8bed\u53e5","text":"<p> \u7ea6 504 \u4e2a\u5b57  20 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/#switch","title":"switch","text":"<ul> <li>\u5185\u90e8\u53d8\u91cf\u5b9a\u4e49\uff0c\u4f7f\u7528\u82b1\u62ec\u53f7\uff1b\u53ea\u5b9a\u4e49\u5728\u8be5\u5757\u5185</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/#try","title":"try\u8bed\u53e5\u5757\u548c\u5f02\u5e38\u5904\u7406","text":"<ul> <li>throw\u8868\u8fbe\u5f0f</li> <li>try{...}catch(runtime_error e){...}</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/#_2","title":"\u6807\u51c6\u5f02\u5e38","text":"<ul> <li> <p>excception\uff1a\u5934\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u901a\u7528\u7684\u5f02\u5e38\u7c7bexception\u3002\u53ea\u62a5\u544a\u5f02\u5e38\u7684\u53d1\u751f\uff0c\u4e0d\u63d0\u4f9b\u989d\u5916\u7684\u4fe1\u606f</p> </li> <li> <p>stdexcept\uff1a\u5b9a\u4e49\u4e86\u96c6\u4e2d\u5e38\u7528\u7684\u5f02\u5e38\u7c7b</p> </li> <li> <p>new\u5934\u6587\u4ef6\u5b9a\u4e49\u4e86bad_alloc</p> </li> <li> <p>type_info\u5934\u6587\u4ef6\u5b9a\u4e49\u4e86bad_cast\u5f02\u5e38\u7c7b\u578b</p> </li> <li> <p>\u5f02\u5e38\u7c7b\u578b\u53ea\u6709\u4e00\u4e2awhat\u6210\u5458\u51fd\u6570\uff0c\u8fd4\u56de\u503c\u662f\u4e00\u4e2aC\u98ce\u683c\u5b57\u7b26\u4e32</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/#header-guardsinclude-guard","title":"Header guards(include guard)","text":"<ul> <li>\u907f\u514d\u4e00\u4e2a\u5934\u6587\u4ef6\u88ab\u591a\u6b21\u5f15\u7528</li> </ul> C++<pre><code>int getSquareSides()  // from square.h\n{\n    return 4;\n}\n\nint getSquareSides() // from wave.h (via square.h)\n{\n    return 4;\n}\n\nint main()\n{\n    return 0;\n}\n</code></pre> C++<pre><code>#ifndef SOME_UNIQUE_NAME_HERE\n#define SOME_UNIQUE_NAME_HERE\n\n// your declarations (and certain types of definitions) here\n\n#endif\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/#header-guards-do-not-prevent-a-header-from-being-included-once-into-different-code-files","title":"Header guards do not prevent a header from being included once into different code files","text":"<ul> <li> <p>\u5982\u679c\u5728\u5934\u6587\u4ef6\u8fdb\u884c\u51fd\u6570\u5b9a\u4e49\uff0c\u5982\u679c\u6709\u591a\u4e2a\u6e90\u6587\u4ef6\u53ef\u80fd\u9020\u6210\u94fe\u63a5\u5931\u8d25\uff0c\u591a\u6b21\u5b9a\u4e49\u540c\u4e00\u4e2a\u51fd\u6570</p> </li> <li> <p>The best way to work around this issue is simply to put the function definition in one of the .cpp files so that the header just contains a forward declaration:</p> </li> <li> <p>Now when the program is compiled, function getSquareSides will have just one definition (via square.cpp), so the linker is happy. File main.cpp is able to call this function (even though it lives in square.cpp) because it includes square.h, which has a forward declaration for the function (the linker will connect the call to getSquareSides from main.cpp to the definition of getSquareSides in square.cpp).</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/5_%E8%AF%AD%E5%8F%A5/#pragma-once","title":"#pragma once","text":"<ul> <li> <p>\u4e3a\u4e86\u907f\u514d\u540c\u4e00\u4e2a\u5934\u6587\u4ef6\u88abInclude\u591a\u6b21</p> </li> <li> <p>#pragma once \u5e76\u4e0d\u662fC++\u7684\u539f\u751f\u8bed\u6cd5\uff0c\u800c\u662f\u7f16\u8bd1\u5668\u7684\u4e00\u79cd\u652f\u6301\uff0c\u6240\u4ee5\u5e76\u4e0d\u662f\u6240\u6709\u7684\u7f16\u8bd1\u5668\u90fd\u80fd\u591f\u652f\u6301\u3002#ifndef \u5219\u4e3aC++\u7684\u6807\u51c6</p> </li> <li> <p>#ifndef \u4f9d\u8d56\u4e8e\u4e0d\u91cd\u590d\u7684\u5b8f\u540d\u79f0\uff0c\u4fdd\u8bc1\u4e86\u5305\u542b\u5728 #endif \u7684\u5185\u5bb9\u4e0d\u4f1a\u88ab\u91cd\u590d\u5305\u542b\uff0c\u8fd9\u4e2a\u5185\u5bb9\u53ef\u4ee5\u662f\u4e00\u4e2a\u6587\u4ef6\u7684\u6240\u6709\u5185\u5bb9\uff0c\u6216\u8005\u4ec5\u4ec5\u662f\u4e00\u6bb5\u4ee3\u7801\u3002\u800c #pragma once \u5219\u662f\u9488\u5bf9\u7269\u7406\u6587\u4ef6\u7684\u4e00\u4e2a\u6807\u8bb0\uff0c\u6807\u8bb0\u8be5\u6587\u4ef6\u4e0d\u4f1a\u88ab #include \u591a\u6b21\uff0c\u4e0d\u80fd\u53ea\u9488\u5bf9\u6587\u4ef6\u4e2d\u67d0\u6bb5\u4ee3\u7801\u8fdb\u884c\u6807\u8bb0\u3002\u800c\u4e14\uff0c#pragma once \u4e0d\u80fd\u4fdd\u8bc1\u591a\u4e2a\u6587\u4ef6\u7684\u62f7\u8d1d\u4e0d\u4f1a\u88ab\u91cd\u590d\u5305\u542b</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/","title":"C++-\u51fd\u6570","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_1","title":"\u51fd\u6570","text":"<p> \u7ea6 667 \u4e2a\u5b57  39 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_2","title":"\u53c2\u6570\u4f20\u9012","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_3","title":"\u4f20\u503c\u53c2\u6570","text":"<ul> <li>\u5b9e\u53c2\u7684\u503c\u4e0d\u53d8</li> <li>\u521d\u59cb\u503c\u88ab\u62f7\u8d1d\u7ed9\u53d8\u91cf</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_4","title":"\u4f20\u6307\u9488","text":"<ul> <li> <p>\u62f7\u8d1d\u7684\u662f\u6307\u9488\uff0c\u4e24\u4e2a\u6307\u9488\u4e0d\u540c\uff0c\u4f46\u6307\u5411\u76f8\u540c\u7684\u5bf9\u8c61</p> </li> <li> <p>\u53ef\u4ee5\u6539\u53d8\u5b9e\u53c2\u7684\u503c</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_5","title":"\u4f20\u5f15\u7528\u53c2\u6570","text":"<ul> <li>\u7ed1\u5b9a\u4e86\u521d\u59cb\u5316\u5b83\u7684\u5bf9\u8c61</li> <li>\u907f\u514d\u62f7\u8d1d</li> <li>\u51fd\u6570\u4e0d\u9700\u8981\u6539\u53d8\u5f15\u7528\u5f62\u53c2\u7684\u503c\uff0c\u58f0\u660e\u6210\u5e38\u91cf\u5f15\u7528</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#const","title":"const\u5f62\u53c2\u548c\u5b9e\u53c2","text":"<ul> <li>\u5b9e\u53c2\u521d\u59cb\u5316\u5f62\u53c2\u65f6\u4f1a\u5ffd\u7565\u6389\u9876\u5c42const</li> <li>\u5c3d\u53ef\u80fd\u4f7f\u7528\u5e38\u91cf\u5f15\u7528</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_6","title":"\u6570\u7ec4\u5f62\u53c2","text":"C++<pre><code>void print(const char *cp);\nvoid print(const int *beg, const int *end); // \u4f20\u9012\u6307\u5411\u6570\u7ec4\u9996\u90e8\u548c\u5c3e\u90e8\u7684\u6307\u9488\nvoid print(const int ia[], size_t size);\nvoid print(int (&amp;arr)[10]);\nvoid print(int (*arr)[10]); // \u4f20\u9012\u591a\u7ef4\u6570\u7ec4\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_7","title":"\u53ef\u53d8\u5f62\u53c2","text":"<ul> <li>initializer_list\u5f62\u53c2\uff1a\u53c2\u6570\u6570\u91cf\u672a\u77e5\u4f46\u5168\u90e8\u5b9e\u53c2\u7c7b\u578b\u76f8\u540c</li> <li>\u8be5\u5bf9\u8c61\u4e2d\u7684\u5143\u7d20\u6c38\u8fdc\u662f\u5e38\u91cf\u503c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_8","title":"\u7701\u7565\u7b26\u5f62\u53c2","text":"<ul> <li>\u4f7f\u7528\u4e86varargs\u7684C\u6807\u51c6\u5e93\u529f\u80fd</li> <li>\u7701\u7565\u7b26\u5f62\u53c2\u53ea\u80fd\u51fa\u73b0\u5728\u5f62\u53c2\u5217\u8868\u7684\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_9","title":"\u8fd4\u56de\u503c","text":"<ul> <li>\u53d8\u91cf\u7684\u9012\u51cf\u64cd\u4f5c\u548c\u8bfb\u53d6\u53d8\u91cf\u503c\u7684\u64cd\u4f5c\u5171\u5b58\u4e8e\u540c\u4e00\u6761\u8868\u8fbe\u5f0f\u4e2d\uff0c\u53ef\u80fd\u4ea7\u751f\u672a\u5b9a\u4e49\u7684\u503c</li> </ul> C++<pre><code>int &amp;get(int *array, int index) {return array[index];}  //\u83b7\u53d6\u6570\u7ec4\u4e2dIndex\u5143\u7d20\u7684\u7d22\u5f15\nint main()\n{\n    int ia[10];\n    for(int i = 0; i != 10; ++i)\n        get(ia, i) = i;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_10","title":"\u8fd4\u56de\u4e00\u4e2a\u503c","text":"<ul> <li> <p>\u62f7\u8d1d\u8c03\u7528\u70b9\u7684\u4e00\u4e2a\u4e34\u65f6\u5bf9\u8c61\uff0c\u8be5\u4e34\u65f6\u5bf9\u8c61\u5373\u4e3a\u8fd4\u56de\u7ed3\u679c</p> </li> <li> <p>\u4e0d\u8981\u8fd4\u56de\u5c40\u90e8\u5bf9\u8c61\u7684\u6307\u9488\u6216\u5f15\u7528</p> </li> <li> <p>\u5f15\u7528\u8fd4\u56de\u5de6\u503c\uff1b\u5176\u4ed6\u7c7b\u578b\u8fd4\u56de\u53f3\u503c</p> </li> <li> <p>\u5217\u8868\u521d\u59cb\u5316\u8fd4\u56de\u503c\uff1a\u5bf9\u8fd4\u56de\u7684\u4e34\u65f6\u91cf\u8fdb\u884c\u521d\u59cb\u5316</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_11","title":"\u58f0\u660e\u4e00\u4e2a\u8fd4\u56de\u6570\u7ec4\u6307\u9488\u7684\u51fd\u6570","text":"C++<pre><code>int (*func(int i))[10];\n// \u5c3e\u7f6e\u7c7b\u578b\nauto func(int i) -&gt; int(*)[10];\n// decltype\nint odd[] = {1,3,5,7,9};\nint even[] = {2,4,6,8,10};\ndecltype(odd) *arrPtr(int i) {\n    return (i % 2) ? &amp;odd : &amp;even;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_12","title":"\u51fd\u6570\u91cd\u8f7d","text":"<ul> <li>\u4e0d\u533a\u5206\u9876\u5c42const\u7684\u5f62\u53c2</li> <li>\u6ce8\u610f\u91cd\u8f7d\u51fd\u6570\u7684\u4f5c\u7528\u57df</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_13","title":"\u9ed8\u8ba4\u5b9e\u53c2","text":"<ul> <li>\u51fd\u6570\u58f0\u660e\u4e2d\u6307\u5b9a\u9ed8\u8ba4\u5b9e\u53c2\uff0c\u5e76\u5c06\u58f0\u660e\u653e\u5728\u5408\u9002\u7684\u5934\u6587\u4ef6\u4e2d</li> <li>\u5c40\u90e8\u53d8\u91cf\u4e0d\u80fd\u4f5c\u4e3a\u9ed8\u8ba4\u5b9e\u53c2</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_14","title":"\u5185\u8054\u51fd\u6570","text":"<ul> <li>\u5728\u6bcf\u4e2a\u8c03\u7528\u70b9\u201c\u5185\u8054\u5730\u201d\u5c55\u5f00</li> <li>\u5185\u8054\u673a\u5236\u7528\u4e8e\u4f18\u5316\u89c4\u6a21\u8f83\u5c0f\uff0c\u6d41\u7a0b\u76f4\u63a5\uff0c\u9891\u7e41\u8c03\u7528\u7684\u51fd\u6570</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#constexpr","title":"constexpr\u51fd\u6570","text":"<ul> <li>\u5e38\u91cf\u8868\u8fbe\u5f0f\u7684\u51fd\u6570</li> <li>\u8fd4\u56de\u7c7b\u578b\u548c\u6240\u6709\u5f62\u53c2\u7684\u7c7b\u578b\u5747\u662f\u5b57\u9762\u503c\u7c7b\u578b\uff0c\u51fd\u6570\u4f53\u6709\u4e14\u53ea\u6709\u4e00\u6761return\u8bed\u53e5</li> </ul> C++<pre><code>constexpr int new_sz(){return 42;}\nconstexpr int foo = new_sz();\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_15","title":"\u5b9e\u53c2\u7c7b\u578b\u8f6c\u6362","text":"<ul> <li>\u7cbe\u786e\u5339\u914d</li> <li>\u5f62\u53c2\u548c\u5b9e\u53c2\u7c7b\u578b\u76f8\u540c</li> <li>\u5b9e\u53c2\u7531\u6570\u7ec4\u6216\u51fd\u6570\u8f6c\u6362\u6210\u5bf9\u5e94\u7684\u6307\u9488</li> <li>\u5411\u5b9e\u53c2\u4e2d\u6dfb\u52a0/\u5220\u9664\u9876\u5c42const</li> <li>const\u8f6c\u6362\u5b9e\u73b0\u7684\u5339\u914d\uff08\u975e\u5e38\u91cf\u7684\u5730\u5740\u8f6c\u6362\u6210const\u7684\u5730\u5740\uff09</li> <li>\u7c7b\u578b\u63d0\u5347\uff08\u5c0f\u6574\u6570\u7c7b\u578b\u8f6c\u6362\u4e3a\u5927\u6574\u6570\u7c7b\u578b\uff09</li> <li>\u7b97\u6570\u7c7b\u578b\u8f6c\u6362\u6216\u6307\u9488\u8f6c\u6362\uff08\u5728\u8fd0\u7b97\u4e2d\u7c7b\u578b\u6539\u53d8\uff09</li> <li>\u5373\u4f7f\u5f88\u5c0f\u7684\u6574\u6570\u503c\u4e5f\u4f1a\u76f4\u63a5\u63d0\u5347\u6210int\u7c7b\u578b</li> </ul> C++<pre><code>void ff(int);\nvoid ff(short);\nff('a');    // char\u63d0\u5347\u6210int\uff0c\u8c03\u7528ff(int);\n</code></pre> <ul> <li>\u7c7b\u7c7b\u578b\u8f6c\u6362\u5b9e\u73b0\u7684\u5339\u914d</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_16","title":"\u4e8c\u4e49\u6027","text":"<ul> <li>\u6240\u6709\u7684\u7b97\u6570\u7c7b\u578b\u8f6c\u6362\u7ea7\u522b\u90fd\u76f8\u540c</li> </ul> C++<pre><code>void manip(long);\nvoid manip(float);\nmanip(3.14);\n// \u65e2\u53ef\u4ee5\u8f6c\u6362\u6210float\u4e5f\u80fd\u8f6c\u6362\u6210long\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#_17","title":"\u51fd\u6570\u6307\u9488","text":"C++<pre><code>bool (*pr)(const string&amp;, const string&amp;);\npr = lengthCompare;\npr = &amp;lengthCompare;\n\nbool b1 = pr(\"hello\", \"goodbye\");\nbool b2 = (*pr)(\"hello\", \"goodbye\");\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/6_%E5%87%BD%E6%95%B0/#autodecltype","title":"\u5c06auto\u548cdecltype\u7528\u4e8e\u51fd\u6570\u6307\u9488\u7c7b\u578b","text":"C++<pre><code>auto f1(int) -&gt; int(*)(int*, int);\nstring::size_type sumLength(const string&amp;, const string &amp;);\ndecltype(sumLength) *getFcn(const string &amp;);    // \u4f7f\u7528decltype\u4f5c\u7528\u67d0\u4e2a\u51fd\u6570\u65f6\uff0c\u8fd4\u56de\u51fd\u6570\u672c\u8eab\u7c7b\u578b\u800c\u975e\u6307\u9488\u7c7b\u578b\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/","title":"C++-\u7c7b","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_1","title":"\u7c7b","text":"<p> \u7ea6 841 \u4e2a\u5b57  66 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#this","title":"this\u6307\u9488","text":"<ul> <li>\u6210\u5458\u51fd\u6570\u901a\u8fc7this\u6307\u9488\u8bbf\u95ee\u8c03\u7528\u5b83\u7684\u90a3\u4e2a\u5bf9\u8c61</li> <li>this\u5f62\u53c2\u662f\u9690\u5f0f\u5b9a\u4e49\u7684\uff1bthis\u662f\u4e00\u4e2a\u5e38\u91cf\u6307\u9488</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#const","title":"const\u6210\u5458\u51fd\u6570","text":"<ul> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cthis\u7684\u7c7b\u578b\u662f\u6307\u5411\u7c7b\u7c7b\u578b\u975e\u5e38\u91cf\u7248\u672c\u7684\u5e38\u91cf\u6307\u9488</li> <li>\u9700\u8981\u5c06this\u58f0\u660e\u4e3a\u6307\u5411\u5e38\u91cf\u7684\u6307\u9488</li> </ul> C++<pre><code>std::string isbn() const {return this-&gt;bookNo;}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_2","title":"\u6784\u9020\u51fd\u6570","text":"<ul> <li>\u53ea\u6709\u7c7b\u6ca1\u6709\u58f0\u660e\u4efb\u4f55\u6784\u9020\u51fd\u6570\u65f6\uff0c\u7f16\u8bd1\u5668\u624d\u4f1a\u81ea\u52a8\u751f\u6210\u9ed8\u8ba4\u6784\u9020\u51fd\u6570</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#default","title":"=default\u542b\u4e49","text":"<ul> <li>\u4f5c\u7528\u5b8c\u5168\u7b49\u540c\u4e8e\u4e4b\u524d\u4f7f\u7528\u7684\u5408\u6210\u9ed8\u8ba4\u6784\u9020\u51fd\u6570</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#classstruct","title":"class\u548cstruct","text":"<ul> <li>\u5e0c\u671b\u5b9a\u4e49\u7684\u7c7b\u7684\u6240\u6709\u6210\u5458\u662fpublic\u65f6\uff0c\u4f7f\u7528struct</li> <li>\u5e0c\u671b\u6210\u5458\u662fprivate\u7684\uff0c\u4f7f\u7528class</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_3","title":"\u53cb\u5143","text":"<ul> <li>\u7c7b\u5141\u8bb8\u5176\u4ed6\u7c7b\u6216\u8005\u51fd\u6570\u8bbf\u95ee\u5b83\u7684\u975e\u516c\u6709\u6210\u5458</li> <li>\u53cb\u5143\u51fd\u6570\u53ea\u80fd\u51fa\u73b0\u5728\u7c7b\u5b9a\u4e49\u7684\u5185\u90e8</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_4","title":"\u7c7b\u7684\u5176\u5b83\u7279\u6027","text":"<ul> <li>\u6210\u5458\u51fd\u6570\u4f5c\u4e3a\u5185\u8054\u51fd\u6570</li> <li>\u91cd\u8f7d\u6210\u5458\u51fd\u6570</li> <li>\u53ef\u53d8\u6570\u636e\u6210\u5458\uff1a\u5373\u4f7f\u662fconst\u5bf9\u8c61\u6210\u5458\uff0c\u8be5\u503c\u4ecd\u53ef\u6539\u53d8</li> </ul> C++<pre><code>class Screen {\npublic:\n    void some_member() const;\nprivate:\n    mutable size_t access_ctr;\n};\nvoid Screen::some_member() const\n{\n    ++access_ctr;\n}\n</code></pre> <ul> <li> <p>\u4ececonst\u6210\u5458\u51fd\u6570\u8fd4\u56de*this\uff1a\u662f\u4e00\u4e2aconst\u5bf9\u8c61</p> </li> <li> <p>\u57fa\u4e8econst\u7684\u91cd\u8f7d</p> </li> </ul> C++<pre><code>class Screen {\npublic:\n    Screen &amp;display(std::ostream &amp;os)\n            {do_display(os); return *this;}\n    const Screen &amp;display(std::ostream &amp;os) const       \n            {do_display(os); return *this;} // \u5e38\u91cf\u5bf9\u8c61\u8c03\u7528\u7684\u51fd\u6570\nprivate:\n    void do_display(std::ostream &amp;os) const {os &lt;&lt; contents;}\n};\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_5","title":"\u53cb\u5143\u6df1\u5165","text":"<ul> <li>\u7c7b\u4e4b\u95f4\u7684\u53cb\u5143</li> <li>\u4ee4\u6210\u5458\u51fd\u6570\u4f5c\u4e3a\u53cb\u5143</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_6","title":"\u53cb\u5143\u58f0\u660e","text":"<ul> <li>\u5728\u7c7b\u5185\u90e8\u5b9a\u4e49\u8be5\u51fd\u6570\uff0c\u5fc5\u987b\u5728\u7c7b\u5916\u90e8\u63d0\u4f9b\u76f8\u5e94\u7684\u58f0\u660e\u4f7f\u5f97\u51fd\u6570\u53ef\u89c1</li> </ul> C++<pre><code>struct X {\n  friend void f() {}\n  X() {f();}    // error: f is not be declared\n  void g();\n  void h();\n};\n\nvoid X::g() {return f();}   // error: f is not be declared\nvoid f();\nvoid X::h() {return f();}   // right!\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_7","title":"\u540d\u5b57\u67e5\u627e\u548c\u7c7b\u7684\u4f5c\u7528\u57df","text":"<ul> <li>\u7f16\u8bd1\u5668\u5904\u7406\u5b8c\u7c7b\u4e2d\u7684\u5168\u90e8\u58f0\u660e\u624d\u5904\u7406\u6210\u5458\u51fd\u6570\u7684\u5b9a\u4e49\uff08\u5982\u679c\u5728\u7c7b\u4e2d\u4e3a\u67e5\u627e\u5230\u540d\u5b57\uff0c\u5230\u7c7b\u4f5c\u7528\u57df\u5916\u5c42\u7ee7\u7eed\u5bfb\u627e\uff09</li> <li>\u7c7b\u578b\u540d\u4e00\u822c\u5b9a\u4e49\u5728\u7c7b\u5f00\u59cb\u5904</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_8","title":"\u6784\u9020\u51fd\u6570\u518d\u63a2","text":"<ul> <li>\u4f7f\u7528\u6784\u9020\u51fd\u6570\u521d\u59cb\u503c\uff1a\u6548\u7387\u95ee\u9898\uff0c\u6709\u4e9b\u6570\u636e\u6210\u5458\u5fc5\u987b\u88ab\u521d\u59cb\u5316</li> <li>\u5c3d\u53ef\u80fd\u907f\u514d\u7528\u67d0\u4e9b\u6210\u5458\u521d\u59cb\u5316\u5176\u5b83\u6210\u5458</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_9","title":"\u9690\u5f0f\u7684\u7c7b\u7c7b\u578b\u8f6c\u6362","text":"<ul> <li>\u53ea\u5141\u8bb8\u4e00\u6b65\u8f6c\u6362\uff0c\u5c06\u5b57\u9762\u503c\u8f6c\u6362\u4e3astring\uff0c\u7c7b\u7684\u9ed8\u8ba4\u6784\u9020\u51fd\u6570\u5c06\u751f\u6210string\u7c7b\u578b\u7684\u7c7b</li> <li>\u6291\u5236\u6784\u9020\u51fd\u6570\u5b9a\u4e49\u7684\u9690\u5f0f\u8f6c\u6362\uff1aexplicit\u53ea\u7528\u4e8e\u76f4\u63a5\u521d\u59cb\u5316</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_10","title":"\u805a\u5408\u7c7b","text":"<ul> <li>\u6210\u5458\u5747\u4e3apublic</li> <li>\u6ca1\u6709\u4efb\u4f55\u6784\u9020\u51fd\u6570</li> <li>\u6ca1\u6709\u7c7b\u5185\u521d\u59cb\u503c</li> <li>\u6ca1\u6709\u57fa\u7c7b\u548c\u865a\u51fd\u6570</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_11","title":"\u5b57\u9762\u503c\u5e38\u91cf\u7c7b","text":"<ul> <li>\u6570\u636e\u6210\u5458\u5747\u662f\u5b57\u9762\u503c\u7684\u805a\u5408\u7c7b</li> <li>\u53e6\u4e00\u79cd</li> <li>\u6570\u636e\u6210\u5458\u662f\u5b57\u9762\u503c</li> <li>\u7c7b\u4e2d\u81f3\u5c11\u5305\u542b\u4e00\u4e2aconstexpr\u6784\u9020\u51fd\u6570</li> <li>\u7c7b\u5185\u521d\u59cb\u503c\u662f\u4e00\u4e2a\u5e38\u91cf\u8868\u8fbe\u5f0f</li> <li>\u5fc5\u987b\u4f7f\u7528\u6790\u6784\u51fd\u6570\u7684\u9ed8\u8ba4\u5b9a\u4e49\uff0c\u8be5\u6210\u5458\u8d1f\u8d23\u9500\u6bc1\u7c7b\u7684\u5bf9\u8c61</li> </ul> C++<pre><code>class Debeg {\npublic:\n    constexpr Debug(bool b = true): hw(b), io(b), other(b){}\n    constexpr bool any() {return hw || io || other;}\n    ...\nprivate:\n    bool hw;\n    bool io;\n    bool other;\n};\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#_12","title":"\u7c7b\u7684\u9759\u6001\u6210\u5458","text":"<ul> <li> <p>\u4e0d\u5305\u542bthis\u6307\u9488\uff0c\u4e5f\u4e0d\u80fd\u58f0\u660e\u6210const\uff0c\u4e5f\u4e0d\u80fd\u518d\u5185\u90e8\u4f7f\u7528this\u6307\u9488</p> </li> <li> <p>\u5fc5\u987b\u5728\u7c7b\u7684\u5916\u90e8\u5b9a\u4e49\u548c\u521d\u59cb\u5316\u6bcf\u4e2a\u9759\u6001\u6210\u5458</p> </li> <li> <p>\uff08\u9759\u6001\u5e38\u91cf\u6210\u5458\uff09\u7c7b\u7684\u5185\u90e8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u521d\u59cb\u503c\uff0c\u7c7b\u5916\u6210\u5458\u7684\u5b9a\u4e49\u4e0d\u80fd\u5728\u6307\u5b9a\u4e00\u4e2a\u521d\u59cb\u503c\u4e86</p> </li> <li> <p>\u9759\u6001\u6210\u5458\u53ef\u4ee5\u4f5c\u4e3a\u9ed8\u8ba4\u5b9e\u53c2\uff1b\u800c\u975e\u9759\u6001\u6570\u636e\u6210\u5458\u672c\u8eab\u662f\u5bf9\u8c61\u7684\u4e00\u90e8\u5206\uff0c\u4e0d\u80fd\u4f5c\u4e3a\u9ed8\u8ba4\u5b9e\u53c2</p> </li> <li> <p>\u53ef\u4ee5\u8bbf\u95ee\u7c7b\u7684\u79c1\u6709\u6210\u5458</p> </li> </ul> C++<pre><code>class Account {\npublic:\n    void calculate() {amount += amount*interestRate;}\nprivate:\n    static double interrestRate;\n    void initRate(double newRate);\n};\n\ndouble Account::interestRate = initRate();\n</code></pre> <ul> <li>\u5b9a\u4e49\u9759\u6001\u6210\u5458\u51fd\u6570\u53ef\u4ee5\u5728\u7c7b\u5185\u4e5f\u53ef\u4ee5\u5728\u7c7b\u5916\uff1bstatic\u5173\u952e\u5b57\u53ea\u51fa\u73b0\u5728\u7c7b\u5185</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/7_%E7%B1%BB/#inline","title":"inline\uff08\u5185\u8054\uff09\u51fd\u6570","text":"<ul> <li>\u5728\u7c7b\u5185\u5b9a\u4e49\u7684\u51fd\u6570\u81ea\u52a8\u6210\u4e3a\u5185\u8054\u51fd\u6570</li> </ul> C++<pre><code>// ctors\u653e\u5728private\n// \u5355\u4f8b\u6a21\u5f0f\nclass A {\npublic:\n    static A&amp; getInstance();\n    setup(){}\nprivate:\n    A();\n    A(const A&amp; rhs);\n};\n\nA&amp; A::getInstance()\n{\n    static A a;\n    return a;\n}\n</code></pre> <ul> <li>class with pointer members\u5fc5\u987b\u6709\u62f7\u8d1d\u6784\u9020\u51fd\u6570\u548c\u62f7\u8d1d\u8d4b\u503c\u8fd0\u7b97\u7b26</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/8_IO%E5%BA%93/","title":"C++-IO\u5e93","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/8_IO%E5%BA%93/#io","title":"IO\u5e93","text":"<p> \u7ea6 338 \u4e2a\u5b57  2 \u884c\u4ee3\u7801  6 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/8_IO%E5%BA%93/#io-class","title":"IO class","text":"<ul> <li>IO\u5bf9\u8c61\u65e0\u62f7\u8d1d\uff0c\u65e0\u8d4b\u503c\uff1a\u4e0d\u80fd\u4f5c\u4e3a\u53c2\u6570\u548c\u8fd4\u56de\u503c</li> <li>\u8bfb\u5199\u4e00\u4e2aIO\u5bf9\u8c61\u4f1a\u6539\u53d8\u5176\u72b6\u6001\uff0c\u4f20\u9012\u548c\u8fd4\u56de\u7684\u5f15\u7528\u4e0d\u80fd\u662fconst</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/8_IO%E5%BA%93/#_1","title":"\u6761\u4ef6\u72b6\u6001","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/8_IO%E5%BA%93/#_2","title":"\u7ba1\u7406\u8f93\u51fa\u7f13\u51b2","text":"<ul> <li> <p>\u7a0b\u5e8f\u5d29\u6e83\uff0c\u8f93\u51fa\u7f13\u51b2\u533a\u4e0d\u4f1a\u88ab\u5237\u65b0</p> </li> <li> <p>\u6bcf\u4e2a\u8f93\u51fa\u6d41\u90fd\u7ba1\u7406\u4e00\u4e2a\u7f13\u51b2\u533a</p> </li> <li> <p>\u7f13\u51b2\u5237\u65b0</p> </li> <li> <p>\u7a0b\u5e8f\u6b63\u5e38\u7ed3\u675f\uff0c\u4f5c\u4e3amain\u51fd\u6570\u7684return\u64cd\u4f5c\u4e00\u90e8\u5206\uff0c\u7f13\u51b2\u88ab\u6267\u884c</p> </li> <li>\u7f13\u51b2\u533a\u6ee1\u65f6\uff0c\u9700\u8981\u5237\u65b0\u7f13\u51b2</li> <li>endl\u7b49\u64cd\u7eb5\u7b26\uff0c\u663e\u793a\u5237\u65b0\u7f13\u51b2\u533a</li> <li>\u8bbe\u7f6eunitbuf\u6765\u6e05\u7a7a\u7f13\u51b2\u533a</li> <li> <p>\u4e00\u4e2a\u8f93\u51fa\u6d41\u53ef\u80fd\u88ab\u5173\u8054\u5230\u53e6\u4e00\u4e2a\u6d41\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8bfb\u5199\u88ab\u5173\u8054\u7684\u6d41\u65f6\uff0c\u5173\u8054\u5230\u7684\u6d41\u7684\u7f13\u51b2\u533a\u4f1a\u88ab\u5237\u65b0</p> </li> <li> <p>endl\uff1a\u8f93\u51fa\u6362\u884c\u7b26\uff0c\u5237\u65b0\u7f13\u51b2\u533a</p> </li> <li> <p>flush\uff1a\u5237\u65b0\u7f13\u51b2\u533a\uff0c\u4e0d\u9644\u52a0\u4efb\u4f55\u989d\u5916\u5b57\u7b26</p> </li> <li> <p>ends\uff1a\u8f93\u51fa\u4e00\u4e2a\u7a7a\u5b57\u7b26\uff0c\u5237\u65b0\u7f13\u51b2\u533a</p> </li> </ul> C++<pre><code>cout &lt;&lt; unitbuf;  // \u6240\u6709\u8f93\u51fa\u64cd\u4f5c\u7acb\u5373\u5237\u65b0\u7f13\u51b2\u533a\ncout &lt;&lt; nounitbuf;    // \u56de\u5230\u6b63\u5e38\u7684\u7f13\u51b2\u65b9\u5f0f\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/8_IO%E5%BA%93/#_3","title":"\u6587\u4ef6\u8f93\u5165\u8f93\u51fa","text":"<ul> <li>\u81ea\u52a8\u6784\u9020\u548c\u6790\u6784\uff1a\u51fa\u4f5c\u7528\u57df\uff0c\u7acb\u5373\u9500\u6bc1</li> <li>\u5f53\u4e00\u4e2afstream\u5bf9\u8c61\u88ab\u9500\u6bc1\u65f6\uff0cclose\u81ea\u52a8\u8c03\u7528</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/8_IO%E5%BA%93/#_4","title":"\u6587\u4ef6\u6a21\u5f0f","text":"<ul> <li>\u4ee5out\u6a21\u5f0f\u6253\u5f00\u6587\u4ef6\u4e22\u5f03\u5df2\u6709\u6570\u636e\uff1b\u907f\u514d\u6e05\u7a7a\u540c\u65f6\u6307\u5b9aapp</li> <li>\u6bcf\u6b21\u8c03\u7528open\u786e\u5b9a\u6587\u4ef6\u6a21\u5f0f\uff08\u663e\u793a\u6216\u9690\u5f0f\uff08out | trunc\uff09\uff09</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/8_IO%E5%BA%93/#string","title":"string\u6d41","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/","title":"C++-\u987a\u5e8f\u5bb9\u5668","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_1","title":"\u987a\u5e8f\u5bb9\u5668","text":"<p> \u7ea6 1049 \u4e2a\u5b57  27 \u884c\u4ee3\u7801  18 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_2","title":"\u6982\u8ff0","text":"<ul> <li>vector, deque\u5728\u5185\u5b58\u4e2d\u8fde\u7eed\u4fdd\u5b58\uff1blist\u4e0d\u652f\u6301\\&lt;\u8fd0\u7b97</li> <li>\u901a\u5e38\uff0c\u4f7f\u7528vector\u662f\u6700\u597d\u7684\u9009\u62e9</li> <li>\u968f\u673a\u8bbf\u95ee\u5143\u7d20\uff0c\u7528vector\u6216deque</li> <li>\u5bb9\u5668\u4e2d\u95f4\u63d2\u5165\u6216\u5220\u9664\uff0c\u7528list\u6216forward_list</li> <li>\u5934\u5c3e\u63d2\u5165\u6216\u5220\u9664\uff0c\u7528deque</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_3","title":"\u5bb9\u5668\u5e93","text":"<ul> <li>\u987a\u5e8f\u5bb9\u5668\u51e0\u4e4e\u53ef\u4ee5\u4fdd\u5b58\u4efb\u610f\u7c7b\u578b\u7684\u5143\u7d20\uff1b\u4e5f\u53ef\u4ee5\u4fdd\u5b58\u5bb9\u5668\u7684\u5bb9\u5668</li> </ul> C++<pre><code>// noDefault\u662f\u4e00\u4e2a\u6ca1\u6709\u9ed8\u8ba4\u6784\u9020\u51fd\u6570\u7684\u7c7b\u578b\nvector&lt;noDefault&gt; v1(20, init);   // \u63d0\u4f9b\u5143\u7d20\u521d\u59cb\u5316\u5668\nvector&lt;noDefault&gt; v2(10);     // \u5fc5\u987b\u63d0\u4f9b\u4e00\u4e2a\u5143\u7d20\u521d\u59cb\u5316\u5668\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_4","title":"\u5bb9\u5668\u64cd\u4f5c","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_5","title":"\u8fed\u4ee3\u5668","text":"<ul> <li>\u8fed\u4ee3\u5668\u8303\u56f4\u7531\u4e00\u5bf9\u8fed\u4ee3\u5668\u8868\u793a\uff0c\u4e24\u4e2a\u8fed\u4ee3\u5668\u5206\u522b\u6307\u5411\u540c\u4e00\u4e2a\u5bb9\u5668\u4e2d\u7684\u5143\u7d20\u6216\u8005\u662f\u5c3e\u5143\u7d20\u4e4b\u540e\u7684\u4f4d\u7f6e\uff1b\u5de6\u95ed\u5408\u533a\u95f4</li> </ul> Text Only<pre><code>[begin, end)\n</code></pre> <ul> <li>str.size()\u7684\u7c7b\u578b\u5c31\u662fsize_type</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#begin-end","title":"begin &amp; end","text":"<ul> <li> <p>begin, end\u6210\u5458\u90fd\u88ab\u91cd\u8f7d\u8fc7\uff1b\u4e00\u4e2a\u662fconst\u6210\u5458\uff0c\u8fd4\u56de\u5bb9\u5668\u7684const_iterator\u7c7b\u578b\uff0c\u53e6\u4e00\u4e2a\u662f\u975e\u5e38\u91cf\u6210\u5458\uff0c\u8fd4\u56de\u5bb9\u5668\u7684iterator\u7c7b\u578b</p> </li> <li> <p>\u4e0d\u9700\u8981\u5199\u8bbf\u95ee\u65f6\uff0c\u4f7f\u7528cbegin\u548ccend</p> </li> </ul> C++<pre><code>auto it7 = a.begin();   // if a is const, it7 is const_iterator\nauto it8 = a.cbegin();  // it8 is const_iterator\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_6","title":"\u5bb9\u5668\u5b9a\u4e49\u548c\u521d\u59cb\u5316","text":"<ul> <li> <p>\u5bb9\u5668\u521d\u59cb\u5316\u4e3a\u53e6\u4e00\u4e2a\u5bb9\u5668\u7684\u62f7\u8d1d\uff1a\u76f4\u63a5\u62f7\u8d1d\u6574\u4e2a\u5bb9\u5668\uff1b\u62f7\u8d1d\u7531\u4e00\u4e2a\u8fed\u4ee3\u5668\u5bf9\u6307\u5b9a\u7684\u5143\u7d20\u8303\u56f4\uff08\u7c7b\u578b\u76f8\u5bb9\u5373\u53ef\uff09</p> </li> <li> <p>\u62f7\u8d1d\u65f6\uff0c\u4e24\u4e2a\u5bb9\u5668\u7684\u5bb9\u5668\u7c7b\u578b\u548c\u5143\u7d20\u7c7b\u578b\u5fc5\u987b\u76f8\u540c\uff08const char*\u53ef\u4ee5\u8f6c\u6362\u6210string\uff09</p> </li> <li> <p>\u53ea\u6709\u987a\u5e8f\u5bb9\u5668\u7684\u6784\u9020\u51fd\u6570\u63a5\u6536\u5927\u5c0f\u53c2\u6570\uff0c\u5173\u8054\u5bb9\u5668\u4e0d\u652f\u6301</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#array","title":"array\u5177\u6709\u56fa\u5b9a\u5927\u5c0f","text":"C++<pre><code>array&lt;int, 42&gt;\narray&lt;string, 10&gt;\n</code></pre> <ul> <li>\u5185\u7f6e\u6570\u7ec4\u4e0d\u5141\u8bb8\u8fdb\u884c\u62f7\u8d1d\u6216\u5bf9\u8c61\u8d4b\u503c\u64cd\u4f5c\uff0c\u4f46\u662farray\u53ef\u4ee5</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#swap","title":"\u8d4b\u503c\u548cswap","text":"<ul> <li>array\u53f3\u8fb9\u8fd0\u7b97\u5bf9\u8c61\u7684\u5927\u5c0f\u53ef\u80fd\u548c\u5de6\u8fb9\u5927\u5c0f\u4e0d\u540c\uff0carray\u4e0d\u652f\u6301assign\uff0c\u4e5f\u4e0d\u5141\u8bb8\u7528\u82b1\u62ec\u53f7\u5305\u56f4\u7684\u503c\u5217\u8868\u8fdb\u884c\u8d4b\u503c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#assign","title":"assign","text":"<ul> <li>\u8d4b\u503c\u8981\u6c42\u8fd0\u7b97\u5bf9\u8c61\u6709\u76f8\u540c\u7684\u7c7b\u578b\uff1bassign\u5141\u8bb8\u4ece\u4e00\u4e2a\u4e0d\u540c\u4f46\u76f8\u5bb9\u7684\u7c7b\u578b\u8d4b\u503c</li> <li>\u65e7\u5143\u7d20\u88ab\u66ff\u6362\uff0c\u4f20\u9012\u7ed9assign\u7684\u8fed\u4ee3\u5668\u4e0d\u80fd\u6307\u5411\u8c03\u7528assign\u7684\u5bb9\u5668</li> </ul> C++<pre><code>list&lt;string&gt; names;\nvector&lt;const char*&gt; oldstyle;\nnames = oldstyle;   // \u9519\u8bef\uff0c\u5bb9\u5668\u7c7b\u578b\u4e0d\u5339\u914d\nnames.assign(oldsyle.cbegin(), oldstyle.cend());\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#swap_1","title":"swap","text":"<ul> <li>swap\u64cd\u4f5c\u4ea4\u6362\u4e24\u4e2a\u76f8\u540c\u7c7b\u578b\u5bb9\u5668\u7684\u5185\u5bb9\uff1b\u4e24\u4e2a\u5bb9\u5668\u7684\u5143\u7d20\u4f1a\u4ea4\u6362</li> <li>\u9664array\u5916\uff0c\u5143\u7d20\u672c\u8eab\u672a\u4ea4\u6362\uff0c\u53ea\u662f\u4ea4\u6362\u4e86\u4e24\u4e2a\u5bb9\u5668\u7684\u5185\u90e8\u6570\u636e\u7ed3\u6784</li> <li>\u9664string\u5916\uff0citerator, reference, pointer\u5747\u4e0d\u4f1a\u5931\u6548</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_7","title":"\u5bb9\u5668\u5927\u5c0f\u64cd\u4f5c","text":"<ul> <li>\u5173\u7cfb\u8fd0\u7b97\u7b26\u4e24\u8fb9\u7684\u8fd0\u7b97\u5bf9\u8c61\u5fc5\u987b\u662f\u76f8\u540c\u7c7b\u578b\u7684\u5bb9\u5668\uff0c\u4e14\u5fc5\u987b\u4fdd\u5b58\u76f8\u540c\u7c7b\u578b\u7684\u5143\u7d20</li> <li>\u6bd4\u8f83\u4e24\u4e2a\u5bb9\u5668\u5b9e\u9645\u4e0a\u662f\u8fdb\u884c\u5143\u7d20\u7684\u9010\u5bf9\u6bd4\u8f83</li> <li>\u76f8\u540c\u5927\u5c0f\u4e14\u5143\u7d20\u76f8\u7b49\uff0c\u5219\u76f8\u7b49</li> <li>\u4e24\u4e2a\u5bb9\u5668\u5927\u5c0f\u4e0d\u540c\uff0c\u4f46\u8f83\u5c0f\u5bb9\u5668\u7684\u6bcf\u4e2a\u5143\u7d20\u90fd\u7b49\u4e8e\u8f83\u5927\u5bb9\u5668\u7684\u5143\u7d20\uff0c\u8f83\u5c0f\u5bb9\u5668\u5c0f\u4e8e\u8f83\u5927\u5bb9\u5668</li> <li>\u4e24\u4e2a\u5bb9\u5668\u90fd\u4e0d\u662f\u53e6\u4e00\u4e2a\u5bb9\u5668\u7684\u524d\u7f00\u5b50\u5e8f\u5217\uff0c\u6bd4\u8f83\u7ed3\u679c\u53d6\u51b3\u4e8e\u7b2c\u4e00\u4e2a\u4e0d\u76f8\u7b49\u5143\u7d20\u7684\u6bd4\u8f83\u7ed3\u679c</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_8","title":"\u987a\u5e8f\u5bb9\u5668\u64cd\u4f5c","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_9","title":"\u6dfb\u52a0\u5143\u7d20","text":"<ul> <li>\u5bb9\u5668\u5143\u7d20\u662f\u62f7\u8d1d\uff1b\u7528\u4e00\u4e2a\u5bf9\u8c61\u521d\u59cb\u5316\u5bb9\u5668\u6216\u63d2\u5165\u5bb9\u5668\u65f6\uff0c\u5b9e\u9645\u4e0a\u653e\u5165\u5230\u5bb9\u5668\u4e2d\u7684\u662f\u5bf9\u8c61\u503c\u7684\u4e00\u4e2a\u62f7\u8d1d</li> </ul> C++<pre><code>vector&lt;string&gt; svec;\nlist&lt;string&gt; slist;\n\n// euqal to slist.push_front(\"Hello!\")\nslist.insert(slist.begin(), \"Hello!\");\n\n// \u63d2\u5165\u5230vector\u672b\u5c3e\u4e4b\u5916\u7684\u4efb\u4f55\u4f4d\u7f6e\u90fd\u53ef\u80fd\u5f88\u6162\nsvec.insert(svec.begin(), \"Hello!\");\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#emplace","title":"emplace","text":"<ul> <li>\u4e0d\u62f7\u8d1d\u5143\u7d20\u800c\u662f\u76f4\u63a5\u5c06\u5143\u7d20\u653e\u7f6e\u5728\u5bb9\u5668\u5934\u90e8\uff0c\u4efb\u610f\u4f4d\u7f6e\uff0c\u5c3e\u90e8</li> <li>\u5c06\u5143\u7d20\u4f20\u9012\u7ed9\u5143\u7d20\u7c7b\u578b\u7684\u6784\u9020\u51fd\u6570\uff1b\u5728\u5bb9\u5668\u7ba1\u7406\u7684\u5185\u5b58\u7a7a\u95f4\u4e2d\u76f4\u63a5\u6784\u9020\u51fd\u6570</li> </ul> C++<pre><code>c.emplace_back();   // default constructor\nc.emplace(iter, \"999\"); // Sales_data(string)\nc.emplace_front(\"999\", 25, 15.99);\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_10","title":"\u8bbf\u95ee\u5143\u7d20","text":"<ul> <li>\u8bbf\u95ee\u5143\u7d20\u8fd4\u56de\u7684\u662f\u5f15\u7528</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_11","title":"\u5220\u9664\u5143\u7d20","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#forward_list","title":"\u7279\u6b8a\u7684forward_list\u64cd\u4f5c","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_12","title":"\u6539\u53d8\u5bb9\u5668\u5927\u5c0f","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_13","title":"\u5bb9\u5668\u64cd\u4f5c\u53ef\u80fd\u4f7f\u8fed\u4ee3\u5668\u5931\u6548","text":"<ul> <li>\u4fdd\u8bc1\u6bcf\u6b21\u6539\u53d8\u5bb9\u5668\u7684\u64cd\u4f5c\u4e4b\u540e\u90fd\u6b63\u786e\u5730\u91cd\u65b0\u5b9a\u4f4d\u8fed\u4ee3\u5668</li> </ul> C++<pre><code>while(begin != v.end()) {   // after adding or deleting, recompute end of vector\n    ++begin;\n    begin = v.insert(begin, 42);\n    ++begin;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#vector","title":"vector\u5bf9\u8c61\u589e\u957f","text":"<ul> <li>\u5bb9\u5668\u4e2d\u5143\u7d20\u8fde\u7eed\u5b58\u50a8\uff0c\u4e14\u5bb9\u5668\u5927\u5c0f\u53ef\u53d8</li> <li>\u5f53\u4e0d\u5f97\u4e0d\u83b7\u53d6\u65b0\u7684\u5185\u5b58\u7a7a\u95f4\u65f6\uff0cvector\u548cstring\u7684\u5b9e\u73b0\u901a\u5e38\u4f1a\u5206\u914d\u6bd4\u65b0\u7684\u7a7a\u95f4\u9700\u6c42\u66f4\u5927\u7684\u5185\u5b58\u7a7a\u95f4</li> </ul> <ul> <li>reverse\u4ec5\u4ec5\u5f71\u54cdvector\u9884\u5148\u5206\u914d\u591a\u5927\u7684\u5185\u5b58\u7a7a\u95f4</li> <li>size\u662f\u5bb9\u5668\u4e2d\u5b9e\u9645\u5143\u7d20\u4e2a\u6570\uff1bcapacity\u662f\u5bb9\u5668\u6700\u591a\u5bb9\u7eb3\u4e2a\u6570</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#string","title":"\u989d\u5916\u7684string\u64cd\u4f5c","text":"<ul> <li>substr(pos, n)\uff1a\u8fd4\u56de\u4e00\u4e2astring\uff0c\u5305\u542bs\u4e2d\u4ecepos\u5f00\u59cb\u7684n\u4e2a\u5b57\u7b26\u62f7\u8d1d</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#string_1","title":"\u4fee\u6539string","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#string_2","title":"string\u641c\u7d22\u64cd\u4f5c","text":"<ul> <li>find\u51fd\u6570\u5b8c\u6210\u6700\u7b80\u5355\u7684\u641c\u7d22\uff1b\u82e5\u627e\u5230\uff0c\u8fd4\u56de\u7b2c\u4e00\u4e2a\u5339\u914d\u4f4d\u7f6e\u7684\u4e0b\u6807\uff0c\u5426\u5219\u8fd4\u56denpos</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#compare","title":"compare","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_14","title":"\u6570\u503c\u8f6c\u6362","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/9_%E9%A1%BA%E5%BA%8F%E5%AE%B9%E5%99%A8/#_15","title":"\u5bb9\u5668\u9002\u914d\u5668","text":"<ul> <li>stack, queue, priority_queue</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/","title":"C++-Makefile\u8bed\u6cd5\u5b66\u4e60","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#makefile","title":"Makefile","text":"<p> \u7ea6 539 \u4e2a\u5b57  183 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_1","title":"\u4f7f\u7528\u6761\u4ef6\u5224\u65ad","text":"Makefile<pre><code>libs_for_gcc = -lgnu\nnormal_libs =\nfoo: $(objects)\nifeq ($(CC),gcc)\n    $(CC) -o foo $(objects) $(libs_for_gcc)\nelse\n    $(CC) -o foo $(objects) $(normal_libs)\nendif\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_2","title":"\u4f7f\u7528\u51fd\u6570","text":"","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_3","title":"\u5b57\u7b26\u4e32\u5904\u7406\u51fd\u6570","text":"Makefile<pre><code>$(subst &lt;from&gt;,&lt;to&gt;,&lt;text&gt;)\n\u2022 \u540d\u79f0\uff1a\u5b57\u7b26\u4e32\u66ff\u6362\u51fd\u6570\n\u2022 \u529f\u80fd\uff1a\u628a\u5b57\u4e32 &lt;text&gt; \u4e2d\u7684 &lt;from&gt; \u5b57\u7b26\u4e32\u66ff\u6362\u6210 &lt;to&gt; \u3002\n\u2022 \u8fd4\u56de\uff1a\u51fd\u6570\u8fd4\u56de\u88ab\u66ff\u6362\u8fc7\u540e\u7684\u5b57\u7b26\u4e32\u3002\n\n$(patsubst &lt;pattern&gt;,&lt;replacement&gt;,&lt;text&gt;)\n\u2022 \u540d\u79f0\uff1a\u6a21\u5f0f\u5b57\u7b26\u4e32\u66ff\u6362\u51fd\u6570\u3002\n\u2022 \u529f\u80fd\uff1a\u67e5\u627e &lt;text&gt; \u4e2d\u7684\u5355\u8bcd\uff08\u5355\u8bcd\u4ee5\u201c\u7a7a\u683c\u201d\u3001\u201cTab\u201d\u6216\u201c\u56de\u8f66\u201d\u201c\u6362\u884c\u201d\u5206\u9694\uff09\u662f\u5426\u7b26\u5408\u6a21\u5f0f\n&lt;pattern&gt; \uff0c\u5982\u679c\u5339\u914d\u7684\u8bdd\uff0c\u5219\u4ee5 &lt;replacement&gt; \u66ff\u6362\u3002\u8fd9\u91cc\uff0c&lt;pattern&gt; \u53ef\u4ee5\u5305\u62ec\u901a\u914d\u7b26 % \uff0c\n\u8868\u793a\u4efb\u610f\u957f\u5ea6\u7684\u5b57\u4e32\u3002\u5982\u679c &lt;replacement&gt; \u4e2d\u4e5f\u5305\u542b % \uff0c\u90a3\u4e48\uff0c&lt;replacement&gt; \u4e2d\u7684\u8fd9\u4e2a % \u5c06\u662f\n&lt;pattern&gt; \u4e2d\u7684\u90a3\u4e2a % \u6240\u4ee3\u8868\u7684\u5b57\u4e32\u3002\uff08\u53ef\u4ee5\u7528 \\ \u6765\u8f6c\u4e49\uff0c\u4ee5 \\% \u6765\u8868\u793a\u771f\u5b9e\u542b\u4e49\u7684 % \u5b57\u7b26\uff09\n\u2022 \u8fd4\u56de\uff1a\u51fd\u6570\u8fd4\u56de\u88ab\u66ff\u6362\u8fc7\u540e\u7684\u5b57\u7b26\u4e32\u3002\n$(objects:.o=.c) \u548c $(patsubst %.o,%.c,$(objects)) \u662f\u4e00\u6837\u7684\n\n$(strip &lt;string&gt;)\n\u2022 \u540d\u79f0\uff1a\u53bb\u7a7a\u683c\u51fd\u6570\u3002\n\u2022 \u529f\u80fd\uff1a\u53bb\u6389 &lt;string&gt; \u5b57\u4e32\u4e2d\u5f00\u5934\u548c\u7ed3\u5c3e\u7684\u7a7a\u5b57\u7b26\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u88ab\u53bb\u6389\u7a7a\u683c\u7684\u5b57\u7b26\u4e32\u503c\u3002\n\n$(findstring &lt;find&gt;,&lt;in&gt;)\n\u2022 \u540d\u79f0\uff1a\u67e5\u627e\u5b57\u7b26\u4e32\u51fd\u6570\n\u2022 \u529f\u80fd\uff1a\u5728\u5b57\u4e32 &lt;in&gt; \u4e2d\u67e5\u627e &lt;find&gt; \u5b57\u4e32\u3002\n\u2022 \u8fd4\u56de\uff1a\u5982\u679c\u627e\u5230\uff0c\u90a3\u4e48\u8fd4\u56de &lt;find&gt; \uff0c\u5426\u5219\u8fd4\u56de\u7a7a\u5b57\u7b26\u4e32\u3002\n\n$(filter &lt;pattern...&gt;,&lt;text&gt;)\n\u2022 \u540d\u79f0\uff1a\u8fc7\u6ee4\u51fd\u6570\n\u2022 \u529f\u80fd\uff1a\u4ee5 &lt;pattern&gt; \u6a21\u5f0f\u8fc7\u6ee4 &lt;text&gt; \u5b57\u7b26\u4e32\u4e2d\u7684\u5355\u8bcd\uff0c\u4fdd\u7559\u7b26\u5408\u6a21\u5f0f &lt;pattern&gt; \u7684\u5355\u8bcd\u3002\u53ef\u4ee5\n\u6709\u591a\u4e2a\u6a21\u5f0f\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u7b26\u5408\u6a21\u5f0f &lt;pattern&gt; \u7684\u5b57\u4e32\u3002\n\n$(filter-out &lt;pattern...&gt;,&lt;text&gt;)\n\u2022 \u540d\u79f0\uff1a\u53cd\u8fc7\u6ee4\u51fd\u6570\n\u2022 \u529f\u80fd\uff1a\u4ee5 &lt;pattern&gt; \u6a21\u5f0f\u8fc7\u6ee4 &lt;text&gt; \u5b57\u7b26\u4e32\u4e2d\u7684\u5355\u8bcd\uff0c\u53bb\u9664\u7b26\u5408\u6a21\u5f0f &lt;pattern&gt; \u7684\u5355\u8bcd\u3002\u53ef\u4ee5\n\u6709\u591a\u4e2a\u6a21\u5f0f\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u4e0d\u7b26\u5408\u6a21\u5f0f &lt;pattern&gt; \u7684\u5b57\u4e32\u3002\n\n$(sort &lt;list&gt;)\n\u2022 \u540d\u79f0\uff1a\u6392\u5e8f\u51fd\u6570\n\u2022 \u529f\u80fd\uff1a\u7ed9\u5b57\u7b26\u4e32 &lt;list&gt; \u4e2d\u7684\u5355\u8bcd\u6392\u5e8f\uff08\u5347\u5e8f\uff09\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u6392\u5e8f\u540e\u7684\u5b57\u7b26\u4e32\u3002\n\u2022 \u793a\u4f8b\uff1a$(sort foo bar lose) \u8fd4\u56de bar foo lose \u3002\n\u2022 \u5907\u6ce8\uff1asort \u51fd\u6570\u4f1a\u53bb\u6389 &lt;list&gt; \u4e2d\u76f8\u540c\u7684\u5355\u8bcd\u3002\n\n$(word &lt;n&gt;,&lt;text&gt;)\n\u2022 \u540d\u79f0\uff1a\u53d6\u5355\u8bcd\u51fd\u6570\n\u2022 \u529f\u80fd\uff1a\u53d6\u5b57\u7b26\u4e32 &lt;text&gt; \u4e2d\u7b2c &lt;n&gt; \u4e2a\u5355\u8bcd\u3002\uff08\u4ece\u4e00\u5f00\u59cb\uff09\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u5b57\u7b26\u4e32 &lt;text&gt; \u4e2d\u7b2c &lt;n&gt; \u4e2a\u5355\u8bcd\u3002\u5982\u679c &lt;n&gt; \u6bd4 &lt;text&gt; \u4e2d\u7684\u5355\u8bcd\u6570\u8981\u5927\uff0c\u90a3\u4e48\u8fd4\u56de\u7a7a\u5b57\n\u7b26\u4e32\u3002\n\n$(wordlist &lt;ss&gt;,&lt;e&gt;,&lt;text&gt;)\n\u2022 \u540d\u79f0\uff1a\u53d6\u5355\u8bcd\u4e32\u51fd\u6570\n\u2022 \u529f\u80fd\uff1a\u4ece\u5b57\u7b26\u4e32 &lt;text&gt; \u4e2d\u53d6\u4ece &lt;ss&gt; \u5f00\u59cb\u5230 &lt;e&gt; \u7684\u5355\u8bcd\u4e32\u3002&lt;ss&gt; \u548c &lt;e&gt; \u662f\u4e00\u4e2a\u6570\u5b57\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u5b57\u7b26\u4e32 &lt;text&gt; \u4e2d\u4ece &lt;ss&gt; \u5230 &lt;e&gt; \u7684\u5355\u8bcd\u5b57\u4e32\u3002\u5982\u679c &lt;ss&gt; \u6bd4 &lt;text&gt; \u4e2d\u7684\u5355\u8bcd\u6570\u8981\u5927\uff0c\n\u90a3\u4e48\u8fd4\u56de\u7a7a\u5b57\u7b26\u4e32\u3002\u5982\u679c &lt;e&gt; \u5927\u4e8e &lt;text&gt; \u7684\u5355\u8bcd\u6570\uff0c\u90a3\u4e48\u8fd4\u56de\u4ece &lt;ss&gt; \u5f00\u59cb\uff0c\u5230 &lt;text&gt; \u7ed3\u675f\u7684\n\u5355\u8bcd\u4e32\u3002\n\n$(words &lt;text&gt;)\n\u2022 \u540d\u79f0\uff1a\u5355\u8bcd\u4e2a\u6570\u7edf\u8ba1\u51fd\u6570\n\u2022 \u529f\u80fd\uff1a\u7edf\u8ba1 &lt;text&gt; \u4e2d\u5b57\u7b26\u4e32\u4e2d\u7684\u5355\u8bcd\u4e2a\u6570\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de &lt;text&gt; \u4e2d\u7684\u5355\u8bcd\u6570\u3002\n\n$(firstword &lt;text&gt;)\n\u2022 \u540d\u79f0\uff1a\u9996\u5355\u8bcd\u51fd\u6570\u2014\u2014firstword\u3002\n\u2022 \u529f\u80fd\uff1a\u53d6\u5b57\u7b26\u4e32 &lt;text&gt; \u4e2d\u7684\u7b2c\u4e00\u4e2a\u5355\u8bcd\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u5b57\u7b26\u4e32 &lt;text&gt; \u7684\u7b2c\u4e00\u4e2a\u5355\u8bcd\u3002\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_4","title":"\u6587\u4ef6\u540d\u64cd\u4f5c\u51fd\u6570","text":"Makefile<pre><code>$(dir &lt;names...&gt;)\n\u2022 \u540d\u79f0\uff1a\u53d6\u76ee\u5f55\u51fd\u6570\u2014\u2014dir\u3002\n\u2022 \u529f\u80fd\uff1a\u4ece\u6587\u4ef6\u540d\u5e8f\u5217 &lt;names&gt; \u4e2d\u53d6\u51fa\u76ee\u5f55\u90e8\u5206\u3002\u76ee\u5f55\u90e8\u5206\u662f\u6307\u6700\u540e\u4e00\u4e2a\u53cd\u659c\u6760\uff08/ \uff09\u4e4b\u524d\u7684\u90e8\u5206\u3002\n\u5982\u679c\u6ca1\u6709\u53cd\u659c\u6760\uff0c\u90a3\u4e48\u8fd4\u56de ./ \u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u6587\u4ef6\u540d\u5e8f\u5217 &lt;names&gt; \u7684\u76ee\u5f55\u90e8\u5206\u3002\n\n$(notdir &lt;names...&gt;)\n\u2022 \u540d\u79f0\uff1a\u53d6\u6587\u4ef6\u51fd\u6570\u2014\u2014notdir\u3002\n\u2022 \u529f\u80fd\uff1a\u4ece\u6587\u4ef6\u540d\u5e8f\u5217 &lt;names&gt; \u4e2d\u53d6\u51fa\u975e\u76ee\u5f55\u90e8\u5206\u3002\u975e\u76ee\u5f55\u90e8\u5206\u662f\u6307\u6700\u5f8c\u4e00\u4e2a\u53cd\u659c\u6760\uff08/ \uff09\u4e4b\u540e\u7684\u90e8\n\u5206\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u6587\u4ef6\u540d\u5e8f\u5217 &lt;names&gt; \u7684\u975e\u76ee\u5f55\u90e8\u5206\u3002\n\n$(basename &lt;names...&gt;)\n\u2022 \u540d\u79f0\uff1a\u53d6\u524d\u7f00\u51fd\u6570\u2014\u2014basename\u3002\n\u2022 \u529f\u80fd\uff1a\u4ece\u6587\u4ef6\u540d\u5e8f\u5217 &lt;names&gt; \u4e2d\u53d6\u51fa\u5404\u4e2a\u6587\u4ef6\u540d\u7684\u524d\u7f00\u90e8\u5206\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u6587\u4ef6\u540d\u5e8f\u5217 &lt;names&gt; \u7684\u524d\u7f00\u5e8f\u5217\uff0c\u5982\u679c\u6587\u4ef6\u6ca1\u6709\u524d\u7f00\uff0c\u5219\u8fd4\u56de\u7a7a\u5b57\u4e32\u3002\n\n$(addsuffix &lt;suffix&gt;,&lt;names...&gt;)\n\u2022 \u540d\u79f0\uff1a\u52a0\u540e\u7f00\u51fd\u6570\u2014\u2014addsuffix\u3002\n\u2022 \u529f\u80fd\uff1a\u628a\u540e\u7f00 &lt;suffix&gt; \u52a0\u5230 &lt;names&gt; \u4e2d\u7684\u6bcf\u4e2a\u5355\u8bcd\u540e\u9762\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u52a0\u8fc7\u540e\u7f00\u7684\u6587\u4ef6\u540d\u5e8f\u5217\u3002\n\n$(addprefix &lt;prefix&gt;,&lt;names...&gt;)\n\u2022 \u540d\u79f0\uff1a\u52a0\u524d\u7f00\u51fd\u6570\u2014\u2014addprefix\u3002\n\u2022 \u529f\u80fd\uff1a\u628a\u524d\u7f00 &lt;prefix&gt; \u52a0\u5230 &lt;names&gt; \u4e2d\u7684\u6bcf\u4e2a\u5355\u8bcd\u540e\u9762\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u52a0\u8fc7\u524d\u7f00\u7684\u6587\u4ef6\u540d\u5e8f\u5217\u3002\n\n$(join &lt;list1&gt;,&lt;list2&gt;)\n\u2022 \u540d\u79f0\uff1a\u8fde\u63a5\u51fd\u6570\u2014\u2014join\u3002\n\u2022 \u529f\u80fd\uff1a\u628a &lt;list2&gt; \u4e2d\u7684\u5355\u8bcd\u5bf9\u5e94\u5730\u52a0\u5230 &lt;list1&gt; \u7684\u5355\u8bcd\u540e\u9762\u3002\u5982\u679c &lt;list1&gt; \u7684\u5355\u8bcd\u4e2a\u6570\u8981\u6bd4\n&lt;list2&gt; \u7684\u591a\uff0c\u90a3\u4e48\uff0c&lt;list1&gt; \u4e2d\u7684\u591a\u51fa\u6765\u7684\u5355\u8bcd\u5c06\u4fdd\u6301\u539f\u6837\u3002\u5982\u679c &lt;list2&gt; \u7684\u5355\u8bcd\u4e2a\u6570\u8981\u6bd4\n&lt;list1&gt; \u591a\uff0c\u90a3\u4e48\uff0c&lt;list2&gt; \u591a\u51fa\u6765\u7684\u5355\u8bcd\u5c06\u88ab\u590d\u5236\u5230 &lt;list1&gt; \u4e2d\u3002\n\u2022 \u8fd4\u56de\uff1a\u8fd4\u56de\u8fde\u63a5\u8fc7\u540e\u7684\u5b57\u7b26\u4e32\u3002\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#vpath","title":"vpath","text":"<ul> <li>vpath %.h include //\u6307\u5b9a.h\u7c7b\u578b\u6587\u4ef6\u7684\u641c\u7d22\u8def\u5f84\u662finclude</li> </ul> <p>vpath %.cpp src //\u6307\u5b9a.cpp\u7c7b\u578b\u6587\u4ef6\u7684\u641c\u7d22\u8def\u5f84\u662fsrc</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#foreach","title":"foreach\u51fd\u6570","text":"Makefile<pre><code>names := a b c d\nfiles := $(foreach n,$(names),$(n).o)\n$(files) \u7684\u503c\u662f a.o b.o c.o d.o\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#call","title":"call\u51fd\u6570","text":"Makefile<pre><code>reverse = $(1) $(2)\nfoo = $(call reverse,a,b)\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#origin","title":"origin\u51fd\u6570","text":"<ul> <li>origin \u51fd\u6570\u4e0d\u50cf\u5176\u5b83\u7684\u51fd\u6570\uff0c\u4ed6\u5e76\u4e0d\u64cd\u4f5c\u53d8\u91cf\u7684\u503c\uff0c\u4ed6\u53ea\u662f\u544a\u8bc9\u4f60\u4f60\u7684\u8fd9\u4e2a\u53d8\u91cf\u662f\u54ea\u91cc\u6765\u7684\uff1f\u5176\u8bed\u6cd5\u662f\uff1a<code>$(origin &lt;variable&gt;)</code></li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#shell","title":"shell\u51fd\u6570","text":"Makefile<pre><code>contents := $(shell cat foo)\nfiles := $(shell echo *.c)\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#make","title":"\u63a7\u5236make\u7684\u51fd\u6570","text":"Makefile<pre><code>$(error &lt;text...&gt;)\n\n$(warning &lt;text...&gt;)\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_5","title":"\u4f2a\u76ee\u6807","text":"Makefile<pre><code>.PHONY: all\nall: prog1 prog2 prog3\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_6","title":"\u9690\u542b\u89c4\u5219","text":"<ul> <li>\u9690\u542b\u89c4\u5219\u5c31\u4f1a\u751f\u6548\u3002\u9ed8\u8ba4\u7684\u540e\u7f00\u5217\u8868\u662f\uff1a.out,.a, .ln, .o, .c, .cc, .C, .p, .f, .F, .r, .y, .l, .s, .S, .mod, .sym, .def, .h, .info, .dvi, .tex, .texinfo, .texi, .txinfo, .w, .ch .web, .sh, .elc, .el</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_7","title":"\u5e38\u7528\u9690\u542b\u89c4\u5219","text":"<ul> <li>\u7f16\u8bd1C\u7a0b\u5e8f\u7684\u9690\u542b\u89c4\u5219\u3002   \u201c.o\u201d\u7684\u76ee\u6807\u7684\u4f9d\u8d56\u76ee\u6807\u4f1a\u81ea\u52a8\u63a8\u5bfc\u4e3a\u201c.c\u201d\uff0c\u5e76\u4e14\u5176\u751f\u6210\u547d\u4ee4\u662f<code>\u201c$(CC) \u2013c $(CPPFLAGS) $(CFLAGS)\u201d</code></li> <li>\u7f16\u8bd1C++\u7a0b\u5e8f\u7684\u9690\u542b\u89c4\u5219\u3002   \u201c.o\u201d \u7684\u76ee\u6807\u7684\u4f9d\u8d56\u76ee\u6807\u4f1a\u81ea\u52a8\u63a8\u5bfc\u4e3a\u201c.cc\u201d\u6216\u662f\u201c.C\u201d\uff0c\u5e76\u4e14\u5176\u751f\u6210\u547d\u4ee4\u662f<code>\u201c$(CXX) \u2013c $(CPPFLAGS) $(CFLAGS)\u201d</code>\u3002\uff08\u5efa\u8bae\u4f7f\u7528\u201c.cc\u201d\u4f5c\u4e3aC++\u6e90\u6587\u4ef6\u7684\u540e\u7f00\uff0c\u800c\u4e0d\u662f\u201c.C\u201d\uff09</li> <li>\u6c47\u7f16\u548c\u6c47\u7f16\u9884\u5904\u7406\u7684\u9690\u542b\u89c4\u5219\u3002   \u201c.o\u201d \u7684\u76ee\u6807\u7684\u4f9d\u8d56\u76ee\u6807\u4f1a\u81ea\u52a8\u63a8\u5bfc\u4e3a\u201c.s\u201d\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7f16\u8bd1\u54c1\u201cas\u201d\uff0c\u5e76\u4e14\u5176\u751f\u6210\u547d\u4ee4\u662f\uff1a<code>\u201c$(AS) $(ASFLAGS)\u201d</code>\u3002\u201c.s\u201d \u7684\u76ee\u6807\u7684\u4f9d\u8d56\u76ee\u6807\u4f1a\u81ea\u52a8\u63a8\u5bfc\u4e3a\u201c.S\u201d\uff0c\u9ed8\u8ba4\u4f7f\u7528C\u9884\u7f16\u8bd1\u5668\u201ccpp\u201d\uff0c\u5e76\u4e14\u5176\u751f\u6210\u547d\u4ee4\u662f\uff1a<code>\u201c$(AS) $(ASFLAGS)\u201d</code>\u3002</li> <li>\u201c\u201d \u76ee\u6807\u4f9d\u8d56\u4e8e\u201c.o\u201d\uff0c\u901a\u8fc7\u8fd0\u884cC\u7684\u7f16\u8bd1\u5668\u6765\u8fd0\u884c\u94fe\u63a5\u7a0b\u5e8f\u751f\u6210\uff08\u4e00\u822c\u662f\u201cld\u201d\uff09\uff0c\u5176\u751f\u6210\u547d\u4ee4\u662f\uff1a<code>\u201c$(CC) $(LDFLAGS) &lt;n&gt;.o $(LOADLIBES) $(LDLIBS)\u201d</code>\u3002</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_8","title":"\u81ea\u52a8\u5316\u53d8\u91cf","text":"Makefile<pre><code>\u2022 $@ : \u8868\u793a\u89c4\u5219\u4e2d\u7684\u76ee\u6807\u6587\u4ef6\u96c6\u3002\u5728\u6a21\u5f0f\u89c4\u5219\u4e2d\uff0c\u5982\u679c\u6709\u591a\u4e2a\u76ee\u6807\uff0c\u90a3\u4e48\uff0c$@ \u5c31\u662f\u5339\u914d\u4e8e\u76ee\u6807\u4e2d\u6a21\n\u5f0f\u5b9a\u4e49\u7684\u96c6\u5408\u3002\n\n\u2022 $% : \u4ec5\u5f53\u76ee\u6807\u662f\u51fd\u6570\u5e93\u6587\u4ef6\u4e2d\uff0c\u8868\u793a\u89c4\u5219\u4e2d\u7684\u76ee\u6807\u6210\u5458\u540d\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4e00\u4e2a\u76ee\u6807\u662f foo.a(bar.o)\n\uff0c\u90a3\u4e48\uff0c$% \u5c31\u662f bar.o \uff0c$@ \u5c31\u662f foo.a \u3002\u5982\u679c\u76ee\u6807\u4e0d\u662f\u51fd\u6570\u5e93\u6587\u4ef6\uff08Unix \u4e0b\u662f .a \uff0cWindows\n\u4e0b\u662f .lib \uff09\uff0c\u90a3\u4e48\uff0c\u5176\u503c\u4e3a\u7a7a\u3002\n\n\u2022 $&lt; : \u4f9d\u8d56\u76ee\u6807\u4e2d\u7684\u7b2c\u4e00\u4e2a\u76ee\u6807\u540d\u5b57\u3002\u5982\u679c\u4f9d\u8d56\u76ee\u6807\u662f\u4ee5\u6a21\u5f0f\uff08\u5373 % \uff09\u5b9a\u4e49\u7684\uff0c\u90a3\u4e48 $&lt; \u5c06\u662f\u7b26\u5408\u6a21\n\u5f0f\u7684\u4e00\u7cfb\u5217\u7684\u6587\u4ef6\u96c6\u3002\u6ce8\u610f\uff0c\u5176\u662f\u4e00\u4e2a\u4e00\u4e2a\u53d6\u51fa\u6765\u7684\u3002\n\n\u2022 $? : \u6240\u6709\u6bd4\u76ee\u6807\u65b0\u7684\u4f9d\u8d56\u76ee\u6807\u7684\u96c6\u5408\u3002\u4ee5\u7a7a\u683c\u5206\u9694\u3002\n\n\u2022 $^ : \u6240\u6709\u7684\u4f9d\u8d56\u76ee\u6807\u7684\u96c6\u5408\u3002\u4ee5\u7a7a\u683c\u5206\u9694\u3002\u5982\u679c\u5728\u4f9d\u8d56\u76ee\u6807\u4e2d\u6709\u591a\u4e2a\u91cd\u590d\u7684\uff0c\u90a3\u4e48\u8fd9\u4e2a\u53d8\u91cf\u4f1a\u53bb\u9664\n\u91cd\u590d\u7684\u4f9d\u8d56\u76ee\u6807\uff0c\u53ea\u4fdd\u7559\u4e00\u4efd\u3002\n\n\u2022 $+ : \u8fd9\u4e2a\u53d8\u91cf\u5f88\u50cf $^ \uff0c\u4e5f\u662f\u6240\u6709\u4f9d\u8d56\u76ee\u6807\u7684\u96c6\u5408\u3002\u53ea\u662f\u5b83\u4e0d\u53bb\u9664\u91cd\u590d\u7684\u4f9d\u8d56\u76ee\u6807\u3002\n\n\u2022 $* : \u8fd9\u4e2a\u53d8\u91cf\u8868\u793a\u76ee\u6807\u6a21\u5f0f\u4e2d % \u53ca\u5176\u4e4b\u524d\u7684\u90e8\u5206\u3002\u5982\u679c\u76ee\u6807\u662f dir/a.foo.b \uff0c\u5e76\u4e14\u76ee\u6807\u7684\u6a21\u5f0f\u662f\na.%.b \uff0c\u90a3\u4e48\uff0c$* \u7684\u503c\u5c31\u662f dir/a.foo \u3002\u8fd9\u4e2a\u53d8\u91cf\u5bf9\u4e8e\u6784\u9020\u6709\u5173\u8054\u7684\u6587\u4ef6\u540d\u662f\u6bd4\u8f83\u6709\u8f83\u3002\u5982\u679c\u76ee\n\u6807\u4e2d\u6ca1\u6709\u6a21\u5f0f\u7684\u5b9a\u4e49\uff0c\u90a3\u4e48 $* \u4e5f\u5c31\u4e0d\u80fd\u88ab\u63a8\u5bfc\u51fa\uff0c\u4f46\u662f\uff0c\u5982\u679c\u76ee\u6807\u6587\u4ef6\u7684\u540e\u7f00\u662f make \u6240\u8bc6\u522b\u7684\uff0c\n\u90a3\u4e48 $* \u5c31\u662f\u9664\u4e86\u540e\u7f00\u7684\u90a3\u4e00\u90e8\u5206\u3002\u4f8b\u5982\uff1a\u5982\u679c\u76ee\u6807\u662f foo.c \uff0c\u56e0\u4e3a .c \u662f make \u6240\u80fd\u8bc6\u522b\u7684\u540e\u7f00\n\u540d\uff0c\u6240\u4ee5\uff0c$* \u7684\u503c\u5c31\u662f foo \u3002\u8fd9\u4e2a\u7279\u6027\u662f GNU make \u7684\uff0c\u5f88\u6709\u53ef\u80fd\u4e0d\u517c\u5bb9\u4e8e\u5176\u5b83\u7248\u672c\u7684 make\uff0c\u6240\n\u4ee5\uff0c\u4f60\u5e94\u8be5\u5c3d\u91cf\u907f\u514d\u4f7f\u7528 $* \uff0c\u9664\u975e\u662f\u5728\u9690\u542b\u89c4\u5219\u6216\u662f\u9759\u6001\u6a21\u5f0f\u4e2d\u3002\u5982\u679c\u76ee\u6807\u4e2d\u7684\u540e\u7f00\u662f make \u6240\n\u4e0d\u80fd\u8bc6\u522b\u7684\uff0c\u90a3\u4e48 $* \u5c31\u662f\u7a7a\u503c\u3002\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#-nostdlib","title":"-nostdlib","text":"<ul> <li>\u4e0d\u8fde\u63a5\u7cfb\u7edf\u6807\u51c6\u542f\u52a8\u6587\u4ef6\u548c\u6807\u51c6\u5e93\u6587\u4ef6\uff0c\u53ea\u628a\u6307\u5b9a\u7684\u6587\u4ef6\u4f20\u9012\u7ed9\u8fde\u63a5\u5668\u3002\u8fd9\u4e2a\u9009\u9879\u5e38\u7528\u4e8e\u7f16\u8bd1\u5185\u6838\u3001bootloader\u7b49\u7a0b\u5e8f\uff0c\u5b83\u4eec\u4e0d\u9700\u8981\u542f\u52a8\u6587\u4ef6\u3001\u6807\u51c6\u5e93\u6587\u4ef6\u3002</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#-fno-builtin","title":"-fno-builtin","text":"<ul> <li> <p>-fno-builtin\u8fd9\u4e2a\u9009\u9879\u3002\u5b83\u7684\u542b\u4e49\u5373\u4e0d\u4f7f\u7528C\u8bed\u8a00\u7684\u5185\u5efa\u51fd\u6570</p> </li> <li> <p>-fno-builtin-function\uff08\u5176\u4e2dfunction\u4e3a\u8981\u51b2\u7a81\u7684\u51fd\u6570\u540d\uff09</p> </li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#ld-e","title":"ld -e","text":"<ul> <li>\u8bbe\u7f6e\u5165\u53e3\u51fd\u6570</li> <li>_entry</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/Makefile%E5%AD%A6%E4%B9%A0/#_9","title":"\u4f8b\u5b50","text":"Makefile<pre><code>CC=gcc\nCFLAGS=-Wall -Wformat=0\nODIR=obj\nIDIR=../include\nLDIR=../lib\nPROGRAM=client server\n\n_DEPS = error_functions.o get_num.o inet_sockets.o become_daemon.o\nDEPS = $(patsubst %, $(ODIR)/%,$(_DEPS))\n\nall: $(PROGRAM)\n\n# compile\n$(ODIR)/%.o: $(LDIR)/%.c\n    $(CC) -c -o $@ $&lt;\n\n$(ODIR)/%.o: %.c\n    $(CC) -c -o $@ $&lt;\n\n# link\n$(PROGRAM): $(patsubst %, $(ODIR)/%,$(addsuffix .o,$(PROGRAM))) $(DEPS)\n    $(CC) -o $@ $(ODIR)/$@.o $(DEPS) \n\n.PHONY: clean\nclean: \n    rm $(ODIR)/*.o $(PROGRAM)\n</code></pre> Makefile<pre><code> CC = gcc\n TARGET = prog\n SOURCE = $(wildcard ./src/*.c)      #\u83b7\u53d6src\u76ee\u5f55\u4e0b\u6240\u6709.c\u6587\u4ef6\n OBJS = $(patsubst %.c, %.o, $(SOURCE))\n INCLUDE = -I./include\n $(TARGET):$(OBJS)  \n     $(CC) $(OBJS) -o $(TARGET)     #\u53e6\u4e00\u79cd\u5199\u6cd5\uff1a $(CC) -o $(TARGET) $(OBJS)\n %.o:%.c\n     $(CC) $(INCLUDE) -c $^ -o $@   #\u53e6\u4e00\u79cd\u5199\u6cd5\uff1a  $(CC) $(INCLUDE) -c -o $@ $^                                                                       \n .PHONY:clean\n clean:\n     rm $(OBJS) $(TARGET) \n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/","title":"C++-\u5e76\u53d1\u4e0e\u591a\u7ebf\u7a0b\u7f16\u7a0b","text":"2025-12-132025-12-13 <code>#C++</code>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/#_1","title":"\u5e76\u53d1\u4e0e\u591a\u7ebf\u7a0b\u7f16\u7a0b","text":"<p> \u7ea6 398 \u4e2a\u5b57  63 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/#_2","title":"\u7ebf\u7a0b\u4f20\u503c","text":"<ul> <li>\u4f7f\u7528 <code>detach()</code> \u5206\u79bb\u4e24\u4e2a\u7ebf\u7a0b\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e3b\u7ebf\u7a0b\u5728\u5b50\u7ebf\u7a0b\u7ed3\u675f\u524d\u5c31\u8dd1\u5b8c\u4e86</li> <li>char*\u53d8\u91cf\u5728\u7ebf\u7a0b\u4e2d\u5730\u5740\u76f8\u540c\uff1b\u4f7f\u7528string\u7c7b\u578b\u5f15\u7528\u6765\u89e3\u51b3\uff1b\u521b\u5efa <code>m_thread</code> \u5bf9\u8c61\u7684\u65f6\u5019\u590d\u5236\u4e00\u4efd\u4e34\u65f6\u53d8\u91cf</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/#_3","title":"\u9690\u5f0f\u8f6c\u6362\u548c\u663e\u793a\u8f6c\u6362","text":"<ul> <li> <p>\u9690\u5f0f\u8f6c\u6362\uff0c\u5bf9\u8c61\u5728\u5b50\u7ebf\u7a0b\u8fdb\u884c\u6784\u9020\uff1b\u5982\u679cdetach\u540emain\u7ebf\u7a0b\u5148\u7ed3\u675f\uff1b\u76f4\u63a5\u5931\u8d25</p> </li> <li> <p>\u663e\u793a\u8f6c\u6362\uff0c\u5bf9\u8c61\u7684\u6784\u5efa\u8fc7\u7a0b\u548c\u62f7\u8d1d\u8fc7\u7a0b\u90fd\u662f\u5728\u4e3b\u7ebf\u7a0b\u4e2d\u5b8c\u6210\u7684\uff0c\u8fd9\u5c31\u786e\u4fdd\u4e86\u5b50\u7ebf\u7a0b\u5728\u4f7f\u7528\u8be5\u53c2\u6570\u65f6\u662f\u5b89\u5168\u7684</p> </li> <li> <p>\u4e34\u65f6\u53d8\u91cf\u4f20\u53c2</p> </li> <li> <p>\u5982\u679c\u4f20\u9012int\u8fd9\u79cd\u7b80\u5355\u7c7b\u578b\uff0c\u63a8\u8350\u4f7f\u7528\u503c\u4f20\u9012\uff0c\u4e0d\u8981\u7528\u5f15\u7528\uff1b</p> </li> <li>\u5982\u679c\u4f20\u9012\u7c7b\u5bf9\u8c61\uff0c\u8981\u907f\u514d\u4f7f\u7528\u9690\u5f0f\u7c7b\u578b\u8f6c\u6362\uff0c\u5fc5\u987b\u5728\u4ee3\u7801\u4e2d\u663e\u5f0f\u8f6c\u6362\uff08\u76f8\u5f53\u4e8e\u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u53d8\u91cf\uff09\uff0c\u7136\u540e\u5728\u51fd\u6570\u53c2\u6570\u91cc\uff0c\u7528\u5f15\u7528\u6765\u63a5\uff08\uff09\uff0c\u867d\u7136\u8be5\u65b9\u6cd5\u5b89\u5168\uff0c\u4f46\u4e0d\u6613\u7406\u89e3\uff0c\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c</li> <li>\u4e0d\u5efa\u8bae\u4f7f\u7528 detach()\uff0c\u7528\u4e86\u975e\u5e38\u5bb9\u6613\u51fa\u95ee\u9898</li> </ul>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/#_4","title":"\u4f20\u9012\u7c7b\u5bf9\u8c61\uff0c\u667a\u80fd\u6307\u9488","text":"<ul> <li>\u53c2\u6570\u662f\u4e00\u4e2a\u62f7\u8d1d\u51fa\u6765\u7684\u5bf9\u8c61\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u5b50\u7ebf\u7a0b\u4e2d\u4fee\u6539\u8be5\u5bf9\u8c61\u4e2d\u7684\u6210\u5458\uff0c\u662f\u4e0d\u4f1a\u4f20\u56de\u7ed9\u4e3b\u7ebf\u7a0b\u7684</li> <li>\u5c06\u201c\u5047\u201d\u5f15\u7528\u53d8\u4e3a\u771f\u5f15\u7528\uff1b\u4f7f\u7528std::ref()</li> </ul> C++<pre><code>class A {\n public:\n  mutable int m_i; /* \u6dfb\u52a0mutable\u4fee\u9970\uff0c\u8ba9m_i\u80fd\u88ab\u4fee\u6539 */\n  /* \u6784\u9020\u51fd\u6570\uff0c\u6b64\u5904\u5b9e\u9645\u4e0a\u662f\u628a\u4e00\u4e2aint\u8f6c\u6210\u7c7b\u578bA\u7684\u5bf9\u8c61\uff0c\u53c8\u79f0\u4e3a\u7c7b\u578b\u8f6c\u6362\u6784\u9020\u51fd\u6570 */\n  A(int a) : m_i(a) { cout &lt;&lt; \"[A::A(int a) exec]\" &lt;&lt; endl; }\n  /* \u62f7\u8d1d\u6784\u9020\u51fd\u6570 */\n  A(const A &amp;a) : m_i(a.m_i) { cout &lt;&lt; \"[A::A(const A &amp;a) exec]\" &lt;&lt; endl; }\n  /* \u6790\u6784\u51fd\u6570 */\n  ~A() { cout &lt;&lt; \"[A::~A() exec]\" &lt;&lt; endl; }\n};\n\nvoid my_print(const A &amp;pbuf) {\n  pbuf.m_i = 66;\n  cout &lt;&lt; \"my_print pbuf.m_i = \" &lt;&lt; pbuf.m_i &lt;&lt; endl;\n  return;\n}\n\nint main() {\n  A obj(10);\n  thread m_thread(my_print, ref(obj));\n  m_thread.join();\n\n  cout &lt;&lt; \"main obj.m_i = \" &lt;&lt; obj.m_i &lt;&lt; endl;\n  cout &lt;&lt; \"Hello World!\" &lt;&lt; endl;\n  return 0;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/c%2B%2Bprimer/%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/#_5","title":"\u7528\u6210\u5458\u51fd\u6570\u6307\u9488\u505a\u7ebf\u7a0b\u51fd\u6570","text":"<ul> <li>thread(argv[])</li> <li>argv[0]\uff1a\u6210\u5458\u51fd\u6570\u6307\u9488</li> <li>argv[1]\uff1aA\u7c7b\u5bf9\u8c61</li> <li>argv[2]\uff1a\u56de\u8c03\u51fd\u6570\u53c2\u6570</li> </ul> C++<pre><code>#include &lt;iostream&gt;\n#include &lt;thread&gt;\nusing namespace std;\n\nclass A\n{\npublic:\n    int m_i;\n    /* \u6784\u9020\u51fd\u6570\uff0c\u6b64\u5904\u5b9e\u9645\u4e0a\u662f\u628a\u4e00\u4e2aint\u8f6c\u6210\u7c7b\u578bA\u7684\u5bf9\u8c61\uff0c\u53c8\u79f0\u4e3a\u7c7b\u578b\u8f6c\u6362\u6784\u9020\u51fd\u6570 */\n    A(int a) : m_i(a) { cout &lt;&lt; \"[A::A(int a) exec]\" &lt;&lt; endl; }\n    /* \u62f7\u8d1d\u6784\u9020\u51fd\u6570 */\n    A(const A &amp;a) : m_i(a.m_i) { cout &lt;&lt; \"[A::A(const A &amp;a) exec]\" &lt;&lt; endl; }\n    /* \u6790\u6784\u51fd\u6570 */\n    ~A() { cout &lt;&lt; \"[A::~A() exec]\" &lt;&lt; endl; }\n    /* \u6210\u5458\u51fd\u6570\u505a\u7ebf\u7a0b\u56de\u8c03\u51fd\u6570 */\n    void thread_work(int num)\n    {\n        cout &lt;&lt; \"thread_work exec\" &lt;&lt; endl;\n    }\n};\n\nint main()\n{\n    A obj(10);\n    int var = 15;\n    /* \u53c2\u6570\u4e00\uff1a\u6210\u5458\u51fd\u6570\u6307\u9488 */\n    /* \u53c2\u6570\u4e8c\uff1aA\u7c7b\u5bf9\u8c61 */\n    /* \u53c2\u6570\u4e09\uff1a\u56de\u8c03\u51fd\u6570\u53c2\u6570 */\n    /* \u53c2\u6570..\uff1a\u56de\u8c03\u51fd\u6570\u53c2\u6570 */\n    thread m_thread(&amp;A::thread_work, obj, var);         /* obj\u5bf9\u8c61\u4f1a\u88ab\u62f7\u8d1d\u4e00\u4efd\u4f20\u5165\u5b50\u7ebf\u7a0b */\n    // thread m_thread(&amp;A::thread_work, ref(obj), var); /* obj\u5bf9\u8c61\u76f4\u63a5\u4f20\u5165\u5b50\u7ebf\u7a0b */\n    // thread m_thread(&amp;A::thread_work, &amp;obj, var);     /* \u4e0estd::ref()\u4e00\u6837\uff0cobj\u5bf9\u8c61\u4e5f\u662f\u76f4\u63a5\u4f20\u5165\u5b50\u7ebf\u7a0b(&amp;obj\u4e3a\u53d6\u5730\u5740) */\n    m_thread.join();\n\n    cout &lt;&lt; \"Hello World!\" &lt;&lt; endl;\n    return 0;\n}\n</code></pre>","tags":["C++"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/","title":"GPU \u5185\u5b58\u7cfb\u7edf\u6f14\u8fdb\uff1a\u6700\u5927\u5316\u5e26\u5bbd\u5229\u7528\u4e0e\u5ef6\u8fdf\u9690\u85cf\u7684\u6280\u672f\u8def\u5f84","text":"2025-12-132025-12-13 <code>#CUDA</code>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#gpu","title":"GPU \u5185\u5b58\u7cfb\u7edf\u6f14\u8fdb\uff1a\u6700\u5927\u5316\u5e26\u5bbd\u5229\u7528\u4e0e\u5ef6\u8fdf\u9690\u85cf\u7684\u6280\u672f\u8def\u5f84","text":"<p> \u7ea6 2035 \u4e2a\u5b57  86 \u884c\u4ee3\u7801  8 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 11 \u5206\u949f</p> <p>\u53c2\u8003 BBuf \u7684\u535a\u5ba2</p> <p>\u867d\u7136 GPU \u663e\u5b58\u5e26\u5bbd\u8d8a\u6765\u8d8a\u5927\uff0c\u4f46\u5355\u4e2a SM\uff08Streaming Multiprocessor\uff09\u7684\u53ef\u7528\u5e26\u5bbd\u63d0\u5347\u5e45\u5ea6\u53d7\u9650\uff0c\u56e0\u6b64 kernel \u60f3\u8981\u6253\u6ee1\u5e26\u5bbd\uff0c\u9700\u8981\u63d0\u9ad8\u6bcf\u4e2a\u65f6\u523b\u5728 in-flight \u7684\u6570\u636e\u91cf\u3002\u8fd9\u5c31\u5f15\u51fa\u4e86\u4e09\u4e2a\u4f18\u5316\u8def\u5f84\uff1aILP/DLP \u5e76\u884c\u6269\u5c55\u3001\u5f02\u6b65\u5185\u5b58\u52a0\u8f7d\u3001\u4ee5\u53ca\u542f\u52a8\u5ef6\u8fdf\u4f18\u5316</p> <p>in-flight \u6570\u636e \u6307\u7684\u662f\uff1a\u5728\u4efb\u610f\u65f6\u523b\uff0c\u5df2\u7ecf\u88ab\u53d1\u51fa\u4f46\u5c1a\u672a\u5b8c\u6210\u7684\u5185\u5b58\u8bbf\u95ee\u6216\u8ba1\u7b97\u8bf7\u6c42\u6240\u6d89\u53ca\u7684\u6570\u636e\u91cf</p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#littles-law","title":"Little's Law","text":"<p>\u957f\u671f\u5e73\u5747\u987e\u5ba2\u6570\uff08\u00a0L\u00a0\uff09\u7b49\u4e8e\u957f\u671f\u5e73\u5747\u6709\u6548\u5230\u8fbe\u7387\uff08\u00a0\u03bb\u00a0\uff09\u4e58\u4ee5\u987e\u5ba2\u5728\u7cfb\u7edf\u4e2d\u505c\u7559\u7684\u5e73\u5747\u65f6\u95f4\uff08\u00a0W\u00a0\uff09\u3002\u8be5\u5b9a\u5f8b\u7684\u4ee3\u6570\u8868\u8fbe\u5f0f\u4e3a\uff1a</p> \\[ L = \\\\lambda W \\] <p>\u5bf9\u4e8e GPU \u6765\u8bf4\uff0cLittle's Law \u5982\u4e0b\uff1a</p> \\[ bytes-in-flight = bandwidth * mean\\\\space latency \\] <p>bandwidth \u548c mean latency \u7531\u786c\u4ef6\u51b3\u5b9a \u786c\u4ef6\u7ed9\u5b9a\u5e26\u5bbd\u4e0e\u5ef6\u8fdf\uff1b\u8f6f\u4ef6\u9700\u628a\u201cin-fight \u5b57\u8282\u6570\u201d\u5806\u5230\u8fd9\u4e2a\u6c34\u5e73\uff0c\u624d\u80fd\u5403\u6ee1\u5e26\u5bbd</p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#motivationvector-add-example","title":"Motivation(Vector Add Example)","text":"C++<pre><code>__global__ void kernel(float* a, float* b, float* c)\n{\n    int i = blockId.x * blockDim.x + threadId.x;\n    c[i] = a[i] + b[i];\n}\n</code></pre> <p>\u6bcf\u4e2a SM \u7684 <code>bytes-in-flight</code> \u8ba1\u7b97\u516c\u5f0f\u5982\u4e0b\uff1a</p> \\[ bytes-in-flight / SM = (#loads/thread) \\\\times (#bytes/load) \\\\times (#threads/block) \\\\times (#blocks/SM) \\] <p>\u5bf9\u4e8e\u5411\u91cf\u52a0\u6cd5\u6765\u8bf4\uff1a2 \u00d7 4 \u00d7 256 \u00d7 8 = 16 KB/SM\uff08\u5047\u8bbe 100% Occupancy\uff09</p> <p>\u7b80\u5355 kernel \u96be\u4ee5\u6253\u6ee1\u5e26\u5bbd\u3002\u771f\u5b9e\u5e26\u5bbd\u5728\u4e0a\u5347\u4f46\u662f\u7b80\u5355 kernel \u7684\u5229\u7528\u7387\u5374\u5728\u4e0b\u964d</p> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#how-to-increase-bandwidthbig-scale","title":"How To Increase Bandwidth(Big Scale)","text":"<p>\u7531\u4e0a\u9762\u7684\u77e5\u8bc6\u6211\u4eec\u77e5\u9053\u60f3\u628a\u5e26\u5bbd\u6253\u6ee1\uff0c\u5c31\u8981\u63d0\u5347 <code>in-flight</code> \u7684\u5b57\u8282\u6570\uff0c\u8fd9\u91cc\u4ecb\u7ecd\u4e86\u4e09\u79cd\u901a\u7528\u624b\u6bb5</p> <ul> <li>\u63d0\u5347 ILP\uff1a\u6bcf\u7ebf\u7a0b\u5904\u7406\u591a\u5143\u7d20\u3001\u5faa\u73af\u5c55\u5f00\u3001\u589e\u52a0\u5e76\u884c\u52a0\u8f7d\uff08\u5355\u7ebf\u7a0b\u66f4\u591a\u72ec\u7acb\u5185\u5b58\u64cd\u4f5c\uff09\u3002</li> <li>\u63d0\u5347 DLP\uff1a\u7528 <code>float4/uint4</code> \u7b49\u3001\u5408\u5e76\u8bbf\u95ee\uff0c\u5355\u6b21\u4e8b\u52a1\u642c\u66f4\u591a\u5b57\u8282\u5e76\u51cf\u5c11\u6307\u4ee4\uff08\u5411\u91cf\u5316\u5185\u5b58\u64cd\u4f5c\uff09\u3002</li> <li>\u5f02\u6b65\u6570\u636e\u62f7\u8d1d\uff1a\u7528 <code>cp.async/TMA</code> \u9884\u53d6\u5230 shared memory\uff0c\u53cc/\u4e09\u7f13\u51b2\uff0c\u8ba9\u52a0\u8f7d\u4e0e\u8ba1\u7b97\u91cd\u53e0\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#ilp","title":"\u63d0\u5347\u6307\u4ee4\u5e76\u884c\u5ea6 ILP","text":"<p><code>#pragma unroll 2</code>\u00a0 \u6216\u624b\u5de5\u5c55\u5f00\uff0c\u8ba9\u4e00\u4e2a\u7ebf\u7a0b\u5728\u4f7f\u7528\u524d\u5148\u53d1\u8d77\u4e24\u5bf9\u72ec\u7acb\u52a0\u8f7d\uff1a<code>a[i1], b[i1], a[i2], b[i2]</code>\uff0c\u518d\u8fdb\u884c\u4e24\u6b21\u8ba1\u7b97\u4e0e\u5199\u56de\u3002</p> <p>\u4f30\u7b97\u6bcf\u7ebf\u7a0b in-fight \u5b57\u8282\u6570\u7ffb\u500d\uff1a<code>#loads/thread</code> = 4\uff0c4 \u00d7 4B = 16B\u3002in-fight \u8bf7\u6c42\u66f4\u591a\uff0c\u5e26\u5bbd\u5229\u7528\u66f4\u9ad8\u3002</p> C++<pre><code>__global__ void(int n,\nconst float* __restrict__ a,\nconst float* __restrict__ b,\nfloat* __restrict__ c\n)\n{\n    int tid = blockId.x * blockDim.x + threadId.x;\n    int stride = blockDim.x * gridDim.x\n    /*\n        load a[i1]\n        load b[i1]\n        load a[i2]\n        load b[i2]\n        mul a[i1], b[i1]\n        store c[i1]\n        mul a[i2], b[i2]\n        store c[i2]\n    */\n    #pragma unroll 2\n    for(int i = tid; i &lt; n; i += stride) {\n        c[i] = a[i] + b[i];\n    }\n}\n</code></pre>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#dlp","title":"\u63d0\u5347\u6570\u636e\u5e76\u884c\u5ea6 DLP","text":"<p>\u201c\u5411\u91cf\u5316\u5168\u5c40\u8bbf\u5b58\u201d\u63d0\u5347 DLP/bytes\u2011in\u2011flight\uff0c\u4ece\u800c\u66f4\u63a5\u8fd1\u5cf0\u503c\u5e26\u5bbd</p> <p>\u663e\u5f0f\u4f7f\u7528\u5411\u91cf\u7c7b\u578b\uff1a<code>float2</code>\u3001<code>float4</code>\uff08\u5bf9\u5e94 64/128\u2011bit \u4e8b\u52a1\uff09\u3002\u6216\u5bf9\u6807\u91cf\u6307\u9488\u505a\u5411\u91cf\u6307\u9488\u7684\u5f3a\u5236\u8f6c\u6362\uff1b\u524d\u63d0\u662f\u5730\u5740\u6309 8/16B \u5bf9\u9f50</p> <p>\u6bcf\u7ebf\u7a0b in-fight \u5b57\u8282\u6570\u7ffb\u500d\uff1a<code>#loads/thread</code> = 4\uff0c4 \u00d7 4B = 16B</p> <p>\u4e00\u6b21\u8fed\u4ee3\u6709 16B \u6570\u636e\u5728 in-fight\uff0c\u6307\u4ee4/\u4e8b\u52a1\u66f4\u5c11\u3002\u9700\u8981\u786e\u4fdd\u5bf9\u9f50\u4e0e\u8fb9\u754c\u5904\u7406\uff08<code>N%2</code>\u3001<code>N%4</code> \u7684\u5c3e\u90e8\uff09\u3001\u53ef\u80fd\u7684\u5bc4\u5b58\u5668\u538b\u529b</p> C++<pre><code>__global__ void(int n,\nconst float2* __restrict__ a,\nconst float2* __restrict__ b,\nfloat2* __restrict__ c\n)\n{\n    int tid = blockId.x * blockDim.x + threadId.x;\n    int stride = blockDim.x * gridDim.x\n    /*\n        load a[i1], a[i2]\n        load b[i1], b[i2]\n\n        mul a[i1], b[i1]\n        mul a[i2], b[i2]\n\n        store c[i1], c[i2]\n    */\n    #pragma unroll 2\n    for(int i = tid; i &lt; N / 2; i += stride) {\n        c[i] = a[i] + b[i];\n    }\n}\n</code></pre> <p>\u65b0\u67b6\u6784\u8981\u5403\u6ee1\u5e26\u5bbd\u66f4\u4f9d\u8d56\u589e\u5927 \u00a0<code>bytes\u2011in\u2011flight</code>\uff1b\u4f18\u5148\u5c1d\u8bd5\u5411\u91cf\u5316\u5230 128bit\uff08\u4fdd\u8bc1\u5bf9\u9f50\uff09\uff0c\u518d\u914d\u5408\u9002\u5ea6 unroll\uff0c\u6ce8\u610f\u5bc4\u5b58\u5668\u4e0e\u5360\u7528(Occupancy)\u6743\u8861\u3002</p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#_1","title":"\u5f02\u6b65\u52a0\u8f7d","text":"<p>\u5373\u4f7f ILP/DLP \u505a\u5230\u6781\u81f4\uff0c\u4ecd\u53d7\u9650\u4e8e\u540c\u6b65 load \u5bfc\u81f4\u7684 stall\uff08\u7b49\u5f85\u5185\u5b58\u8fd4\u56de\uff09\u3002\\ \u56e0\u6b64\u4e0b\u4e00\u6b65\u7684\u63d0\u5347\u662f\uff1a\u5c06\u5185\u5b58\u52a0\u8f7d\u4e0e\u8ba1\u7b97\u5f7b\u5e95\u89e3\u8026\uff0c\u8ba9\u5185\u5b58\u4f20\u8f93\u5728\u540e\u53f0\u8fdb\u884c\u3002</p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#_2","title":"\u539f\u7406","text":"<p>\u901a\u8fc7\u8df3\u8fc7\u5bc4\u5b58\u5668\u76f4\u63a5\u5c06\u6570\u636e\u4ece\u5168\u5c40\u5185\u5b58\u4f20\u8f93\u5230\u5171\u4eab\u5185\u5b58\uff0c\u65e2\u8282\u7701\u4e86\u5b9d\u8d35\u7684\u5bc4\u5b58\u5668\u8d44\u6e90\u7528\u4e8e\u8ba1\u7b97\uff0c\u53c8\u51cf\u5c11\u4e86 L1 \u7f13\u5b58\u7684\u6d41\u91cf\u8d1f\u62c5\uff0c\u76f8\u6bd4\u4f20\u7edf\u7684\u540c\u6b65\u590d\u5236\uff08\u9700\u8981\u7ecf\u8fc7\u5bc4\u5b58\u5668\u4e2d\u8f6c\uff09\uff0c\u5f02\u6b65\u590d\u5236\u63d0\u4f9b\u4e86\u4e24\u79cd\u6a21\u5f0f\u2014\u2014L1 \u7ed5\u8fc7\u6a21\u5f0f\u548c L1 \u8bbf\u95ee\u6a21\u5f0f\uff0c\u5b9e\u73b0\u4e86\u66f4\u9ad8\u6548\u7684\u5185\u5b58\u6570\u636e\u4f20\u8f93\u3002</p> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#async-load-tma","title":"Async Load &amp; TMA","text":"<ul> <li>\u666e\u901a\u5f02\u6b65\u52a0\u8f7d\u9700\u8981\u591a\u4e2a\u7ebf\u7a0b\u53c2\u4e0e\u590d\u5236\u5e76\u5728\u7ebf\u7a0b\u4f5c\u7528\u57df pipeline \u4e2d\u5b8c\u6210\u540c\u6b65</li> <li>TMA \u53ea\u9700\u8981\u4e00\u4e2a\u7ebf\u7a0b\u542f\u52a8\u590d\u5236\u64cd\u4f5c\uff0c\u901a\u8fc7\u5171\u4eab\u5185\u5b58\u5c4f\u969c\u5b8c\u6210\u540c\u6b65\u63a7\u5236\uff0c\u5b9e\u73b0\u4e86\u66f4\u9ad8\u6548\u7684\u5927\u5757\u6570\u636e\u4f20\u8f93\uff0c\u51cf\u5c11\u4e86\u7ebf\u7a0b\u534f\u8c03\u7684\u5f00\u9500\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#example","title":"Example","text":"<p>\u901a\u8fc7<code>cuda::memcpy_async</code>\uff0c\u53ea\u9700\u5355\u4e2a\u7ebf\u7a0b\u5c31\u80fd\u542f\u52a8\u5927\u5757\u6570\u636e\u590d\u5236\uff0c\u4f7f\u7528\u5171\u4eab\u5185\u5b58\u5c4f\u969c\uff08<code>cuda::barrier</code>\uff09\u8fdb\u884c\u5b8c\u6210\u540c\u6b65\u63a7\u5236\uff0c</p> <p>\u5f53\u6e90/\u76ee\u6807\u5730\u5740 16 \u5b57\u8282\u5bf9\u9f50\u4e14\u5927\u5c0f\u4e3a 16 \u7684\u500d\u6570\u65f6\u4f1a\u81ea\u52a8\u4f7f\u7528 TMA \u786c\u4ef6\u52a0\u901f\uff0c\u5426\u5219\u56de\u9000\u5230\u540c\u6b65\u590d\u5236\u6a21\u5f0f\u3002</p> C++<pre><code>#include &lt;cuda/barrier&gt;\n__shared__ cuda::barrier&lt;cuda::thread_scope_block&gt; bar;\nif(threadIdx.x == 0) {\n    init(&amp;bar, blockDim.x);\n}\n__syncthreads();\n\nif(threadIdx.x == 0) {\n    cuda::memmcpy_async(smem_a, a + idx, cuda::aligned_size_t&lt;16&gt;(num_bytes), bar);\n    cuda::memmcpy_async(smem_b, b + idx, cuda::aligned_size_t&lt;16&gt;(num_bytes), bar);\n}\n\nbarrier::arrival_token token = bar.arrive();\nbar.wait(cuda::std::move(token));\n</code></pre>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#async-load","title":"Async Load \u603b\u7ed3","text":"\u5bf9\u9f50\u7ea6\u675f \u989d\u5916\u7684\u597d\u5904 Synchronous Loads None Async Loads 4, 8 or 16 bytes + \u6279\u5904\u7406\u590d\u5236\u589e\u52a0 <code>bytes-in-flight</code> Aysnc Bulk Loads 16 bytes + \u6279\u5904\u7406\u590d\u5236\u51cf\u5c11\u6307\u4ee4\u6570\u91cf Async Bulk Tensor Loads SMEM 128 bytes; GMEM 16 bytes; strides multiples of 16 bytes + SMEM swizzling \u80fd\u529b + \u8d8a\u754c\u5904\u7406\u80fd\u529b","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#_3","title":"\u603b\u7ed3","text":"<p>\u4ece\"START HERE\"\u5f00\u59cb\uff0c\u9996\u5148\u5224\u65ad\u5f53\u524d\u662f\u5426\u6709\u8db3\u591f\u7684\u5728\u9014\u5b57\u8282\u6570\uff08bytes-in-flight\uff09\uff0c\u5982\u679c\u8db3\u591f\u5c31\u65e0\u9700\u4f18\u5316\uff1b\u5982\u679c\u4e0d\u591f\uff0c\u63a5\u4e0b\u6765\u5224\u65ad\u6570\u636e\u52a0\u8f7d\u76ee\u6807\u662f\u5bc4\u5b58\u5668\uff08REG\uff09\u8fd8\u662f\u5171\u4eab\u5185\u5b58\uff08SMEM\uff09\u2014\u2014\u9009\u62e9\u5bc4\u5b58\u5668\u5c31\u8fdb\u884c\u5c55\u5f00/\u5411\u91cf\u5316\u4f18\u5316\uff0c\u9009\u62e9\u5171\u4eab\u5185\u5b58\u5219\u9700\u8981\u8fdb\u4e00\u6b65\u8003\u8651\u5bf9\u9f50\u65b9\u5f0f\u548c\u6570\u636e\u5757\u5927\u5c0f\uff1a4/8 \u5b57\u8282\u5bf9\u9f50\u65f6\u4f7f\u7528\u5f02\u6b65\u52a0\u8f7d\uff0c16 \u5b57\u8282\u5bf9\u9f50\u65f6\u6839\u636e Tile \u5927\u5c0f\u9009\u62e9\u7b56\u7565\uff08\u5c0f\u4e8e 1KB \u7528\u666e\u901a\u5f02\u6b65\u52a0\u8f7d\uff0c1-2KB \u4e4b\u95f4\u53ef\u9009\u62e9\u6279\u91cf\u6216\u975e\u6279\u91cf\u5f02\u6b65\u52a0\u8f7d\uff0c\u5927\u4e8e 2KB \u5219\u4f7f\u7528\u5f02\u6b65\u6279\u91cf\u52a0\u8f7d\uff09</p> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#how-to-decrease-latencysmall-scale","title":"How to Decrease Latency(Small scale)","text":"<p>\u76f8\u540c\u95ee\u9898\u89c4\u6a21\u4e0b\u63d0\u9ad8\u5b9e\u9645\u8fbe\u5230\u7684\u5e26\u5bbd\uff0c\u901a\u8fc7\u51cf\u5c11\u603b\u8fd0\u884c\u65f6\u95f4\u6765\u5b9e\u73b0\u8fd9\u4e00\u76ee\u6807\uff0c\u800c\u51cf\u5c11\u603b\u8fd0\u884c\u65f6\u95f4\u9700\u8981\u9488\u5bf9\u6027\u5730\u964d\u4f4e\u5ef6\u8fdf</p> <p>kernel \u542f\u52a8\u5ef6\u8fdf\u662f\u5236\u7ea6\u5c0f\u89c4\u6a21\u95ee\u9898\u6027\u80fd\u7684\u4e3b\u8981\u74f6\u9888</p> <p></p> <p>\u8fd9\u91cc\u6709\u4e24\u79cd\u6280\u672f(\u8f6f\u4ef6\u6280\u672f)\uff1a\u4e00\u4e2a\u662f CUDA Graph\uff0c\u901a\u8fc7\u56fe\u7ed3\u6784\u5316\u6267\u884c\u591a\u4e2a kernel\uff0c\u907f\u514d\u591a\u6b21 CPU\u2192GPU \u7684 launch \u5f00\u9500\uff1b\u4e00\u4e2a\u662f PDL\uff0c\u5f53\u4e00\u4e2a kernel \u8fd0\u884c\u7ed3\u675f\u540e\uff0c\u786c\u4ef6\u81ea\u52a8\u89e6\u53d1\u4e0b\u4e00\u4e2a\u4f9d\u8d56 kernel\uff0c\u4e0d\u9700\u8981 CPU \u8fdb\u884c\u91cd\u65b0 launch</p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#cuda-graph","title":"CUDA Graph","text":"<ul> <li>\u4e00\u6b21\u6027\u6784\u5efa\u6267\u884c\u56fe\uff08Graph Capture\uff09\uff0c\u518d\u6279\u91cf\u6267\u884c\uff08Graph Launch\uff09\u3002</li> <li>\u9002\u5408\u91cd\u590d\u6267\u884c\u7684\u8ba1\u7b97\u56fe\uff0c\u5982\u63a8\u7406 pipeline\u3001\u5c0f batch \u63a8\u7406\u3001RNN \u6b65\u8fdb\u8ba1\u7b97\u3002</li> <li>\u6548\u679c\uff1a\u5c06\u6210\u767e\u4e0a\u5343\u4e2a\u5c0f kernel \u542f\u52a8\u5408\u5e76\u4e3a\u4e00\u6b21\u56fe\u6267\u884c\uff0c\u663e\u8457\u964d\u4f4e CPU overhead\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#usage","title":"Usage","text":"<ul> <li>\u6355\u83b7\u9636\u6bb5\uff08Capture\uff09\u901a\u8fc7 <code>cudaStreamBeginCapture</code> \u548c <code>cudaStreamEndCapture</code> \u5c06 1000 \u6b21 kernel \u8c03\u7528\u5e8f\u5217\u8bb0\u5f55\u6210\u56fe\u7ed3\u6784</li> <li>\u521b\u5efa\u9636\u6bb5\uff08Create\uff09\u7528 <code>cudaGraphInstantiate</code> \u5c06\u6355\u83b7\u7684\u56fe\u8f6c\u6362\u4e3a\u53ef\u6267\u884c\u7684\u56fe\u5b9e\u4f8b</li> <li>\u542f\u52a8\u9636\u6bb5\uff08Launch\uff09\u901a\u8fc7 <code>cudaGraphLaunch</code> \u4e00\u6b21\u6027\u63d0\u4ea4\u6574\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u800c\u4e0d\u662f\u9010\u4e2a\u542f\u52a8 kernel</li> <li>\u6e05\u7406\u9636\u6bb5\uff08Cleanup\uff09\u91ca\u653e\u76f8\u5173\u8d44\u6e90</li> </ul> C++<pre><code>// capture\ncudaGraph_t g;\ncudaGraphCreate(&amp;g, 0);\ncudaStream_t stream;\ncudaStreamCreate(&amp;stream);\ncudaStreamBeginCapture(stream, cudaStreamCaptureModeGlobal);\nfor(int i = 0; i &lt; 1000; ++i)\n    kernel&lt;&lt;&lt;grid,block,smem_size,stream&gt;&gt;&gt;(params);\ncudaStreamEndCapture(stream, &amp;g);\n\n// create\ncudaGraphExec_t gEx;\ncudaGraphInstantiate(&amp;gEx, g, nullptr, nullptr, 0);\n\n// launch\nCUDA_CHECK(cudaGraphLaunch(gEx, stream));\nCUDA_CHECK(cudaDeviceSynchronize());\n\n// cleanup\nCUDA_CHECK(cudaStreamDestroy(stream));\nCUDA_CHECK(cudaGraphDestroy(g));\nCUDA_CHECK(cudaGraphExecDestroy(gEx));\n</code></pre>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#programmatic-dependent-launchpdl","title":"Programmatic Dependent Launch(PDL)","text":"<p>\u8fd9\u662f\u4e00\u79cd\u66f4\u7ec6\u7c92\u5ea6\u7684\u4f18\u5316\u65b9\u6cd5\uff1a\u5728 kernel \u51fd\u6570\u4e2d\u9700\u8981\u8c03\u7528 <code>cudaGridDependencySynchronize()</code> \u6765\u786e\u4fdd\u524d\u4e00\u4e2a kernel \u7684\u5168\u5c40\u5185\u5b58\u5199\u5165\u64cd\u4f5c\u5bf9\u5f53\u524d kernel \u53ef\u89c1\uff0c\u800c\u5728\u542f\u52a8\u914d\u7f6e\u4e2d\u901a\u8fc7\u8bbe\u7f6e<code>cudaLaunchAttributeProgrammaticStreamSerialization</code> \u5c5e\u6027\u548c\u76f8\u5173\u53c2\u6570\u6765\u542f\u7528\u8fd9\u4e00\u7279\u6027</p> <ul> <li>\u5141\u8bb8 kernel \u63d0\u524d\u542f\u52a8\uff0c\u5373\u5728\u524d\u4e00\u4e2a kernel \u7684\u5168\u5c40\u5185\u5b58\u5b58\u50a8\u64cd\u4f5c\u5b8c\u5168\u53ef\u89c1\u4e4b\u524d\u5c31\u5f00\u59cb\u6267\u884c\uff0c\u8fd9\u6837\u53ef\u4ee5\u5b9e\u73b0\u66f4\u591a\u7684\u9884\u53d6\u64cd\u4f5c</li> <li>\u4fdd\u8bc1\u7a0b\u5e8f\u6b63\u786e\u6027\uff0ckernel \u5fc5\u987b\u5728\u9700\u8981\u8bbf\u95ee\u524d\u4e00\u4e2a kernel \u5199\u5165\u7684\u6570\u636e\u4e4b\u524d\u663e\u5f0f\u8c03\u7528<code>cudaGridDependencySynchronize()</code> \u8fdb\u884c\u540c\u6b65</li> <li>\u6700\u5927\u5316\u5730\u91cd\u53e0 kernel \u542f\u52a8\u548c\u6267\u884c</li> </ul> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#triggerprogrammaticlaynchcompletion","title":"TriggerProgrammaticLaynchCompletion","text":"<ul> <li>\u8be5\u51fd\u6570\u5141\u8bb8\u5757\u5728\u5b9e\u9645\u9000\u51fa\u4e4b\u524d\u5c31\u5411 GPU \u8c03\u5ea6\u5668\u53d1\u9001\u5b8c\u6210\u4fe1\u53f7\uff0c\u53ea\u9700\u8981\u5757\u4e2d\u7684\u4e00\u4e2a\u7ebf\u7a0b\u6267\u884c\u8be5\u8c03\u7528\u5373\u53ef</li> <li>\u6539\u53d8\u4e86\u4f20\u7edf\u7684 kernel \u95f4\u540c\u6b65\u6a21\u5f0f\uff1a\u6b63\u5e38\u60c5\u51b5\u4e0b\u4e0b\u4e00\u4e2a kernel \u5fc5\u987b\u7b49\u5f85\u524d\u4e00\u4e2a kernel \u7684\u6240\u6709\u5757\u771f\u6b63\u9000\u51fa\u540e\u624d\u80fd\u542f\u52a8\uff0c\u800c\u73b0\u5728\u4e0b\u4e00\u4e2a kernel \u53ea\u9700\u7b49\u5f85\u6240\u6709\u5757\u90fd\u6267\u884c\u4e86<code>cudaTriggerProgrammaticLaunchCompletion()</code> \u5c31\u53ef\u4ee5\u63d0\u524d\u542f\u52a8\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u8ba1\u7b97\u548c\u4e0b\u4e00\u4e2a kernel \u542f\u52a8\u7684\u91cd\u53e0\uff0c\u8fdb\u4e00\u6b65\u51cf\u5c11\u4e86 kernel \u95f4\u7684\u7a7a\u95f2\u7b49\u5f85\u65f6\u95f4</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/GPU%20%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%BC%94%E8%BF%9B%EF%BC%9A%E6%9C%80%E5%A4%A7%E5%8C%96%E5%B8%A6%E5%AE%BD%E5%88%A9%E7%94%A8%E4%B8%8E%E5%BB%B6%E8%BF%9F%E9%9A%90%E8%97%8F%E7%9A%84%E6%8A%80%E6%9C%AF%E8%B7%AF%E5%BE%84/#_4","title":"\u603b\u7ed3","text":"<ul> <li>CUDA Graph \u89e3\u51b3\u4e86\u6279\u91cf kernel \u63d0\u4ea4\u7684\u5f00\u9500\u95ee\u9898</li> <li>PDL + TriggerProgrammaticLaynchCompletion \u901a\u8fc7\u63d0\u524d\u542f\u52a8\u548c\u66f4\u7ec6\u7c92\u5ea6\u7684\u4f9d\u8d56\u7ba1\u7406\u4ee5\u53ca\u63d0\u524d\u9000\u51fa\u51cf\u5c11\u4e86 kernel \u95f4\u7684\u540c\u6b65\u7b49\u5f85\u65f6\u95f4</li> <li>\u5728\u6700\u5c0f\u89c4\u6a21\uff0810KB \u5de6\u53f3\uff09\u65f6\uff0c\u4e09\u79cd\u7ec4\u5408\u4f18\u5316\u6280\u672f\u53ef\u4ee5\u5b9e\u73b0\u9ad8\u8fbe 3 \u500d\u7684\u52a0\u901f\u6bd4\uff0c\u4f46\u968f\u7740\u6570\u636e\u91cf\u589e\u52a0\uff0c\u52a0\u901f\u6548\u679c\u9010\u6e10\u9012\u51cf\uff0c\u5f53\u6570\u636e\u91cf\u8fbe\u5230 1GB \u4ee5\u4e0a\u65f6\u52a0\u901f\u6bd4\u8d8b\u8fd1\u4e8e 1 \u500d\uff08\u5373\u57fa\u672c\u65e0\u63d0\u5347\uff09</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/","title":"\u4e00\u6b65\u6b65\u5b9e\u73b0 CUDA Vector Add \u4f18\u5316","text":"2025-10-212025-12-13 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#cuda-vector-add","title":"\u4e00\u6b65\u6b65\u5b9e\u73b0 CUDA Vector Add \u4f18\u5316","text":"<p> \u7ea6 2740 \u4e2a\u5b57  251 \u884c\u4ee3\u7801  6 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 17 \u5206\u949f</p> <p>\ud83d\udcda \u672c\u6587\u5c06\u4ece\u6700\u57fa\u7840\u7684 vector add \u5b9e\u73b0\u5f00\u59cb\uff0c\u4f7f\u7528 nsight compute \u5de5\u5177\u8fdb\u884c\u6027\u80fd\u5206\u6790\u5bfb\u627e\u74f6\u9888\u5e76\u4e00\u6b65\u6b65\u8fdb\u884c\u4f18\u5316\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6765\u5b66\u4e60 CUDA \u7684\u7f16\u7a0b\u548c\u4f18\u5316\u3002</p>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#prerequisite","title":"Prerequisite","text":"","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#arithmetic-intensityai","title":"Arithmetic Intensity(AI)","text":"<p>\u7b97\u672f\u5f3a\u5ea6\u662f\u8861\u91cf\u4e00\u4e2a\u8ba1\u7b97\u4efb\u52a1\uff08\u5982 CUDA Kernel\uff09\u662f\u201c\u8ba1\u7b97\u5bc6\u96c6\u578b\u201d\u8fd8\u662f\u201c\u8bbf\u5b58\u5bc6\u96c6\u578b\u201d\u7684\u6838\u5fc3\u6307\u6807\u3002</p> <p>1. \u5b9a\u4e49\uff1a \u5b83\u88ab\u5b9a\u4e49\u4e3a\u201c\u603b\u5171\u6267\u884c\u7684\u6d6e\u70b9\u8ba1\u7b97\u64cd\u4f5c\u6b21\u6570\u201d\u4e0e\u201c\u603b\u5171\u4f20\u8f93\u7684\u6570\u636e\u5b57\u8282\u6570\u201d\u4e4b\u95f4\u7684\u6bd4\u7387\u3002</p> <ul> <li><code>AI = (\u603b\u8ba1\u7b97\u64cd\u4f5c\u6570) / (\u603b\u8bbf\u5b58\u5b57\u8282\u6570)</code></li> <li>\u5355\u4f4d\uff1a <code>FLOPs/Byte</code> (\u5373\uff0c\u6bcf\u4f20\u8f93\u4e00\u4e2a\u5b57\u8282\u7684\u6570\u636e\uff0c\u80fd\u5bf9\u5e94\u6267\u884c\u591a\u5c11\u6b21\u6d6e\u70b9\u8ba1\u7b97)</li> </ul> <p>2. \u4e3a\u4ec0\u4e48\u5b83\u5982\u6b64\u91cd\u8981\uff1f AI \u51b3\u5b9a\u4e86\u4e00\u4e2a\u7a0b\u5e8f\u7406\u8bba\u4e0a\u7684\u6027\u80fd\u74f6\u9888\u3002\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u5bf9\u6bd4\u4e00\u4e2a\u7a0b\u5e8f\u548c\u4e00\u4e2a\u786c\u4ef6\uff08GPU\uff09\u7684\u7279\u6027\uff1a</p> <ul> <li>\u786c\u4ef6\u7684\u201cAI\u201d\uff1aGPU \u4e5f\u6709\u4e00\u4e2a\u5e73\u8861\u70b9\uff0c\u5373\u5b83\u7684 <code>\u5cf0\u503c\u8ba1\u7b97\u80fd\u529b (GFLOPs/s)</code> / `\u5cf0\u503c\u5185\u5b58\u5e26\u5bbd (GB/s)</li> <li>\u7a0b\u5e8f\u7684 AI\uff1a\u5185\u6838\u7684 <code>FLOPs / Bytes</code>\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#roofline","title":"Roofline","text":"<p>Roofline \u6a21\u578b\uff08\u5c4b\u9876\u7ebf\u6a21\u578b\uff09\u662f\u4e00\u79cd\u7528\u6765\u5206\u6790\u7a0b\u5e8f\u6027\u80fd\u74f6\u9888\uff08\u8ba1\u7b97\u53d7\u9650\u8fd8\u662f\u5e26\u5bbd\u53d7\u9650\uff09\u7684\u65b9\u6cd5\u3002\\ \u5b83\u628a\u8ba1\u7b97\u6027\u80fd\uff08FLOPs/s\uff09\u548c\u8bbf\u5b58\u6027\u80fd\uff08Bytes/s\uff09\u8054\u7cfb\u5728\u4e00\u8d77\uff0c\u3002\u4ee5\u53ef\u89c6\u5316\u7684\u65b9\u5f0f\u5c55\u793a\u6027\u80fd\u4e0a\u9650</p> \\[ Achievable\u00a0FLOPs=min(AI\u00d7Memory\u00a0BW,Peak\u00a0FLOPs) \\] <p></p>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#stall-in-ncu","title":"Stall in NCU","text":"\u7c7b\u578b \u4ee3\u8868\u7b49\u5f85 \u5178\u578b\u74f6\u9888 \u4f18\u5316\u65b9\u5411 All Scoreboard \u6240\u6709\u4f9d\u8d56\u672a\u6ee1\u8db3 \u5b8c\u5168\u7b49\u5f85 \u63d0\u9ad8\u5e76\u53d1\u3001\u5f02\u6b65\u8bbf\u95ee Long Scoreboard DRAM \u8bbf\u95ee\u672a\u8fd4\u56de \u5185\u5b58\u5ef6\u8fdf \u4f18\u5316\u8bbf\u5b58\u3001\u5171\u4eab\u5185\u5b58 Short Scoreboard L1/\u5bc4\u5b58\u5668\u4f9d\u8d56 \u6570\u636e\u4f9d\u8d56 \u8c03\u6574\u6307\u4ee4\u987a\u5e8f Execution Dependency \u7b97\u672f\u6307\u4ee4\u7ed3\u679c\u672a\u5c31\u7eea \u8fd0\u7b97\u94fe\u957f \u589e\u52a0 ILP Barrier/Branch \u540c\u6b65\u6216\u5206\u652f\u7b49\u5f85 \u63a7\u5236\u6d41 \u51cf\u5c11\u5206\u652f/\u540c\u6b65","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#settings","title":"Settings","text":"<p>\u8fd9\u91cc\u6d4b\u8bd5\u73af\u5883\u662f RTX 3080 Ti</p> <ul> <li>\u7406\u8bba\u5e26\u5bbd\u7ea6\u4e3a 912 GB/s</li> <li>FP32 peak FLOPs\uff1a34 TFLOPS</li> <li>\u6700\u5927\u7ebf\u7a0b\u6570 / SM\uff1a 1536 \u4e2a\u3002</li> <li>\u6700\u5927 Warp \u6570 / SM\uff1a 48 \u4e2a\u3002</li> </ul> <p>\u4e0b\u9762\u9664 Benchmark \u5916\uff0c\u6240\u6709\u7684\u6d4b\u8bd5 Vector Element \u5927\u5c0f\u4e3a 1024</p>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_1","title":"\u6307\u6807","text":"","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#compute-throughput","title":"Compute Throughput","text":"\\[\\\\text{Compute Throughput} \\\\approx \\\\frac{\\\\text{Total Instructions Executed (\u6307\u4ee4\u603b\u6570)}}{\\\\text{Execution Time (\u6267\u884c\u65f6\u95f4)}}\\]","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#memory-throughput","title":"Memory Throughput","text":"<p>\u5f71\u54cd\u8be5\u6307\u6807\u7684\u95ee\u9898</p>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#1-instruction-issue-efficiency","title":"1. \u6307\u4ee4\u5c42\u7ea7\uff1a\u6307\u4ee4\u53d1\u5c04\u6548\u7387 (Instruction Issue Efficiency)","text":"<p>\u8fd9\u662f <code>float4</code> \u4f18\u5316\u7684\u76f4\u63a5\u4f5c\u7528\u57df\u3002</p> <ul> <li> <p>LSU (Load Store Unit) \u538b\u529b\uff1a</p> </li> <li> <p>Scalar (<code>float</code>): \u642c\u8fd0\u540c\u6837\u591a\u7684\u6570\u636e\uff0c\u9700\u8981\u53d1\u5c04 4 \u500d \u7684\u6307\u4ee4\u6570\u3002\u8fd9\u4f1a\u5927\u91cf\u5360\u7528\u524d\u7aef\uff08Fetch/Decode\uff09\u5e26\u5bbd\uff0c\u5e76\u589e\u52a0 LSU \u7ef4\u62a4 In-flight \u72b6\u6001\u7684\u5f00\u9500\u3002</p> </li> <li> <p>Vectorized (<code>float4</code>): \u5355\u6307\u4ee4\u9ad8\u541e\u5410\u3002\u4e00\u6761\u6307\u4ee4\u5373\u53ef\u642c\u8fd0 128-bit \u6570\u636e\u3002LSU \u961f\u5217\u5360\u7528\u5c11\uff0c\u66f4\u5bb9\u6613\u7ef4\u6301\u6d41\u6c34\u7ebf\u9971\u548c\u3002</p> </li> <li> <p>\u4fee\u6b63\u70b9\uff1a \u5373\u4f7f\u662f\u6807\u91cf\u8bbf\u95ee\uff0c\u5982\u679c\u662f Coalesced \u7684\uff0cWarp \u4e5f\u53ea\u4f1a\u751f\u6210 1 \u4e2a Transaction\uff0c\u4f46\u9700\u8981 4 \u6761\u6307\u4ee4 \u624d\u80fd\u5b8c\u6210 4 \u4e2a\u5143\u7d20\u7684\u52a0\u8f7d\u3002</p> </li> <li> <p>\u6307\u4ee4\u53d1\u5c04\u5ef6\u8fdf\u63a9\u76d6 (Issue Latency Hiding)\uff1a</p> </li> <li> <p>\u6c14\u6ce1\u95ee\u9898\uff1a \u6307\u4ee4\u53d1\u5c04\u6709\u56fa\u6709\u5ef6\u8fdf\u3002\u5982\u679c\u6bcf\u6761\u6307\u4ee4\u642c\u8fd0\u7684\u6570\u636e\u91cf\u592a\u5c0f\uff08\u5982 4 Bytes\uff09\uff0c\u6307\u4ee4\u53d1\u5c04\u7684\u901f\u5ea6\u53ef\u80fd\u8ddf\u4e0d\u4e0a\u5185\u5b58\u603b\u7ebf\u7684\u6d88\u8017\u901f\u5ea6\uff0c\u5bfc\u81f4\u603b\u7ebf\u51fa\u73b0\u201c\u7a7a\u95f2\u6c14\u6ce1\u201d\u3002</p> </li> <li> <p>\u4f18\u52bf\uff1a <code>float4</code> (16 Bytes/thread) \u8ba9\u6bcf\u6b21\u53d1\u5c04\u7684\u201c\u542b\u91d1\u91cf\u201d\u66f4\u9ad8\uff0c\u66f4\u5bb9\u6613\u586b\u6ee1\u5185\u5b58\u7ba1\u9053\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#2-mlp-memory-level-parallelism","title":"2. \u6570\u636e\u5c42\u7ea7\uff1a\u5185\u5b58\u7ea7\u5e76\u884c\u5ea6 (MLP, Memory Level Parallelism)","text":"<p>\u8fd9\u662f\u51b3\u5b9a\u5e26\u5bbd\u4e0a\u9650\u7684\u5173\u952e\u8f6f\u4ef6\u7b56\u7565\u3002</p> <ul> <li> <p>\u539f\u7406\uff1a HBM \u5ef6\u8fdf\u6781\u9ad8 (~600 cycles)\u3002\u4e3a\u4e86\u63a9\u76d6\u5ef6\u8fdf\uff0c\u5fc5\u987b\u8ba9\u603b\u7ebf\u4e0a\u540c\u65f6\u98de\u7740\u8db3\u591f\u591a\u7684\u8bf7\u6c42 (In-flight Requests)\u3002</p> </li> <li> <p>\u4f18\u5316\u624b\u6bb5\uff1a \u5faa\u73af\u5c55\u5f00 (Loop Unrolling)\u3002</p> </li> <li> <p>Bad: <code>Load -&gt; Use -&gt; Load -&gt; Use</code> (\u4e32\u884c\u4f9d\u8d56\uff0c\u5ef6\u8fdf\u65e0\u6cd5\u63a9\u76d6)\u3002</p> </li> <li> <p>Good: <code>Load1 -&gt; Load2 -&gt; Load3 -&gt; Load4 ... -&gt; Use1</code> (\u5e76\u884c\u53d1\u5c04\uff0c\u4e00\u6b21\u7b49\u5f85\uff0c\u5168\u90e8\u8fd4\u56de)\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#3-transaction-utilization","title":"3. \u786c\u4ef6\u5c42\u7ea7\uff1a\u4f20\u8f93\u7c92\u5ea6\u4e0e\u5229\u7528\u7387 (Transaction &amp; Utilization)","text":"<p>\u5373\u4f7f\u8f6f\u4ef6\u5199\u5f97\u597d\uff0c\u786c\u4ef6\u673a\u5236\u4e5f\u53ef\u80fd\u5bfc\u81f4\u6d6a\u8d39\u3002</p> <ul> <li> <p>\u6247\u533a\u5229\u7528\u7387 (Sector Utilization):</p> </li> <li> <p>\u673a\u5236\uff1a DRAM \u5230 L2 \u7684\u6700\u5c0f\u4f20\u8f93\u7c92\u5ea6\u662f 32 Bytes (Sector)\u3002</p> </li> <li> <p>\u6d6a\u8d39\uff1a \u5982\u679c\u4f60\u53ea\u8bfb 1 \u4e2a Byte (<code>char</code>) \u4e14\u672a\u6253\u5305\uff0c\u786c\u4ef6\u4e5f\u88ab\u8feb\u642c\u8fd0 32 Bytes\u3002\u6709\u6548\u5e26\u5bbd (Effective Bandwidth) \u53ea\u6709 1/32\u3002</p> </li> <li> <p>\u5bf9\u7b56\uff1a \u5bf9\u4e8e\u5c0f\u6570\u636e\u7c7b\u578b\uff08INT8/FP16\uff09\uff0c\u5fc5\u987b\u4f7f\u7528\u6253\u5305\u5bf9\u9f50\uff08Pack Alignment\uff09\u8bbf\u95ee\u3002</p> </li> <li> <p>\u5730\u5740\u5bf9\u9f50 (Address Alignment):</p> </li> <li> <p>\u673a\u5236\uff1a \u786c\u4ef6\u8981\u6c42\u8bbf\u95ee\u5730\u5740\u6309 32B \u6216 128B \u5bf9\u9f50\u3002</p> </li> <li> <p>\u540e\u679c\uff1a \u5982\u679c\u6307\u9488\u5730\u5740\u504f\u79fb\uff08Misaligned\uff09\uff0c\u4e00\u6b21 128 Bytes \u7684\u8bfb\u53d6\u53ef\u80fd\u4f1a\u8de8\u8d8a\u4e24\u4e2a 128B \u5757\uff0c\u5bfc\u81f4\u786c\u4ef6\u5fc5\u987b\u53d1\u8d77 2 \u4e2a Transactions\u3002\u8fd9\u4f1a\u76f4\u63a5\u5bfc\u81f4\u5e26\u5bbd\u6027\u80fd\u51cf\u534a\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#4-physical-conflict","title":"4. \u67b6\u6784\u5c42\u7ea7\uff1a\u7269\u7406\u51b2\u7a81 (Physical Conflict)","text":"<p>\u901a\u5e38\u7531\u786c\u4ef6\u89e3\u51b3\uff0c\u4f46\u5728\u6781\u7aef\u4f18\u5316\u65f6\u9700\u6ce8\u610f\u3002</p> <ul> <li> <p>\u5206\u533a\u51b2\u7a81 (Partition Camping / Channel Conflict):</p> </li> <li> <p>\u539f\u7406\uff1a \u663e\u5b58\u88ab\u5212\u5206\u4e3a\u591a\u4e2a\u7269\u7406\u5206\u533a\uff08Memory Controllers\uff09\u3002</p> </li> <li> <p>\u73b0\u8c61\uff1a \u7279\u5b9a\u7684\u8bbf\u95ee\u6b65\u957f\uff08Stride\uff0c\u901a\u5e38\u662f 2 \u7684\u5e42\u6b21\uff09\u53ef\u80fd\u5bfc\u81f4\u6240\u6709\u8bf7\u6c42\u96c6\u4e2d\u6253\u5411\u540c\u4e00\u4e2a Controller\uff0c\u9020\u6210\u5c40\u90e8\u62e5\u5835\uff08Serialization\uff09\uff0c\u800c\u5176\u4ed6 Controller \u7a7a\u95f2\u3002</p> </li> <li> <p>\u73b0\u72b6\uff1a \u73b0\u4ee3 GPU (Pascal+) \u5df2\u901a\u8fc7\u7269\u7406\u5730\u5740\u54c8\u5e0c\uff08Address Swizzling\uff09\u6781\u5927\u7f13\u89e3\u4e86\u6b64\u95ee\u9898\uff0c\u4f46\u5728\u5199\u6781\u9650 Kernel \u65f6\u4ecd\u9700\u907f\u514d\u5b8c\u7f8e\u7684 2 \u7684\u5e42\u6b21\u8de8\u5ea6\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#baseline","title":"baseline","text":"C++<pre><code>// FP32\n// ElementWise Add grid(N/256),\n// block(256) a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)\n__global__ void vector_add_kernel(const float *a, const float *b, float *c,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 int n) {\n\u00a0 int idx = blockIdx.x * blockDim.x + threadIdx.x;\n\u00a0 if (idx &lt; n) {\n\u00a0 \u00a0 c[idx] = a[idx] + b[idx];\n\u00a0 }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_2","title":"\u5206\u6790","text":"<p>\u8be5\u7248\u672c\u7684 vector add\uff0c\u6267\u884c\u4e00\u6b21\u8ba1\u7b97\u9700\u8981\u4e09\u6b21\u8bbf\u5b58\uff0c\u6bcf\u6b21\u8bfb 4 bytes (read A, read B, write C)</p> \\[ AI = 1 / (3 \\\\times 4) =1/12\\\\approx 0.083 \\] <p>\u8bf4\u660e\u8fd9\u662f\u4e00\u4e2a memory-bound \u7684\u7a0b\u5e8f</p> <ul> <li> <p>\u67e5\u770b ncu \u7684 SLO \u6211\u4eec\u53ef\u4ee5\u770b\u5230</p> </li> <li> <p>Memory Throughput: 75%</p> </li> <li> <p>Compute Throughput: 15%</p> </li> <li> <p>\u67e5\u770b Memory Workload Analysis\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u6211\u4eec\u5b8c\u5168\u6ca1\u6709\u7528\u5230 shared memory\uff0c\u76f4\u63a5\u7528 L2 Cache \u548c L1 Cache</p> </li> </ul> <p></p> <ul> <li>Kernel \u7684\u4e3b\u8981\u74f6\u9888\u662f <code>Stall Long Scoreboard</code>\u2014\u2014\u5373\u5185\u5b58\u5ef6\u8fdf\u505c\u987f\u3002GPU \u9690\u85cf\u8fd9\u79cd\u201c\u7b49\u5f85\u201d\u7684\u552f\u4e00\u673a\u5236\uff0c\u5c31\u662f Occupancy (\u5360\u7528\u7387)</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#optimization-v1-vectorized-access","title":"Optimization V1 -- vectorized access","text":"","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_3","title":"\u4f18\u5316","text":"<ul> <li>\u77e2\u91cf\u5316\u5185\u5b58\u8bbf\u95ee\uff1a\u6211\u4eec\u4e0d\u518d\u4e00\u6b21\u8bfb\u53d6\u4e00\u4e2a float\uff0c\u800c\u662f\u540c\u65f6\u53d6 4 \u4e2a float\uff0c\u4e00\u4e2a wrap \u91cc\u9762\u7684\u6240\u6709\u7ebf\u7a0b\u540c\u65f6\u83b7\u53d6 4 float\uff0c\u53ef\u4ee5\u53d8\u4e3a LDG.128 \u4e00\u6b21\u6027\u83b7\u53d6 128 bit \u6570\u636e</li> <li>\u589e\u52a0\u4e86 ILP</li> <li>\u26a0 \u8fd9\u91cc\u6709\u4e2a trade-off\uff0c\u5982\u679c\u6211\u4eec\u6bcf\u4e2a thread \u4f7f\u7528\u4e86\u8fc7\u591a\u7684\u5bc4\u5b58\u5668\uff0c\u90a3\u4e48 SM \u4e0a\u6d3b\u8dc3\u7684 Warp \u4f1a\u53d8\u5c11\uff0c\u5bfc\u81f4 Occupany \u4f1a\u4e0b\u964d\uff0c\u8fd9\u540c\u6837\u5bf9\u6027\u80fd\u5f71\u54cd\u5f88\u5927</li> </ul> C++<pre><code>// ElementWise Add + Vec4\n// grid(N/256), block(256/4)\n// a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)\n__global__ void elementwise_add_f32x4_kernel(const float *a, const float *b,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0float *c, int n) {\n\u00a0 int idx = (blockIdx.x * blockDim.x + threadIdx.x) * 4;\n\u00a0 if (idx &lt; n) {\n\u00a0 \u00a0 float4 a4 = reinterpret_cast&lt;const float4 *&gt;(a)[idx / 4];\n\u00a0 \u00a0 float4 b4 = reinterpret_cast&lt;const float4 *&gt;(b)[idx / 4];\n\u00a0 \u00a0 float4 c4;\n\u00a0 \u00a0 c4.x = a4.x + b4.x;\n\u00a0 \u00a0 c4.y = a4.y + b4.y;\n\u00a0 \u00a0 c4.z = a4.z + b4.z;\n\u00a0 \u00a0 c4.w = a4.w + b4.w;\n\u00a0 \u00a0 reinterpret_cast&lt;float4 *&gt;(c)[idx / 4] = c4;\n\u00a0 }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_4","title":"\u7ed3\u679c","text":"<ul> <li> <p>\u5185\u5b58\u541e\u5410\u589e\u52a0\uff0c\u5185\u5b58\u5229\u7528\u7387\u63d0\u5347\u81f3 80 %\uff1b\u8ba1\u7b97\u5229\u7528\u7387\u4e0b\u964d </p> </li> <li> <p>Occupancy \u4ece 67% \u63d0\u5347\u81f3 100%</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_5","title":"\u5206\u6790","text":"<ul> <li> <p>Compute Throughput \u4e0b\u964d\uff1a \u56e0\u4e3a Vector Add \u662f Memory-Bound \u7684\uff0c\u6027\u80fd\u74f6\u9888\u5728\u4e8e\u5e26\u5bbd\u800c\u975e\u8ba1\u7b97\u3002\u4f7f\u7528 <code>float4</code> \u5e76\u6ca1\u6709\u6539\u53d8\u603b\u7684\u6570\u636e\u4f20\u8f93\u91cf\uff0c\u4f46\u5b83\u901a\u8fc7\u5411\u91cf\u5316\u6307\u4ee4\u5927\u5e45\u51cf\u5c11\u4e86 SM \u9700\u8981\u53d1\u5c04\u7684\u6307\u4ee4\u603b\u6570\uff08\u51cf\u5c11\u4e86 Load/Store \u6307\u4ee4\u6570\u548c\u5faa\u73af\u5f00\u9500\uff09\u3002\u6839\u636e <code>\u541e\u5410\u7387 = \u6307\u4ee4\u6570 / \u65f6\u95f4</code>\uff0c\u5728\u65f6\u95f4\u4e0d\u53d8\u7684\u60c5\u51b5\u4e0b\uff0c\u6307\u4ee4\u6570\u51cf\u5c11\u5bfc\u81f4\u4e86 Compute Throughput \u4e0b\u964d\u3002\u8fd9\u5b9e\u9645\u4e0a\u610f\u5473\u7740\u6307\u4ee4\u6548\u7387\u7684\u63d0\u5347\u3002</p> </li> <li> <p>\u5173\u4e8e Memory \u4e0a\u5347\uff1a <code>float4</code> \u751f\u6210\u4e86\u66f4\u5bbd\u7684\u5185\u5b58\u4e8b\u52a1\uff08Memory Transactions\uff09\uff0c\u51cf\u5c11\u4e86 LSU\uff08Load Store Unit\uff09\u5904\u7406\u8bf7\u6c42\u7684\u5f00\u9500\uff0c\u5e76\u51cf\u5c11\u4e86\u6307\u4ee4\u53d1\u5c04\u5e26\u6765\u7684\u5ef6\u8fdf\u6c14\u6ce1\uff0c\u4ece\u800c\u80fd\u66f4\u7d27\u5bc6\u5730\u586b\u6ee1\u663e\u5b58\u5e26\u5bbd\uff0c\u56e0\u6b64 Memory Utilization \u4e0d\u964d\u53cd\u5347\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#optimization-v2-fp16","title":"Optimization V2 -- fp16","text":"","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_6","title":"\u4f18\u5316","text":"<ul> <li>FP16 \u8ba1\u7b97\u4f7f\u7528 CUDA Core \u4f1a\u6bd4 FP32 \u5feb\u8fd1 2 \u500d</li> </ul> C++<pre><code>// FP16\n// ElementWise Add grid(N/256),\n// block(256) a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)\n__global__ void elementwise_add_f16_kernel(half *a, half *b, half *c, int N) {\n\u00a0 int idx = blockIdx.x * blockDim.x + threadIdx.x;\n\u00a0 if (idx &lt; N)\n\u00a0 \u00a0 c[idx] = __hadd(a[idx], b[idx]);\n}\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_7","title":"\u7ed3\u679c","text":"<ul> <li>Memory Throughput \u4e0b\u964d (80%\u219247%)</li> <li>\u6267\u884c\u65f6\u95f4\u51cf\u5c11\uff0815.97\u03bcs -&gt; 13.38\u03bcs\uff09</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_8","title":"\u5206\u6790","text":"<p>\u4f20\u8f93\u7684\u6570\u636e\u91cf\u51cf\u534a\uff0c\u7406\u8bba\u4e0a\u65f6\u95f4\u5e94\u8be5\u4ece 15.97 \u53d8\u6210 8.0 \u5de6\u53f3\u624d\u5bf9\uff0c\u4e3a\u4ec0\u4e48\u53ea\u5230\u4e86 13.38 \uff1f</p> <p>\u5355\u6b21\u642c\u8fd0\u7c92\u5ea6\u53d8\u5c0f\u4e86\uff0c\u5bfc\u81f4\u603b\u7ebf\u5229\u7528\u7387\u4f4e\u3002</p> <ul> <li> <p>FP32 + float4 (Baseline):</p> </li> <li> <p>\u6bcf\u4e2a\u7ebf\u7a0b\u4e00\u6761\u6307\u4ee4\u642c\u8fd0\uff1a\\(4 \\\\times 4 \\\\text{ Bytes} = \\\\mathbf{16 \\\\text{ Bytes}}\\)\u3002</p> </li> <li> <p>FP16 (Current):</p> </li> <li> <p>\u6bcf\u4e2a\u7ebf\u7a0b\u4e00\u6761\u6307\u4ee4\u642c\u8fd0\uff1a\\(\\\\mathbf{2 \\\\text{ Bytes}}\\)\u3002\u5355\u6b21\u8bf7\u6c42\u592a\u5c0f\u4e86\u3002</p> </li> <li>\u540e\u679c\uff1a<ol> <li>LSU \u62e5\u5835\uff1a \u53d1\u5c04\u6307\u4ee4\u7684\u9891\u7387\u592a\u9ad8\uff0cLSU \u5904\u7406\u4e0d\u8fc7\u6765\u3002</li> <li>Sector \u6d6a\u8d39\uff1a \u663e\u5b58\u4f20\u8f93\u6700\u5c0f\u5355\u4f4d\u662f 32 Bytes\u3002\u5982\u679c\u4f60\u6ca1\u505a\u597d\u5408\u5e76\u8bbf\u95ee\uff08Coalescing\uff09\uff0c\u6bcf\u6b21\u4e3a\u4e86\u62ff 2 Bytes \u90fd\u8981\u52a8\u7528 32 Bytes \u7684\u5e26\u5bbd\uff0c\u6709\u6548\u5e26\u5bbd\uff08Effective Bandwidth\uff09 \u5c31\u4f1a\u5f88\u4f4e\u3002</li> </ol> </li> </ul> <p>\u6240\u4ee5\uff0c\u6211\u4eec\u9700\u8981\u4e00\u6b21\u642c\u8fd0\u66f4\u591a\u6570\u636e</p>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#optimization-v3-fp16-8","title":"Optimization V3 -- fp16 * 8","text":"","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_9","title":"\u4f18\u5316","text":"<ul> <li>\u4e00\u6b21\u53d6 \\(\\\\mathbf{16 \\\\text{ Bytes}}\\) \u6570\u636e</li> </ul> C++<pre><code>__global__ void elementwise_add_f16x8_kernel(const half *a, const half *b, half *c, int n) {\n\u00a0 int idx = (blockIdx.x * blockDim.x + threadIdx.x) * 8;\n\u00a0 if (idx &lt; n) {\n\u00a0 \u00a0 float4 a4 = reinterpret_cast&lt;const float4 *&gt;(a)[idx / 8];\n\u00a0 \u00a0 float4 b4 = reinterpret_cast&lt;const float4 *&gt;(b)[idx / 8];\n\u00a0 \u00a0 float4 c4;\n\u00a0 \u00a0 half2 *a2 = reinterpret_cast&lt;half2 *&gt;(&amp;a4);\n\u00a0 \u00a0 half2 *b2 = reinterpret_cast&lt;half2 *&gt;(&amp;b4);\n\u00a0 \u00a0 half2 *c2 = reinterpret_cast&lt;half2 *&gt;(&amp;c4);\n\u00a0 \u00a0 c2[0] = __hadd2(a2[0], b2[0]);\n\u00a0 \u00a0 c2[1] = __hadd2(a2[1], b2[1]);\n\u00a0 \u00a0 c2[2] = __hadd2(a2[2], b2[2]);\n\u00a0 \u00a0 c2[3] = __hadd2(a2[3], b2[3]);\n\u00a0 \u00a0 reinterpret_cast&lt;float4 *&gt;(c)[idx / 8] = c4;\n\u00a0 }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_10","title":"\u7ed3\u679c","text":"<ul> <li>Memory Throughput \u4e0a\u5347\uff0c\u8fbe\u5230 66%</li> <li>\u6267\u884c\u65f6\u95f4\u51cf\u5c11\uff0813.38\u03bcs -&gt; 8.96\u03bcs\uff09</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_11","title":"\u5206\u6790","text":"<ul> <li>\u6570\u636e\u91cf\uff1a \\(1M \\\\text{ elements} \\\\times 3 \\\\text{ arrays} \\\\times 2 \\\\text{ Bytes} = \\\\mathbf{6 \\\\text{ MB}}\\)\u3002</li> <li>\u8017\u65f6\uff1a \\(8.96 \\\\mu s\\)\u3002</li> <li>\u7406\u8bba\u6709\u6548\u5e26\u5bbd\uff1a \\(\\(\\\\frac{6 \\\\text{ MB}}{8.96 \\\\mu s} = 0.669 \\\\text{ TB/s} \\\\approx \\\\mathbf{670 \\\\text{ GB/s}}\\)\\)</li> <li>\u5229\u7528\u7387\uff1a \\(670 / 912 \\\\approx \\\\mathbf{73%}\\)\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#fp32-4-memory-throughput","title":"\u4e3a\u4ec0\u4e48\u6ca1\u6709\u8fbe\u5230 FP32 * 4 \u7684 Memory Throughput \u5462\uff1f","text":"<p>\u731c\u60f3</p> <ul> <li>\u7269\u7406\u89c4\u5f8b\uff1a \u5185\u5b58\u63a7\u5236\u5668\u4ece\u6536\u5230\u8bf7\u6c42\u5230\u6570\u636e\u771f\u6b63\u5360\u6ee1\u603b\u7ebf\uff0c\u6709\u4e00\u6bb5\u56fa\u5b9a\u7684\u7269\u7406\u5ef6\u8fdf (Latency)\u3002</li> <li>FP32 \u573a\u666f:</li> <li>\u603b\u642c\u8fd0\u91cf 12MB\u3002</li> <li>\u8017\u65f6 ~16\u03bcs\u3002</li> <li>\u8fd9\u4e2a\u65f6\u95f4\u8db3\u591f\u957f\uff0c\u8ba9\u603b\u7ebf\u5728\u5927\u90e8\u5206\u65f6\u95f4\u91cc\u5904\u4e8e\u201c\u6ee1\u8f7d\u201d\u72b6\u6001\uff0c\u4ece\u800c\u62c9\u9ad8\u4e86\u5e73\u5747\u5e26\u5bbd\u3002</li> <li>FP16 \u573a\u666f:</li> <li>\u603b\u642c\u8fd0\u91cf 6MB\u3002</li> <li>\u8017\u65f6 8.96\u03bcs\u3002</li> <li>\u7ed3\u679c\uff1a Nsight Compute \u7edf\u8ba1\u7684\u662f\u6574\u4e2a\u751f\u547d\u5468\u671f\u7684\u5e73\u5747\u5e26\u5bbd\u3002\u56e0\u4e3a\u201c\u6ee1\u8f7d\u201d\u7684\u65f6\u95f4\u6bb5\u53d8\u77ed\u4e86\uff0c\u56fa\u5b9a\u7684\u201c\u5ef6\u8fdf\u201d\u65f6\u95f4\u6bb5\u5360\u6bd4\u53d8\u5927\u4e86\uff0c\u5bfc\u81f4\u5e73\u5747\u5e26\u5bbd\u88ab\u62c9\u4f4e\u4e86\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_12","title":"\u9a8c\u8bc1","text":"<p>\u9a8c\u8bc1 10 M \u7684 vector add\uff0c\u7ed3\u679c\uff1a</p> <ul> <li>\u4e0d\u7ba1\u662f fp32 _ 4 \u8fd8\u662f fp16 _ 8\uff0cMemory Throughput \u90fd\u6709\u660e\u663e\u589e\u52a0\uff0c\u8bf4\u660e\u6211\u4eec\u7684\u731c\u60f3\u57fa\u672c\u6b63\u786e</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#summary","title":"Summary","text":"<p>vector add \u7b97\u5b50\u662f\u4e00\u4e2a\u5178\u578b\u7684 memory-bound \u7684\u7b97\u5b50\uff0c\u6211\u4eec\u9700\u8981\u5c3d\u53ef\u80fd\u8282\u7701\u5185\u5b58\u5e26\u5bbd\u5e76\u63d0\u9ad8\u8ba1\u7b97\u6548\u7387\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u4f7f\u7528 benchmark \u6d4b\u8bd5\u6240\u6709\u7b97\u5b50\u7684\u5f00\u9500\uff0c\u5206\u6790\u4ea7\u751f\u8fd9\u79cd\u7ed3\u679c\u7684\u539f\u56e0</p> <p></p>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#latency-bound","title":"\u9636\u6bb5\u4e00\uff1a\u5c0f\u6570\u636e\u91cf\u533a\u95f4 (Latency Bound / \u542f\u52a8\u5f00\u9500\u4e3b\u5bfc)","text":"<ul> <li> <p>\u6570\u636e\uff1a S=256, K=256</p> </li> <li> <p>\u73b0\u8c61 1\uff1a</p> </li> <li> <p>PyTorch (<code>f32_th</code>): 0.0116 ms</p> </li> <li> <p>Your Kernel (<code>f32x4</code>): 0.0080 ms (\u5feb\u4e86 ~30%)</p> </li> <li> <p>\u539f\u56e0\uff1a</p> </li> <li> <p>\u901a\u7528\u6027 vs \u4e13\u7528\u6027 (Generality vs Specialization)\uff1a</p> <ul> <li>PyTorch: \u4e3a\u4e86\u901a\u7528\u6027\uff0cPyTorch \u7684 Element-wise \u7b97\u5b50\uff08<code>TensorIterator</code>\uff09\u5fc5\u987b\u5904\u7406\u5404\u79cd\u590d\u6742\u60c5\u51b5\uff1a\u975e\u8fde\u7eed\u5185\u5b58\uff08Strided Memory\uff09\u3001\u5e7f\u64ad\uff08Broadcasting\uff09\u3001\u7c7b\u578b\u8f6c\u6362\uff08Type Casting\uff09\u3002\u5373\u4fbf\u6570\u636e\u662f\u8fde\u7eed\u7684\uff0c\u5b83\u5185\u90e8\u7684\u7d22\u5f15\u8ba1\u7b97\u903b\u8f91\u4e5f\u6bd4\u4f60\u590d\u6742\u7684\u7d22\u5f15\u8ba1\u7b97\u66f4\u91cd\uff0c\u6d88\u8017\u66f4\u591a\u5bc4\u5b58\u5668\u548c\u6307\u4ee4\u3002</li> <li>f32x4 Kernel: \u5047\u8bbe\u4e86\u6570\u636e\u7edd\u5bf9\u8fde\u7eed\u3001\u65e0\u5e7f\u64ad\u3002\u3002</li> </ul> </li> <li> <p>\u542f\u52a8\u914d\u7f6e (Launch Heuristics)\uff1a</p> <ul> <li>PyTorch \u6709\u4e00\u5957\u901a\u7528\u7684 Block/Grid \u8ba1\u7b97\u516c\u5f0f\u3002\u5bf9\u4e8e\u6781\u5c0f\u5f62\u72b6\uff0c\u5b83\u7684\u914d\u7f6e\u53ef\u80fd\u4e0d\u662f\u9488\u5bf9\u5f53\u524d GPU \u6700\u4f18\u7684\u3002\u800c\u4f60\u662f\u9488\u5bf9\u6027\u8c03\u4f18\u7684\u3002</li> </ul> </li> <li> <p>\u73b0\u8c61 2\uff1a</p> </li> </ul> \u5185\u6838\u7248\u672c \u6267\u884c\u65f6\u95f4 (ms) <code>out_f32x4</code> 0.0079 <code>out_f16x8</code> 0.0063 <ul> <li>\u539f\u56e0\uff1a</li> <li>FP16 \u4f20\u8f93\u6570\u636e\u66f4\u5c11\uff0c\u8bfb\u5199\u8fd9\u51e0\u767e KB \u6570\u636e\u7684\u5e8f\u5217\u5316\u5ef6\u8fdf\uff08Serialization Delay\uff09 \u5dee\u5f02\u6b63\u597d\u5c31\u5728\u5fae\u79d2\u7ea7\u522b<ul> <li>FP32x4: \u9700\u8981\u642c\u8fd0 \\(65536 \\\\times 4 \\\\text{B} \\\\times 3 \\\\approx \\\\mathbf{786 \\\\text{ KB}}\\)\u3002</li> <li>FP16x8: \u9700\u8981\u642c\u8fd0 \\(65536 \\\\times 2 \\\\text{B} \\\\times 3 \\\\approx \\\\mathbf{393 \\\\text{ KB}}\\)\u3002</li> </ul> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_13","title":"\u9636\u6bb5\u4e8c\uff1a\u4e2d\u7b49\u6570\u636e\u91cf\u533a\u95f4","text":"<p>\u5173\u6ce8\u70b9\uff1a \\(S=1024, K=1024\\) \u5de6\u53f3\u3002</p> <ul> <li> <p>\u73b0\u8c61\uff1a</p> </li> <li> <p>FP32 \u7684\u65f6\u95f4\u5f00\u59cb\u663e\u8457\u589e\u52a0\uff080.017ms\uff09\u3002</p> </li> <li> <p>FP16 \u7684\u65f6\u95f4\u7ea6\u4e3a FP32 \u7684\u4e00\u534a\u751a\u81f3\u66f4\u5c11\uff080.006ms - 0.011ms\uff09\u3002</p> </li> <li> <p>\u539f\u56e0\uff1a</p> </li> <li> <p>\u6570\u636e\u91cf\u5f00\u59cb\u5927\u5230\u8db3\u4ee5\u63a9\u76d6\u542f\u52a8\u5f00\u9500\u3002</p> </li> <li>\u6b64\u65f6 Memory Bound (\u5e26\u5bbd\u9650\u5236) \u7684\u7279\u5f81\u5f00\u59cb\u663e\u73b0\uff0cFP16 \u56e0\u4e3a\u6570\u636e\u91cf\u51cf\u534a\uff0c\u4f18\u52bf\u5f00\u59cb\u6269\u5927\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#bandwidth-bound","title":"\u9636\u6bb5\u4e09\uff1a\u5927\u6570\u636e\u91cf\u533a\u95f4 (Bandwidth Bound)","text":"<p>\u5173\u6ce8\u70b9\uff1a \\(S=4096, K=4096\\) (\u6700\u5927\u89c4\u6a21)\u3002</p> <ul> <li>\u73b0\u8c61\uff1a 2 \u500d\u7ebf\u6027\u52a0\u901f (FP32 vs FP16)</li> </ul> \u5185\u6838\u7248\u672c \u6267\u884c\u65f6\u95f4 (ms) \u5206\u6790 <code>out_f32x4</code> 0.240 \u5411\u91cf\u5316\u52a0\u8f7d <code>out_f16x8</code> 0.122 \u5411\u91cf\u5316\u52a0\u8f7d <ul> <li>\u539f\u56e0\uff1a \u8fd9\u8bc1\u660e\u4e86\u8fd9\u662f\u5f7b\u5e95\u7684 Memory Bound \u573a\u666f\u3002FP16 \u7684\u6570\u636e\u91cf\u662f 16-bit\uff0cFP32 \u662f 32-bit\u3002\u8ba1\u7b97\u5355\u5143\uff08ALU\uff09\u5728\u8fd9\u91cc\u5b8c\u5168\u662f\u5728\u7b49\u6570\u636e\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/Vector%20Add%20Optimization%20Example/#_14","title":"\u9644\u5f55","text":"Bash<pre><code>-------------------------------------------------------------------------------------\n                                        S=256, K=256\n         out_f32x4: [1.97265029, -1.30800462], time:0.00798702ms\n        out_f32_th: [1.97265029, -1.30800462], time:0.01163483ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [1.97265625, -1.30859375], time:0.00634193ms\n        out_f16_th: [1.97265625, -1.30859375], time:0.01137257ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=256, K=512\n         out_f32x4: [-0.01563577, -0.42283049], time:0.00610352ms\n        out_f32_th: [-0.01563577, -0.42283049], time:0.01132488ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-0.015625, -0.42285156], time:0.00598431ms\n        out_f16_th: [-0.015625, -0.42285156], time:0.01120567ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=256, K=1024\n         out_f32x4: [-1.84007502, 0.55290109], time:0.00596046ms\n        out_f32_th: [-1.84007502, 0.55290109], time:0.01132488ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-1.83984375, 0.55273438], time:0.00605583ms\n        out_f16_th: [-1.83984375, 0.55273438], time:0.01125336ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=256, K=2048\n         out_f32x4: [1.10615909, 1.60974789], time:0.00636578ms\n        out_f32_th: [1.10615909, 1.60974789], time:0.01173019ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [1.10644531, 1.609375], time:0.00603199ms\n        out_f16_th: [1.10644531, 1.609375], time:0.01103878ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=256, K=4096\n         out_f32x4: [2.09329867, 1.75160038], time:0.01795292ms\n        out_f32_th: [2.09329867, 1.75160038], time:0.01842976ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [2.09375, 1.75195312], time:0.00665188ms\n        out_f16_th: [2.09375, 1.75195312], time:0.01180172ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=512, K=256\n         out_f32x4: [2.45374489, 0.12144065], time:0.00607967ms\n        out_f32_th: [2.45374489, 0.12144065], time:0.01118183ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [2.453125, 0.12158203], time:0.00586510ms\n        out_f16_th: [2.453125, 0.12158203], time:0.01101494ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=512, K=512\n         out_f32x4: [-0.09491166, -1.25630379], time:0.00629425ms\n        out_f32_th: [-0.09491166, -1.25630379], time:0.01106262ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-0.09472656, -1.25585938], time:0.00588894ms\n        out_f16_th: [-0.09472656, -1.25585938], time:0.01108646ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=512, K=1024\n         out_f32x4: [0.18375367, 0.85552824], time:0.00627041ms\n        out_f32_th: [0.18375367, 0.85552824], time:0.01142025ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [0.18408203, 0.85546875], time:0.00581741ms\n        out_f16_th: [0.18408203, 0.85546875], time:0.01120567ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=512, K=2048\n         out_f32x4: [-0.19396098, 1.58398294], time:0.01785755ms\n        out_f32_th: [-0.19396098, 1.58398294], time:0.01859665ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-0.19384766, 1.58398438], time:0.00648499ms\n        out_f16_th: [-0.19384766, 1.58398438], time:0.01170635ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=512, K=4096\n         out_f32x4: [-2.16418219, -0.03980557], time:0.03359318ms\n        out_f32_th: [-2.16418219, -0.03980557], time:0.03430843ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-2.1640625, -0.03979492], time:0.01790524ms\n        out_f16_th: [-2.1640625, -0.03979492], time:0.01864433ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=1024, K=256\n         out_f32x4: [0.90988386, 0.60685712], time:0.00605583ms\n        out_f32_th: [0.90988386, 0.60685712], time:0.01113415ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [0.91015625, 0.60644531], time:0.00584126ms\n        out_f16_th: [0.91015625, 0.60644531], time:0.01084805ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=1024, K=512\n         out_f32x4: [-0.33057773, 1.10878396], time:0.00631809ms\n        out_f32_th: [-0.33057773, 1.10878396], time:0.01146793ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-0.33056641, 1.10839844], time:0.00598431ms\n        out_f16_th: [-0.33056641, 1.10839844], time:0.01108646ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=1024, K=1024\n         out_f32x4: [1.78476286, 2.11524606], time:0.01773834ms\n        out_f32_th: [1.78476286, 2.11524606], time:0.01845360ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [1.78515625, 2.11523438], time:0.00653267ms\n        out_f16_th: [1.78515625, 2.11523438], time:0.01168251ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=1024, K=2048\n         out_f32x4: [-0.7581079, 2.17606115], time:0.03349781ms\n        out_f32_th: [-0.7581079, 2.17606115], time:0.03435612ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-0.7578125, 2.17578125], time:0.01788139ms\n        out_f16_th: [-0.7578125, 2.17578125], time:0.01869202ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=1024, K=4096\n         out_f32x4: [-1.73245358, 0.14577931], time:0.06384850ms\n        out_f32_th: [-1.73245358, 0.14577931], time:0.06377697ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-1.73242188, 0.14550781], time:0.03356934ms\n        out_f16_th: [-1.73242188, 0.14550781], time:0.03452301ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=2048, K=256\n         out_f32x4: [-0.57417279, -2.21091771], time:0.00746250ms\n        out_f32_th: [-0.57417279, -2.21091771], time:0.01170635ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-0.57470703, -2.2109375], time:0.00593662ms\n        out_f16_th: [-0.57470703, -2.2109375], time:0.01111031ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=2048, K=512\n         out_f32x4: [-1.0632087, -1.56113195], time:0.01783371ms\n        out_f32_th: [-1.0632087, -1.56113195], time:0.01852512ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-1.06347656, -1.56054688], time:0.00619888ms\n        out_f16_th: [-1.06347656, -1.56054688], time:0.01146793ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=2048, K=1024\n         out_f32x4: [1.92093897, 1.09060407], time:0.03349781ms\n        out_f32_th: [1.92093897, 1.09060407], time:0.03435612ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [1.92089844, 1.09082031], time:0.01776218ms\n        out_f16_th: [1.92089844, 1.09082031], time:0.01859665ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=2048, K=2048\n         out_f32x4: [1.64275861, -0.26722771], time:0.06289482ms\n        out_f32_th: [1.64275861, -0.26722771], time:0.06389618ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [1.64257812, -0.26708984], time:0.03345013ms\n        out_f16_th: [1.64257812, -0.26708984], time:0.03454685ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=2048, K=4096\n         out_f32x4: [-1.02567387, -0.87697959], time:0.12266636ms\n        out_f32_th: [-1.02567387, -0.87697959], time:0.12316704ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-1.02539062, -0.87695312], time:0.06325245ms\n        out_f16_th: [-1.02539062, -0.87695312], time:0.06403923ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=4096, K=256\n         out_f32x4: [-0.12928185, 1.02175057], time:0.01778603ms\n        out_f32_th: [-0.12928185, 1.02175057], time:0.01845360ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [-0.12915039, 1.02148438], time:0.00731945ms\n        out_f16_th: [-0.12915039, 1.02148438], time:0.01139641ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=4096, K=512\n         out_f32x4: [0.10359669, 1.60598481], time:0.03335476ms\n        out_f32_th: [0.10359669, 1.60598481], time:0.03447533ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [0.10351562, 1.60546875], time:0.01790524ms\n        out_f16_th: [0.10351562, 1.60546875], time:0.01866817ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=4096, K=1024\n         out_f32x4: [0.50812161, 2.05591512], time:0.06299019ms\n        out_f32_th: [0.50812161, 2.05591512], time:0.06392002ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [0.5078125, 2.0546875], time:0.03347397ms\n        out_f16_th: [0.5078125, 2.0546875], time:0.03452301ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=4096, K=2048\n         out_f32x4: [0.44834208, -2.61600804], time:0.12195110ms\n        out_f32_th: [0.44834208, -2.61600804], time:0.12311935ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [0.44824219, -2.6171875], time:0.06358624ms\n        out_f16_th: [0.44824219, -2.6171875], time:0.06401539ms\n-------------------------------------------------------------------------------------\n-------------------------------------------------------------------------------------\n                                        S=4096, K=4096\n         out_f32x4: [0.87607241, -2.12679267], time:0.24068356ms\n        out_f32_th: [0.87607241, -2.12679267], time:0.24130344ms\n-------------------------------------------------------------------------------------\n         out_f16x8: [0.87597656, -2.12695312], time:0.12204647ms\n        out_f16_th: [0.87597656, -2.12695312], time:0.12366772ms\n-------------------------------------------------------------------------------------\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/cudaopt/","title":"CUDA Optimization for LLM Inference","text":"2025-12-022025-12-13 <code>#CUDA</code>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#cuda-optimization-for-llm-inference","title":"CUDA Optimization for LLM Inference","text":"<p> \u7ea6 6647 \u4e2a\u5b57  14 \u884c\u4ee3\u7801  15 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 33 \u5206\u949f</p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#overview","title":"Overview","text":"<p>\u5728\u5927\u89c4\u6a21\u8bed\u8a00\u6a21\u578b\uff08LLM\uff09\u63a8\u7406\u4e2d\uff0c\u4f18\u5316 CUDA \u4ee3\u7801\u5bf9\u4e8e\u63d0\u5347\u6027\u80fd\u548c\u6548\u7387\u81f3\u5173\u91cd\u8981\u3002\u672c\u6587\u6863\u4ecb\u7ecd\u4e86\u4e00\u4e9b\u5173\u952e\u7684 CUDA \u4f18\u5316\u6280\u672f\uff0c\u5e2e\u52a9\u5f00\u53d1\u8005\u66f4\u597d\u5730\u5229\u7528 GPU \u8d44\u6e90\u8fdb\u884c LLM \u63a8\u7406\u3002\u8fd9\u91cc\u6211\u4eec\u5c06\u4ecb\u7ecd Transformer-based \u81ea\u56de\u5f52\u9884\u8bad\u7ec3\u6a21\u578b\u63a8\u7406\u7528\u5230\u7684\u7b97\u5b50\u7684\u4f18\u5316\u65b9\u6cd5\u3002\u8fd9\u4e9b\u4f18\u5316\u7684\u65b9\u6cd5\u4e5f\u9002\u7528\u4e8e\u5176\u4ed6\u7b97\u5b50\u3002</p> <p>\u6211\u4eec\u4e3b\u8981\u5173\u6ce8\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>GPU \u786c\u4ef6\u67b6\u6784(Hirerarchy Memory, SM, Warp \u7b49)</li> <li>CUDA \u8ba1\u7b97\u6a21\u578b(Thread, Thread Block, Grid \u7b49)</li> <li>CUDA Kernel \u6027\u80fd\u8c03\u4f18(Nsight Compute, Occupancy)</li> <li>CUDA \u5e38\u7528\u4f18\u5316\u6280\u5de7(Double buffering, Memory Coalescing, Overcoming Bank Conflict \u7b49)</li> <li>Transformer \u5185\u90e8\u7b97\u5b50\u4f18\u5316    - Matrix Multiplication \u4f18\u5316    - Softmax \u4f18\u5316    - LayerNorm \u4f18\u5316    - Self-Attention \u4f18\u5316    - Flash Attention \u4f18\u5316</li> </ol>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#gpu","title":"GPU \u786c\u4ef6\u67b6\u6784","text":"<p>GPU \u4ee5 Throughput \u4e3a\u8bbe\u8ba1\u76ee\u6807\uff0c\u548c CPU \u6709\u5f88\u5927\u7684\u4e0d\u540c\u3002</p> <ul> <li>GPU \u4e2d\u867d\u6709\u7f13\u5b58\u7ed3\u6784\u4f46\u662f\u6570\u91cf\u5c11\u3002 \u56e0\u4e3a\u8981\u51cf\u5c11\u6307\u4ee4\u8bbf\u95ee\u7f13\u5b58\u7684\u6b21\u6570\u3002</li> <li>GPU \u4e2d\u63a7\u5236\u5355\u5143\u975e\u5e38\u7b80\u5355\u3002 \u63a7\u5236\u5355\u5143\u4e2d\u6ca1\u6709\u5206\u652f\u9884\u6d4b\u673a\u5236\u548c\u6570\u636e\u8f6c\u53d1\u673a\u5236\uff0c\u5bf9\u4e8e\u590d\u6742\u7684\u6307\u4ee4\u8fd0\u7b97\u5c31\u4f1a\u6bd4\u8f83\u6162\u3002</li> <li>GPU \u7684\u8fd0\u7b97\u5355\u5143 (Core) \u975e\u5e38\u591a\uff0c\u91c7\u7528\u957f\u5ef6\u65f6\u6d41\u6c34\u7ebf\u4ee5\u5b9e\u73b0\u9ad8\u541e\u5410\u91cf\u3002 \u6bcf\u4e00\u884c\u7684\u8fd0\u7b97\u5355\u5143\u7684\u63a7\u5236\u5668\u53ea\u6709\u4e00\u4e2a\uff0c\u610f\u5473\u7740\u6bcf\u4e00\u884c\u7684\u8fd0\u7b97\u5355\u5143\u4f7f\u7528\u7684\u6307\u4ee4\u662f\u76f8\u540c\u7684\uff0c\u4e0d\u540c\u7684\u662f\u5b83\u4eec\u7684\u6570\u636e\u5185\u5bb9\u3002\u90a3\u4e48\u8fd9\u79cd\u6574\u9f50\u5212\u4e00\u7684\u8fd0\u7b97\u65b9\u5f0f\u4f7f\u5f97 GPU \u5bf9\u4e8e\u90a3\u4e9b\u63a7\u5236\u7b80\u5355\u4f46\u8fd0\u7b97\u9ad8\u6548\u7684\u6307\u4ee4\u7684\u6548\u7387\u663e\u8457\u589e\u52a0\u3002[^cuda1]</li> </ul> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#streaming-multiprocessor-sm-based-on-h100-hopper-architecture","title":"Streaming Multiprocessor (SM) (Based on H100 Hopper Architecture)","text":"<p>NVIDIA H100 GPU \u57fa\u4e8e Hopper \u67b6\u6784\uff0c\u5176 SM \u8bbe\u8ba1\u4e3a\u4e86\u6781\u81f4\u7684 AI \u548c HPC \u6027\u80fd\u8fdb\u884c\u4e86\u91cd\u5927\u5347\u7ea7\u3002\u4e00\u4e2a H100 SM \u5305\u542b\u4ee5\u4e0b\u6838\u5fc3\u7ec4\u4ef6\uff1a</p> <ul> <li> <p>4 \u4e2a\u5904\u7406\u5757 (SMSP - SM Sub-Partitions):</p> </li> <li> <p>\u67b6\u6784\u8bbe\u8ba1: \u4e3a\u4e86\u63d0\u9ad8\u6307\u4ee4\u6d41\u6c34\u7ebf\u7684\u5e76\u884c\u5ea6\u548c\u8d44\u6e90\u5229\u7528\u7387\uff0c\u6bcf\u4e2a SM \u88ab\u7269\u7406\u5212\u5206\u4e3a 4 \u4e2a\u72ec\u7acb\u7684\u5904\u7406\u5757\uff08SMSP\uff09\u3002</p> </li> <li>\u8d44\u6e90\u9694\u79bb: \u6bcf\u4e2a SMSP \u62e5\u6709\u81ea\u5df1\u72ec\u7acb\u7684\u6307\u4ee4\u8c03\u5ea6\u5668\u3001\u5bc4\u5b58\u5668\u6587\u4ef6\u548c\u8ba1\u7b97\u5355\u5143\u3002\u8fd9\u610f\u5473\u7740\u5b83\u4eec\u53ef\u4ee5\u72ec\u7acb\u5730\u8c03\u5ea6\u548c\u6267\u884c Warp\uff0c\u4e92\u4e0d\u5e72\u6270\u3002</li> <li> <p>\u7ec4\u4ef6\u8be6\u60c5:</p> <ul> <li>Warp Scheduler &amp; Dispatch Unit: \u6bcf\u4e2a SMSP \u6709\u4e00\u4e2a Warp \u8c03\u5ea6\u5668\u3002\u5b83\u8d1f\u8d23\u4ece\u5206\u914d\u7ed9\u8be5 SMSP \u7684 Warp \u6c60\u4e2d\u9009\u62e9\u4e00\u4e2a Ready \u7684 Warp\uff0c\u5e76\u5c06\u5176\u4e0b\u4e00\u6761\u6307\u4ee4\u5206\u53d1\u5230\u6267\u884c\u5355\u5143\u3002\u8fd9\u662f GPU \u5ef6\u8fdf\u63a9\u76d6\u673a\u5236\u7684\u6838\u5fc3\u3002</li> <li>Register File: \u6bcf\u4e2a SMSP \u914d\u5907 64K \u4e2a 32-bit \u5bc4\u5b58\u5668\uff08\u6574\u4e2a SM \u5171 256K\uff09\u3002\u5bc4\u5b58\u5668\u662f GPU \u4e0a\u901f\u5ea6\u6700\u5feb\u7684\u5b58\u50a8\uff0c\u7528\u4e8e\u4fdd\u5b58\u7ebf\u7a0b\u7684\u79c1\u6709\u53d8\u91cf\u3002\u5de8\u5927\u7684\u5bc4\u5b58\u5668\u6587\u4ef6\u652f\u6301\u4e86\u9ad8\u5e76\u53d1\u7ebf\u7a0b\u6570\uff08Occupancy\uff09\u3002</li> <li>L0 Instruction Cache: \u7f13\u5b58\u6307\u4ee4\uff0c\u51cf\u5c11\u53d6\u6307\u5ef6\u8fdf\u3002</li> <li>Math Units (\u8ba1\u7b97\u5355\u5143):</li> <li>32 FP32 Cores (CUDA Cores): \u8d1f\u8d23\u6807\u51c6\u7684\u5355\u7cbe\u5ea6\u6d6e\u70b9\u8fd0\u7b97\u3002</li> <li>16 INT32 Cores: \u8d1f\u8d23\u6574\u6570\u8fd0\u7b97\uff0c\u901a\u5e38\u7528\u4e8e\u5730\u5740\u8ba1\u7b97\u3001\u5faa\u73af\u63a7\u5236\u7b49\u3002Hopper \u67b6\u6784\u5141\u8bb8 FP32 \u548c INT32 \u6307\u4ee4\u5e76\u53d1\u6267\u884c\uff0c\u63d0\u9ad8\u4e86\u6d41\u6c34\u7ebf\u6548\u7387\u3002</li> <li>16 FP64 Cores: \u53cc\u7cbe\u5ea6\u6d6e\u70b9\u5355\u5143\u3002H100 \u7684 FP64 \u6027\u80fd\u662f A100 \u7684 3 \u500d\uff0c\u8fd9\u5bf9\u79d1\u5b66\u8ba1\u7b97\uff08HPC\uff09\u81f3\u5173\u91cd\u8981\u3002</li> <li>1 4<sup>th</sup> Gen Tensor Core: \u8fd9\u662f AI \u63a8\u7406\u548c\u8bad\u7ec3\u7684\u52a8\u529b\u6e90\u3002<ul> <li>\u591a\u7cbe\u5ea6\u652f\u6301: \u652f\u6301 FP8, FP16, BF16, TF32, FP64\u3002FP8 \u662f Hopper \u7684\u4e00\u5927\u4eae\u70b9\uff0c\u541e\u5410\u91cf\u662f FP16 \u7684\u4e24\u500d\u3002</li> <li>\u7a00\u758f\u6027 (Sparsity): \u652f\u6301\u7ed3\u6784\u5316\u7a00\u758f\uff08Structured Sparsity\uff09\uff0c\u53ef\u8fdb\u4e00\u6b65\u63d0\u5347 2 \u500d\u6027\u80fd\u3002</li> <li>\u5f02\u6b65\u6267\u884c: \u4e0e CUDA Cores \u5f02\u6b65\u6267\u884c\uff0c\u6781\u5927\u63d0\u5347\u4e86\u77e9\u9635\u8fd0\u7b97\u6548\u7387\u3002</li> </ul> </li> </ul> </li> <li> <p>Shared Memory / L1 Data Cache:</p> </li> <li> <p>\u7edf\u4e00\u67b6\u6784: H100 SM \u62e5\u6709 256 KB \u7684\u7edf\u4e00 L1/Shared Memory\uff08\u76f8\u6bd4 A100 \u7684 192 KB \u63d0\u5347\u4e86 33%\uff09\u3002\u8fd9\u5757\u5185\u5b58\u53ef\u4ee5\u6839\u636e\u9700\u8981\u88ab\u914d\u7f6e\u4e3a L1 \u7f13\u5b58\u6216 Shared Memory\u3002</p> </li> <li>\u9ad8\u5e26\u5bbd: \u5b83\u662f\u7247\u4e0a\u5185\u5b58\uff0c\u5e26\u5bbd\u6781\u9ad8\uff0c\u5ef6\u8fdf\u6781\u4f4e\uff0c\u662f\u7ebf\u7a0b\u5757\u5185\u6570\u636e\u4ea4\u6362\u7684\u6865\u6881\u3002</li> <li> <p>Distributed Shared Memory (DSMEM): \u8fd9\u662f Hopper \u5f15\u5165\u7684\u9769\u547d\u6027\u7279\u6027\u3002</p> <ul> <li>Thread Block Cluster: \u5141\u8bb8\u5c06\u591a\u4e2a Thread Block \u7ec4\u6210\u4e00\u4e2a Cluster\uff08\u4f8b\u5982 8 \u4e2a Block\uff09\u3002</li> <li>\u76f4\u63a5\u8bbf\u95ee: Cluster \u5185\u7684\u6240\u6709\u7ebf\u7a0b\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u5176\u4ed6 SM \u4e0a\u7684 Shared Memory\uff0c\u5c31\u50cf\u8bbf\u95ee\u672c\u5730 Shared Memory \u4e00\u6837\uff08\u867d\u7136\u5ef6\u8fdf\u7a0d\u9ad8\u4e00\u70b9\u70b9\uff09\u3002\u8fd9\u6253\u7834\u4e86\u4f20\u7edf CUDA \u7f16\u7a0b\u4e2d \"Shared Memory \u4ec5\u9650 Block \u5185\u5171\u4eab\" \u7684\u9650\u5236\uff0c\u4f7f\u5f97\u8de8 Block \u7684\u6570\u636e\u590d\u7528\u548c\u901a\u4fe1\u6210\u4e3a\u53ef\u80fd\u3002</li> </ul> </li> <li> <p>Tensor Memory Accelerator (TMA):</p> </li> <li> <p>\u5b9a\u4e49: \u4e00\u4e2a\u4e13\u7528\u7684\u786c\u4ef6\u76f4\u63a5\u5185\u5b58\u8bbf\u95ee (DMA) \u5f15\u64ce\u3002</p> </li> <li>\u529f\u80fd: \u8d1f\u8d23\u5728 Global Memory \u548c Shared Memory \u4e4b\u95f4\u9ad8\u6548\u3001\u5f02\u6b65\u5730\u642c\u8fd0\u6570\u636e\u3002</li> <li>\u4f18\u52bf:<ul> <li>\u89e3\u653e SM: \u4f20\u7edf\u7684\u6570\u636e\u52a0\u8f7d\u9700\u8981 CUDA Core \u6267\u884c Load \u6307\u4ee4\uff0c\u5360\u7528\u5bc4\u5b58\u5668\u548c ALU \u8d44\u6e90\u3002TMA \u63a5\u7ba1\u4e86\u8fd9\u9879\u5de5\u4f5c\uff0c\u8ba9 SM \u4e13\u6ce8\u4e8e\u8ba1\u7b97\u3002</li> <li>\u964d\u4f4e\u5bc4\u5b58\u5668\u538b\u529b: \u6570\u636e\u76f4\u63a5\u4ece Global Memory \u5199\u5165 Shared Memory\uff0c\u4e0d\u7ecf\u8fc7\u5bc4\u5b58\u5668\u6587\u4ef6\u3002</li> <li>\u7b80\u5316\u7f16\u7a0b: \u53ea\u9700\u8981\u914d\u7f6e\u597d Copy Descriptor\uff0cTMA \u5c31\u4f1a\u81ea\u52a8\u5904\u7406\u590d\u6742\u7684\u5730\u5740\u8ba1\u7b97\uff08\u5982\u77e9\u9635\u5757\u7684 stride \u8bbf\u95ee\uff09\u548c\u8d8a\u754c\u68c0\u67e5\u3002</li> <li>\u652f\u6301 mbarrier: \u4e0e\u5f02\u6b65\u5c4f\u969c (mbarrier) \u7ed3\u5408\uff0c\u5b9e\u73b0\u9ad8\u6548\u7684\u6d41\u6c34\u7ebf\u5e76\u884c\u3002</li> </ul> </li> </ul> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#functional-units-h100-specifics","title":"Functional Units (H100 Specifics)","text":"<p>H100 \u7684\u529f\u80fd\u5355\u5143\u8bbe\u8ba1\u65e8\u5728\u6700\u5927\u5316\u5e76\u53d1\u6027\u548c\u541e\u5410\u91cf\uff1a</p> <ul> <li>\u5e76\u53d1\u6d41\u6c34\u7ebf (Concurrent Pipelines):</li> <li>H100 \u7684 SM \u5305\u542b\u72ec\u7acb\u7684 FP32, INT32 \u548c FP64 \u6570\u636e\u8def\u5f84\u3002</li> <li>FP32 &amp; INT32 \u5e76\u53d1: \u5141\u8bb8\u5728\u540c\u4e00\u4e2a\u5468\u671f\u5185\u540c\u65f6\u53d1\u5c04 FP32 \u6307\u4ee4\u548c INT32 \u6307\u4ee4\u3002\u8fd9\u5bf9\u4e8e\u5faa\u73af\u7d22\u5f15\u66f4\u65b0\uff08INT32\uff09\u548c\u6838\u5fc3\u8ba1\u7b97\uff08FP32\uff09\u5e76\u884c\u6267\u884c\u975e\u5e38\u6709\u6548\u3002</li> <li>FP64 \u6027\u80fd: H100 \u7684 FP64 \u541e\u5410\u91cf\u662f FP32 \u7684 \u00bd\uff0c\u76f8\u6bd4 A100 \u5927\u5e45\u63d0\u5347\uff0c\u9002\u5408\u79d1\u5b66\u8ba1\u7b97\u3002</li> <li>Tensor Core (4<sup>th</sup> Gen):</li> <li>\u72ec\u7acb\u4e8e CUDA Cores \u7684\u4e13\u7528\u6d41\u6c34\u7ebf\u3002</li> <li>\u652f\u6301 \u5f02\u6b65\u6267\u884c\uff0c\u5373 Tensor Core \u5728\u8fdb\u884c\u77e9\u9635\u8fd0\u7b97\u65f6\uff0cCUDA Cores \u53ef\u4ee5\u540c\u65f6\u5904\u7406\u5176\u4ed6\u65e0\u5173\u6307\u4ee4\uff08\u5982\u5730\u5740\u8ba1\u7b97\u3001\u903b\u8f91\u5224\u65ad\uff09\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#warp-contexts-occupancy","title":"Warp Contexts &amp; Occupancy","text":"<ul> <li>Warp Contexts: \u6bcf\u4e2a SM \u7ef4\u62a4\u7740\u5927\u91cf Warp \u7684\u4e0a\u4e0b\u6587\uff08PC, \u5bc4\u5b58\u5668\u72b6\u6001\u7b49\uff09\u3002H100 \u4e0a\u6bcf\u4e2a SM \u6700\u591a\u652f\u6301 64 \u4e2a Warp\uff08\u5373 2048 \u4e2a\u7ebf\u7a0b\uff09\u3002</li> <li>Occupancy (\u5360\u7528\u7387):</li> <li>\u6307\u5f53\u524d SM \u4e0a\u5b9e\u9645\u6fc0\u6d3b\u7684 Warp \u6570\u91cf\u4e0e\u6700\u5927\u652f\u6301\u6570\u91cf\u7684\u6bd4\u503c\u3002</li> <li>\u5bc4\u5b58\u5668\u538b\u529b: H100 \u6bcf\u4e2a SM \u6709 64K (32-bit) \u5bc4\u5b58\u5668\u3002\u5982\u679c\u6bcf\u4e2a\u7ebf\u7a0b\u4f7f\u7528\u7684\u5bc4\u5b58\u5668\u8fc7\u591a\uff0cSM \u5c31\u65e0\u6cd5\u540c\u65f6\u5bb9\u7eb3\u8db3\u591f\u591a\u7684 Warp\uff0c\u5bfc\u81f4 Occupancy \u4e0b\u964d\uff0c\u4ece\u800c\u65e0\u6cd5\u6709\u6548\u9690\u85cf\u5ef6\u8fdf\u3002</li> <li>Shared Memory \u9650\u5236: \u540c\u6837\uff0c\u5982\u679c Block \u6d88\u8017\u8fc7\u591a\u7684 Shared Memory\uff0c\u4e5f\u4f1a\u9650\u5236 SM \u4e0a\u80fd\u5e76\u53d1\u8fd0\u884c\u7684 Block \u6570\u91cf\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#warp-scheduler-h100","title":"Warp Scheduler (H100)","text":"<p>H100 \u7684 Warp \u8c03\u5ea6\u5668\u66f4\u52a0\u667a\u80fd\u548c\u9ad8\u6548\uff1a</p> <ul> <li>\u72ec\u7acb\u8c03\u5ea6\u5668: \u6bcf\u4e2a SMSP (SM Sub-Partition) \u90fd\u6709\u81ea\u5df1\u7684 Warp Scheduler\u3002\u8fd9\u610f\u5473\u7740\u4e00\u4e2a SM \u6bcf\u4e2a\u5468\u671f\u53ef\u4ee5\u540c\u65f6\u4ece 4 \u4e2a SMSP \u4e2d\u5404\u53d1\u5c04\u6307\u4ee4\uff0c\u5b9e\u73b0 4 \u8def\u5e76\u53d1\u3002</li> <li>Latency Hiding:</li> <li>\u8c03\u5ea6\u5668\u7684\u6838\u5fc3\u4efb\u52a1\u662f\u96f6\u5f00\u9500\u4e0a\u4e0b\u6587\u5207\u6362\u3002</li> <li>\u5f53\u5f53\u524d Warp \u9047\u5230\u957f\u5ef6\u8fdf\u64cd\u4f5c\uff08\u5982 Global Memory \u8bfb\u53d6\u6216 Tensor Core \u8ba1\u7b97\uff09\u800c\u963b\u585e\u65f6\uff0c\u8c03\u5ea6\u5668\u4f1a\u5728\u4e0b\u4e00\u4e2a\u65f6\u949f\u5468\u671f\u7acb\u5373\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u201c\u51c6\u5907\u5c31\u7eea\u201d\u7684 Warp \u6267\u884c\u3002</li> <li>H100 \u4f18\u52bf: \u914d\u5408 TMA (Tensor Memory Accelerator) \u7684\u5f02\u6b65\u62f7\u8d1d\uff0cSM \u53ef\u4ee5\u6302\u8d77\u7b49\u5f85\u6570\u636e\u7684 Warp\uff0c\u8f6c\u800c\u6267\u884c\u8ba1\u7b97\u5bc6\u96c6\u7684 Warp\uff0c\u5b9e\u73b0\u8ba1\u7b97\u4e0e\u8bbf\u5b58\u7684\u5b8c\u7f8e\u91cd\u53e0\u3002</li> <li>Warp Divergence:</li> <li>\u4f9d\u7136\u9075\u5faa SIMT (Single Instruction, Multiple Threads) \u6a21\u578b\u3002</li> <li>\u5982\u679c Warp \u5185\u7ebf\u7a0b\u8fdb\u5165\u4e0d\u540c\u7684 <code>if-else</code> \u5206\u652f\uff0c\u786c\u4ef6\u4f1a\u4e32\u884c\u6267\u884c\u4e0d\u540c\u8def\u5f84\uff0c\u5e76\u4f7f\u7528 Active Mask \u5c4f\u853d\u4e0d\u5e94\u6267\u884c\u7684\u7ebf\u7a0b\u3002</li> <li>\u5c3d\u91cf\u907f\u514d Warp \u5185\u7684\u5206\u652f\u5206\u5316\uff0c\u6216\u8005\u4f7f\u7528 <code>__shfl_sync</code> \u7b49\u6307\u4ee4\u5728 Warp \u5185\u4ea4\u6362\u6570\u636e\u4ee5\u7edf\u4e00\u63a7\u5236\u6d41\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#gpu-memory-hierarchy-h100-enhanced","title":"GPU Memory Hierarchy (H100 Enhanced)","text":"<p>H100 \u7684\u5185\u5b58\u4f53\u7cfb\u7ed3\u6784\u4e3a\u4e86\u5582\u9971\u5f3a\u5927\u7684 Tensor Cores \u8fdb\u884c\u4e86\u5168\u9762\u5347\u7ea7\uff0c\u6838\u5fc3\u5728\u4e8e\u66f4\u9ad8\u7684\u5e26\u5bbd\u548c\u66f4\u7075\u6d3b\u7684\u6570\u636e\u5171\u4eab\u3002</p> <ul> <li> <p>Registers (\u5bc4\u5b58\u5668):</p> </li> <li> <p>\u901f\u5ea6: \u6700\u5feb\uff0c\u5355\u5468\u671f\u8bbf\u95ee\u3002</p> </li> <li>\u5bb9\u91cf: \u6bcf\u4e2a SM \u62e5\u6709 256KB \u7684\u5bc4\u5b58\u5668\u6587\u4ef6\u3002</li> <li> <p>\u4f18\u5316: \u7f16\u8bd1\u5668\u4f1a\u5c3d\u53ef\u80fd\u5c06\u9891\u7e41\u8bbf\u95ee\u7684\u53d8\u91cf\u653e\u5165\u5bc4\u5b58\u5668\u3002\u5982\u679c\u5bc4\u5b58\u5668\u6ea2\u51fa (Spill)\uff0c\u6570\u636e\u4f1a\u88ab\u653e\u5165 Local Memory (\u5b9e\u9645\u4e0a\u662f Global Memory)\uff0c\u5bfc\u81f4\u6027\u80fd\u6025\u5267\u4e0b\u964d\u3002</p> </li> <li> <p>L1 Data Cache / Shared Memory (Unified):</p> </li> <li> <p>\u7edf\u4e00\u67b6\u6784: \u6bcf\u4e2a SM \u62e5\u6709 256 KB \u7684\u9ad8\u901f\u7247\u4e0a\u5185\u5b58\u3002</p> </li> <li>\u53ef\u914d\u7f6e: \u53ef\u4ee5\u6839\u636e Kernel \u9700\u6c42\u7075\u6d3b\u5212\u5206\u4e3a L1 Cache \u548c Shared Memory</li> <li> <p>DSMEM (Distributed Shared Memory): \u5141\u8bb8\u4e00\u4e2a Thread Block Cluster \u5185\u7684 SM \u76f4\u63a5\u901a\u8fc7 SM-to-SM \u7f51\u7edc\u8bbf\u95ee\u5f7c\u6b64\u7684 Shared Memory\u3002\u8fd9\u4f7f\u5f97 Shared Memory \u7684\u6709\u6548\u5bb9\u91cf\u5728\u903b\u8f91\u4e0a\u6269\u5927\u4e86\u6570\u500d\u3002</p> </li> <li> <p>L2 Cache:</p> </li> <li> <p>\u5bb9\u91cf: H100 \u62e5\u6709\u5de8\u5927\u7684 50 MB L2 Cache\u3002</p> </li> <li> <p>\u4f5c\u7528: \u6240\u6709 SM \u5171\u4eab\u3002\u5b83\u662f\u8fde\u63a5\u9ad8\u901f SM \u548c\u4f4e\u901f HBM \u7684\u5173\u952e\u7f13\u51b2\u3002\u7531\u4e8e\u539f\u5b50\u64cd\u4f5c (Atomics) \u901a\u5e38\u5728 L2 \u4e0a\u6267\u884c\uff0c\u66f4\u5927\u7684 L2 \u610f\u5473\u7740\u66f4\u5c11\u7684 DRAM \u8bbf\u95ee\u51b2\u7a81\u3002</p> </li> <li> <p>HBM3 (Global Memory):</p> </li> <li> <p>\u5e26\u5bbd: H100 \u642d\u8f7d HBM3 \u663e\u5b58\uff0c\u5e26\u5bbd\u9ad8\u8fbe 3.35 TB/s\u3002</p> </li> <li> <p>TMA: \u914d\u5408 Tensor Memory Accelerator\uff0c\u6570\u636e\u53ef\u4ee5\u201c\u6d41\u201d\u8fdb Shared Memory\uff0c\u800c\u4e0d\u9700\u8981 CUDA Cores \u9010\u4e2a\u6307\u4ee4\u642c\u8fd0\u3002</p> </li> <li> <p>Constant / Texture Memory: \u4f9d\u7136\u5b58\u5728\uff0c\u7528\u4e8e\u53ea\u8bfb\u6570\u636e\u7684\u7f13\u5b58\u4f18\u5316\uff0c\u4f46\u5728\u73b0\u4ee3\u8ba1\u7b97\u5bc6\u96c6\u578b Kernel \u4e2d\uff0c\u5176\u89d2\u8272\u9010\u6e10\u88ab L1 Cache \u548c Shared Memory \u8986\u76d6\u3002</p> </li> </ul> <p>Summary (H100 Perspective)</p> \u5c42\u7ea7 \u7c7b\u578b H100 \u7279\u6027 \u5ef6\u8fdf (Cycles) Registers \u79c1\u6709 256KB/SM, \u6781\u901f ~0 Shared Memory Block/Cluster \u5171\u4eab DSMEM (\u8de8 SM \u8bbf\u95ee), TMA \u5f02\u6b65\u52a0\u8f7d ~20-30 (Local), ~50 (Remote) L1 Cache SM \u79c1\u6709 \u4e0e Shared Memory \u7edf\u4e00\u914d\u7f6e ~30 L2 Cache \u5168\u5c40\u5171\u4eab 50MB \u8d85\u5927\u5bb9\u91cf, \u539f\u5b50\u64cd\u4f5c\u4e2d\u5fc3 ~200 HBM3 (Global) \u5168\u5c40\u5171\u4eab 3TB/s+ \u5e26\u5bbd, TMA \u76f4\u901a ~400-600+","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#warp-h100-scheduling-execution","title":"Warp (H100 Scheduling &amp; Execution)","text":"<p>\u867d\u7136\u7a0b\u5e8f\u5458\u7f16\u5199\u7684\u662f\u5355\u4e2a\u7ebf\u7a0b\u7684\u4ee3\u7801\uff0c\u4f46\u5728\u786c\u4ef6\u5c42\u9762\uff0cH100 \u4f9d\u7136\u5c06\u7ebf\u7a0b\u7ec4\u7ec7\u6210\u56fa\u5b9a\u5927\u5c0f\uff0832 \u4e2a\uff09\u7684\u675f\uff0c\u79f0\u4e3a Warp\u3002Warp \u662f SM \u4e0a\u8c03\u5ea6\u548c\u6267\u884c\u7684\u771f\u6b63\u57fa\u672c\u5355\u4f4d\u3002</p> <ul> <li> <p>SIMT \u4e0e \u72ec\u7acb\u7ebf\u7a0b\u8c03\u5ea6:</p> </li> <li> <p>H100 \u5ef6\u7eed\u4e86 Volta \u5f15\u5165\u7684\u72ec\u7acb\u7ebf\u7a0b\u8c03\u5ea6\u673a\u5236\u3002\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6709\u81ea\u5df1\u7684\u7a0b\u5e8f\u8ba1\u6570\u5668 (PC) \u548c\u8c03\u7528\u6808\u3002</p> </li> <li>\u5c3d\u7ba1\u5982\u6b64\uff0c\u4e3a\u4e86\u6027\u80fd\uff0cWarp \u5185\u7684 32 \u4e2a\u7ebf\u7a0b\u901a\u5e38\u4f9d\u7136\u662f\u540c\u6b65\u6267\u884c\u76f8\u540c\u6307\u4ee4\u7684 (SIMT)\u3002</li> <li> <p>Warp Divergence: \u5982\u679c Warp \u5185\u7ebf\u7a0b\u8fdb\u5165\u4e0d\u540c\u7684\u5206\u652f\uff0c\u786c\u4ef6\u4f1a\u4e32\u884c\u6267\u884c\u4e0d\u540c\u8def\u5f84\u3002\u867d\u7136\u72ec\u7acb\u8c03\u5ea6\u907f\u514d\u4e86\u6b7b\u9501\u98ce\u9669\uff0c\u4f46\u6027\u80fd\u60e9\u7f5a\u4f9d\u7136\u5b58\u5728\uff0c\u56e0\u4e3a\u786c\u4ef6\u5355\u5143\u5728\u67d0\u4e00\u65f6\u523b\u53ea\u80fd\u670d\u52a1\u4e8e\u4e00\u79cd\u6307\u4ee4\u8def\u5f84\u3002</p> </li> <li> <p>Dispatch Speed:</p> </li> <li> <p>H100 \u7684\u6bcf\u4e2a SM \u5212\u5206\u4e3a 4 \u4e2a SMSP\uff0c\u6bcf\u4e2a SMSP \u90fd\u6709\u72ec\u7acb\u7684 Warp Scheduler\u3002</p> </li> <li> <p>\u8fd9\u610f\u5473\u7740\u4e00\u4e2a SM \u5728\u6bcf\u4e2a\u65f6\u949f\u5468\u671f\u53ef\u4ee5\u540c\u65f6\u4ece 4 \u4e2a\u4e0d\u540c\u7684 Warp \u4e2d\u53d1\u5c04\u6307\u4ee4\uff0c\u6781\u5927\u5730\u63d0\u9ad8\u4e86\u6307\u4ee4\u541e\u5410\u91cf\u3002</p> </li> <li> <p>\u5ef6\u8fdf\u9690\u85cf:</p> </li> <li> <p>\u4f20\u7edf\u7684\u5ef6\u8fdf\u9690\u85cf\u4f9d\u8d56\u4e8e\u201c\u4e0a\u4e0b\u6587\u5207\u6362\u201d\uff1a\u5f53 Warp A \u7b49\u5f85\u5185\u5b58\u65f6\uff0c\u5207\u6362\u5230 Warp B\u3002</p> </li> <li> <p>H100 \u7248\u672c: \u7ed3\u5408 TMA \u548c \u5f02\u6b65\u62f7\u8d1d (<code>cp.async</code>)\uff0cWarp \u4e0d\u518d\u9700\u8981\u4e3a\u4e86\u642c\u8fd0\u6570\u636e\u800c\u201c\u505c\u987f\u201d\u5728 Load \u6307\u4ee4\u4e0a\u3002Warp \u53ef\u4ee5\u53d1\u51fa\u5f02\u6b65\u62f7\u8d1d\u547d\u4ee4\uff0c\u7136\u540e\u7ee7\u7eed\u6267\u884c\u5176\u4ed6\u8ba1\u7b97\u4efb\u52a1\uff08\u5982 GEMM\uff09\uff0c\u76f4\u5230\u771f\u6b63\u9700\u8981\u6570\u636e\u65f6\u624d\u5728 <code>mbarrier</code> \u4e0a\u7b49\u5f85\u3002\u8fd9\u4f7f\u5f97\u8ba1\u7b97\u548c\u8bbf\u5b58\u7684\u91cd\u53e0 (Overlap) \u8fbe\u5230\u4e86\u65b0\u7684\u9ad8\u5ea6\u3002</p> </li> <li> <p>\u5bc4\u5b58\u5668\u538b\u529b\u4e0e Occupancy:</p> </li> <li> <p>H100 \u6bcf\u4e2a SM \u6709 64K \u5bc4\u5b58\u5668\u3002</p> </li> <li>\u4e3a\u4e86\u7ef4\u6301\u8db3\u591f\u7684 Active Warps \u6765\u9690\u85cf\u5ef6\u8fdf\uff0c\u5fc5\u987b\u4e25\u683c\u63a7\u5236\u6bcf\u4e2a Kernel \u4f7f\u7528\u7684\u5bc4\u5b58\u5668\u6570\u91cf\u3002\u5982\u679c\u6bcf\u4e2a\u7ebf\u7a0b\u4f7f\u7528\u8fc7\u591a\u5bc4\u5b58\u5668\uff0cSM \u4e0a\u80fd\u540c\u65f6\u9a7b\u7559\u7684 Warp \u5c31\u4f1a\u51cf\u5c11\uff0c\u5bfc\u81f4\u8c03\u5ea6\u5668\u201c\u65e0 Warp \u53ef\u5207\u201d\uff0c\u6d41\u6c34\u7ebf\u51fa\u73b0\u6c14\u6ce1\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#cuda-cuda2","title":"CUDA \u8ba1\u7b97\u6a21\u578b[^cuda2]","text":"<p>CUDA \u5c06\u8ba1\u7b97\u4efb\u52a1\u7ec4\u7ec7\u6210\u4e00\u4e2a\u4e09\u7ea7\u5c42\u6b21\u7ed3\u6784 \u3002\u8fd9\u662f\u4e00\u4e2a\u7531\u7a0b\u5e8f\u5458\u521b\u5efa\u7684\u3001\u7528\u4e8e\u7ec4\u7ec7\u95ee\u9898\u7684\u903b\u8f91\u5c42\u6b21\uff0c\u800c\u975e\u786c\u4ef6\u7684\u76f4\u63a5\u4f53\u73b0 \u3002</p> <ul> <li>\u7ebf\u7a0b (Thread)\uff1a\u6700\u57fa\u672c\u7684\u6267\u884c\u5355\u4f4d\u3002\u5355\u4e2a\u7ebf\u7a0b\u6267\u884c\u4e00\u4e2a Kernel \u51fd\u6570\u7684\u5b9e\u4f8b \u3002\u6bcf\u4e2a\u7ebf\u7a0b\u5728\u5176\u6240\u5c5e\u7684\u7ebf\u7a0b\u5757\u5185\u62e5\u6709\u4e00\u4e2a\u552f\u4e00\u7684 ID(threadIdx)</li> <li>\u7ebf\u7a0b\u5757(Thread Block)\uff1a\u4e00\u7ec4\u53ef\u4ee5\u76f8\u4e92\u534f\u4f5c\u7684\u7ebf\u7a0b\uff08\u5728\u73b0\u4ee3\u67b6\u6784\u4e0a\u6700\u591a 1024 \u4e2a\uff09\u3002\u4e00\u4e2a\u5757\u5185\u7684\u6240\u6709\u7ebf\u7a0b\u53ef\u4ee5\u901a\u8fc7\u9ad8\u901f\u7684\u7247\u4e0a \u00a0 \u5171\u4eab\u5185\u5b58\u5171\u4eab\u6570\u636e\uff0c\u5e76\u80fd\u901a\u8fc7<code>__syncthreads()</code>\u6765\u534f\u8c03\u5b83\u4eec\u7684\u6267\u884c \u3002\u6bcf\u4e2a\u7ebf\u7a0b\u5757\u5728\u5176\u6240\u5c5e\u7684 Grid \u5185\u4e5f\u62e5\u6709\u4e00\u4e2a\u552f\u4e00\u7684 ID(blockIdx)</li> <li>\u7f51\u683c (Grid)\uff1a\u4e3a\u6267\u884c\u5355\u4e2a Kernel \u800c\u542f\u52a8\u7684\u6240\u6709\u7ebf\u7a0b\u5757\u7684\u96c6\u5408 \u3002\u4e00\u4e2a Grid \u5185\u7684\u6240\u6709\u7ebf\u7a0b\u90fd\u53ef\u4ee5\u8bbf\u95ee\u540c\u4e00\u4e2a\u5168\u5c40\u5185\u5b58\u7a7a\u95f4\u3002Grid \u5185\u7684\u7ebf\u7a0b\u5757\u88ab\u5047\u5b9a\u4e3a\u72ec\u7acb\u6267\u884c\uff0c\u4e14\u6267\u884c\u987a\u5e8f\u4e0d\u786e\u5b9a\uff1b\u5b83\u4eec\u4e4b\u95f4\u6ca1\u6709\u76f4\u63a5\u7684\u540c\u6b65\u673a\u5236\u3002</li> </ul> <p>\u7ebf\u7a0b\u5757\u548c\u7f51\u683c\u53ef\u4ee5\u88ab\u7ec4\u7ec7\u6210\u4e00\u7ef4\u3001\u4e8c\u7ef4\u6216\u4e09\u7ef4\u7684\u7ed3\u6784\uff0c\u8fd9\u4e3a\u5c06\u8ba1\u7b97\u4efb\u52a1\u6620\u5c04\u5230\u5411\u91cf\u3001\u77e9\u9635\u3001\u4f53\u6570\u636e\u7b49\u6570\u636e\u7ed3\u6784\u4e0a\u63d0\u4f9b\u4e86\u6781\u5927\u7684\u4fbf\u5229 \u3002</p> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#_1","title":"\u4e0e\u786c\u4ef6\u7684\u5bf9\u5e94","text":"","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#thread","title":"Thread","text":"<ul> <li> <p>\u5728\u67d0\u4e00\u65f6\u523b\uff0c\u4e00\u4e2a CUDA core \u6267\u884c\u4e00\u4e2a\u7ebf\u7a0b\u7684\u6307\u4ee4\u3002</p> </li> <li> <p> \u5b9e\u9645\u4e0a\u540c\u4e00\u4e2a CUDA core \u4f1a\u5728\u591a\u4e2a thread \u4e4b\u95f4\u5206\u65f6\u590d\u7528\uff0c\u56e0\u4e3a\u7ebf\u7a0b\u6570\u8fdc\u591a\u4e8e\u6838\u5fc3\u6570</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#thread-block","title":"Thread Block","text":"<ul> <li>\u4e00\u4e2a block \u88ab\u5206\u914d\u5230\u4e00\u4e2a SM (Streaming Multiprocessor) \u4e0a\u6267\u884c\u3002</li> <li>\u4e00\u4e2a block \u4e2d\u7684\u7ebf\u7a0b\u4f1a\u88ab\u5206\u6210\u82e5\u5e72 warp\u3002SM \u5185\u6709\u591a\u4e2a\u8d44\u6e90\uff08\u5bc4\u5b58\u5668\u6587\u4ef6\u3001\u5171\u4eab\u5185\u5b58\uff09\uff0c\u8fd9\u4e9b\u8d44\u6e90\u5728\u4e0d\u540c block \u4e4b\u95f4\u5206\u914d\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#grid","title":"Grid","text":"<ul> <li>\u4e00\u4e2a grid \u5bf9\u5e94\u4e00\u6b21 kernel \u542f\u52a8\uff08Launch\uff09\u3002</li> <li>Grid \u4e2d\u7684 block \u4f1a\u88ab\u5206\u914d\u5230\u4e0d\u540c\u7684 SM \u6267\u884c\u3002</li> <li>GPU \u4e0a\u7684 GPC\uff08Graphics Processing Cluster\uff09 \u6216 TPC\uff08Texture Processing Cluster\uff09 \u5c42\u7ea7\u4f1a\u53c2\u4e0e\u5168\u5c40\u8c03\u5ea6\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#kernel","title":"Kernel \u6267\u884c\u6d41\u7a0b","text":"<ul> <li>\u5f53\u4e00\u4e2a Kernel \u88ab\u542f\u52a8\u65f6\uff0c\u7531\u786c\u4ef6\u8c03\u5ea6\u5668\u5c06 Grid \u4e2d\u7684\u6240\u6709\u7ebf\u7a0b\u5757\u5206\u914d\u5230 GPU \u4e0a\u53ef\u7528\u7684 SM \u4e2d</li> <li>\u4e00\u4e2a Thread Block \u4f1a\u88ab\u5b8c\u6574\u5730\u5206\u914d\u7ed9\u4e00\u4e2a SM\uff0c\u5e76\u5728\u5176\u4e0a\u5b8c\u6574\u5730\u6267\u884c\u3002\u5728\u5176\u751f\u547d\u5468\u671f\u5185\uff0c\u5b83\u4e0d\u4f1a\u88ab\u8fc1\u79fb\u5230\u5176\u4ed6 SM</li> <li>\u4e00\u4e2a SM \u53ef\u4ee5\u5e76\u53d1\u5730\u6267\u884c\u591a\u4e2a Thread Block\uff0c\u524d\u63d0\u662f\u5b83\u62e5\u6709\u8db3\u591f\u7684\u8d44\u6e90\uff08\u5982\u5bc4\u5b58\u5668\u3001\u5171\u4eab\u5185\u5b58\uff09\u6765\u5bb9\u7eb3\u8fd9\u4e9b\u7ebf\u7a0b\u5757</li> <li>\u5728 SM \u5185\u90e8\uff0c\u4e00\u4e2a Thread Block \u7684\u6240\u6709\u7ebf\u7a0b\u88ab\u5212\u5206\u4e3a\u82e5\u5e72\u4e2a Warp\uff08\u6bcf\u7ec4 32 \u4e2a\u7ebf\u7a0b\uff09\u3002\u8fd9\u4e9b Warp \u624d\u662f\u88ab SM \u7684 Warp \u8c03\u5ea6\u5668\u5b9e\u9645\u8c03\u5ea6\u6267\u884c\u7684\u5355\u5143 \u3002</li> </ul> <p>\u8fd9\u4e2a\u6620\u5c04\u5173\u7cfb\u662f\u5c42\u7ea7\u5316\u7684\uff1a<code>Grid -&gt; GPU</code>\uff0c<code>Block -&gt; SM</code>\uff0c<code>Thread -&gt; Warp -&gt; CUDA\u6838\u5fc3</code></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#roofline","title":"Roofline \u6a21\u578b","text":"<p>Roofline \u6a21\u578b\uff08\u5c4b\u9876\u7ebf\u6a21\u578b\uff09\u662f\u4e00\u79cd\u7528\u6765\u5206\u6790\u7a0b\u5e8f\u6027\u80fd\u74f6\u9888\uff08\u8ba1\u7b97\u53d7\u9650\u8fd8\u662f\u5e26\u5bbd\u53d7\u9650\uff09\u7684\u65b9\u6cd5\u3002\\ \u5b83\u628a\u8ba1\u7b97\u6027\u80fd\uff08FLOPs/s\uff09\u548c\u8bbf\u5b58\u6027\u80fd\uff08Bytes/s\uff09\u8054\u7cfb\u5728\u4e00\u8d77\uff0c\u3002\u4ee5\u53ef\u89c6\u5316\u7684\u65b9\u5f0f\u5c55\u793a\u6027\u80fd\u4e0a\u9650</p> \\[ Achievable\u00a0\\\\space FLOPs=min(AI\u00d7Memory\\\\space\u00a0BW,Peak\u00a0FLOPs) \\] <p></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#cuda-kernel","title":"CUDA Kernel \u6027\u80fd\u8c03\u4f18","text":"<p>\u6839\u636e Roofline \u6a21\u578b\uff0c\u7b97\u5b50\u5206\u4e3a Compute-Bound \u548c Memory-Bound \u578b\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5206\u5f00\u8ba8\u8bba\uff0c\u4f46\u5b9e\u9645\u4e0a\u5728\u4f18\u5316\u8fc7\u7a0b\u4e2d\uff0c\u8fd9\u4e24\u79cd\u74f6\u9888\u4f1a\u4ea4\u66ff\u51fa\u73b0\ud83d\ude2d</p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#memory-bound","title":"Memory-Bound","text":"","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#1-instruction-issue-efficiency","title":"1. \u6307\u4ee4\u5c42\u7ea7\uff1a\u6307\u4ee4\u53d1\u5c04\u6548\u7387 (Instruction Issue Efficiency)","text":"<ul> <li> <p>LSU (Load Store Unit) \u538b\u529b\uff1a</p> </li> <li> <p>Scalar (<code>float</code>): \u642c\u8fd0\u540c\u6837\u591a\u7684\u6570\u636e\uff0c\u9700\u8981\u53d1\u5c04 4 \u500d \u7684\u6307\u4ee4\u6570\u3002\u8fd9\u4f1a\u5927\u91cf\u5360\u7528\u5e26\u5bbd\uff0c\u5e76\u589e\u52a0 LSU \u7ef4\u62a4 In-flight \u72b6\u6001\u7684\u5f00\u9500\u3002</p> </li> <li> <p>Vectorized (<code>float4</code>): \u5355\u6307\u4ee4\u9ad8\u541e\u5410\u3002\u4e00\u6761\u6307\u4ee4\u5373\u53ef\u642c\u8fd0 128-bit \u6570\u636e\u3002LSU \u961f\u5217\u5360\u7528\u5c11\uff0c\u66f4\u5bb9\u6613\u7ef4\u6301\u6d41\u6c34\u7ebf\u9971\u548c\u3002</p> </li> <li> <p>\u6307\u4ee4\u53d1\u5c04\u5ef6\u8fdf\u63a9\u76d6 (Issue Latency Hiding)\uff1a</p> </li> <li> <p>\u6c14\u6ce1\u95ee\u9898\uff1a \u6307\u4ee4\u53d1\u5c04\u6709\u56fa\u6709\u5ef6\u8fdf\u3002\u5982\u679c\u6bcf\u6761\u6307\u4ee4\u642c\u8fd0\u7684\u6570\u636e\u91cf\u592a\u5c0f\uff08\u5982 4 Bytes\uff09\uff0c\u6307\u4ee4\u53d1\u5c04\u7684\u901f\u5ea6\u53ef\u80fd\u8ddf\u4e0d\u4e0a\u5185\u5b58\u603b\u7ebf\u7684\u6d88\u8017\u901f\u5ea6\uff0c\u5bfc\u81f4\u603b\u7ebf\u51fa\u73b0\u201c\u7a7a\u95f2\u6c14\u6ce1\u201d\u3002</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#2-mlp-memory-level-parallelism","title":"2. \u6570\u636e\u5c42\u7ea7\uff1a\u5185\u5b58\u7ea7\u5e76\u884c\u5ea6 (MLP, Memory Level Parallelism)","text":"<p>\u8fd9\u662f\u51b3\u5b9a\u5e26\u5bbd\u4e0a\u9650\u7684\u5173\u952e\u8f6f\u4ef6\u7b56\u7565\u3002</p> <ul> <li> <p>\u539f\u7406\uff1a HBM \u5ef6\u8fdf\u6781\u9ad8 (~600 cycles)\u3002\u4e3a\u4e86\u63a9\u76d6\u5ef6\u8fdf\uff0c\u5fc5\u987b\u8ba9\u603b\u7ebf\u4e0a\u540c\u65f6\u98de\u7740\u8db3\u591f\u591a\u7684\u8bf7\u6c42 (In-flight Requests)\u3002</p> </li> <li> <p>\u4f18\u5316\u624b\u6bb5\uff1a \u5faa\u73af\u5c55\u5f00 (Loop Unrolling)\u3002</p> </li> <li> <p>Bad: <code>Load -&gt; Use -&gt; Load -&gt; Use</code> (\u4e32\u884c\u4f9d\u8d56\uff0c\u5ef6\u8fdf\u65e0\u6cd5\u63a9\u76d6)\u3002</p> </li> <li> <p>Good: <code>Load1 -&gt; Load2 -&gt; Load3 -&gt; Load4 ... -&gt; Use1</code> (\u5e76\u884c\u53d1\u5c04\uff0c\u4e00\u6b21\u7b49\u5f85\uff0c\u5168\u90e8\u8fd4\u56de)\u3002</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#3-transaction-utilization","title":"3. \u786c\u4ef6\u5c42\u7ea7\uff1a\u4f20\u8f93\u7c92\u5ea6\u4e0e\u5229\u7528\u7387 (Transaction &amp; Utilization)","text":"<p>\u5373\u4f7f\u8f6f\u4ef6\u5199\u5f97\u597d\uff0c\u786c\u4ef6\u673a\u5236\u4e5f\u53ef\u80fd\u5bfc\u81f4\u6d6a\u8d39\u3002</p> <ul> <li> <p>\u6247\u533a\u5229\u7528\u7387 (Sector Utilization):</p> </li> <li> <p>\u673a\u5236\uff1a DRAM \u5230 L2 \u7684\u6700\u5c0f\u4f20\u8f93\u7c92\u5ea6\u662f 32 Bytes (Sector)\u3002</p> </li> <li> <p>\u6d6a\u8d39\uff1a \u5982\u679c\u53ea\u8bfb 1 \u4e2a Byte (<code>char</code>) \u4e14\u672a\u6253\u5305\uff0c\u786c\u4ef6\u4e5f\u88ab\u8feb\u642c\u8fd0 32 Bytes\u3002\u6709\u6548\u5e26\u5bbd (Effective Bandwidth) \u53ea\u6709 1/32\u3002</p> </li> <li> <p>\u5bf9\u7b56\uff1a \u5bf9\u4e8e\u5c0f\u6570\u636e\u7c7b\u578b\uff08INT8/FP16\uff09\uff0c\u5fc5\u987b\u4f7f\u7528\u6253\u5305\u5bf9\u9f50\uff08Pack Alignment\uff09\u8bbf\u95ee\u3002</p> </li> <li> <p>\u5730\u5740\u5bf9\u9f50 (Address Alignment):</p> </li> <li> <p>\u673a\u5236\uff1a \u786c\u4ef6\u8981\u6c42\u8bbf\u95ee\u5730\u5740\u6309 32B \u6216 128B \u5bf9\u9f50\u3002</p> </li> <li> <p>\u540e\u679c\uff1a \u5982\u679c\u6307\u9488\u5730\u5740\u504f\u79fb\uff08Misaligned\uff09\uff0c\u4e00\u6b21 128 Bytes \u7684\u8bfb\u53d6\u53ef\u80fd\u4f1a\u8de8\u8d8a\u4e24\u4e2a 128B \u5757\uff0c\u5bfc\u81f4\u786c\u4ef6\u5fc5\u987b\u53d1\u8d77 2 \u4e2a Transactions\u3002\u8fd9\u4f1a\u76f4\u63a5\u5bfc\u81f4\u5e26\u5bbd\u6027\u80fd\u51cf\u534a\u3002</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#4-physical-conflict","title":"4. \u67b6\u6784\u5c42\u7ea7\uff1a\u7269\u7406\u51b2\u7a81 (Physical Conflict)","text":"<p>\u901a\u5e38\u7531\u786c\u4ef6\u89e3\u51b3\uff0c\u4f46\u5728\u6781\u7aef\u4f18\u5316\u65f6\u9700\u6ce8\u610f\u3002</p> <ul> <li> <p>\u5206\u533a\u51b2\u7a81 (Partition Camping / Channel Conflict):</p> </li> <li> <p>\u539f\u7406\uff1a \u663e\u5b58\u88ab\u5212\u5206\u4e3a\u591a\u4e2a\u7269\u7406\u5206\u533a\uff08Memory Controllers\uff09\u3002</p> </li> <li> <p>\u73b0\u8c61\uff1a \u7279\u5b9a\u7684\u8bbf\u95ee\u6b65\u957f\uff08Stride\uff0c\u901a\u5e38\u662f 2 \u7684\u5e42\u6b21\uff09\u53ef\u80fd\u5bfc\u81f4\u6240\u6709\u8bf7\u6c42\u96c6\u4e2d\u6253\u5411\u540c\u4e00\u4e2a Controller\uff0c\u9020\u6210\u5c40\u90e8\u62e5\u5835\uff08Serialization\uff09\uff0c\u800c\u5176\u4ed6 Controller \u7a7a\u95f2\u3002</p> </li> <li> <p>\u73b0\u72b6\uff1a \u73b0\u4ee3 GPU (Pascal+) \u5df2\u901a\u8fc7\u7269\u7406\u5730\u5740\u54c8\u5e0c\uff08Address Swizzling\uff09\u6781\u5927\u7f13\u89e3\u4e86\u6b64\u95ee\u9898\uff0c\u4f46\u5728\u5199\u6781\u9650 Kernel \u65f6\u4ecd\u9700\u907f\u514d\u5b8c\u7f8e\u7684 2 \u7684\u5e42\u6b21\u8de8\u5ea6\u3002</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#5-asynchronous-copy-cpasync","title":"5. Asynchronous Copy (cp.async)","text":"<p>\u5728 Ampere (A100) \u548c Hopper (H100) \u67b6\u6784\u4e0a\uff0c\u4e3a\u4e86\u6781\u81f4\u7684 Double/Multi-stage Buffering\uff0c\u6211\u4eec\u4f7f\u7528\u5f02\u6b65\u62f7\u8d1d\u6307\u4ee4\u3002</p> <ul> <li>\u673a\u5236\uff1a <code>cp.async</code> (PTX: <code>cp.async.ca.shared.global</code>) \u5141\u8bb8\u6570\u636e\u76f4\u63a5\u4ece Global Memory \u4f20\u8f93\u5230 Shared Memory\u3002</li> <li>\u4f18\u52bf\uff1a</li> <li>Bypass Register File: \u6570\u636e\u4e0d\u7ecf\u8fc7\u5bc4\u5b58\u5668\uff0c\u76f4\u63a5\u8fdb\u5165 Shared Memory\uff0c\u6781\u5927\u964d\u4f4e\u5bc4\u5b58\u5668\u538b\u529b (Register Pressure)\u3002</li> <li>Non-blocking: \u53d1\u51fa\u6307\u4ee4\u540e\uff0c\u7ebf\u7a0b\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\u5176\u4ed6\u8ba1\u7b97\uff08\u5982\u8ba1\u7b97\u4e0a\u4e00\u5757\u6570\u636e\u7684 GEMM\uff09\uff0c\u5b9e\u73b0\u8ba1\u7b97\u4e0e\u8bbf\u5b58\u7684\u5b8c\u7f8e\u6d41\u6c34\u7ebf\u63a9\u76d6\u3002</li> <li>\u6d41\u6c34\u7ebf (Pipeline):</li> <li><code>cp.async.commit_group()</code>: \u63d0\u4ea4\u4e00\u7ec4\u62f7\u8d1d\u4efb\u52a1\u3002</li> <li><code>cp.async.wait_group&lt;N&gt;()</code>: \u7b49\u5f85\u76f4\u5230\u53ea\u5269\u4e0b N \u7ec4\u672a\u5b8c\u6210\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#compute-bound","title":"Compute-Bound","text":"","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#1-tensor-cores-wmma-mma","title":"1. \u4f7f\u7528 Tensor Cores (WMMA / MMA)","text":"<p>\u8fd9\u662f\u73b0\u4ee3 LLM \u63a8\u7406\u52a0\u901f\u7684\u7edd\u5bf9\u6838\u5fc3\u3002\u5728 LLM \u63a8\u7406\u4e2d\uff0c99% \u7684 GEMM \u90fd\u662f FP16/INT8/BF16\uff0c\u5fc5\u987b\u8fd0\u884c\u5728 Tensor Cores \u4e0a\u624d\u80fd\u83b7\u5f97 8-16 \u500d\u7684\u52a0\u901f\u3002</p> <ul> <li> <p>\u539f\u7406\uff1a</p> </li> <li> <p>CUDA Core (FP32): SIMT \u6a21\u578b\uff0c\u6bcf\u4e2a Thread \u5904\u7406\u4e00\u4e2a\u6807\u91cf\u8ba1\u7b97\u3002\u6bcf\u4e2a\u65f6\u949f\u5468\u671f\u6267\u884c 1 \u6b21 <code>FMA (a*b+c)</code>\u3002</p> </li> <li>Tensor Core (FP16/INT8): Warp-level \u6a21\u578b\uff0c\u4e00\u4e2a Warp (32 threads) \u534f\u540c\u5904\u7406\u4e00\u4e2a\u77e9\u9635\u5757\uff08\u5982 16x16x16\uff09\u3002\u6bcf\u4e2a\u65f6\u949f\u5468\u671f\u6267\u884c 1 \u6b21\u5b8c\u6574\u7684\u77e9\u9635\u4e58\u52a0\u3002</li> <li> <p>\u5dee\u8ddd\uff1a A100 \u4e0a\uff0cTensor Core \u7684\u541e\u5410\u91cf\u662f CUDA Core \u7684 16 \u500d\u4ee5\u4e0a\u3002</p> </li> <li> <p>\u5173\u952e\u6982\u5ff5\uff1aFragment</p> </li> <li> <p>\u6570\u636e\u4e0d\u80fd\u968f\u610f\u653e\u5728\u5bc4\u5b58\u5668\u91cc\uff0c\u5fc5\u987b\u6309\u7167 Tensor Core \u8981\u6c42\u7684\u5e03\u5c40\uff08Layout\uff09\u5b58\u653e\u3002</p> </li> <li> <p><code>nvcuda::wmma::fragment</code>: \u8fd9\u662f\u4e00\u4e2a\u6a21\u677f\u7c7b\uff0c\u4ee3\u8868\u77e9\u9635\u7684\u4e00\u4e2a\u5757\uff08Tile\uff09\u3002</p> </li> <li> <p>API \u5c42\u6b21\uff1a</p> </li> </ul> <ol> <li>WMMA API (<code>nvcuda::wmma</code>): C++ \u6a21\u677f\u5c01\u88c5\uff0c\u6613\u7528\u6027\u597d\u3002 C++<pre><code>using namespace nvcuda;\nwmma::fragment&lt;wmma::matrix_a, 16, 16, 16, half, wmma::row_major&gt; a_frag;\nwmma::load_matrix_sync(a_frag, a_ptr, lda);\nwmma::mma_sync(c_frag, a_frag, b_frag, c_frag);\nwmma::store_matrix_sync(c_ptr, c_frag, ldc, wmma::mem_row_major);\n</code></pre></li> <li>PTX MMA (<code>mma.sync</code>): \u66f4\u5e95\u5c42\uff0c\u63a7\u5236\u529b\u66f4\u5f3a\uff0cCutlass \u5e38\u7528\u3002</li> </ol> <ul> <li> <p>\u4f18\u5316\u624b\u6bb5\uff1a</p> </li> <li> <p>\u629b\u5f03 <code>c = a * b + c</code> \u7684\u6807\u91cf\u5199\u6cd5\u3002</p> </li> <li>\u4f7f\u7528 <code>nvcuda::wmma</code> \u6216 Cutlass \u5e93\u3002</li> <li>\u6570\u636e\u5e03\u5c40 (Layout): \u5fc5\u987b\u5904\u7406\u597d Shared Memory \u5230 Register \u7684\u52a0\u8f7d\uff0c\u907f\u514d Bank Conflict\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#2-precision-reduction","title":"2. \u964d\u4f4e\u7cbe\u5ea6 (Precision Reduction)","text":"<p>\u8ba1\u7b97\u541e\u5410\u91cf\u4e0e\u6570\u636e\u7c7b\u578b\u7684\u4f4d\u5bbd\u6210\u53cd\u6bd4</p> <ul> <li>FP32: \u57fa\u51c6 (1x)</li> <li>TF32 (Ampere+): Tensor Core \u4e13\u7528\uff0c19 bits\uff0c\u541e\u5410\u91cf\u901a\u5e38\u662f FP32 \u7684 high-speed \u6a21\u5f0f\u3002</li> <li>FP16 / BF16: \u541e\u5410\u91cf\u662f FP32 \u7684 2x (CUDA Core) \u6216\u66f4\u9ad8 (Tensor Core)\u3002</li> <li>INT8: \u541e\u5410\u91cf\u662f FP16 \u7684 2x\u3002</li> <li>\u4f18\u5316\u624b\u6bb5\uff1a \u5728 LLM \u63a8\u7406\u4e2d\uff0c\u6743\u91cd\uff08Weight\uff09\u548c\u6fc0\u6d3b\uff08Activation\uff09\u901a\u5e38\u91cf\u5316\u4e3a FP16 \u6216 INT8/W8A16\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#3-ilp-instruction-level-parallelism","title":"3. \u6307\u4ee4\u7ea7\u5e76\u884c (ILP, Instruction Level Parallelism)","text":"<p>\u5faa\u73af\u5c55\u5f00 (Loop Unrolling): \u8ba9\u6bcf\u4e2a\u7ebf\u7a0b\u540c\u65f6\u7ef4\u6301\u591a\u4e2a\u201cIn-flight\u201d\u7684\u8ba1\u7b97\u6307\u4ee4 </p>C++<pre><code>// \u5c55\u5f00\u540e\uff0c\u7f16\u8bd1\u5668\u4f1a\u4ea4\u9519\u53d1\u5c04\u6307\u4ee4\na1 = b1 * c1; // \u53d1\u5c04\na2 = b2 * c2; // \u53d1\u5c04\uff0c\u4e0d\u9700\u8981\u7b49 a1\na3 = b3 * c3; // \u53d1\u5c04\n// ... \u6b64\u65f6 ALU \u6d41\u6c34\u7ebf\u88ab\u586b\u6ee1\n</code></pre><p></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#4-dual-issue","title":"4. \u53cc\u53d1\u5c04 (Dual Issue) / \u5e76\u53d1\u6267\u884c","text":"<ul> <li> <p>\u539f\u7406\uff1a \u73b0\u4ee3 SM\uff08Ampere/Ada/Hopper\uff09\u901a\u5e38\u5305\u542b\uff1a</p> </li> <li> <p>FP32 \u8ba1\u7b97\u5355\u5143</p> </li> <li>INT32 \u8ba1\u7b97\u5355\u5143</li> <li> <p>\u8fd9\u4e24\u8005\u5728\u67d0\u4e9b\u67b6\u6784\u4e0a\u662f\u72ec\u7acb\u7684\uff0c\u53ef\u4ee5\u540c\u65f6\u6267\u884c\u3002</p> </li> <li> <p>\u573a\u666f\uff1a</p> </li> <li> <p><code>val = val * x + y</code> (FP32 \u8ba1\u7b97)</p> </li> <li> <p><code>ptr += stride</code> (INT32 \u6307\u9488\u8ba1\u7b97/\u5faa\u73af\u8ba1\u6570)</p> </li> <li> <p>\u4f18\u5316\u624b\u6bb5\uff1a \u7f16\u5199 Kernel \u65f6\uff0c\u5982\u679c\u80fd\u8ba9\u6d6e\u70b9\u8ba1\u7b97\uff08\u4e1a\u52a1\u903b\u8f91\uff09\u548c\u6574\u6570\u8ba1\u7b97\uff08\u5730\u5740\u7d22\u5f15\uff09\u4ea4\u7ec7\u5728\u4e00\u8d77\uff0cSM \u53ef\u4ee5\u5728\u4e00\u4e2a\u5468\u671f\u5185\u540c\u65f6\u53d1\u5c04\u8fd9\u4e24\u6761\u6307\u4ee4\uff0c\u4ece\u800c\u63a9\u76d6\u6389\u7d22\u5f15\u8ba1\u7b97\u7684\u5f00\u9500\u3002</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#5-fma-fused-multiply-add","title":"5. \u4f7f\u7528 FMA (Fused Multiply-Add)","text":"<ul> <li>\u539f\u7406\uff1a <code>a * b + c</code>\u3002</li> <li>\u5982\u679c\u4e0d\u4f18\u5316\uff1a<code>MUL</code> (\u4e58\u6cd5) + <code>ADD</code> (\u52a0\u6cd5) = 2 \u6761\u6307\u4ee4\u3002</li> <li>\u4f18\u5316\u540e\uff1a<code>FFMA</code> (Fused FMA) = 1 \u6761\u6307\u4ee4\u3002</li> <li>\u4f18\u5316\u624b\u6bb5\uff1a \u7f16\u8bd1\u5668\u901a\u5e38\u4f1a\u81ea\u52a8\u4f18\u5316\u3002\u4f46\u5728\u624b\u5199 intrinsic \u65f6\uff0c\u786e\u4fdd\u8c03\u7528 <code>__fmaf_rn(a, b, c)</code> \u800c\u4e0d\u662f\u5206\u5f00\u5199\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#examples","title":"Examples","text":"<ul> <li>Memory-Bound Vector Add\uff1a\u4e00\u6b65\u6b65\u5b9e\u73b0 CUDA Vector Add \u4f18\u5316</li> <li>Compute-Bound GEMM: \u4ece GEMM \u5b9e\u8df5 CUDA \u4f18\u5316</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#cuda","title":"CUDA \u5e38\u7528\u4f18\u5316\u6280\u5de7","text":"","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#maximize-compiler-computationgpu-miarch","title":"Maximize Compiler Computation[^gpu-miarch]","text":"<ul> <li>Unroll Loops <p>\u5c55\u5f00\u5faa\u73af\uff08loop unrolling\uff09\uff0c\u8ba9\u5faa\u73af\u4f53\u91cd\u590d\u5c55\u5f00\u591a\u6b21\uff0c\u51cf\u5c11\u5faa\u73af\u63a7\u5236\u5f00\u9500\uff08\u6bd4\u5982 i++\u3001i\\&lt;N \u7684\u5224\u65ad\uff09\uff0c\u63d0\u9ad8 GPU \u7684\u541e\u5410\u91cf\u3002</p> </li> <li>Write code using compile-time constants (not same as constant registers) <p>\u5728\u4ee3\u7801\u91cc\u7528 \u7f16\u8bd1\u671f\u5df2\u77e5\u7684\u5e38\u91cf\u6765\u505a\u7d22\u5f15\u3001\u5faa\u73af\u6b21\u6570\u3001\u6570\u7ec4\u5927\u5c0f\u7b49\uff0c\u800c\u4e0d\u662f\u4f9d\u8d56 GPU \u7684\u5e38\u91cf\u5bc4\u5b58\u5668</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#coalescing-memory-access","title":"Coalescing Memory Access","text":"<ul> <li> <p>\u5f53\u4e00\u4e2a Warp \u4e2d\u7684\u6240\u6709 32 \u4e2a\u7ebf\u7a0b\u8bbf\u95ee\u5168\u5c40\u5185\u5b58\u4e2d\u7684\u8fde\u7eed\u4f4d\u7f6e\u65f6\uff0c\u786c\u4ef6\u53ef\u4ee5\u5c06\u8fd9 32 \u4e2a\u5c0f\u7684\u8bf7\u6c42\u201c\u5408\u5e76\u201d\u6210\u4e00\u4e2a\u5355\u4e00\u3001\u5927\u578b\u3001\u9ad8\u6548\u7684\u5185\u5b58\u4e8b\u52a1</p> </li> <li> <p>Memory Access Patterns:</p> </li> <li> <p>\u5408\u5e76\u8bbf\u95ee\uff08\u7406\u60f3\uff09\uff1aWarp \u4e2d\u7684\u7ebf\u7a0b i \u8bbf\u95ee\u5185\u5b58\u5730\u5740 base + i\u3002\u8fd9\u5728\u5904\u7406\u6309\u884c\u4e3b\u5e8f\u5b58\u50a8\u7684\u77e9\u9635\u7684\u884c\u65f6\u975e\u5e38\u5e38\u89c1</p> <p></p> </li> <li> <p>\u8de8\u6b65\u8bbf\u95ee\uff08\u95ee\u9898\uff09\uff1a\u7ebf\u7a0b i \u8bbf\u95ee base + i * stride\u3002\u5982\u679c\u6b65\u957f\uff08stride\uff09\u5f88\u5927\uff0c\u8fd9\u5c06\u5bfc\u81f4\u8bb8\u591a\u72ec\u7acb\u7684\u3001\u4f4e\u6548\u7684\u5185\u5b58\u4e8b\u52a1\u3002\u8fd9\u5728\u8bbf\u95ee\u6309\u884c\u4e3b\u5e8f\u5b58\u50a8\u7684\u77e9\u9635\u7684\u5217\u65f6\u5f88\u5e38\u89c1</p> <p></p> </li> <li> <p>\u975e\u5bf9\u9f50\u8bbf\u95ee\uff1aWarp \u8bbf\u95ee\u7684\u8d77\u59cb\u5730\u5740\u672a\u4e0e\u5185\u5b58\u4e8b\u52a1\u7684\u5927\u5c0f\u5bf9\u9f50</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#avoid-bank-conflicts-in-shared-memory","title":"Avoid Bank Conflicts in Shared Memory","text":"<p> Shared memory is organized into 32 banks. Each bank is a slice of SRAM that can load or store 4 bytes of data every cycle.</p> <p></p> <ul> <li>\u5f53\u4e00\u4e2a Warp \u4e2d\u7684\u6240\u6709 32 \u4e2a\u7ebf\u7a0b\u8bbf\u95ee\u5168\u5c40\u5185\u5b58\u4e2d\u7684\u8fde\u7eed\u4f4d\u7f6e\u65f6\uff0c\u786c\u4ef6\u53ef\u4ee5\u5c06\u8fd9 32 \u4e2a\u5c0f\u7684\u8bf7\u6c42 \u201c\u5408\u5e76\u201d\u6210\u4e00\u4e2a\u5355\u4e00\u3001\u5927\u578b\u3001\u9ad8\u6548\u7684\u5185\u5b58\u4e8b\u52a1</li> </ul> <p></p> <ul> <li>\u5f53\u540c\u4e00\u4e2a Warp \u4e2d\u7684\u4e24\u4e2a\u6216\u66f4\u591a\u7ebf\u7a0b\u8bd5\u56fe\u8bbf\u95ee\u4f4d\u4e8e\u540c\u4e00\u4e2a\u5185\u5b58\u94f6\u884c\u4e2d\u7684\u4e0d\u540c\u5730\u5740\u65f6\uff0c\u5c31\u4f1a\u53d1\u751f\u94f6\u884c\u51b2\u7a81 \u3002\u6b64\u65f6\uff0c\u8fd9\u4e9b\u8bbf\u95ee\u4f1a\u88ab\u4e32\u884c\u5316\u5904\u7406\uff0c\u4ece\u800c\u964d\u4f4e\u4e86\u5171\u4eab\u5185\u5b58\u7684\u6709\u6548\u5e26\u5bbd</li> </ul> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#solutionsbankconflict","title":"Solutions[^bankconflict]","text":"<ul> <li>Padding: \u5728\u6570\u636e\u7ed3\u6784\u4e2d\u63d2\u5165\u586b\u5145\u5143\u7d20\uff0c\u4ee5\u6539\u53d8\u6570\u636e\u5728\u5185\u5b58\u4e2d\u7684\u5e03\u5c40\uff0c\u907f\u514d\u591a\u4e2a\u7ebf\u7a0b\u8bbf\u95ee\u540c\u4e00\u94f6\u884c</li> <li>\u53ef\u80fd\u964d\u4f4e SM \u7684 occupancy</li> <li>\u53ef\u80fd\u5730\u5740\u8bbf\u95ee\u4e0d\u5bf9\u9f50\uff0c\u65e0\u6cd5\u4f7f\u7528\u5411\u91cf\u5316\u8bbf\u95ee</li> <li>Swizzling (XOR Swizzling): \u91cd\u65b0\u7ec4\u7ec7\u6570\u636e\u7684\u5b58\u50a8\u65b9\u5f0f\uff0c\u4f7f\u5f97\u5e76\u884c\u8bbf\u95ee\u65f6\u66f4\u5c11\u51b2\u7a81(\u66f4\u5e38\u7528)</li> <li> <p>\u539f\u7406\uff1a \u901a\u8fc7\u5bf9\u5730\u5740\u4f4d\u8fdb\u884c\u5f02\u6216\u64cd\u4f5c\uff0c\u6253\u4e71 Bank \u7684\u6620\u5c04\u5173\u7cfb\u3002</p> </li> <li> <p>\u516c\u5f0f\u793a\u4f8b\uff1a <code>bank_id = ((addr / 4) / 8) ^ ((addr / 4) % 32)</code> (\u7b80\u5316\u7248)\u3002</p> </li> <li> <p>LDGSTS (Load Global Store Shared): \u73b0\u4ee3\u67b6\u6784 (Ampere+) \u63d0\u4f9b\u4e86 <code>cp.async</code> \u7b49\u6307\u4ee4\uff0c\u786c\u4ef6\u81ea\u52a8\u5904\u7406 Swizzled \u5b58\u50a8\uff0c\u4e0d\u9700\u8981\u7a0b\u5e8f\u5458\u624b\u52a8\u8ba1\u7b97\u590d\u6742\u7684\u5730\u5740\u6620\u5c04\u3002</p> </li> <li> <p>\u67d0\u4e9b swizzling \u65b9\u6cd5\u5728\u4ece shared memory \u8bfb\u6570\u636e\u5230 register \u65f6\u4e0d\u80fd\u8fdb\u884c float4 \u7684\u5408\u5e76\u8bfb\u53d6</p> <p></p> </li> <li> <p>\u903b\u8f91\u4f4d\u7f6e\u8868\u793a\u5143\u7d20\u5728\u77e9\u9635\u4e2d\u7684\u903b\u8f91\u5750\u6807\u3002</p> </li> <li> <p>\u7269\u7406\u4f4d\u7f6e\u8868\u793a\u5176\u5bf9\u5e94\u5143\u7d20\u5728\u5b9e\u9645\u5b58\u50a8\u6570\u636e\u7684 shared memory \u4e2d\u7684\u4f4d\u7f6e\u5750\u6807\u3002</p> <p>\u5f53\u6211\u4eec\u8bf4\u8bfb\u53d6\u77e9\u9635\u7684\u7b2c 2 \u884c\u7b2c 3 \u5217\u7684\u5143\u7d20\uff0c(2,3)\u5c31\u8868\u793a\u903b\u8f91\u4f4d\u7f6e\uff0c\u800c\u771f\u6b63\u8bfb\u53d6\u6570\u636e\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u4ece\u5b9e\u9645\u5b58\u50a8\u6570(2,1)\u7684 shared memory \u4e2d\u5bf9\u5e94\u7684\u4f4d\u7f6e</p> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#matmul-bank-conflict-avoidance-examplebankconflict2","title":"Matmul Bank Conflict Avoidance Example[^bankconflict2]","text":"C++<pre><code>const int warp_id = tid / 32;\nconst int lane_id = tid % 32;\nconst int a_tile_index =  warp_id / 2 * 16 + lane_id / 8 * 4\nconst int b_tile_index =  warp_id % 2 * 32 + lane_id % 8 * 4;\n</code></pre> <p>\u4f7f\u7528\u7684\u662f 4\u00d72 \u7684 warp \u5e03\u5c40, warp \u4e2d\u7684\u6bcf\u4e2a\u7ebf\u7a0b\u6309\u7167 4\u00d78 \u8fdb\u884c\u6392\u5e03, \u6bcf\u4e2a warp \u5bf9\u5e94 16\u00d732 \u7684\u6570\u636e</p> <ul> <li>\u6bcf\u4e2a wrap 32 \u4e2a\u7ebf\u7a0b\u53ea\u83b7\u53d6 As \u7684 4*4=16 \u4e2a\u6570\u636e</li> <li>\u6bcf\u4e2a wrap 32 \u4e2a\u7ebf\u7a0b\u53ea\u83b7\u53d6 Bs \u7684 8*4=32 \u4e2a\u6570\u636e</li> <li> \u5e7f\u64ad (Broadcast): \u5982\u679c\u4e00\u4e2a Warp \u4e2d\u7684\u6240\u6709\u7ebf\u7a0b\u8bbf\u95ee\u540c\u4e00\u4e2a bank \u4e2d\u7684\u5b8c\u5168\u76f8\u540c\u7684\u5730\u5740\uff0c\u8fd9\u662f\u4e00\u79cd\u5e7f\u64ad\u64cd\u4f5c\uff0c\u4e0d\u4f1a\u4ea7\u751f\u51b2\u7a81</li> </ul> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#double-bufferingbankconflict2","title":"Double Buffering[^bankconflict2]","text":"<p>\u5728\u5171\u4eab\u5185\u5b58\u4e2d\u5206\u914d\u4e24\u4e2a\u7f13\u51b2\u533a: \u5f53 SM \u6b63\u5728\u5bf9\u7f13\u51b2\u533a 1 \u4e2d\u7684\u6570\u636e\u8fdb\u884c\u8ba1\u7b97\u65f6\uff0c\u786c\u4ef6\u53ef\u4ee5\u5f02\u6b65\u5730\u5c06\u4e0b\u4e00\u5757\u6570\u636e\u4ece\u5168\u5c40\u5185\u5b58\u9884\u53d6\u5230\u7f13\u51b2\u533a 2 \u4e2d\u3002\u4e00\u65e6\u8ba1\u7b97\u5b8c\u6210\uff0c\u4e24\u4e2a\u7f13\u51b2\u533a\u7684\u89d2\u8272\u4e92\u6362\u3002\u8fd9\u79cd\u65b9\u5f0f\u6709\u6548\u5730\u5c06\u5168\u5c40\u5185\u5b58\u7684\u8bbf\u95ee\u5ef6\u8fdf\u9690\u85cf\u5728\u4e86\u8ba1\u7b97\u7684\u80cc\u540e </p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#warp-shuffle-reduction","title":"Warp Shuffle &amp; Reduction","text":"<p>\u5728 Softmax \u548c LayerNorm \u7b49 Memory-bound \u7b97\u5b50\u4e2d\uff0c\u74f6\u9888\u5f80\u5f80\u5728\u4e8e\u89c4\u7ea6 (Reduction) \u64cd\u4f5c\uff08\u5982\u6c42 Max \u6216 Sum\uff09\u3002</p> <ul> <li>\u4f20\u7edf\u65b9\u6cd5\uff1a \u4f7f\u7528 Shared Memory \u8fdb\u884c\u6811\u72b6\u89c4\u7ea6\u3002\u7f3a\u70b9\u662f\u9700\u8981\u9891\u7e41\u8bfb\u5199 Shared Memory\uff0c\u4e14\u9700\u8981 <code>__syncthreads()</code> \u540c\u6b65\u3002</li> <li>\u4f18\u5316\u65b9\u6cd5\uff1a \u4f7f\u7528 Warp Shuffle API \u5728\u5bc4\u5b58\u5668\u4e4b\u95f4\u76f4\u63a5\u901a\u4fe1\u3002</li> <li><code>__shfl_down_sync(mask, val, delta)</code>: \u5c06\u6570\u636e\u4ece\u5f53\u524d\u7ebf\u7a0b\u5411\u4e0b\u4f20\u9012\u7ed9 ID \u4e3a <code>tid + delta</code> \u7684\u7ebf\u7a0b\u3002</li> <li><code>__shfl_xor_sync(mask, val, laneMask)</code>: \u8774\u8776\u4ea4\u6362 (Butterfly Exchange)\uff0c\u7528\u4e8e\u5168\u89c4\u7ea6\u3002</li> <li>Block Reduce: \u5f53\u4e00\u884c\u6570\u636e\u8d85\u8fc7 32 \u4e2a\uff08\u6bd4\u5982 hidden_size=4096\uff09\u65f6\uff0c\u5982\u4f55\u8de8 Warp \u8fdb\u884c\u89c4\u7ea6\uff1f</li> <li>\u7b56\u7565\uff1aWarp Reduce -&gt; \u5b58\u5165 Shared Memory -&gt; \u6700\u540e\u4e00\u4e2a Warp \u518d\u8bfb\u51fa\u6765 Reduce\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#tilematmul","title":"Tile[^matmul]","text":"<ul> <li> <p>\u5c06\u539f\u672c\u4e00\u884c \u00d7 \u4e00\u5217\u7684\u8ba1\u7b97\u8fdb\u884c\u5206\u5757\uff0c\u6bcf\u6b21\u53ea\u8ba1\u7b97\u4e00\u5757</p> </li> <li> <p>\u4e00\u6b21\u6027\u4ece\u5168\u5c40\u5185\u5b58\u4e2d\u52a0\u8f7d\u4e00\u5c0f\u5757 A (BM x BK) \u548c\u4e00\u5c0f\u5757 B (BK x BN) \u5230\u5171\u4eab\u5185\u5b58\u4e2d</p> </li> <li> <p>\u4e00\u4e2a\u7ebf\u7a0b\u5757\u5185\u7684\u6240\u6709\u7ebf\u7a0b\u5c31\u53ef\u4ee5\u5728\u5171\u4eab\u5185\u5b58\u4e0a\u5feb\u901f\u5730\u8fdb\u884c\u5927\u91cf\u7684\u8ba1\u7b97\uff0c\u4ee5\u5b8c\u6210\u5bf9\u5e94\u7684\u4e00\u5c0f\u5757 C (BM x BN) \u7684\u8ba1\u7b97</p> </li> <li> <p>\u6bcf\u4e2a\u7ebf\u7a0b\u4e0d\u518d\u662f\u53ea\u8ba1\u7b97 C \u5757\u4e2d\u7684\u4e00\u4e2a\u5143\u7d20\uff0c\u800c\u662f\u8d1f\u8d23\u8ba1\u7b97\u4e00\u4e2a\u66f4\u5c0f\u7684\u7ed3\u679c\u7f51\u683c\uff08\u56fe\u4e2d\u662f 2x2\uff09\u3002\u8fd9\u6837\u505a\u53ef\u4ee5\u8fdb\u4e00\u6b65\u63d0\u5347\u6570\u636e\u590d\u7528\u7387\u548c\u8ba1\u7b97\u6548\u7387</p> </li> </ul> <p></p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#wrap-tilematmul","title":"Wrap Tile[^matmul]","text":"<ul> <li>\u7ebf\u7a0b\u5757\u5206\u7247(blocktiling): \u4e0d\u540c\u7684\u7ebf\u7a0b\u5757\u53ef\u4ee5\u5728\u4e0d\u540c\u7684 SM \u4e0a\u5e76\u884c\u6267\u884c.</li> <li>warp \u5206\u7247(warptiling): \u4e0d\u540c\u7684 warp \u53ef\u4ee5\u5728\u4e0d\u540c\u7684 warp \u8c03\u5ea6\u5668\u4e0a\u5e76\u884c\u6267\u884c, \u4e5f\u53ef\u4ee5\u5728\u540c\u4e00\u4e2a warp \u8c03\u5ea6\u5668\u4e0a\u5e76\u53d1\u6267\u884c.</li> <li>\u7ebf\u7a0b\u5206\u7247(threadtiling): (\u6570\u91cf\u975e\u5e38\u6709\u9650\u7684)\u6307\u4ee4\u53ef\u4ee5\u5728\u76f8\u540c\u7684 CUDA \u5185\u6838\u4e0a\u5e76\u884c\u6267\u884c(=\u6307\u4ee4\u7ea7\u5e76\u884c, instruction-level parallelism, \u5373 ILP).</li> </ul> <p>Note</p> <p>\u5b9e\u9645\u4e0a\uff0c WMMA \u5c31\u662f Warp Tile \u7684\u4e00\u79cd\u5b9e\u73b0</p>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#transformer","title":"Transformer \u5185\u90e8\u7b97\u5b50\u4f18\u5316","text":"","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#softmax-layernorm","title":"Softmax &amp; LayerNorm \u4f18\u5316","text":"<p>\u8fd9\u4e24\u4e2a\u7b97\u5b50\u662f\u5178\u578b\u7684 Memory-bound \u7b97\u5b50\u3002</p> <ul> <li>Softmax: \\(Softmax(x_i) = \\\\frac{e^{x_i - x\\_{max}}}{\\\\sum e^{x_j - x\\_{max}}}\\)</li> <li>\u9700\u8981\u4e24\u6b21\u89c4\u7ea6\uff1a\u4e00\u6b21\u6c42 Max\uff0c\u4e00\u6b21\u6c42 Sum\u3002</li> <li>\u4f18\u5316\u6838\u5fc3\uff1a\u4f7f\u7528 Warp Shuffle \u8fdb\u884c\u5bc4\u5b58\u5668\u7ea7\u89c4\u7ea6\uff0c\u51cf\u5c11 Shared Memory \u8bbf\u95ee\u3002</li> <li>LayerNorm: \u9700\u8981\u6c42 Mean \u548c Variance\u3002</li> <li>\u540c\u6837\u4f9d\u8d56\u9ad8\u6548\u7684 Block Reduce\u3002</li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#flash-attention","title":"Flash Attention \u4f18\u5316","text":"<p>Standard Attention \u7684\u75db\u70b9\u5728\u4e8e \\(N \\\\times N\\) \u7684 Attention Matrix \u592a\u5927\uff0c\u5199\u56de HBM \u518d\u8bfb\u56de\u6765\u505a Softmax\uff0c\u5e26\u5bbd\u6491\u4e0d\u4f4f\u3002</p> <ul> <li>\u6838\u5fc3\u601d\u60f3\uff1a   1. Tiling (\u5206\u5757): \u5c06 Q, K, V \u5207\u5206\u6210\u5c0f\u5757\uff0c\u52a0\u8f7d\u5230 SRAM (Shared Memory) \u4e2d\u8ba1\u7b97\u3002   1. Recomputation (\u91cd\u8ba1\u7b97): \u4e3a\u4e86\u4e0d\u5b58\u50a8 \\(N \\\\times N\\) \u7684\u4e2d\u95f4\u77e9\u9635\uff0c\u53cd\u5411\u4f20\u64ad\u65f6\u5b81\u613f\u91cd\u65b0\u8ba1\u7b97\u4e00\u904d\u524d\u5411\u8fc7\u7a0b\u3002   1. Online Softmax: \u8fd9\u662f\u4e00\u4e2a\u6570\u5b66\u6280\u5de7\uff0c\u5141\u8bb8 Softmax \u5206\u5757\u8ba1\u7b97\uff0c\u4e0d\u9700\u8981\u7b49\u770b\u5230\u5168\u5c40\u6700\u5927\u503c\u3002<ul> <li>\u7ef4\u62a4\u5c40\u90e8\u7684 max \u548c sum\uff0c\u5f53\u5904\u7406\u65b0\u7684\u5757\u65f6\uff0c\u66f4\u65b0\u5168\u5c40\u7684 max \u548c sum\u3002</li> </ul> </li> </ul>","tags":["CUDA"]},{"location":"notes/cuda/cudaopt/#_2","title":"\u53c2\u8003\u8d44\u6599","text":"<p>[^cuda1]: CUDA\uff08\u4e00\uff09\uff1aCUDA \u7f16\u7a0b\u57fa\u7840 [^cuda2]: CUDA\uff08\u4e8c\uff09\uff1aGPU \u7684\u5185\u5b58\u4f53\u7cfb\u53ca\u5176\u4f18\u5316\u6307\u5357 [^matmul]: [CUDA \u5b66\u4e60\u7b14\u8bb0] \u5982\u4f55\u4f18\u5316 CUDA \u77e9\u9635\u4e58\u5185\u6838\u4ee5\u83b7\u5f97\u7c7b\u4f3c cuBLAS \u7684\u6027\u80fd: \u5de5\u4f5c\u65e5\u5fd7 [^gpu-miarch]: EE 7722, Lecture Slides: NVIDIA GPU Microarchitecture [^bankconflict]: CUDA shared memory \u907f\u514d bank conflict \u7684 swizzling \u673a\u5236\u89e3\u6790 [^bankconflict2]: GEMM \u4f18\u5316: \u53cc\u7f13\u51b2 (Prefetch) \u548c Bank Conflict \u89e3\u51b3</p>","tags":["CUDA"]},{"location":"notes/cuda/reduce/","title":"Reduce","text":"<p> \u7ea6 205 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-102025-12-13 <p>\u8fd9\u79cd\u53eb Single Pass Reduction (\u5355\u6b21\u5f52\u7ea6)\uff0c\u4f46\u5b9e\u73b0\u8d77\u6765\u6bd4\u8f83\u590d\u6742\uff0c\u4e3b\u8981\u6709\u4e24\u79cd\u601d\u8def\uff1a</p> <p>\u539f\u5b50\u52a0 (Atomic Add)\uff1a</p> <p>\u6240\u6709 Block \u7b97\u5b8c\u540e\uff0c\u76f4\u63a5 atomicAdd(global_final_sum, block_sum)\u3002</p> <p>\u7f3a\u70b9\uff1a \u539f\u5b50\u64cd\u4f5c\u5728\u6570\u5343\u4e2a Block \u540c\u65f6\u7ade\u4e89\u5199\u5165\u540c\u4e00\u4e2a\u5730\u5740\u65f6\uff0c\u6027\u80fd\u4f1a\u6025\u5267\u4e0b\u964d\uff08\u4e32\u884c\u5316\uff09\uff0c\u901a\u5e38\u4e0d\u5982\u4e24\u6b21 Kernel \u542f\u52a8\u5feb\u3002</p> <p>\u5168\u5c40\u540c\u6b65\u9501 (Global Sync / Last Block Optimization)\uff1a</p> <p>\u5229\u7528\u539f\u5b50\u8ba1\u6570\u5668\u8bb0\u5f55\u5df2\u7ecf\u5b8c\u6210\u7684 Block \u6570\u91cf\u3002\u6700\u540e\u4e00\u4e2a\u5230\u8fbe\u7ec8\u70b9\u7684 Block \u8d1f\u8d23\u628a\u4e4b\u524d\u6240\u6709 Block \u7684\u7ed3\u679c\u52a0\u8d77\u6765\u3002</p> <p>\u7f3a\u70b9\uff1a \u4ee3\u7801\u975e\u5e38\u590d\u6742\uff0c\u5bb9\u6613\u6b7b\u9501\uff0c\u4e14\u4f9d\u8d56 GPU \u5177\u4f53\u7684\u8c03\u5ea6\u884c\u4e3a\uff0c\u4e0d\u5982\u8fd9\u79cd\u201c\u4e24\u6b21\u542f\u52a8\u201d\u7684\u65b9\u6cd5\u7a33\u5065\u548c\u901a\u7528\u3002</p> <p>\u6240\u4ee5\uff0c\u201c\u4e24\u6b21\u542f\u52a8\u5185\u6838\u201d\uff08Recursive Reduction\uff09\u662f\u5de5\u4e1a\u754c\u6700\u6807\u51c6\u3001\u6700\u7a33\u59a5\u7684\u5b9e\u73b0\u65b9\u5f0f\u3002</p>"},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/","title":"\u4ece GEMM \u5b9e\u8df5 CUDA \u4f18\u5316","text":"2025-12-132025-12-13 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#gemm-cuda","title":"\u4ece GEMM \u5b9e\u8df5 CUDA \u4f18\u5316","text":"<p> \u7ea6 4059 \u4e2a\u5b57  194 \u884c\u4ee3\u7801  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 23 \u5206\u949f</p> <p>\ud83d\udcda \u672c\u6587\u5c06\u4ece\u6700 naive \u7684 GEMM \u5b9e\u73b0\u5f00\u59cb\uff0c\u4f7f\u7528 nsight compute \u5de5\u5177\u8fdb\u884c\u6027\u80fd\u5206\u6790\u5bfb\u627e\u74f6\u9888\u5e76\u4e00\u6b65\u6b65\u8fdb\u884c\u4f18\u5316\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6765\u5b9e\u8df5 CUDA \u4e2d\u7684\u5404\u79cd\u4f18\u5316\u6280\u5de7\u3002</p>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#gemm","title":"GEMM \u7b80\u4ecb","text":"<p>General Matrix-Matrix Multiplication\uff08\u901a\u7528\u77e9\u9635\u4e58\u6cd5\uff09\u3002\u5b83\u662f BLAS (Basic Linear Algebra Subprograms) \u6807\u51c6\u5e93\u4e2d\u5b9a\u4e49\u7684\u201c\u7b2c\u4e09\u7ea7\u201d\uff08Level 3\uff09\u8fd0\u7b97\u3002\u5176\u6807\u51c6\u6570\u5b66\u5b9a\u4e49\u5982\u4e0b\uff1a \\(\\(C \\leftarrow \\alpha AB + \\beta C\\)\\) \u5176\u4e2d\uff1a</p> <ul> <li>\\(A, B, C\\) \u662f\u77e9\u9635\u3002</li> <li>\\(\\alpha, \\beta\\) \u662f\u6807\u91cf\uff08Scalar\uff09\u3002</li> <li>\u901a\u5e38\u5047\u8bbe \\(A\\) \u7684\u7ef4\u5ea6\u4e3a \\(M \\times K\\)\uff0c\\(B\\) \u7684\u7ef4\u5ea6\u4e3a \\(K \\times N\\)\uff0c\u5219 \\(C\\) \u7684\u7ef4\u5ea6\u4e3a \\(M \\times N\\)\u3002</li> </ul> <p>\u4e3a\u4ec0\u4e48 GEMM \u5982\u6b64\u91cd\u8981\uff1f</p> <ul> <li>\u6df1\u5ea6\u5b66\u4e60\u7684\u6838\u5fc3\uff1a \u5168\u8fde\u63a5\u5c42\uff08Dense/Linear\uff09\u76f4\u63a5\u5c31\u662f\u77e9\u9635\u4e58\u6cd5\uff1b\u5377\u79ef\u5c42\uff08Convolution\uff09\u901a\u8fc7 Im2Col \u7b49\u53d8\u6362\u540e\uff0c\u672c\u8d28\u4e0a\u4e5f\u662f GEMM\u3002</li> <li>\u8ba1\u7b97\u5bc6\u96c6\u578b\uff1a \u5b83\u662f\u5178\u578b\u7684\u8ba1\u7b97\u5bc6\u96c6\u578b\u4efb\u52a1\uff08Compute Bound\uff09\uff0c\u8fd0\u7b97\u590d\u6742\u5ea6\u4e3a \\(O(N^3)\\)\uff0c\u800c\u6570\u636e\u642c\u8fd0\u590d\u6742\u5ea6\u4e3a \\(O(N^2)\\)\u3002\u8fd9\u610f\u5473\u7740\u4f18\u5316\u5f97\u5f53\uff0c\u53ef\u4ee5\u6781\u9ad8\u5730\u5229\u7528\u786c\u4ef6\u5cf0\u503c\u7b97\u529b\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#_1","title":"\u4f18\u5316\u65b9\u6cd5","text":"","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#naive-gemm","title":"Naive GEMM","text":"<p>Naive GEMM \u4e00\u5171\u4f7f\u7528 M * N \u4e2a\u7ebf\u7a0b\u5b8c\u6210\u6574\u4e2a\u77e9\u9635\u4e58\u6cd5\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u8ba1\u7b97\u7ed3\u679c\u77e9\u9635 \\(C\\) \u7684\u4e00\u4e2a\u5143\u7d20\u3002\u4e0b\u9762\u662f\u4e00\u4e2a\u7b80\u5355\u7684 FP32 GEMM CUDA kernel \u5b9e\u73b0\uff1a</p> C++<pre><code>// FP32\n// GEMM naive: compute one c[i,j]\n// element per threads, all row major\n__global__ void gemm_fp32_kernel(const float *a, const float *b, float *c, int M, int N, int K) {\n  int n = blockIdx.x * blockDim.x + threadIdx.x;\n  int m = blockIdx.y * blockDim.y + threadIdx.y;\n\n  if (m &lt; M &amp;&amp; n &lt; N) {\n    float psum = 0.0;\n#pragma unroll\n    for (int k = 0; k &lt; K; k++) {\n      // m row in a matrix, n col in b matrix\n      psum += a[m * K + k] * b[k * N + n];\n    }\n    c[m * N + n] = psum;  // c[m,n]\n  }\n}\n</code></pre> <p></p>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#tiling","title":"Tiling \u4f18\u5316","text":"<ul> <li>Block Tile: \u6bcf\u4e2a Block \u8d1f\u8d23\u8ba1\u7b97\u77e9\u9635 C \u4e2d\u7684\\(BM \\times BN\\)\u4e2a\u5143\u7d20\uff1b</li> <li>K Tile: \u5faa\u73af\\(K / BK\\)\u6b21\uff0c\u4e00\u4e2a Block \u7684\u6240\u6709\u7ebf\u7a0b\u6bcf\u6b21\u4e00\u8d77\u4ece Global Memory \u4e2d load \\(BM \\times BK\\)\u4e2a\u77e9\u9635 A \u7684\u5143\u7d20\u548c\\(BK \\times BN\\)\u4e2a\u77e9\u9635 B \u7684\u5143\u7d20\uff1b</li> <li>Thread Tile: \u6bcf\u4e2a Thread \u8d1f\u8d23\u8ba1\u7b97\u77e9\u9635 C \u4e2d\u7684\\(TM \\times TN\\)\u4e2a\u5143\u7d20\u3002</li> <li>Shared Memory: \u6bcf\u4e2a Block \u5206\u914d Shared Memory \u6765\u5b58\u50a8\u4ece Global Memory \u52a0\u8f7d\u7684\u77e9\u9635 A \u548c\u77e9\u9635 B \u7684 Tile \u6570\u636e\uff0c\u51cf\u5c11\u5bf9 Global Memory \u7684\u8bbf\u95ee\u6b21\u6570\uff0c\u63d0\u9ad8\u6570\u636e\u91cd\u7528\u7387\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#_2","title":"\u5206\u6790","text":"<ul> <li>Block Level (\u7ebf\u7a0b\u5757\u7ea7):</li> <li>\\(BM \\times BN\\): \u4e00\u4e2a CUDA Block \u8d1f\u8d23\u8ba1\u7b97 \\(C\\) \u77e9\u9635\u4e2d\u5927\u5c0f\u4e3a \\(BM \\times BN\\) \u7684\u4e00\u4e2a\u5b50\u5757\u3002</li> <li>\\(BK\\): \u6bcf\u6b21\u5faa\u73af\uff08K \u7ef4\u5ea6\uff09\u52a0\u8f7d\u5230 Shared Memory \u4e2d\u7684\u6b65\u957f\u3002</li> <li>\u76ee\u7684: \u5229\u7528 Shared Memory \u590d\u7528\u6570\u636e\uff0c\u51cf\u5c11 Global Memory \u8bbf\u95ee\u3002</li> <li>Thread Level (\u7ebf\u7a0b\u7ea7):</li> <li>\\(TM \\times TN\\): \u4e00\u4e2a CUDA Thread \u8d1f\u8d23\u8ba1\u7b97 Block \u5b50\u5757\u4e2d\u5927\u5c0f\u4e3a \\(TM \\times TN\\) \u7684\u5fae\u5c0f\u5757\u3002</li> <li>\u76ee\u7684: \u5229\u7528 Register (\u5bc4\u5b58\u5668) \u590d\u7528\u6570\u636e\u3002\u5bc4\u5b58\u5668\u6bd4 Shared Memory \u66f4\u5feb\uff0c\u4e14\u662f\u96f6\u5ef6\u8fdf\u7684</li> </ul> <p>\u8ba1\u7b97\u8bbf\u5b58\u6bd4(AI)</p> \\[ Loads = ( \\frac{1}{BN} + \\frac{1}{BM} ) \\times MNK \\] <ul> <li>\u8ba1\u7b97\u91cf: \\(2MNK\\) (\u6d6e\u70b9\u8fd0\u7b97\u6b21\u6570) \u662f\u56fa\u5b9a\u7684\u3002</li> <li>\u8bbf\u5b58\u91cf: \u968f\u7740 \\(BM\\) \u548c \\(BN\\) \u589e\u5927\uff0c\u603b\u8bbf\u5b58\u6b21\u6570\u4e0b\u964d\u3002</li> </ul> <p>\u6211\u4eec\u5e0c\u671b\u5c3d\u53ef\u80fd\u589e\u5927 \\(BM\\) \u548c \\(BN\\)\uff0c\u4ee5\u63d0\u9ad8\u8ba1\u7b97\u8bbf\u5b58\u6bd4 (AI)\uff0c\u4ece\u800c\u63d0\u5347\u6027\u80fd\uff1b\u4e5f\u5e0c\u671b\u589e\u5927 \\(TM\\) \u548c \\(TN\\)\uff0c\u4ee5\u63d0\u9ad8\u5bc4\u5b58\u5668\u6570\u636e\u590d\u7528\u7387\u3002\u4f46\u662f\uff0c\u589e\u5927\u8fd9\u4e9b\u53c2\u6570\u4f1a\u589e\u52a0 Shared Memory \u548c\u5bc4\u5b58\u5668\u7684\u4f7f\u7528\u91cf\uff0c\u4ece\u800c\u964d\u4f4e\u5e76\u53d1\u5ea6 (Occupancy)\u3002\u56e0\u6b64\uff0c\u9700\u8981\u5728\u8ba1\u7b97\u8bbf\u5b58\u6bd4\u548c\u5e76\u53d1\u5ea6\u4e4b\u95f4\u8fdb\u884c\u6743\u8861\u3002</p> <p>Occupancy \u53d7\u4ee5\u4e0b\u56e0\u7d20\u5f71\u54cd\uff1a</p> <ul> <li>Shared Memory \u5bb9\u91cf (\u9650\u5236 BM, BN, BK)</li> <li>\u516c\u5f0f\uff1a\\(Bytes = BK \\times (BM + BN) \\times 4 \\text{ (float size)}\\)</li> <li>Double Buffering: \u4e3a\u4e86\u63a9\u76d6\u8bbf\u5b58\u5ef6\u8fdf\uff0c\u901a\u5e38\u4f7f\u7528\u53cc\u7f13\u51b2\uff08\u5728\u8ba1\u7b97\u5f53\u524d\u5757\u65f6\u52a0\u8f7d\u4e0b\u4e00\u5757\uff09\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u9700\u6c42\u7ffb\u500d\uff1a\\(\\(Bytes_{Total} = 2 \\times BK \\times (BM + BN) \\times 4\\)\\)</li> <li>\u5bc4\u5b58\u5668\u538b\u529b (Register Pressure) (\u9650\u5236 TM, TN)</li> <li>\u7d2f\u52a0\u5668\u6d88\u8017: \u6bcf\u4e2a\u7ebf\u7a0b\u5fc5\u987b\u72ec\u81ea\u7ef4\u62a4 \\(TM \\times TN\\) \u4e2a \\(C\\) \u77e9\u9635\u7684\u5143\u7d20\u3002\u8fd9\u4e9b\u5143\u7d20\u5fc5\u987b\u4e00\u76f4\u9a7b\u7559\u5728\u5bc4\u5b58\u5668\u4e2d\u76f4\u5230\u8ba1\u7b97\u7ed3\u675f\u3002</li> <li>\u5982\u679c \\(TM=8, TN=8\\)\uff0c\u4ec5 \\(C\\) \u7684\u90e8\u5206\u548c\u5c31\u9700\u8981 64 \u4e2a\u5bc4\u5b58\u5668\u3002</li> <li>\u52a0\u4e0a\u52a0\u8f7d \\(A, B\\) \u7684\u4e34\u65f6\u5bc4\u5b58\u5668\u3001\u7d22\u5f15\u8ba1\u7b97\u3001\u5faa\u73af\u53d8\u91cf\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u80fd\u6d88\u8017 80-100 \u4e2a\u5bc4\u5b58\u5668\u3002</li> <li>\u7ebf\u7a0b\u5e76\u884c\u5ea6 (Thread Level Parallelism)</li> <li>\u516c\u5f0f\uff1a\\(ThreadsPerBlock = \\frac{BM \\times BN}{TM \\times TN}\\)</li> <li>\u786c\u9650\u5236: CUDA \u89c4\u5b9a\u4e00\u4e2a Block \u6700\u591a 1024 \u4e2a\u7ebf\u7a0b\u3002</li> <li>\u8f6f\u9650\u5236: \u7ebf\u7a0b\u6570\u6700\u597d\u662f 32 (Warp Size) \u7684\u500d\u6570\u3002</li> </ul> C++<pre><code>// gemm: Block Tile + Thread Tile + K Tile + Vec4, with smem\n// BK:TILE_K=8 BM=BN=128\n// TM=TN=8 \u589e\u52a0\u8ba1\u7b97\u5bc6\u5ea6 BM/TM=16 BN/TN=16\n// dim3 blockDim(BN/TN, BM/TM);\n// dim3 gridDim((N + BN - 1) / BN, (M + BM - 1) / BM)\ntemplate &lt;const int BM = 128, const int BN = 128, const int BK = 8, const int TM = 8,\n          const int TN = 8&gt;\n__global__ void gemm_t_8x8_sliced_k_f32x4_kernel(float *a, float *b, float *c, int M, int N,\n                                                 int K) {\n  // [1]  Block Tile: \u4e00\u4e2a16x16\u7684block\u5904\u7406C\u4e0a\u5927\u5c0f\u4e3a128X128\u7684\u4e00\u4e2a\u76ee\u6807\u5757\n  // [2] Thread Tile: \u6bcf\u4e2athread\u8d1f\u8d23\u8ba1\u7b97TM*TN(8*8)\u4e2a\u5143\u7d20\uff0c\u589e\u52a0\u8ba1\u7b97\u5bc6\u5ea6\n  // [3]      K Tile: \u5c06K\u5206\u5757\uff0c\u6bcf\u5757BK\u5927\u5c0f\uff0c\u8fed\u4ee3(K+BK-1/BK)\u6b21\uff0c\n  //                  \u6bcf\u6b21\u8ba1\u7b97TM*TN\u4e2a\u5143\u7d20\u5404\u81ea\u7684\u90e8\u5206\u4e58\u7d2f\u52a0\n  // [4]   Vectorize: \u51cf\u5c11load\u548cstore\u6307\u4ee4\uff0c\u4f7f\u7528float4\n  int bx = blockIdx.x;\n  int by = blockIdx.y;\n  int tx = threadIdx.x;\n  int ty = threadIdx.y;\n  int tid = threadIdx.y * blockDim.x + tx;  // tid within the block\n  __shared__ float s_a[BM][BK], s_b[BK][BN];\n\n  // 0. \u5148\u8ba1\u7b97shared memory\u4e2d\u7684\u7d22\u5f15\n  // 1024 \u4e2a\u5143\u7d20\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u8bfb4\u4e2a\u5143\u7d20\uff0c\u9700\u8981256\u4e2a\u7ebf\u7a0b\n  int load_smem_a_m = tid / 2;\n  int load_smem_a_k = (tid % 2 == 0) ? 0 : 4;\n  int load_smem_b_k = tid / 32;\n  int load_smem_b_n = (tid % 32) * 4;\n  // 1. \u518d\u8ba1\u7b97\u5168\u5c40\u5185\u5b58\u4e2d\u7684\u7d22\u5f15\n  int load_gmem_a_m = by * BM + load_smem_a_m;  // global row of a and c\n  int load_gmem_b_n = bx * BN + load_smem_b_n;  // global col of b and c\n\n  float r_c[TM][TN];\n  for (int bk = 0; bk &lt; (K + BK - 1) / BK; ++bk) {\n    // 2. \u8ba1\u7b97\u6bcf\u6b21\u52a0\u8f7d\u5230smem\u7684A\u548cB\u77e9\u9635\u5143\u7d20\u5728\u5168\u5c40\u5185\u5b58\u4e2d\u7684\u5217\u6570\u548c\u884c\u6570\n    int load_gmem_a_k = bk * BK + load_smem_a_k;\n    int load_gmem_a_addr = load_gmem_a_m * K + load_gmem_a_k;\n    FLOAT4(s_a[load_smem_a_m][load_smem_a_k]) =\n        FLOAT4(a[load_gmem_a_addr]);  // load A to shared memory\n\n    int load_gmem_b_k = bk * BK + load_smem_b_k;\n    int load_gmem_b_addr = load_gmem_b_k * N + load_gmem_b_n;\n    FLOAT4(s_b[load_smem_b_k][load_smem_b_n]) =\n        FLOAT4(b[load_gmem_b_addr]);  // load B to shared memory\n    __syncthreads();\n\n    // 3. \u8ba1\u7b97\u7ebf\u7a0b\u8d1f\u8d23\u7684TMxTN\u4e2a\u5143\u7d20\u7684\u90e8\u5206\u4e58\u52a0\n#pragma unroll\n    for (int k = 0; k &lt; BK; ++k) {\n#pragma unroll\n      for (int m = 0; m &lt; TM; ++m) {\n#pragma unroll\n        for (int n = 0; n &lt; TN; ++n) {\n          int comp_smem_a_m = ty * TM + m;\n          int comp_smem_b_n = tx * TN + n;\n          r_c[m][n] += s_a[comp_smem_a_m][k] * s_b[k][comp_smem_b_n];\n        }\n      }\n    }\n    __syncthreads();\n  }\n\n// 4. store output\n#pragma unroll\n  for (int m = 0; m &lt; TM; ++m) {\n    int store_gmem_c_m =\n        by * BM + ty * TM +\n        m;  // \u5927\u5206\u5757\u7684\u8d77\u59cb\u884c\u53f7by * BM + \u5c0f\u5206\u5757\u7684\u8d77\u59cb\u884c\u53f7ty * TM + \u5c0f\u5206\u5757\u5185\u90e8\u7684\u76f8\u5bf9\u884c\u53f7 m\n#pragma unroll\n    for (int n = 0; n &lt; TN; ++n) {\n      int store_gmem_c_n =\n          bx * BN + tx * TN +\n          n;  // \u5927\u5206\u5757\u7684\u8d77\u59cb\u5217\u53f7bx * BN + \u5c0f\u5206\u5757\u7684\u8d77\u59cb\u5217\u53f7tx * TN + \u5c0f\u5206\u5757\u5185\u90e8\u7684\u76f8\u5bf9\u5217\u53f7 n\n      int store_gmem_c_addr = store_gmem_c_m * N + store_gmem_c_n;\n      c[store_gmem_c_addr] = r_c[m][n];\n    }\n  }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#free-bank-conflict","title":"Free Bank Conflict \u4f18\u5316","text":"","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#bank-conflict","title":"Bank Conflict \u4ecb\u7ecd","text":"<p>Cuda shared memory \u6309\u7167 4 \u5b57\u8282\u4e00\u4e2a bank\uff0c\u603b\u5171 32 \u4e2a bank\uff08128 \u5b57\u8282\uff09\u6765\u7ec4\u7ec7\uff0c\u5176 store \u548c load \u64cd\u4f5c\u5728\u4e00\u5b9a\u60c5\u51b5\u4e0b\u5b58\u5728 bank conflict \u7684\u60c5\u51b5\uff1a</p> <ul> <li>\u4e0d\u540c\u7684\u7ebf\u7a0b\u8bbf\u95ee\u540c\u4e00 bank \u7684\u4e0d\u540c address \u65f6\u5c31\u4f1a\u51fa\u73b0 bank conflict\u3002</li> <li>bank conflict \u53ea\u53d1\u751f\u5728\u540c\u4e00\u4e2a warp \u7684\u4e0d\u540c\u7ebf\u7a0b\u95f4\u3002</li> <li>\u5982\u679c\u591a\u4e2a\u7ebf\u7a0b\u8bbf\u95ee shared memory \u7684\u76f8\u540c bank \u7684\u76f8\u540c address\uff0c\u5b9e\u9645\u6548\u679c\u662f broadcast\uff0c\u975e bank conflict\u3002</li> <li>bank conflict \u53ea\u53d1\u751f\u5728 shared memory \u7684\u8bfb\u5199\u64cd\u4f5c\u4e0a\uff0cglobal memory \u7684\u8bfb\u5199\u64cd\u4f5c\u4e0d\u4f1a\u6709 bank conflict \u4ea7\u751f\u3002</li> </ul> <p>Note</p> <p>\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0cbank conflict \u7684\u53d1\u751f\u662f\u5728 warp \u4e2d\u5904\u4e8e\u540c\u4e00\u4e2a phase \u7684\u4e0d\u540c threads \u4e4b\u95f4\uff0c\u8fd9\u91cc\u7684 phase \u662f\u6307 warp \u7684 32 \u4e2a\u7ebf\u7a0b\u64cd\u4f5c shared memory \u65f6\uff0c\u5206\u591a\u4e2a phase\uff0c\u6bcf\u4e2a phase \u7684\u53c2\u4e0e\u7ebf\u7a0b\u4e0d\u4e00\u6837\u3002</p> <p>\u6bd4\u5982 ldmatrix \u6307\u4ee4 ldmatrix.sync.aligned.x4.m8n8.shared.b16\uff0c\u8be5\u6307\u4ee4\u4ece\u5171\u4eab\u5185\u5b58\u52a0\u8f7d\u6570\u636e\u5230\u7ebf\u7a0b\u5bc4\u5b58\u5668\uff0c\u64cd\u4f5c\u5206 4 \u4e2a phase\uff0c\u5728 phase0 \u9636\u6bb5\uff0cthread0~7 \u64cd\u4f5c\u5171\u4eab\u5185\u5b58\uff0c\u5728 phase1 \u9636\u6bb5\uff0cthread8~15 \u64cd\u4f5c\u5171\u4eab\u5185\u5b58\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002</p> <ul> <li>bank conflict \u4f1a\u5bfc\u81f4 warp \u88ab stall\uff0c\u51b2\u7a81\u8f83\u591a\u4f1a\u5bf9\u6574\u4e2a pipeline \u7684\u8017\u65f6\u4f1a\u6709\u8f83\u5927\u7684\u5f71\u54cd\u3002</li> </ul> <p>Warning</p> <p>\u5f53\u53d1\u751f bank conflict \u65f6\uff0cwarp \u9700\u8981\u989d\u5916\u7684\u4e00\u4e2a cycle \u6765\u91cd\u65b0\u63d0\u4ea4 shared memory \u7684\u8bbf\u95ee\u6307\u4ee4\u5230 LSU \u5355\u5143\uff0c\u8be5\u6307\u4ee4\u9700\u8981\u5728 MIO \u4e2d\u6392\u961f\uff0c\u8fd9\u79cd\u6392\u961f\u4f1a\u5bfc\u81f4\u8bbf\u95ee\u5ef6\u8fdf\u589e\u52a0\uff0c\u6b64\u65f6 warp \u53ef\u80fd\u5904\u4e8e\u7b49\u5f85\u6570\u636e\u8fd4\u56de\u7684\u72b6\u6001\uff0cwarp state \u6807\u8bc6\u4e3a Stall Short Scoreboard\u3002</p> <p>\u5982\u679c MIO \u961f\u5217\u6ee1\uff0c\u6b64\u65f6 warp \u5148\u9700\u8981\u7b49\u5f85 MIO \u961f\u5217\u5904\u4e8e\u975e\u7a7a\u7684\u72b6\u6001\uff0c\u6b64\u65f6 warp state \u6807\u8bc6\u4e3a Stall MIO Throttle\u3002</p>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#free-bank-conflict_1","title":"Free Bank Conflict \u4f18\u5316\u65b9\u6cd5","text":"<ul> <li>padding: \u5728 shared memory \u7684\u4e8c\u7ef4\u6570\u7ec4\u4e2d\u589e\u52a0 padding \u5217\uff0c\u907f\u514d\u4e0d\u540c\u7ebf\u7a0b\u8bbf\u95ee\u540c\u4e00 bank</li> <li>\u8f6c\u7f6e\u5b58\u50a8: \u5c06\u4ece global memory \u8bfb\u53d6\u7684\u6570\u636e\u8f6c\u7f6e\u5b58\u50a8\u5230 shared memory \u4e2d</li> <li>swizzling \u673a\u5236: \u4e0d\u6539\u53d8\u7269\u7406\u5185\u5b58\u5927\u5c0f\uff0c\u800c\u662f\u6539\u53d8\u5730\u5740\u6620\u5c04\u903b\u8f91\u3002\u5728\u5b58\u5165 Shared Memory \u65f6\uff0c\u5c06\u5217\u5730\u5740\u4e0e\u884c\u5730\u5740\u8fdb\u884c\u5f02\u6216\uff08XOR\uff09\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#_3","title":"\u4ee3\u7801\u793a\u4f8b","text":"<p>\u8fd9\u91cc\u4f7f\u7528\u4e86\u8f6c\u7f6e\u5b58\u50a8\u7684\u65b9\u6cd5\uff1b</p> <p>\u5bf9\u4e8e Paddding \u5927\u5c0f\u7684\u9009\u62e9\uff0c\u6211\u4eec\u9700\u8981\u540c\u65f6\u6ee1\u8db3\u4e24\u4e2a\u786c\u6027\u6761\u4ef6\uff1a</p> <ul> <li> <p>\u6d88\u9664 Bank Conflict\uff1a \u8de8\u884c\u8bbf\u95ee\u65f6\u7684 Stride \u4e0d\u80fd\u662f 32 \u7684\u500d\u6570(<code>s_a</code> \u548c <code>s_b</code>)\u3002</p> </li> <li> <p>\u6ee1\u8db3\u5411\u91cf\u5316\u5bf9\u9f50\uff1a \u6bcf\u4e00\u884c\u7684\u8d77\u59cb\u5730\u5740\u5fc5\u987b\u662f 16 Byte \u5bf9\u9f50\u7684\uff08\u56e0\u4e3a\u6211\u4eec\u8981\u7528 float4 \u8fdb\u884c Global -&gt; Shared \u7684\u5199\u5165\uff09\u3002</p> </li> </ul> C++<pre><code>template &lt;const int BM = 128, const int BN = 128, const int BK = 8, const int TM = 8,\n          const int TN = 8, const int OFFSET = 0&gt;\n__global__ void gemm_t_8x8_sliced_k_f32x4_bcf_kernel(float *a, float *b, float *c, const int M,\n                                                     const int N, const int K) {\n  const int bx = blockIdx.x;\n  const int by = blockIdx.y;\n  const int tx = threadIdx.x;\n  const int ty = threadIdx.y;\n  const int tid = ty * blockDim.x + tx;\n\n  __shared__ float s_a[BK][BM + OFFSET];  //\u6211\u4eec\u9700\u8981\u7684\u662f A[0][0], A[1][0], A[2][0],\n                                          // A[3][0]\uff08\u540c\u4e00\u5217\u7684 4 \u4e2a M \u503c\uff09\u3002\u5728 s_a[BM][BK] \u4e2d\uff0c\u8fd9 4\n                                          //\u4e2a\u6570\u7684\u5185\u5b58\u5730\u5740\u4e0d\u8fde\u7eed\uff08\u76f8\u9694 BK \u4e2a float\uff09\u3002\n  __shared__ float s_b[BK][BN + OFFSET];\n\n  float r_load_a[TM / 2];  // 4\n  float r_load_b[TN / 2];  // 4\n  float r_comp_a[TM];\n  float r_comp_b[TN];\n  float r_c[TM][TN] = {0.0};\n\n  int load_a_smem_m = tid / 2;  // tid / 2\uff0c(0,1,2,...,128)\n  int load_a_smem_k = (tid &amp; 1) &lt;&lt; 2;\n  int load_b_smem_k = tid / 32;         // 0~8\n  int load_b_smem_n = (tid &amp; 31) &lt;&lt; 2;  // (0,4,8,12,...,124)\n  int load_a_gmem_m = by * BM + load_a_smem_m;\n  int load_b_gmem_n = bx * BN + load_b_smem_n;\n\n  for (int bk = 0; bk &lt; (K + BK - 1) / BK; bk++) {\n    int load_a_gmem_k = bk * BK + load_a_smem_k;\n    int load_a_gmem_addr = load_a_gmem_m * K + load_a_gmem_k;\n    int load_b_gmem_k = bk * BK + load_b_smem_k;\n    int load_b_gmem_addr = load_b_gmem_k * N + load_b_gmem_n;\n    FLOAT4(r_load_a[0]) = FLOAT4(a[load_a_gmem_addr]);\n    FLOAT4(r_load_b[0]) = FLOAT4(b[load_b_gmem_addr]);\n\n    s_a[load_a_smem_k][load_a_smem_m] = r_load_a[0];      // e.g layer_0  b0\n    s_a[load_a_smem_k + 1][load_a_smem_m] = r_load_a[1];  // e.g layer_4  b0\n    s_a[load_a_smem_k + 2][load_a_smem_m] = r_load_a[2];  // e.g layer_8  b0\n    s_a[load_a_smem_k + 3][load_a_smem_m] = r_load_a[3];  // e.g layer_12 b0\n\n    FLOAT4(s_b[load_b_smem_k][load_b_smem_n]) = FLOAT4(r_load_b[0]);\n\n    __syncthreads();\n\n#pragma unroll\n    for (int tk = 0; tk &lt; BK; tk++) {\n      FLOAT4(r_comp_a[0]) = FLOAT4(s_a[tk][ty * TM / 2]);\n      FLOAT4(r_comp_a[4]) = FLOAT4(s_a[tk][ty * TM / 2 + BM / 2]);\n\n      FLOAT4(r_comp_b[0]) = FLOAT4(s_b[tk][tx * TN / 2]);\n      FLOAT4(r_comp_b[4]) = FLOAT4(s_b[tk][tx * TN / 2 + BN / 2]);\n      // conclusion: still have some bank conflicts, need 4 memory issues.\n\n#pragma unroll\n      for (int tm = 0; tm &lt; TM; tm++) {\n#pragma unroll\n        for (int tn = 0; tn &lt; TN; tn++) {\n          // r_c[tm][tn] += r_comp_a[tm] * r_comp_b[tn];\n          r_c[tm][tn] = __fmaf_rn(r_comp_a[tm], r_comp_b[tn], r_c[tm][tn]);\n        }\n      }\n    }\n    // sync per BK.\n    __syncthreads();\n  }\n\n#pragma unroll\n  for (int i = 0; i &lt; TM / 2; i++) {\n    int store_c_gmem_m = by * BM + ty * TM / 2 + i;\n    int store_c_gmem_n = bx * BN + tx * TN / 2;\n    int store_c_gmem_addr = store_c_gmem_m * N + store_c_gmem_n;\n    FLOAT4(c[store_c_gmem_addr]) = FLOAT4(r_c[i][0]);\n    FLOAT4(c[store_c_gmem_addr + BN / 2]) = FLOAT4(r_c[i][4]);\n  }\n#pragma unroll\n  for (int i = 0; i &lt; TM / 2; i++) {\n    int store_c_gmem_m = by * BM + BM / 2 + ty * TM / 2 + i;\n    int store_c_gmem_n = bx * BN + tx * TN / 2;\n    int store_c_gmem_addr = store_c_gmem_m * N + store_c_gmem_n;\n    FLOAT4(c[store_c_gmem_addr]) = FLOAT4(r_c[i + TM / 2][0]);\n    FLOAT4(c[store_c_gmem_addr + BN / 2]) = FLOAT4(r_c[i + TM / 2][4]);\n  }\n}\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#why-transpose","title":"Why Transpose?","text":"<p>\u4e0d\u4f7f\u7528\u8f6c\u7f6e\uff1a</p> <ul> <li>Bank Conflict\uff1a\u53ef\u4ee5\u901a\u8fc7\u8c03\u8282 OFFSET \u6d88\u9664\u3002</li> <li>\u5411\u91cf\u5316 (LDS.128)\uff1a\u8fd9\u91cc\u53d6\u5230\u7684 4 \u4e2a\u6570\u5728\u7269\u7406\u5185\u5b58\u91cc\u662f\u5206\u6563\u7684\uff08Strided Access\uff09\u3002</li> <li>\u540e\u679c\uff1a\u5fc5\u987b\u53d1\u5c04 4 \u6761 LDS.32 \u6307\u4ee4\u6765\u5206\u522b\u8bfb\u53d6\u8fd9 4 \u4e2a\u6570\u3002</li> <li>\u6027\u80fd\u4ee3\u4ef7\uff1a\u6307\u4ee4\u6570\u589e\u52a0\u4e86 4 \u500d\uff0c\u53d1\u5c04\u5e26\u5bbd\u88ab\u6d6a\u8d39\u3002</li> </ul> <p>\u7269\u7406\u8f6c\u7f6e (s_a[BK][BM + OFFSET])</p> <ul> <li>Bank Conflict\uff1a\u53ef\u4ee5\u901a\u8fc7\u8c03\u8282 OFFSET \u6d88\u9664\u3002</li> <li>\u5411\u91cf\u5316 (LDS.128)\uff1a\u652f\u6301\u3002\u53ef\u4ee5\u7528 1 \u6761 LDS.128 \u6307\u4ee4\u628a\u8ba1\u7b97\u6240\u9700\u7684 4 \u4e2a\u6570\u52a0\u8f7d\u5230\u5bc4\u5b58\u5668\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#global-shared","title":"Global -&gt; Shared \u53d8\u6162\uff0c\u4e3a\u4ec0\u4e48\u8981\u505a\u8f6c\u7f6e\uff1f","text":"<p>\u6267\u884c\u9891\u7387\u7684\u5bf9\u6bd4\uff1a</p> <ul> <li>\u5916\u5c42\u5faa\u73af (Global \\(\\rightarrow\\) Shared)\uff1a\u6267\u884c\u6b21\u6570\uff1a\\(K / BK\\) \u6b21\u3002\u8fd9\u662f\u4e00\u4e2a\u76f8\u5bf9\u4f4e\u9891\u7684\u64cd\u4f5c\u3002\u5bf9\u603b\u65f6\u95f4\u5f71\u54cd\u8f83\u5c0f\u3002</li> <li>\u6700\u5185\u5c42\u5faa\u73af (Shared \\(\\rightarrow\\) Register \\(\\rightarrow\\) FMA)\uff1a\u6267\u884c\u6b21\u6570\uff1a\\((K / BK) \\times BK = K\\) \u6b21\u3002\u8fd9\u662f Kernel \u4e2d\u6700\u70ed\uff08Hot Spot\uff09 \u7684\u5730\u65b9\u3002\u5728\u8fd9\u4e2a\u5faa\u73af\u91cc\uff0c\u4efb\u4f55\u591a\u4f59\u7684\u6307\u4ee4\u90fd\u4f1a\u88ab\u653e\u5927\u6570\u767e\u4e07\u500d\u3002\u5982\u679c\u5728\u8fd9\u91cc\u80fd\u7528 1 \u6761\u6307\u4ee4\u4ee3\u66ff 4 \u6761\u6307\u4ee4\uff0c\u6027\u80fd\u6536\u76ca\u662f\u5de8\u5927\u7684\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#double-buffer-multi-stage-pipeline","title":"Double Buffer \u4f18\u5316(Multi-Stage Pipeline)","text":"<p>Double Buffering \u672c\u8d28\u4e0a\u662f\u4e00\u79cd\u8f6f\u4ef6\u6d41\u6c34\u7ebf (Software Pipelining) \u7b56\u7565\u3002\u5176\u6838\u5fc3\u76ee\u6807\u662f\u901a\u8fc7\u6307\u4ee4\u8c03\u5ea6\uff0c\u6253\u7834\u51af\u00b7\u8bfa\u4f9d\u66fc\u67b6\u6784\u4e2d\u201c\u53d6\u6307-\u6267\u884c\u201d\u7684\u4e32\u884c\u4f9d\u8d56\uff0c\u5b9e\u73b0\u8ba1\u7b97\u8d44\u6e90\uff08ALU/FPU/Tensor Core\uff09\u4e0e\u5b58\u50a8\u8d44\u6e90\uff08DMA/Memory Controller\uff09\u7684\u65f6\u95f4\u91cd\u53e0 \u3002</p> <ul> <li>\u9884\u53d6 (Prefetching): \u5728\u5904\u7406\u5f53\u524d\u8fed\u4ee3 Step \\(K\\) \u7684\u540c\u65f6\uff0c\u63d0\u524d\u53d1\u51fa Step \\(K+1\\) \u7684\u5185\u5b58\u52a0\u8f7d\u8bf7\u6c42\u3002</li> <li>\u5ef6\u8fdf\u63a9\u76d6 (Latency Masking): \u5229\u7528\u8ba1\u7b97\u6307\u4ee4\uff08Compute Kernel\uff09\u7684\u9ad8\u541e\u5410\u91cf\u6267\u884c\u65f6\u95f4\uff0c\u53bb\u586b\u8865\u5185\u5b58\u52a0\u8f7d\u6307\u4ee4\uff08Load Kernel\uff09\u7684\u9ad8\u5ef6\u8fdf\u7a7a\u7a97\u671f\u3002</li> </ul> Bash<pre><code>Time --------------------------------------------------&gt;\n[Load K0] ...latency...\n                        [Compute K0]\n                        [Load K1 (Async/Background)] ...latency...\n                                    &lt;---- \u88ab\u8ba1\u7b97\u65f6\u95f4\u63a9\u76d6 ----&gt;\n                                                     [Compute K1]\n                                                     [Load K2] ...\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#cost-model","title":"Cost Model \u5206\u6790","text":"<p>\u5b9e\u65bd \\(N\\)-stage buffering (\u5176\u4e2d \\(N=2\\) \u4e3a\u53cc\u7f13\u51b2) \u6240\u9700\u7684 Shared Memory \u5bb9\u91cf \\(S_{mem}\\) \u53ef\u7531\u4e0b\u5f0f\u7ed9\u51fa\uff1a \\(\\(S_{mem} = N \\times [BK \\times (BM + BN)] \\times \\text{sizeof(dtype)}\\)\\) \u5176\u4e2d\uff1a</p> <ul> <li>\\(N\\): \u7f13\u51b2\u7ea7\u6570 (Double Buffering \u65f6 \\(N=2\\), Multi-stage \u53ef\u80fd\u4e3a 3, 4, 5)\u3002</li> <li>\\(BM, BN\\): \u5206\u5757\u77e9\u9635\u5728 M, N \u7ef4\u5ea6\u7684\u5c3a\u5bf8\u3002</li> <li>\\(BK\\): \u7d2f\u52a0\u7ef4\u5ea6 K \u7684\u6b65\u957f (Unroll factor)\u3002</li> <li>\\(\\text{sizeof(dtype)}\\): \u6570\u636e\u7c7b\u578b\u5927\u5c0f (\u5982 float \u4e3a 4 Bytes)\u3002</li> </ul> <p>\u8fd9\u4e00\u516c\u5f0f\u63ed\u793a\u4e86\u7b97\u672f\u5f3a\u5ea6 (Arithmetic Intensity) \u4e0e \u7247\u4e0a\u5b58\u50a8\u5bb9\u91cf (On-chip Memory Capacity) \u4e4b\u95f4\u7684\u76f4\u63a5\u77db\u76fe\u3002</p>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#occupancy-vs-parallelism-trade-off","title":"Occupancy vs. Parallelism Trade-off","text":"<p>\u6211\u4eec\u9700\u8981\u6743\u8861\u4e24\u79cd\u5e76\u884c\u6a21\u5f0f\uff1a</p> <ul> <li>\u7ebf\u7a0b\u7ea7\u5e76\u884c (TLP - Thread Level Parallelism)</li> <li>\u5b9a\u4e49\uff1a GPU \u901a\u8fc7\u5feb\u901f\u4e0a\u4e0b\u6587\u5207\u6362 (Context Switching) \u5728\u4e0d\u540c\u7684 Warps \u4e4b\u95f4\u8f6e\u8f6c\u6267\u884c\uff0c\u4ee5\u63a9\u76d6\u5ef6\u8fdf\u3002- \u5ea6\u91cf\u6307\u6807\uff1a\u5360\u7528\u7387 (Occupancy)\u3002\u5373\u6d3b\u8dc3 Warp \u6570\u91cf\u4e0e SM \u7269\u7406\u6700\u5927\u652f\u6301 Warp \u6570\u91cf\u7684\u6bd4\u503c\u3002</li> <li>\u8d44\u6e90\u9650\u5236\uff1aShared Memory \u662f\u9650\u5236 Occupancy \u7684\u5173\u952e\u74f6\u9888\u3002</li> <li>\u6307\u4ee4\u7ea7\u5e76\u884c (ILP - Instruction Level Parallelism)</li> <li>\u5b9a\u4e49\uff1a\u5355\u4e2a\u7ebf\u7a0b\u5185\u90e8\uff0c\u5229\u7528\u6d41\u6c34\u7ebf\u6280\u672f\uff0c\u8ba9\u8ba1\u7b97\u6307\u4ee4\u548c\u8bbf\u5b58\u6307\u4ee4\u540c\u65f6\u5728\u98de\u884c\u4e2d (In-flight)\u3002</li> <li>Double Buffering \u5b9e\u9645\u4e0a\u662f\u6781\u5927\u5730\u63d0\u9ad8\u4e86 ILP\u3002</li> </ul> <p>\u5982\u679c\u6211\u4eec\u4f7f\u7528 Double Buffering\uff0c\u8ba9 Shared Memory \u8fc7\u5927\u4f1a\u89e6\u53d1\u4ee5\u4e0b\u8fde\u9501\u53cd\u5e94\uff1a</p> <ul> <li>Active Blocks \u4e0b\u964d\uff1a\u8bbe \\(C_{SM}\\) \u4e3a\u5355\u4e2a SM \u7684 Shared Memory \u603b\u5bb9\u91cf (e.g., A100 164KB)\u3002\u5355\u4e2a Block \u7684\u9700\u6c42\u4e3a \\(S_{block}\\)\u3002\u5219\u6bcf\u4e2a SM \u80fd\u540c\u65f6\u9a7b\u7559\u7684\u6700\u5927 Block \u6570\u91cf \\(N_{blocks}\\) \u4e3a\uff1a\\(\\(N_{blocks} = \\lfloor \\frac{C_{SM}}{S_{block}} \\rfloor\\)\\)</li> <li>Occupancy \u5d29\u584c\uff1a\u5982\u679c \\(S_{block}\\) \u8d85\u8fc7\u4e86 \\(C_{SM} / 2\\)\uff08\u5373\u5927\u4e8e 82KB\uff09\uff0c\u90a3\u4e48 \\(N_{blocks}\\) \u5f3a\u5236\u53d8\u4e3a 1\u3002\u8fd9\u610f\u5473\u7740\u6574\u4e2a SM \u4e0a\u53ea\u6709\u4e00\u4e2a Block \u5728\u8fd0\u884c\u3002</li> <li>\u5c3e\u90e8\u6548\u5e94\u4e0e\u5ef6\u8fdf\u66b4\u9732\uff1a</li> <li>\u7f3a\u4e4f TLP(Thread Level Parallelism, TLP) \u8865\u507f\uff1a \u5f53 SM \u4e0a\u53ea\u6709\u4e00\u4e2a Block \u65f6\uff0c\u5982\u679c\u8be5 Block \u5185\u7684\u6240\u6709 Warps \u90fd\u56e0\u4e3a\u540c\u6b65\u6307\u4ee4 (__syncthreads()) \u6216 \u957f\u5ef6\u8fdf\u6307\u4ee4\uff08\u5982\u672a\u88ab\u5b8c\u5168\u63a9\u76d6\u7684 Global Memory \u8bbf\u95ee\uff09\u800c\u963b\u585e\uff0cSM \u5c06\u6ca1\u6709\u4efb\u4f55\u5176\u4ed6 Block \u7684 Warps \u53ef\u4ee5\u8c03\u5ea6\u6765\u586b\u8865\u7a7a\u95f2\u65f6\u95f4\u3002</li> <li>\u6d41\u6c34\u7ebf\u6c14\u6ce1 (Pipeline Stalls)\uff1a \u4e00\u65e6\u6d41\u6c34\u7ebf\u65ad\u6d41\uff0cGPU \u7684\u6d77\u91cf\u8ba1\u7b97\u5355\u5143\u5c06\u77ac\u95f4\u7a7a\u8f6c\uff0c\u6027\u80fd\u6025\u5267\u4e0b\u964d\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#wmma","title":"wmma \u6307\u4ee4\u4f18\u5316","text":"","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#tensor-core","title":"Tensor Core","text":"<p>\u901a\u8fc7 WMMA API\uff0c\u5f00\u53d1\u8005\u53ef\u5c06 D = A \u00d7 B + C \u5f53\u4f5c warp \u64cd\u4f5c\uff0c\u5176\u4e2d\u7684 A\u3001B\u3001C\u3001D \u90fd\u662f\u66f4\u5927\u77e9\u9635\u7684 tile\u3002\u901a\u8fc7 WMMA API\uff0cwarp \u7684\u6240\u6709\u7ebf\u7a0b\u53ef\u4ee5\u5408\u4f5c\u5b8c\u6210\u5728\u8fd9\u4e9b tile \u4e0a\u7684\u77e9\u9635\u4e58\u52a0\u64cd\u4f5c</p> <p>\u6bcf\u4e2a tile \u53ef\u4ee5\u8fdb\u4e00\u6b65\u5206\u5272\u4e3a fragment\uff0c\u6bcf\u4e2a fragment \u662f\u6620\u5c04\u5230\u7ebf\u7a0b\u5bc4\u5b58\u5668\u7684\u4e00\u7ec4 tile \u5143\u7d20\u3002\u56e0\u6b64\uff0c\u8f93\u5165\u77e9\u9635\u7684\u5206\u5e03\u662f\u8de8\u7ebf\u7a0b\u7684\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u53ea\u5305\u542b\u4e00\u90e8\u5206 tile\u3002\u4e00\u4e2a 16\u00d716 \u7684 tile \u5305\u542b 256 \u4e2a\u5143\u7d20\u3002warp\uff08\u5305\u62ec 32 \u4e2a\u7ebf\u7a0b\uff09\u4e2d\u7684\u6bcf\u4e2a\u7ebf\u7a0b\u5728 8 \u4e2a GPR\uff08General-Purpose Register\uff09\u4e2d\u4fdd\u5b58\u4e00\u4e2a 8\uff08256/32=8\uff09\u5143\u7d20\u7684 fragment\u3002</p> C++<pre><code>nvcuda::wmma::fragment&lt;wmma::matrix_a, 16, 16, 16, half, wmma::row_major&gt; frag_a;\nnvcuda::wmma::fragment&lt;wmma::matrix_b, 16, 16, 16, half, wmma::row_major&gt; frag_a;\nnvcuda::wmma::fragment&lt;wmma::accumulator, 16, 16, 16, half&gt; frag_c;\n\nnvcuda::wmma::fill_fragment(frag_c, 0.0);\nnvcuda::wmma::load_matrix_sync(frag_a, (shared memory or global memory pointer), (stride_a));\nnvcuda::wmma::load_matrix_sync(frag_b, (shared memory or global memory pointer), (stride_b));\nnvcuda::wmma::mma_sync(frag_c, frag_a, frag_b, frag_c);\nnvcuda::wmma::store_matrix_sync((shared memory or global memory pointer), frag_c, (stride_c), wmma::mem_row_major);\n</code></pre>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#wmmaload-vs-ldmatrix","title":"wmma.load vs ldmatrix","text":"<p>\u5728\u4f7f\u7528 Tensor Core \u8fdb\u884c\u77e9\u9635\u4e58\u6cd5\u65f6\uff0c\u6570\u636e\u52a0\u8f7d\u662f\u4e00\u4e2a\u5173\u952e\u73af\u8282\uff0c\u8fd9\u4e24\u4e2a API \u7684\u6838\u5fc3\u533a\u522b\u5728\u4e8e\uff1a\u5bfb\u5740\u903b\u8f91\u7684\u7c92\u5ea6\u3002</p> <ul> <li>wmma.load: \u662f Block/Tile \u7ea7 \u7684\u5bfb\u5740\u3002\u4f60\u7ed9\u5b83\u4e00\u4e2a\u57fa\u5730\u5740 (ptr) \u548c\u4e00\u4e2a\u8de8\u5ea6 (stride)\uff0c\u5b83\u5047\u8bbe\u6570\u636e\u662f\u201c\u89c4\u77e9\u201d\u5730\u6309\u884c\u6216\u5217\u6392\u5217\u7684\u3002</li> <li>ldmatrix: \u662f Thread/Warp \u7ea7 \u7684\u5bfb\u5740\u3002Warp \u91cc\u7684\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u72ec\u7acb\u7684 Shared Memory \u5730\u5740\u3002</li> </ul> <ol> <li>wmma.load \u7684\u5c40\u9650\u6027\uff1a\u6b7b\u677f\u7684\u7ebf\u6027\u6620\u5c04</li> </ol> <ul> <li>\u5728 CUDA C++ API \u4e2d\uff0cwmma::load_matrix_sync \u7684\u51fd\u6570\u7b7e\u540d\u901a\u5e38\u957f\u8fd9\u6837\uff1a<code>wmma::load_matrix_sync(frag, base_ptr, stride_dm)</code>;</li> <li>\u9690\u542b\u5047\u8bbe\uff1a \u5b83\u5047\u8bbe\u77e9\u9635\u5728\u5185\u5b58\u4e2d\u662f\u8fde\u7eed\u7684\u6216\u8005\u5177\u6709\u56fa\u5b9a stride \u7684\u3002</li> <li>\u5bfb\u5740\u516c\u5f0f\uff1a \u5bf9\u4e8e\u77e9\u9635\u4e2d\u7684\u7b2c \\((row, col)\\) \u4e2a\u5143\u7d20\uff0c\u5b83\u5f3a\u5236\u8ba4\u4e3a\u5730\u5740\u662f\uff1a\\(\\(Addr = base\\_ptr + row \\times stride + col\\)\\)</li> <li>\u95ee\u9898\u6240\u5728\uff1a\u5982\u679c\u4f60\u4e3a\u4e86\u907f\u514d Shared Memory Bank Conflict\uff0c\u5bf9\u6570\u636e\u5e03\u5c40\u505a\u4e86 XOR Swizzling\uff08\u5f02\u6216\u6df7\u6d17\uff0c\u5373\u6253\u4e71\u4e86\u6bcf\u884c\u7684\u8d77\u59cb\u504f\u79fb\u91cf\uff09\uff0c\u90a3\u4e48\u6570\u636e\u5728\u5185\u5b58\u4e2d\u7684\u7269\u7406\u4f4d\u7f6e\u5c31\u4e0d\u518d\u7b26\u5408 row * stride \u8fd9\u79cd\u7b80\u5355\u7684\u7ebf\u6027\u5173\u7cfb\u4e86\u3002\u3002wmma.load \u65e0\u6cd5\u7406\u89e3\u8fd9\u79cd\u903b\u8f91\uff0c</li> </ul> <ol> <li>ldmatrix \u7684\u7075\u6d3b\u6027\uff1aPer-Thread \u5bfb\u5740    - ldmatrix \u662f Ampere \u5f15\u5165\u7684 PTX \u6307\u4ee4\uff0c\u5b83\u628a\u201c\u52a0\u8f7d\u4ec0\u4e48\u6570\u636e\u201d\u7684\u63a7\u5236\u6743\u5b8c\u5168\u4ea4\u7ed9\u4e86\u6bcf\u4e00\u4e2a\u7ebf\u7a0b\u3002    - \u6307\u4ee4\u539f\u578b\uff08PTX\uff09\uff1a<code>ldmatrix.sync.aligned.m8n8.x4.shared.b16 {r0, r1, r2, r3}, [addr]</code>;    - \u8fd9\u91cc\u7684 [addr] \u662f\u4e00\u4e2a\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u3002    - Warp \u4e2d\u7684 32 \u4e2a\u7ebf\u7a0b\uff0c\u6bcf\u4e2a\u7ebf\u7a0b\u90fd\u6301\u6709\u81ea\u5df1\u7684 addr \u5bc4\u5b58\u5668\u3002    - \u5728 .x4 \u6a21\u5f0f\uff08\u52a0\u8f7d 4 \u4e2a\u5bc4\u5b58\u5668\uff0c\u5bf9\u5e94 \\(16 \\times 16\\) \u77e9\u9635 A\uff09\u4e0b\uff0c\u786c\u4ef6\u901a\u5e38\u5c06 Warp \u5206\u4e3a 8 \u7ec4\uff0c\u6bcf\u7ec4 4 \u4e2a\u7ebf\u7a0b\u3002\u8fd9 4 \u4e2a\u7ebf\u7a0b\u534f\u4f5c\u52a0\u8f7d\u4e00\u90e8\u5206\u6570\u636e\u3002</li> </ol>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#warp-tile","title":"warp tile","text":"<p>Warp Tile \u662f Block -&gt; Warp -&gt; Thread \u7684\u4e2d\u95f4\u5c42\u3002</p> <ul> <li>\u5728 FP32 \u4e0a\uff1a\u4f18\u5316 Cache \u5c40\u90e8\u6027\uff0c\u65b9\u4fbf\u6392\u5e03\u3002</li> <li>\u5728 Tensor Core \u4e0a\uff1a\u5fc5\u987b\u5b58\u5728\uff0c\u8fd9\u662f\u9a71\u52a8 Tensor Core \u7684\u6570\u636e\u5e03\u5c40\u57fa\u7840\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#cuda-core-warp-tile","title":"\u4e3a\u4ec0\u4e48 CUDA Core \u91cc\u9762\u5bf9 warp tile \u4e0d\u662f\u5fc5\u987b\u7684\uff1f","text":"<p>\u786c\u4ef6\u7279\u6027\uff1a CUDA Core \u662f\u6807\u91cf/\u5411\u91cf\u5355\u5143\uff0c\u539f\u672c\u5c31\u662f\u6309\u7ebf\u7a0b\u8c03\u5ea6\u7684\u3002</p> <p>\u6027\u80fd\u74f6\u9888\uff1a \u5728 FP32 SGEMM \u4e2d\uff0c\u6027\u80fd\u74f6\u9888\u901a\u5e38\u5728\u4e8e Global Memory \u5e26\u5bbd \u548c Shared Memory \u51b2\u7a81\u3002</p>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#block-swizzle","title":"Block Swizzle","text":"<p>\u901a\u8fc7\u6539\u53d8 Grid \u7684\u904d\u5386\u987a\u5e8f\uff0c\u6b3a\u9a97 GPU \u786c\u4ef6\u8c03\u5ea6\u5668\uff0c\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u63d0\u9ad8 L2 Cache \u7684\u547d\u4e2d\u7387\u3002</p> <p>CUDA \u9ed8\u8ba4\u6309\u7167 blockIdx.x \u589e\u52a0\u7684\u65b9\u5411\u8c03\u5ea6\uff0c\u586b\u6ee1\u4e00\u884c\u540e\u518d\u6362\u4e0b\u4e00\u884c\uff08blockIdx.y \u589e\u52a0\uff09\u3002RTX 3090 \u540c\u4e00\u65f6\u523b\u53ea\u80fd\u8dd1 82 \u4e2a Block\u3002</p> <p>\u4e0d\u52a0 Swizzle\uff1a</p> <p>\u4e00\u884c\u6709 64 \u4e2a Block\uff08BX=64\uff09\u3002GPU \u4e00\u6b21\u80fd\u201c\u5403\u201d\u6389\u7b2c\u4e00\u884c\u5168\u884c (64 \u4e2a) + \u7b2c\u4e8c\u884c\u524d 18 \u4e2a\u3002\u5f53\u7b2c\u4e00\u6279 Block \u8dd1\u5b8c\uff0cSM \u91ca\u653e\uff0c\u5f00\u59cb\u8dd1\u540e\u7eed Block \u65f6\uff0c\u5982\u679c\u6309\u7167\u5149\u6805\u987a\u5e8f\uff0c\u5b83\u4f1a\u7ee7\u7eed\u5f80\u53f3\u8dd1\u6216\u8005\u6362\u884c\u3002\u5982\u679c\u4e0d\u63a7\u5236\u987a\u5e8f\uff0cSM \u53ef\u80fd\u4f1a\u968f\u673a\u5730\u4ece DRAM \u62c9\u53d6\u975e\u5e38\u5206\u6563\u7684 B \u77e9\u9635 Tile\uff0c\u5bfc\u81f4\u5e26\u5bbd\u74f6\u9888\u3002</p> <p>\u5728\u5904\u7406\u4e2d\u95f4\u90a3 127 \u4e2a Block \u7684\u8fc7\u7a0b\u4e2d\uff0c\u52a0\u8f7d\u4e86\u5927\u91cf\u65b0\u7684 B \u77e9\u9635\u6570\u636e\u3002\u7531\u4e8e L2 Cache \u5bb9\u91cf\u6709\u9650\uff0c\\(B_{tile}[0]\\) \u5f88\u53ef\u80fd\u65e9\u5c31\u88ab\u540e\u7eed\u7684 \\(B_{tile}[1 \\dots 127]\\) \u6324\u51fa\u53bb\u4e86\uff08Evicted\uff09\u3002\u8fd9\u5c31\u5bfc\u81f4\u4e86 B \u77e9\u9635\u7684 Cache Thrashing\uff08\u98a0\u7c38\uff09\uff0c\u6bcf\u6b21\u6362\u884c\u90fd\u8981\u91cd\u65b0\u4ece DRAM \u8bfb\u53d6 B\uff0c\u6781\u5927\u5730\u6d6a\u8d39\u4e86\u5e26\u5bbd</p> <p>\u52a0\u4e0a Swizzle\uff1a GPU \u786c\u4ef6\u8c03\u5ea6\u5668\u901a\u5e38\u4f18\u5148\u8c03\u5ea6 x\uff0c\u7136\u540e y\uff0c\u6700\u540e z\uff08\u6216\u8005\u8bf4\u5728 z \u56fa\u5b9a\u7684\u60c5\u51b5\u4e0b\u8dd1\u5b8c x, y\uff09\u3002\u73b0\u5728\u7684 gridDim.x = 16\u3002</p> <p>GPU \u6267\u884c\u7684 Block \u5927\u6982\u7387\u662f\uff1a</p> <ul> <li>Strip 0 \u7684 Row 0 (16 \u4e2a)</li> <li>Strip 0 \u7684 Row 1 (16 \u4e2a)</li> <li>Strip 0 \u7684 Row 2 (16 \u4e2a)</li> <li>Strip 0 \u7684 Row 3 (16 \u4e2a)</li> <li>Strip 0 \u7684 Row 4 (16 \u4e2a)</li> <li>Strip 0 \u7684 Row 5 (2 \u4e2a)</li> </ul> <p>\u8fd9 82 \u4e2a\u6b63\u5728\u8fd0\u884c\u7684 Block\uff0c\u7edd\u5927\u591a\u6570\u90fd\u96c6\u4e2d\u5728 B \u77e9\u9635\u7684\u524d 16 \u4e2a Tile \u4e0a\u3002\u5b83\u4eec\u5171\u4eab B \u77e9\u9635\u7684\u8bfb\u8bf7\u6c42\uff0cL2 Cache \u547d\u4e2d\u7387\u6781\u9ad8\uff0cDRAM \u5e26\u5bbd\u538b\u529b\u9aa4\u964d\u3002</p>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#example","title":"Example","text":"<ul> <li>warp_id \u8303\u56f4 0~7 (8 \u4e2a warps)\u3002</li> <li>warp_m = warp_id / 2 (0~3) -&gt; M \u7ef4\u5ea6\u6709 4 \u4e2a Warp\u3002</li> <li>warp_n = warp_id % 2 (0~1) -&gt; N \u7ef4\u5ea6\u6709 2 \u4e2a Warp\u3002</li> <li>\u6bcf\u4e2a Warp \u8d1f\u8d23 \\(32 \\times 64\\)\u3002</li> <li>Block \u603b\u5927\u5c0f\u662f M: \\(4 \\times 32 = 128\\), N: \\(2 \\times 64 = 128\\)\u3002</li> <li>\u8fd9\u91cc\u7b80\u5355\u4f7f\u7528 Padding \u907f\u514d shared memory \u5728 load/store \u65f6\u7684 Bank Conflict\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#_4","title":"\u603b\u7ed3","text":"<p>\u8fd9\u5f20\u56fe\u8868\u975e\u5e38\u76f4\u89c2\u5730\u5c55\u793a\u4e86\u4e0d\u540c GEMM \u5b9e\u73b0\u7b56\u7565\u5728\u4e0d\u540c\u77e9\u9635\u89c4\u6a21\u4e0b\u7684\u6027\u80fd\u8868\u73b0\uff08TFLOPS\uff09\u3002</p>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#1-1024pytorch-cublas","title":"1. \u5c0f\u77e9\u9635\u4e0b\uff08&lt; 1024\uff09\uff0cPyTorch (cuBLAS) \u6548\u679c\u6700\u597d","text":"<p>\u539f\u56e0\uff1a</p> <ul> <li> <p>\u542f\u52a8\u5f00\u9500\uff08Launch Overhead\uff09\uff1a\u5c0f\u77e9\u9635\u8ba1\u7b97\u65f6\u95f4\u77ed\uff0cKernel \u542f\u52a8\u548c CPU \u4fa7\u7684\u5f00\u9500\u5360\u6bd4\u5927\u3002PyTorch/cuBLAS \u5728\u8fd9\u65b9\u9762\u505a\u4e86\u6781\u81f4\u4f18\u5316\u3002</p> </li> <li> <p>\u542f\u53d1\u5f0f\u9009\u62e9\uff1acuBLAS \u5185\u90e8\u9488\u5bf9\u5c0f\u5c3a\u5bf8\u6709\u4e13\u95e8\u7684\u201c\u786c\u7f16\u7801\u201d\u7b56\u7565\uff0c\u5e76\u4e0d\u662f\u5355\u7eaf\u8d70\u901a\u7528\u7684\u5206\u5757\u903b\u8f91\uff0c\u53ef\u80fd\u76f4\u63a5\u7528\u5bc4\u5b58\u5668\u6781\u5ea6\u4f18\u5316\u7684 Micro-kernel\u3002</p> </li> <li> <p>\u624b\u5199 Kernel\uff08\u7279\u522b\u662f FP32x4 \u7cfb\u5217\uff09\u5728\u8fd9\u91cc\u6027\u80fd\u8f83\u4f4e\uff0c\u8bf4\u660e\u5355\u7eaf\u7684 Tiling \u548c\u5411\u91cf\u5316\u5728\u5c0f\u5c3a\u5bf8\u4e0a\u65e0\u6cd5\u6218\u80dc cuBLAS \u7684\u7b56\u7565\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#2-tf32-tensor-core-fp32","title":"2. \u4e2d\u5927\u77e9\u9635\u4e0b\uff0cTF32 Tensor Core \u6548\u679c\u660e\u663e\u4f18\u4e8e FP32","text":"<ul> <li>\u4ece 2048 \u5f00\u59cb\uff0c\u5e26\u6709 tf32 \u524d\u7f00\u7684\u66f2\u7ebf\uff08\u7ea2\u3001\u7d2b\u3001\u7c89\u3001\u9752\u8272\uff09\u5f00\u59cb\u53cd\u8d85 f32_th\u3002\u5728 4096 \u548c 8192 \u8fbe\u5230\u5cf0\u503c\uff0c\u6700\u9ad8\u63a5\u8fd1 28 TFLOPS\u3002</li> </ul> <p>\u539f\u56e0\uff1a</p> <ul> <li> <p>Tensor Core \u4f18\u52bf\uff1aPyTorch \u7684 f32_th \u9ed8\u8ba4\u53ef\u80fd\u8fd8\u662f\u8d70\u7684 FP32 SIMT \u8def\u5f84\uff08\u6216\u8005\u7b56\u7565\u76f8\u5bf9\u4fdd\u5b88\uff09\uff0c\u867d\u7136\u7a33\u5b9a\u5728 23 TFLOPS \u5de6\u53f3\uff0c\u4f46\u65e0\u6cd5\u8fbe\u5230 Tensor Core \u7684\u7406\u8bba\u6781\u9650\u3002</p> </li> <li> <p>\u6d41\u6c34\u7ebf\u63a9\u76d6\uff1a\u9ad8\u6027\u80fd\u7684 tf32 \u66f2\u7ebf\u901a\u5e38\u5e26\u6709 stage2 \u6216 stage3\uff0c\u8bf4\u660e\u591a\u7ea7\u6d41\u6c34\u7ebf\u6210\u529f\u63a9\u76d6\u4e86 Global Memory \u7684\u5ef6\u8fdf\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/cuda/%E4%BB%8EGEMM%E5%AE%9E%E8%B7%B5CUDA%E4%BC%98%E5%8C%96/#3-grid-swizzling-pipeline-trade-off","title":"3. Grid Swizzling \u4e0e Pipeline \u7684 trade-off","text":"<ul> <li>\u5728 16384 \u5904\u4f9d\u7136\u4fdd\u6301\u5728 ~26 TFLOPS \u7684\u9ad8\u4f4d\uff0c\u5b8c\u80dc PyTorch\u3002</li> </ul> <p>\u539f\u56e0\uff1a</p> <ul> <li> <p>Stage 3\uff1a\u4e09\u7ea7\u6d41\u6c34\u7ebf\u6bd4\u4e8c\u7ea7\u63d0\u4f9b\u4e86\u66f4\u6df1\u7684\u9884\u53d6\u6df1\u5ea6\uff0c\u66f4\u80fd\u5bb9\u5fcd\u5927\u77e9\u9635\u4e0b\u7684 DRAM \u5ef6\u8fdf\u6296\u52a8\u3002</p> </li> <li> <p>Warp Tile \u4f18\u5316\uff1awarp2x4 \u53ef\u80fd\u63d0\u4f9b\u4e86\u66f4\u597d\u7684\u5bc4\u5b58\u5668\u548c Shared Memory \u5e03\u5c40\uff0c\u914d\u5408 Stage 3 \u5f62\u6210\u4e86\u66f4\u7a33\u5065\u7684\u8bbf\u5b58\u6a21\u5f0f\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/","title":"DiT Generate Model in SGLang","text":"2025-12-102025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#dit-generate-model-in-sglang","title":"DiT Generate Model in SGLang","text":"<p> \u7ea6 3124 \u4e2a\u5b57  51 \u884c\u4ee3\u7801  9 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 16 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#dit-generate","title":"\u5e38\u89c1 DiT Generate \u6a21\u578b","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#stable-diffusion-3image-generate","title":"Stable Diffusion 3(Image Generate)","text":"<p>Note</p> <p>\u6587\u672c\uff08Text\uff09\u548c\u56fe\u50cf\uff08Image\uff09\u662f\u4e24\u79cd\u672c\u8d28\u4e0d\u540c\u7684\u6a21\u6001\uff0c\u56e0\u6b64\u5e94\u8be5\u4f7f\u7528\u4e24\u5957\u72ec\u7acb\u7684\u6743\u91cd\u6765\u5206\u522b\u5904\u7406\u5b83\u4eec\uff0c\u4f46\u5728\u6ce8\u610f\u529b\u673a\u5236\uff08Attention\uff09\u9636\u6bb5\u5141\u8bb8\u4e24\u8005\u8fdb\u884c\u4ea4\u4e92\u3002</p> <ol> <li>\u53cc\u6d41\u67b6\u6784\uff1a\u6587\u672c\u6d41 \\(c\\) \u4e0e\u56fe\u50cf\u6d41 \\(x\\) \u5404\u81ea\u7528\u72ec\u7acb\u6743\u91cd\u5904\u7406\uff0c\u4ec5\u5728\u6ce8\u610f\u529b\u5904\u4ea4\u4e92\uff0c\u4ee5\u66f4\u597d\u4fdd\u7559\u5404\u81ea\u6a21\u6001\u7279\u5f81\u3002</li> <li>\u5168\u5c40\u8c03\u5236\uff1a\u7531\u65f6\u95f4\u6b65 \\(t\\) \u4e0e\u6c47\u805a\u6587\u672c\u5411\u91cf\u6784\u6210\u7684 \\(y\\) \u7ecf SiLU+Linear\uff0c\u4e3a\u4e24\u6d41\u5404\u81ea\u4ea7\u751f 6 \u7ec4\u8c03\u5236\u53c2\u6570\uff08\\(\\alpha,\\beta,\\gamma,\\delta,\\epsilon,\\zeta\\)\uff09\uff0c\u5728\u5404\u5b50\u6a21\u5757\u4e2d\u6ce8\u5165\u65f6\u5e8f\u4e0e\u8bed\u4e49\u3002</li> <li>\u81ea\u9002\u5e94\u5f52\u4e00\u5316\uff1a\u8fdb\u5165 Attention/MLP \u524d\u5148\u505a LayerNorm\uff0c\u518d\u6309 \\(\\text{Mod}(u)=\\alpha\\cdot\\text{LayerNorm}(u)+\\beta\\) \u8c03\u5236\uff0c\u5b9e\u73b0\u53ef\u63a7\u7684\u7f29\u653e\u4e0e\u5e73\u79fb\u3002</li> <li>\u8054\u5408\u6ce8\u610f\u529b\uff1a\u4e24\u6d41\u5206\u522b\u751f\u6210 Q/K/V\uff0c\u6cbf\u5e8f\u5217\u62fc\u63a5\u540e\u505a\u81ea\u6ce8\u610f\u529b\uff0c\u5b8c\u6210\u8de8\u6a21\u6001\u4fe1\u606f\u4ea4\u6362\uff0c\u968f\u540e\u518d\u62c6\u56de\u4e24\u6d41\uff08\u53ef\u9009 QK RMS-Norm \u63d0\u5347\u7a33\u5b9a\u6027\uff09\u3002</li> <li>\u95e8\u63a7\u6b8b\u5dee\uff1aAttention \u7528 \\(\\gamma\\)\u3001MLP \u7528 \\(\\zeta\\) \u7f29\u653e\u540e\u4e0e\u8f93\u5165\u505a\u6b8b\u5dee\u76f8\u52a0\uff0c\u4fbf\u4e8e\u6df1\u5c42\u8bad\u7ec3\u5e76\u9009\u62e9\u6027\u6291\u5236/\u589e\u5f3a\u6a21\u5757\u8d21\u732e\u3002</li> <li>\u72ec\u7acb MLP\uff1a\u4e24\u6d41\u5404\u81ea\u4f7f\u7528 Linear-\u6fc0\u6d3b-Linear \u7684 MLP\uff0c\u5e76\u914d\u5408 \\(\\delta,\\epsilon\\) \u7b49\u8fdb\u884c AdaLN \u8c03\u5236\u3002</li> </ol> <p></p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#qwen-imageimage-generate","title":"Qwen-Image(Image Generate)","text":"<p>Note</p> <p>\u5229\u7528 Qwen2.5-VL \u5b9e\u73b0\u4e86\u6781\u5f3a\u7684\u8bed\u4e49\u7406\u89e3\u548c\u591a\u6a21\u6001\u6307\u4ee4\u9075\u5faa\u80fd\u529b \u901a\u8fc7 \u7279\u5236\u7684 VAE \u89e3\u7801\u5668 \u89e3\u51b3\u4e86\u201cAI \u751f\u6210\u6587\u5b57\u4e71\u7801\u201d\u7684\u5e38\u89c1\u75db\u70b9</p> <p>\u6574\u4f53\u6d41\u7a0b</p> Bash<pre><code>\u591a\u8def\u8f93\u5165\uff08System/User prompt\uff0c\u9009\u586b\u56fe\u50cf\uff09\u2192 Qwen2.5-VL \u63d0\u53d6\u6761\u4ef6\u7279\u5f81\n\u2192 \u521d\u59cb\u566a\u58f0\u4e0e\u6f5c\u5728\u7279\u5f81\u7ed3\u5408\u5e76\u6ce8\u5165\u65f6\u95f4\u6b65 t \u2192 \u591a\u5c42 MMDiT \u5904\u7406\n\u2192 UnPatchify -&gt; VAE \u89e3\u7801\u6210\u56fe\u50cf\n</code></pre> <p>\u6761\u4ef6\u7f16\u7801\u5668\uff08Qwen2.5-VL\uff09 \u8be5\u6a21\u578b\u8bed\u8a00-\u89c6\u89c9\u7a7a\u95f4\u5df2\u5bf9\u9f50\uff1b\u4fdd\u7559\u5f3a\u8bed\u8a00\u7406\u89e3\uff1b\u539f\u751f\u652f\u6301\u56fe\u50cf\u8f93\u5165\uff08\u9002\u5408\u7f16\u8f91/\u56fe\u751f\u56fe\uff09\u3002\u7528\u7279\u5236 System Prompt\uff0c\u5f15\u51fa\u6700\u540e\u4e00\u5c42 hidden state \u4f5c\u4e3a\u6761\u4ef6\u5411\u91cf\u3002 VAE Encoder VAE Encoder \u5c06\u56fe\u50cf\u4ece\u201c\u50cf\u7d20\u7a7a\u95f4\u201d\u6620\u5c04\u5230\u201c\u6f5c\u7a7a\u95f4\uff08Latent Space\uff09\u201d\u3002\u8fd9\u6781\u5927\u5730\u964d\u4f4e\u4e86\u6570\u636e\u7684\u7ef4\u5ea6\uff0c\u4f7f\u5f97 MMDiT \u80fd\u591f\u9ad8\u6548\u5730\u8fdb\u884c\u53bb\u566a\u8bad\u7ec3\u3002 MM-DiT \u7c7b\u4f3c SD \u6a21\u578b\u7684 MMDiT\uff0c\u53cc\u6d41\uff08\u6587\u672c/\u56fe\u50cf\uff09\u5404\u81ea\u72ec\u7acb\u7684 Gate/MLP/Norm\uff0c\u4ec5\u5728\u81ea\u6ce8\u610f\u529b\u4e2d\u4ea4\u4e92\uff1b\u65f6\u95f4\u6b65 t \u7ecf MLP \u751f\u6210 Scale/Shift \u6ce8\u5165\u5404\u5c42 Norm\uff0c\u63a7\u5236\u53bb\u566a\u8fdb\u5ea6\u3002 MS-RoPE \u89e3\u51b3\u6587\u672c/\u56fe\u50cf\u4f4d\u7f6e\u7f16\u7801\u6df7\u6dc6\uff1b\u5c06\u6587\u672c\u89c6\u4f5c 2D\uff0c\u5e76\u5728\u4f4d\u7f6e\u7a7a\u95f4\u4e0e\u56fe\u50cf\u505a\u201c\u5bf9\u89d2\u7ebf\u62fc\u63a5\u201d\uff0c\u65e2\u4fdd\u7559\u56fe\u50cf\u5206\u8fa8\u7387\u53ef\u6269\u5c55\u6027\uff0c\u53c8\u4fdd\u6301\u6587\u672c\u4fa7 1D-RoPE \u7b49\u4ef7\u6027\uff0c\u63d0\u5347\u9ad8\u5206\u8fa8\u7387\u7a33\u5b9a\u6027\u3002</p> <p></p> <p></p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#cogvideoxvideo-generate","title":"CogVideoX(Video Generate)","text":"<p>\u6838\u5fc3\u6d41\u7a0b</p> <ul> <li>\u538b\u7f29\uff1a\u7528 3D Causal VAE \u628a\u89c6\u9891\u538b\u5230\u6f5c\u5728\u7a7a\u95f4\uff0c\u5f97\u5230\u957f\u5e8f\u5217 z_vision\uff1b\u6587\u672c\u7ecf T5 \u7f16\u7801\u4e3a z_text\u3002</li> <li>\u878d\u5408\uff1a\u5728\u5e8f\u5217\u7ef4\u5ea6\u62fc\u63a5 \\(z_text \u2295 z_vision\\)\uff0c\u4f5c\u4e3a input \u4f20\u7ed9\u591a\u4e2a Expret Transforme r \u5757\u3002</li> <li>\u8fd8\u539f\uff1a\u8f93\u51fa\u5148 Unpatchify \u6062\u590d\u6f5c\u5728\u5f62\u72b6\uff0c\u518d\u7528 3D Causal VAE \u89e3\u7801\u6210\u89c6\u9891\u3002</li> </ul> <p>\u5173\u952e\u7ec4\u4ef6</p> <ul> <li>3D Causal VAE\uff1a\u540c\u65f6\u538b\u7f29\u7a7a\u95f4\u4e0e\u65f6\u95f4\uff0c\u4f7f\u7528\u56e0\u679c\u5377\u79ef\u4fdd\u8bc1\u751f\u6210\u7684\u65f6\u95f4\u987a\u5e8f\u4e00\u81f4\uff1b\u901a\u8fc7\u4e0a\u4e0b\u6587\u5e76\u884c\u652f\u6491\u957f\u89c6\u9891\u8bad\u7ec3\uff1b\u4ee5\u91cd\u5efa+\u611f\u77e5+KL \u4e3a\u4e3b\uff0c\u540e\u671f\u5c11\u91cf GAN \u63d0\u5347\u7ec6\u8282\u3002</li> </ul> <p></p> <ul> <li>Expert Transformer\uff1a</li> <li>Patchify\uff08\u5207\u7247\u5316\uff09\uff1a 3D \u56e0\u679c VAE \u7f16\u7801\u51fa\u5f62\u72b6\u4e3a \\(T \\times H \\times W \\times C\\) \u7684\u89c6\u9891\u6f5c\u5728\u53d8\u91cf\uff08\u5206\u522b\u4ee3\u8868\u5e27\u6570\u3001\u9ad8\u3001\u5bbd\u3001\u901a\u9053\uff09\u3002\u8fd9\u4e9b\u6f5c\u5728\u53d8\u91cf\u88ab\u5207\u7247\uff0c\u751f\u6210\u957f\u5ea6\u4e3a \\(\\frac{T}{q} \\cdot \\frac{H}{p} \\cdot \\frac{W}{p}\\) \u7684\u5e8f\u5217 \\(z_{vision}\\)\u3002</li> <li>3D-RoPE\uff1a\u5c06\u4f4d\u7f6e\u7f16\u7801\u6269\u5c55\u5230(x,y,t)\u4e09\u7ef4\uff0c\u5206\u522b\u7528 1D-RoPE \u5e76\u6309\u901a\u9053\u62fc\u63a5\uff0c\u63d0\u5347\u65f6\u7a7a\u5efa\u6a21\u80fd\u529b\u3002</li> <li>Expert Adaptive LayerNrom\uff1a\u6587\u672c\u4e0e\u89c6\u9891\u4e24\u5957\u72ec\u7acb\u8c03\u5236\u5f52\u4e00\u5316\uff0c\u7f13\u89e3\u8de8\u6a21\u6001\u5c3a\u5ea6\u4e0e\u5206\u5e03\u5dee\u5f02\u3002</li> <li>3D Full Attention\uff1a\u7edf\u4e00\u5728\u65f6\u7a7a\u7ef4\u5ea6\u505a\u6df7\u5408\u6ce8\u610f\u529b\uff0c\u501f\u52a9 FlashAttention \u4e0e\u5e76\u884c\u6280\u5de7\u628a\u7b97\u529b\u538b\u529b\u964d\u5230\u53ef\u63a5\u53d7\u3002</li> </ul> <p></p> <p>\u4e3a\u4ec0\u4e48\u8981\u8fd9\u6837\u8bbe\u8ba1</p> <ul> <li>3D Causal VAE \u7684\u4f5c\u7528\uff1a\u538b\u7f29\u89c6\u9891\u6570\u636e\uff0c\u51cf\u5c0f\u8ba1\u7b97\u91cf\uff0c\u540c\u65f6\u4fdd\u8bc1\u65f6\u95f4\u987a\u5e8f\u4e00\u81f4\u6027\uff0c\u4fbf\u4e8e\u540e\u7eed Transformer \u5904\u7406\u957f\u5e8f\u5217\u3002</li> <li>3D-RoPE \u7684\u4f5c\u7528\uff1a3D-RoPE \u4e13\u95e8\u4e3a\u89c6\u9891\u8bbe\u8ba1\uff0c\u544a\u8bc9\u6a21\u578b\u6bcf\u4e2a\u5757\u5728\u7a7a\u95f4 \\((x, y)\\) \u548c\u65f6\u95f4 \\((t)\\) \u4e0a\u7684\u5177\u4f53\u4f4d\u7f6e\u3002</li> <li>3D Full Attention \u7684\u4f5c\u7528\uff1a\u540c\u65f6\u8ba1\u7b97\u6240\u6709\u5e27\u3001\u6240\u6709\u4f4d\u7f6e\u7684\u5173\u7cfb\u3002\u8fd9\u8ba9\u6a21\u578b\u80fd\u76f4\u63a5\u6355\u6349\u5927\u5e45\u5ea6\u7684\u8fd0\u52a8\uff0c\u4fdd\u8bc1\u7269\u4f53\u5728\u8fd0\u52a8\u4e2d\u4e0d\u8d70\u6837</li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#hunyuanvideovideo-generate","title":"HunyuanVideo(Video Generate)","text":"<p>\u67b6\u6784\u6982\u89c8</p> <ul> <li>Latent DiT\uff1a\u8f93\u5165\u4e3a\u566a\u58f0\u6f5c\u53d8\u91cf + \u6587\u672c/\u56fe\u50cf\u6761\u4ef6\uff0c\u4e3b\u5e72\u4e3a\u7ea6 13B \u53c2\u6570\u7684 Transformer\u3002</li> <li>\u8bad\u7ec3\u76ee\u6807\uff1a\u91c7\u7528 Flow Matching\uff0c\u76f8\u6bd4\u6269\u6563\u635f\u5931\uff0c\u751f\u6210\u8f68\u8ff9\u66f4\u76f4\u66f4\u7a33</li> </ul> <p></p> <p>\u6838\u5fc3\u7ec4\u4ef6</p> <ul> <li>3D Causal VAE\uff1a\u65f6\u7a7a\u538b\u7f29\u7387\u4e3a \\(4 \\times 8 \\times 8\\)\uff0c\u6f5c\u5728\u901a\u9053\u6570 16\uff1b\u56e0\u679c Conv3D \u786e\u4fdd\u7b2c t \u5e27\u4e0d\u4f9d\u8d56\u672a\u6765\u5e27\uff0c\u63d0\u5347\u65f6\u5e8f\u4e00\u81f4\u6027\u3002</li> <li>Text Encoder\uff1a\u4f7f\u7528\u589e\u52a0\u4e86 bidirectional attention \u7684 MLLM </li> <li>Diffusion Backbone\uff1a\u5148\u53cc\u6d41 20 \u5c42\uff08\u6587\u672c/\u89c6\u9891\u5404\u81ea\u5efa\u6a21\uff0c\u65e0\u8de8\u6d41\u6ce8\u610f\u529b\uff09\uff0c\u518d\u5355\u6d41 40 \u5c42\uff08\u62fc\u63a5\u540e Full Attention \u6df1\u5ea6\u878d\u5408\uff09\u3002 </li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#dit","title":"DiT \u6a21\u578b\u7684\u5e38\u89c1\u7ec4\u4ef6","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#vae-encoderdecoder","title":"VAE Encoder/Decoder","text":"<p>VAE \u8d1f\u8d23\u5728\u50cf\u7d20\u57df\u4e0e\u6f5c\u5728\u57df\u4e4b\u95f4\u5f80\u8fd4\u6620\u5c04\uff1aEncoder \u5c06\u56fe\u50cf/\u89c6\u9891\u4ece\u50cf\u7d20\u7a7a\u95f4\u538b\u7f29\u5230\u6f5c\u7a7a\u95f4\uff08Latent Space\uff09\uff0c\u663e\u8457\u964d\u7ef4\u4ee5\u4fbf DiT \u9ad8\u6548\u5efa\u6a21\uff1bDecoder \u5c06\u6f5c\u53d8\u91cf\u8fd8\u539f\u4e3a\u50cf\u7d20\u3002</p> <ul> <li>\u538b\u7f29\u6bd4\u4f8b\uff1a\u56fe\u50cf\u5e38\u89c1 \\(8\\times8\\) \u6216 \\(16\\times16\\)\uff1b\u89c6\u9891\u5e38\u89c1\u65f6\u7a7a\u538b\u7f29\u5982 \\(4\\times8\\times8\\)\uff08Time\u00d7H\u00d7W\uff09\u3002</li> <li>2D vs 3D\uff1a\u56fe\u50cf\u7528 2D VAE\uff1b\u89c6\u9891\u66f4\u504f\u5411 3D VAE\uff08\u542b 3D \u5377\u79ef\uff09\u3002\u4e3a\u4fdd\u8bc1\u751f\u6210\u65f6\u5e8f\u6b63\u786e\uff0c\u5e38\u7528\u56e0\u679c\u5377\u79ef\uff08Temporally Causal Conv\uff09\uff0c\u4ec5\u4f9d\u8d56\u5f53\u524d\u53ca\u8fc7\u53bb\u5e27\uff0c\u7f13\u89e3\u95ea\u70c1\uff08flickering\uff09\u3002</li> <li>\u635f\u5931\u7ec4\u5408\uff1a\u91cd\u5efa\u635f\u5931\uff08L1/L2\uff09+ \u611f\u77e5\u635f\u5931\uff08LPIPS\uff09+ KL \u6b63\u5219\uff0c\u90e8\u5206\u5de5\u4f5c\u4f1a\u5728\u540e\u671f\u52a0\u5165\u5c11\u91cf GAN \u635f\u5931\u4ee5\u589e\u5f3a\u7ec6\u8282\u4e14\u6291\u5236\u7f51\u683c\u4f2a\u5f71\u3002</li> <li>\u8bad\u7ec3\u4e0e\u5de5\u7a0b\uff1a\u7f16\u7801\u5668\u5e38\u51bb\u7ed3\u4ee5\u7a33\u5b9a\u6f5c\u7a7a\u95f4\uff1b\u5bf9\u6587\u672c\u5bc6\u96c6\u573a\u666f\uff08\u6d77\u62a5/PDF\uff09\u53ef\u5fae\u8c03\u89e3\u7801\u5668\u4ee5\u63d0\u5347\u6587\u5b57\u8fd8\u539f\uff1bPatchify/Unpatchify \u7528\u4e8e\u6f5c\u5728\u5f20\u91cf\u4e0e\u5e8f\u5217\u4e4b\u95f4\u7684\u9ad8\u6548\u8f6c\u6362\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#text-encoder","title":"Text Encoder(\u6587\u672c\u7f16\u7801\u5668)","text":"<p>\u5c06\u81ea\u7136\u8bed\u8a00\u8f6c\u4e3a\u9ad8\u7ef4\u5411\u91cf\uff08\u5982 \\(z_{text}\\)/token embeddings\uff09\uff0c\u6355\u6349\u5bf9\u8c61\u3001\u5c5e\u6027\u3001\u5173\u7cfb\u3001\u98ce\u683c\u4e0e\u6307\u4ee4\u8bed\u4e49\uff0c\u7528\u4e8e\u7ea6\u675f/\u5f15\u5bfc\u751f\u6210\u3002</p> <ul> <li>\u6761\u4ef6\u6ce8\u5165\u65b9\u5f0f\uff1a</li> <li>\u62fc\u63a5\u5f0f\uff08Concatenation/Joint Attention\uff09\uff1a\u5c06\u6587\u672c\u4e0e\u89c6\u89c9\u5e8f\u5217\u62fc\u63a5\u5230\u540c\u4e00 Transformer \u4e2d\u505a\u81ea\u6ce8\u610f\u529b\uff08\u5982 MM-DiT\uff09\u3002</li> <li>\u4ea4\u53c9\u6ce8\u610f\u529b\uff08Cross-Attn\uff09\uff1a\u6587\u672c\u4f5c\u4e3a K/V\uff0c\u89c6\u89c9\u4e3a Q\uff0c\u5b9e\u73b0\u6761\u4ef6\u6ce8\u610f\u529b\uff08\u5e38\u89c1\u4e8e U-Net \u65f6\u4ee3\uff09\u3002</li> <li>\u5168\u5c40\u8c03\u5236\uff08AdaLN\uff09\uff1a\u5c06\u6c60\u5316\u540e\u7684\u6587\u672c\u5411\u91cf\u4e0e\u65f6\u95f4\u6b65 \\(t\\) \u5408\u6210\u8c03\u5236\u5411\u91cf \\(y\\)\uff0c\u4ea7\u51fa\u7f29\u653e/\u5e73\u79fb\u53c2\u6570\u6ce8\u5165\u5404\u5c42\u5f52\u4e00\u5316\u4e0e\u95e8\u63a7\u3002</li> <li>\u6307\u4ee4\u4e0e\u591a\u8bed\uff1aMLLM\uff08\u5982 LLaVA/Llama\u3001Qwen-VL \u7b49\uff09\u66f4\u64c5\u957f\u957f\u6307\u4ee4\u3001\u591a\u8f6e\u4e0e\u591a\u6a21\u6001\u6761\u4ef6\uff1b\u5b57\u5f62/\u591a\u8bed\u79cd\u589e\u5f3a\uff08glyph-aware\uff09\u6709\u52a9\u4e8e\u4e2d\u6587\u7b49\u542b\u6587\u5b57\u573a\u666f\u7684\u4e00\u81f4\u6027\u3002</li> <li>CFG \u4e0e\u8d1f\u63d0\u793a\uff1a\u901a\u8fc7 classifier-free guidance \u4e0e negative prompt \u8c03\u8282\u6587\u672c\u5bf9\u9f50\u5f3a\u5ea6\u4e0e\u591a\u6837\u6027\u3002</li> </ul> <p>\u4e3b\u6d41\u6a21\u578b</p> <ul> <li>CLIP (OpenAI)\uff1a\u7269\u4f53/\u98ce\u683c/\u6784\u56fe\u8868\u73b0\u597d\uff0c\u903b\u8f91\u4e0e\u957f\u6587\u672c\u8f83\u5f31\u3002</li> <li>T5 (Google)\uff1a\u5bf9\u957f\u53e5\u4e0e\u590d\u6742\u903b\u8f91\u53cb\u597d\uff0c\u9002\u5408\u4e25\u683c\u8bed\u4e49\u7ea6\u675f\u3002</li> <li>MLLM\uff08LLaVA/Llama\u3001Qwen-VL \u7b49\uff09\uff1a\u66f4\u5f3a\u6307\u4ee4\u9075\u5faa\u4e0e\u8de8\u6a21\u6001\u7406\u89e3\uff0c\u9002\u5408\u56fe\u6587\u6df7\u5408\u3001\u7f16\u8f91\u4e0e\u9ad8\u8bed\u4e49\u4e00\u81f4\u6027\u9700\u6c42\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#dit-diffusion-transformer","title":"DiT (Diffusion Transformer)","text":"<p>\u57fa\u4e8e Transformer \u7684\u6269\u6563/\u6d41\u5339\u914d\u9aa8\u5e72\uff0c\u8d1f\u8d23\u5728\u6f5c\u5728\u7a7a\u95f4\u5185\u9010\u6b65\u53bb\u566a\u6216\u62df\u5408\u6d41\u573a\uff0c\u751f\u6210\u4e0e\u6761\u4ef6\u4e00\u81f4\u7684\u6f5c\u53d8\u91cf\u3002</p> <ul> <li>\u6761\u4ef6\u7ec4\u6210\uff1a\u6587\u672c/\u56fe\u50cf\uff08\u6216\u89c6\u9891\uff09\u5d4c\u5165 + \u65f6\u95f4\u6b65\u5d4c\u5165 \\(t\\)\u3002\u65f6\u95f4\u6b65\u7ecf MLP \u4ea7\u51fa\u8c03\u5236\u53c2\u6570\uff08\u4e0e\u6587\u672c\u6c60\u5316\u5411\u91cf\u5408\u6210 \\(y\\)\uff09\u7528\u4e8e AdaLN\uff1b\u652f\u6301\u8d1f\u63d0\u793a/CFG\u3002</li> <li>\u7ed3\u6784\uff1a\u591a\u5934\u81ea\u6ce8\u610f\u529b + \u524d\u9988\u7f51\u7edc\uff0c\u914d\u5408\u95e8\u63a7\u6b8b\u5dee\uff08\\(\\gamma,\\zeta\\)\uff09\u4e0e\u5206\u5c42\u8c03\u5236\uff08\\(\\alpha,\\beta,\\delta,\\epsilon\\)\uff09\u7a33\u5b9a\u6df1\u5c42\u8bad\u7ec3\u3002</li> <li>\u4f4d\u7f6e\u7f16\u7801\uff1a\u56fe\u50cf\u5e38\u7528 2D RoPE\uff1b\u89c6\u9891\u5e38\u7528 3D RoPE \\((x,y,t)\\) \u63d0\u5347\u957f\u65f6\u7a7a\u4f9d\u8d56\uff1b\u53ef\u9009 QK-Norm/RMSNorm \u63d0\u5347\u8bad\u7ec3\u7a33\u5b9a\u6027\u3002</li> <li>\u4f18\u52bf\uff1aU-Net \u4ee5\u5377\u79ef/\u8df3\u8fde\u4e3a\u4e3b\uff0c\u611f\u53d7\u91ce\u4e0e\u5168\u5c40\u5efa\u6a21\u53d7\u9650\uff1bDiT \u5168\u5c40\u6ce8\u610f\u529b\u66f4\u5229\u4e8e\u5927\u573a\u666f\u5173\u7cfb\u3001\u957f\u6587\u672c\u4e0e\u9ad8\u5206\u8fa8\u7387\u6269\u5c55\uff08Sora \u4ee5\u540e\u4e3b\u6d41\uff09\u3002</li> </ul> <p>Note</p> <p>\u4ee5\u524d\u4e3b\u6d41\u662f U-Net\uff08SD 1.5\uff09\uff0c\u5982\u4eca DiT\uff08Transformer\uff09\u56e0\u66f4\u5f3a\u7684\u5168\u5c40\u5efa\u6a21\u4e0e\u53ef\u6269\u5c55\u6027\u6210\u4e3a\u4e3b\u6d41\uff08Sora \u4ee5\u540e\uff09\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#dit_1","title":"DiT \u751f\u6210\u6a21\u578b\u7684\u4e00\u822c\u63a8\u7406\u6d41\u7a0b","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#1-condition-encoding","title":"1. \u6761\u4ef6\u7f16\u7801(Condition Encoding)","text":"<ul> <li>\u6587\u672c\u7f16\u7801 (Text Encoding):   \u7528\u6237\u8f93\u5165\u7684 Prompt \u88ab\u9001\u5165\u6587\u672c\u7f16\u7801\u5668\uff08\u5982 T5-XXL \u6216 CLIP\uff09\u3002</li> <li>\u56fe\u50cf\u7f16\u7801 (Image Encoding, \u53ef\u9009):   \u5982\u679c\u662f\u201c\u56fe\u751f\u89c6\u9891\u201d\uff0c\u9996\u5e27\u56fe\u7247\u4f1a\u7ecf\u8fc7 VAE Encoder \u88ab\u538b\u7f29\u6210 Latent\uff08\u6f5c\u53d8\u91cf\uff09\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#2-denoising-loop","title":"2. \u53bb\u566a\u5faa\u73af(Denoising Loop)","text":"<p>Warning</p> <p>\u6574\u4e2a\u6d41\u7a0b\u4e2d\u6700\u8017\u65f6\u7684\u90e8\u5206</p> <ul> <li> <p>\u521d\u59cb\u5316\u566a\u58f0: \u968f\u673a\u751f\u6210\u4e00\u4e2a\u9ad8\u65af\u566a\u58f0\u5f20\u91cf\uff0c\u5f62\u72b6\u901a\u5e38\u4e3a [Batch, Channels, Frames, Height, Width]\u3002</p> </li> <li> <p>\u8fed\u4ee3\u53bb\u566a (Scheduler Loop):</p> </li> <li> <p>\u6807\u51c6\u6d41\u7a0b: \u5faa\u73af 50 \u6b21\uff08Steps\uff09\u3002\u6bcf\u6b21\u5c06\u5f53\u524d Latent \u8f93\u5165 DiT/UNet \u6a21\u578b\uff0c\u9884\u6d4b\u566a\u58f0\u5e76\u51cf\u53bb\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#3-decoding","title":"3. \u89e3\u7801\u8fd8\u539f(Decoding)","text":"<ul> <li>VAE \u89e3\u7801 (VAE Decoding):</li> </ul> <p>\u53bb\u566a\u5b8c\u6210\u540e\u7684 Latent \u662f\u9ad8\u5ea6\u538b\u7f29\u7684\u3002\u9700\u8981\u901a\u8fc7 3D VAE Decoder \u5c06\u5176\u8fd8\u539f\u4e3a\u50cf\u7d20\u7a7a\u95f4\u7684\u89c6\u9891\u5e27\u3002</p> <ul> <li>\u540e\u5904\u7406: \u89c6\u9891\u5e27\u7684\u62fc\u63a5\u3001\u63d2\u5e27\uff08\u5982\u6709\u9700\u8981\uff09\u3001\u8f6c\u7801\uff08\u4fdd\u5b58\u4e3a MP4\uff09\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#dit_2","title":"DiT \u751f\u6210\u6a21\u578b\u4f18\u5316","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#condition-encoding","title":"Condition Encoding \u4f18\u5316","text":"<p>\u6587\u672c\u7f16\u7801\u5668\u91cf\u5316 (Text Encoder Quantization):</p> <p>fastvideo \u652f\u6301\u5c06 T5-XXL \u6216 CLIP \u4ee5 FP8 \u6216 INT8 \u7cbe\u5ea6\u52a0\u8f7d\u3002\u8fd9\u53ef\u4ee5\u5c06 T5 \u7684\u663e\u5b58\u5360\u7528\u4ece ~22GB \u964d\u4f4e\u5230 ~6GB \u5de6\u53f3\uff0c\u4e14\u5bf9\u751f\u6210\u8d28\u91cf\u5f71\u54cd\u6781\u5c0f\u3002</p> <p>CPU Offload (\u5378\u8f7d):</p> <p>\u7531\u4e8e\u6587\u672c\u7f16\u7801\u53ea\u5728\u7b2c\u4e00\u6b65\u8fd0\u884c\u4e00\u6b21\uff0c\u8ba1\u7b97\u5b8c\u62ff\u5230 Embedding \u540e\uff0cfastvideo \u4f1a\u7acb\u5373\u5c06 T5 \u6a21\u578b\u4ece GPU \u79fb\u56de CPU \u5185\u5b58\uff0c\u4e3a\u540e\u7eed\u7e41\u91cd\u7684 DiT \u817e\u51fa\u5b9d\u8d35\u7684 VRAM\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#denoising-loop","title":"Denoising Loop \u4f18\u5316","text":"<p>A. \u5e8f\u5217\u5e76\u884c (Sequence Parallelism / SP)\u8fd9\u662f fastvideo \u7684\u6740\u624b\u950f\u3002\u5f53\u89c6\u9891 Token \u5e8f\u5217\u592a\u957f\uff08\u6bd4\u5982 5 \u79d2\u89c6\u9891\u53ef\u80fd\u6709 100k+ tokens\uff09\uff0c\u5355\u5f20\u5361\u653e\u4e0d\u4e0b\u3002DeepSpeed Ulysses (DS-Ulysses): fastvideo \u96c6\u6210\u4e86\u8fd9\u4e00\u6280\u672f\u3002\u5b83\u5c06\u957f\u5e8f\u5217\uff08Video Tokens\uff09\u5728 Attention \u8ba1\u7b97\u7ef4\u5ea6\u4e0a\u5207\u5206\uff0c\u5206\u914d\u5230\u591a\u5f20 GPU \u4e0a\u5e76\u884c\u8ba1\u7b97\u3002\u6548\u679c\uff1a \u4ee5\u524d\u5355\u5361\u53ea\u80fd\u8dd1 2 \u79d2\u89c6\u9891\uff0c\u73b0\u5728 8 \u5361\u5e76\u884c\u53ef\u4ee5\u8dd1 16 \u79d2\u89c6\u9891\u3002Ring Attention: \u5bf9\u4e8e\u8d85\u957f\u4e0a\u4e0b\u6587\uff0c\u4f7f\u7528\u73af\u72b6\u901a\u4fe1\u4f20\u9012 Key/Value \u5757\uff0c\u8fdb\u4e00\u6b65\u7a81\u7834\u663e\u5b58\u5899\u3002B. \u7b97\u5b50\u4f18\u5316 (Kernel Optimization)Flash Attention \u2154: \u5f3a\u5236\u4f7f\u7528\u6700\u65b0\u7684 Flash Attention \u5e93\uff0c\u6781\u5927\u52a0\u901f Attention \u5c42\u7684\u8ba1\u7b97\uff08\\(O(N^2)\\) \u590d\u6742\u5ea6\u4f18\u5316\uff09\uff0c\u5e76\u663e\u8457\u964d\u4f4e\u663e\u5b58\u5360\u7528\u3002Fused Kernels (\u7b97\u5b50\u878d\u5408): \u5c06 Layernorm\u3001GeLU\u3001Add \u7b49\u7410\u788e\u7684\u5c0f\u7b97\u5b50\u5408\u5e76\u6210\u4e00\u4e2a\u5927\u7b97\u5b50\uff08Kernel\uff09\uff0c\u51cf\u5c11 GPU \u8bfb\u5199\u5185\u5b58\u7684\u6b21\u6570\u3002C. \u4f4e\u7cbe\u5ea6\u63a8\u7406 (FP8 Inference)\u4f7f\u7528 FP8 (Float8) \u683c\u5f0f\u8fdb\u884c\u77e9\u9635\u4e58\u6cd5\u3002\u76f8\u6bd4 BF16/FP16\uff0cFP8 \u7684\u541e\u5410\u91cf\u7ffb\u500d\uff0c\u663e\u5b58\u5360\u7528\u51cf\u534a\u3002D. \u65f6\u95f4\u6b65\u84b8\u998f (Timestep Distillation)\u867d\u7136\u8fd9\u662f\u6a21\u578b\u5c42\u9762\u7684\uff0c\u4f46 fastvideo \u5e38\u914d\u5408 LCM \u6216 Rectified Flow \u84b8\u998f\u6a21\u578b\uff0c\u5c06 50 \u6b65\u5faa\u73af\u51cf\u5c11\u5230 4-8 \u6b65\uff0c\u76f4\u63a5\u5e26\u6765 6-10 \u500d\u7684\u901f\u5ea6\u63d0\u5347\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#decoding","title":"Decoding \u4f18\u5316","text":"<p>Tiled Decoding (\u7a7a\u95f4\u5206\u5757\u89e3\u7801):\u539f\u7406\uff1a \u4e0d\u4e00\u6b21\u6027\u89e3\u7801\u6574\u5f20\u56fe\uff0c\u800c\u662f\u5c06 Latent \u5728\u7a7a\u95f4\u4e0a\u5207\u6210\u5c0f\u5757\uff08Tiles\uff0c\u6bd4\u5982 \\(512 \\times 512\\)\uff09\uff0c\u4e00\u5757\u5757\u89e3\u7801\uff0c\u6700\u540e\u62fc\u8d77\u6765\u3002\u4f18\u5316\uff1a \u4e3a\u4e86\u9632\u6b62\u62fc\u63a5\u5904\u51fa\u73b0\u63a5\u7f1d\uff08Seams\uff09\uff0cfastvideo \u4f1a\u5728\u5207\u5757\u8fb9\u7f18\u8fdb\u884c\u91cd\u53e0\u5904\u7406\uff08Overlap blending\uff09\u3002Temporal Slicing (\u65f6\u95f4\u5207\u7247\u89e3\u7801):\u539f\u7406\uff1a \u73b0\u5728\u7684 Video VAE \u5177\u6709\u65f6\u95f4\u538b\u7f29\u6027\u3002fastvideo \u4e0d\u4f1a\u4e00\u6b21\u89e3\u7801\u6574\u4e2a\u89c6\u9891\u7684\u6240\u6709\u5e27\uff0c\u800c\u662f\u6309\u201c\u7ec4\u201d\uff08\u6bd4\u5982\u6bcf 8 \u5e27\u4e00\u7ec4\uff09\u8fdb\u884c\u89e3\u7801\uff0c\u89e3\u7801\u5b8c\u4e00\u7ec4\u91ca\u653e\u663e\u5b58\uff0c\u518d\u89e3\u4e0b\u4e00\u7ec4\u3002VAE Tiling Parallelism (\u5e76\u884c\u5206\u5757):\u5982\u679c\u6709\u591a\u5f20\u5361\uff0c\u53ef\u4ee5\u5c06\u4e0d\u540c\u7684 Tiles \u5206\u53d1\u5230\u4e0d\u540c\u7684 GPU \u4e0a\u89e3\u7801\uff0c\u518d\u6c47\u805a\u7ed3\u679c\uff0c\u5229\u7528\u591a\u5361\u52a0\u901f\u8fd9\u4e00\u8fc7\u7a0b\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#sgl-diffusion-dit","title":"sgl-diffusion \u7684 DiT \u63a8\u7406\u6d41\u7a0b","text":"<p>calculate_shift \u548c prepare_mu \u7684\u7528\u9014 \u8fd9\u4e24\u4e2a\u51fd\u6570\u7528\u4e8e\u8ba1\u7b97 Flow Matching \u8c03\u5ea6\u5668 (Scheduler) \u7684\u65f6\u95f4\u6b65\u504f\u79fb\u91cf (Time Shift, \u03bc \u03bc)\u3002</p> <p>\u80cc\u666f: \u5728\u57fa\u4e8e Flow Matching \u7684\u6269\u6563\u6a21\u578b\uff08\u5982 Qwen-Image, Flux \u7b49\uff09\u4e2d\uff0c\u4e3a\u4e86\u66f4\u597d\u5730\u5904\u7406\u4e0d\u540c\u5206\u8fa8\u7387\u7684\u56fe\u50cf\u751f\u6210\uff0c\u901a\u5e38\u9700\u8981\u8c03\u6574\u65f6\u95f4\u6b65\uff08Timestep\uff09\u7684\u91c7\u6837\u5206\u5e03\u3002 calculate_shift: \u8fd9\u662f\u4e00\u4e2a\u7ebf\u6027\u63d2\u503c\u51fd\u6570\u3002\u5b83\u6839\u636e\u5f53\u524d\u7684\u56fe\u50cf\u5e8f\u5217\u957f\u5ea6 (image_seq_len)\uff0c\u5728\u57fa\u51c6\u957f\u5ea6 (base_seq_len) \u548c\u6700\u5927\u957f\u5ea6 (max_seq_len) \u4e4b\u95f4\u8fdb\u884c\u63d2\u503c\uff0c\u8ba1\u7b97\u51fa\u4e00\u4e2a\u5bf9\u5e94\u7684\u504f\u79fb\u503c mu\u3002 \u8f83\u5c0f\u7684\u56fe\u50cf\uff08\u5e8f\u5217\u77ed\uff09\u5bf9\u5e94\u8f83\u5c0f\u7684 mu (\u63a5\u8fd1 base_shift=0.5)\u3002 \u8f83\u5927\u7684\u56fe\u50cf\uff08\u5e8f\u5217\u957f\uff09\u5bf9\u5e94\u8f83\u5927\u7684 mu (\u63a5\u8fd1 max_shift=1.15)\u3002 prepare_mu: \u8fd9\u662f\u4e00\u4e2a\u8f85\u52a9\u51fd\u6570\uff0c\u7528\u4e8e\u4ece\u8bf7\u6c42 (batch) \u4e2d\u63d0\u53d6\u56fe\u50cf\u7684\u9ad8\u5bbd\uff0c\u8ba1\u7b97\u5e8f\u5217\u957f\u5ea6\uff0c\u7136\u540e\u8c03\u7528 calculate_shift \u5f97\u5230 mu \u503c\u3002 \u8fd4\u56de\u503c: (\"mu\", mu)\u3002\u8fd9\u4e2a\u952e\u503c\u5bf9\u4f1a\u88ab\u4f20\u9012\u7ed9 Scheduler \u7684 set_timesteps \u65b9\u6cd5\uff0c\u4ece\u800c\u52a8\u6001\u8c03\u6574\u751f\u6210\u8fc7\u7a0b\u4e2d\u7684\u65f6\u95f4\u6b65\u8c03\u5ea6\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#stage-pipeline","title":"Stage Pipeline \u8bbe\u7f6e","text":"Python<pre><code>def create_pipeline_stages(self, server_args: ServerArgs):\n    \"\"\"Set up pipeline stages with proper dependency injection.\"\"\"\n\n    self.add_stage(\n        stage_name=\"input_validation_stage\", stage=InputValidationStage()\n    )\n\n    self.add_stage(\n        stage_name=\"prompt_encoding_stage_primary\",\n        stage=TextEncodingStage(\n            text_encoders=[\n                self.get_module(\"text_encoder\"),\n            ],\n            tokenizers=[\n                self.get_module(\"tokenizer\"),\n            ],\n        ),\n    )\n\n    self.add_stage(stage_name=\"conditioning_stage\", stage=ConditioningStage())\n\n    self.add_stage(\n        stage_name=\"timestep_preparation_stage\",\n        stage=TimestepPreparationStage(\n            scheduler=self.get_module(\"scheduler\"),\n            prepare_extra_set_timesteps_kwargs=[prepare_mu],\n        ),\n    )\n\n    self.add_stage(\n        stage_name=\"latent_preparation_stage\",\n        stage=LatentPreparationStage(\n            scheduler=self.get_module(\"scheduler\"),\n            transformer=self.get_module(\"transformer\"),\n        ),\n    )\n\n    self.add_stage(\n        stage_name=\"denoising_stage\",\n        stage=DenoisingStage(\n            transformer=self.get_module(\"transformer\"),\n            scheduler=self.get_module(\"scheduler\"),\n        ),\n    )\n\n    self.add_stage(\n        stage_name=\"decoding_stage\", stage=DecodingStage(vae=self.get_module(\"vae\"))\n    )\n</code></pre>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#inputvalidationstage","title":"InputValidationStage","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#textencodingstage","title":"TextEncodingStage","text":"<p>\u652f\u6301\u591a\u91cd\u7f16\u7801\u5668 (Multi-Encoder Support) \u73b0\u5728\u7684\u5148\u8fdb\u6a21\u578b\uff08\u5982 SDXL, Flux\uff09\u901a\u5e38\u4e0d\u53ea\u4f7f\u7528\u4e00\u4e2a\u6587\u672c\u7f16\u7801\u5668</p>","tags":["LLMInference"]},{"location":"notes/diffusion/DiT%20Video%20Generate/#denoisingstage","title":"DenoisingStage","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/","title":"Masked Diffusion Large Language Model","text":"2025-12-102025-12-12 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#masked-diffusion-large-language-model","title":"Masked Diffusion Large Language Model","text":"<p> \u7ea6 4135 \u4e2a\u5b57  63 \u884c\u4ee3\u7801  7 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 21 \u5206\u949f</p> <p> \u8fd9\u91cc\u4ee5 Ant Group \u7684 LLaDA \u8bba\u6587\u4e3a\u4f8b\uff0c\u4ecb\u7ecd Masked Diffusion LLM \u7684\u57fa\u672c\u539f\u7406\u548c\u5b9e\u73b0\u65b9\u6cd5\uff1b\u540e\u9762\u7ed3\u5408 SGLang \u5bf9\u8be5\u6a21\u578b\u7684\u63a8\u7406\u5b9e\u73b0\u8fdb\u884c\u8bf4\u660e\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#traing-details","title":"Traing Details","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#masked-diffusion-model","title":"\u57fa\u4e8e\u63a9\u7801\u7684\u6269\u6563\u6a21\u578b(Masked Diffusion Model)","text":"<p>LLaDA \u901a\u8fc7\u5b9a\u4e49\u524d\u5411\u8fc7\u7a0b\uff08Forward Process\uff09\u548c\u53cd\u5411\u8fc7\u7a0b\uff08Reverse Process\uff09\u6765\u5efa\u7acb\u6a21\u578b\u5206\u5e03 \\(p_\\theta(x_0)\\)\u3002 - \u524d\u5411\u8fc7\u7a0b\uff08\u7834\u574f\u6570\u636e\uff09\uff1aLLaDA \u4e0d\u50cf\u4f20\u7edf\u6269\u6563\u6a21\u578b\u90a3\u6837\u6dfb\u52a0\u9ad8\u65af\u566a\u58f0\uff0c\u800c\u662f\u901a\u8fc7\u63a9\u7801\uff08Masking\uff09 \u6765\u7834\u574f\u6570\u636e\u3002   - \u7ed9\u5b9a\u4e00\u4e2a\u6587\u672c\u5e8f\u5217 \\(x_0\\)\uff0c\u8fc7\u7a0b\u4ece \\(t=0\\)\uff08\u65e0\u63a9\u7801\uff09\u8fdb\u884c\u5230 \\(t=1\\)\uff08\u5168\u63a9\u7801\uff09\u3002   - \u5728\u4efb\u610f\u65f6\u95f4\u6b65 \\(t \\in (0, 1)\\)\uff0c\u5e8f\u5217 \\(x_t\\) \u4e2d\u7684\u6bcf\u4e00\u4e2a Token \u90fd\u6709 \\(t\\) \u7684\u6982\u7387\u88ab\u63a9\u76d6\uff08\u53d8\u6210 [MASK]\uff09\uff0c\u6216\u8005\u4ee5 \\(1-t\\)    - \u4f7f\u7528\u7684\u63a9\u7801\u6bd4\u4f8b\u662f\u968f\u673a\u7684\uff08\\(0\\) \u5230 \\(1\\) \u4e4b\u95f4\uff09\uff0c\u800c BERT \u4f7f\u7528\u7684\u662f\u56fa\u5b9a\u7684\u6bd4\u4f8b\u3002\u8fd9\u4f7f\u5f97 LLaDA \u5728\u6570\u5b66\u4e0a\u6210\u4e3a\u4e00\u4e2a\u6709\u539f\u5219\u7684\u751f\u6210\u6a21\u578b\uff0c\u80fd\u591f\u903c\u8fd1\u6700\u5927\u4f3c\u7136\u4f30\u8ba1\u3002 - \u53cd\u5411\u8fc7\u7a0b\uff08\u6062\u590d\u6570\u636e\uff09\u4e0e\u8bad\u7ec3\u76ee\u6807\uff1aLLaDA \u7684\u6838\u5fc3\u662f\u4e00\u4e2a\u63a9\u7801\u9884\u6d4b\u5668\uff08Mask Predictor\uff09 \\(p_\\theta(\\cdot|x_t)\\)\uff0c\u5b83\u63a5\u6536\u90e8\u5206\u88ab\u63a9\u76d6\u7684\u5e8f\u5217 \\(x_t\\)\uff0c\u5e76\u540c\u65f6\u9884\u6d4b\u6240\u6709\u88ab\u63a9\u76d6\u7684 Token\u3002\u5176\u635f\u5931\u51fd\u6570\u5b9a\u4e49\u4e3a\uff1a \\(\\(L(\\theta) \\triangleq -E_{t,x_0,x_t} \\left[ \\frac{1}{t} \\sum_{i=1}^{L} 1[x_i^t = M] \\log p_\\theta(x_i^0|x_t) \\right]\\)\\)   - \\(t\\): \u65f6\u95f4\u6b65/\u566a\u58f0\u6c34\u5e73\u3002   - \\(x_0\\): \u539f\u59cb\u7684\u3001\u5e72\u51c0\u7684\u6570\u636e\u6837\u672c\uff08\u4f8b\u5982\u4e00\u53e5\u8bdd\u6216\u4e00\u5f20\u56fe\u7684 Token \u5e8f\u5217\uff09\u3002   - \\(x_t\\): \u88ab\u7834\u574f\uff08\u52a0\u566a/\u63a9\u7801\uff09\u540e\u7684\u6570\u636e\u6837\u672c\u3002   - \\(t \\sim [0, 1]\\) (Continuous Random Variable)\u8fd9\u662f\u4e00\u4e2a\u8fde\u7eed\u7684\u65f6\u95f4\u53d8\u91cf\uff0c\u4ece 0 \u5230 1 \u5747\u5300\u91c7\u6837   - \\(\\mathbf{1}[x_t^i = \\text{M}]\\): \u5982\u679c\u4f4d\u7f6e \\(i\\) \u4e0a\u7684 Token \u662f\u63a9\u7801\u6807\u8bb0\uff08\\(M\\)\uff09\uff0c\u5219\u8be5\u9879\u4e3a 1\uff1b\u5426\u5219\u4e3a 0\u3002   - \\(\\log p_\\theta(x_0^i | x_t)\\): \u7ed9\u5b9a\u88ab\u7834\u574f\u7684\u5e8f\u5217 \\(x_t\\)\uff0c\u6a21\u578b\u9884\u6d4b\u4f4d\u7f6e \\(i\\) \u5904\u7684\u539f\u59cb Token \u662f \\(x_0^i\\) \u7684\u6982\u7387\u3002   - \u7cfb\u6570 \\(\\frac{1}{t}\\) \u81f3\u5173\u91cd\u8981\uff0c\u5b83\u4f7f\u5f97\u8be5\u635f\u5931\u51fd\u6570\u6210\u4e3a\u6a21\u578b\u8d1f\u5bf9\u6570\u4f3c\u7136\u7684\u4e0a\u754c\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86 LLaDA \u5177\u6709\u575a\u5b9e\u7684\u751f\u6210\u6a21\u578b\u7406\u8bba\u57fa\u7840\u3002</p> <p>Note</p> <p>\u8fd9\u4e2a\u516c\u5f0f\u5f15\u5165\u4e86\u8fde\u7eed\u65f6\u95f4 \\(t\\)\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u8bad\u7ec3\u4e00\u4e2a\u751f\u6210\u6a21\u578b\u3002\u5728\u63a8\u7406\uff08\u751f\u6210\uff09\u9636\u6bb5\uff0c\u6a21\u578b\u4f1a\u4ece\u4e00\u4e2a\u5168 [MASK] \u7684\u5e8f\u5217\u5f00\u59cb\uff0c\u8fed\u4ee3\u5730\u3001\u4e00\u70b9\u4e00\u70b9\u5730\u6839\u636e\u7f6e\u4fe1\u5ea6\u628a [MASK] \u586b\u56de\u53bb\uff0c\u6700\u7ec8\u751f\u6210\u5b8c\u6574\u7684\u5185\u5bb9\u3002\u8fd9\u901a\u5e38\u88ab\u79f0\u4e3a Iterative Decoding\uff08\u8fed\u4ee3\u89e3\u7801\uff09 \u6216 Discrete Diffusion\uff08\u79bb\u6563\u6269\u6563\uff09\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#pre-training","title":"\u9884\u8bad\u7ec3 (Pre-training)","text":"<p>LLaDA \u7684\u9884\u8bad\u7ec3\u65e8\u5728\u8ba9\u6a21\u578b\u5b66\u4f1a\u4ece\u4e0d\u540c\u7a0b\u5ea6\u7684\u63a9\u7801\u4e2d\u6062\u590d\u6587\u672c\u3002 - \u6a21\u578b\u67b6\u6784\uff1a   - \u53cc\u5411\u6ce8\u610f\u529b\uff1a\u4e0e GPT \u7cfb\u5217\uff08\u81ea\u56de\u5f52\u6a21\u578b\uff09\u4e0d\u540c\uff0cLLaDA \u4f7f\u7528\u7684 Transformer \u4e0d\u4f7f\u7528\u56e0\u679c\u63a9\u7801\uff08Causal Mask\uff09\u3002\u8fd9\u610f\u5473\u7740\u5728\u9884\u6d4b\u65f6\uff0c\u6a21\u578b\u53ef\u4ee5\u770b\u5230\u4e0a\u4e0b\u6587\u4e2d\u7684\u6240\u6709\u5185\u5bb9\uff08\u5305\u62ec\u201c\u672a\u6765\u201d\u7684 Token\uff0c\u5982\u679c\u5b83\u4eec\u6ca1\u88ab\u63a9\u76d6\u7684\u8bdd\uff09\u3002   - MHA not GQA\uff1a\u4e3a\u4e86\u9002\u5e94\u67b6\u6784\uff0cLLaDA \u505a\u4e86\u4e00\u4e9b\u5fae\u8c03\u3002\u4f8b\u5982\uff0c\u5b83\u4f7f\u7528\u6807\u51c6\u7684\u591a\u5934\u6ce8\u610f\u529b\uff08MHA\uff09\u800c\u4e0d\u662f\u5206\u7ec4\u67e5\u8be2\u6ce8\u610f\u529b\uff08GQA\uff09\uff0c\u56e0\u4e3a\u5b83\u4e0d\u4f7f\u7528 KV Cache\u3002\u4e3a\u4e86\u4fdd\u6301\u53c2\u6570\u91cf\u4e0e LLaMA3 8B \u4e00\u81f4\uff0c\u5b83\u76f8\u5e94\u51cf\u5c11\u4e86\u524d\u9988\u795e\u7ecf\u7f51\u7edc\uff08FFN\uff09\u7684\u7ef4\u5ea6\u3002</p> <p>Note</p> <p>Why MHA not GQA? \u56e0\u4e3a LLaDA \u4e0e KV Cache \u4e0d\u517c\u5bb9\u3002GQA \u7684\u4e3b\u8981\u76ee\u7684\u662f\u4e3a\u4e86\u51cf\u5c11 KV Cache \u7684\u663e\u5b58\u5360\u7528\uff0c\u65e2\u7136\u7528\u4e0d\u4e86 KV Cache\uff0cGQA \u7684\u4f18\u52bf\u4e5f\u5c31\u6ca1\u4e86\uff0c\u4e0d\u5982\u76f4\u63a5\u7528\u53c2\u6570\u66f4\u591a\u7684 MHA \u6765\u6362\u53d6\u6027\u80fd</p> <ul> <li>\u9884\u8bad\u7ec3\u6d41\u7a0b\uff1a\u8bad\u7ec3\u65f6\uff0c\u5bf9\u6bcf\u4e2a\u5e8f\u5217\u968f\u673a\u91c7\u6837\u4e00\u4e2a\u65f6\u95f4\u6b65 \\(t \\in [0, 1]\\)\uff0c\u7136\u540e\u6309\u6982\u7387 \\(t\\) \u72ec\u7acb\u63a9\u76d6 Token\u3002<ul> <li>\u8f93\u5165\u662f\u4e00\u6bb5\u5b8c\u6574\u7684\u6587\u672c\uff08\u5982\u56fe\u4e2d\u4e0a\u65b9\u5f69\u8272\u65b9\u5757\uff09\u3002</li> <li>\u91c7\u6837\u4e00\u4e2a\u63a9\u7801\u6bd4\u4f8b \\(t\\)\uff08Mask ratio\uff09\u3002\u72ec\u7acb\u5730\u63a9\u76d6\u6240\u6709 Token\uff0c\u65e0\u8bba\u662f\u524d\u9762\u7684\u8fd8\u662f\u540e\u9762\u7684 Token\uff0c\u90fd\u6709\u53ef\u80fd\u88ab\u6362\u6210 Mask token\u3002</li> <li>\u9884\u6d4b\uff1aMask predictor \u63a5\u6536\u8fd9\u4e2a\u6b8b\u7f3a\u7684\u5e8f\u5217\uff0c\u8bd5\u56fe\u8fd8\u539f\u90a3\u4e9b\u88ab\u63a9\u76d6\u7684 Token\u3002</li> </ul> </li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#supervised-fine-tuning-sft","title":"\u76d1\u7763\u5fae\u8c03 (Supervised Fine-Tuning, SFT)","text":"<p>\u8fd9\u662f\u8ba9 LLaDA \u5177\u5907\u5bf9\u8bdd\u548c\u6307\u4ee4\u9075\u5faa\u80fd\u529b\u7684\u5173\u952e\u6b65\u9aa4\u3002SFT \u9700\u8981\u6a21\u62df\u6761\u4ef6\u5206\u5e03 \\(p_\\theta(r_0|p_0)\\)\uff0c\u5373\u7ed9\u5b9a\u63d0\u793a\u8bcd\uff08Prompt\uff09\u751f\u6210\u56de\u590d\uff08Response\uff09\u3002\u5c06 Prompt (\\(p_0\\)) \u548c Response (\\(r_0\\)) \u62fc\u63a5\u5728\u4e00\u8d77\u3002 - Prompt \u90e8\u5206\uff1a\u4fdd\u6301\u5b8c\u5168\u4e0d\u63a9\u76d6\uff0c\u4f5c\u4e3a\u5df2\u77e5\u6761\u4ef6\u3002 - Response \u90e8\u5206\uff1a\u6309\u7167\u6982\u7387 \\(t\\) \u8fdb\u884c\u72ec\u7acb\u63a9\u76d6\uff0c\u751f\u6210 \\(r_t\\)\u3002</p> <p>\u6a21\u578b\u9700\u8981\u6839\u636e\u5b8c\u6574\u7684 Prompt \u548c\u6b8b\u7f3a\u7684 Response \u6765\u586b\u8865\u7a7a\u7f3a\u3002\u8fd9\u5b9e\u9645\u4e0a\u662f\u5728\u6559\u6a21\u578b\u201c\u6839\u636e\u95ee\u9898\u5199\u7b54\u6848\u201d\uff08\u5fae\u8c03\uff0cFine-tuning\uff09\u3002 \\(\\(\\mathcal{L} = -\\mathbb{E}_{t, p_0, r_0, r_t} \\left[ \\frac{1}{t} \\sum_{i=1}^{L'} \\mathbf{1}[r_t^i = \\text{M}] \\log p_\\theta(r_0^i \\mid p_0, r_t) \\right]\\)\\)</p> <p>\u8fd9\u4e2a\u516c\u5f0f\u7684\u6838\u5fc3\u903b\u8f91\u662f\uff1a\u7ed9\u5b9a\u4e00\u4e2a\u5b8c\u6574\u7684\u95ee\u9898\uff08Prompt\uff09\uff0c\u4ee5\u53ca\u4e00\u4e2a\u88ab\u90e8\u5206\u906e\u6321\u7684\u7b54\u6848\uff08Masked Response\uff09\uff0c\u8ba9\u6a21\u578b\u53bb\u586b\u8865\u7b54\u6848\u91cc\u7684\u7a7a\u7f3a</p> <ul> <li>\\(p_0\\) (Prompt): \u63d0\u793a\u8bcd/\u95ee\u9898\uff0c\u6a21\u578b\u59cb\u7ec8\u80fd\u770b\u5230\u5b8c\u6574\u7684\u95ee\u9898\u3002</li> <li>\\(r_0\\) (Response): \u539f\u59cb\u7684\u3001\u6b63\u786e\u7684\u56de\u590d/\u7b54\u6848\u3002</li> <li>\\(r_t\\) (Masked Response): \u88ab\u906e\u6321\uff08\u52a0\u566a\uff09\u540e\u7684\u56de\u590d\u3002\u8fd9\u662f\u968f\u65f6\u95f4\u6b65 \\(t\\) \u53d8\u5316\u7684\u3002\u90e8\u5206 token \u88ab\u66ff\u6362\u6210\u4e86 [MASK]\u3002</li> <li>\\(L'\\) (Dynamic Length): \u56de\u590d\u7684\u957f\u5ea6\u3002\u56e0\u4e3a\u6bcf\u4e2a\u95ee\u9898\u7684\u7b54\u6848\u957f\u5ea6\u90fd\u4e0d\u4e00\u6837\uff08\u6709\u7684\u7b54\u6848 10 \u4e2a\u5b57\uff0c\u6709\u7684 100 \u4e2a\u5b57\uff09\uff0c\u6240\u4ee5\u957f\u5ea6\u662f\u52a8\u6001\u7684\u3002</li> <li>\\(p_\\theta(r_0^i \\mid p_0, r_t)\\): \u6839\u636e\u5b8c\u6574\u7684\u95ee\u9898 (\\(p_0\\)) \u548c \u6b8b\u7f3a\u7684\u8349\u7a3f (\\(r_t\\))\uff0c\u731c\u51fa\u7b2c \\(i\\) \u4e2a\u4f4d\u7f6e\u539f\u672c\u7684\u8bcd (\\(r_0^i\\)) \u662f\u4ec0\u4e48\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#sampling","title":"\u91c7\u6837\u4e0e\u751f\u6210 (Sampling)","text":"<p>LLaDA \u7684\u751f\u6210\u662f\u4e00\u4e2a\u8fed\u4ee3\u7684\u53bb\u566a\u8fc7\u7a0b\uff1a - \u521d\u59cb\u72b6\u6001 (\\(t=1\\))\uff1aResponse \u90e8\u5206\u5168\u90fd\u662f Mask token\uff0cPrompt \u90e8\u5206\u4fdd\u6301\u53ef\u89c1\u3002 - \u4e2d\u95f4\u6b65\u9aa4 (Intermediate step)\uff1a\u6a21\u578b\u9884\u6d4b\u51fa\u6240\u6709 Token \u7684\u4e00\u79cd\u53ef\u80fd\u586b\u6cd5\uff0c\u7136\u540e\u6839\u636e\u8c03\u5ea6\u7b56\u7565\uff0c\u4fdd\u7559\u7f6e\u4fe1\u5ea6\u9ad8\u7684\uff0c\u91cd\u65b0\u63a9\u76d6 (Remask) \u7f6e\u4fe1\u5ea6\u4f4e\u7684\u3002</p> <p>Note</p> <p>\u539f\u5219\u4e0a\uff0c\u91cd\u63a9\u7801\u7b56\u7565\u5e94\u5f53\u662f\u7eaf\u968f\u673a\u7684\u3002\u7136\u800c\uff0c\u53d7 LLM \u91c7\u6837\u4e2d\u9000\u706b\u6280\u5de7 \u7684\u542f\u53d1\uff0cLlada \u91c7\u7528\u4e86\u4e00\u79cd\u4f4e\u7f6e\u4fe1\u5ea6\u91cd\u63a9\u7801\u7b56\u7565\uff08Low-confidence remasking strategy\uff09</p> <p>\u65f6\u95f4 \\(t \\in (0, 1]\\) \u5230 \\(s \\in [0, t)\\) \u7684\u4e2d\u95f4\u6b65\u9aa4\u4e2d\uff0c\u57fa\u4e8e\u9884\u6d4b\u7ed3\u679c\uff0c\u5c06\u7f6e\u4fe1\u5ea6\u6700\u4f4e\u7684\u90a3 \\(s/t\\) \u6bd4\u4f8b\u7684 Token \u91cd\u65b0\u63a9\u76d6</p> <ul> <li>\u6700\u7ec8\u72b6\u6001 (\\(t=0\\))\uff1a\u7ecf\u8fc7\u591a\u6b21\u8fed\u4ee3\uff0c\u6240\u6709 Mask \u90fd\u88ab\u66ff\u6362\u4e3a\u5177\u4f53\u7684 Token\uff0c\u5f62\u6210\u5b8c\u6574\u7684\u56de\u590d\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#sampling-strategies","title":"Sampling Strategies","text":"<ul> <li>\u81ea\u56de\u5f52\u91c7\u6837(Autoregressive Sampling)\uff1a \u4f20\u7edf\u7684\u9010\u6b65\u751f\u6210\u65b9\u6cd5\uff0c\u6bcf\u6b21\u751f\u6210 1 \u4e2a Token\uff0c\u76f4\u5230\u8fbe\u5230\u6307\u5b9a\u957f\u5ea6\u6216\u9047\u5230  \u6807\u8bb0\u3002</li> <li>\u5757\u6269\u6563\u91c7\u6837(Block Diffusion Sampling)\uff1a\u5728\u6bcf\u4e2a\u5757\uff08Block\uff09\u5185\u90e8\u5e94\u7528\u539f\u59cb\u7684\u9006\u5411\u6269\u6563\u8fc7\u7a0b\uff0c\u800c\u5728\u5757\u4e0e\u5757\u4e4b\u95f4\u5e94\u7528\u81ea\u56de\u5f52\u91c7\u6837\u3002\u5728\u539f\u59cb\u7684\u5757\u6269\u6563\u8fc7\u7a0b\u4e2d\uff0c\u5e8f\u5217\u957f\u5ea6\u662f\u52a8\u6001\u53d8\u5316\u7684\u3002</li> <li>Block Diffusion LLaDA\uff1aLLaDA \u4e5f\u53ef\u4ee5\u91c7\u7528\u56fa\u5b9a\u957f\u5ea6\u7684\u5757\u6269\u6563\u7b56\u7565\uff0c\u8bba\u6587\u4e2d\u79f0\u4e4b\u4e3a\u201cBlock Diffusion LLaDA\u201d\uff0c\u4e5f\u79f0\u4e3a\u534a\u81ea\u56de\u5f52\u91cd\u63a9\u7801(Semi-autoregressive Remasking)</li> </ul>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#inference","title":"Inference","text":"<p>\u63a9\u7801\u6269\u6563\u8bed\u8a00\u6a21\u578b (MDM) \u7684\u751f\u6210\u8fc7\u7a0b\u7531\u7f51\u7edc \\(p_\\theta\\) \u5efa\u6a21\uff0c\u8be5\u7f51\u7edc\u5728\u7ed9\u5b9a\u90e8\u5206\u52a0\u566a\u4e0a\u4e0b\u6587\u548c\uff08\u53ef\u9009\u7684\uff09\u65f6\u95f4 \\(t\\) \u7684\u6761\u4ef6\u4e0b\uff0c\u9884\u6d4b\u63a9\u7801\u4f4d\u7f6e\u7684\u6e05\u6670 Token (clean tokens) \u3002 - \u5728\u6bcf\u4e00\u6b65\u4e2d\uff0c\u7ed9\u5b9a\u5f53\u524d\u7684\u8bc1\u636e \\(E = (x_t, t)\\)\uff0c\u6a21\u578b\u4e3a\u6bcf\u4e2a\u4f4d\u7f6e \\(i\\) \u8ba1\u7b97 \\(p_\\theta(X_i = v | E)\\)\uff0c\u5e76\u9009\u62e9\u5177\u6709\u6700\u9ad8\u7f6e\u4fe1\u5ea6 \\(c_i(E) = \\max_{v \\in V} p_\\theta(X_i = v | E)\\) \u7684 Token \u8fdb\u884c\u89e3\u63a9\u7801 (unmask)\u3002 - \u8fd9\u4e00\u8fc7\u7a0b\u8fed\u4ee3\u66f4\u65b0\u5e8f\u5217\uff0c\u76f4\u5230\u8fbe\u5230 \\(t = 0\\) \u6216\u6ee1\u8db3\u505c\u6b62\u6761\u4ef6\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#parallel-decoding","title":"Parallel Decoding","text":"<p>\u901a\u8fc7\u6839\u636e\u7f6e\u4fe1\u5ea6\u4fe1\u53f7\u5e76\u884c\u89e3\u7801\u88ab\u63a9\u7801\u7684 Token \u6765\u52a0\u901f MDM \u7684\u751f\u6210\u3002\u5b83\u5c06\u8f93\u51fa\u7ec4\u7ec7\u6210 \\(K\\) \u4e2a\u5927\u5c0f\u4e3a \\(B\\) \u7684\u5757 (blocks)\uff0c\u5e76\u901a\u8fc7 MDM \u673a\u5236\u5bf9\u6bcf\u4e2a\u5757\u6267\u884c\u6700\u591a \\(S\\) \u4e2a\u7cbe\u70bc\u6b65\u9aa4 (refinement steps)\u3002 - \u57fa\u4e8e\u9608\u503c\u7684\u89c4\u5219 (Threshold-Based Rule): \u5bf9\u4e8e\u5f53\u524d\u5904\u7406\u5e8f\u5217 \\(x\\)\uff0c\u8be5\u89c4\u5219\u8ba1\u7b97\u7f6e\u4fe1\u5ea6 \\(\\{c_i(E)\\}_{i \\in M(x)}\\)\uff0c\u5e76\u89e3\u63a9\u7801\u6240\u6709\u7f6e\u4fe1\u5ea6\u8d85\u8fc7\u56fa\u5b9a\u5168\u5c40\u9608\u503c \\(\\tau \\in (0, 1)\\) \u7684\u4f4d\u7f6e \uff1a \\(\\(U_\\tau (E) = \\{ i \\in M(x) : c_i(E) \\ge \\tau \\} \\quad (1)\\)\\)</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#problems-proposed-in-llada","title":"Problems Proposed in Llada","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#block-kv-cache","title":"\u5728\u6bcf\u4e2a Block \u5185\u90e8\u4e0d\u80fd\u4f7f\u7528 KV Cache","text":"<ul> <li>\u6ca1\u6709 KV Cache\uff1aGPT \u63a8\u7406\u5feb\u662f\u56e0\u4e3a\u6709 KV Cache\uff08\u4e0d\u7528\u91cd\u590d\u8ba1\u7b97\u524d\u9762\u7684\u8bcd\uff09\u3002LLaDA \u662f\u5e76\u884c\u751f\u6210\u7684\uff0c\u4f20\u7edf\u7684 KV Cache \u4f18\u5316\u4e0d\u9002\u7528\uff0c\u9700\u8981\u65b0\u7684\u4f18\u5316\u6280\u672f\u3002</li> </ul> <p>Note</p> <p>Block-wise KV Cache \u662f\u53ef\u4ee5\u4f7f\u7528\u7684\uff0c\u6b63\u5728\u751f\u6210\u7684 block \u4e0d\u80fd\u4f7f\u7528\uff0c\u4f46\u662f\u5df2\u7ecf\u751f\u6210\u5e76\u51bb\u7ed3\u7684 block \u662f\u53ef\u4ee5\u4f7f\u7528 KV Cache \u7684\uff0c\u8be6\u60c5\u89c1\u4e0b\u6587\u201c\u63a8\u7406\u4f18\u5316\u201d\u90e8\u5206\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#arm-blocksize","title":"\u8ba1\u7b97\u91cf\u7206\u70b8(\u662f ARM \u7684 BlockSize \u500d\uff1f)","text":"<p>\u4f20\u7edf\u81ea\u56de\u5f52 (Autoregressive) - \u8fc7\u7a0b\uff1a\u4e32\u884c\u6267\u884c 32 \u6b21 Forward\u3002 - \u5355\u6b21\u8f93\u5165\uff1a1 \u4e2a Token\uff08\u52a0\u4e0a\u5386\u53f2 KV Cache\uff09\u3002 - \u5355\u6b21\u8ba1\u7b97\u91cf\uff1a\u4e3b\u8981\u96c6\u4e2d\u5728\u5c06\u8fd9 1 \u4e2a Token \u6620\u5c04\u8fc7\u6240\u6709\u7684 Linear \u5c42\uff08QKV projection, MLP \u7b49\uff09\u3002Attention \u8ba1\u7b97\u91cf\u4e3a \\(1 \\times (L_{prefix} + i)\\) \u200b- \u603b\u8ba1\u7b97\u91cf\uff1a\u8fd1\u4f3c\u4e3a \\(32\u00d7Cost(1_token)\\)</p> <p>\u9000\u5316\u7684 Block Diffusion (Degraded DLLM) - \u8fc7\u7a0b\uff1aLowConfidence \u7b97\u6cd5\u6bcf\u6b21\u8fed\u4ee3\u53ea\u7f6e\u4fe1\uff08\u56fa\u5b9a\uff09\u4e86 1 \u4e2a Token\uff0c\u56e0\u6b64\u5faa\u73af\u4e86 32 \u6b21\u624d\u586b\u6ee1 Block\u3002\u4e32\u884c\u6267\u884c 32 \u6b21 Forward\u3002 - \u5355\u6b21\u8f93\u5165\uff1a32 \u4e2a Token\uff08\u5305\u542b\u5df2\u56fa\u5b9a\u7684\u548c\u672a\u56fa\u5b9a\u7684 Mask\uff09\u3002 - \u5355\u6b21\u8ba1\u7b97\u91cf\uff1a   - Linear \u5c42\uff1a\u6a21\u578b\u5fc5\u987b\u5bf9\u8fd9 32 \u4e2a Token \u5168\u90e8\u91cd\u65b0\u8ba1\u7b97 Q\u3001K\u3001V \u548c MLP\u3002\u8fd9\u662f\u786c\u6027\u5f00\u9500\uff0c\u65e0\u6cd5\u5229\u7528 Prefix Cache \u7701\u7565\uff08\u56e0\u4e3a Block \u5185\u90e8\u662f\u53cc\u5411 Attention\uff0c\u4e14 Mask \u53d8\u4e86\uff0c\u6574\u4e2a Block \u7684\u8868\u793a\u90fd\u4f1a\u53d8\uff09\u3002   - Attention \u5c42\uff1a\u8fd9 32 \u4e2a Token \u9700\u8981\u4e0e Prefix \u505a Attention\uff0c\u4e14 32 \u4e2a Token \u5185\u90e8\u8981\u505a 32\u00d732 \u7684\u53cc\u5411 Attention\u3002 - \u603b\u8ba1\u7b97\u91cf\uff1a\u8fd1\u4f3c\u4e3a \\(32\u00d7Cost(32_tokens)\\) \u7ed3\u8bba \u5728\u9000\u5316\u6700\u4e25\u91cd\u7684\u60c5\u51b5\u4e0b\uff08\u6bcf\u6b21\u53ea\u751f\u6210 1 \u4e2a\uff09\uff0cDLLM \u7684\u8ba1\u7b97\u91cf\u662f\u4f20\u7edf\u81ea\u56de\u5f52\u7684 B \u500d\uff08\u5373 32\u500d\uff09\u3002ARM \u6bcf\u6b21\u53ea\u7b97 1 \u4e2a Token \u7684\u65b0\u72b6\u6001\uff1bDLLM \u6bcf\u6b21\u90fd\u8981\u91cd\u7b97 32 \u4e2a Token \u7684\u72b6\u6001\uff0c\u5374\u53ea\u4ea7\u51fa\u4e86 1 \u4e2a\u6709\u6548 Token\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#_1","title":"\u8bf7\u6c42\u505c\u6b62\u95ee\u9898","text":"<p>LaDA \u8fd9\u79cd\u673a\u5236\u5b58\u5728\u8ba1\u7b97\u6d6a\u8d39\uff1a</p> <ul> <li>\u8ba1\u7b97\u6d6a\u8d39: \u5728 Worker \u7aef\uff0cAttention \u548c Linear \u5c42\u662f\u9488\u5bf9\u6574\u4e2a Block\uff0832 \u4e2a Token\uff09\u5e76\u884c\u8ba1\u7b97\u7684\u3002\u5373\u4f7f  \u51fa\u73b0\u5728\u7b2c 1 \u4e2a\u4f4d\u7f6e\uff0c\u540e\u9762 31 \u4e2a\u4f4d\u7f6e\u7684\u8ba1\u7b97\u4e5f\u5df2\u7ecf\u53d1\u751f\u4e86\uff0c\u65e0\u6cd5\u64a4\u9500\u3002</li> <li>\u663e\u5b58\u6d6a\u8d39: \u5728\u751f\u6210\u8fc7\u7a0b\u4e2d\uff0c\u8fd9 32 \u4e2a Token \u7684 KV Cache \u4e5f\u90fd\u88ab\u8ba1\u7b97\u5e76\u5360\u7528\u4e86\u663e\u5b58 </li> </ul> <p>\u5982\u679c block size \u8bbe\u7f6e\u8fc7\u5927\u5b9e\u9645\u4e0a\u4e25\u91cd\u5f71\u54cd\u5ef6\u8fdf\uff0c\u65e0\u6cd5\u50cf\u4f20\u7edf\u81ea\u56de\u5f52\u6a21\u578b\u90a3\u6837\u201c\u89c1\u5230  \u9a6c\u4e0a\u505c\u6b62\u201d\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#_2","title":"\u5e76\u884c\u89e3\u7801\u95ee\u9898<sup>1</sup>","text":"<p>\u5ffd\u7565\u52a8\u6001\u53d8\u5316 (Ignore Dynamic Changes)</p> <p>\u95ee\u9898\uff1aLLaDA \u4f7f\u7528\u56fa\u5b9a\u7684 block_size (32) \u548c\u56fa\u5b9a\u7684\u8fed\u4ee3\u903b\u8f91\u3002\u5b83\u4e0d\u4f1a\u6839\u636e\u5f53\u524d\u751f\u6210\u7684\u96be\u6613\u7a0b\u5ea6\u52a8\u6001\u8c03\u6574 Block \u5927\u5c0f\u3002 \u73b0\u72b6\uff1a\u5373\u4f7f\u5f53\u524d\u4e0a\u4e0b\u6587\u975e\u5e38\u7b80\u5355\uff08\u4f8b\u5982\u6284\u5199\u4e00\u6bb5\u56fa\u5b9a\u6587\u672c\uff09\uff0c\u5b83\u4f9d\u7136\u4f1a\u4f7f\u7528 32 \u7684 Block Size\uff0c\u5e76\u4e14\u53ef\u80fd\u56e0\u4e3a\u9759\u6001\u9608\u503c\u8fc7\u9ad8\u800c\u8fdb\u884c\u4e0d\u5fc5\u8981\u7684\u591a\u6b21\u8fed\u4ee3\u3002 \u91c7\u6837\u5e7f\u5ea6\u5355\u4e00 (Uniform Sampling Width):</p> <p>\u95ee\u9898\uff1a\u5b83\u5bf9\u6bcf\u4e2a Block \u4e00\u89c6\u540c\u4ec1\u3002 \u73b0\u72b6\uff1a\u4ee3\u7801\u4e2d\u6ca1\u6709\u9488\u5bf9\u4e0d\u540c Block \u6216\u4e0d\u540c\u4f4d\u7f6e\u8c03\u6574\u91c7\u6837\u7b56\u7565\u7684\u903b\u8f91\u3002\u6240\u6709\u4f4d\u7f6e\u90fd\u4f7f\u7528\u76f8\u540c\u7684 argmax \u6216 topk \u903b\u8f91\u3002 \u63d0\u4ea4\u9608\u503c\u50f5\u5316 (Rigid Commit Threshold):</p> <p>\u95ee\u9898\uff1a\u8fd9\u662f\u6700\u663e\u8457\u7684\u95ee\u9898\u3002self.threshold \u662f\u4e00\u4e2a\u9759\u6001\u5e38\u6570\uff080.95\uff09\u3002 \u73b0\u72b6\uff1a \u573a\u666f A\uff08\u7b80\u5355\uff09\uff1a\u6a21\u578b\u975e\u5e38\u81ea\u4fe1\uff0c\u7f6e\u4fe1\u5ea6\u5168\u662f 0.99\u3002\u9759\u6001\u9608\u503c 0.95 \u5de5\u4f5c\u826f\u597d\uff0c\u4e00\u6b21\u8fed\u4ee3\u5168\u90e8\u89e3\u5f00\u3002 \u573a\u666f B\uff08\u56f0\u96be\uff09\uff1a\u6a21\u578b\u6bd4\u8f83\u72b9\u8c6b\uff0c\u7f6e\u4fe1\u5ea6\u5728 0.6-0.8 \u4e4b\u95f4\u6ce2\u52a8\u3002\u9759\u6001\u9608\u503c 0.95 \u4f1a\u5bfc\u81f4\u6ca1\u6709\u4efb\u4f55 Token \u88ab\u9009\u4e2d\uff08\u9664\u4e86\u4fdd\u5e95\u673a\u5236\u5f3a\u5236\u9009\u4e00\u4e2a\uff09\u3002\u8fd9\u4f1a\u5bfc\u81f4\u7b97\u6cd5\u9000\u5316\u6210\u201c\u4e00\u6b21\u4e00\u4e2a Token\u201d\u7684\u4f4e\u6548\u6a21\u5f0f\uff0c\u6b63\u5982\u6211\u4eec\u4e4b\u524d\u8ba8\u8bba\u7684\u90a3\u6837\u3002 \u7f3a\u4e4f\u9002\u5e94\u6027\uff1a\u7b97\u6cd5\u4e0d\u4f1a\u6839\u636e\u5f53\u524d\u6b65\u9aa4\u7684\u7f6e\u4fe1\u5ea6\u5206\u5e03\uff08\u4f8b\u5982\u6574\u4f53\u90fd\u5f88\u4f4e\uff09\u6765\u52a8\u6001\u964d\u4f4e\u9608\u503c\u4ee5\u52a0\u901f\u751f\u6210\u3002 </p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#_3","title":"\u63a8\u7406\u4f18\u5316","text":"<p>\u5bf9\u4e8e\u201c\u6b63\u5728\u751f\u6210\u7684 Block\u201d\uff1a\u4f9d\u7136\u4e0d\u80fd\u4f7f\u7528 KV Cache\u3002\u56e0\u4e3a\u5728\u8fd9\u4e2a 64 Token \u7684\u5c0f\u7a97\u53e3\u5185\uff0c\u6269\u6563\u8fc7\u7a0b\u4f9d\u7136\u662f\u53cd\u590d\u8fed\u4ee3\u3001\u53cc\u5411\u6ce8\u610f\u529b\u7684\uff0c\u6bcf\u4e00\u6b65\u90fd\u8981\u91cd\u7b97\u3002</p> <p>\u5bf9\u4e8e\u201c\u5df2\u56fa\u5b9a\u7684\u524d\u6587\u201d\uff1a\u53ef\u4ee5\u4f7f\u7528 KV Cache\u3002\u56e0\u4e3a Block 1 \u4e00\u65e6\u751f\u6210\u5b8c\u6bd5\u5e76\u51bb\u7ed3\uff0c\u5b83\u5bf9\u4e8e Block 2 \u6765\u8bf4\u5c31\u662f\u6c38\u8fdc\u4e0d\u53d8\u7684\u4e0a\u4e0b\u6587\uff08Context\uff09\u3002Block 2 \u5728\u8fed\u4ee3\u53bb\u566a\u65f6\uff0c\u867d\u7136\u81ea\u5df1\u7684 KV \u4f1a\u53d8\uff0c\u4f46\u5b83\u67e5\u8be2 Block 1 \u7684 KV \u662f\u56fa\u5b9a\u7684\u3002</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#adaptive-block-size-steps-and-threshold","title":"Adaptive Block Size, Steps and Threshold<sup>1</sup>","text":"<p>\u73b0\u6709\u7684\u7f6e\u4fe1\u5ea6\u5e76\u884c\u89e3\u7801\u65b9\u6cd5\u5c06\u8f93\u51fa\u7ec4\u7ec7\u6210 \\(K\\) \u4e2a\u5927\u5c0f\u4e3a \\(B\\) \u7684\u5757 (blocks)\uff0c\u5e76\u901a\u8fc7 MDM \u673a\u5236\u5bf9\u6bcf\u4e2a\u5757\u6267\u884c\u6700\u591a \\(S\\) \u4e2a\u7cbe\u70bc\u6b65\u9aa4 (refinement steps)\uff0c\u8ba1\u7b97\u7f6e\u4fe1\u5ea6\u7684\u65b9\u6cd5\u4e3b\u8981\u6709\u4e24\u79cd\uff1a \u5b83\u3002 - \u57fa\u4e8e\u9608\u503c\u7684\u89c4\u5219 (Threshold-Based Rule)   - \u5bf9\u4e8e\u5f53\u524d\u5904\u7406\u5e8f\u5217 \\(x\\)\uff0c\u8be5\u89c4\u5219\u8ba1\u7b97\u7f6e\u4fe1\u5ea6 \\(\\{c_i(E)\\}_{i \\in M(x)}\\)\uff0c\u5e76\u89e3\u63a9\u7801\u6240\u6709\u7f6e\u4fe1\u5ea6\u8d85\u8fc7\u56fa\u5b9a\u5168\u5c40\u9608\u503c \\(\\tau \\in (0, 1)\\) \u7684\u4f4d\u7f6e\uff1a \\(\\(U_\\tau (E) = \\{ i \\in M(x) : c_i(E) \\ge \\tau \\} \\quad (1)\\)\\) - \u57fa\u4e8e\u56e0\u5b50\u7684\u89c4\u5219 (Factor-Based Rule)   - \u57fa\u4e8e\u56e0\u5b50\u7684\u89c4\u5219\u901a\u8fc7\u4e00\u4e2a\u56e0\u5b50\u53c2\u6570 \\(\\phi &gt; 0\\) \u6765\u63a7\u5236\u5e76\u884c\u5ea6\u3002\u5bf9\u4e8e\u5f53\u524d\u5757\u4e2d \\(m\\) \u4e2a\u63a9\u7801\u4f4d\u7f6e\u7684\u6392\u5e8f\u7f6e\u4fe1\u5ea6 \\(c_{(1)} \\ge \\dots \\ge c_{(m)}\\)\uff0c\u9009\u62e9\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6\u7684\u6700\u5927 \\(r\\)\uff1a \\(\\((r + 1)(1 - c_{(r)}) &lt; \\phi\\)\\)   \u7136\u540e\u89e3\u63a9\u7801\u524d \\(r\\) \u4e2a\u4f4d\u7f6e\u3002\u76f4\u89c2\u5730\u8bf4\uff0c\u5f53\u4e2a\u4f53\u7f6e\u4fe1\u5ea6\u666e\u904d\u8f83\u9ad8\u65f6\uff0c\u8fd9\u79cd\u65b9\u6cd5\u4f1a\u89e3\u7801\u66f4\u591a Token\uff1b\u800c\u5f53\u7f6e\u4fe1\u5ea6\u6a21\u68f1\u4e24\u53ef (borderline) \u65f6\uff0c\u89e3\u7801\u8f83\u5c11\u3002</p> <p>\u56fa\u5b9a\u7684\u8c03\u5ea6\u7b56\u7565 (Fixed schedule) \u4f1a\u5bfc\u81f4\u5bf9\u7b80\u5355\u7684\u5757\u8fdb\u884c\u8fc7\u5ea6\u7cbe\u70bc (over-refines)\uff0c\u662f\u5bf9\u8ba1\u7b97\u8d44\u6e90\u7684\u6d6a\u8d39\uff1b\u800c\u5bf9\u8f83\u96be\u7684\u5757\u5219\u670d\u52a1\u4e0d\u8db3 (under-serving)\uff0c\u5bfc\u81f4\u751f\u6210\u8d28\u91cf\u4e0b\u964d\u3002</p> <ul> <li> <p>Block Size\uff1a \u5f53\u7f6e\u4fe1\u5ea6\u8f83\u9ad8\u65f6\uff0c\u8f83\u5927\u7684\u5757\u5927\u5c0f\u53ef\u4ee5\u5145\u5206\u5229\u7528\u5e76\u884c\u89e3\u7801\uff0c\u56e0\u4e3a\u6709\u66f4\u591a\u7684 Token \u80fd\u591f\u8d85\u8fc7\u9608\u503c\uff1b\u5f53\u7f6e\u4fe1\u5ea6\u8f83\u4f4e\u65f6\uff0c\u8f83\u5c0f\u7684\u5757\u6709\u52a9\u4e8e\u66f4\u5feb\u5730\u7a33\u5b9a\u8f93\u51fa\u3002</p> </li> <li> <p>Step Size\uff1a\u5728\u4f4e\u7f6e\u4fe1\u5ea6\u4e0b\u6b65\u957f\u5e94\u8be5\u8f83\u5927\uff0c\u800c\u4e00\u65e6\u9884\u6d4b\u7a33\u5b9a\u4e0b\u6765\uff0c\u6b65\u957f\u5e94\u8be5\u53d8\u5c0f\u3002</p> </li> <li> <p>Threshold\uff1a \u7f6e\u4fe1\u5ea6\u9608\u503c\u672c\u8eab\u4e5f\u5fc5\u987b\u81ea\u9002\u5e94\u2014\u2014\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u5e94\u8bbe\u4e3a\u9ad8\u503c\u4ee5\u9632\u6b62\u8fc7\u65e9\u63d0\u4ea4 (premature commitments)\uff0c\u800c\u5728\u53e6\u4e00\u4e9b\u60c5\u51b5\u4e0b\u5e94\u8bbe\u4e3a\u4f4e\u503c\u4ee5\u52a0\u901f\u89e3\u7801\u3002</p> </li> </ul> <p>Note</p> <p>\u5728\u5b9e\u9a8c\u4e2d\uff0cThreshold \u5bf9\u7ed3\u679c\u5f71\u54cd\u6700\u5927\uff0c\u52a8\u6001\u8c03\u8282 Threshold \u80fd\u663e\u8457\u63d0\u5347\u751f\u6210\u8d28\u91cf\u548c\u901f\u5ea6\u3002</p> <p></p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#softmax-with-adaptive-vocabulary","title":"Softmax with Adaptive Vocabulary","text":"<p>\u91c7\u6837\u5e7f\u5ea6\u5b58\u5728\u5ef6\u8fdf\u5f00\u9500\uff0c<sup>1</sup>\u4e2d\u7ed3\u679c\u663e\u793a\uff0c\u5ef6\u8fdf\u968f\u7740\u8bcd\u8868\u5927\u5c0f\u6025\u5267\u589e\u52a0\uff1a\u8bc4\u4f30\u5168\u90e8\u7ea6 5 \u4e07\u4e2a Token \u7684\u901f\u5ea6\u51e0\u4e4e\u6bd4\u4f7f\u7528\u4e00\u4e2a\u5c0f\u8bcd\u8868\u5b50\u96c6\u6162\u4e86\u4e00\u4e2a\u6570\u91cf\u7ea7 (order of magnitude)\u3002\u7531\u4e8e\u6bcf\u4e00\u6b65 (step) \u90fd\u8981\u8c03\u7528 Softmax\uff0c\u8fd9\u53ef\u80fd\u4f1a\u6210\u4e3a\u4e00\u4e2a\u4e3b\u8981\u7684\u6027\u80fd\u74f6\u9888\u3002\u8fd9\u4e5f\u8bc1\u5b9e\u4e86\u57fa\u4e8e\u81ea\u9002\u5e94\u8bcd\u8868\u5927\u5c0f\u7684\u9009\u62e9\u662f\u5fc5\u8981\u7684\uff0c\u4ee5\u4fbf\u4ec5\u5728\u603b\u8bcd\u8868\u7684\u4e00\u4e2a\u5b50\u96c6\u4e0a\u6267\u884c Softmax \u8ba1\u7b97</p> <p></p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#overview-of-cadllm","title":"Overview of CadLLM","text":"<p>Adaptive Block Size(\\(B_t\\)) \u8bba\u6587\u5c06 \\(B_t\\) \u8bbe\u5b9a\u4e3a\u4e0e\u5f53\u524d\u5e73\u5747\u7f6e\u4fe1\u5ea6 \\(\\bar{c}\\) \u6210\u6b63\u6bd4\uff1a\u9ad8\u7f6e\u4fe1\u5ea6\u7684\u5757\u4f1a\u6269\u5927\u5c3a\u5bf8\uff0c\u4ee5\u644a\u9500\u524d\u5411\u4f20\u64ad\u7684\u8ba1\u7b97\u6210\u672c\uff1b\u800c\u4f4e\u7f6e\u4fe1\u5ea6\u7684\u5757\u4f1a\u6536\u7f29\uff0c\u4ee5\u4fbf\u6a21\u578b\u80fd\u5c06\u7cbe\u70bc\u8fc7\u7a0b\u96c6\u4e2d\u5728\u4e0d\u786e\u5b9a\u6027\u96c6\u4e2d\u7684\u5730\u65b9\u3002 \\(\\(B_t = \\text{clip}(B_{min} + (B_{max} - B_{min}) \\cdot \\bar{c}, B_{min}, B_{max}) \\quad (2)\\)\\)\u8fd9\u91cc\uff0c\\(B_{max}\\) \u548c \\(B_{min}\\) \u5206\u522b\u4ee3\u8868\u5141\u8bb8\u7684\u6700\u5927\u548c\u6700\u5c0f\u5757\u5927\u5c0f\u3002</p> <p>Adaptive Step(\\(S_t\\))  (\\(S_t\\))\u6211\u4eec\u5c06\u6b65\u6570 \\(S_t\\) \u8bbe\u8ba1\u4e3a\u4e0e \\(\\bar{c}\\) \u5448\u4e92\u8865\u5173\u7cfb\uff08\u8d1f\u76f8\u5173\uff09\uff0c\u5e76\u7528\u5b83\u6765\u63a7\u5236\u6d3b\u8dc3\u5757\u5185\u5185\u5faa\u73af (inner loop) \u7684\u8282\u594f\uff0c\u540c\u65f6\u4e5f\u7528\u4e8e\u8c03\u5ea6\u9608\u503c \\(\\tau_t\\)\u3002\u8fd9\u4f7f\u5f97\u4f4e\u7f6e\u4fe1\u5ea6\u7684\u63a9\u7801\u4f4d\u7f6e\u80fd\u591f\u89e6\u53d1\u66f4\u591a\u7684\u7cbe\u70bc\u6b65\u9aa4\uff0c\u800c\u9ad8\u7f6e\u4fe1\u5ea6\u7684\u4f4d\u7f6e\u5219\u6267\u884c\u8f83\u5c11\u7684\u6b65\u9aa4\u3002 \\(\\(S_t = \\text{clip}(S_{base} + (S_{max} - S_{base})(1 - \\bar{c}), S_{base}, S_{max}) \\quad (3)\\)\\)</p> <p>Apdative vocabulary size (\\(V_t\\)) \u4e3a\u4e86\u644a\u9500\u4ece\u8bcd\u8868\u4e2d\u91c7\u6837\u7684\u6210\u672c\uff0c\u8bba\u6587\u6839\u636e\u51e0\u4e2a\u5173\u952e\u6307\u6807\u8c03\u6574\u91c7\u6837\u5927\u5c0f \\(V_t\\)\uff1a\u9636\u6bb5 (phase)\u3001\u7f6e\u4fe1\u5ea6 (confidence) \u548c Token \u91cd\u590d (token repetition) - \u5728\u751f\u6210\u7684\u65e9\u671f\u9636\u6bb5\u6216 Token \u751f\u6210\u7684\u4e0d\u786e\u5b9a\u9636\u6bb5\u4f7f\u7528\u8f83\u5927\u7684\u8bcd\u8868\u5b50\u96c6\u3002 - \u5f53\u751f\u6210\u51fa\u73b0\u91cd\u590d Token (\\(r_t\\)) \u65f6\uff0c\u6211\u4eec\u4e5f\u5141\u8bb8\u8f83\u5927\u7684\u8bcd\u8868\u5927\u5c0f\u3002 - \u5728\u9ad8\u7f6e\u4fe1\u5ea6\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u51cf\u5c0f\u5176\u5927\u5c0f\u4ee5\u964d\u4f4e\u8ba1\u7b97\u6210\u672c\u3002 \\(\\(V_t = \\text{clip}(V_{phase}(g_t) \\cdot f_{conf}(\\bar{c}) \\cdot f_{rep}(r_t), V_{min}, V_{max}) \\quad (4)\\)\\) - \\(V_{phase}(g_t)\\)\uff1a \\(g_t\\) \u662f\u751f\u6210\u8fdb\u5ea6\u3002   - \u751f\u6210\u521d\u671f\uff1a\u4e0a\u4e0b\u6587\u5f88\u5c11\uff0c\u53ef\u80fd\u6027\u65e0\u9650\u591a\u3002\u8fd9\u65f6\u5019\u5982\u679c\u8bcd\u8868\u592a\u5c0f\uff0c\u53ef\u80fd\u4f1a\u6f0f\u6389\u6b63\u786e\u7684\u65b9\u5411\u3002\u6240\u4ee5\u521d\u671f \\(V_t\\) \u8981\u5927\u3002   - \u751f\u6210\u540e\u671f\uff1a \u53e5\u5b50\u5feb\u5199\u5b8c\u4e86\uff0c\u5269\u4e0b\u7684\u8bcd\u57fa\u672c\u88ab\u4e0a\u4e0b\u6587\u9650\u5b9a\u6b7b\u4e86\uff08\u6bd4\u5982 \"New York Ci...\" \u540e\u9762\u51e0\u4e4e\u80af\u5b9a\u662f \"ty\"\uff09\u3002\u8fd9\u65f6\u5019\u53ea\u9700\u8981\u770b\u5f88\u5c0f\u8303\u56f4\u7684\u8bcd\u8868\u5c31\u591f\u4e86\u3002 - \\(f_{conf}(\\bar{c})\\)\uff1a \\(\\bar{c}\\) \u662f\u6a21\u578b\u7684\u5e73\u5747\u7f6e\u4fe1\u5ea6\u3002   - \u4f4e\u7f6e\u4fe1\u5ea6 (Low Confidence)\uff1a \u6a21\u578b\u5f88\u8ff7\u832b\u3002\u8fd9\u65f6\u5019\u5fc5\u987b\u6269\u5927\u641c\u7d22\u8303\u56f4\uff08\u6269\u5927 \\(V_t\\)\uff09\uff0c\u53bb\u770b\u770b\u90a3\u4e9b\u539f\u672c\u6392\u5728\u540e\u9762\u7684\u8bcd\u662f\u4e0d\u662f\u66f4\u597d\u7684\u9009\u62e9\u3002   - \u9ad8\u7f6e\u4fe1\u5ea6 (High Confidence)\uff1a \u6a21\u578b\u975e\u5e38\u6709\u628a\u63e1\u3002\u8fd9\u65f6\u5019\u4e0d\u9700\u8981\u6d6a\u8d39\u7b97\u529b\u53bb\u770b\u6392\u540d 1000 \u4ee5\u5916\u7684\u8bcd\uff0c\u53ea\u770b\u524d\u51e0\u540d\u5c31\u591f\u4e86\uff08\u7f29\u5c0f \\(V_t\\)\uff09\u3002 - \\(f_{rep}(r_t)\\)\uff1a \\(r_t\\) \u662f\u68c0\u6d4b\u5230\u7684\u91cd\u590d\u7387\u3002   - \u5982\u679c\u6a21\u578b\u6781\u5176\u81ea\u4fe1\uff08\u56e0\u5b50 2 \u8ba9\u8bcd\u8868\u53d8\u5f97\u6781\u5c0f\uff09\uff0c\u5b83\u53ef\u80fd\u4f1a\u9677\u5165\u5c40\u90e8\u6700\u4f18\u9677\u9631\uff0c\u53cd\u590d\u8f93\u51fa\u540c\u4e00\u4e2a\u9ad8\u6982\u7387\u8bcd\uff08\u4f8b\u5982\uff1a\"the the the...\"\uff09\u3002   - \u4e00\u65e6\u68c0\u6d4b\u5230\u91cd\u590d\u7387 \\(r_t\\) \u98d9\u5347\uff0c\\(f_{rep}\\) \u4f1a\u53d8\u6210\u4e00\u4e2a\u5927\u4e8e 1 \u7684\u7cfb\u6570\uff0c\u5f3a\u5236\u6491\u5927\u8bcd\u8868\u3002   - \u8bcd\u8868\u53d8\u5927 -&gt; \u5f15\u5165\u4e86\u66f4\u591a\u4f4e\u6982\u7387\u7684\u201c\u65b0\u9c9c\u8bcd\u201d -&gt; \u6a21\u578b\u6709\u673a\u4f1a\u8df3\u51fa\u201c\u590d\u8bfb\u6b7b\u5faa\u73af\u201d -&gt; \u6062\u590d\u6b63\u5e38\u540e\uff0c\\(r_t\\) \u4e0b\u964d\uff0c\u8bcd\u8868\u518d\u6b21\u7f29\u5c0f\u3002</p> <p>Apdative threshold (\\(\\tau_t\\)) \u81ea\u9002\u5e94\u7f6e\u4fe1\u5ea6\u9608\u503c\u63a7\u5236\u7740 Token \u7684\u89e3\u63a9\u7801\u3002\u5728\u4e00\u4e2a\u5757\u7684\u65e9\u671f\u6216\u7f6e\u4fe1\u5ea6\u8f83\u4f4e\u65f6\uff0c\u901a\u8fc7\u8bbe\u5b9a\u4f4e\u9608\u503c\u5e76\u884c\u63d0\u4ea4\u8fc7\u591a Token \u4f1a\u5bfc\u81f4\u8f93\u51fa\u8d28\u91cf\u4f4e\u4e0b\u3002\u540c\u65f6\uff0c\u5728\u5757\u7684\u540e\u671f\u8bbe\u5b9a\u9ad8\u9608\u503c\u4f1a\u963b\u788d\u5df2\u7ecf\u7a33\u5b9a\u7684 Token \u88ab\u89e3\u63a9\u7801\u3002\u8bba\u6587\u5b9a\u4e49\u4e86\u4e00\u4e2a\u611f\u77e5\u8fdb\u5ea6 (progress-aware) \u7684\u9608\u503c \\(\\tau_t\\)\u3002\u968f\u7740\u8d8a\u6765\u8d8a\u591a\u7684 Token \u88ab\u89e3\u63a9\u7801\uff0c\u8be5\u9608\u503c\u6700\u521d\u662f\u4e25\u683c\u7684\uff08\u5f53\u7f6e\u4fe1\u5ea6\u4f4e\u65f6\uff09\uff0c\u5e76\u6700\u7ec8\u653e\u677e\uff08\u968f\u7740\u7f6e\u4fe1\u5ea6\u4e0a\u5347\u5e76\u4fdd\u6301\u9ad8\u4f4d\uff09 \\(\\(\\tau_t = \\tau_{base}(1 - g_t) + \\tau_{min}g_t\\)\\)</p> <p></p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#early-exiting-in-diffusion-llm","title":"Early exiting in Diffusion LLM<sup>2</sup>","text":"<p>\u8fd9\u4e2a\u65b9\u6cd5\u5229\u7528\u4e86DLM\u4e2d\u7684\u7279\u70b9\u2014\u2014\u65e9\u671f\u7b54\u6848\u6536\u655b\uff08Early Answer Convergence\uff09\uff1a\u5728\u8bb8\u591a\u60c5\u51b5\u4e0b\uff0c\u65e0\u8bba\u662f\u5728\u534a\u81ea\u56de\u5f52\u8fd8\u662f\u968f\u673a\u91cd\u65b0\u63a9\u7801\uff08Re-masking\uff09\u7684\u8c03\u5ea6\u7b56\u7565\u4e0b\uff0c\u6a21\u578b\u5728\u6700\u7ec8\u89e3\u7801\u6b65\u9aa4\u5b8c\u6210\u4e4b\u524d\u7684\u4e00\u534a\u6b65\u6570\u65f6\uff0c\u5c31\u5df2\u7ecf\u80fd\u5728\u5185\u90e8\u8bc6\u522b\u51fa\u6b63\u786e\u7b54\u6848\u3002\u4f8b\u5982\uff0c\u5728 GSM8K \u548c MMLU \u6570\u636e\u96c6\u4e0a\uff0c\u5206\u522b\u6709\u9ad8\u8fbe 97% \u548c 99% \u7684\u5b9e\u4f8b\u4ec5\u4f7f\u7528\u4e00\u534a\u7684\u7ec6\u5316\u6b65\u9aa4\u5c31\u80fd\u88ab\u6b63\u786e\u89e3\u7801\u3002</p> <p>\u56e0\u6b64\uff0cProphet \u5f15\u5165\u4e86\u4e00\u4e2a\u201c\u88c1\u5224\u201d\u673a\u5236\uff1a\u5728\u6bcf\u4e00\u6b65\u8fed\u4ee3\u4e2d\uff0c\u5229\u7528\u524d\u4e24\u4e2a\u9884\u6d4b\u5019\u9009\u4e4b\u95f4\u7684\u7f6e\u4fe1\u5ea6\u5dee\u8ddd(top-2 confidence gap)\u4f5c\u4e3a\u6807\u51c6\uff0c\u52a8\u6001\u51b3\u5b9a\u662f\u7ee7\u7eed\u7ec6\u5316\u8fd8\u662f\u201cAll-in\u201d(\u5373\u4e00\u6b65\u89e3\u7801\u6240\u6709\u5269\u4f59\u7684 Token)\u3002</p> <p>Note</p> <p>\u7f6e\u4fe1\u5ea6\u5dee\u8ddd (Confidence Gap, \\(\\bar{g}_t\\))\uff1a\u8ba1\u7b97 Top-1 \u6982\u7387\u4e0e Top-2 \u6982\u7387\u4e4b\u95f4\u7684\u5dee\u8ddd\u3002\u5982\u679c\u5dee\u8ddd\u5f88\u5927\uff0c\u8bf4\u660e\u6a21\u578b\u975e\u5e38\u786e\u5b9a\u9009 Top-1 \u662f\u5bf9\u7684\uff1b\u5982\u679c\u5dee\u8ddd\u5f88\u5c0f\uff0c\u8bf4\u660e\u6a21\u578b\u5728\u7ea0\u7ed3\u3002</p> <p>All-in: \u5982\u679ctop2 Confidence Gap\u5dee\u8ddd\u5927\u4e8e\u5f53\u524d\u7f6e\u4fe1\u5ea6\u9608\u503c(\\(\\tau_t\\))\u76f4\u63a5\u53d6\u5f53\u524d\u6982\u7387\u6700\u5927\u7684\u8bcd\u586b\u5165\u6240\u6709\u63a9\u7801\u4f4d\u7f6e\uff0c\u5e76\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c\uff0c\u4e0d\u518d\u8fdb\u884c\u540e\u7eed\u5faa\u73af</p> <p></p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#_4","title":"\u53ef\u80fd\u7684\u4f18\u5316\u65b9\u6cd5","text":"<p>\u6a21\u578b\u8bad\u7ec3\u8d28\u91cf (\u6700\u5173\u952e)\uff1a</p> <p>LLaDA \u6a21\u578b\u5fc5\u987b\u8bad\u7ec3\u5f97\u8db3\u591f\u597d\uff0c\u80fd\u591f\u5728\u7ed9\u5b9a\u4e0a\u4e0b\u6587\u65f6\uff0c\u5bf9\u540e\u7eed\u7684\u591a\u4e2a Token \u540c\u65f6\u4ea7\u751f\u9ad8\u7f6e\u4fe1\u5ea6\u3002\u5982\u679c\u6a21\u578b\u672c\u8eab\u5f88\u5f31\uff0c\u9884\u6d4b\u51fa\u6765\u7684\u6982\u7387\u5206\u5e03\u5f88\u5e73\u5766\uff08\u71b5\u5f88\u9ad8\uff09\uff0c\u90a3\u4e48\u7f6e\u4fe1\u5ea6\u6c38\u8fdc\u4e0a\u4e0d\u53bb\uff0c\u9000\u5316\u662f\u5fc5\u7136\u7684\u3002 \u9608\u503c (Threshold) \u8c03\u4f18\uff1a</p> <p>config.algorithm_config.get(\"threshold\", 0.95)\u3002 \u964d\u4f4e\u9608\u503c\uff1a\u5c06 0.95 \u964d\u5230 0.8 \u6216 0.6\uff0c\u53ef\u4ee5\u8ba9\u6a21\u578b\u5355\u6b21\u8fed\u4ee3\u201c\u63a5\u53d7\u201d\u66f4\u591a\u7684 Token\uff0c\u4ece\u800c\u51cf\u5c11\u8fed\u4ee3\u6b21\u6570\uff0c\u63d0\u5347\u901f\u5ea6\u3002 \u4ee3\u4ef7\uff1a\u964d\u4f4e\u9608\u503c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u751f\u6210\u7684\u8d28\u91cf\u4e0b\u964d\uff08\u63a5\u53d7\u4e86\u6a21\u578b\u4e0d\u592a\u786e\u5b9a\u7684 Token\uff09\uff0c\u53ef\u80fd\u51fa\u73b0\u903b\u8f91\u4e0d\u901a\u6216\u5e7b\u89c9\u3002\u8fd9\u662f\u4e00\u4e2a\u901f\u5ea6 vs. \u8d28\u91cf\u7684\u6743\u8861\u3002 \u52a8\u6001 Block Size (\u8fdb\u9636\u7b56\u7565)\uff1a</p> <p>\u76ee\u524d\u7684\u5b9e\u73b0\u662f\u56fa\u5b9a\u7684 block_size=32\u3002 \u5982\u679c\u53d1\u73b0\u6a21\u578b\u5728\u67d0\u4e9b\u590d\u6742\u4e0a\u4e0b\u6587\u4e2d\u7f6e\u4fe1\u5ea6\u666e\u904d\u5f88\u4f4e\uff0c\u53ef\u4ee5\u52a8\u6001\u51cf\u5c0f Block Size\uff08\u4f8b\u5982\u51cf\u5230 8 \u6216 4\uff09\u3002\u867d\u7136\u8fd8\u662f\u6162\uff0c\u4f46\u6bd4\u786c\u7b97 32 \u4e2a Mask \u8981\u5feb\u3002 \u63a8\u6d4b\u91c7\u6837 (Speculative Sampling)\uff1a</p> <p>\u867d\u7136\u4ee3\u7801\u4e2d\u5c1a\u672a\u5b8c\u5168\u96c6\u6210\uff0c\u4f46 Block Diffusion \u7684\u601d\u60f3\u4e0e\u63a8\u6d4b\u89e3\u7801\u7c7b\u4f3c\u3002\u5982\u679c\u80fd\u5f15\u5165\u4e00\u4e2a\u66f4\u5c0f\u7684 Draft Model \u6765\u7ed9\u51fa\u4e00\u4e2a\u521d\u59cb\u7684 Block \u731c\u6d4b\uff0c\u7136\u540e\u8ba9 LLaDA \u6a21\u578b\u8fdb\u884c\u201c\u964d\u566a\u201d\u6216\u201c\u9a8c\u8bc1\u201d\uff0c\u53ef\u80fd\u4f1a\u6bd4\u4ece\u5168 Mask \u5f00\u59cb\u751f\u6210\u6536\u655b\u5f97\u66f4\u5feb</p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#sglang-design","title":"SGLang Design","text":"","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#baseline","title":"Baseline","text":"<p>GSM8K Accuracy Test:</p> Bash<pre><code># first shell\npython3 -m sglang.launch_server --trust-remote-code \\\n  --model-path inclusionAI/LLaDA2.0-mini \\\n  --dllm-algorithm LowConfidence \\\n  --dllm-algorithm-config ./config.yaml \\\n  --host 0.0.0.0 \\\n  --port 30000\n\n# second shell\npython3 -m sglang.test.few_shot_gsm8k --num-questions 200\n</code></pre> <p>Results:</p> <p></p>Bash<pre><code>Accuracy: 0.925\nInvalid: 0.000\nLatency: 119.062 s\nOutput throughput: 204.145 token/s\n</code></pre> mmlu Accuracy Test:<p></p> <p></p>Bash<pre><code>cd test/srt &amp;&amp; python -m unittest test_eval_accuracy_large.TestEvalAccuracyLarge.test_mmlu\n</code></pre> Results:<p></p> Bash<pre><code>Total latency: 157.114 s\nScore: 0.710\n</code></pre> <p>Online Benchmark Test:</p> Bash<pre><code># first shell\npython3 -m sglang.launch_server --trust-remote-code \\\n  --model-path inclusionAI/LLaDA2.0-mini \\\n  --dllm-algorithm LowConfidence \\\n  --dllm-algorithm-config ./config.yaml \\\n  --host 0.0.0.0 \\\n  --port 30000\n\n# second shell\npython3 -m sglang.bench_serving --backend sglang --num-prompt 10\n</code></pre> <p>Results: </p>Bash<pre><code>============ Serving Benchmark Result ============\nBackend:                                 sglang    \nTraffic request rate:                    inf       \nMax request concurrency:                 not set   \nSuccessful requests:                     10        \nBenchmark duration (s):                  13.75     \nTotal input tokens:                      2055      \nTotal input text tokens:                 2055      \nTotal input vision tokens:               0         \nTotal generated tokens:                  2910      \nTotal generated tokens (retokenized):    2910      \nRequest throughput (req/s):              0.73      \nInput token throughput (tok/s):          149.42    \nOutput token throughput (tok/s):         211.59    \nPeak output token throughput (tok/s):    403.00    \nPeak concurrent requests:                10        \nTotal token throughput (tok/s):          361.01    \nConcurrency:                             5.47      \n----------------End-to-End Latency----------------\nMean E2E Latency (ms):                   7523.65   \nMedian E2E Latency (ms):                 7886.13   \n---------------Time to First Token----------------\nMean TTFT (ms):                          6257.11   \nMedian TTFT (ms):                        5386.92   \nP99 TTFT (ms):                           12728.10  \n-----Time per Output Token (excl. 1st token)------\nMean TPOT (ms):                          3.91      \nMedian TPOT (ms):                        4.55      \nP99 TPOT (ms):                           5.56      \n---------------Inter-Token Latency----------------\nMean ITL (ms):                           4.52      \nMedian ITL (ms):                         4.85      \nP95 ITL (ms):                            5.79      \nP99 ITL (ms):                            9.50      \nMax ITL (ms):                            90.06     \n==================================================\n</code></pre><p></p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#baseline-cadllm","title":"Baseline + CadLLM","text":"<p>GSM8K Accuracy Test Results:</p> Bash <p>mmlu Accuracy Test Results:</p> Bash <p>Online Benchmark Test Results: </p>Bash<p></p>","tags":["LLMInference"]},{"location":"notes/diffusion/Masked%20Diffusion%20LLM/#reference","title":"Reference","text":"<ol> <li> <p>Improving the Throughput of Diffusion-based Large Language Models via a Training-Free Confidence-Aware Calibration \u21a9\u21a9\u21a9</p> </li> <li> <p>Diffusion Language Models Know the Answer Before Decoding \u21a9</p> </li> </ol>","tags":["LLMInference"]},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/","title":"MultiModel Generate in SGLang","text":"2025-12-022025-12-10 <p>title: MultiModel Generate in SGLang tags:</p> <ul> <li>LLMInference   created: 2025-12-2</li> </ul>"},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/#multimodel-generate-in-sglang","title":"MultiModel Generate in SGLang","text":"<p> \u7ea6 891 \u4e2a\u5b57  32 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p>"},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/#overview","title":"Overview","text":"<p>SGLang Diffusion \u91c7\u7528\u4e86\u00a0Client-Server\u00a0\u67b6\u6784\uff0c\u7ed3\u5408\u00a0\u591a\u8fdb\u7a0b (Multi-Process)\u00a0\u548c\u00a0\u6a21\u5757\u5316\u6d41\u6c34\u7ebf (Modular Pipeline)\u00a0\u8bbe\u8ba1\u3002</p> <ul> <li>Client (DiffGenerator): \u7528\u6237\u63a5\u53e3\uff0c\u8d1f\u8d23\u53d1\u9001\u8bf7\u6c42\u548c\u63a5\u6536\u7ed3\u679c\u3002</li> <li>Server (Scheduler &amp; Workers): \u540e\u7aef\u63a8\u7406\u670d\u52a1\uff0c\u7531\u591a\u4e2a GPU Worker \u8fdb\u7a0b\u7ec4\u6210\u3002</li> <li>Rank 0 (Scheduler): \u4e3b\u8282\u70b9\uff0c\u8d1f\u8d23\u63a5\u6536 Client \u8bf7\u6c42\uff0c\u5e76\u901a\u8fc7\u5206\u5e03\u5f0f\u5e7f\u64ad\u5c06\u4efb\u52a1\u5206\u53d1\u7ed9\u6240\u6709 Worker\u3002</li> <li>Rank 0 ~ N-1 (GPUWorker): \u8ba1\u7b97\u8282\u70b9\uff0c\u8d1f\u8d23\u6267\u884c\u5177\u4f53\u7684\u6a21\u578b\u63a8\u7406\u3002</li> </ul>"},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/#component","title":"Component","text":"<ul> <li> <p>DiffGenerator: \u7528\u6237\u4f7f\u7528\u7684\u4e3b\u8981\u5165\u53e3\u7c7b\u3002\u63d0\u4f9b\u00a0generate()\u00a0\u63a5\u53e3\uff0c\u5904\u7406\u53c2\u6570\u5c01\u88c5\u3001\u8bf7\u6c42\u53d1\u9001\u548c\u7ed3\u679c\u540e\u5904\u7406\uff08\u5982\u4fdd\u5b58\u89c6\u9891/\u56fe\u7247\uff09\u3002</p> </li> <li> <p>Scheduler: \u8fd0\u884c\u5728 Rank 0 \u8fdb\u7a0b\u4e2d\u3002\u5b83\u76d1\u542c ZMQ \u7aef\u53e3\u63a5\u6536\u8bf7\u6c42\uff0c\u5229\u7528\u00a0torch.distributed\u00a0\u5c06\u8bf7\u6c42\u5e7f\u64ad\u7ed9\u6240\u6709 GPU Worker\u3002</p> </li> <li> <p>GPUWorker: \u6bcf\u4e2a GPU \u5bf9\u5e94\u4e00\u4e2a Worker \u8fdb\u7a0b\u3002\u5b83\u8d1f\u8d23\u521d\u59cb\u5316\u5206\u5e03\u5f0f\u73af\u5883\uff08TP/SP/CFG Parallel\uff09\u548c\u6784\u5efa\u63a8\u7406\u6d41\u6c34\u7ebf\u3002</p> </li> <li> <p>ComposedPipelineBase: \u6a21\u5757\u5316\u7684\u63a8\u7406\u6d41\u6c34\u7ebf\u57fa\u7c7b\u3002\u5b83\u5c06\u63a8\u7406\u8fc7\u7a0b\u62c6\u5206\u4e3a\u591a\u4e2a\u00a0Stage\u3002</p> </li> <li> <p>PipelineStage: \u6d41\u6c34\u7ebf\u7684\u5177\u4f53\u9636\u6bb5\uff0c\u5982\u00a0TextEncodingStage\u00a0(\u6587\u672c\u7f16\u7801),\u00a0DenoisingStage\u00a0(\u53bb\u566a/DiT),\u00a0DecodingStage\u00a0(VAE \u89e3\u7801)\u3002</p> </li> <li> <p>ParallelExecutor: \u8d1f\u8d23\u6267\u884c\u6d41\u6c34\u7ebf\u4e2d\u7684\u5404\u4e2a Stage\uff0c\u5e76\u5904\u7406 Stage \u7ea7\u522b\u7684\u5e76\u884c\u7b56\u7565\uff08\u5982 CFG Parallel\uff09\u3002</p> </li> <li> <p>Req: \u4e00\u4e2a\u5305\u542b\u8bf7\u6c42\u6240\u6709\u72b6\u6001\uff08Prompt, Latents, Embeddings \u7b49\uff09\u7684\u6570\u636e\u7c7b\uff0c\u5728\u6d41\u6c34\u7ebf\u5404 Stage \u95f4\u4f20\u9012\u3002</p> </li> </ul>"},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/#_1","title":"\u5de5\u4f5c\u6d41\u7a0b","text":""},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/#initialization","title":"\u7b2c\u4e00\u9636\u6bb5\uff1a\u521d\u59cb\u5316 (Initialization)","text":"<ol> <li>\u542f\u52a8 Server:    - \u7528\u6237\u521d\u59cb\u5316\u00a0<code>DiffGenerator</code>\u3002\u5982\u679c\u662f\u672c\u5730\u6a21\u5f0f\uff0c\u5b83\u4f1a\u8c03\u7528\u00a0<code>launch_server()</code>\u00a0\u542f\u52a8\u591a\u8fdb\u7a0b\u670d\u52a1\u3002    - <code>launch_server()</code>\u00a0\u6839\u636e GPU \u6570\u91cf\u542f\u52a8 N \u4e2a\u8fdb\u7a0b\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u8fd0\u884c\u00a0<code>run_scheduler_process()</code>\u3002</li> <li>Worker \u521d\u59cb\u5316:    - \u6bcf\u4e2a\u8fdb\u7a0b\u5b9e\u4f8b\u5316\u00a0<code>GPUWorker]</code>\u3002    - \u5206\u5e03\u5f0f\u73af\u5883: \u521d\u59cb\u5316 NCCL \u901a\u4fe1\u7ec4\uff0c\u914d\u7f6e Tensor Parallel (TP)\u3001Sequence Parallel (SP) \u548c CFG Parallel\u3002    - \u6784\u5efa\u6d41\u6c34\u7ebf: \u8c03\u7528\u00a0<code>build_pipeline()</code>\uff0c\u6839\u636e\u6a21\u578b\u8def\u5f84\u52a0\u8f7d\u5bf9\u5e94\u7684 Pipeline\uff08\u5982\u00a0<code>HunyuanVideoPipeline</code>\uff09\u3002    - \u52a0\u8f7d\u6a21\u578b: Pipeline \u52a0\u8f7d\u5404\u4e2a\u5b50\u6a21\u5757\uff08VAE, Transformer, TextEncoder \u7b49\uff09\u3002 JSON<pre><code>{\n  \"_class_name\": \"StableDiffusionPipeline\",\n  \"_diffusers_version\": \"0.9.0\",\n  \"feature_extractor\": [\n    \"transformers\",\n    \"CLIPImageProcessor\"\n  ],\n  \"safety_checker\": [\n    \"stable_diffusion\",\n    \"StableDiffusionSafetyChecker\"\n  ],\n  \"scheduler\": [\n    \"diffusers\",\n    \"PNDMScheduler\"\n  ],\n  \"text_encoder\": [\n    \"transformers\",\n    \"CLIPTextModel\"\n  ],\n  \"tokenizer\": [\n    \"transformers\",\n    \"CLIPTokenizer\"\n  ],\n  \"unet\": [\n    \"diffusers\",\n    \"UNet2DConditionModel\"\n  ],\n  \"vae\": [\n    \"diffusers\",\n    \"AutoencoderKL\"\n  ]\n}\n</code></pre></li> <li>Scheduler \u5c31\u7eea:    - Rank 0 \u8fdb\u7a0b\u989d\u5916\u521d\u59cb\u5316\u00a0<code>Scheduler</code>\u00a0\u5bf9\u8c61\uff0c\u7ed1\u5b9a ZMQ \u7aef\u53e3\uff0c\u8fdb\u5165\u4e8b\u4ef6\u5faa\u73af\u00a0<code>event_loop()</code>\u00a0\u7b49\u5f85\u8bf7\u6c42\u3002</li> </ol>"},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/#inference-execution","title":"\u7b2c\u4e8c\u9636\u6bb5\uff1a\u63a8\u7406\u6267\u884c (Inference Execution)","text":"<ol> <li>\u53d1\u9001\u8bf7\u6c42:    - \u7528\u6237\u8c03\u7528\u00a0<code>DiffGenerator.generate(prompt=\"...\")</code>\u3002    - <code>DiffGenerator</code>\u00a0\u5c06\u53c2\u6570\u5c01\u88c5\u4e3a\u00a0<code>Req</code>\u00a0\u5bf9\u8c61\u5217\u8868\u3002    - \u8c03\u7528 <code>_send_to_scheduler_and_wait_for_response()</code>\uff0c\u5b9e\u9645\u4e0a\u901a\u8fc7\u00a0<code>sync_scheduler_client.forward()</code>\u00a0\u5c06\u8bf7\u6c42\u5e8f\u5217\u5316\u5e76\u901a\u8fc7 ZMQ \u53d1\u9001\u7ed9 Rank 0 \u7684 Scheduler\u3002</li> <li>\u4efb\u52a1\u5206\u53d1: <code>recv_reqs()</code>    - Rank 0:\u00a0<code>Scheduler</code>\u00a0\u6536\u5230\u8bf7\u6c42\u3002    - \u5e7f\u64ad:\u00a0<code>Scheduler</code>\u00a0\u8c03\u7528\u00a0<code>broadcast_pyobj()</code>\uff0c\u5229\u7528\u00a0<code>torch.distributed.broadcast</code>\u00a0\u5c06\u00a0<code>Req</code>\u00a0\u5bf9\u8c61\u5e7f\u64ad\u7ed9\u6240\u6709 GPU Worker\uff08\u5305\u62ec\u5b83\u81ea\u5df1\uff09\u3002</li> <li>\u6d41\u6c34\u7ebf\u6267\u884c:    - \u6240\u6709 Worker \u8c03\u7528\u00a0<code>GPUWorker.execute_forward(reqs)]</code>\u3002    - Pipeline Forward: \u8fdb\u5165 <code>Pipeline.forward()</code>\uff0c\u59d4\u6258\u7ed9\u00a0<code>ParallelExecutor</code>\u3002    - Stage \u6267\u884c:\u00a0<code>ParallelExecutor</code>\u00a0\u6309\u987a\u5e8f\u6267\u884c\u5404\u4e2a Stage\uff08\u5982\u00a0<code>TextEncodingStage</code>\u00a0-&gt;\u00a0<code>DenoisingStage</code>\u00a0-&gt;\u00a0<code>DecodingStage</code>\uff09\u3002<ul> <li>\u5e76\u884c\u5904\u7406: \u5bf9\u4e8e\u652f\u6301 CFG Parallel \u7684 Stage\uff0cExecutor \u4f1a\u534f\u8c03\u4e0d\u540c Rank \u5206\u522b\u8ba1\u7b97 Positive \u548c Negative Prompt\uff0c\u7136\u540e\u540c\u6b65\u7ed3\u679c\u3002\u5bf9\u4e8e TP/SP\uff0c\u5219\u5728\u6a21\u578b\u5c42\u5185\u90e8\u5904\u7406\u3002</li> <li>\u72b6\u6001\u66f4\u65b0: \u6bcf\u4e2a Stage \u4fee\u6539\u00a0<code>Req</code>\u00a0\u5bf9\u8c61\uff08\u4f8b\u5982\u586b\u5145\u00a0<code>req.latents</code>\uff09\u3002</li> </ul> </li> <li>\u7ed3\u679c\u8fd4\u56de:    - \u63a8\u7406\u5b8c\u6210\u540e\uff0c\u751f\u6210\u7684\u7ed3\u679c\uff08\u5982\u751f\u6210\u7684 Tensor\uff09\u5b58\u50a8\u5728\u00a0<code>Req</code>\u00a0\u5bf9\u8c61\u4e2d\u3002    - Rank 0:\u00a0<code>Scheduler</code>\u00a0\u5c06\u7ed3\u679c\u5c01\u88c5\u4e3a <code>OuputBatch</code>\uff0c\u901a\u8fc7 ZMQ \u53d1\u56de\u7ed9 Client\u3002</li> </ol>"},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/#post-processing","title":"\u7b2c\u4e09\u9636\u6bb5\uff1a\u540e\u5904\u7406 (Post-Processing)","text":"<ol> <li>Client \u63a5\u6536:\u00a0<code>DiffGenerator</code>\u00a0\u6536\u5230\u00a0<code>OutputBatch</code>\u3002</li> <li>\u4fdd\u5b58\u7ed3\u679c: \u8c03\u7528\u00a0<code>post_process_sample</code>\u00a0\u5c06 Tensor \u8f6c\u6362\u4e3a\u56fe\u50cf\u6216\u89c6\u9891\u5e27\uff0c\u5e76\u4fdd\u5b58\u5230\u78c1\u76d8\u3002</li> </ol>"},{"location":"notes/diffusion/MultiModel%20Generate%20in%20SGLang/#parallelism","title":"\u5e76\u884c\u7b56\u7565 (Parallelism)","text":"<p>SGLang Diffusion \u652f\u6301\u591a\u79cd\u5e76\u884c\u65b9\u5f0f\u4ee5\u52a0\u901f\u751f\u6210\uff1a</p> <ul> <li>Tensor Parallel (TP): \u5c06\u5927\u6a21\u578b\uff08\u5982 DiT\uff09\u7684\u6743\u91cd\u5207\u5206\u5230\u591a\u5361\u3002</li> <li>Sequence Parallel (SP): \u5c06\u957f\u5e8f\u5217\uff08\u89c6\u9891 Token\uff09\u5207\u5206\u5230\u591a\u5361\u3002</li> <li>CFG Parallel: \u5c06 Classifier-Free Guidance \u7684\u4e24\u6b21\u524d\u5411\u8ba1\u7b97\uff08\u6709\u6761\u4ef6\u548c\u65e0\u6761\u4ef6\uff09\u5206\u914d\u5230\u4e0d\u540c\u7684 GPU \u7ec4\u5e76\u884c\u6267\u884c\uff0c\u51e0\u4e4e\u80fd\u5e26\u6765 2 \u500d\u52a0\u901f\u3002</li> <li>Data Parallel(DP): \u5904\u7406\u4e0d\u540c\u7684\u56fe\u7247</li> </ul>"},{"location":"notes/linux%20tools/1-grep/","title":"grep","text":""},{"location":"notes/linux%20tools/1-grep/#31-grep","title":"3.1 grep","text":"<p> \u7ea6 76 \u4e2a\u5b57  59 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-022025-12-10 <ul> <li>\u5168\u9762\u641c\u7d22\u6b63\u5219\u8868\u8fbe\u5f0f\u5e76\u628a\u884c\u6253\u5370\u51fa\u6765\uff09\u662f\u4e00\u79cd\u5f3a\u5927\u7684\u6587\u672c\u641c\u7d22\u5de5\u5177\uff0c\u5b83\u80fd\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u641c\u7d22\u6587\u672c\uff0c\u5e76\u628a\u5339\u914d\u7684\u884c\u6253\u5370\u51fa\u6765\u3002\u7528\u4e8e\u8fc7\u6ee4/\u641c\u7d22\u7684\u7279\u5b9a\u5b57\u7b26\u3002</li> </ul>"},{"location":"notes/linux%20tools/1-grep/#311","title":"3.1.1 \u57fa\u672c\u547d\u4ee4\u9009\u9879","text":"Bash<pre><code>-a --text  # \u4e0d\u8981\u5ffd\u7565\u4e8c\u8fdb\u5236\u6570\u636e\u3002\n-A &lt;\u663e\u793a\u884c\u6570&gt;   --after-context=&lt;\u663e\u793a\u884c\u6570&gt;   # \u9664\u4e86\u663e\u793a\u7b26\u5408\u8303\u672c\u6837\u5f0f\u7684\u90a3\u4e00\u884c\u4e4b\u5916\uff0c\u5e76\u663e\u793a\u8be5\u884c\u4e4b\u540e\u7684\u5185\u5bb9\u3002\n-b --byte-offset                           # \u5728\u663e\u793a\u7b26\u5408\u8303\u672c\u6837\u5f0f\u7684\u90a3\u4e00\u884c\u4e4b\u5916\uff0c\u5e76\u663e\u793a\u8be5\u884c\u4e4b\u524d\u7684\u5185\u5bb9\u3002\n-B&lt;\u663e\u793a\u884c\u6570&gt;   --before-context=&lt;\u663e\u793a\u884c\u6570&gt;   # \u9664\u4e86\u663e\u793a\u7b26\u5408\u6837\u5f0f\u7684\u90a3\u4e00\u884c\u4e4b\u5916\uff0c\u5e76\u663e\u793a\u8be5\u884c\u4e4b\u524d\u7684\u5185\u5bb9\u3002\n-c --count    # \u8ba1\u7b97\u7b26\u5408\u8303\u672c\u6837\u5f0f\u7684\u5217\u6570\u3002\n-C&lt;\u663e\u793a\u884c\u6570&gt; --context=&lt;\u663e\u793a\u884c\u6570&gt;\u6216-&lt;\u663e\u793a\u884c\u6570&gt; # \u9664\u4e86\u663e\u793a\u7b26\u5408\u8303\u672c\u6837\u5f0f\u7684\u90a3\u4e00\u5217\u4e4b\u5916\uff0c\u5e76\u663e\u793a\u8be5\u5217\u4e4b\u524d\u540e\u7684\u5185\u5bb9\u3002\n-d&lt;\u8fdb\u884c\u52a8\u4f5c&gt; --directories=&lt;\u52a8\u4f5c&gt;  # \u5f53\u6307\u5b9a\u8981\u67e5\u627e\u7684\u662f\u76ee\u5f55\u800c\u975e\u6587\u4ef6\u65f6\uff0c\u5fc5\u987b\u4f7f\u7528\u8fd9\u9879\u53c2\u6570\uff0c\u5426\u5219grep\u547d\u4ee4\u5c06\u56de\u62a5\u4fe1\u606f\u5e76\u505c\u6b62\u52a8\u4f5c\u3002\n-e&lt;\u8303\u672c\u6837\u5f0f&gt; --regexp=&lt;\u8303\u672c\u6837\u5f0f&gt;   # \u6307\u5b9a\u5b57\u7b26\u4e32\u4f5c\u4e3a\u67e5\u627e\u6587\u4ef6\u5185\u5bb9\u7684\u8303\u672c\u6837\u5f0f\u3002\n-E --extended-regexp             # \u5c06\u8303\u672c\u6837\u5f0f\u4e3a\u5ef6\u4f38\u7684\u666e\u901a\u8868\u793a\u6cd5\u6765\u4f7f\u7528\uff0c\u610f\u5473\u7740\u4f7f\u7528\u80fd\u4f7f\u7528\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\u3002\n-f&lt;\u8303\u672c\u6587\u4ef6&gt; --file=&lt;\u89c4\u5219\u6587\u4ef6&gt;     # \u6307\u5b9a\u8303\u672c\u6587\u4ef6\uff0c\u5176\u5185\u5bb9\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u8303\u672c\u6837\u5f0f\uff0c\u8ba9grep\u67e5\u627e\u7b26\u5408\u8303\u672c\u6761\u4ef6\u7684\u6587\u4ef6\u5185\u5bb9\uff0c\u683c\u5f0f\u4e3a\u6bcf\u4e00\u5217\u7684\u8303\u672c\u6837\u5f0f\u3002\n-F --fixed-regexp   # \u5c06\u8303\u672c\u6837\u5f0f\u89c6\u4e3a\u56fa\u5b9a\u5b57\u7b26\u4e32\u7684\u5217\u8868\u3002\n-G --basic-regexp   # \u5c06\u8303\u672c\u6837\u5f0f\u89c6\u4e3a\u666e\u901a\u7684\u8868\u793a\u6cd5\u6765\u4f7f\u7528\u3002\n-h --no-filename    # \u5728\u663e\u793a\u7b26\u5408\u8303\u672c\u6837\u5f0f\u7684\u90a3\u4e00\u5217\u4e4b\u524d\uff0c\u4e0d\u6807\u793a\u8be5\u5217\u6240\u5c5e\u7684\u6587\u4ef6\u540d\u79f0\u3002\n-H --with-filename  # \u5728\u663e\u793a\u7b26\u5408\u8303\u672c\u6837\u5f0f\u7684\u90a3\u4e00\u5217\u4e4b\u524d\uff0c\u6807\u793a\u8be5\u5217\u7684\u6587\u4ef6\u540d\u79f0\u3002\n-i --ignore-case    # \u5ffd\u7565\u5b57\u7b26\u5927\u5c0f\u5199\u7684\u5dee\u522b\u3002\n-l --file-with-matches   # \u5217\u51fa\u6587\u4ef6\u5185\u5bb9\u7b26\u5408\u6307\u5b9a\u7684\u8303\u672c\u6837\u5f0f\u7684\u6587\u4ef6\u540d\u79f0\u3002\n-L --files-without-match # \u5217\u51fa\u6587\u4ef6\u5185\u5bb9\u4e0d\u7b26\u5408\u6307\u5b9a\u7684\u8303\u672c\u6837\u5f0f\u7684\u6587\u4ef6\u540d\u79f0\u3002\n-n --line-number         # \u5728\u663e\u793a\u7b26\u5408\u8303\u672c\u6837\u5f0f\u7684\u90a3\u4e00\u5217\u4e4b\u524d\uff0c\u6807\u793a\u51fa\u8be5\u5217\u7684\u7f16\u53f7\u3002\n-P --perl-regexp         # PATTERN \u662f\u4e00\u4e2a Perl \u6b63\u5219\u8868\u8fbe\u5f0f\n-q --quiet\u6216--silent     # \u4e0d\u663e\u793a\u4efb\u4f55\u4fe1\u606f\u3002\n-R/-r  --recursive       # \u6b64\u53c2\u6570\u7684\u6548\u679c\u548c\u6307\u5b9a\u201c-d recurse\u201d\u53c2\u6570\u76f8\u540c\u3002\n-s --no-messages  # \u4e0d\u663e\u793a\u9519\u8bef\u4fe1\u606f\u3002\n-v --revert-match # \u53cd\u8f6c\u67e5\u627e\u3002\n-V --version      # \u663e\u793a\u7248\u672c\u4fe1\u606f\u3002   \n-w --word-regexp  # \u53ea\u663e\u793a\u5168\u5b57\u7b26\u5408\u7684\u5217\u3002\n-x --line-regexp  # \u53ea\u663e\u793a\u5168\u5217\u7b26\u5408\u7684\u5217\u3002\n-y # \u6b64\u53c2\u6570\u6548\u679c\u8ddf\u201c-i\u201d\u76f8\u540c\u3002\n-o # \u53ea\u8f93\u51fa\u6587\u4ef6\u4e2d\u5339\u914d\u5230\u7684\u90e8\u5206\u3002\n-m &lt;num&gt; --max-count=&lt;num&gt; # \u627e\u5230num\u884c\u7ed3\u679c\u540e\u505c\u6b62\u67e5\u627e\uff0c\u7528\u6765\u9650\u5236\u5339\u914d\u884c\u6570\n</code></pre>"},{"location":"notes/linux%20tools/1-grep/#312","title":"3.1.2 \u793a\u4f8b","text":"Bash<pre><code>grep -E \"[1-9]+\"\n# \u53ea\u8f93\u51fa\u6587\u4ef6\u4e2d\u5339\u914d\u5230\u7684\u90e8\u5206 -o \u9009\u9879\necho this is a test line. | grep -o -E \"[a-z]+\\.\"\nline.\n# \u7edf\u8ba1\u6587\u4ef6\u6216\u8005\u6587\u672c\u4e2d\u5305\u542b\u5339\u914d\u5b57\u7b26\u4e32\u7684\u884c\u6570 -c \u9009\u9879\uff1a\ngrep -c \"text\" file_name\n# \u8f93\u51fa\u5305\u542b\u5339\u914d\u5b57\u7b26\u4e32\u7684\u884c\u6570 -n \u9009\u9879\ngrep \"text\" -n file_1 file_2\n# \u6253\u5370\u6837\u5f0f\u5339\u914d\u6240\u4f4d\u4e8e\u7684\u5b57\u7b26\u6216\u5b57\u8282\u504f\u79fb\n#\u4e00\u884c\u4e2d\u5b57\u7b26\u4e32\u7684\u5b57\u7b26\u504f\u79fb\u662f\u4ece\u8be5\u884c\u7684\u7b2c\u4e00\u4e2a\u5b57\u7b26\u5f00\u59cb\u8ba1\u7b97\uff0c\u8d77\u59cb\u503c\u4e3a0\u3002\u9009\u9879  **-b -o**  \u4e00\u822c\u603b\u662f\u914d\u5408\u4f7f\u7528\u3002\necho gun is not unix | grep -b -o \"not\"\n7:not\n# \u591a\u7ea7\u76ee\u5f55\u4e0b\u9012\u5f52\u641c\u7d22\ngrep \"text\" . -r -n\n# -e \u5339\u914d\u591a\u4e2a\u6837\u5f0f\necho this is a text line | grep -e \"is\" -e \"line\" -o\nis\nis\nline\n# \u53ea\u5728\u76ee\u5f55\u4e2d\u6240\u6709\u7684.php\u548c.html\u6587\u4ef6\u4e2d\u9012\u5f52\u641c\u7d22\u5b57\u7b26\"main()\"\ngrep \"main()\" . -r --include *.{php,html}\n\n# \u5728\u641c\u7d22\u7ed3\u679c\u4e2d\u6392\u9664\u6240\u6709README\u6587\u4ef6\ngrep \"main()\" . -r --exclude \"README\"\n\n# \u5728\u641c\u7d22\u7ed3\u679c\u4e2d\u6392\u9664filelist\u6587\u4ef6\u5217\u8868\u91cc\u7684\u6587\u4ef6\ngrep \"main()\" . -r --exclude-from filelist\n</code></pre>"},{"location":"notes/linux%20tools/2-sed/","title":"sed","text":""},{"location":"notes/linux%20tools/2-sed/#32-sed","title":"3.2 sed","text":"<p> \u7ea6 600 \u4e2a\u5b57  44 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"notes/linux%20tools/2-sed/#321","title":"3.2.1 \u6b63\u5219\u8868\u8fbe\u5f0f","text":""},{"location":"notes/linux%20tools/2-sed/#_1","title":"\u57fa\u672c\u6b63\u5219\u8868\u8fbe\u5f0f","text":"<ul> <li> <p>.\uff0c\u8868\u793a\u5339\u914d\u4efb\u610f\u4e00\u4e2a\u5b57\u7b26\uff0c\u9664\u4e86\u6362\u884c\u7b26\uff0c\u7c7b\u4f3c Shell \u901a\u914d\u7b26\u4e2d\u7684 ?\uff1b</p> </li> <li> <p>*\uff0c\u8868\u793a\u524d\u8fb9\u5b57\u7b26\u6709 0 \u4e2a\u6216\u591a\u4e2a\uff1b</p> </li> <li> <p>.*\uff0c\u8868\u793a\u4efb\u610f\u4e00\u4e2a\u5b57\u7b26\u6709 0 \u4e2a\u6216\u591a\u4e2a\uff0c\u4e5f\u5c31\u662f\u80fd\u5339\u914d\u4efb\u610f\u7684\u5b57\u7b26\uff1b</p> </li> <li> <p><sup>\uff0c\u8868\u793a\u884c\u9996\uff0c\u4e5f\u5c31\u662f\u6bcf\u4e00\u884c\u7684\u5f00\u59cb\u4f4d\u7f6e\uff0c</sup>abc \u5339\u914d\u4ee5 abc \u5f00\u5934\u7684\u5b57\u7b26\u4e32\uff1b</p> </li> <li> <p>\\(\uff0c\u8868\u793a\u884c\u5c3e\uff0c\u4e5f\u5c31\u662f\u6bcf\u4e00\u884c\u7684\u7ed3\u5c3e\u4f4d\u7f6e\uff0c}\\) \u5339\u914d\u4ee5\u5927\u62ec\u53f7\u7ed3\u5c3e\u7684\u5b57\u7b26\u4e32\uff1b</p> </li> <li> <p>{}\uff0c\u8868\u793a\u524d\u8fb9\u5b57\u7b26\u7684\u6570\u91cf\u8303\u56f4\uff0c{2}\uff0c\u8868\u793a\u91cd\u590d 2 \u6b21\uff0c{2,}\u91cd\u590d\u81f3\u5c11 2 \u6b21\uff0c{2,4} \u91cd\u590d 2-4 \u6b21\uff1b</p> </li> <li> <p>[]\uff0c\u62ec\u53f7\u4e2d\u53ef\u4ee5\u5305\u542b\u8868\u793a\u5b57\u7b26\u96c6\u7684\u8868\u8fbe\u5f0f</p> </li> </ul>"},{"location":"notes/linux%20tools/2-sed/#_2","title":"\uff08\u4e8c\uff09\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f","text":"<p>\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\u4f7f\u7528\u9891\u7387\u4e0a\u6ca1\u6709\u57fa\u672c\u8868\u8fbe\u5f0f\u90a3\u4e48\u9ad8\uff0c\u4f46\u4f9d\u7136\u5f88\u91cd\u8981\uff0c\u5f88\u591a\u60c5\u51b5\u4e0b\u6ca1\u6709\u6269\u5c55\u6b63\u5219\u662f\u641e\u4e0d\u5b9a\u7684\uff0csed \u547d\u4ee4\u4f7f\u7528\u6269\u5c55\u6b63\u5219\u65f6\u9700\u8981\u52a0\u4e0a\u9009\u9879 -r\u3002</p> <ul> <li> <p>?\uff1a\u8868\u793a\u524d\u7f6e\u5b57\u7b26\u6709 0 \u4e2a\u6216 1 \u4e2a\uff1b</p> </li> <li> <p>+\uff1a\u8868\u793a\u524d\u7f6e\u5b57\u7b26\u6709 1 \u4e2a\u6216\u591a\u4e2a\uff1b</p> </li> <li> <p>|\uff1a\u8868\u793a\u5339\u914d\u5176\u4e2d\u7684\u4e00\u9879\u5373\u53ef\uff1b</p> </li> <li> <p>()\uff1a\u8868\u793a\u5206\u7ec4\uff0c(a|b)b \u8868\u793a\u53ef\u4ee5\u5339\u914d ab \u6216 bb \u5b50\u4e32\uff0c\u4e14\u547d\u4ee4\u8868\u8fbe\u5f0f\u4e2d\u53ef\u4ee5\u901a\u8fc7 \\1\u3001\\2 \u6765\u8868\u793a\u5339\u914d\u7684\u53d8\u91cf</p> </li> <li> <p>{}\uff1a\u548c\u57fa\u672c\u6b63\u5219\u4e2d\u7684\u5927\u62ec\u53f7\u4e2d\u610f\u4e49\u76f8\u540c\uff0c\u53ea\u4e0d\u8fc7\u4f7f\u7528\u65f6\u4e0d\u7528\u52a0\u8f6c\u4e49\u7b26\u53f7\uff1b</p> </li> </ul>"},{"location":"notes/linux%20tools/2-sed/#322","title":"3.2.2 \u8bed\u6cd5","text":"Bash<pre><code>sed [option] 'command' filename\n</code></pre>"},{"location":"notes/linux%20tools/2-sed/#command","title":"command","text":"<p>command \u5b50\u547d\u4ee4\u683c\u5f0f\uff1a</p> <p>[\u5730\u57401, \u5730\u57402] [\u51fd\u6570] [\u53c2\u6570(\u6807\u8bb0)]</p>"},{"location":"notes/linux%20tools/2-sed/#_3","title":"\u57fa\u672c\u5b50\u547d\u4ee4","text":"<ol> <li>\u66ff\u6362\u5b50\u547d\u4ee4 s</li> </ol> Bash<pre><code># \u5c06\u6bcf\u884c\u7684hello\u66ff\u6362\u4e3aHELLO\uff0c\u53ea\u66ff\u6362\u5339\u914d\u5230\u7684\u7b2c\u4e00\u4e2a\n$ sed 's/hello/HELLO/' file.txt\n\n# \u5c06\u5339\u914d\u5230\u7684hello\u5168\u90e8\u66ff\u6362\u4e3aHELLO\uff0cg\u8868\u793a\u66ff\u6362\u4e00\u884c\u6240\u6709\u5339\u914d\u5230\u7684\n$ sed 's/hello/HELLO/g' file.txt\n\n# \u5c06\u7b2c2\u6b21\u5339\u914d\u5230\u7684hello\u66ff\u6362\n$ sed 's/hello/A/2' file.txt\n\n# \u5c06\u7b2c2\u6b21\u540e\u5339\u914d\u5230\u7684\u6240\u6709\u90fd\u66ff\u6362\n$ sed 's/hello/A/2g' file.txt\n\n# \u5728\u884c\u9996\u52a0#\u53f7\n$ sed 's/^/#/g' file.txt\n\n# \u5728\u884c\u5c3e\u52a0\u4e1c\u897f\n$ sed 's/$/xxx/g' file.txt\n</code></pre> <ul> <li>\u591a\u4e2a\u5339\u914d</li> </ul> Bash<pre><code># \u5c061-3\u884c\u7684my\u66ff\u6362\u4e3ayour\uff0c\u4e143\u884c\u4ee5\u540e\u7684This\u66ff\u6362\u4e3aThat\n$ sed '1,3s/my/your/g; 3,$s/This/That/g' my.txt\n\n# \u7b49\u4ef7\u4e8e\n$ sed -e '1,3s/my/your/g' -e '3,$s/This/That/g' my.txt\n</code></pre> <ol> <li>\u8ffd\u52a0\u5b50\u547d\u4ee4 a</li> </ol> Bash<pre><code> # \u5c06\u6240\u6709\u884c\u4e0b\u8fb9\u90fd\u6dfb\u52a0\u4e00\u884c\u5185\u5bb9A\n $ sed 'a A' file.txt\n\n # \u5c06\u6587\u4ef6\u4e2d1-2\u884c\u4e0b\u8fb9\u90fd\u6dfb\u52a0\u4e00\u884c\u5185\u5bb9A\n $ sed '1,2a A' file.txt\n</code></pre> <ol> <li> <p>\u63d2\u5165\u5b50\u547d\u4ee4 i</p> </li> <li> <p>\u66ff\u6362\u5b50\u547d\u4ee4 c</p> </li> <li> <p>\u5220\u9664\u5b50\u547d\u4ee4 d</p> </li> </ol>"},{"location":"notes/linux%20tools/2-sed/#option","title":"option","text":"<ul> <li> <p>-n\uff0c\u8868\u793a\u5b89\u9759\u6a21\u5f0f\u3002\u9ed8\u8ba4 sed \u4f1a\u628a\u6bcf\u884c\u5185\u5bb9\u5904\u7406\u5b8c\u6bd5\u540e\u6253\u5370\u5230\u5c4f\u5e55\u4e0a\uff0c\u52a0\u4e0a\u9009\u9879\u540e\u5c31\u4e0d\u4f1a\u8f93\u51fa\u5230\u5c4f\u5e55\u4e0a\u3002</p> </li> <li> <p>-e\uff0c\u5982\u679c\u9700\u8981\u7528 sed \u5bf9\u6587\u672c\u5185\u5bb9\u8fdb\u884c\u591a\u79cd\u64cd\u4f5c\uff0c\u5219\u9700\u8981\u6267\u884c\u591a\u6761\u5b50\u547d\u4ee4\u6765\u8fdb\u884c\u64cd\u4f5c\uff1b</p> </li> <li> <p>-i\uff0c\u9ed8\u8ba4 sed \u53ea\u4f1a\u5904\u7406\u6a21\u5f0f\u7a7a\u95f4\u7684\u526f\u672c\u5185\u5bb9\uff0c\u4e0d\u4f1a\u76f4\u63a5\u4fee\u6539\u6587\u4ef6\uff0c\u5982\u679c\u9700\u8981\u4fee\u6539\u6587\u4ef6\uff0c\u5c31\u8981\u6307\u5b9a -i \u9009\u9879\uff1b</p> </li> <li> <p>-f\uff0c\u5982\u679c\u547d\u4ee4\u64cd\u4f5c\u6bd4\u8f83\u591a\u65f6\uff0c\u7528 -e \u4f1a\u6709\u70b9\u529b\u4e0d\u4ece\u5fc3\uff0c\u8fd9\u65f6\u9700\u8981\u628a\u591a\u4e2a\u5b50\u547d\u4ee4\u5199\u5165\u811a\u672c\u6587\u4ef6\uff0c\u4f7f\u7528 -f \u9009\u9879\u6307\u5b9a\u6267\u884c\u8be5\u811a\u672c\uff1b</p> </li> <li> <p>-r\uff1a\u5982\u679c\u9700\u8981\u652f\u6301\u6269\u5c55\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u90a3\u4e48\u9700\u8981\u6dfb\u52a0 -r \u9009\u9879\uff1b</p> </li> </ul>"},{"location":"notes/linux%20tools/2-sed/#323","title":"3.2.3 \u6570\u5b57\u5b9a\u5740\u548c\u6b63\u5219\u5b9a\u5740","text":""},{"location":"notes/linux%20tools/2-sed/#_4","title":"\u6570\u5b57\u5b9a\u5740","text":"Bash<pre><code># \u53ea\u5c06\u7b2c4\u884c\u4e2dhello\u66ff\u6362\u4e3aA\n$ sed '4s/hello/A/g' file.txt\n# \u5c06\u7b2c2-4\u884c\u4e2dhello\u66ff\u6362\u4e3aA\n$ sed '2,4s/hello/A/g' file.txt\n# \u4ece\u7b2c2\u884c\u5f00\u59cb\uff0c\u5f80\u4e0b\u65704\u884c\uff0c\u4e5f\u5c31\u662f2-6\u884c\n$ sed '2,+4s/hello/A/g' file.txt\n# \u5c06\u6700\u540e1\u884c\u4e2dhello\u66ff\u6362\u4e3aA\n$ sed '$s/hello/A/g' file.txt\n# \u9664\u4e86\u7b2c1\u884c\uff0c\u5176\u5b83\u884c\u5c06hello\u66ff\u6362\u4e3aA\n$ sed '1!s/hello/A/g' file.txt\n</code></pre>"},{"location":"notes/linux%20tools/2-sed/#_5","title":"\u6b63\u5219\u5b9a\u5740","text":"Bash<pre><code># \u5c06\u5339\u914d\u5230hello\u7684\u884c\u6267\u884c\u5220\u9664\u64cd\u4f5c\uff0cd \u8868\u793a\u5220\u9664\n$ sed '/hello/d' file.txt\n# \u5220\u9664\u7a7a\u884c\uff0c\"^$\" \u8868\u793a\u7a7a\u884c\n$ sed '/^$/d' file.txt\n# \u5c06\u5339\u914d\u5230\u4ee5ts\u5f00\u5934\u7684\u884c\u5230\u4ee5te\u5f00\u5934\u7684\u884c\u4e4b\u95f4\u6240\u6709\u884c\u8fdb\u884c\u5220\u9664\n$ sed '/^ts/,/^te/d' file.txt\n</code></pre>"},{"location":"notes/linux%20tools/3-awk/","title":"awk","text":""},{"location":"notes/linux%20tools/3-awk/#33-awk","title":"3.3 awk","text":"<p> \u7ea6 169 \u4e2a\u5b57  19 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-022025-12-10 <ul> <li>awk\u4f1a\u6839\u636e\u7a7a\u683c\u548c\u5236\u8868\u7b26\uff0c\u5c06\u6bcf\u4e00\u884c\u5206\u6210\u82e5\u5e72\u5b57\u6bb5\uff0c\u4f9d\u6b21\u7528\\(1\u3001\\)2\u3001$3\u4ee3\u8868\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u3001\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\u3001\u7b2c\u4e09\u4e2a\u5b57\u6bb5\u7b49\u7b49</li> <li>print\u547d\u4ee4\u91cc\u9762\uff0c\u5982\u679c\u539f\u6837\u8f93\u51fa\u5b57\u7b26\uff0c\u8981\u653e\u5728\u53cc\u5f15\u53f7\u91cc\u9762\u3002</li> </ul>"},{"location":"notes/linux%20tools/3-awk/#331","title":"3.3.1 \u57fa\u672c\u7528\u6cd5","text":"Bash<pre><code>awk action filename\nawk '{print $0}' demo.txt\n</code></pre>"},{"location":"notes/linux%20tools/3-awk/#332","title":"3.3.2 \u5185\u7f6e\u51fd\u6570","text":"<p>\u53d8\u91cfNF\u8868\u793a\u5f53\u524d\u884c\u6709\u591a\u5c11\u4e2a\u5b57\u6bb5\uff0c\u56e0\u6b64$NF\u5c31\u4ee3\u8868\u6700\u540e\u4e00\u4e2a\u5b57\u6bb5\\ \u53d8\u91cfNR\u8868\u793a\u5f53\u524d\u5904\u7406\u7684\u662f\u7b2c\u51e0\u884c\\ toupper()\u7528\u4e8e\u5c06\u5b57\u7b26\u8f6c\u4e3a\u5927\u5199\\ tolower()\uff1a\u5b57\u7b26\u8f6c\u4e3a\u5c0f\u5199\u3002\\ length()\uff1a\u8fd4\u56de\u5b57\u7b26\u4e32\u957f\u5ea6\u3002\\ substr()\uff1a\u8fd4\u56de\u5b50\u5b57\u7b26\u4e32\u3002\\ sin()\uff1a\u6b63\u5f26\u3002\\ cos()\uff1a\u4f59\u5f26\u3002\\ sqrt()\uff1a\u5e73\u65b9\u6839\u3002\\ rand()\uff1a\u968f\u673a\u6570\u3002</p>"},{"location":"notes/linux%20tools/3-awk/#333","title":"3.3.3 \u793a\u4f8b","text":"Bash<pre><code># \u8f93\u51fa\u5947\u6570\u884c\n$ awk -F ':' 'NR % 2 == 1 {print $1}' demo.txt\nroot\nbin\nsync\n\n# \u8f93\u51fa\u7b2c\u4e09\u884c\u4ee5\u540e\u7684\u884c\n$ awk -F ':' 'NR &gt;3 {print $1}' demo.txt\nsys\nsync\n\n$ awk -F ':' '$1 == \"root\" {print $1}' demo.txt\nroot\n\n$ awk -F ':' '$1 == \"root\" || $1 == \"bin\" {print $1}' demo.txt\nroot\nbin\n</code></pre>"},{"location":"notes/linux%20tools/4-find/","title":"find","text":""},{"location":"notes/linux%20tools/4-find/#34-find","title":"3.4 find","text":"<p> \u7ea6 282 \u4e2a\u5b57  11 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p> 2025-12-022025-12-10 <ul> <li>\u4ece\u6bcf\u4e2a\u6307\u5b9a\u7684\u8d77\u59cb\u70b9 (\u76ee\u5f55) \u5f00\u59cb\uff0c\u641c\u7d22\u4ee5\u8be5\u70b9\u4e3a\u6839\u7684\u76ee\u5f55\u6811\uff0c\u5e76\u6309\u7167\u8fd0\u7b97\u7b26\u4f18\u5148\u7ea7\u89c4\u5219\u4ece\u5de6\u81f3\u53f3\u8bc4\u4f30\u7ed9\u5b9a\u7684\u8868\u8fbe\u5f0f\uff0c\u76f4\u5230\u7ed3\u679c\u786e\u5b9a\uff0c\u6b64\u65f6find\u4f1a\u7ee7\u7eed\u5904\u7406\u4e0b\u4e00\u4e2a\u6587\u4ef6\u540d\u3002</li> </ul>"},{"location":"notes/linux%20tools/4-find/#341","title":"3.4.1 \u8bed\u6cd5","text":"Bash<pre><code>find [-H] [-L] [-P] [-D debugopts] [-Olevel] [\u8d77\u59cb\u70b9...] [\u8868\u8fbe\u5f0f]\n</code></pre> <ul> <li>-name pattern\uff1a\u6309\u6587\u4ef6\u540d\u67e5\u627e\uff0c\u652f\u6301\u4f7f\u7528\u901a\u914d\u7b26 * \u548c ?\u3002</li> <li>-type type\uff1a\u6309\u6587\u4ef6\u7c7b\u578b\u67e5\u627e\uff0c\u53ef\u4ee5\u662f f\uff08\u666e\u901a\u6587\u4ef6\uff09\u3001d\uff08\u76ee\u5f55\uff09\u3001l\uff08\u7b26\u53f7\u94fe\u63a5\uff09\u7b49\u3002 <p>f \u666e\u901a\u6587\u4ef6\\ l \u7b26\u53f7\u8fde\u63a5\\ d \u76ee\u5f55\\ c \u5b57\u7b26\u8bbe\u5907\\ b \u5757\u8bbe\u5907\\ s \u5957\u63a5\u5b57\\ p Fifo</p> </li> <li>-size [+-]size[cwbkMG]\uff1a\u6309\u6587\u4ef6\u5927\u5c0f\u67e5\u627e\uff0c\u652f\u6301\u4f7f\u7528 + \u6216 - \u8868\u793a\u5927\u4e8e\u6216\u5c0f\u4e8e\u6307\u5b9a\u5927\u5c0f\uff0c\u5355\u4f4d\u53ef\u4ee5\u662f c\uff08\u5b57\u8282\uff09\u3001w\uff08\u5b57\u6570\uff09\u3001b\uff08\u5757\u6570\uff09\u3001k\uff08KB\uff09\u3001M\uff08MB\uff09\u6216 G\uff08GB\uff09\u3002</li> <li>-mtime days\uff1a\u6309\u4fee\u6539\u65f6\u95f4\u67e5\u627e\uff0c\u652f\u6301\u4f7f\u7528 + \u6216 - \u8868\u793a\u5728\u6307\u5b9a\u5929\u6570\u524d\u6216\u540e\uff0cdays \u662f\u4e00\u4e2a\u6574\u6570\u8868\u793a\u5929\u6570\u3002</li> <li>-user username\uff1a\u6309\u6587\u4ef6\u6240\u6709\u8005\u67e5\u627e\u3002</li> <li>-group groupname\uff1a\u6309\u6587\u4ef6\u6240\u5c5e\u7ec4\u67e5\u627e</li> <li>-depth: \u8ba9 find \u4ee5\u6df1\u5ea6\u4f18\u5148\u7684\u65b9\u5f0f\u904d\u5386\u76ee\u5f55\u6811\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b find \u4ee5\u5e7f\u5ea6\u4f18\u5148\u65b9\u5f0f\u5904\u7406\u76ee\u5f55\u6811</li> </ul>"},{"location":"notes/linux%20tools/4-find/#342","title":"3.4.2 \u793a\u4f8b","text":"Bash<pre><code># \u5f53\u524d\u76ee\u5f55\u641c\u7d22\u6240\u6709\u6587\u4ef6\uff0c\u4e14\u6587\u4ef6\u5185\u5bb9\u5305\u542b \u201c140.206.111.111\u201d\nfind . -type f -name \"*\" | xargs grep \"140.206.111.111\"\n# \u5728/home\u76ee\u5f55\u4e0b\u67e5\u627e\u4ee5.txt\u7ed3\u5c3e\u7684\u6587\u4ef6\u540d\uff0c\u5ffd\u7565\u5927\u5c0f\u5199\nfind /home -iname \"*.txt\"\n# \u5f53\u524d\u76ee\u5f55\u53ca\u5b50\u76ee\u5f55\u4e0b\u67e5\u627e\u6240\u6709\u4ee5.txt\u548c.pdf\u7ed3\u5c3e\u7684\u6587\u4ef6\nfind . -name \"*.txt\" -o -name \"*.pdf\"\n# \u57fa\u4e8e\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u6587\u4ef6\u8def\u5f84\nfind . -regex \".*\\(\\.txt\\|\\.pdf\\)$\"\n# \u5411\u4e0b\u6700\u5927\u6df1\u5ea6\u9650\u5236\u4e3a3\nfind . -maxdepth 3 -type f\n</code></pre>"},{"location":"notes/llm_inference/Introduction/","title":"Introduction","text":"2025-09-122025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#introduction","title":"Introduction","text":"<p> \u7ea6 5323 \u4e2a\u5b57  22 \u884c\u4ee3\u7801  9 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 27 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#overview","title":"Overview","text":"<p>\u4e0d\u540c\u7684\u7b97\u6cd5\u7ed3\u6784\u6709\u4e0d\u540c\u7684\u8ba1\u7b97\u6a21\u5f0f\uff0c\u5bf9\u6a21\u5f0f\u7684\u5904\u7406\u5f71\u54cd\u4e86\u7b97\u6cd5\u7ed3\u6784\uff0c\u7b97\u6cd5\u7ed3\u6784\u53c8\u4f1a\u6620\u5c04\u5230\u8ba1\u7b97\u673a\u7cfb\u7edf\u8d44\u6e90\u3002\u4ece\u7b97\u6cd5\u9700\u6c42\u5230\u8ba1\u7b97\u673a\u7cfb\u7edf\u8bbe\u8ba1\u7684\u6620\u5c04\u6d89\u53ca\u51e0\u4e2a\u5173\u952e\u8003\u8651\u56e0\u7d20\uff1a</p> <ul> <li>\u5185\u5b58\u8bbf\u95ee\u6a21\u5f0f\uff1a\u6570\u636e\u5982\u4f55\u5728\u5185\u5b58\u5c42\u6b21\u7ed3\u6784\u4e2d\u79fb\u52a8</li> <li>\u8ba1\u7b97\u7279\u6027\uff1a\u7b97\u672f\u64cd\u4f5c\u7684\u672c\u8d28\u548c\u7ec4\u7ec7</li> <li>\u6570\u636e\u79fb\u52a8\uff1a\u7247\u4e0a\u548c\u7247\u5916\u6570\u636e\u4f20\u8f93\u7684\u8981\u6c42</li> <li>\u8d44\u6e90\u5229\u7528\uff1a\u8ba1\u7b97\u548c\u5185\u5b58\u8d44\u6e90\u7684\u5206\u914d\u65b9\u5f0f</li> </ul> <p>\u72b6\u6001\u5316\u5904\u7406\u4f1a\u5728\u65f6\u95f4\u6b65\u957f\u4e0a\u7ef4\u62a4\u4fe1\u606f\uff0c\u9700\u8981\u7279\u5b9a\u7684\u7247\u4e0a\u5185\u5b58\u6765\u7ef4\u62a4</p> <p>\u6211\u4eec\u4e00\u822c\u5206\u6790\u8ba1\u7b97\u6a21\u5f0f\u5982\u4f55\u5f71\u54cd\u8ba1\u7b97\u673a\u7cfb\u7edf\u65f6\uff0c\u4e3b\u8981\u5173\u6ce8\u4e09\u4e2a\u7ef4\u5ea6\uff1a</p> <ol> <li>\u5185\u5b58\u9700\u6c42</li> <li>\u8ba1\u7b97\u9700\u6c42</li> <li>\u6570\u636e\u79fb\u52a8</li> </ol>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#mlp-dense-pattern-processing","title":"MLP\uff1a Dense Pattern Processing","text":"<p>\u6700\u521d\u901a\u8fc7\u5f15\u5165\u901a\u7528\u903c\u8fd1\u5b9a\u7406\uff08UAT\uff09\uff08Cybenko 1992\uff1bHornik, Stinchcombe, and White 1989\uff09\u800c\u5f97\u5230\u5f62\u5f0f\u5316\uff0c\u8be5\u5b9a\u7406\u8868\u660e\uff0c\u5177\u6709\u975e\u7ebf\u6027\u6fc0\u6d3b\u51fd\u6570\u7684\u8db3\u591f\u5927\u7684 MLP \u53ef\u4ee5\u5728\u7d27\u51d1\u57df\u5185\u903c\u8fd1\u4efb\u4f55\u8fde\u7eed\u51fd\u6570\uff0c\u524d\u63d0\u662f\u5177\u6709\u5408\u9002\u7684\u6743\u91cd\u548c\u504f\u5dee</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#pattern-processing-needs","title":"Pattern Processing Needs","text":"<p>\u6df1\u5ea6\u5b66\u4e60\u7cfb\u7edf\u7ecf\u5e38\u9047\u5230\u4efb\u4f55\u8f93\u5165\u7279\u5f81\u90fd\u53ef\u80fd\u5f71\u54cd\u4efb\u4f55\u8f93\u51fa\u7684\u60c5\u51b5\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u5173\u7cfb\u6ca1\u6709\u5185\u5728\u7684\u7ea6\u675f\u3002\u8003\u8651\u5206\u6790\u91d1\u878d\u5e02\u573a\u6570\u636e\uff1a\u4efb\u4f55\u7ecf\u6d4e\u6307\u6807\u90fd\u53ef\u80fd\u5f71\u54cd\u4efb\u4f55\u5e02\u573a\u7ed3\u679c\uff0c\u6216\u8005\u5728\u81ea\u7136\u8bed\u8a00\u5904\u7406\u4e2d\uff0c\u4e00\u4e2a\u8bcd\u7684\u610f\u4e49\u53ef\u80fd\u53d6\u51b3\u4e8e\u53e5\u5b50\u4e2d\u7684\u4efb\u4f55\u5176\u4ed6\u8bcd\u3002\u8fd9\u4e9b\u573a\u666f\u9700\u8981\u4e00\u79cd\u80fd\u591f\u5b66\u4e60\u6240\u6709\u8f93\u5165\u7279\u5f81\u4e4b\u95f4\u4efb\u610f\u5173\u7cfb\u7684\u67b6\u6784\u6a21\u5f0f\u3002</p> <p>\u5bc6\u96c6\u6a21\u5f0f\u5904\u7406\u901a\u8fc7\u5b9e\u73b0\u51e0\u4e2a\u5173\u952e\u80fd\u529b\u6765\u6ee1\u8db3\u8fd9\u4e00\u57fa\u672c\u9700\u6c42\u3002</p> <ul> <li>\u5b83\u5141\u8bb8\u65e0\u9650\u5236\u7684\u7279\u5f81\u4ea4\u4e92\uff0c\u5176\u4e2d\u6bcf\u4e2a\u8f93\u51fa\u53ef\u4ee5\u4f9d\u8d56\u4e8e\u4efb\u4f55\u8f93\u5165\u7ec4\u5408\u3002</li> <li>\u5b83\u4fc3\u8fdb\u4e86\u5b66\u4e60\u5230\u7684\u7279\u5f81\u91cd\u8981\u6027\uff0c\u4f7f\u7cfb\u7edf\u80fd\u591f\u786e\u5b9a\u54ea\u4e9b\u8fde\u63a5\u91cd\u8981\uff0c\u800c\u4e0d\u662f\u7531\u5b83\u4eec\u9884\u5148\u89c4\u5b9a\u3002</li> <li>\u5b83\u63d0\u4f9b\u4e86\u81ea\u9002\u5e94\u8868\u793a\uff0c\u4f7f\u7f51\u7edc\u80fd\u591f\u6839\u636e\u6570\u636e\u91cd\u65b0\u5851\u9020\u5176\u5185\u90e8\u8868\u793a\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#algorithmic-structure","title":"Algorithmic Structure","text":"<p>MLP \u91c7\u7528\u4e86\u4e00\u79cd\u76f4\u63a5\u7684\u7b97\u6cd5\u89e3\u51b3\u65b9\u6848\uff1a\u5c06\u6240\u6709\u5185\u5bb9\u90fd\u8fde\u63a5\u5230\u6240\u6709\u5185\u5bb9\u3002\u8fd9\u901a\u8fc7\u4e00\u7cfb\u5217\u5168\u8fde\u63a5\u5c42\u6765\u5b9e\u73b0\uff0c\u5176\u4e2d\u6bcf\u4e2a\u795e\u7ecf\u5143\u90fd\u4e0e\u76f8\u90bb\u5c42\u4e2d\u7684\u6bcf\u4e2a\u795e\u7ecf\u5143\u76f8\u8fde\u3002</p> \\[ h^{(l)} = f(W^{(l)}h^{(l-1)} + b^{(l)}) \\] <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#computational-mapping","title":"Computational Mapping","text":"<p>mlp_layer_compute \u901a\u8fc7\u5d4c\u5957\u5faa\u73af\u66b4\u9732\u4e86\u5b9e\u9645\u7684\u8ba1\u7b97\u6a21\u5f0f\u3002\u8fd9\u4e2a\u7248\u672c\u5411\u6211\u4eec\u5c55\u793a\u4e86\u5f53\u6211\u4eec\u8ba1\u7b97\u5c42\u7684\u8f93\u51fa\u65f6\u771f\u6b63\u53d1\u751f\u7684\u4e8b\u60c5\uff1a\u6211\u4eec\u5904\u7406\u6279\u6b21\u4e2d\u7684\u6bcf\u4e2a\u6837\u672c\uff0c\u901a\u8fc7\u7d2f\u79ef\u6240\u6709\u8f93\u5165\u7684\u52a0\u6743\u8d21\u732e\u6765\u8ba1\u7b97\u6bcf\u4e2a\u8f93\u51fa\u795e\u7ecf\u5143\u3002</p> Python<pre><code>def mlp_layer_matrix(X, W, b):\n    # X: input matrix (batch_size \u00d7 num_inputs)\n    # W: weight matrix (num_inputs \u00d7 num_outputs)\n    # b: bias vector (num_outputs)\n    H = activation(matmul(X, W) + b)\n    # One clean line of math\n    return H\n\n\ndef mlp_layer_compute(X, W, b):\n    # Process each sample in the batch\n    for batch in range(batch_size):\n        # Compute each output neuron\n        for out in range(num_outputs):\n            # Initialize with bias\n            Z[batch, out] = b[out]\n            # Accumulate weighted inputs\n            for in_ in range(num_inputs):\n                Z[batch, out] += X[batch, in_] * W[in_, out]\n\n    H = activation(Z)\n    return H\n</code></pre>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#system-implications","title":"System Implications","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#memory-requirements","title":"Memory Requirements","text":"<p>\u5185\u5b58\u9700\u6c42\u6e90\u4e8e\u5b58\u50a8\u548c\u8bbf\u95ee\u6743\u91cd\u3001\u8f93\u5165\u548c\u4e2d\u95f4\u7ed3\u679c\u3002\u5728\u6211\u4eec\u7684 MNIST \u793a\u4f8b\u4e2d\uff0c\u5c06 784 \u7ef4\u8f93\u5165\u5c42\u8fde\u63a5\u5230 100 \u4e2a\u795e\u7ecf\u5143\u7684\u9690\u85cf\u5c42\u9700\u8981 78,400 \u4e2a\u6743\u91cd\u53c2\u6570\u3002\u6bcf\u6b21\u524d\u5411\u4f20\u64ad\u5fc5\u987b\u8bbf\u95ee\u6240\u6709\u8fd9\u4e9b\u6743\u91cd\uff0c\u4ee5\u53ca\u8f93\u5165\u6570\u636e\u548c\u4e2d\u95f4\u7ed3\u679c\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#computation-needs","title":"Computation Needs","text":"<p>\u6838\u5fc3\u8ba1\u7b97\u56f4\u7ed5\u5d4c\u5957\u5faa\u73af\u4e2d\u7684\u4e58\u7d2f\u52a0\u64cd\u4f5c\u8fdb\u884c\u3002\u6bcf\u4e2a\u8f93\u51fa\u503c\u9700\u8981\u7684\u4e58\u7d2f\u52a0\u6b21\u6570\u4e0e\u8f93\u5165\u6570\u91cf\u76f8\u540c\u3002\u5bf9\u4e8e MNIST\uff0c\u8fd9\u610f\u5473\u7740\u6bcf\u4e2a\u8f93\u51fa\u795e\u7ecf\u5143\u9700\u8981\u8fdb\u884c 784 \u6b21\u4e58\u7d2f\u52a0\u3002\u5728\u6211\u4eec\u7684\u9690\u85cf\u5c42\u4e2d\u6709 100 \u4e2a\u795e\u7ecf\u5143\uff0c\u5bf9\u4e8e\u5355\u4e2a\u8f93\u5165\u56fe\u50cf\uff0c\u6211\u4eec\u6267\u884c\u4e86 78,400 \u6b21\u4e58\u7d2f\u52a0\u3002</p> <p>\u8fd9\u79cd\u8ba1\u7b97\u7ed3\u6784\u9002\u5408\u4e8e\u73b0\u4ee3\u786c\u4ef6\u4e2d\u7684\u7279\u5b9a\u4f18\u5316\u7b56\u7565\u3002\u5bc6\u96c6\u77e9\u9635\u4e58\u6cd5\u6a21\u5f0f\u53ef\u4ee5\u9ad8\u6548\u5730\u5e76\u884c\u5316\u5230\u591a\u4e2a\u5904\u7406\u5355\u5143\uff0c\u6bcf\u4e2a\u5904\u7406\u5355\u5143\u5904\u7406\u4e0d\u540c\u7684\u795e\u7ecf\u5143\u5b50\u96c6\u3002\u73b0\u4ee3\u786c\u4ef6\u52a0\u901f\u5668\u901a\u8fc7\u4e13\u95e8\u7684\u77e9\u9635\u4e58\u6cd5\u5355\u5143\u5229\u7528\u8fd9\u4e00\u70b9\uff0c\u800c\u6df1\u5ea6\u5b66\u4e60\u6846\u67b6\u81ea\u52a8\u5c06\u8fd9\u4e9b\u64cd\u4f5c\u8f6c\u6362\u4e3a\u4f18\u5316\u7684 BLAS\uff08\u57fa\u672c\u7ebf\u6027\u4ee3\u6570\u5b50\u7a0b\u5e8f\uff09\u8c03\u7528\u3002CPU \u548c GPU \u90fd\u53ef\u4ee5\u901a\u8fc7\u4ed4\u7ec6\u5212\u5206\u8ba1\u7b97\u6765\u5229\u7528\u7f13\u5b58\u5c40\u90e8\u6027\uff0c\u4ee5\u6700\u5927\u5316\u6570\u636e\u91cd\u7528\uff0c\u5c3d\u7ba1\u5b83\u4eec\u7684\u5177\u4f53\u65b9\u6cd5\u6839\u636e\u5176\u67b6\u6784\u4f18\u52bf\u800c\u6709\u6240\u4e0d\u540c\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#data-movement","title":"Data Movement","text":"<p>MLP \u4e2d\u7684\u5168\u8fde\u63a5\u6a21\u5f0f\u4ea7\u751f\u4e86\u5de8\u5927\u7684\u6570\u636e\u79fb\u52a8\u9700\u6c42\u3002\u6bcf\u6b21\u4e58\u52a0\u64cd\u4f5c\u9700\u8981\u4e09\u4efd\u6570\u636e\uff1a\u4e00\u4e2a\u8f93\u5165\u503c\u3001\u4e00\u4e2a\u6743\u91cd\u503c\u548c\u7d2f\u8ba1\u548c\u3002\u5bf9\u4e8e\u6211\u4eec\u7684 MNIST \u793a\u4f8b\u5c42\uff0c\u8ba1\u7b97\u5355\u4e2a\u8f93\u51fa\u503c\u9700\u8981\u5c06 784 \u4e2a\u8f93\u5165\u548c 784 \u4e2a\u6743\u91cd\u79fb\u52a8\u5230\u8ba1\u7b97\u53d1\u751f\u7684\u4efb\u4f55\u5730\u65b9\u3002\u8fd9\u79cd\u79fb\u52a8\u6a21\u5f0f\u5728\u6bcf\u4e2a 100 \u4e2a\u8f93\u51fa\u795e\u7ecf\u5143\u4e2d\u91cd\u590d\uff0c\u4ece\u800c\u5728\u5185\u5b58\u548c\u8ba1\u7b97\u5355\u5143\u4e4b\u95f4\u4ea7\u751f\u4e86\u5927\u91cf\u7684\u6570\u636e\u4f20\u8f93\u9700\u6c42\u3002</p> <p>\u8fd9\u4e9b\u6570\u636e\u79fb\u52a8\u6a21\u5f0f\u7684\u53ef\u9884\u6d4b\u6027\u4f7f\u5f97\u6570\u636e\u9636\u6bb5\u548c\u4f20\u8f93\u4f18\u5316\u6210\u4e3a\u53ef\u80fd\u3002\u4e0d\u540c\u7684\u67b6\u6784\u901a\u8fc7\u5404\u79cd\u673a\u5236\u5e94\u5bf9\u8fd9\u4e00\u6311\u6218\uff1bCPU \u4f7f\u7528\u590d\u6742\u7684\u9884\u53d6\u548c\u591a\u7ea7\u7f13\u5b58\uff1b\u540c\u65f6\uff0cGPU \u91c7\u7528\u9ad8\u5e26\u5bbd\u5185\u5b58\u7cfb\u7edf\u4ee5\u53ca\u901a\u8fc7\u5927\u91cf\u7ebf\u7a0b\u9690\u85cf\u5ef6\u8fdf\u3002\u6df1\u5ea6\u5b66\u4e60\u6846\u67b6\u901a\u8fc7\u4f18\u5316\u7684\u5185\u5b58\u7ba1\u7406\u7cfb\u7edf\u534f\u8c03\u8fd9\u4e9b\u6570\u636e\u79fb\u52a8\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#convolutional-neural-networks-spatial-pattern-processing","title":"Convolutional Neural Networks: Spatial Pattern Processing","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#pattern-processing-needs_1","title":"Pattern Processing Needs","text":"<p>\u7a7a\u95f4\u6a21\u5f0f\u5904\u7406\u6d89\u53ca\u6570\u636e\u70b9\u4e4b\u95f4\u7684\u5173\u7cfb\u53d6\u51b3\u4e8e\u5b83\u4eec\u7684\u76f8\u5bf9\u4f4d\u7f6e\u6216\u90bb\u8fd1\u6027\u7684\u573a\u666f\u3002 </p> <p>\u7a7a\u95f4\u7279\u5f81\u63d0\u53d6\uff1a\u5377\u79ef\u795e\u7ecf\u7f51\u7edc\u901a\u8fc7\u5728\u8f93\u5165\u4e0a\u5e94\u7528\u53ef\u5b66\u4e60\u7684\u6ee4\u6ce2\u5668\u6765\u8bc6\u522b\u56fe\u50cf\u4e2d\u72ec\u7acb\u4e8e\u5176\u4f4d\u7f6e\u7684\u56fe\u6848\uff0c\u4ece\u800c\u5b9e\u73b0\u9c81\u68d2\u7684\u5bf9\u8c61\u8bc6\u522b\u3002\u8fd9\u4e9b\u6ee4\u6ce2\u5668\u68c0\u6d4b\u5c40\u90e8\u7279\u5f81\uff0c\u5e76\u5728\u56fe\u50cf\u4e0a\u91cd\u590d\u5e94\u7528\u8fd9\u4e9b\u6ee4\u6ce2\u5668\u521b\u5efa\u2014\u2014\u5373\u65e0\u8bba\u56fe\u6848\u7684\u4f4d\u7f6e\u5982\u4f55\u90fd\u80fd\u8bc6\u522b\u8be5\u56fe\u6848\u7684\u80fd\u529b</p> <p>CNN \u4e0d\u662f\u5c06\u6bcf\u4e2a\u8f93\u5165\u8fde\u63a5\u5230\u6bcf\u4e2a\u8f93\u51fa\uff0c\u800c\u662f\u4f7f\u7528\u5c40\u90e8\u8fde\u63a5\u6a21\u5f0f\uff0c\u5176\u4e2d\u6bcf\u4e2a\u8f93\u51fa\u4ec5\u8fde\u63a5\u5230\u8f93\u5165\u7684\u4e00\u4e2a\u5c0f\u800c\u7a7a\u95f4\u4e0a\u8fde\u7eed\u7684\u533a\u57df\u3002\u8fd9\u4e2a\u5c40\u90e8\u611f\u53d7\u91ce\u5728\u8f93\u5165\u7a7a\u95f4\u4e2d\u79fb\u52a8\uff0c\u5728\u6bcf\u4e2a\u4f4d\u7f6e\u5e94\u7528\u76f8\u540c\u7684\u4e00\u7ec4\u6743\u91cd\u2014\u2014\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u5377\u79ef</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#algorithmic-structure_1","title":"Algorithmic Structure","text":"<ul> <li> <p>\u5904\u7406\u672c\u5730\u90bb\u57df</p> </li> <li> <p>\u5728\u6bcf\u4e2a\u7a7a\u95f4\u4f4d\u7f6e\u91cd\u590d\u4f7f\u7528\u76f8\u540c\u7684\u6743\u91cd</p> </li> <li> <p>\u5728\u8f93\u51fa\u4e2d\u4fdd\u6301\u7a7a\u95f4\u7ed3\u6784</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#system-implications_1","title":"System Implications","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#memory-requirements_1","title":"Memory Requirements","text":"<p>\u5bf9\u4e8e\u5377\u79ef\u5c42\uff0c\u5185\u5b58\u9700\u6c42\u4e3b\u8981\u96c6\u4e2d\u5728\u4e24\u4e2a\u5173\u952e\u7ec4\u4ef6\uff1a\u6ee4\u6ce2\u5668\u6743\u91cd\u548c\u7279\u5f81\u56fe \u3002\u4e0e\u9700\u8981\u5b58\u50a8\u5b8c\u6574\u8fde\u63a5\u77e9\u9635\u7684 MLP \u4e0d\u540c\uff0cCNN \u4f7f\u7528\u5c0f\u578b\u3001\u53ef\u91cd\u590d\u4f7f\u7528\u7684\u6ee4\u6ce2\u5668\u3002\u5728\u6211\u4eec\u7684 MNIST \u793a\u4f8b\u4e2d\uff0c\u4e00\u4e2a\u5305\u542b 32 \u4e2a\u5927\u5c0f\u4e3a 3*3 \u7684\u6ee4\u6ce2\u5668\u7684\u5377\u79ef\u5c42\u53ea\u9700\u8981\u5b58\u50a8 288 \u4e2a\u6743\u91cd\u53c2\u6570\uff0c\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u6211\u4eec\u7684 MLP \u5168\u8fde\u63a5\u5c42\u9700\u8981 78,400 \u4e2a\u6743\u91cd\u3002\u7136\u800c\uff0c\u7cfb\u7edf\u5fc5\u987b\u5b58\u50a8\u6240\u6709\u7a7a\u95f4\u4f4d\u7f6e\u7684\u7279\u5f81\u56fe\uff0c\u8fd9\u4ea7\u751f\u4e86\u4e0d\u540c\u7684\u5185\u5b58\u9700\u6c42\u2014\u2014\u4e00\u4e2a\u5177\u6709 32 \u4e2a\u8f93\u51fa\u901a\u9053\u7684 28*28 \u7279\u5f81\u56fe\u9700\u8981\u5b58\u50a8 25,088 \u4e2a\u6fc0\u6d3b\u503c</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#computation-needs_1","title":"Computation Needs","text":"<p>CNNs \u7684\u6838\u5fc3\u8ba1\u7b97\u6d89\u53ca\u5728\u7a7a\u95f4\u4f4d\u7f6e\u4e0a\u53cd\u590d\u5e94\u7528\u5c0f\u578b\u6ee4\u6ce2\u5668\u3002\u6bcf\u4e2a\u8f93\u51fa\u503c\u90fd\u9700\u8981\u5728\u6ee4\u6ce2\u5668\u533a\u57df\u5185\u8fdb\u884c\u5c40\u90e8\u4e58\u52a0\u8fd0\u7b97\u3002\u5bf9\u4e8e\u6211\u4eec\u7684 MNIST \u793a\u4f8b\uff0c\u6709 3*3 \u4e2a\u6ee4\u6ce2\u5668\u548c 32 \u4e2a\u8f93\u51fa\u901a\u9053\uff0c\u8ba1\u7b97\u4e00\u4e2a\u7a7a\u95f4\u4f4d\u7f6e\u6d89\u53ca 288 \u6b21\u4e58\u52a0\uff0c\u5e76\u4e14\u5fc5\u987b\u5bf9\u6240\u6709 784 \u4e2a\u7a7a\u95f4\u4f4d\u7f6e \u91cd\u590d\u6b64\u64cd\u4f5c\u3002\u867d\u7136\u6bcf\u4e2a\u5355\u72ec\u7684\u8ba1\u7b97\u6d89\u53ca\u7684\u8fd0\u7b97\u6bd4 MLP \u5c42\u5c11\uff0c\u4f46\u7531\u4e8e\u7a7a\u95f4\u91cd\u590d\uff0c\u603b\u8ba1\u7b97\u91cf\u4ecd\u7136\u5f88\u5927\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#data-movement_1","title":"Data Movement","text":"<p>\u5377\u79ef\u7684\u6ed1\u52a8\u7a97\u53e3\u6a21\u5f0f\u521b\u5efa\u4e86\u4e00\u4e2a\u72ec\u7279\u7684\u6570\u636e\u79fb\u52a8\u914d\u7f6e\u6587\u4ef6\u3002\u4e0e MLP \u4e2d\u6bcf\u4e2a\u6743\u91cd\u5728\u6bcf\u4e2a\u524d\u5411\u4f20\u9012\u4e2d\u53ea\u4f7f\u7528\u4e00\u6b21\u4e0d\u540c\uff0cCNN \u6ee4\u6ce2\u5668\u6743\u91cd\u5728\u6ee4\u6ce2\u5668\u6ed1\u52a8\u5230\u7a7a\u95f4\u4f4d\u7f6e\u65f6\u88ab\u591a\u6b21\u91cd\u590d\u4f7f\u7528\u3002</p> <p>\u7cfb\u7edf\u5fc5\u987b\u5728\u4fdd\u6301\u6ee4\u6ce2\u5668\u6743\u91cd\u7a33\u5b9a\u7684\u540c\u65f6\uff0c\u5c06\u8f93\u5165\u7279\u5f81\u6d41\u7ecf\u8ba1\u7b97\u5355\u5143\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#recurrent-neural-networks-sequential-pattern-processing","title":"Recurrent Neural Networks: Sequential Pattern Processing","text":"<p>\u5143\u7d20\u968f\u65f6\u95f4\u53d8\u5316\u7684\u987a\u5e8f\u548c\u5173\u7cfb\u81f3\u5173\u91cd\u8981\u3002\u6587\u672c\u5904\u7406\u9700\u8981\u7406\u89e3\u8bcd\u8bed\u4e0e\u5148\u524d\u4e0a\u4e0b\u6587\u7684\u5173\u7cfb\uff0c\u8bed\u97f3\u8bc6\u522b\u9700\u8981\u8ddf\u8e2a\u58f0\u97f3\u5982\u4f55\u5f62\u6210\u8fde\u8d2f\u7684\u6a21\u5f0f\uff0c\u65f6\u95f4\u5e8f\u5217\u5206\u6790\u5fc5\u987b\u6355\u6349\u503c\u968f\u65f6\u95f4\u6f14\u5316\u7684\u65b9\u5f0f\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#pattern-processing-needs_2","title":"Pattern Processing Needs","text":"<p>\u5e8f\u5217\u6a21\u5f0f\u5904\u7406\u89e3\u51b3\u5f53\u524d\u8f93\u5165\u7684\u610f\u4e49\u53d6\u51b3\u4e8e\u4e4b\u524d\u53d1\u751f\u7684\u60c5\u51b5\u7684\u573a\u666f\u3002\u4ee5\u81ea\u7136\u8bed\u8a00\u5904\u7406\u4e3a\u4f8b\uff1a\u4e00\u4e2a\u8bcd\u7684\u610f\u4e49\u5f80\u5f80\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53d6\u51b3\u4e8e\u53e5\u5b50\u4e2d\u7684\u524d\u4e00\u4e2a\u8bcd\u3002</p> <p>\u5e8f\u5217\u5904\u7406\u4e2d\u7684\u5173\u952e\u6311\u6218\u662f\u5728\u65f6\u95f4\u4e0a\u7ef4\u62a4\u548c\u66f4\u65b0\u76f8\u5173\u4e0a\u4e0b\u6587\u3002\u5f53\u9605\u8bfb\u6587\u672c\u65f6\uff0c\u4eba\u7c7b\u4e0d\u4f1a\u6bcf\u4e2a\u8bcd\u90fd\u4ece\u5934\u5f00\u59cb\u2014\u2014\u6211\u4eec\u4fdd\u6301\u4e00\u4e2a\u4e0d\u65ad\u53d1\u5c55\u7684\u7406\u89e3\uff0c\u968f\u7740\u6211\u4eec\u5904\u7406\u65b0\u4fe1\u606f\u800c\u6f14\u53d8\u3002\u540c\u6837\uff0c\u5f53\u5904\u7406\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u65f6\uff0c\u6a21\u5f0f\u53ef\u80fd\u8de8\u8d8a\u4e0d\u540c\u7684\u65f6\u95f4\u5c3a\u5ea6\uff0c\u4ece\u5373\u65f6\u4f9d\u8d56\u5230\u957f\u671f\u8d8b\u52bf\u3002\u8fd9\u8868\u660e\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u65e2\u80fd\u7ef4\u62a4\u72b6\u6001\u53c8\u80fd\u6839\u636e\u65b0\u8f93\u5165\u8fdb\u884c\u66f4\u65b0\u7684\u67b6\u6784\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#algorithmic-structure_2","title":"Algorithmic Structure","text":"<p>RNNs \u901a\u8fc7\u5f15\u5165\u5faa\u73af\u8fde\u63a5\uff0c\u4e0d\u4ec5\u5c06\u8f93\u5165\u6620\u5c04\u5230\u8f93\u51fa\uff0c\u800c\u662f\u5728\u6bcf\u4e2a\u65f6\u95f4\u6b65\u66f4\u65b0\u5185\u90e8\u72b6\u6001\u3002\u8fd9\u521b\u5efa\u4e86\u4e00\u79cd\u8bb0\u5fc6\u673a\u5236\uff0c\u4f7f\u7f51\u7edc\u80fd\u591f\u5c06\u4fe1\u606f\u5728\u65f6\u95f4\u4e0a\u4f20\u9012\u3002</p> \\[ h_t = f(W\\_{hh}h\\_{t-1} + W\\_{xh}x_t + b_h) \\] <p></p> <p>Rnn \u901a\u8fc7\u7ef4\u62a4\u4e00\u4e2a\u5305\u542b\u5148\u524d\u65f6\u95f4\u6b65\u4fe1\u606f\u7684\u72b6\u6001\u6765\u5904\u7406\u5e8f\u5217\u6570\u636e\u3002\u5c55\u5f00\u7684\u7ed3\u6784\u660e\u786e\u8868\u793a\u4e86\u5faa\u73af\u6743\u91cd\u5efa\u6a21\u7684\u65f6\u95f4\u4f9d\u8d56\u6027\uff0c\u4f7f\u7f51\u7edc\u80fd\u591f\u5b66\u4e60\u53ef\u53d8\u957f\u5ea6\u5e8f\u5217\u4e2d\u7684\u6a21\u5f0f\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#system-implications_2","title":"System Implications","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#memory-requirements_2","title":"Memory Requirements","text":"<p>RNNs \u9700\u8981\u5b58\u50a8\u4e24\u7ec4\u6743\u91cd\uff08\u8f93\u5165\u5230\u9690\u85cf\u548c\u9690\u85cf\u5230\u9690\u85cf\uff09\u4ee5\u53ca\u9690\u85cf\u72b6\u6001\u3002\u5bf9\u4e8e\u8f93\u5165\u7ef4\u5ea6\u4e3a 100 \u548c\u9690\u85cf\u72b6\u6001\u7ef4\u5ea6\u4e3a 128 \u7684\u793a\u4f8b\uff0c\u8fd9\u610f\u5473\u7740\u9700\u8981\u5b58\u50a8 12,800 \u4e2a\u8f93\u5165\u6295\u5f71\u7684\u6743\u91cd\u548c 16,384 \u4e2a\u9012\u5f52\u8fde\u63a5\u7684\u6743\u91cd\u3002RNN \u7684\u6743\u91cd\u5728\u65f6\u95f4\u6b65\u4e0a\u91cd\u590d\u4f7f\u7528\u3002\u6b64\u5916\uff0c\u7cfb\u7edf\u5fc5\u987b\u7ef4\u62a4\u9690\u85cf\u72b6\u6001\uff0c\u8fd9\u6210\u4e3a\u5185\u5b58\u4f7f\u7528\u548c\u8bbf\u95ee\u6a21\u5f0f\u7684\u5173\u952e\u56e0\u7d20\u3002</p> <p>\u73b0\u4ee3\u5904\u7406\u5668\u901a\u8fc7\u5728\u7f13\u5b58\u4e2d\u4fdd\u6301\u6743\u91cd\u77e9\u9635\uff0c\u5728\u6d41\u8fc7\u5e8f\u5217\u5143\u7d20\u65f6\u5904\u7406\u8fd9\u4e9b\u6a21\u5f0f\u3002\u6df1\u5ea6\u5b66\u4e60\u6846\u67b6\u901a\u8fc7\u5c06\u5e8f\u5217\u5206\u6279\u548c\u4ed4\u7ec6\u7ba1\u7406\u65f6\u95f4\u6b65\u4e4b\u95f4\u7684\u9690\u85cf\u72b6\u6001\u5b58\u50a8\u6765\u4f18\u5316\u5185\u5b58\u8bbf\u95ee\u3002CPU \u548c GPU \u91c7\u7528\u4e0d\u540c\u7684\u7b56\u7565\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1bCPU \u5229\u7528\u5176\u7f13\u5b58\u5c42\u6b21\u7ed3\u6784\u6765\u5b9e\u73b0\u6743\u91cd\u91cd\u7528\uff1b\u540c\u65f6\uff0cGPU \u4f7f\u7528\u4e13\u4e3a\u5728\u8fde\u7eed\u64cd\u4f5c\u4e2d\u7ef4\u62a4\u72b6\u6001\u800c\u8bbe\u8ba1\u7684\u4e13\u7528\u5185\u5b58\u67b6\u6784\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#computation-needs_2","title":"Computation Needs","text":"<p>RNNs \u7684\u6838\u5fc3\u8ba1\u7b97\u6d89\u53ca\u5728\u65f6\u95f4\u6b65\u957f\u4e0a\u53cd\u590d\u5e94\u7528\u6743\u91cd\u77e9\u9635\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u65f6\u95f4\u6b65\u957f\uff0c\u6211\u4eec\u6267\u884c\u4e24\u6b21\u77e9\u9635\u4e58\u6cd5\uff1a\u4e00\u6b21\u662f\u4e0e\u8f93\u5165\u6743\u91cd\u76f8\u4e58\uff0c\u53e6\u4e00\u6b21\u662f\u4e0e\u5faa\u73af\u6743\u91cd\u76f8\u4e58\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u5904\u7406\u5355\u4e2a\u65f6\u95f4\u6b65\u957f\u9700\u8981 12,800 \u6b21\u4e58\u52a0\u8fd0\u7b97\u7528\u4e8e\u8f93\u5165\u6295\u5f71\uff0c\u4ee5\u53ca 16,384 \u6b21\u4e58\u52a0\u8fd0\u7b97\u7528\u4e8e\u5faa\u73af\u8fde\u63a5</p> <p>\u867d\u7136\u6211\u4eec\u53ef\u4ee5\u5728\u6279\u91cf\u5143\u7d20\u4e4b\u95f4\u5e76\u884c\u5316\uff0c\u4f46\u7531\u4e8e\u5e8f\u5217\u4f9d\u8d56\u6027\uff0c\u6211\u4eec\u65e0\u6cd5\u5728\u65f6\u95f4\u6b65\u4e4b\u95f4\u5e76\u884c\u5316\u3002\u6bcf\u4e2a\u65f6\u95f4\u6b65\u5fc5\u987b\u7b49\u5f85\u524d\u4e00\u4e2a\u6b65\u9aa4\u7684\u9690\u85cf\u72b6\u6001\u624d\u80fd\u5f00\u59cb\u8ba1\u7b97\u3002\u8fd9\u5bfc\u81f4\u4e86\u7b97\u6cd5\u56fa\u6709\u7684\u5e8f\u5217\u6027\u8d28\u4e0e\u73b0\u4ee3\u786c\u4ef6\u5e76\u884c\u6267\u884c\u613f\u671b\u4e4b\u95f4\u7684\u7d27\u5f20\u5173\u7cfb\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#data-movement_2","title":"Data Movement","text":"<p>\u6bcf\u4e2a\u65f6\u95f4\u6b65\u5fc5\u987b\uff1a\u52a0\u8f7d\u5148\u524d\u7684\u9690\u85cf\u72b6\u6001\uff08128 \u4e2a\u503c\uff09\u3001\u8bbf\u95ee\u4e24\u4e2a\u6743\u91cd\u77e9\u9635\uff08\u4ece\u8f93\u5165\u548c\u5faa\u73af\u8fde\u63a5\u4e2d\u603b\u5171 29,184 \u4e2a\u6743\u91cd\uff09\uff0c\u5e76\u5b58\u50a8\u65b0\u7684\u9690\u85cf\u72b6\u6001\uff08128 \u4e2a\u503c\uff09\u3002\u8fd9\u79cd\u6a21\u5f0f\u5728\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\u4e0a\u90fd\u4f1a\u91cd\u590d\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#attention-mechanisms-dynamic-pattern-processing","title":"Attention Mechanisms: Dynamic Pattern Processing","text":"<p>\u8bed\u8a00\u7406\u89e3\u9700\u8981\u6355\u6349\u5230\u57fa\u4e8e\u610f\u4e49\u800c\u4e0d\u662f\u4ec5\u4ec5\u4f4d\u7f6e\u7684\u5b57\u8bcd\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u56fe\u5206\u6790\u9700\u8981\u7406\u89e3\u8282\u70b9\u95f4\u53d8\u5316\u7684\u8fde\u63a5\u3002\u8fd9\u4e9b\u52a8\u6001\u5173\u7cfb\u8868\u660e\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u80fd\u591f\u6839\u636e\u6570\u636e\u672c\u8eab\u5b66\u4e60\u5e76\u8c03\u6574\u5176\u5904\u7406\u6a21\u5f0f\u7684\u67b6\u6784\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#pattern-processing-needs_3","title":"Pattern Processing Needs","text":"<p>\u52a8\u6001\u6a21\u5f0f\u5904\u7406\u9488\u5bf9\u7684\u662f\u5143\u7d20\u4e4b\u95f4\u7684\u5173\u7cfb\u4e0d\u662f\u7531\u67b6\u6784\u56fa\u5b9a\uff0c\u800c\u662f\u4ece\u5185\u5bb9\u4e2d\u4ea7\u751f\u7684\u573a\u666f\u3002</p> <p>\u7cfb\u7edf\u5fc5\u987b\u8ba1\u7b97\u6240\u6709\u5143\u7d20\u5bf9\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u6839\u636e\u5185\u5bb9\u6743\u8861\u8fd9\u4e9b\u5173\u7cfb\uff0c\u5e76\u4f7f\u7528\u8fd9\u4e9b\u6743\u91cd\u6765\u9009\u62e9\u6027\u5730\u7ec4\u5408\u4fe1\u606f\u3002\u4e0e\u5177\u6709\u56fa\u5b9a\u8fde\u63a5\u6a21\u5f0f\u7684\u524d\u4e00\u4ee3\u67b6\u6784\u4e0d\u540c\uff0c\u52a8\u6001\u5904\u7406\u9700\u8981\u6839\u636e\u8f93\u5165\u672c\u8eab\u4fee\u6539\u5176\u8ba1\u7b97\u56fe\u7684\u80fd\u529b\u3002\u8fd9\u4f7f\u6211\u4eec\u8f6c\u5411 Transformer \u67b6\u6784\uff0c\u8be5\u67b6\u6784\u901a\u8fc7\u6ce8\u610f\u529b\u673a\u5236\u5b9e\u73b0\u8fd9\u4e9b\u80fd\u529b\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#basic-attention-mechanism","title":"Basic Attention Mechanism","text":"\\[ Attention(Q, K, V) = softmax\\\\left(\\\\frac{QK^T}{\\\\sqrt{d_k}}\\\\right)V \\]","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#system-implications_3","title":"System Implications","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#memory-requirements_3","title":"Memory Requirements","text":"<p>\u6ce8\u610f\u529b\u673a\u5236\u9700\u8981\u5b58\u50a8\u6ce8\u610f\u529b\u6743\u91cd\u3001\u952e\u67e5\u8be2\u503c\u6295\u5f71\u548c\u4e2d\u95f4\u7279\u5f81\u8868\u793a\u3002\u5bf9\u4e8e\u4e00\u4e2a\u5e8f\u5217\u957f\u5ea6\u4e3a N \u548c\u7ef4\u5ea6\u4e3a d \u7684\u60c5\u51b5\uff0c\u6bcf\u4e2a\u6ce8\u610f\u529b\u5c42\u5fc5\u987b\u4e3a\u6279\u6b21\u4e2d\u7684\u6bcf\u4e2a\u5e8f\u5217\u5b58\u50a8\u4e00\u4e2a N*N \u7684\u6ce8\u610f\u529b\u6743\u91cd\u77e9\u9635\uff0c\u4e09\u7ec4\u6295\u5f71\u77e9\u9635\u7528\u4e8e\u67e5\u8be2\u3001\u952e\u548c\u503c\uff08\u6bcf\u4e2a\u5927\u5c0f\u4e3a d*d\uff09\uff0c\u4ee5\u53ca\u5927\u5c0f\u4e3a N*d \u7684\u8f93\u5165\u548c\u8f93\u51fa\u7279\u5f81\u56fe\u3002\u4e3a\u6bcf\u4e2a\u8f93\u5165\u52a8\u6001\u751f\u6210\u6ce8\u610f\u529b\u6743\u91cd\u4f1a\u521b\u5efa\u4e00\u4e2a\u5185\u5b58\u8bbf\u95ee\u6a21\u5f0f\uff0c\u5176\u4e2d\u4e2d\u95f4\u6ce8\u610f\u529b\u6743\u91cd\u6210\u4e3a\u5185\u5b58\u4f7f\u7528\u7684\u4e00\u4e2a\u91cd\u8981\u56e0\u7d20\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#computation-needs_3","title":"Computation Needs","text":"<p>\u8ba1\u7b97\u9700\u6c42\u5728\u6ce8\u610f\u529b\u673a\u5236\u4e2d\u4e3b\u8981\u96c6\u4e2d\u5728\u4e24\u4e2a\u4e3b\u8981\u9636\u6bb5\uff1a\u751f\u6210\u6ce8\u610f\u529b\u6743\u91cd\u548c\u5c06\u5b83\u4eec\u5e94\u7528\u4e8e\u503c\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u6ce8\u610f\u529b\u5c42\uff0c\u7cfb\u7edf\u5728\u591a\u4e2a\u8ba1\u7b97\u9636\u6bb5\u6267\u884c\u5927\u91cf\u7684\u4e58\u52a0\u8fd0\u7b97\u3002\u4ec5\u67e5\u8be2-\u952e\u4ea4\u4e92\u5c31\u9700\u8981 \\(N\\\\times N \\\\times d\\)\u6b21\u4e58\u52a0\u8fd0\u7b97\uff0c\u5e94\u7528\u6ce8\u610f\u529b\u6743\u91cd\u5230\u503c\u4e0a\u4e5f\u9700\u8981\u76f8\u540c\u6570\u91cf\u7684\u8fd0\u7b97\u3002\u8fd8\u9700\u8981\u989d\u5916\u7684\u8ba1\u7b97\u7528\u4e8e\u6295\u5f71\u77e9\u9635\u548c softmax \u64cd\u4f5c\u3002\u8fd9\u79cd\u8ba1\u7b97\u6a21\u5f0f\u4e0e\u4e4b\u524d\u7684\u67b6\u6784\u4e0d\u540c\uff0c\u56e0\u4e3a\u5b83\u4e0e\u5e8f\u5217\u957f\u5ea6\u5448\u4e8c\u6b21\u5173\u7cfb\uff0c\u5e76\u4e14\u9700\u8981\u5bf9\u6bcf\u4e2a\u8f93\u5165\u8fdb\u884c\u65b0\u9c9c\u7684\u8ba1\u7b97\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#data-movement_3","title":"Data Movement","text":"<p>\u6bcf\u4e2a\u6ce8\u610f\u529b\u64cd\u4f5c\u90fd\u6d89\u53ca\u5c06\u67e5\u8be2\u3001\u952e\u548c\u4ef7\u503c\u5411\u91cf\u6295\u5f71\u548c\u79fb\u52a8\u5230\u6bcf\u4e2a\u4f4d\u7f6e\uff0c\u5b58\u50a8\u548c\u8bbf\u95ee\u5b8c\u6574\u7684\u6ce8\u610f\u529b\u6743\u91cd\u77e9\u9635\uff0c\u4ee5\u53ca\u5728\u52a0\u6743\u7ec4\u5408\u9636\u6bb5\u534f\u8c03\u4ef7\u503c\u5411\u91cf\u7684\u79fb\u52a8\u3002\u8fd9\u5f62\u6210\u4e86\u4e00\u79cd\u6570\u636e\u79fb\u52a8\u6a21\u5f0f\uff0c\u5176\u4e2d\u4e2d\u95f4\u6ce8\u610f\u529b\u6743\u91cd\u6210\u4e3a\u7cfb\u7edf\u5e26\u5bbd\u9700\u6c42\u7684\u4e3b\u8981\u56e0\u7d20\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#transformer-and-self-attention","title":"Transformer and Self-Attention","text":"\\[ SelfAttention(X) = softmax(\\\\frac{XW_Q (XW_K)^T}{\\\\sqrt{d_k}})XW_V \\] <ul> <li>\u81ea\u6ce8\u610f\u529b\u4f7f\u5f97\u5e8f\u5217\u4e2d\u6240\u6709\u4f4d\u7f6e\u7684\u5e76\u884c\u5904\u7406\u6210\u4e3a\u53ef\u80fd\u3002\u8fd9\u5728\u8ba1\u7b97\u6240\u6709\u4f4d\u7f6e\u4e0a\u7684 Q \u3001 K \u548c V \u7684\u77e9\u9635\u4e58\u6cd5\u4e2d\u8868\u73b0\u5f97\u975e\u5e38\u660e\u663e\u3002</li> <li>\u6ce8\u610f\u529b\u5206\u6570\u7684\u8ba1\u7b97\u7ed3\u679c\u662f\u4e00\u4e2a\u5927\u5c0f\u4e3a (seq_len \u00d7 seq_len) \u7684\u77e9\u9635\uff0c\u5bfc\u81f4\u4e0e\u5e8f\u5217\u957f\u5ea6\u76f8\u5173\u7684\u4e8c\u6b21\u590d\u6742\u6027\u3002\u5f53\u5904\u7406\u957f\u5e8f\u5217\u65f6\uff0c\u8fd9\u79cd\u4e8c\u6b21\u5173\u7cfb\u6210\u4e3a\u4e00\u4e2a\u663e\u8457\u7684\u8ba1\u7b97\u74f6\u9888\uff0c\u8fd9\u4e00\u6311\u6218\u4fc3\u4f7f\u7814\u7a76\u4eba\u5458\u63a2\u7d22\u66f4\u6709\u6548\u7684\u6ce8\u610f\u529b\u673a\u5236\u3002</li> <li>\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u6709\u6548\u5730\u5e76\u884c\u8fd0\u884c\u591a\u4e2a\u81ea\u6ce8\u610f\u529b\u64cd\u4f5c\uff0c\u6bcf\u4e2a\u64cd\u4f5c\u90fd\u6709\u5176\u81ea\u5df1\u7684\u5b66\u4e60\u6295\u5f71\u96c6\u3002\u867d\u7136\u8fd9\u4f7f\u8ba1\u7b97\u8d1f\u8f7d\u4e0e\u5934\u7684\u6570\u91cf\u5448\u7ebf\u6027\u589e\u957f\uff0c\u4f46\u5b83\u5141\u8bb8\u6a21\u578b\u6355\u6349\u540c\u4e00\u8f93\u5165\u4e2d\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u5173\u7cfb\uff0c\u589e\u5f3a\u4e86\u6a21\u578b\u7684\u8868\u8fbe\u80fd\u529b\u3002</li> <li>\u81ea\u6ce8\u610f\u529b\u4e2d\u7684\u6838\u5fc3\u8ba1\u7b97\u4e3b\u8981\u7531\u5927\u77e9\u9635\u4e58\u6cd5\u4e3b\u5bfc\u3002\u5bf9\u4e8e\u957f\u5ea6\u4e3a\u7684 N \u5e8f\u5217\u548c\u5d4c\u5165\u7ef4\u5ea6\u4e3a d\uff0c\u4e3b\u8981\u64cd\u4f5c\u6d89\u53ca\u5927\u5c0f\u4e3a N*d, d*d, N*N \u7684\u77e9\u9635\u3002\u8fd9\u4e9b\u5bc6\u96c6\u7684\u77e9\u9635\u8fd0\u7b97\u975e\u5e38\u9002\u5408\u5728\u4e13\u95e8\u7684\u786c\u4ef6\u5982 GPU \u4e0a\u52a0\u901f\uff0c\u4f46\u5b83\u4eec\u4e5f\u663e\u8457\u589e\u52a0\u4e86\u6a21\u578b\u7684\u6574\u4f53\u8ba1\u7b97\u6210\u672c\u3002</li> <li>\u81ea\u6ce8\u610f\u529b\u751f\u6210\u5185\u5b58\u5bc6\u96c6\u7684\u4e2d\u95f4\u7ed3\u679c\u3002\u6ce8\u610f\u529b\u6743\u91cd\u77e9\u9635 N*N \u548c\u6bcf\u4e2a\u6ce8\u610f\u529b\u5934\u7684\u4e2d\u95f4\u7ed3\u679c\u521b\u5efa\u4e86\u5927\u91cf\u7684\u5185\u5b58\u9700\u6c42\uff0c\u5c24\u5176\u662f\u5bf9\u4e8e\u957f\u5e8f\u5217\u3002\u8fd9\u53ef\u80fd\u5728\u5185\u5b58\u53d7\u9650\u7684\u8bbe\u5907\u4e0a\u90e8\u7f72\u65f6\u5e26\u6765\u6311\u6218\uff0c\u5e76\u9700\u8981\u5728\u5b9e\u73b0\u4e2d\u4ed4\u7ec6\u7ba1\u7406\u5185\u5b58\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#modern-architectures","title":"Modern Architectures","text":"<p>\u73b0\u4ee3\u67b6\u6784\uff0c\u5c24\u5176\u662f Transformer\uff0c\u4ee3\u8868\u4e86\u8fd9\u4e9b\u57fa\u672c\u6784\u5efa\u6a21\u5757\u7684\u590d\u6742\u7efc\u5408\u3002\u5b83\u4eec\u5e76\u975e\u5f15\u5165\u5168\u65b0\u7684\u6a21\u5f0f\uff0c\u800c\u662f\u901a\u8fc7\u5de7\u5999\u5730\u7ec4\u5408\u548c\u6539\u8fdb\u73b0\u6709\u7ec4\u4ef6\u8fdb\u884c\u521b\u65b0\u3002\u4ee5 Transformer \u67b6\u6784\u4e3a\u4f8b\uff1a\u5176\u6838\u5fc3\u662f MLP \u98ce\u683c\u7684\u524d\u9988\u7f51\u7edc\uff0c\u5728\u6ce8\u610f\u529b\u5c42\u4e4b\u95f4\u5904\u7406\u7279\u5f81\u3002\u6ce8\u610f\u529b\u673a\u5236\u672c\u8eab\u5efa\u7acb\u5728\u5e8f\u5217\u6a21\u578b\u7684\u601d\u60f3\u4e4b\u4e0a\uff0c\u4f46\u53bb\u9664\u4e86\u5faa\u73af\u8fde\u63a5\uff0c\u8f6c\u800c\u4f7f\u7528\u53d7 CNN \u76f4\u89c9\u542f\u53d1\u7684\u4f4d\u7f6e\u5d4c\u5165 \u3002\u8be5\u67b6\u6784\u5e7f\u6cdb\u5229\u7528\u8df3\u8dc3\u8fde\u63a5 \uff0c\u8fd9\u4e9b\u8fde\u63a5\u7ee7\u627f\u81ea ResNets\uff0c\u800c\u5c42\u5f52\u4e00\u5316\uff08\u6e90\u81ea CNN \u7684\u6279\u91cf\u5f52\u4e00\u5316\uff09\u5219\u7a33\u5b9a\u4e86\u8bad\u7ec3 </p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#system-level-building-blocks","title":"System-Level Building Blocks","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#core-computational-primitives","title":"Core Computational Primitives","text":"<p>\u4e09\u4e2a\u57fa\u672c\u64cd\u4f5c\u662f\u6240\u6709\u6df1\u5ea6\u5b66\u4e60\u8ba1\u7b97\u7684\u6784\u5efa\u5757\uff1a\u77e9\u9635\u4e58\u6cd5\u3001\u6ed1\u52a8\u7a97\u53e3\u64cd\u4f5c\u548c\u52a8\u6001\u8ba1\u7b97 \u3002\u8fd9\u4e9b\u64cd\u4f5c\u4e4b\u6240\u4ee5\u662f\u539f\u751f\u7684\uff0c\u662f\u56e0\u4e3a\u5b83\u4eec\u4e0d\u80fd\u8fdb\u4e00\u6b65\u5206\u89e3\u800c\u4e0d\u4f1a\u5931\u53bb\u5176\u57fa\u672c\u7684\u8ba1\u7b97\u7279\u6027\u548c\u6548\u7387\u7279\u5f81\u3002</p> <p>\u52a8\u6001\u8ba1\u7b97\uff0c\u5176\u4e2d\u64cd\u4f5c\u672c\u8eab\u4f9d\u8d56\u4e8e\u8f93\u5165\u6570\u636e\uff0c\u968f\u7740\u6ce8\u610f\u529b\u673a\u5236\u7684\u5174\u8d77\u800c\u663e\u8457\u51fa\u73b0\uff0c\u4f46\u4ee3\u8868\u4e86\u9002\u5e94\u5904\u7406\u6240\u9700\u7684\u57fa\u672c\u80fd\u529b\u3002\u5728 Transformer \u6ce8\u610f\u529b\u4e2d\uff0c\u6bcf\u4e2a\u67e5\u8be2\u52a8\u6001\u786e\u5b9a\u5176\u4e0e\u6240\u6709\u952e\u7684\u4ea4\u4e92\u6743\u91cd\uff1b\u5bf9\u4e8e\u957f\u5ea6\u4e3a 512 \u7684\u5e8f\u5217\uff0c\u8fd9\u610f\u5473\u7740\u5fc5\u987b\u5b9e\u65f6\u8ba1\u7b97 512 \u79cd\u4e0d\u540c\u7684\u6743\u91cd\u6a21\u5f0f\u3002\u4e0e\u9884\u5148\u77e5\u9053\u8ba1\u7b97\u56fe\u7684\u56fa\u5b9a\u6a21\u5f0f\u4e0d\u540c\uff0c\u52a8\u6001\u8ba1\u7b97\u9700\u8981\u8fd0\u884c\u65f6\u51b3\u7b56\u3002\u8fd9\u521b\u9020\u4e86\u7279\u5b9a\u7684\u5b9e\u73b0\u6311\u6218\uff1b\u786c\u4ef6\u5fc5\u987b\u63d0\u4f9b\u7075\u6d3b\u7684\u6570\u636e\u8def\u7531\uff08\u73b0\u4ee3 GPU \u4f7f\u7528\u52a8\u6001\u8c03\u5ea6\uff09\u5e76\u652f\u6301\u53ef\u53d8\u7684\u8ba1\u7b97\u6a21\u5f0f\uff0c\u800c\u8f6f\u4ef6\u6846\u67b6\u9700\u8981\u9ad8\u6548\u7684\u673a\u5236\u6765\u5904\u7406\u6570\u636e\u76f8\u5173\u7684\u6267\u884c\u8def\u5f84\uff08PyTorch \u7684\u52a8\u6001\u8ba1\u7b97\u56fe\uff0cTensorFlow \u7684\u52a8\u6001\u63a7\u5236\u6d41\uff09</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#memory-access-primitives","title":"Memory Access Primitives","text":"<p>Three fundamental memory access patterns dominate in deep learning architectures: sequential access, strided access, and random access</p> <p>\u968f\u673a\u8bbf\u95ee\u5bf9\u7cfb\u7edf\u6548\u7387\u63d0\u51fa\u4e86\u6700\u5927\u7684\u6311\u6218\u3002\u5728\u4e00\u4e2a\u5904\u7406 512 \u4e2a\u6807\u8bb0\u5e8f\u5217\u7684 Transformer \u4e2d\uff0c\u6bcf\u4e2a\u6ce8\u610f\u529b\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u8bbf\u95ee\u5e8f\u5217\u4e2d\u7684\u4efb\u4f55\u4f4d\u7f6e\uff0c\u4ece\u800c\u4ea7\u751f\u4e0d\u53ef\u9884\u6d4b\u7684\u5185\u5b58\u8bbf\u95ee\u6a21\u5f0f\u3002\u968f\u673a\u8bbf\u95ee\u4f1a\u901a\u8fc7\u7f13\u5b58\u672a\u547d\u4e2d\uff08\u53ef\u80fd\u6bcf\u6b21\u8bbf\u95ee\u9020\u6210 100 \u591a\u4e2a\u5468\u671f\u505c\u6ede\uff09\u548c\u4e0d\u53ef\u9884\u6d4b\u7684\u5185\u5b58\u5ef6\u8fdf\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\u3002\u7cfb\u7edf\u901a\u8fc7\u5927\u578b\u7f13\u5b58\u5c42\u6b21\u7ed3\u6784\uff08\u73b0\u4ee3 GPU \u6709\u6570 MB \u7684 L2 \u7f13\u5b58\uff09\u548c\u590d\u6742\u7684\u9884\u53d6\u7b56\u7565\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u800c\u8f6f\u4ef6\u6846\u67b6\u91c7\u7528\u8bf8\u5982\u6ce8\u610f\u529b\u6a21\u5f0f\u526a\u679d\u7b49\u6280\u672f\u6765\u51cf\u5c11\u968f\u673a\u8bbf\u95ee\u9700\u6c42\u3002</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#data-movement-primitives","title":"Data Movement Primitives","text":"<p>\u5728\u6df1\u5ea6\u5b66\u4e60\u67b6\u6784\u4e2d\uff0c\u56db\u79cd\u57fa\u672c\u7684\u6570\u636e\u79fb\u52a8\u6a21\u5f0f\u5f88\u5e38\u89c1\uff1a\u5e7f\u64ad\u3001\u6563\u5c04\u3001\u6536\u96c6\u548c\u5f52\u7ea6\u3002</p> <p></p> <ul> <li>\u5e7f\u64ad\u64cd\u4f5c\u540c\u65f6\u5c06\u76f8\u540c\u7684\u6570\u636e\u53d1\u9001\u5230\u591a\u4e2a\u76ee\u7684\u5730\u3002\u5728\u6279\u91cf\u5927\u5c0f\u4e3a 32 \u7684\u77e9\u9635\u4e58\u6cd5\u4e2d\uff0c\u6bcf\u4e2a\u6743\u91cd\u90fd\u5fc5\u987b\u8fdb\u884c\u5e7f\u64ad\u4ee5\u5e76\u884c\u5904\u7406\u4e0d\u540c\u7684\u8f93\u5165\u3002\u73b0\u4ee3\u786c\u4ef6\u901a\u8fc7\u4e13\u7528\u4e92\u8fde\u652f\u6301\u8fd9\u4e00\u70b9</li> <li>\u6563\u5217\u64cd\u4f5c\u5c06\u4e0d\u540c\u7684\u5143\u7d20\u5206\u914d\u5230\u4e0d\u540c\u7684\u76ee\u7684\u5730\u3002\u5f53\u5728 GPU \u6838\u5fc3\u4e0a\u5e76\u884c\u5316 0#\u77e9\u9635\u4e58\u6cd5\u65f6\uff0c\u6bcf\u4e2a\u6838\u5fc3\u63a5\u6536\u8ba1\u7b97\u7684\u4e00\u90e8\u5206\u3002\u8fd9\u79cd\u5e76\u884c\u5316\u5bf9\u4e8e\u6027\u80fd\u81f3\u5173\u91cd\u8981\uff0c\u4f46\u5177\u6709\u6311\u6218\u6027\uff0c\u56e0\u4e3a\u5185\u5b58\u51b2\u7a81\u548c\u8d1f\u8f7d\u4e0d\u5747\u8861\u53ef\u80fd\u4f1a\u964d\u4f4e\u6548\u7387 50%\u4ee5\u4e0a\u3002</li> <li>\u6536\u96c6\u64cd\u4f5c\u4ece\u591a\u4e2a\u6765\u6e90\u6536\u96c6\u6570\u636e\u3002\u5728\u5e8f\u5217\u957f\u5ea6\u4e3a 512 \u7684 Transformer \u6ce8\u610f\u529b\u4e2d\uff0c\u6bcf\u4e2a\u67e5\u8be2\u5fc5\u987b\u4ece 512 \u4e2a\u4e0d\u540c\u7684\u952e\u503c\u5bf9\u4e2d\u6536\u96c6\u4fe1\u606f\u3002\u8fd9\u4e9b\u4e0d\u89c4\u5219\u7684\u8bbf\u95ee\u6a21\u5f0f\u5177\u6709\u6311\u6218\u6027\uff0c\u968f\u673a\u6536\u96c6\u53ef\u80fd\u6bd4\u987a\u5e8f\u8bbf\u95ee\u6162\u3002\u786c\u4ef6\u901a\u8fc7\u9ad8\u5e26\u5bbd\u4e92\u8fde\u548c\u5927\u578b\u7f13\u5b58\u6765\u652f\u6301\u8fd9\u4e00\u70b9\uff0c\u800c\u8f6f\u4ef6\u6846\u67b6\u91c7\u7528\u8bf8\u5982\u6ce8\u610f\u529b\u6a21\u5f0f\u526a\u679d\u7b49\u6280\u672f\u6765\u51cf\u5c11\u6536\u96c6\u5f00\u9500\u3002</li> <li>\u5f52\u7ea6\u64cd\u4f5c\u5c06\u591a\u4e2a\u503c\u901a\u8fc7\u6c42\u548c\u7b49\u64cd\u4f5c\u5408\u5e76\u6210\u4e00\u4e2a\u5355\u4e00\u7ed3\u679c\u3002\u5728\u8ba1\u7b97 Transformer \u4e2d\u7684\u6ce8\u610f\u529b\u5206\u6570\u6216 MLP \u4e2d\u7684\u5c42\u8f93\u51fa\u65f6\uff0c\u9ad8\u6548\u7684\u5f52\u7ea6\u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\u3002\u786c\u4ef6\u5b9e\u73b0\u4e86\u6811\u72b6\u7ed3\u6784\u7684\u5f52\u7ea6\u7f51\u7edc\uff08\u5c06\u5ef6\u8fdf\u4ece O(N) \u964d\u4f4e\u5230 O(log N)\uff09\uff0c\u800c\u8f6f\u4ef6\u6846\u67b6\u4f7f\u7528\u4f18\u5316\u7684\u5e76\u884c\u5f52\u7ea6\u7b97\u6cd5\uff0c\u53ef\u4ee5\u5b9e\u73b0\u63a5\u8fd1\u7406\u8bba\u5cf0\u503c\u6027\u80fd\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/Introduction/#system-design-impact","title":"System Design Impact","text":"<p>\u8fd9\u4e9b\u539f\u8bed\u5bf9\u7cfb\u7edf\u8bbe\u8ba1\u6700\u663e\u8457\u7684\u5f71\u54cd\u4e4b\u4e00\u662f\u63a8\u52a8\u5411\u4e13\u7528\u786c\u4ef6\u7684\u53d1\u5c55\u3002\u6df1\u5ea6\u5b66\u4e60\u4e2d\u77e9\u9635\u4e58\u6cd5\u548c\u5377\u79ef\u7684\u666e\u904d\u5b58\u5728\u5bfc\u81f4\u4e86\u5f20\u91cf\u5904\u7406\u5355\u5143\uff08TPU\uff09\u548c GPU \u4e2d\u7684\u5f20\u91cf\u6838\u5fc3\u7684\u53d1\u5c55\uff0c\u8fd9\u4e9b\u5355\u5143\u4e13\u95e8\u8bbe\u8ba1\u7528\u4e8e\u9ad8\u6548\u6267\u884c\u8fd9\u4e9b\u64cd\u4f5c\u3002\u8fd9\u4e9b\u4e13\u7528\u5355\u5143\u53ef\u4ee5\u5e76\u884c\u6267\u884c\u8bb8\u591a\u4e58\u52a0\u8fd0\u7b97\uff0c\u663e\u8457\u52a0\u901f\u795e\u7ecf\u7f51\u7edc\u7684\u6838\u5fc3\u8ba1\u7b97\u3002</p> <p>\u5185\u5b58\u7cfb\u7edf\u4e5f\u6df1\u53d7\u6df1\u5ea6\u5b66\u4e60\u539f\u8bed\u9700\u6c42\u7684\u5f71\u54cd\u3002\u652f\u6301\u9ad8\u6548\u5730\u540c\u65f6\u652f\u6301\u987a\u5e8f\u548c\u968f\u673a\u8bbf\u95ee\u6a21\u5f0f\u7684\u9700\u6c42\u63a8\u52a8\u4e86\u590d\u6742\u5185\u5b58\u5c42\u6b21\u7ed3\u6784\u7684\u53d1\u5c55\u3002\u9ad8\u5e26\u5bbd\u5185\u5b58\uff08HBM\uff09\u5728 AI \u52a0\u901f\u5668\u4e2d\u53d8\u5f97\u5e38\u89c1\uff0c\u4ee5\u652f\u6301\u5927\u91cf\u6570\u636e\u4f20\u8f93\u9700\u6c42\uff0c\u5c24\u5176\u662f\u5728 Transformer \u4e2d\u7684\u6ce8\u610f\u529b\u673a\u5236\u64cd\u4f5c\u3002\u7247\u4e0a\u5185\u5b58\u5c42\u6b21\u7ed3\u6784\u53d8\u5f97\u66f4\u52a0\u590d\u6742\uff0c\u62e5\u6709\u591a\u7ea7\u7f13\u5b58\u548c\u6682\u5b58\u5185\u5b58\uff0c\u4ee5\u652f\u6301\u4e0d\u540c\u795e\u7ecf\u7f51\u7edc\u5c42\u7684\u5de5\u4f5c\u96c6\u5927\u5c0f\u3002 </p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/","title":"Parallelization in LLM Inference","text":"2025-09-282025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#parallelism-in-transformer-based-llm","title":"Parallelism in Transformer-Based LLM","text":"<p> \u7ea6 2102 \u4e2a\u5b57  19 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 11 \u5206\u949f</p> <ul> <li>DP: LLM \u8bad\u7ec3\u5e38\u7ed3\u5408 ZeRO \u4f7f\u7528\uff0c\u51cf\u5c11 optimizer/gradient/weight \u7684\u5197\u4f59\u3002</li> <li>PP: DeepSeek \u4f7f\u7528\u4e86 Dualpipe\uff0c\u5927\u591a\u6570\u90fd\u4f1a\u4f7f\u7528 1F1B</li> <li>TP: Megaton-LM \u7684 attention \u7b97\u5b50\u5e76\u884c\u548c matmul \u5e76\u884c</li> <li>Expert Parallelism: MoE \u5c42\u7684\u4e13\u5bb6\u5e76\u884c\uff0cGShard-MoE</li> <li>Inference \u8d8a\u6765\u8d8a\u5e38\u89c1</li> <li>SP(Sequence Parallelism)/CP(context parallelism): \u8d85\u957f\u4e0a\u4e0b\u6587 LLM \u8bad\u7ec3\u4f7f\u7528</li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4ee5 Transformer-based LLM \u4e3a\u4f8b\uff0c\u5206\u6790 Attention \u548c FFN or MoE \u91c7\u7528\u7684\u5e76\u884c\u5316\u624b\u6bb5(Training &amp; Inference)</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#mlp-parallelism","title":"MLP Parallelism","text":"<p>MLP \u7684\u5e76\u884c\u8fd0\u7b97\uff0c\u5305\u62ec\u5c42\u5185\u5207\u5206\u3001\u5c42\u95f4\u5207\u5206\u4ee5\u53ca\u53c2\u6570\u5197\u4f59\u6d88\u9664\uff0c\u5e76\u884c\u65b9\u5f0f\u5305\u62ec\u4e86\u6570\u636e\u5e76\u884c\uff08DP\uff09\u3001\u5e8f\u5217\u5e76\u884c(SP)\u3001\u5f20\u91cf\u5e76\u884c\uff08TP\uff09\u3001\u5c42\u5e76\u884c\uff08PP\uff09\u3001\u53c2\u6570\u5197\u4f59\u6d88\u9664\uff08Zero\uff09</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#_1","title":"\u5c42\u5185\u5e76\u884c","text":"<ul> <li>DP: batch size \u5207\u5206</li> <li>SP: seq len \u5207\u5206</li> <li>TP: hidden size \u5207\u5206   $$ activation size:[batch_size, seq_len, hidden_size]$$</li> </ul> <p>SP \u548c TP \u901a\u5e38\u4e00\u8d77\u4f7f\u7528\uff0c\u56e0\u4e3a TP \u4ec5\u4ec5\u5207\u5206\u4e86 weights\uff0c\u800c input \u6ca1\u6709\u5207\u5206\uff0cGPU \u4e0a\u4ecd\u7136\u4fdd\u5b58\u5b8c\u6574\u7684 \u8f93\u5165\u8ba1\u7b97\u7684 activation\uff0c\u800c SP \u5219\u5207\u5206\u4e86 activation</p> <ul> <li>\u5bf9\u4e8e MLP \u6765\u8bf4\uff0cSP \u662f\u6bd4\u8f83\u5bb9\u6613\u7684\uff0c</li> </ul> <p>Example megatron-v3 \u4e2d\u4f7f\u7528 SP+TP \u6765\u51cf\u5c0f activation \u7684\u5927\u5c0f[^megatronv3]\uff0cTP \u7684\u8ba1\u7b97\u8fc7\u7a0b\u7c7b\u4f3c MatMul Parallelism \u7684\u63cf\u8ff0</p> <ul> <li>MLP TP   \u5728 A x B x C \u77e9\u9635\u4e58\u6cd5\u573a\u666f\uff0cB \u77e9\u9635\u5217\u5207\uff0c C \u77e9\u9635\u884c\u5207\u3002\u8ba1\u7b97\u91cf\u51cf\u534a\uff0c\u591a\u4e86\u4e00\u6b21\u96c6\u7fa4\u901a\u4fe1\uff08allReduce\uff09\u4e2d\u95f4\u503c\u7684\u5b58\u50a8\u5927\u5c0f\u51cf\u534a\uff0cInput, Weight \u51cf\u534a</li> </ul> <p></p> <ul> <li>\u56e0\u4e3a GeLU \u975e\u7ebf\u6027\uff0c\u5fc5\u987b\u4f7f\u7528 allGather \u6765\u6536\u96c6 activation[^megatronv3] </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#_2","title":"\u5c42\u95f4\u5e76\u884c","text":"<p>Pipeline Parallelism\uff0cExpert Parallelism\uff0cAttention-FFN Decoupling</p> <p>\u73b0\u5728\u7684\u666e\u904d\u505a\u6cd5\u662f AFD(Attention-FFN Decoupling)\uff0c\u8fd9\u662f\u4e00\u79cd\u5c42\u95f4\u5f02\u6784\u5e76\u884c\u7b56\u7565\uff0c\u628a Transformer \u91cc\u7684 Attention \u548c MoE-FFN \u62c6\u5f00\u5230\u4e0d\u540c\u8bbe\u5907\u4e0a\u6267\u884c\uff0c\u4ee5\u9002\u914d\u5b83\u4eec\u7b97\u529b/\u663e\u5b58\u9700\u6c42\u7684\u5dee\u5f02\uff0c\u4ece\u800c\u63d0\u9ad8\u63a8\u7406\u541e\u5410\u548c\u786c\u4ef6\u5229\u7528\u7387\uff0cMoE \u7684\u4e0d\u540c\u4e13\u5bb6\u4e5f\u5206\u914d\u5230\u4e0d\u540c\u7684 GPU \u4e0a[<sup>afd][</sup>afd2]</p> <ul> <li> <p>Attention \u662f Matmul + softmax + activation\uff0c\u901a\u5e38\u662f\u8bbf\u5b58\u74f6\u9888\uff08memory access bound\uff09</p> </li> <li> <p>FFN \u662f\u5360\u7528\u663e\u5b58\u5927\uff0c\u7b97\u529b\u8981\u6c42\u9ad8\uff0c\u901a\u5e38\u8868\u73b0\u4e3a\u8ba1\u7b97\u74f6\u9888\uff08compute bound\uff09 </p> </li> <li> <p>ByteDance \u7684 AFD \u65b9\u6848 overview </p> </li> <li> <p>\u5c06\u4e00\u6279\u8bf7\u6c42\u62c6\u5206\u6210 m \u4e2a\u5fae\u6279\u6b21 (micro-batches)\uff0c\u5728\u6ce8\u610f\u529b\u8282\u70b9\u548c\u4e13\u5bb6\u8282\u70b9\u4e4b\u95f4\u521b\u5efa\u4e00\u4e2a\u201c\u4e52\u4e53\u6d41\u6c34\u7ebf\u201d\u3002\u8fd9\u4e9b\u8282\u70b9\u6267\u884c\u5fae\u6279\u6b21\u7684\u524d\u5411\u4f20\u64ad\uff0c\u5e76\u5728\u6bcf\u4e2a MoE \u5c42\u4e2d\u4ea4\u6362\u4e24\u6b21\u4e2d\u95f4\u7ed3\u679c\u3002\u8fd9\u79cd\u8bbe\u7f6e\u4f7f\u5f97\u524d\u5411\u8ba1\u7b97\u80fd\u591f\u8986\u76d6\u901a\u4fe1\u5f00\u9500</p> </li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#_3","title":"\u5197\u4f59\u53c2\u6570\u6d88\u9664","text":"<p>\u4e00\u822c\u4f7f\u7528 ZeRO\uff0c\u5c06\u53c2\u6570\u5206\u6563\u5b58\u50a8</p> <ul> <li>\u6a21\u578b\u53c2\u6570\u8f83\u5c0f\u65f6\uff0c\u4e00\u822c\u9009\u62e9\u53c2\u6570\u5e7f\u64ad</li> </ul> <p></p> <ul> <li>\u53c2\u6570\u8f83\u5927\u65f6\uff0c\u5c06\u6bcf\u4e00\u5c42\u7684\u6743\u91cd n \u7b49\u5206\uff0c\u6bcf\u4e2a GPU \u8bbe\u5907\u4e0a\u9762\u5b58\u4e00\u4efd\uff0c\u5f53\u9700\u8ba1\u7b97\u65f6\u5c06\u5176 allgather \u56de\u6765\u3002</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#attention-parallelism","title":"Attention Parallelism","text":"<ul> <li>DP: batch size</li> <li>TP: heads &amp; \\(d_k\\)</li> <li>SP/CP(context parallelism): seq_len \\(\\(attention \\\\space size: [batch_size, heads, seq_len, d_k]\\)\\)</li> </ul> <p>Attention \u7684\u5c42\u95f4\u5e76\u884c\u3001\u5197\u4f59\u53c2\u6570\u6d88\u9664\u65b9\u5f0f\u4e0e\u7ebf\u6027\u5c42\u7684\u65b9\u5f0f\u4e00\u81f4\uff0c\u5c42\u5185\u5e76\u884c\u7684\u4e3b\u8981\u5dee\u5f02\u662f TP \u548c SP</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#sequence-parallelsimspcp","title":"Sequence Parallelsim[<sup>sp][</sup>cp]","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#motivation","title":"Motivation","text":"<p>self-attention \u7684\u5185\u5b58\u9700\u6c42\u662f\u8f93\u5165\u957f\u5ea6\uff08sequence length\uff09\u7684 2 \u6b21\u65b9\u3002\u5176\u590d\u6742\u5ea6\u4e3a \\(O(n^2)\\) \uff0c\u5176\u4e2d\uff0cn \u662f\u5e8f\u5217\u957f\u5ea6\u3002\u6362\u8a00\u4e4b\uff0c\u957f\u5e8f\u5217\u6570\u636e\u5c06\u589e\u52a0\u4e2d\u95f4 activation \u5185\u5b58\u4f7f\u7528\u91cf\uff0c\u4ece\u800c\u9650\u5236\u8bbe\u5907\u7684\u8bad\u7ec3\u80fd\u529b\u3002</p> <p>\u8fd9\u91cc\u51fa\u73b0\u4e86\u4e09\u79cd\u5207\u5206\u65b9\u5f0f\uff1a</p> <ul> <li>\u53ea\u5207\u5206 Q \u7684\u5e8f\u5217   Q \u7684\u5207\u5206\u540e\u7684\u5c3a\u5bf8\u4e3a\\([bs, heads, seq_len/SP, head_dim]\\)\uff0c\u6309\u7167 attention \u8ba1\u7b97\uff1a   1. \u6c42\u89e3 score\uff0cQ x K \u76f8\u5f53\u4e8e\u5de6\u77e9\u9635\u884c\u5207\uff0cscore \u5c3a\u5bf8\uff1a\\([bs, heads, seq_len/SP, seq_len]\\)   1. softmax \u6c42\u89e3\u7684\u662f\u6700\u540e\u4e00\u4e2a\u7ef4\u5ea6\uff0c\u8ba1\u7b97\u5143\u7d20\u503c\u76f8\u540c\uff0c\u5f97\u5230 attention_weights\uff0c   1. attention_weights \u4e0e V \u8fdb\u884c\u77e9\u9635\u4e58\uff0c\u8fd8\u662f\u5de6\u77e9\u9635\u884c\u5207\u8fd0\u7b97\uff0c\u5143\u7d20\u503c\u76f8\u540c\uff0c\u8ba1\u7b97\u5f97\u5230 O \u7684\u5206\u5757\u7ed3\u679c   1. \u5c06\u8ba1\u7b97\u7684 O \u8fdb\u884c allgather\uff0c\u7ed3\u679c\u76f8\u7b49\u3002</li> </ul> <p> \u867d\u7136\u8ba1\u7b97\u4e0a\u53ef\u884c\uff0c\u4f46\u6bcf\u4e2a GPU \u90fd\u9700\u8981\u4e00\u4efd\u5b8c\u6574\u7684 K \u548c V\uff0c\u6ca1\u6709\u8282\u7701\u4e0b\u957f\u5e8f\u5217\u5e26\u6765\u7684\u5de8\u5927 KV Cache \u5185\u5b58\u5f00\u9500\uff0c\u8fd9\u8fdd\u80cc\u4e86 SP \u7684\u521d\u8877\u3002</p> <ul> <li>\u53ea\u5207\u5206 K \u7684\u5e8f\u5217   score \u5c3a\u5bf8\u662f\\([bs, heads, seq_len, seq_len/SP]\\)\uff0c\u8fdb\u4e00\u6b65\u8ba1\u7b97 softmax\uff0c\u7531\u4e8e\u6700\u540e\u4e00\u4e2a\u7ef4\u5ea6\u7684\u6570\u636e\u53ea\u6709\u4e4b\u524d\u7684\u4e00\u534a\u957f\u5ea6\uff0c\u800c softmax \u7684\u8ba1\u7b97\u8ddf\u6574\u4e2a\u5e8f\u5217\u76f8\u5173\uff0c\u76f4\u63a5\u62fc\u63a5\u4f1a\u5bfc\u81f4\u7ed3\u679c\u4e0d\u76f8\u7b49\u3002\u6240\u4ee5\uff0c\u5355\u72ec\u5207 K \u5e8f\u5217\u540e\u62fc\u63a5\uff0c\u7ed3\u679c\u4e0d\u7b49</li> <li>\u53ea\u5207\u5206 V \u5e8f\u5217   \u5f97\u5230 attention_weights \u5c3a\u5bf8\u5b8c\u6574\uff0c\u8ba1\u7b97 attention_weights x V\uff0c\u56e0\u4e3a V \u77e9\u9635\u88ab\u884c\u5207\uff0c\u6240\u4ee5 attention_weights \u9700\u8981\u5217\u5207(Matmul parallelism \u7684\u56fe)\uff0c\u6700\u540e allreduce \u80fd\u591f\u83b7\u5f97\u5b8c\u6574\u7ed3\u679c</li> </ul> <p> softmax \u8ba1\u7b97\u9700\u8981\u5b8c\u6574\u7684 score \u77e9\u9635\uff0c\u5185\u5b58\u74f6\u9888\u6ca1\u6709\u89e3\u51b3</p> <p>\u5f53\u524d\u5e38\u7528\u7684\u65b9\u5f0f\uff1aQKV \u6309\u7167\u76f8\u540c\u65b9\u5f0f\u5207\u5206\uff0c\u7136\u540e\u5bf9 softmax \u4fee\u6b63\uff1a</p> <ul> <li>\u6570\u636e\u534f\u540c\u5207\u5206\uff1a\u6bcf\u4e2a\u5207\u5206 Qi \u8981\u4e0e\u6240\u6709\u7684 Ki\u3001Vi \u8fdb\u884c\u4e00\u6b21\u8ba1\u7b97\uff0c\u5f97\u5230 Oi\uff0c\u5c3a\u5bf8\u5747\u4e3a\\([bs, heads, seq_len/N, head_dim]\\)\uff0c\\(N\\)\u662f sp \u7684\u5e76\u884c\u5ea6</li> <li>\u5206\u5757\u8ba1\u7b97\u4e0e\u901a\u4fe1\uff1a\u6bcf\u4e2a\\(Rank_i\\) \u7684\u76ee\u6807\u662f\u8ba1\u7b97\u51fa\u5b83\u6240\u8d1f\u8d23\u7684\u8f93\u51fa \\(O_i\\)\u3002\u8981\u8ba1\u7b97 \\(O_i\\)\uff0c\\(Q_i\\) \u5fc5\u987b\u548c\u6240\u6709\u7684 \\(K_j\\) \u4e0e \\(V_j\\)\uff08\u5176\u4e2d \\(j=0, 1, ..., N-1\\)\uff09\u8fdb\u884c\u4ea4\u4e92\u3002\u8fd9\u901a\u8fc7\u901a\u4fe1\u5b9e\u73b0\uff08\u4f8b\u5982\uff0cAll-to-All \u6216\u8005 Ring AllGather\uff09\u3002</li> <li>\u5728\u7ebf Softmax \u4fee\u6b63\uff1a\u5728\u4e0e\u6bcf\u4e2a \\(K_j\\), \\(V_j\\) \u5757\u4ea4\u4e92\u8ba1\u7b97\u65f6\uff0c\u4e0d\u80fd\u76f4\u63a5\u8ba1\u7b97\u5c40\u90e8\u7684 softmax \u7136\u540e\u76f8\u52a0\u3002\u5fc5\u987b\u4f7f\u7528\u4e00\u79cdOnline \u7684\u7b97\u6cd5\u6765\u8fed\u4ee3\u5730\u66f4\u65b0 softmax \u7684\u7ed3\u679c\uff0c\u4ece\u800c\u4fdd\u8bc1\u6700\u7ec8\u7ed3\u679c\u4e0e\u5168\u5c40\u8ba1\u7b97\u5b8c\u5168\u4e00\u81f4\u3002 </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#prefill","title":"prefill","text":"<p>\u63a8\u7406\u7684 prefill \u9636\u6bb5\uff0cQ \u7684\u5e8f\u5217\u957f\u5ea6\u4e0e KV \u4fdd\u6301\u4e00\u81f4\uff0c\u5f00\u542f SP \u540e GPU \u4e4b\u95f4\u9700\u8981\u4ea4\u6362 KV \u503c\u4e0e Q \u8fdb\u884c\u8fd0\u7b97</p> <ul> <li>\u6bcf\u4e2a rank \u7684 Q \u4e0e KV \u5339\u914d\u8ba1\u7b97\u5b8c\u540e\u83b7\u5f97\u4e09\u4e2a\u8f93\u51fa\u503c\uff0c\u7136\u540e\u8fdb\u884c\u7ed3\u679c\u4fee\u6b63\u5f97\u5230\\([O\\_{X0}, O\\_{X1}, O\\_{X2}]\\)\uff0cX \u503c\u4e3a rank \u5e8f\u53f7\u3002\u6700\u540e\u6bcf\u4e2a rank \u5c06\u81ea\u5df1\u7684\u5206\u5757\u7ed3\u679c\u8fdb\u884c\u805a\u5408\uff08\u52a0\u6cd5\uff09\u8fd0\u7b97\u5f97\u5230\u7ed3\u679c \\(O_X\\)[^ringattention]</li> </ul> <p>\u53ef\u4ee5\u9009\u62e9 pass Q \u6216\u8005 pass KV</p> <p></p> <p>\u7c7b\u4f3c\u5206\u5e03\u5f0f\u7684 flash attention[^flashattention]</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#decode","title":"decode","text":"<p>\u5728 decode \u9636\u6bb5 Q \u7684\u957f\u5ea6\u4e3a 1\uff0c\u82e5\u5bf9\u5e94\u7684 KV \u503c\u5206\u6563\u5728\u5404\u4e2a GPU \u8bbe\u5907\u4e2d\uff0c\u53ef\u4ee5\u5c06 Q \u590d\u5236 N \u4efd\u4e0e\u5207\u7247\u7684 KV \u503c\u8fdb\u884c attention \u8ba1\u7b97\u540e\uff0c\u6700\u540e\u5c06\u7ed3\u679c gather \u5230\u4e00\u4e2a\u8bbe\u5907\u4e0a\u518d\u8ba1\u7b97\u4fee\u6b63\u7ed3\u679c\u3002 </p> <ul> <li>\u8fd9\u4e2a\u65b9\u5f0f\u610f\u5473\u7740 GPU0 \u9700\u8981\u5b8c\u6210\u6700\u5927\u503c\u3001\u4fee\u6b63\u8fd0\u7b97\u3001\u6c42\u548c\u8fd0\u7b97\uff0cGPU0 \u53ef\u80fd\u6210\u4e3a\u74f6\u9888\u3002\u4e00\u79cd Tree attention \u7b97\u6cd5\u5bf9\u8fc7\u7a0b\u505a\u4e86\u6539\u8fdb\uff0c\u63d0\u5347\u4e86\u901a\u4fe1\u6548\u7387\u3002\u5c31\u662f\u628a gather \u6362\u6210\u591a\u6b21 allreduce\uff0c\u8fd9\u79cd\u65b9\u5f0f\u5728\u8de8\u8282\u70b9\u573a\u666f\u4e2d\u4f18\u52bf\u660e\u663e[^treeattention]\u3002</li> </ul> <p></p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#tensor-parallelism","title":"Tensor Parallelism","text":"<p>Attention \u7684\u5f20\u91cf\u5e76\u884c\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206:QKV \u8fd0\u7b97\u3001\u7ebf\u6027\u6295\u5f71\u8fd0\u7b97\u3002</p> <p>QKV \u8fd0\u7b97\u7684 TP \u5207\u5206\u4e00\u822c\u9488\u5bf9 heads \u7ef4\u5ea6\uff0c\u76f8\u5f53\u4e8e\u77e9\u9635\u7684\u5e76\u884c\u7684\u6279\u91cf\u8fd0\u7b97[^megatronv3]</p> <ul> <li>attention \u6309\u7167 heads \u8fdb\u884c\u5207\u5206</li> <li>linear \u6309\u7167 hidden_size / heads \u8fdb\u884c\u5207\u5206 </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#deepseek-v3deepseekv3","title":"DeepSeek-V3[^deepseekv3]","text":"<p>DeepSeek \u4e00\u5171\u6709 61 \u5c42\uff0c\u4f46\u5e76\u975e\u6bcf\u5c42\u90fd\u91c7\u7528 MoE \u7ed3\u6784\uff0c\u524d 3 \u5c42\u4f9d\u7136\u662f\u53ea\u6709 1 \u4e2a MLP \u7684 Dense \u5c42</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#training-parallelism","title":"Training Parallelism","text":"<p>\\(16PP \\\\times 64EP \\\\times 2DP(ZeRO) = 2048\\) GPUs</p> <ul> <li> <p>DualPipe with Overlap </p> </li> <li> <p>\u53ef\u4ee5\u8ba9 compute \u548c communication \u91cd\u53e0\uff0c\u5728\u6574\u4e2a\u53cc\u5411\u7ba1\u9053\u90fd\u5145\u6ee1\u6570\u636e\u7684\u60c5\u51b5\u4e0b </p> </li> <li> <p>MoE Expert Parallelism</p> </li> <li> <p>Not Tensor Parallelism: \u4e3b\u8981\u539f\u56e0\u662f DeepSeek \u6ca1\u6709 H100GPU \u548c NVLink \u7684\u652f\u6301\uff0cCompute \u80fd\u529b\u548c\u901a\u4fe1\u80fd\u529b\u4e0d\u8db3\u4ee5\u652f\u6491 TP</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#inference-parallelism","title":"Inference Parallelism","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#prefill_1","title":"Prefill","text":"<ul> <li>Compute:</li> <li>Attention: TP4 + SP + DP8 [^deepseekv3]     &gt; TP4 \u662f\u4e3a\u4e86\u964d\u4f4e\u901a\u4fe1\u5f00\u9500</li> <li>FFN: EP32 + TP     &gt; Dense MLP\uff08\u6d45\u5c42\uff09\u90e8\u5206\uff1aTP1\uff08\u65e0\u5f20\u91cf\u5e76\u884c\uff09</li> <li>Scheduler: \u540c\u65f6\u5904\u7406\u4e24\u4e2a micro-batch\uff1b</li> <li>\u5728\u4e00\u4e2a micro-batch \u505a Attention + MoE \u8ba1\u7b97\u65f6\uff0c</li> <li>\u53e6\u4e00\u4e2a micro-batch \u6b63\u5728\u8fdb\u884c token \u7684 dispatch/combine\uff08all-to-all \u901a\u4fe1\uff09\u3002</li> <li>\u7528\u6d41\u6c34\u7ebf\uff08pipeline\uff09\u65b9\u5f0f\u5728 micro-batch \u7ea7\u522b\u505a\u5e76\u884c\u8ba1\u7b97\u4e0e\u901a\u4fe1\u91cd\u53e0</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#decode_1","title":"Decode","text":"<ul> <li>Compute:</li> </ul> \u6a21\u5757 \u5e76\u884c\u7b56\u7565 \u8bf4\u660e Attention \u90e8\u5206 TP4 + SP + DP80 Tensor Parallel 4 \u8def + Sequence Parallel + Data Parallel 80 \u8def MoE \u90e8\u5206 EP320 Expert Parallel 320 \u8def\uff0c\u6bcf\u5f20 GPU \u627f\u8f7d\u4e00\u4e2a\u4e13\u5bb6 <p>\u6bcf\u5f20 GPU \u4e0a\u53ea\u6709 1 \u4e2a\u4e13\u5bb6\uff1b320 \u4e2a\u4e13\u5bb6\u8986\u76d6\u6240\u6709 GPU\uff1b\u53e6\u6709 64 \u5f20 GPU \u4e13\u95e8\u653e\u7f6e\u5197\u4f59\u4e13\u5bb6\u548c\u5171\u4eab\u4e13\u5bb6\u3002</p> <ul> <li>Scheduler: \u548c prefilling \u9636\u6bb5\u7c7b\u4f3c\uff0c\u4ed6\u4eec\u5c1d\u8bd5\u5e76\u884c\u5904\u7406\u4e24\u4e2a\u5fae\u6279\uff08micro-batch\uff09\uff1b\u5728\u89e3\u7801\u9636\u6bb5\uff0cAttention \u5360\u7528\u7684\u8ba1\u7b97\u65f6\u95f4\u66f4\u591a\uff1b\u56e0\u6b64\u91c7\u7528\u65b0\u7684\u91cd\u53e0\u65b9\u5f0f\uff1a</li> </ul> \u9636\u6bb5 micro-batch A micro-batch B \u65f6\u95f4\u7247 1 Attention Dispatch + MoE + Combine \u65f6\u95f4\u7247 2 Dispatch + MoE + Combine Attention","tags":["LLMInference"]},{"location":"notes/llm_inference/LLMparallelization/#_4","title":"\u53c2\u8003\u8d44\u6599","text":"<p>[^megatronv3]: Reducing Activation Recomputation in Large Transformer Models [^afd]: MegaScale-Infer: Serving Mixture-of-Experts at Scale with Disaggregated Expert Parallelism</p> <p>[^afd2]: LLM \u63a8\u7406\u63d0\u901f\uff1aAttention \u4e0e FFN \u5206\u79bb(AFD)\u65b9\u6848\u89e3\u6790 [^sp]: Sequence Parallelism: Long Sequence Training from System Perspective [^cp]: [\u5e76\u884c\u8bad\u7ec3]Context Parallelism \u7684\u539f\u7406\u4e0e\u4ee3\u7801\u6d45\u6790 [^ringattention]: ring attention + flash attention\uff1a\u8d85\u957f\u4e0a\u4e0b\u6587\u4e4b\u8def [^treeattention]: Tree Attention: Topology-aware Decoding for Long-Context Attention on GPU clusters [^deepseekv3]: DeepSeek-V3 Technical Report [^flashattention]: FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/","title":"Attention & Transformers","text":"2025-09-302025-12-12 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#attention-transformers","title":"Attention &amp; Transformers","text":"<p> \u7ea6 3061 \u4e2a\u5b57  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 15 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#attention","title":"Attention","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#self-attention","title":"\u4f20\u7edf\u7684 self-attention","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#_1","title":"\u4f20\u7edf\u7684\u5e8f\u5217\u6a21\u578b\u5904\u7406\u65b9\u5f0f","text":"<p>\u5728\u4f20\u7edf\u7684\u5e8f\u5217\u5904\u7406\u6a21\u578b\uff08\u5982 RNN\u3001LSTM \u548c GRU\uff09\u4e2d\uff0c\u6a21\u578b\u662f\u6309\u987a\u5e8f\u9010\u4e2a\u5904\u7406\u5e8f\u5217\u4e2d\u7684\u5143\u7d20\uff08\u4f8b\u5982\u5355\u8bcd\u6216\u5b57\u7b26\uff09\uff0c\u5e76\u4e14\u6bcf\u4e2a\u5143\u7d20\u7684\u5904\u7406\u4f9d\u8d56\u4e8e\u524d\u4e00\u4e2a\u5143\u7d20\u7684\u9690\u85cf\u72b6\u6001\u3002</p> <p>Warnning</p> <p>\u8fd9\u79cd\u65b9\u6cd5\u5728\u5904\u7406\u957f\u5e8f\u5217\u65f6\u4f1a\u9762\u4e34\u68af\u5ea6\u6d88\u5931\u6216\u68af\u5ea6\u7206\u70b8\u7684\u95ee\u9898\uff0c\u5bfc\u81f4\u6a21\u578b\u96be\u4ee5\u6355\u6349\u957f\u8ddd\u79bb\u7684\u4f9d\u8d56\u5173\u7cfb\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#_2","title":"\u81ea\u6ce8\u610f\u529b\u673a\u5236\u6838\u5fc3\u601d\u60f3","text":"<p>\u5bf9\u4e8e\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\uff0c\u6a21\u578b\u53ef\u4ee5\u540c\u65f6\u8003\u8651\u5e8f\u5217\u4e2d\u6240\u6709\u5176\u4ed6\u5143\u7d20\u7684\u4fe1\u606f\uff0c\u4ece\u800c\u52a8\u6001\u5730\u8ba1\u7b97\u6bcf\u4e2a\u5143\u7d20\u4e0e\u5176\u4ed6\u5143\u7d20\u4e4b\u95f4\u7684\u76f8\u5173\u6027\uff08\u5373\u201c\u6ce8\u610f\u529b\u201d\uff09\uff0c\u5e76\u6839\u636e\u8fd9\u4e9b\u76f8\u5173\u6027\u5bf9\u5e8f\u5217\u4e2d\u7684\u4fe1\u606f\u8fdb\u884c\u52a0\u6743\u6c42\u548c\u3002\u8fd9\u6837\uff0c\u6a21\u578b\u80fd\u591f\u66f4\u9ad8\u6548\u5730\u6355\u6349\u5e8f\u5217\u5185\u90e8\u7684\u957f\u8ddd\u79bb\u4f9d\u8d56\u5173\u7cfb\uff0c\u800c\u4e0d\u9700\u8981\u50cf RNN \u90a3\u6837\u9010\u4e2a\u5904\u7406\u5e8f\u5217\u5143\u7d20\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#attention_1","title":"Attention \u53d8\u79cd","text":"<ul> <li>MHA \u548c MQA \u90fd\u662f GQA \u7684\u7279\u6b8a\u8868\u8fbe\u5f62\u5f0f   \u4e09\u8005\u53ef\u4ee5\u7528\u540c\u4e00\u5957\u4ee3\u7801\uff0c\u53ea\u9700\u8981\u4fee\u6539 GQA \u4ee3\u7801\u91cc\u9762\u7684 nums_key_value_head \u53c2\u6570\u5c31\u53ef   nums_key_value_head \u8bbe\u7f6e\u7b49\u4e8e 1 \u5c31\u662f MQA   nums_key_value_head \u8bbe\u7f6e\u7b49\u4e8e nums_head \u5c31\u662f MHA</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#multi-head-attention","title":"Multi-Head Attention","text":"<p>\u6bcf\u4e2a Query \u5934\u90fd\u6709\u72ec\u7acb\u7684 Key \u548c Value\u3002\u5b9e\u9645\u4e0a\u4e5f\u989d\u5916\u589e\u52a0\u4e86\u5e76\u884c\u80fd\u529b\uff0c\u540e\u7eed\u7684 Tensor Parallelism \u4e3b\u8981\u57fa\u4e8e\u8fd9\u4e2a\u7279\u70b9\u8fdb\u884c\u901a\u4fe1\u91cf\u7684\u51cf\u5c11</p> <p>\u73b0\u5728 block-diffusion llm \u56e0\u4e3a\u65e0\u6cd5\u5728 block \u5185\u4f7f\u7528 KV Cache\uff0cGQA \u5931\u53bb\u4e86\u5b83\u7684\u4f18\u52bf\uff0c\u6240\u4ee5\u5e38\u7528 MHA</p> <p>![NOTE] \u4f18\u52bf\uff1a \u5141\u8bb8\u4e0d\u540c\u7684 Query \u5934\u5173\u6ce8\u4e0d\u540c\u7684 Key-Value \u4fe1\u606f\uff0c\u63d0\u9ad8\u6a21\u578b\u7684\u8868\u8fbe\u80fd\u529b\u3002 \u66f4\u9002\u5408\u590d\u6742\u4efb\u52a1\uff0c\u5982\u957f\u5e8f\u5217\u5efa\u6a21\u548c\u590d\u6742\u63a8\u7406\u4efb\u52a1\u3002 \u52a3\u52bf\uff1a KV \u5934\u5f88\u591a\uff0c\u5bfc\u81f4 KV \u7f13\u5b58\uff08KV Cache\uff09\u975e\u5e38\u5927\uff0c\u5360\u7528\u5927\u91cf\u663e\u5b58\u548c\u5185\u5b58\u5e26\u5bbd\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#multi-query-attention","title":"Multi-Query Attention","text":"<p>\u6240\u6709 Query \u5934\u5171\u4eab\u76f8\u540c\u7684 Key \u548c Value\u3002\u7cbe\u5ea6\u635f\u5931\u6bd4\u8f83\u5927\uff0c\u57fa\u672c\u73b0\u5728\u4e3b\u6d41\u4f7f\u7528 GQA</p> <p>![NOTE] \u4f18\u52bf\uff1a \u63a8\u7406\u901f\u5ea6\u5feb\uff0c\u56e0\u4e3a\u53ea\u9700\u8981\u5b58\u50a8\u548c\u8bfb\u53d6\u4e00\u4e2a Key-Value \u7ec4\uff0c\u800c\u4e0d\u662f\u591a\u4e2a\u3002 \u663e\u5b58\u5360\u7528\u4f4e\uff0c\u9002\u7528\u4e8e \u5927\u89c4\u6a21\u8bed\u8a00\u6a21\u578b\u63a8\u7406\uff08\u5982 ChatGPT\uff09\u3002 \u52a3\u52bf\uff1a \u4e0d\u540c Query \u5934\u4f1a\u5173\u6ce8\u76f8\u540c\u7684\u4fe1\u606f\uff0c\u5bfc\u81f4\u6a21\u578b\u8868\u8fbe\u80fd\u529b\u4e0b\u964d\uff0c\u5c24\u5176\u662f\u5728\u957f\u5e8f\u5217\u5efa\u6a21\u4efb\u52a1\u4e0a\uff08\u5982\u673a\u5668\u7ffb\u8bd1\u3001\u6458\u8981\u751f\u6210\uff09\u3002 \u53ef\u80fd\u5bfc\u81f4\u8bad\u7ec3\u4e0d\u7a33\u5b9a\uff0c\u7279\u522b\u662f\u957f\u5e8f\u5217\u8f93\u5165\u65f6\uff0c\u8bad\u7ec3\u5bb9\u6613\u51fa\u73b0 Loss spikes\uff08\u635f\u5931\u503c\u5267\u70c8\u6ce2\u52a8\uff09\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#group-query-attention","title":"Group-Query Attention","text":"<p>GQA \u5c06 Key \u548c Value \u6309\u7ec4\u5206\u914d\uff0c\u6bcf\u4e2a\u7ec4\u5171\u4eab Key \u548c Value\uff0c\u800c Query \u4ecd\u7136\u662f\u72ec\u7acb\u7684\u3002</p> <p>![NOTE] \u9ad8\u6548\u6027\uff1a\u76f8\u6bd4 MHA\uff0cGQA \u51cf\u5c11\u4e86 Key \u548c Value \u7684\u5b58\u50a8\u9700\u6c42\uff0c\u63a8\u7406\u901f\u5ea6\u66f4\u5feb\u3002 \u9ad8\u8d28\u91cf\uff1a\u76f8\u6bd4 MQA\uff0cGQA \u7684 BLEU \u5f97\u5206\u63a5\u8fd1 MHA\uff0c\u51cf\u5c11\u4e86\u4fe1\u606f\u5197\u4f59\u3002 \u7075\u6d3b\u6027\uff1a\u901a\u8fc7\u8c03\u6574\u7ec4\u7684\u6570\u91cf\uff08num_groups\uff09\uff0c\u53ef\u4ee5\u5728\u8d28\u91cf\u548c\u901f\u5ea6\u4e4b\u95f4\u8fdb\u884c\u6743\u8861</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#transformers-decode-only","title":"Transformers \u7ed3\u6784(decode only)","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#_3","title":"\u6d41\u7a0b","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#input-processing","title":"\u8f93\u5165\u9636\u6bb5 (Input Processing)","text":"<p>Tokenization (\u5206\u8bcd)\u5c06\u81ea\u7136\u8bed\u8a00\u6587\u672c\u8f6c\u6362\u4e3a\u6574\u6570\u7d22\u5f15\uff08Token IDs\uff09\u3002 - Input: \"Hello world\" (String) - Output: [15496, 995] (List of Ints) - Tensor Shape: \\((B, T)\\) \u8fd9\u91cc\u5b58\u50a8\u7684\u662f\u6574\u6570\u7d22\u5f15 (Index)\u3002</p> <p>Embedding (\u5d4c\u5165\u5c42)\u5c06\u6574\u6570\u7d22\u5f15\u8f6c\u6362\u4e3a\u7a20\u5bc6\u5411\u91cf\u3002 - \u64cd\u4f5c: \u67e5\u8868 (Lookup Table)\u3002\u6a21\u578b\u6301\u6709\u4e00\u4e2a \\((V, D)\\) \u7684\u5927\u77e9\u9635\u3002 - \u8fc7\u7a0b: \u6839\u636e input \u7684 ID\uff0c\u4ece\u5927\u77e9\u9635\u4e2d\u628a\u5bf9\u5e94\u7684\u884c\u53d6\u51fa\u6765\u3002 - Tensor Shape:\\(\\((B, T) \\xrightarrow{\\text{Lookup}} (B, T, D)\\)\\) - \u6ce8\u610f: \u6b64\u65f6\u901a\u5e38\u4f1a\u52a0\u4e0a Positional Encodings (\u4f4d\u7f6e\u7f16\u7801)\u3002   - \u5982\u679c\u662f\u7edd\u5bf9\u4f4d\u7f6e\u7f16\u7801\uff08\u5982 GPT-2\uff09\uff0c\u76f4\u63a5\u52a0\uff1a\\(X = X + P\\)\u3002   - \u5982\u679c\u662f RoPE (\u65cb\u8f6c\u4f4d\u7f6e\u7f16\u7801\uff0cLLaMA)\uff0c\u8fd9\u4e00\u6b65\u4e0d\u52a0\uff0c\u800c\u662f\u63a8\u8fdf\u5230 Attention \u5c42\u7684 Q, K \u8ba1\u7b97\u65f6\u518d\u505a\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#transformer-block-n","title":"Transformer Block (\u6838\u5fc3\u5faa\u73af N \u5c42)","text":"<p>\u8f93\u5165\u8fdb\u5165 N \u4e2a\u5806\u53e0\u7684 Block\uff0c\u6bcf\u4e2a Block \u8f93\u5165\u548c\u8f93\u51fa\u7ef4\u5ea6\u4fdd\u6301\u4e0d\u53d8\u3002 \u8f93\u5165 \\(X\\) \u7ef4\u5ea6\uff1a\\((B, T, D)\\)</p> <p>LayerNorm / RMSNorm (\u5f52\u4e00\u5316) - \u64cd\u4f5c: \u5bf9\u6700\u540e\u4e00\u4e2a\u7ef4\u5ea6 \\(D\\) \u8fdb\u884c\u5f52\u4e00\u5316\u3002 - Shape: \\((B, T, D) \\rightarrow (B, T, D)\\) (\u5f62\u72b6\u4e0d\u53d8)</p> <p>Masked Self-Attention (\u6ce8\u610f\u529b\u673a\u5236)\u8fd9\u662f\u7ef4\u5ea6\u53d8\u5316\u6700\u590d\u6742\u7684\u90e8\u5206\u3002</p> <ol> <li>Q, K, V \u6295\u5f71 (Linear Projection):    - \u8f93\u5165 \\(X\\) \u4e58\u4ee5\u4e09\u4e2a\u77e9\u9635 \\(W_Q, W_K, W_V\\) (\u5f62\u72b6\u5747\u4e3a \\(D \\times D\\))\u3002    - Shape: \\((B, T, D)\\)    - \u6ce8\uff1a\u5982\u679c\u662f LLaMA\uff0c\u5728\u8fd9\u91cc\u5bf9 Q \u548c K \u5e94\u7528 RoPE \u65cb\u8f6c\u3002</li> <li>\u5206\u5934 (Split Heads):<ul> <li>\u5c06 \\(D\\) \u62c6\u5206\u4e3a \\(H \\times D_h\\) (\\(D_h = D/H\\))\u3002</li> <li>Reshape: \\((B, T, H, D_h)\\)</li> <li>Transpose (\u8f6c\u7f6e): \u4e3a\u4e86\u8ba9 \\(T\\) \u7ef4\u5ea6\u53c2\u4e0e\u77e9\u9635\u4e58\u6cd5\uff0c\u4ea4\u6362\u7ef4\u5ea6\u3002</li> <li>Shape: \\((B, H, T, D_h)\\)</li> </ul> </li> <li>Attention Score (QK\u1d40):    - \\(Q\\) \u4e58\u4ee5 \\(K\\) \u7684\u8f6c\u7f6e\u3002    - \u8ba1\u7b97\uff1a\\((B, H, T, D_h) \\times (B, H, D_h, T)\\)    - Shape: \\((B, H, T, T)\\)    - \u5f97\u5230\u4e00\u4e2a \\(T \\times T\\) \u7684\u65b9\u9635\uff0c\u8868\u793a token \u4e4b\u95f4\u7684\u76f8\u5173\u6027\u3002</li> <li>Causal Masking (\u56e0\u679c\u906e\u853d):<ul> <li>\u5c06 \\(T \\times T\\) \u77e9\u9635\u7684\u4e0a\u4e09\u89d2\u90e8\u5206\u8bbe\u4e3a \\(-\\infty\\)\u3002</li> <li>Shape: \\((B, H, T, T)\\) (\u5f62\u72b6\u4e0d\u53d8)</li> </ul> </li> <li>Softmax:\u5f52\u4e00\u5316\u5f97\u5230\u6982\u7387\u3002    - Shape: \\((B, H, T, T)\\)</li> <li>Weighted Sum (Score @ V):    - Attention \u77e9\u9635\u4e58\u4ee5 \\(V\\)\u3002    - \u8ba1\u7b97\uff1a\\((B, H, T, T) \\times (B, H, T, D_h)\\)    - Shape: \\((B, H, T, D_h)\\)</li> <li>Output Projection (\u5408\u5e76\u5934):    - Transpose \u56de\u53bb\uff1a\\((B, T, H, D_h)\\)    - Reshape \u5408\u5e76\uff1a\\((B, T, D)\\)    - \u6700\u540e\u7ecf\u8fc7\u4e00\u4e2a\u7ebf\u6027\u5c42 \\(W_O\\)\u3002    - Output Shape: \\((B, T, D)\\)</li> <li>Residual Connection (\u6b8b\u5dee\u8fde\u63a5):    - \\(X_{new} = X_{input} + Attention(Norm(X_{input}))\\)    - Shape: \\((B, T, D)\\)</li> </ol>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#feed-forward-network-mlp-ffn","title":"Feed Forward Network (MLP / FFN)","text":"<p>Attention \u8d1f\u8d23\u63d0\u53d6\u201c\u76f8\u5173\u6027\u201d\uff0cFFN \u8d1f\u8d23\u201c\u77e5\u8bc6\u5904\u7406\u201d\u3002 - Norm: \\((B, T, D)\\) - Up Projection (\u5347\u7ef4):   - \\(X \\times W_{up}\\)\u3002\u7ef4\u5ea6\u901a\u5e38\u653e\u5927 4 \u500d\uff08\u6216\u8005 LLaMA \u7684 SwiGLU \u7ed3\u6784\uff09\u3002   - Shape: \\((B, T, D) \\rightarrow (B, T, D_{ff})\\) - Activation: (ReLU / GELU / SiLU)\uff0c\u5f62\u72b6\u4e0d\u53d8\u3002 - Down Projection (\u964d\u7ef4):   - \\(X \\times W_{down}\\)\u3002   - Shape: \\((B, T, D_{ff}) \\rightarrow (B, T, D)\\) - Residual Connection:   - \\(X_{out} = X_{new} + FFN(Norm(X_{new}))\\)   - Shape: \\((B, T, D)\\)</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#output-head","title":"\u8f93\u51fa\u9636\u6bb5 (Output Head)","text":"<p>\u7ecf\u8fc7 \\(N\\) \u5c42 Block \u540e\uff0c\u6570\u636e\u6765\u5230\u4e86\u6700\u540e\u4e00\u5c42\u3002</p> <ul> <li>Final Norm</li> <li>\u6700\u540e\u518d\u505a\u4e00\u6b21 RMSNorm/LayerNorm\u3002</li> <li>Shape: \\((B, T, D)\\)</li> <li>LM Head (Linear Un-embedding)\u8fd9\u662f\u628a\u9690\u85cf\u5411\u91cf\u6620\u5c04\u56de\u201c\u8bcd\u8868\u6982\u7387\u201d\u7684\u5173\u952e\u4e00\u6b65\u3002</li> <li>\u64cd\u4f5c: \u4e58\u4ee5\u77e9\u9635 \\((D, V)\\)\u3002\u8fd9\u4e2a\u77e9\u9635\u6709\u65f6\u4e0e Input Embedding \u77e9\u9635\u5171\u4eab\u53c2\u6570\uff08Weight Tying\uff09\u3002</li> <li>\u8ba1\u7b97: \\((B, T, D) \\times (D, V)\\)</li> <li>Output (Logits): \\((B, T, V)\\)</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#logits","title":"Logits \u7684\u4f7f\u7528","text":"<p>Logits \u662f\u6a21\u578b\u6700\u540e\u4e00\u5c42\u8f93\u51fa\u7684\u539f\u59cb\u6253\u5206\uff08Raw Scores\uff09\uff0c\u8fd8\u6ca1\u6709\u88ab\u8f6c\u6362\u6210\u6982\u7387\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#forward-pass","title":"\u524d\u5411\u4f20\u64ad (Forward Pass)","text":"<p>\u8f93\u5165\u7ecf\u8fc7 Embedding \u548c N \u5c42 Transformer Block \u540e\uff0c\u5f97\u5230\u6700\u540e\u4e00\u4e2a Token \u7684\u9690\u85cf\u72b6\u6001\u5411\u91cf\uff08\u5047\u8bbe\u7ef4\u5ea6 \\(D=4096\\)\uff09\u3002 \u7136\u540e\uff0c\u7ecf\u8fc7\u8f93\u51fa\u5c42 (LM Head)\uff0c\u8fd9\u662f\u4e00\u4e2a\u7ebf\u6027\u53d8\u6362\uff08\u77e9\u9635\u4e58\u6cd5\uff09\uff1a \\(\\(\\text{Hidden\\_State} (1, 4096) \\times W_{head} (4096, 5) \\rightarrow \\text{Logits} (1, 5)\\)\\)</p> <p>Logits \u662f  \u4e00\u5806\u6ca1\u6709\u4efb\u4f55\u8303\u56f4\u9650\u5236\u7684\u6d6e\u70b9\u6570\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#logits-post-processing","title":"Logits \u7684\u5904\u7406 (Post-processing)\u8fd9","text":"<p>\u5728\u628a Logits \u53d8\u6210\u6982\u7387\u4e4b\u524d\uff0c\u6211\u4eec\u901a\u5e38\u4f1a\u4fee\u6539 Logits \u7684\u503c\u3002 - Temperature (\u6e29\u5ea6) \\(T\\)\uff1a \\(\\(\\text{New\\_Logits} = \\frac{\\text{Logits}}{T}\\)\\)   - \\(T &lt; 1\\) (\u5982 0.1)\uff1a \u5dee\u8ddd\u62c9\u5927\u3002\u5927\u7684\u66f4\u5927\uff0c\u5c0f\u7684\u66f4\u5c0f\u3002\u6a21\u578b\u53d8\u5f97\u4fdd\u5b88\u3001\u786e\u5b9a\u3002\u6bd4\u5982 12.5 / 0.1 = 125\u3002   - \\(T &gt; 1\\) (\u5982 1.5)\uff1a \u5dee\u8ddd\u7f29\u5c0f\u3002\u5206\u6570\u9ad8\u7684\u548c\u5206\u6570\u4f4e\u7684\u53d8\u63a5\u8fd1\u4e86\u3002\u6a21\u578b\u53d8\u5f97\u53d1\u6563\u3001\u6709\u521b\u9020\u529b\u3002\u6bd4\u5982 12.5 / 1.5  - Penalty (\u60e9\u7f5a)\uff1a\u5982\u679c\u4f60\u8bbe\u7f6e\u4e86\u201c\u91cd\u590d\u60e9\u7f5a\u201d\uff0c\u6a21\u578b\u4f1a\u68c0\u67e5\u521a\u624d\u751f\u6210\u7684\u8bcd\uff0c\u628a\u5b83\u4eec\u5bf9\u5e94\u7684 Logits \u5f3a\u884c\u51cf\u53bb\u4e00\u4e2a\u503c\uff08\u6bd4\u5982\u51cf 2.0\uff09\uff0c\u8ba9\u5b83\u4eec\u4e0d\u5bb9\u6613\u518d\u88ab\u9009\u4e2d\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#softmax","title":"Softmax (\u5f52\u4e00\u5316)","text":"<p>\u6211\u4eec\u9700\u8981\u628a Logits \u53d8\u6210 \u6982\u7387 (Probability)\u3002\u4f7f\u7528 Softmax  \\(\\(P_i = \\frac{e^{logit_i}}{\\sum_{j} e^{logit_j}}\\)\\)</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#sampling","title":"\u91c7\u6837 (Sampling)","text":"<p>\u6709\u4e86\u6982\u7387 [0, 0.98, 0.019, 0, 0]\uff0c\u6a21\u578b\u5230\u5e95\u9009\u54ea\u4e2a\uff1f \u8fd9\u53d6\u51b3\u4e8e\u91c7\u6837\u7b56\u7565\uff1a - Greedy Search (\u8d2a\u5a6a\u641c\u7d22):\u6c38\u8fdc\u53ea\u9009\u6982\u7387\u6700\u5927\u7684\u90a3\u4e2a\u3002   - \u7279\u70b9\uff1a\u6700\u7a33\u5b9a\uff0c\u4f46\u5bb9\u6613\u8f66\u8f71\u8f98\u8bdd\uff0c\u7f3a\u4e4f\u521b\u9020\u529b\u3002 - Random Sampling (\u968f\u673a\u91c7\u6837):\u6839\u636e\u6982\u7387\u63b7\u9ab0\u5b50\u3002   - \u6709 98% \u7684\u51e0\u7387\u9009 \"blue\"\uff0c\u4f46\u4e5f\u6709 1.9% \u7684\u51e0\u7387\u9009 \"green\"\uff08\u6bd4\u5982\u7279\u610f\u60f3\u8bf4\u201c\u7eff\u8272\u7684\u5929\u7a7a\u201d\uff09\u3002   - Top-K / Top-P: \u4e3a\u4e86\u9632\u6b62\u9009\u5230\u592a\u79bb\u8c31\u7684\u8bcd\uff08\u6bd4\u5982 \"apple\"\uff09\uff0c\u6211\u4eec\u4f1a\u5148\u622a\u65ad\uff0c\u53ea\u5728\u6982\u7387\u6700\u9ad8\u7684\u51e0\u4e2a\u8bcd\uff08K\uff09\u6216\u7d2f\u79ef\u6982\u7387\u8fbe\u5230 P \u7684\u8bcd\u91cc\u62bd\u7b7e\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#transformer-layer-norm","title":"\u4e3a\u4ec0\u4e48\u7528 Transformer \u4e2d\u7528 layer norm","text":"\u7279\u6027 Batch Norm Layer Norm RMSNorm \u6807\u51c6\u5316\u7ef4\u5ea6 \u5c0f\u6279\u91cf\u5185\u5404\u7279\u5f81\u7ef4\u5ea6 \u6bcf\u4e2a\u6837\u672c\u7684\u6240\u6709\u7279\u5f81\u7ef4\u5ea6 \u6bcf\u4e2a\u6837\u672c\u7684\u7279\u5f81\u7ef4\u5ea6\u7684\u5747\u65b9\u6839 \u8ba1\u7b97\u5f00\u9500 \u4e2d\u7b49 \u8f83\u5927 \u8f83\u5c0f \u5bf9\u5c0f\u6279\u91cf\u5927\u5c0f\u4f9d\u8d56 \u4f9d\u8d56 \u4e0d\u4f9d\u8d56 \u4e0d\u4f9d\u8d56 \u5e94\u7528\u573a\u666f CNN\u3001MLP RNN\u3001Transformer \u5404\u7c7b\u795e\u7ecf\u7f51\u7edc\uff0c\u5c24\u5176\u5728\u8ba1\u7b97\u6548\u7387\u548c\u7a33\u5b9a\u6027\u8981\u6c42\u9ad8\u7684\u4efb\u52a1\u4e2d \u6b63\u5219\u5316\u6548\u679c \u6709\u4e00\u5b9a\u6b63\u5219\u5316\u6548\u679c \u65e0\u663e\u8457\u6b63\u5219\u5316\u6548\u679c \u65e0\u663e\u8457\u6b63\u5219\u5316\u6548\u679c <ol> <li>\u5217\u957f\u5ea6\u7684\u7075\u6d3b\u6027\uff1a    Transformer \u5904\u7406\u7684\u662f\u5e8f\u5217\u6570\u636e\uff0c\u5e8f\u5217\u957f\u5ea6\u53ef\u80fd\u56e0\u8f93\u5165\u6837\u672c\u800c\u5f02\u3002LayerNorm \u5bf9\u6bcf\u4e2a\u6837\u672c\u81ea\u8eab\u7684\u4e00\u5c42\u795e\u7ecf\u5143\u7684\u8f93\u5165\u8fdb\u884c\u5f52\u4e00\u5316\uff0c\u4e0e\u5176\u4ed6\u6837\u672c\u7684\u5e8f\u5217\u957f\u5ea6\u65e0\u5173\uff0c\u80fd\u591f\u5f88\u597d\u5730\u5904\u7406\u4e0d\u540c\u957f\u5ea6\u7684\u8f93\u5165\u5e8f\u5217\u3002\u800c batch norm \u5bf9\u957f\u5ea6\u5927\u5c0f\u4e0d\u540c\u7684 NLP \u4efb\u52a1\u8ba1\u7b97\u7684\u8d85\u53c2\u6570\u6cdb\u5316\u80fd\u529b\u5dee\u3002</li> <li>\u5e76\u884c\u8ba1\u7b97\u7684\u9002\u5e94\u6027\uff1a    Transformer \u7684\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u9ad8\u5ea6\u5e76\u884c\u5316\uff0cLayerNorm \u53ea\u9700\u8981\u5bf9\u5355\u4e2a\u6837\u672c\u7684\u4e00\u5c42\u8fdb\u884c\u8ba1\u7b97\uff0c\u4e0d\u9700\u8981\u7b49\u5f85\u5176\u4ed6\u6837\u672c\u7684\u4fe1\u606f\uff0c\u56e0\u6b64\u66f4\u9002\u5408\u5e76\u884c\u8ba1\u7b97\u73af\u5883\u3002</li> <li>\u6a21\u578b\u7684\u7a33\u5b9a\u6027\uff1a    LayerNorm \u57fa\u4e8e\u6bcf\u4e00\u5c42\u81ea\u8eab\u7684\u8f93\u5165\u8fdb\u884c\u5f52\u4e00\u5316\uff0c\u80fd\u591f\u66f4\u597d\u5730\u63a7\u5236\u6bcf\u4e00\u5c42\u8f93\u5165\u7684\u8303\u56f4\u548c\u5206\u5e03\uff0c\u907f\u514d\u68af\u5ea6\u6d88\u5931\u6216\u68af\u5ea6\u7206\u70b8\u95ee\u9898\u3002</li> </ol>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#post-norm-pre-norm","title":"post-norm \u4e0e pre-norm","text":"<ul> <li>\u539f\u59cb\u7684 transformer \u4e2d\u4f7f\u7528\u7684\u662f post-norm\uff0c\u800c llm \u4e2d\u5927\u591a\u4f7f\u7528 pre-norm</li> </ul> norm \u4f4d\u7f6e \u4f18\u70b9 \u7f3a\u70b9 pre-norm \u8bad\u7ec3\u7a33\u5b9a\uff1a\u5728\u6b8b\u5dee\u8fde\u63a5\u4e4b\u524d\u8fdb\u884c\u5f52\u4e00\u5316\uff0c\u53ef\u4ee5\u6709\u6548\u7f13\u89e3\u68af\u5ea6\u6d88\u5931\u6216\u7206\u70b8\u7684\u95ee\u9898\uff0c\u4f7f\u6df1\u5c42\u7f51\u7edc\u7684\u8bad\u7ec3\u66f4\u52a0\u7a33\u5b9a\u3002 \u6536\u655b\u901f\u5ea6\u5feb\uff1a\u68af\u5ea6\u80fd\u591f\u66f4\u76f4\u63a5\u5730\u4f20\u9012\u5230\u524d\u9762\u7684\u5c42\uff0c\u4ece\u800c\u52a0\u5feb\u6a21\u578b\u7684\u6574\u4f53\u6536\u655b\u901f\u5ea6\u3002\u51cf\u5c11\u8c03\u53c2\u5de5\u4f5c\uff1a\u4e0d\u9700\u8981\u50cf Post-Norm \u90a3\u6837\u4f9d\u8d56\u590d\u6742\u7684\u5b66\u4e60\u7387\u9884\u70ed\u7b49\u4f18\u5316\u6280\u5de7 \u6f5c\u5728\u7684\u8868\u793a\u584c\u9677\u95ee\u9898\uff1a\u9760\u8fd1\u8f93\u51fa\u4f4d\u7f6e\u7684\u5c42\u53ef\u80fd\u4f1a\u53d8\u5f97\u975e\u5e38\u76f8\u4f3c\uff0c\u4ece\u800c\u5bf9\u6a21\u578b\u7684\u8d21\u732e\u53d8\u5c0f\uff0c\u9650\u5236\u4e86\u6a21\u578b\u7684\u4e0a\u9650\u3002\u53ef\u80fd\u524a\u5f31\u5c42\u7684\u8d21\u732e\uff1a\u7531\u4e8e\u5148\u8fdb\u884c\u4e86\u5f52\u4e00\u5316\uff0c\u53ef\u80fd\u4f1a\u51cf\u5f31\u6bcf\u4e00\u5c42\u7684\u5b9e\u9645\u8d21\u732e\uff0c\u5bfc\u81f4\u6a21\u578b\u7684\u6709\u6548\u6df1\u5ea6\u53d8\u6d45 post-norm \u4fdd\u7559\u8f93\u5165\u7279\u5f81\uff1a\u66f4\u63a5\u8fd1\u539f\u59cb\u8f93\u5165\u7684\u7279\u5f81\uff0c\u6709\u52a9\u4e8e\u4fe1\u606f\u7684\u4f20\u9012\u3002 \u6f5c\u5728\u6027\u80fd\u4f18\u52bf\uff1a\u867d\u7136\u8bad\u7ec3\u4e0d\u7a33\u5b9a\uff0c\u4f46\u6709\u7814\u7a76\u6697\u793a\u5176\u5728\u6548\u679c\u4e0a\u53ef\u80fd\u6709\u66f4\u5927\u7684\u6f5c\u529b \u8bad\u7ec3\u4e0d\u7a33\u5b9a\uff1a\u5728\u6df1\u5c42\u6a21\u578b\u4e2d\uff0c\u68af\u5ea6\u5bb9\u6613\u7206\u70b8\u6216\u6d88\u5931\uff0c\u5bf9\u5b66\u4e60\u7387\u548c\u6743\u91cd\u521d\u59cb\u5316\u975e\u5e38\u654f\u611f\uff0c\u6536\u655b\u56f0\u96be\u3002\u4f9d\u8d56\u4f18\u5316\u6280\u5de7\uff1a\u9700\u8981\u4f7f\u7528\u5b66\u4e60\u7387\u9884\u70ed\u7b49\u590d\u6742\u7684\u4f18\u5316\u65b9\u6cd5\u6765\u7a33\u5b9a\u8bad\u7ec3","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#gptllama-embedding-dim-llm-model-dim","title":"\u4e3a\u4ec0\u4e48\u73b0\u4ee3\u5927\u6a21\u578b\uff08GPT/LLaMA\uff09\u7684 embedding dim \u548c llm model dim \u4e00\u81f4\uff1f","text":"<p>\u5982\u679c \\(D_{emb} \\neq D_{model}\\)\uff0c\u6a21\u578b\u5fc5\u987b\u5728\u7b2c\u4e00\u5c42\u52a0\u4e00\u4e2a\u7ebf\u6027\u6295\u5f71\u5c42\uff08Projection Layer\uff09\uff0c\u628a\u7ef4\u5ea6\u4ece \\(D_{emb}\\) \u5f3a\u884c\u6620\u5c04\u5230 \\(D_{model}\\)\uff0c\u4e4b\u540e\u6240\u6709\u7684\u6b8b\u5dee\u8fde\u63a5\u624d\u80fd\u5728 \\(D_{model}\\) \u7ef4\u5ea6\u4e0a\u8fdb\u884c</p> <p>Add &amp; Norm \u64cd\u4f5c\u8981\u6c42\u8f93\u5165\u8f93\u51fa\u7ef4\u5ea6\u4e00\u81f4\uff0c\u5426\u5219\u65e0\u6cd5\u76f8\u52a0</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#embedding","title":"\u4e3a\u4ec0\u4e48\u4e0d\u6545\u610f\u628a Embedding \u505a\u5c0f\u4e00\u70b9\uff1f\uff08\u4e3a\u4e86\u7701\u663e\u5b58\uff1f\uff09","text":"<p>ALBERT \u7684\u505a\u6cd5\uff1a \u5047\u8bbe \\(D_{model}=768\\)\uff0c\u4f46 \\(D_{emb}=128\\)\u3002\u5b83\u8ba4\u4e3a\u8bcd\u5411\u91cf\u4e3b\u8981\u5b66\u7684\u662f\u201c\u4e0a\u4e0b\u6587\u65e0\u5173\u201d\u7684\u6d45\u5c42\u8bed\u4e49\uff0c\u4e0d\u9700\u8981\u90a3\u4e48\u5927\u7ef4\u5ea6\u3002</p> <p>\u7ed3\u679c\uff1a \u867d\u7136\u53c2\u6570\u91cf\u5de8\u5e45\u4e0b\u964d\uff08Embedding \u5c42\u53c2\u6570\u53d8\u5c11\uff09\uff0c\u4f46\u8ba1\u7b97\u91cf\u5e76\u6ca1\u6709\u51cf\u5c11\uff08\u6a21\u578b\u5185\u90e8\u8fd8\u662f\u8981\u7b97 768 \u7ef4\uff09\uff0c\u800c\u4e14\u6027\u80fd\u4e0b\u964d\u4e86\u3002</p> <p>\u73b0\u4ee3\u5927\u6a21\u578b\u7684\u5171\u8bc6\uff1a Embedding \u5c42\u4e0d\u4ec5\u5b58\u50a8\u8bcd\u4e49\uff0c\u8fd8\u627f\u8f7d\u4e86\u6a21\u578b\u7684\u7b2c\u4e00\u6ce2\u201c\u77e5\u8bc6\u201d\u3002\u5c06\u5b83\u538b\u7f29\u4f1a\u9020\u6210\u4fe1\u606f\u74f6\u9888\uff08Information Bottleneck\uff09\uff0c\u5bfc\u81f4\u8f93\u5165\u6a21\u578b\u7684\u4fe1\u606f\u201c\u5148\u5929\u4e0d\u8db3\u201d\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#embedding_1","title":"\u4e3a\u4ec0\u4e48\u4e0d\u628a Embedding \u505a\u5927\u4e00\u70b9\uff1f\uff08\u4e3a\u4e86\u66f4\u5f3a\u8868\u8fbe\uff1f\uff09","text":"<p>\u6709\u4e9b\u7814\u7a76\uff08\u5982 Google \u7684 T5 \u6216\u65e9\u671f\u7684 Transformer\uff09\u5c1d\u8bd5\u8fc7\u8ba9 \\(D_{emb} &gt; D_{model}\\) \u6216\u76f8\u53cd\uff0c\u4f46\u8fd9\u5c31\u5f15\u5165\u4e86\u989d\u5916\u7684\u6295\u5f71\u77e9\u9635 \\(W_{proj}\\)\u3002</p> <p>\u5728\u5927\u6a21\u578b\u65f6\u4ee3\uff08Scaling Law \u65f6\u4ee3\uff09\uff0c\u5927\u5bb6\u53d1\u73b0 \u201c\u67b6\u6784\u8d8a\u7b80\u5355\u8d8a\u597d\u201d\u3002\u589e\u52a0\u6295\u5f71\u5c42\u4e0d\u4ec5\u589e\u52a0\u4e86\u4ee3\u7801\u5b9e\u73b0\u7684\u590d\u6742\u5ea6\uff0c\u8fd8\u589e\u52a0\u4e86\u989d\u5916\u7684\u8ba1\u7b97\u5f00\u9500\uff08\u867d\u7136\u4e0d\u5927\uff09\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/attention%26transformer/#_4","title":"\u603b\u7ed3","text":"<p>\u4e00\u81f4\u6027\u7684\u597d\u5904\uff1a - \u65e0\u7f1d\u6b8b\u5dee\uff1a \u6bcf\u4e00\u5c42\u7684\u8f93\u5165\u8f93\u51fa\u7ef4\u5ea6\u7531\u59cb\u81f3\u7ec8\u4fdd\u6301\u4e0d\u53d8\uff0c\u4e0d\u9700\u8981 resize\u3002 - \u907f\u514d\u74f6\u9888\uff1a \u4fdd\u8bc1\u8f93\u5165\u7684\u539f\u59cb\u4fe1\u606f\u91cf\u8db3\u4ee5\u652f\u6491\u540e\u7eed 32+ \u5c42\u7f51\u7edc\u7684\u6df1\u5c42\u5904\u7406\u3002 - \u5de5\u7a0b\u53cb\u597d\uff1a \u5728\u5206\u5e03\u5f0f\u8bad\u7ec3\uff08TP/PP\uff09\u548c\u63a8\u7406\u4f18\u5316\uff08KV Cache\uff09\u4e2d\uff0c\u7edf\u4e00\u7684\u7ef4\u5ea6\u8ba9\u5185\u5b58\u7ba1\u7406\u66f4\u5bb9\u6613\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/","title":"Parallelization Concepts","text":"2025-09-182025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#parallelization-concepts","title":"Parallelization Concepts","text":"<p> \u7ea6 5158 \u4e2a\u5b57  54 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 26 \u5206\u949f</p> <p>\u672c\u8282\u4e3b\u8981\u4ecb\u7ecd\u5927\u6a21\u578b\u8bad\u7ec3\u4e2d\u7684\u5e76\u884c\u5316\u6280\u672f\uff0c\u6db5\u76d6\u6570\u636e\u5e76\u884c\u3001\u6a21\u578b\u5e76\u884c\u3001\u6d41\u6c34\u7ebf\u5e76\u884c\u548c\u5f20\u91cf\u5e76\u884c\u7b49\u65b9\u6cd5\u3002\u6211\u4eec\u5c06\u4ece Transformer \u7684\u53c2\u6570\u91cf\u3001Flops \u4ee5\u53ca\u8bad\u7ec3\u5360\u7528\u663e\u5b58\u5165\u624b\uff0c\u5206\u6790\u4e3a\u4ec0\u4e48\u9700\u8981\u5e76\u884c\u5316\u6280\u672f\uff0c\u5e76\u4ecb\u7ecd\u8fd9\u4e9b\u6280\u672f\u7684\u57fa\u672c\u539f\u7406\u3002</p> <p>\u4e3b\u8981\u53c2\u8003 CSE 234 \u5927\u7eb2[^cse234]\u8fdb\u884c\u8bb2\u89e3</p> <p>\u4e0b\u4e00\u7bc7\u6587\u7ae0\u6211\u4eec\u5c06\u4ee5 Transformer-based LLM \u4e3a\u4f8b\uff0c\u5bf9\u91cc\u9762 Attention \u4ee5\u53ca FFN or MoE \u91c7\u7528\u7684\u5e76\u884c\u5316\u624b\u6bb5\u8fdb\u884c\u5206\u6790\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#transformer-params","title":"Transformer \u6a21\u578b\u7684\u53c2\u6570\u91cf\u3001\u8ba1\u7b97\u91cf\u3001\u663e\u5b58\u5360\u7528[^params]","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#_1","title":"\u53c2\u6570\u91cf","text":"<ul> <li>\u6bcf\u4e2a transformer \u5c42\u7684\u53c2\u6570\u91cf\u4e3a   $$ \\text{Params per layer} = 12h^2 + 13h $$</li> <li>\u5f53\u9690\u85cf\u7ef4\u5ea6 \\(h\\) \u8f83\u5927\u65f6\uff0c\u53ef\u4ee5\u5ffd\u7565\u4e00\u6b21\u9879\uff0c\u6a21\u578b\u53c2\u6570\u91cf\u8fd1\u4f3c\u4e3a   $$ \\text{Params per layer} \\approx 12lh^2 $$</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#flops","title":"\u8ba1\u7b97\u91cf(FLOPs)","text":"<ul> <li>l \u5c42\u7684 Transformer \u4e00\u6b21\u8bad\u7ec3\u8fed\u4ee3\u8ba1\u7b97\u91cf\uff1a</li> <li>self-attention \u4e0e seq_len \u5e73\u65b9\u6210\u6b63\u6bd4</li> <li>mlp \u4e0e hidden_size \u5e73\u65b9\u6210\u6b63\u6bd4</li> </ul> \\[ \\\\text{FLOPs per iteration} = l\\\\cdot(24hsh^2+4bs^2h)+2bshV \\] <ul> <li>\\(l\\): Transformer \u5c42\u6570</li> <li>\\(h\\): \u9690\u85cf\u5c42\u7ef4\u5ea6</li> <li>\\(s\\): \u5e8f\u5217\u957f\u5ea6</li> <li>\\(b\\): \u6279\u91cf\u5927\u5c0f</li> <li>\\(V\\): \u8bcd\u6c47\u8868\u5927\u5c0f</li> <li>\u5f53 \\(h\\) \u8f83\u5927\u4e14\\(s \\\\ll h\\)\u65f6\uff0c\u53ef\u4ee5\u5ffd\u7565\u4f4e\u9636\u9879\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd1\u4f3c\u8ba4\u4e3a\uff1a\u5728\u4e00\u6b21\u524d\u5411\u4f20\u9012\u4e2d\uff0c\u5bf9\u4e8e\u6bcf\u4e2a token\uff0c\u6bcf\u4e2a\u6a21\u578b\u53c2\u6570\uff0c\u9700\u8981\u8fdb\u884c 2 \u6b21\u6d6e\u70b9\u6570\u8fd0\u7b97\uff0c\u5373\u4e00\u6b21\u4e58\u6cd5\u6cd5\u8fd0\u7b97\u548c\u4e00\u6b21\u52a0\u6cd5\u8fd0\u7b97</li> <li>\u4e00\u6b21\u8bad\u7ec3\u8fed\u4ee3\u5305\u542b\u4e86\u524d\u5411\u4f20\u9012\u548c\u540e\u5411\u4f20\u9012\uff0c\u540e\u5411\u4f20\u9012\u7684\u8ba1\u7b97\u91cf\u662f\u524d\u5411\u4f20\u9012\u7684 2 \u500d\u3002 <p>\u4e00\u6b21\u8bad\u7ec3\u8fed\u4ee3\u4e2d\uff0c\u5bf9\u4e8e\u6bcf\u4e2a token\uff0c\u6bcf\u4e2a\u6a21\u578b\u53c2\u6570\uff0c\u9700\u8981\u8fdb\u884c 6 \u6b21\u6d6e\u70b9\u6570\u8fd0\u7b97</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#_2","title":"\u663e\u5b58\u5360\u7528","text":"<ol> <li>\u53c2\u6570\u8bad\u7ec3\u65f6\u7684\u663e\u5b58    - \u8bad\u7ec3\u65f6\u9700\u8981\u5b58\u50a8\u6a21\u578b\u53c2\u6570\u3001\u68af\u5ea6\u548c\u4f18\u5316\u5668\u72b6\u6001    - \u6bcf\u4e2a\u53ef\u8bad\u7ec3\u6a21\u578b\u53c2\u6570\u90fd\u4f1a\u5bf9\u5e94 1 \u4e2a\u68af\u5ea6\uff0c\u5e76\u5bf9\u5e94 2 \u4e2a\u4f18\u5316\u5668\u72b6\u6001\uff08Adam \u4f18\u5316\u5668\u68af\u5ea6\u7684\u4e00\u9636\u52a8\u91cf\u548c\u4e8c\u9636\u52a8\u91cf\uff09\uff0c\u4f7f\u7528\u6df7\u5408\u7cbe\u5ea6\u8bad\u7ec3      $$      \\text{Total Memory for Parameters} = 20 \\times \\text{Params num}      $$</li> <li>\u4e2d\u95f4\u6fc0\u6d3b\u503c\u7684\u663e\u5b58    - \u5bf9\u4e8e l \u5c42 transformer \u6a21\u578b\uff0c\u4e2d\u95f4\u6fc0\u6d3b\u5360\u7528\u7684\u663e\u5b58\u5927\u5c0f\u53ef\u4ee5\u8fd1\u4f3c\u4e3a<ul> <li>self-attention: \u4ecd\u7136\u4e0e seq_len \u5e73\u65b9\u6210\u6b63\u6bd4    $$    \\text{Activation Memory} = (34bsh+5hs^2a)\\cdot l    $$</li> </ul> </li> </ol> <ul> <li>\u901a\u5e38\u4f1a\u5c1d\u8bd5\u51cf\u5c0f\u6279\u6b21\u5927\u5c0f\u6765\u907f\u514d\u663e\u5b58\u4e0d\u8db3\u7684\u95ee\u9898\uff0c\u8fd9\u79cd\u65b9\u5f0f\u51cf\u5c11\u7684\u5176\u5b9e\u662f\u4e2d\u95f4\u6fc0\u6d3b\u5360\u7528\u7684\u663e\u5b58\uff0c\u800c\u4e0d\u662f\u6a21\u578b\u53c2\u6570\u3001\u68af\u5ea6\u548c\u4f18\u5316\u5668\u7684\u663e\u5b58</li> </ul> <ol> <li>KV Cache \u7684\u663e\u5b58    - \u8bbe\u8f93\u5165\u5e8f\u5217\u7684\u957f\u5ea6\u4e3a \\(s\\) \uff0c\u8f93\u51fa\u5e8f\u5217\u7684\u957f\u5ea6\u4e3a \\(n\\) \uff0c\u4ee5 float16 \u6765\u4fdd\u5b58 KV cache\uff0c\u90a3\u4e48 KV cache \u7684\u5cf0\u503c\u663e\u5b58\u5360\u7528\u5927\u5c0f\u4e3a      $$      b(s+n)lh \\times 2 \\times 2= 4blh(s+n)      $$      \u8fd9\u91cc\u7b2c\u4e00\u4e2a 2 \u8868\u793a K/V cache\uff0c\u7b2c\u4e8c\u4e2a 2 \u8868\u793a float16 \u5360 2 \u4e2a bytes\u3002</li> </ol>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#why-parallelism","title":"Why Parallelism?","text":"<ul> <li><code>Computation Bottleneck</code>: LLM \u7684\u53c2\u6570\u91cf\u5de8\u5927\uff0c\u4ee5 GPT-3 \u4e3a\u4f8b\uff0c1750 \u4ebf\u53c2\u6570\uff0c\u5bf9 GPU \u8ba1\u7b97\u80fd\u529b\u8981\u6c42\u6781\u9ad8\uff0c\u5355\u4e2a GPU \u65e0\u6cd5\u6ee1\u8db3\u3002(TP, PP, SP) <p>FLOPs \u8fd1\u4f3c \\(6 * 1750 * 10 ^9\\)FLOPs</p> </li> <li><code>Memory Bottleneck</code>: LLM \u7684\u6a21\u578b\u53c2\u6570\u548c\u4e2d\u95f4\u6fc0\u6d3b\u503c\u5360\u7528\u5927\u91cf\u5185\u5b58\uff0c\u5355\u4e2a GPU \u7684\u663e\u5b58\u6709\u9650\uff0c\u65e0\u6cd5\u5bb9\u7eb3\u6574\u4e2a\u6a21\u578b\u3002(TP, PP, ZeRO, SP) <p>\u53c2\u6570\u8bad\u7ec3\u65f6\u7684\u663e\u5b58\u8fd1\u4f3c \\(20 * 1750 * 10 ^9\\) bytes \u8fdc\u5927\u4e8e \u76ee\u524d\u5355\u4e2a GPU \u7684\u663e\u5b58\u5bb9\u91cf \u4e2d\u95f4\u6fc0\u6d3b\u503c\u7684\u663e\u5b58\u5360\u7528\u53d6\u51b3\u4e8e\u6279\u6b21\u5927\u5c0f\u3001\u5e8f\u5217\u957f\u5ea6\u548c\u6a21\u578b\u5c42\u6570\uff0c\u901a\u5e38\u4e5f\u975e\u5e38\u5927\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#parallelism-overviewub-mesh","title":"Parallelism Overview[^UB-mesh]","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#before-parallelism","title":"Before Parallelism","text":"<p>\u5728\u5206\u5e03\u5f0f\u8bad\u7ec3\u4e2d\uff0cGPU \u4e4b\u95f4\u7684\u901a\u4fe1\u5fc5\u4e0d\u53ef\u5c11\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u77e5\u9053 NCCL \u7684\u57fa\u672c\u901a\u4fe1\u539f\u8bed[^NCCL]</p> <ul> <li>Minimum Spanning Tree: HPC \u901a\u4fe1\u5e38\u7528\uff0c\u6700\u5c0f\u5316\u901a\u4fe1 ROUND \u6570</li> <li>Ring Algorithm: GPU \u901a\u4fe1\u901a\u5e38\u6709\u6781\u9ad8\u7684\u5e26\u5bbd\uff0c\u901a\u4fe1\u542f\u52a8\u5e26\u6765\u7684\u5ef6\u8fdf\u5e76\u4e0d\u662f\u4e3b\u8981 bottleneck</li> </ul> <p>AllReduce: \u5c06\u6240\u6709 GPU \u7684\u6570\u636e\u8fdb\u884c\u6c47\u603b\uff0c\u8ba1\u7b97\u5e73\u5747\u503c\uff0c\u5e76\u5c06\u7ed3\u679c\u5e7f\u64ad\u56de\u6240\u6709 GPU\uff0c\u5e38\u7528\u4e8e\u68af\u5ea6\u66f4\u65b0 Broadcast: \u5c06\u4e00\u4e2a GPU \u7684\u6570\u636e\u53d1\u9001\u5230\u6240\u6709\u5176\u4ed6 GPU\uff0c\u5e38\u7528\u4e8e\u6a21\u578b\u53c2\u6570\u521d\u59cb\u5316 </p> <p>Reduce: \u5c06\u6240\u6709 GPU \u7684\u6570\u636e\u6c47\u603b\u5230\u4e00\u4e2a GPU \u4e0a\uff0c\u5e38\u7528\u4e8e\u6536\u96c6\u7ed3\u679c </p> <p>AllGather: \u5c06\u6240\u6709 GPU \u7684\u6570\u636e\u6536\u96c6\u5230\u6bcf\u4e2a GPU \u4e0a\uff0c\u5e38\u7528\u4e8e\u6536\u96c6\u4e2d\u95f4\u7ed3\u679c </p> <p>ReduceScatter: \u5c06\u6570\u636e\u5148\u8fdb\u884c Reduce \u64cd\u4f5c\uff0c\u7136\u540e\u5c06\u7ed3\u679c\u5206\u6563\u5230\u5404\u4e2a GPU \u4e0a\uff0c\u5e38\u7528\u4e8e\u5206\u5e03\u5f0f\u8ba1\u7b97\u4e2d\u7684\u4e2d\u95f4\u6b65\u9aa4 </p> <ul> <li>\u5176\u4e2d AllReduce \u53ef\u4ee5\u770b\u4f5c\u662f ReduceScatter \u548c AllGather \u7684\u7ec4\u5408 <p>ZeRO-3 \u7684\u4f18\u5316\u57fa\u4e8e\u6b64</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#data-parallelism","title":"Data Parallelism","text":"<ul> <li> <p>Parameter Server: workers \u5b58\u6709\u526f\u672c\u4fdd\u8bc1\u5bb9\u9519\uff0cPS \u6536\u96c6\u68af\u5ea6\u66f4\u65b0\u5e76\u5e7f\u64ad\u4fdd\u8bc1\u4e00\u81f4\u6027 </p> </li> <li> <p>All-reduce: \u6bcf\u4e2a GPU \u8ba1\u7b97\u68af\u5ea6\uff0c\u7136\u540e\u901a\u8fc7 All-reduce \u6c47\u603b\u5e76\u66f4\u65b0\u53c2\u6570\uff0c\u6ca1\u6709\u5bb9\u9519\uff0c\u4f46\u662f\u7b80\u5355(\u5de5\u4e1a\u754c\u559c\u6b22\u7b80\u5355\u6709\u6548\u7684\u65b9\u6848) </p> </li> <li> <p>DDP in PyTorch[^ddp]</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#model-parallelism","title":"Model Parallelism","text":"<p>\u6a21\u578b\u5e76\u884c\u539f\u56e0\u662f\u56e0\u4e3a\u6a21\u578b\u6743\u91cd\u8fc7\u5927\uff0c\u5355\u4e2a GPU \u65e0\u6cd5\u5bb9\u7eb3\u6216\u8005\u6a21\u578b\u4e2d\u95f4\u6fc0\u6d3b\u503c\u8fc7\u5927\u4e0d\u80fd\u5728\u5355\u4e2a GPU \u4e0a\u8fdb\u884c\u5b8c\u6574\u7684\u4e00\u6b21\u8bad\u7ec3\u8fed\u4ee3</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u6a21\u578b\u5e76\u884c\u53ef\u4ee5\u5206\u4e3a\u5f20\u91cf\u5e76\u884c\u548c\u6d41\u6c34\u7ebf\u5e76\u884c\uff0c\u4ee5\u53ca\u5bf9 MoE \u6a21\u578b\u7684\u4e13\u5bb6\u5e76\u884c\u3002</p> <ul> <li>TP\uff1a\u901a\u4fe1\u8f7d\u91cf\u5f88\u5927\uff0c\u4e00\u822c\u5728\u5c0f\u4e8e 8 \u5f20 GPU \u7684\u573a\u666f\u4e0b\u4f7f\u7528</li> <li>PP\uff1a\u901a\u4fe1\u8f7d\u91cf\u8f83\u5c0f\uff0c\u6a21\u578b\u5206\u5272\u6bd4\u8f83\u72ec\u7acb</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#pipeline-parallelism","title":"Pipeline Parallelism","text":"<p>\u628a\u6a21\u578b\u5207\u5206\u591a\u4e2a stage\uff0c\u6bcf\u4e2a device \u8d1f\u8d23\u4e00\u4e2a stage \u7684\u8ba1\u7b97\uff0c\u7c7b\u4f3c CPU \u7684 pipeline\uff0c\u95ee\u9898\u53d8\u6210\u4e86\u5982\u4f55\u8ba9 pipeline \u7684 bubbles \u5c3d\u53ef\u80fd\u5c11</p> <ul> <li>\u5b9e\u9645\u4e0a llm \u63a8\u7406\u548c\u8bad\u7ec3\u7684 pipeline \u5e76\u4e0d\u5b8c\u5168\u4e00\u6837\uff0c\u63a8\u7406\u7684 pipeline \u66f4\u7b80\u5355\uff0c\u56e0\u4e3a\u4e0d\u9700\u8981\u53cd\u5411\u4f20\u64ad\uff0c\u800c\u8bad\u7ec3\u7684\u8bdd\u9700\u8981\u8003\u8651\u53cd\u5411\u4f20\u64ad\u548c\u68af\u5ea6\u66f4\u65b0\u3002\u53cd\u5411\u4f20\u64ad\u548c\u68af\u5ea6\u66f4\u65b0\u5bf9\u524d\u5411\u4f20\u64ad\u6709\u4f9d\u8d56 </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#device-placement","title":"Device Placement","text":"<ul> <li>\u53ea\u5bf9\u7279\u6b8a\u7684\u6709\u5206\u652f\u7684\u6a21\u578b\u6709\u6548 </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#synchronous-pipeline-parallelism","title":"Synchronous Pipeline Parallelism","text":"<ul> <li>Idea: \u5c3d\u53ef\u80fd\u51cf\u5c11 Pipeline Bubbles</li> <li>Pros: \u4fdd\u8bc1\u6536\u655b\u8bed\u4e49\uff0c\u8bad\u7ec3\u8fc7\u7a0b\u548c\u5728\u5355\u5f20\u5361\u4e0a\u76f8\u540c</li> <li>Cons:</li> <li>compute: \u6d41\u6c34\u7ebf\u6c14\u6ce1</li> <li>compute: \u4e3a\u4e86\u6d88\u9664\u6d41\u6c34\u7ebf\u6c14\u6ce1\uff0c\u6211\u4eec\u5fc5\u987b\u5207\u5206 input \u53d8\u6210\u66f4\u5c0f\u7684 micro-batches\uff0c\u4f46\u662f micro-batch \u592a\u5c0f\u4f1a\u5f71\u54cd\u786c\u4ef6\u8ba1\u7b97\u7684\u6548\u7387(\\(AI \\\\space = \\\\space #ops \\\\space/ \\\\space #bytes\\))     &gt; \u7b97\u6cd5\u4e0a\u5176\u5b9e\u5bf9 global batch size \u4e5f\u6709\u9650\u5236</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#gpipegpipe","title":"GPipe[^gpipe]","text":"<p>\u628a input \u5207\u5206\u6210\u591a\u4e2a micro-batches\uff0c\u628a micro-batches \u4f9d\u6b21\u9001\u5165 pipeline\u3002\u68af\u5ea6\u8ba1\u7b97\u5982\u4e0b\uff1a</p> \\[ \\\\nabla L\\_{\\\\theta}(x) = \\\\frac{1}{N} \\\\sum\\_{i=1}^{N} \\\\nabla L\\_{\\\\theta}(x_i) \\] <p></p> <ul> <li>Memory Usage \u95ee\u9898\uff1a \u5b58\u5728\u4e00\u4e2a\u4e0d\u505c\u589e\u957f\u5185\u5b58\u7684\u9636\u6bb5\u76f4\u5230\u5cf0\u503c\uff0c\u56e0\u4e3a\u6bcf\u4e2a micro-batch \u7684\u4e2d\u95f4\u6fc0\u6d3b\u503c\u90fd\u9700\u8981\u5b58\u50a8\u76f4\u5230\u5f00\u59cb\u53cd\u5411\u4f20\u64ad</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#1f1b-interleaved-1f1b1f1b","title":"1F1B &amp; Interleaved 1F1B[^1f1b]","text":"<ul> <li> <p>1F1B: \u5e76\u6ca1\u6709\u964d\u4f4e GPipe \u7684\u5ef6\u8fdf\uff0c\u53ea\u662f\u6539\u53d8\u4e86\u8c03\u5ea6\u7684\u987a\u5e8f\uff0c\u5c3d\u53ef\u80fd\u4f18\u5148\u5730\u6267\u884c\u53cd\u5411\u4f20\u64ad </p> </li> <li> <p>Interleaved 1F1B: \u5207\u5206\u6210\u66f4\u7ec6\u7c92\u5ea6\u7684 stage\uff0c\u6bcf\u4e2a GPU \u8d1f\u8d23\u591a\u4e2a\u4e0d\u90bb\u8fd1\u7684 stage </p> </li> </ul> <p>\u6709 16 transformer layers \uff08L1 to L16\uff09\uff0c\u4ed6\u4eec\u88ab\u5747\u5300\u5730\u5206\u914d\u5230\u56db\u4e2a devices \u4e0a Device 1: [L1, L2], [L9, L10] Device 2: [L3, L4], [L11, L12] Device 3: [L5, L6], [L13, L14] Device 4: [L7, L8], [L15, L16]</p> <p>\u8fd9\u6837\u7684\u8bdd\uff0c\u4e00\u4e2a\u6570\u636e\u5728\u6267\u884c\u4e86 device 4 \u7684 L7, L8 \u4e4b\u540e\uff0c\u53ef\u4ee5\u8f6c\u5230 device 1 \u7ee7\u7eed L9 L10\uff1b\u8fd9\u4e5f\u4e0d\u803d\u8bef device 4 \u7ee7\u7eed\u63a5\u53d7\u6765\u81ea forward/backward \u7684\u8ba1\u7b97\u4efb\u52a1\u4e86\u3002</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#terapipeterapipe","title":"TeraPipe[^terapipe]","text":"<p>GPipe \u7b49 PP \u5728\u5927\u89c4\u6a21\u6269\u5c55\u65f6\u9762\u4e34\u7684\u201c\u6d41\u6c34\u7ebf\u6c14\u6ce1\u201d\u548c\u201c\u5185\u5b58\u9650\u5236\u201d\u4e24\u5927\u74f6\u9888\u3002</p> <p>token-level \u5e76\u884c\uff1a\u4e13\u95e8\u9488\u5bf9 autoregressive \u7cfb\u5217\u6a21\u578b\u8bbe\u8ba1\u7684 pipeline \u5e76\u884c\uff0c\u4e00\u4e2a\u8bbe\u5907\u6bcf\u5904\u7406\u5b8c\u4e00\u5c0f\u5757\u6570\u636e(token-level)\uff0c\u5c31\u7acb\u523b\u5c06\u5176\u53d1\u9001\u7ed9\u4e0b\u4e00\u4e2a\u8bbe\u5907</p> <p>\u51cf\u5c0f activation \u5360\u7528\u7684\u663e\u5b58\uff1a \u201c\u6fc0\u6d3b\u91cd\u8ba1\u7b97\u201d\uff08gradient Checkpointing\uff09 \uff0c\u5373\u5728\u6b63\u5411\u4f20\u64ad\u65f6\u53ea\u4fdd\u5b58\u5c11\u91cf\u5173\u952e\u7684\u6fc0\u6d3b\u503c\uff0c\u5728\u53cd\u5411\u4f20\u64ad\u9700\u8981\u65f6\u518d\u91cd\u65b0\u8ba1\u7b97\u5176\u4ed6\u7684\u3002\u4f46\u8fd9\u4f1a\u589e\u52a0\u8ba1\u7b97\u5f00\u9500\uff0c\u62d6\u6162\u53cd\u5411\u4f20\u64ad\u7684\u901f\u5ea6\u3002TeraPipe \u5bf9\u6b64\u8fdb\u884c\u4e86\u4f18\u5316\uff1a</p> <ul> <li> <p>\u4f20\u7edf\u65b9\u5f0f\uff1a\u5728\u53cd\u5411\u4f20\u64ad\u7684\u4e3b\u8ba1\u7b97\u6d41\u4e2d\u540c\u6b65\u5730\u8fdb\u884c\u91cd\u8ba1\u7b97\uff0c\u5bfc\u81f4\u4e3b\u6d41\u7a0b\u9700\u8981\u7b49\u5f85\u91cd\u8ba1\u7b97\u5b8c\u6210\u3002</p> </li> <li> <p>TeraPipe \u65b9\u5f0f\uff1a\u5c06\u6fc0\u6d3b\u503c\u7684\u91cd\u8ba1\u7b97\u4efb\u52a1\u653e\u5230\u4e00\u4e2a**\u72ec\u7acb\u7684\u3001\u5e76\u884c\u7684\u8ba1\u7b97\u6d41\uff08Asynchronous Stream\uff09**\u4e2d\u6267\u884c\u3002\u8fd9\u6837\uff0c\u4e3b\u8ba1\u7b97\u6d41\u5728\u8fdb\u884c\u53cd\u5411\u68af\u5ea6\u8ba1\u7b97\u7684\u540c\u65f6\uff0c\u53e6\u4e00\u4e2a\u8ba1\u7b97\u6d41\u5728\u201c\u540e\u53f0\u201d\u6084\u6084\u5730\u51c6\u5907\u597d\u4e0b\u4e00\u6b65\u9700\u8981\u7684\u6fc0\u6d3b\u503c\u3002</p> </li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#chimerachimera","title":"Chimera[^chimera]","text":"<p>\u63d0\u51fa\u53cc\u5411\u6d41\u6c34\u7ebf (bi-directional pipeline)\uff0c\u5373\u540c\u65f6\u5728 forward \u9636\u6bb5\u548c backward \u9636\u6bb5\u5e76\u884c\u8fd0\u884c\u4e0d\u540c micro-batch(DeepSeek \u4f7f\u7528\u7c7b\u4f3c\u7684\u53d8\u4f53) </p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#zero-bubble-pipeline-parallelismzb","title":"Zero Bubble Pipeline Parallelism[^ZB]","text":"<ul> <li>Motivation: backward \u9700\u8981 forward \u7684\u4e24\u500d\u7684\u65f6\u95f4\u5f00\u9500\uff0cforward \u53ea\u6709\u4e00\u4e2a wx \u4e58\u6cd5\uff1b\u800c backward \u91cc\u9762\u6709\u4e24\u4e2a\u4e58\u6cd5\uff0c\u5c06 backward \u62c6\u6210\u5bf9 Input \u7684 backward \u548c\u5bf9 weight \u7684 backward \u4e24\u4e2a\u90e8\u5206</li> </ul> <p>\u5f53\u524d layer \u7684 backward \u53ea\u4f9d\u8d56\u5bf9\u4e0a\u4e00\u4e2a layer \u7684 input \u7684 backward(B)\uff0c\u4e0d\u4f9d\u8d56 weights \u7684 backward(W)</p> <p></p> <ul> <li> <p>ZB-H1\uff1adevice 1 \u7684\u5cf0\u503c\u5185\u5b58\u4e0e 1F1B \u76f8\u6bd4\u6ca1\u6709\u53d8\u5316\uff0c\u5176\u4ed6 device \u76f8\u5bf9\u589e\u52a0\uff0c\u4f46\u662f bubble \u51cf\u5c11\u4e86 \u2154 </p> </li> <li> <p>ZB-H2\uff1adevice 1 \u7684\u5cf0\u503c\u589e\u52a0\u5230 2 * 1F1B\uff0cbubbles \u63a5\u8fd1\u4e3a 0</p> </li> <li> <p> \u8fd9\u91cc\u5b9e\u9645\u4e0a\u6709\u4e00\u4e2a\u95ee\u9898\uff0coptimizer \u4e00\u822c\u9700\u8981\u5168\u5c40\u540c\u6b65\uff0c\u4f46\u662f ZB-H2 \u91cc\u6bcf\u4e2a device \u90fd\u6709\u81ea\u5df1\u7684 optimizer state\uff0c\u9700\u8981\u989d\u5916\u7684\u673a\u5236\u6765\u5b9e\u73b0 </p> </li> <li> <p>optimizer sync: \u4e3a\u4e86\u8fdb\u884c\u68af\u5ea6\u88c1\u526a\uff0c\u9700\u8981\u8ba1\u7b97\u5168\u5c40\u68af\u5ea6\u8303\u6570\uff1b\u5728\u6df7\u5408\u7cbe\u5ea6\u8bad\u7ec3\u4e2d\uff0c\u9700\u8981\u5bf9\u6240\u6709\u53c2\u6570\u8fdb\u884c\u5168\u5c40 NaN/INF \u68c0\u67e5\u3002</p> <p>\u5f53\u68af\u5ea6\u7684\u201c\u6574\u4f53\u5927\u5c0f\u201d\u8d85\u8fc7\u67d0\u4e2a\u9608\u503c\u65f6\uff0c\u5c31\u628a\u5b83\u6309\u6bd4\u4f8b\u7f29\u5c0f\u3002</p> <p></p> </li> <li> <p>\u5b9e\u9645\u4e0a\u89e6\u53d1\u68af\u5ea6\u88c1\u526a\u548c NaN/INF \u68c0\u67e5\u7684\u9891\u7387\u5e76\u4e0d\u9ad8\uff0c\u6240\u4ee5\u5f02\u6b65\u8fdb\u884c\u6bcf\u4e2a\u9636\u6bb5\u7684 gradients \u68c0\u67e5</p> <p>\u8fd9\u91cc\u5728\u6bcf\u4e2a\u6d41\u6c34\u7ebf\u9636\u6bb5\u6267\u884c\u4f18\u5316\u5668\u6b65\u9aa4\u4e4b\u524d\uff0c\u8be5\u9636\u6bb5\u4f1a\u4ece\u524d\u4e00\u4e2a\u9636\u6bb5\u63a5\u6536\u4e00\u4e2a\u90e8\u5206\u5f52\u7ea6\uff08partially reduced\uff09\u7684\u5168\u5c40\u72b6\u6001\uff0c\u5c06\u5176\u4e0e\u672c\u9636\u6bb5\u7684\u672c\u5730\u72b6\u6001\uff08local state\uff09\u5408\u5e76\u540e\uff0c\u518d\u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2a\u9636\u6bb5\u3002\u5982\u679c\u6700\u540e\u53d1\u73b0\u9700\u8981\u88c1\u526a\u68af\u5ea6\u6216\u8005\u53d1\u73b0 NaN/INF\uff0c\u8fdb\u884c rollback\uff0c\u4e22\u5f03\u6b64\u6b21\u66f4\u65b0\u5373\u53ef\u3002</p> <p></p> </li> <li> <p>ZB-V: ZB-H2 \u7ed3\u5408 Interleaved 1F1B\uff0c\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u5c06\u96c6\u7fa4\u5cf0\u503c\u5185\u5b58\u964d\u4f4e\u5230 1F1B \u7684\u6c34\u5e73\uff0c\u540c\u65f6\u4fdd\u6301\u63a5\u8fd1\u96f6\u7684\u6d41\u6c34\u7ebf\u6c14\u6ce1</p> </li> </ul> <p></p> <ul> <li>Comparison of different PP methods</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#dualpipedeepseek-v3-useddualpipe","title":"DualPipe(DeepSeek-V3 Used)[^dualpipe]","text":"<ul> <li> <p>\u6d41\u6c34\u7ebf\u7a33\u5b9a\u7684\u6807\u51c6\uff1a </p> </li> <li> <p>\u53cc\u5411\u7ba1\u9053\u90fd\u5df2\u201c\u704c\u6ee1\u201d\uff1a     &gt; \u7b2c\u4e00\u4e2a\u6d41\u6c34\u7ebf\uff08F0\uff09\u7684\u7b2c\u4e00\u4e2a\u524d\u5411\u5757\uff08\u9ec4\u8272\u7684 0\uff09\u5fc5\u987b\u5df2\u7ecf\u8d70\u5b8c\u4e86\u5168\u7a0b\uff0c\u4ece Device 0 \u5230\u8fbe\u4e86 Device 7\u3002     &gt; \u7b2c\u4e8c\u4e2a\u6d41\u6c34\u7ebf\uff08F1\uff09\u7684\u7b2c\u4e00\u4e2a\u524d\u5411\u5757\uff08\u6a59\u8272\u7684 10\uff09\u4e5f\u5fc5\u987b\u5df2\u7ecf\u8d70\u5b8c\u4e86\u5168\u7a0b\uff0c\u4ece Device 7 \u5230\u8fbe\u4e86 Device 0\u3002</p> </li> <li> <p>\u53cc\u5411\u53cd\u5411\u4f20\u64ad\u90fd\u5df2\u5f00\u59cb\uff1a     &gt; \u5f53 F0 \u7684\u5757 0 \u5230\u8fbe Device 7 \u540e\uff0c\u5b83\u7684\u53cd\u5411\u4f20\u64ad B0\uff08\u7eff\u8272\u7684 0\uff09\u5c31\u53ef\u4ee5\u4ece Device 7 \u5f00\u59cb\uff0c\u5e76\u5411\u7740 Device 0 \u7684\u65b9\u5411\u56de\u4f20\u3002     &gt; \u5f53 F1 \u7684\u5757 10 \u5230\u8fbe Device 0 \u540e\uff0c\u5b83\u7684\u53cd\u5411\u4f20\u64ad B1\uff08\u6bd4\u5982 T=8 \u65f6 Device 4 \u4e0a\u7684\u6a59\u8272\u5757 10\uff09\u5c31\u53ef\u4ee5\u4ece Device 0 \u5f00\u59cb\uff0c\u5e76\u5411\u7740 Device 7 \u7684\u65b9\u5411\u56de\u4f20\u3002</p> </li> <li> <p>Overlap \u8ba1\u7b97\u548c\u901a\u4fe1[^deepseekv3]</p> </li> </ul> <p></p> <ul> <li>\u5b8c\u6574\u7684 DualPipe \u8c03\u5ea6</li> </ul> <p></p> <ul> <li> \u4e0b\u9762\u7684\u56fe\u91cc\uff0c\u6709\u4e24\u4e2a X\uff0c\u4ee3\u8868 bubble\uff0c\u5373\uff0cdevice 2 \u9700\u8981\u7b49\u5f85 device 3 \u4f20\u9012\u8fc7\u6765 14+0 \u7684\u6267\u884c\u7ed3\u679c\u4e4b\u540e\uff0c\u624d\u53ef\u4ee5\u81ea\u5df1\u6267\u884c\u3002</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#asynchronous-pipeline-parallelism","title":"Asynchronous Pipeline Parallelism","text":"<ul> <li>Idea: \u5728\u53cd\u5411\u4f20\u64ad\u5b8c\u6210\u4e4b\u524d\u5f00\u59cb\u4e0b\u4e00\u9636\u6bb5\u7684\u524d\u5411\u4f20\u64ad</li> <li>Pros: No pipeline bubbles</li> <li>Cons:</li> <li>compute: \u6253\u7834\u4e86\u540c\u6b65\u8bad\u7ec3\u8bed\u4e49(forward \u548c backward \u5fc5\u987b\u5339\u914d\u540c\u4e00\u4efd\u6743\u91cd)\uff0c\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u53ef\u80fd\u6709\u6ede\u540e gradient</li> <li>memory: \u7b97\u6cd5\u4f1a\u5b58\u50a8\u591a\u4e2a\u7248\u672c\u7684 weights \u6765\u4fdd\u8bc1\u4e00\u81f4\u6027</li> </ul> <p>AMPNet[^ampnet]: \u5b8c\u5168\u5f02\u6b65\u3002\u6bcf\u4e2a\u8bbe\u5907\u5728\u7a7a\u95f2\u65f6\u5c31\u6267\u884c\u524d\u5411\u4f20\u64ad\uff0c\u5e76\u5728\u6bcf\u6b21\u53cd\u5411\u4f20\u64ad\u540e\u66f4\u65b0\u6743\u91cd\u3002</p> <ul> <li>Techniques:</li> <li>Task Queue: \u6bcf\u4e2a\u8ba1\u7b97\u5355\u5143\u7ef4\u62a4\u4e00\u4e2a\u672c\u5730\u961f\u5217\uff0cforward \u548c backward \u90fd\u88ab\u8868\u793a\u4e3a\u4efb\u52a1\u3002\u4efb\u52a1\u53ea\u6709\u5728\u4f9d\u8d56\u7684\u6570\u636e (activation \u6216\u68af\u5ea6) \u5230\u8fbe\u65f6\uff0c\u624d\u4f1a\u88ab\u89e6\u53d1</li> <li>AMPNet \u5f15\u5165\u4e86\u4f9d\u8d56\u8ba1\u6570 (dependency counter)\uff0c\u5f53\u6240\u6709\u4f9d\u8d56\u6ee1\u8db3\u65f6\uff0c\u4efb\u52a1\u624d\u80fd\u88ab\u8c03\u5ea6\u6267\u884c\u3002</li> <li>Pros: No pipeline bubbles</li> <li>Cons:</li> <li>\u53ea\u5728\u672c\u5730\u66f4\u65b0\u6743\u91cd\uff0c\u6ca1\u6709\u5168\u5c40\u540c\u6b65\u3002\u5c0f\u6570\u636e\u96c6\u4e0a\u53ef\u4ee5\u5f88\u597d\u7684\u6cdb\u5316\uff0c\u4f46\u662f\u5927\u6570\u636e\u96c6\u4e0a\u5f88\u96be</li> <li>activation \u7f13\u5b58\u9020\u6210 memory overhead(forward \u7ed3\u679c\u9700\u8981\u5b58\u50a8\u76f4\u5230 backward)</li> </ul> <p></p> <p>Pipedream[^pipedream]: \u6bcf\u4e2a batch \u5b58\u50a8\u591a\u4e2a\u6743\u91cd\u7248\u672c(\u7c7b\u4f3c MVCC)</p> <ul> <li>Techniques:</li> <li>Weight Versioning:<ol> <li>forward \u65f6\u4fdd\u5b58\u4e00\u4efd\u5f53\u524d\u53c2\u6570\u5feb\u7167 (stash)\u3002</li> <li>backward \u65f6\u5fc5\u987b\u4f7f\u7528\u5bf9\u5e94 forward \u65f6\u7684\u90a3\u4efd\u53c2\u6570\uff08\u786e\u4fdd\u4e00\u81f4\u6027\uff09\u3002</li> <li>\u66f4\u65b0\u662f\u5f02\u6b65\u7684\uff0c\u4f46\u4fdd\u8bc1 forward/backward \u7528\u7684\u662f\u540c\u4e00\u7248\u672c\u7684\u6743\u91cd\u3002</li> </ol> </li> <li>\u91c7\u7528 1F1B (one forward, one backward) pipeline \u8c03\u5ea6\u3002</li> <li> No Memory saving compared to single device case, which is opposite to the purpose of model parrallelism</li> </ul> <p> Pipedream-2BW: \u53ea\u4fdd\u7559 2 \u4e2a\u7248\u672c\u7684\u6743\u91cd</p> <ul> <li> <p>Techniques:</p> </li> <li> <p>\u6bcf\u4e2a stage \u53ea\u4fdd\u7559 \u4e24\u4e2a\u7248\u672c\u7684\u6743\u91cd\uff08current \u548c previous\uff09\u3002\u4e0d\u9700\u8981\u4e3a\u6bcf\u4e2a\u5fae\u6279\u6b21 stash weight\uff0c\u5927\u5e45\u964d\u4f4e\u663e\u5b58\u5360\u7528\u3002</p> </li> <li>forward \u603b\u662f\u7528\u524d\u4e00\u7248\u672c\uff08stalled by 1 update\uff09</li> <li>\u8c03\u5ea6\uff1a\u6539\u8fdb\u4e86 1F1B \u8c03\u5ea6\uff0c\u4f7f\u5f97\u5728 forward/backward \u4e4b\u95f4\u80fd\u66f4\u9ad8\u6548\u590d\u7528 weight\u3002</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#rl-based-partitioning-algorithm","title":"RL-Based Partitioning Algorithm","text":"<p>\u5c06\u8ba1\u7b97\u56fe\u5206 stage \u95ee\u9898\u53d8\u6210\u4e00\u4e2a\u5f3a\u5316\u5b66\u4e60\u95ee\u9898</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#optimization-based-partitioning-algorithm","title":"Optimization-Based Partitioning Algorithm","text":"<p>\u8bb2\u6c42\u89e3\u5212\u5206\u95ee\u9898\u53d8\u6210\u4e00\u4e2a\u6574\u6570\u7ebf\u6027\u89c4\u5212\u95ee\u9898</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#tensor-parallelism","title":"Tensor Parallelism","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#parallelize-one-operator","title":"Parallelize One Operator","text":"<ul> <li>Manual: \u679a\u4e3e\u6240\u6709\u53ef\u80fd\u7684\u5212\u5206\u65b9\u5f0f\uff0c\u9009\u62e9\u5728\u73af\u5883\u9650\u5236\u4e0b\u6700\u4f18\u7684\u5212\u5206\u65b9\u5f0f </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#re-partition-in-tensor-parallelism","title":"Re-partition in Tensor Parallelism","text":"<p>\u4e0d\u540c\u7684 op \u5e76\u884c\u7b56\u7565\u8981\u6c42 tensor \u7684\u5f62\u72b6\u4e0d\u540c\uff0c\u901a\u4fe1\u5f00\u9500\u4e5f\u4e0d\u540c</p> <p></p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#parallelize-all-operators-in-a-computation-graph","title":"Parallelize All Operators in a Computation Graph","text":"<p>Problem Definition:</p> <ul> <li>\u7ed9\u5b9a\u4e00\u4e2a\u8ba1\u7b97\u56fe\uff0c\u9009\u62e9\u4e00\u4e2a\u5212\u5206\u7b56\u7565\uff0c\u4f7f\u5f97 Node costs(\u8ba1\u7b97\u5f00\u9500+\u901a\u4fe1\u5f00\u9500) + Edge costs(re-partition \u901a\u4fe1\u5f00\u9500) \u6700\u5c0f </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#model-specific-intra-op-parallel-strategies","title":"Model-specific Intra-op Parallel Strategies","text":"<p>AlexNet</p> <p></p> <p>Megaton-LM[^megatonlm]</p> <ul> <li>f \u548c g \u662f\u5171\u8f6d\u7684\u3002 f \u5728\u6b63\u5411\u4f20\u64ad\u4e2d\u662f\u6052\u7b49\u7b97\u5b50\uff0c\u5728\u53cd\u5411\u4f20\u64ad\u4e2d\u662f\u6240\u6709 reduce \u64cd\u4f5c\uff0c\u800c g \u5728\u6b63\u5411\u4f20\u64ad\u4e2d\u662f\u6240\u6709 reduce \u64cd\u4f5c\uff0c\u5728\u53cd\u5411\u4f20\u64ad\u4e2d\u662f\u6052\u7b49\u64cd\u4f5c </li> </ul> <p>Gshard-MoE[^gshard]</p> <ul> <li>\u9664\u4e86 MoE \u5c42\u5206\u5e03\u5f0f\u5728\u591a\u4e2a\u8bbe\u5907\u4e0a\uff0c\u5176\u4ed6\u5c42\u90fd copy \u5230\u6bcf\u4e2a\u8bbe\u5907\u4e0a</li> <li>\u4e00\u6b21 forward \u548c backward \u5206\u522b\u9700\u8981 2 \u6b21 all-to-all \u64cd\u4f5c <p>\u8def\u7531\u5206\u53d1 token \u5230\u4e0d\u540c\u7684\u4e13\u5bb6\uff0c\u5c06\u8def\u7531\u5230\u81ea\u5df1\u4e13\u5bb6\u7684\u8f93\u5165 gather</p> </li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#systems-for-intra-op-parallelism","title":"Systems for Intra-op Parallelism","text":"<p>ZeRO Optimizer[^zero]: \u89e3\u51b3\u6570\u636e\u5e76\u884c\u4e2d\u5185\u5b58\u74f6\u9888\uff0c\u5c06 gradients, optimizer states and model weights \u5206\u533a\u5e76\u5206\u53d1\u5230\u4e0d\u540c\u8bbe\u5907\u4e0a</p> <p>\u8fd9\u91cc Optimizer States \u4f7f\u7528\u4e86 Adam \u4f18\u5316\u5668\uff0c\u9700\u8981\u4e3a\u6bcf\u4e2a\u53c2\u6570\u989d\u5916\u5b58\u50a8\u4e00\u9636\u52a8\u91cf + \u4e8c\u9636\u52a8\u91cf + \u53c2\u6570\u526f\u672c(fp32 copy)\uff0cZeRO \u8bba\u6587\u4e2d\u4f7f\u7528\u4e86 FP16 + FP32 \u6df7\u5408\u7cbe\u5ea6\u8bad\u7ec3\uff0c\u6240\u4ee5\u4f1a\u5b58\u50a8\u4e24\u500d\u7684 Optimizer States</p> <p></p> <p>ZeRO 2: \u4e0d\u4ec5\u5c06 optimizer states \u5206\u5e03\u5230\u4e0d\u540c\u8bbe\u5907\u4e0a\uff0c\u8fd8\u5c06 gradients \u5206\u5e03\u5230\u4e0d\u540c\u8bbe\u5907\u4e0a</p> <p></p> <p>ZeRO 3: \u5c06\u6a21\u578b\u53c2\u6570\u4e5f\u5206\u5e03\u5230\u4e0d\u540c\u8bbe\u5907\u4e0a\uff0c\u4f46\u662f\u589e\u52a0\u4e86\u901a\u4fe1\u5f00\u9500</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#automatic-parallelization-methods","title":"Automatic Parallelization Methods","text":"<ul> <li>Alpa[^alpa]</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#summary-for-parallelism-concepts","title":"Summary for Parallelism Concepts","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#why-we-do-not-use-automatic-parallelization-in-llm","title":"Why we do not use automatic parallelization in LLM?","text":"<p>\u56e0\u4e3a LLM \u73b0\u5728\u7684\u67b6\u6784\u57fa\u672c\u662f Transformer\uff0cTransformer \u7684\u8ba1\u7b97\u56fe\u6bd4\u8f83\u7b80\u5355\uff0c\u624b\u52a8\u8bbe\u8ba1\u7684\u5e76\u884c\u7b56\u7565\u5df2\u7ecf\u8db3\u591f\u597d\uff0c\u5e76\u4e14\u81ea\u52a8\u5e76\u884c\u5316\u65b9\u6cd5\u7684\u641c\u7d22\u7a7a\u95f4\u548c\u8ba1\u7b97\u5f00\u9500\u90fd\u6bd4\u8f83\u5927\uff0c\u6536\u76ca\u4e0d\u660e\u663e\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#communication-in-different-parallelism","title":"Communication in Different Parallelism","text":"<p>[^UB-mesh]</p> Parallelism Techniques Communication Pattern Data Volume Per Transfer Total Transfer Total Volume Data Traffic DP AllReduce 711.75 MB 64 44.48 GB 1.34% PP P2P 192 MB 26 4.875 GB 0.14% TP AllReduce 360 MB 4992 1775 GB 52.9% SP AllGather 180/360 MB 4992/1664 1462.5 GB 44.08% EP AlltoAll 10.5 MB 4992 51.19 GB 1.54% <ul> <li> <p>\u6570\u636e\u5e76\u884c\uff08Data Parallelism, DP\uff09\uff1a</p> </li> <li> <p>\u4e3a\u4e86\u540c\u6b65\u68af\u5ea6\uff0cGPU \u4e4b\u95f4\u9700\u8981\u8fdb\u884c AllReduce \u901a\u4fe1\u64cd\u4f5c\uff1b</p> </li> <li> <p>DP \u7684\u6d41\u91cf\u867d\u7136\u53ea\u5360\u4e0d\u5230 2%\uff0c\u4f46\u9700\u957f\u8ddd\u79bb\u4f20\u8f93\uff0c\u540c\u65f6\u53ef\u4e0e\u8ba1\u7b97\u90e8\u5206\u63a9\u76d6\uff0c\u9700\u63a7\u5236\u901a\u4fe1\u5f00\u9500\u5360\u6bd4\u3002</p> </li> <li> <p>\u6d41\u6c34\u7ebf\u5e76\u884c\uff08Pipeline Parallelism, PP\uff09\uff1a</p> </li> <li> <p>\u6d89\u53ca\u7528\u4e8e\u8de8\u5c42\u4f20\u8f93\u53c2\u6570\u7684 P2P \u901a\u4fe1\uff1b</p> </li> <li> <p>\u901a\u4fe1\u91cf\u5c0f\u3001\u901a\u4fe1\u6b21\u6570\u5c11\uff0c\u53ef\u901a\u8fc7\u6d41\u6c34\u63a9\u76d6\uff0c\u5bf9\u7f51\u7edc\u8bc9\u6c42\u8f83\u4f4e\u3002</p> </li> <li> <p>\u5f20\u91cf\u5e76\u884c\uff08Tensor Parallelism, TP\uff09\uff1a</p> </li> <li> <p>\u5f20\u91cf\u5e76\u884c\u6240\u9700\u7684\u901a\u4fe1\u91cf\u6700\u5927\uff0c\u4e14\u4e0d\u53ef\u88ab\u8ba1\u7b97\u63a9\u76d6\uff0c\u56e0\u6b64\u9700\u5728\u540c\u4e00\u4e2a\u670d\u52a1\u5668\u5185\u4f7f\u7528\u5f20\u91cf\u5e76\u884c\u3002</p> </li> <li> <p>\u5e8f\u5217\u5e76\u884c\uff08Sequence Parallelism, SP\uff09\uff1a</p> </li> <li> <p>\u5e8f\u5217\u5e76\u884c\u6240\u9700\u7684\u901a\u4fe1\u91cf\u4e5f\u5f88\u5927\uff0c\uff0c\u56e0\u6b64\u9700\u5728\u540c\u4e00\u4e2a\u670d\u52a1\u5668\u5185\u4f7f\u7528\u5e8f\u5217\u5e76\u884c\u3002</p> </li> <li> <p>\u4e13\u5bb6\u5e76\u884c\uff08Experts Parallelism, EP\uff09\uff1a</p> </li> <li> <p>\u4f8b\u5982\u5c06\u9700\u8981\u7ed9\u4e13\u5bb6 1 \u8ba1\u7b97\u7684\u6570\u636e\u6536\u96c6\u8d77\u6765\u653e\u5728\u4e13\u5bb6 1 \u5904\u3001\u5c06\u9700\u8981\u7ed9\u4e13\u5bb6 2 \u8ba1\u7b97\u7684\u6570\u636e\u6536\u96c6\u8d77\u6765\u653e\u5728\u4e13\u5bb6 2 \u5904\uff0c\u56e0\u6b64\u9700\u8981\u4f7f\u7528 All-to-All \u901a\u4fe1\uff1b</p> </li> <li>\u5355\u6b21\u901a\u4fe1\u91cf\u5c0f\uff0c\u4f46\u901a\u4fe1\u6b21\u6570\u591a\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#_3","title":"\u9644\u5f55","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#ddp-in-pytorchddp","title":"DDP in PyTorch[^ddp]","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#original-solution","title":"Original Solution","text":"<ol> <li>\u4ece\u76f8\u540c\u7684\u6a21\u578b\u72b6\u6001\u5f00\u59cb</li> </ol> <p>\u5728 DDP \u6784\u5efa\u65f6\u5c06\u6a21\u578b\u72b6\u6001\u4ece\u4e00\u4e2a\u8fdb\u7a0b\u5e7f\u64ad\u5230\u6240\u6709\u5176\u4ed6\u8fdb\u7a0b\u6765\u5b9e\u73b0</p> <ol> <li>\u5728\u6bcf\u6b21\u8fed\u4ee3\u4e2d\u6d88\u8017\u76f8\u540c\u7684\u68af\u5ea6\u6765\u4fdd\u8bc1\u6b63\u786e\u6027\u3002</li> </ol> <p>\u4e00\u4e2a\u7b80\u5355\u7684\u89e3\u51b3\u65b9\u6848\u53ef\u4ee5\u5728\u672c\u5730\u53cd\u5411\u4f20\u64ad\u4e4b\u540e\u548c\u66f4\u65b0\u672c\u5730\u53c2\u6570\u4e4b\u524d\u63d2\u5165\u4e00\u4e2a\u68af\u5ea6\u540c\u6b65\u9636\u6bb5\u3002</p> <p>DDP \u53ef\u4ee5\u6ce8\u518c autograd \u94a9\u5b50\u4ee5\u5728\u6bcf\u4e2a\u53cd\u5411\u4f20\u64ad\u540e\u89e6\u53d1\u8ba1\u7b97\u3002\u5f53\u89e6\u53d1\u65f6\uff0c\u6bcf\u4e2a\u94a9\u5b50\u4f1a\u626b\u63cf\u6240\u6709\u672c\u5730\u6a21\u578b\u53c2\u6570\uff0c\u5e76\u4ece\u6bcf\u4e2a\u53c2\u6570\u4e2d\u68c0\u7d22\u68af\u5ea6\u5f20\u91cf\u3002</p> <p>\u7136\u540e\uff0c\u5b83\u4f7f\u7528 AllReduce \u96c6\u4f53\u901a\u4fe1\u8c03\u7528\u6765\u8ba1\u7b97\u6240\u6709\u8fdb\u7a0b\u4e2d\u6bcf\u4e2a\u53c2\u6570\u7684\u5e73\u5747\u68af\u5ea6\uff0c\u5e76\u5c06\u7ed3\u679c\u5199\u56de\u68af\u5ea6\u5f20\u91cf\u3002</p> <p>\u5b9e\u9645\u4e0a\u8fd9\u79cd\u65b9\u6848\u5bfc\u81f4\u4e86\u6027\u80fd\u95ee\u9898\uff1a</p> <ul> <li>\u96c6\u7fa4\u901a\u4fe1\u5728\u5c0f tensor \u4e0a\u6548\u7387\u4f4e\u4e0b</li> <li>\u56e0\u4e3a\u5c06\u68af\u5ea6\u8ba1\u7b97\u548c\u540c\u6b65\u5206\u5f00\uff0c\u65e0\u6cd5\u91cd\u53e0\u8ba1\u7b97\u548c\u901a\u4fe1</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#improved-technique","title":"Improved Technique","text":"<ol> <li>Gradient Bucketing: DDP \u53ef\u4ee5\u901a\u8fc7\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4\u5e76\u5c06\u591a\u4e2a\u68af\u5ea6\u5408\u5e76\u5230\u4e00\u4e2a AllReduce \u64cd\u4f5c\u4e2d\uff0c\u5b9e\u73b0\u66f4\u9ad8\u7684\u541e\u5410\u91cf\u548c\u66f4\u4f4e\u7684\u5ef6\u8fdf\u3002\u4e3a\u4e86\u91cd\u53e0\u8ba1\u7b97\u548c\u901a\u4fe1\uff0cDDP \u4e0d\u5e94\u5728\u4e00\u6b21 AllReduce \u4e2d\u901a\u4fe1\u6240\u6709\u68af\u5ea6\uff0c\u5426\u5219\u5728\u8ba1\u7b97\u5b8c\u6210\u4e4b\u524d\u65e0\u6cd5\u5f00\u59cb\u901a\u4fe1</li> <li>Overlap Computation with Communication: \u4f7f\u7528\u6876\u5212\u5206\uff0cDDP \u53ea\u9700\u8981\u7b49\u5f85\u540c\u4e00\u6876\u4e2d\u7684\u6240\u6709\u5185\u5bb9\u90fd\u51c6\u5907\u597d\u540e\u624d\u5f00\u59cb\u901a\u4fe1\u3002DDP \u4e3a\u6bcf\u4e2a\u68af\u5ea6\u7d2f\u52a0\u5668\u6ce8\u518c\u4e86\u4e00\u4e2a\u81ea\u52a8\u5fae\u5206\u94a9\u5b50\u3002\u94a9\u5b50\u5728\u76f8\u5e94\u7684\u7d2f\u52a0\u5668\u66f4\u65b0\u68af\u5ea6\u540e\u89e6\u53d1\uff0c\u5e76\u5c06\u68c0\u67e5\u5b83\u6240\u5c5e\u7684\u6876\u3002\u5982\u679c\u540c\u4e00\u6876\u4e2d\u6240\u6709\u68af\u5ea6\u7684\u94a9\u5b50\u90fd\u5df2\u89e6\u53d1\uff0c\u6700\u540e\u4e00\u4e2a\u94a9\u5b50\u5c06\u89e6\u53d1\u8be5\u6876\u7684\u5f02\u6b65 AllReduce\u3002</li> </ol> <p>Attentions</p> <ul> <li>\u6240\u6709\u8fdb\u7a0b\u5fc5\u987b\u4f7f\u7528\u76f8\u540c\u7684\u6876\u6392\u5e8f\u987a\u5e8f\uff0c\u5e76\u4e14\u6ca1\u6709\u8fdb\u7a0b\u53ef\u4ee5\u5728\u542f\u52a8\u6876 i+1 \u4e4b\u524d\u542f\u52a8\u6876 i \u7684 AllReduce</li> </ul> <p>\uff08a\uff09\u663e\u793a\u4e86\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5176\u4e2d\u4e24\u4e2a\u5782\u76f4\u8f74\u4ee3\u8868\u65f6\u95f4\uff0c\u865a\u7ebf\u8868\u793a\u68af\u5ea6\u4f55\u65f6\u51c6\u5907\u597d\u3002\u5728\u8fdb\u7a0b 1 \u4e2d\uff0c\u56db\u4e2a\u68af\u5ea6\u6309\u987a\u5e8f\u8ba1\u7b97\uff0c\u4f46\u5728\u8fdb\u7a0b 2 \u4e2d\uff0c\u68af\u5ea6\\(g_2\\)\u662f\u5728\\(g_3\\)\u548c\\(g_4\\)\u4e4b\u540e\u8ba1\u7b97\u7684\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u6240\u6709\u8fdb\u7a0b\u5728\u51c6\u5907\u597d\u540e\u7acb\u5373\u8fdb\u884c AllReduce\uff0cAllReduce \u5185\u5bb9\u5c06\u4e0d\u5339\u914d(\\(g_2\\)\u8fd8\u6ca1\u6709\u8ba1\u7b97\u5b8c\u6210\uff0c\u7ed3\u679c\u4e0d\u6b63\u786e)</p> <p>PyTorch v1.5.0 \u901a\u8fc7\u4f7f\u7528 model.parameters()\u7684\u9006\u5e8f\u4f5c\u4e3a\u6876\u6392\u5e8f\u987a\u5e8f\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5047\u8bbe\u5c42\u5f88\u53ef\u80fd\u6309\u7167\u4e0e\u5b83\u4eec\u5728\u6b63\u5411\u4f20\u9012\u4e2d\u8c03\u7528\u7684\u76f8\u540c\u987a\u5e8f\u6ce8\u518c\u3002 \u56e0\u6b64\uff0c\u53cd\u5411\u987a\u5e8f\u5e94\u5927\u81f4\u4ee3\u8868\u53cd\u5411\u4f20\u64ad\u4e2d\u7684\u68af\u5ea6\u8ba1\u7b97\u987a\u5e8f</p> <ul> <li>\u5bf9\u4e8e\u8df3\u8fc7\u7684\u68af\u5ea6\uff0cDDP \u53ef\u4ee5\u901a\u8fc7\u5728\u6b63\u5411\u4f20\u64ad\u7ed3\u675f\u65f6\u4e3b\u52a8\u5c06\u5b83\u4eec\u6807\u8bb0\u4e3a\u5c31\u7eea\u6765\u907f\u514d\u7b49\u5f85\u5176\u4f59\u53c2\u6570\u68af\u5ea6</li> </ul> <p>\u7531\u4e8e\u68af\u5ea6\u5230\u6876\u7684\u6620\u5c04\u662f\u5728\u6784\u5efa\u65f6\u786e\u5b9a\u7684\uff0c\u90a3\u4e9b\u7f3a\u5931\u7684\u68af\u5ea6\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u6876\u4ece\u672a\u770b\u5230\u6700\u7ec8\u7684 autograd \u94a9\u5b50\uff0c\u4ece\u800c\u672a\u80fd\u5c06\u6876\u6807\u8bb0\u4e3a\u5c31\u7eea\u3002\u56e0\u6b64\uff0c\u53cd\u5411\u4f20\u64ad\u53ef\u80fd\u4f1a\u6302\u8d77</p> <p>\uff08b\uff09\u663e\u793a\u4e86\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5176\u4e2d\u4e00\u4e2a\u8fed\u4ee3\u4e2d\u8df3\u8fc7\u4e86\u5bf9\u5e94\u68af\u5ea6\\(g_3\\)\u7684\u53c2\u6570\uff0c\u5bfc\u81f4\u6876 2 \u6c38\u8fdc\u4e0d\u4f1a\u51c6\u5907\u597d</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#distributeddataparallel-algorithm","title":"DistributedDataParallel Algorithm","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#alpaalpa","title":"Alpa[^alpa]","text":"","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#techniques","title":"Techniques","text":"<ul> <li> <p>\u5206\u5c42\u62bd\u8c61 (Hierarchical Abstraction)\uff1a\u628a\u5927\u95ee\u9898\u62c6\u5206\u6210\u4e24\u5c42\uff1a</p> </li> <li> <p>Inter-Operator Parallelism\uff08\u7b97\u5b50\u7ea7\u522b\u5e76\u884c\uff09 \u2192 \u51b3\u5b9a\u6bcf\u4e2a layer/module \u600e\u4e48\u5207\uff08DP, PP, TP\uff09\u3002</p> </li> <li> <p>Intra-Operator Parallelism\uff08\u7b97\u5b50\u5185\u5e76\u884c\uff09 \u2192 \u9488\u5bf9\u77e9\u9635\u4e58\u6cd5\u3001\u5377\u79ef\u7b49\u64cd\u4f5c\u8fdb\u4e00\u6b65\u505a\u5f20\u91cf\u5207\u5206\u3002</p> </li> <li> <p>\u4e24\u9636\u6bb5\u641c\u7d22 (Two-level search)\uff1a</p> </li> <li> <p>Stage 1: \u901a\u8fc7\u52a8\u6001\u89c4\u5212\uff08DP\uff09+ cost model\uff0c\u5728 operator graph \u5c42\u9762\u627e\u5230\u6700\u4f18\u5212\u5206\u3002</p> </li> <li> <p>Stage 2: \u5728\u6bcf\u4e2a operator \u5185\u90e8\uff0c\u7528 ILP / search \u786e\u5b9a\u6700\u4f73 intra-op parallelism\u3002</p> </li> <li> <p>\u7f16\u8bd1\u5668\u652f\u6301 (Compiler-based)\uff1a</p> </li> <li> <p>Alpa \u6784\u5efa\u5728 XLA \u4e0a\uff0c\u53ef\u4ee5\u81ea\u52a8\u751f\u6210 SPMD (single program multiple data) \u7a0b\u5e8f\u3002</p> </li> <li>\u901a\u8fc7 parallel execution plan \u2192 lowered to XLA SPMD \u2192 \u6620\u5c04\u5230 GPU/TPU\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#_4","title":"\u641c\u7d22\u7a7a\u95f4","text":"<p>\u5bf9\u4e8e computation block\uff0cAlpa \u5141\u8bb8 DP PP TP \u4ee5\u53ca\u4ed6\u4eec\u7684\u7ec4\u5408</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#search-methods","title":"Search Methods","text":"<ul> <li>Inter-Operator \u5c42\u7ea7\uff1a\u628a\u6a21\u578b\u5206\u6210\u591a\u4e2a stage \u5206\u914d\u7ed9\u4e0d\u540c\u7684 mesh\u3002\u6bcf\u4e2a segment \u9009\u62e9\u4e00\u4e2a\u5e76\u884c\u65b9\u5f0f\uff08DP / PP / TP\uff09\u3002\u52a8\u6001\u89c4\u5212\u641c\u7d22 segment \u5212\u5206\uff0c\u5229\u7528 cost model \u8bc4\u4f30\u6267\u884c\u7684\u5ef6\u8fdf\u3002</li> </ul> <ul> <li>Intra-Operator \u5c42\u7ea7\uff1a\u5bf9\u6bcf\u4e2a\u7b97\u5b50\uff0c\u679a\u4e3e\u53ef\u80fd\u7684 tensor \u5207\u5206\u65b9\u5f0f\u3002\u7528 ILP \u627e\u5230\u4ee3\u4ef7\u6700\u4f4e\u7684\u65b9\u6848\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/parallelization/#_5","title":"\u53c2\u8003\u8d44\u6599","text":"<p>[^params]: \u5206\u6790 transformer \u6a21\u578b\u7684\u53c2\u6570\u91cf\u3001\u8ba1\u7b97\u91cf\u3001\u4e2d\u95f4\u6fc0\u6d3b\u3001KV cache [^NCCL]: NCCL \u5b98\u65b9\u6587\u6863 [^ZB]: Zero Bubble Pipeline Parallelism [^dualpipe]: Deepseek-v3 \u6280\u672f\u62a5\u544a-\u56fe\u7684\u9010\u6b65\u89e3\u6790-4-DualPipe [^deepseekv3]: DeepSeek-V3 Technical Report [^UB-mesh]: UB-Mesh: a Hierarchically Localized nD-FullMesh Datacenter Network Architecture [^ddp]: PyTorch Distributed: Experiences on Accelerating Data Parallel Training</p> <p>[^gpipe]: GPipe: Efficient Training of Giant Neural Networks using Pipeline Parallelism [^gshard]: GShard: Scaling Giant Models with Conditional Computation and Automatic Sharding [^megatonlm]: Megatron-LM: Training Multi-Billion Parameter Language Models Using Model Parallelism [^zero]: ZeRO: Memory Optimization Towards Training A Trillion Parameter Models [^1f1b]: Efficient Large-Scale Language Model Training on GPU Clusters Using Megatron-LM</p> <p>[^terapipe]: TeraPipe: Token-Level Pipeline Parallelism for Training Large-Scale Language Models [^chimera]: Chimera: Efficiently Training Large-Scale Neural Networks with Bidirectional Pipelines [^ampnet]: AMPNet: Asynchronous Model-Parallel Training for Dynamic Neural Networks [^pipedream]: PipeDream: Fast and Efficient Pipeline Parallel DNN Training [^alpa]: Alpa: Automating Inter- and Intra-Operator Parallelism for Distributed Deep Learning [^cse234]:CSE 234</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/torch_compile/","title":"torch.compile \u539f\u7406\u548c\u5b9e\u8df5","text":"2025-12-122025-12-12 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/llm_inference/torch_compile/#torchcompile","title":"torch.compile \u539f\u7406\u548c\u5b9e\u8df5","text":"<p> \u7ea6 160 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/torch_compile/#_1","title":"\u539f\u7406","text":"<p><code>torch.compile</code> \u662f PyTorch \u63d0\u4f9b\u7684\u4e00\u4e2a\u7528\u4e8e\u52a0\u901f\u6a21\u578b\u63a8\u7406\u548c\u8bad\u7ec3\u7684\u5de5\u5177\u3002\u5b83\u901a\u8fc7\u5c06 PyTorch \u4ee3\u7801\u8f6c\u6362\u4e3a\u66f4\u9ad8\u6548\u7684\u4e2d\u95f4\u8868\u793a\uff08IR\uff09\uff0c\u5e76\u5229\u7528\u5404\u79cd\u4f18\u5316\u6280\u672f\u6765\u63d0\u5347\u6027\u80fd\u3002\u5176\u6838\u5fc3\u539f\u7406\u5305\u62ec\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u9762\uff1a - Dynamo: \u62e6\u622a Python \u6267\u884c\u4ee3\u7801\uff0c\u63d0\u53d6 tensor op \u6784\u6210\u9759\u6001 IR \u56fe\uff0c\u8df3\u8fc7 Python \u89e3\u91ca\u5668 - Inductor: \u7b97\u5b50\u878d\u5408 + kernel \u5408\u5e76 + \u5185\u5b58\u4f18\u5316 - CUDAGraph: \u51cf\u5c11 CPU \u8c03\u5ea6\u5f00\u9500\uff0c\u4e00\u6b21\u5f55\u5236\u591a\u6b21\u6267\u884c</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/","title":"Transformer-based LLM","text":"2025-10-052025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#transformer-based-llm","title":"Transformer-based LLM","text":"<p> \u7ea6 2631 \u4e2a\u5b57  10 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 13 \u5206\u949f</p> <p>\u73b0\u5728\u7684\u5927\u6a21\u578b\u57fa\u672c\u662f Transformer-based \u7684\u81ea\u56de\u5f52\u9884\u8bad\u7ec3\u6a21\u578b\uff0c\u672c\u7ae0\u6211\u4eec\u5c06\u4ee5 llama2 \u4ee5\u53ca GPT-3 \u4e3a\u4f8b\u4ecb\u7ecd\u8fd9\u79cd\u6a21\u578b\u7684\u57fa\u672c\u7ed3\u6784\u3002</p> <ul> <li>Positional Encoding: RoPE</li> <li>Attention: Multi-Head Attention or Multi-Query Attention or Grouped-Query Attention or Multi-Head Latent Attention or DeepSeek Sparse Attention</li> <li>Normalization: LayerNorm or RMSNorm</li> <li>FFN: MLP or SwiGLU or Mixture of Experts</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#overview","title":"Overview","text":"<p>\u4ee5 Transformer \u67b6\u6784\u4e3a\u57fa\u7840\u7684 Large Language Models \u7684\u6574\u4f53\u6d41\u7a0b\u662f\u57fa\u4e8e Transformer Block\u7684\uff0c\u6bcf\u4e2a Transformer Block \u4e3b\u8981\u7531 Multi-Head Self-Attention Block\uff0cFeed Forward Network\u4ee5\u53ca Layer Normalization \u7ec4\u6210\u3002\u6bcf\u4e2a Transformer Block \u7684\u8f93\u5165\u662f\u4e0a\u4e2a Transformer Block \u7684\u8f93\u51fa\u3002</p> <ul> <li>Input X \u9700\u8981\u7ecf\u8fc7 embedding \u53d8\u6210 token \u5e8f\u5217</li> <li>\u63a5\u7740\uff0c\u9700\u8981\u7ecf\u8fc7 positional embedding\uff0c\u5c06 token \u5e8f\u5217\u4f4d\u7f6e\u4fe1\u606f\u7f16\u7801\u5230 token \u5e8f\u5217\u4e2d</li> <li>positional encoding \u5305\u542b\u4e24\u79cd\u7edd\u5bf9\u7f16\u7801\u65b9\u5f0f\u6216\u8005\u76f8\u5bf9\u7f16\u7801\u65b9\u5f0f\u540e\u9762\u4f1a\u8be6\u7ec6\u8bb2\u89e3</li> </ul> <p>LLMs \u63a8\u7406\u662f\u4e00\u822c\u5206\u4e3a\u4e24\u4e2a\u9636\u6bb5 prefill \u9636\u6bb5\u548c decode \u9636\u6bb5\uff1a</p> <ul> <li>Prefill Stage: LLM \u8ba1\u7b97\u5e76\u5b58\u50a8\u521d\u59cb\u8f93\u5165 token \u7684 KV cache\uff0c\u5e76\u751f\u6210\u7b2c\u4e00\u4e2aoutput token</li> <li>Decode Stage: LLM \u901a\u8fc7 KV cache \u9010\u4e2a\u751f\u6210 output token\uff0c\u7136\u540e\u7528\u65b0\u751f\u6210\u7684 token \u7684 KV \u5bf9\u66f4\u65b0 KV cache </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#positional-encoding","title":"Positional Encoding","text":"<p>\u4e00\u822c\u5206\u4e3a\u4e24\u5927\u7c7b\uff1a\u7edd\u5bf9\u4f4d\u7f6e\u7f16\u7801\uff08Absolute Position Encoding\uff09\u548c\u76f8\u5bf9\u4f4d\u7f6e\u7f16\u7801\uff08Relative Position Encoding\uff09\u3002\u672c\u8282\u5c06\u4ecb\u7ecd\u8fd9\u4e24\u79cd\u4f4d\u7f6e\u7f16\u7801\u7684\u533a\u522b\u53ca\u5176\u91cd\u8981\u6027\uff0c\u5e76\u91cd\u70b9\u89e3\u6790\u4e00\u79cd\u7ed3\u5408\u4e86\u4e24\u8005\u4f18\u70b9\u7684\u521b\u65b0\u65b9\u6cd5\u2014\u2014\u65cb\u8f6c\u4f4d\u7f6e\u7f16\u7801\uff08Rotary Position Embedding, RoPE\uff09</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#why-we-need-position-encoding","title":"Why we need Position Encoding","text":"<p>\u5728\u81ea\u7136\u8bed\u8a00\u5904\u7406\u9886\u57df\uff0cTransformer \u6a21\u578b\u5df2\u6210\u4e3a\u4e00\u9879\u9769\u547d\u6027\u7684\u6280\u672f\u3002\u7136\u800c\uff0c\u5176\u6838\u5fc3\u7684\u81ea\u6ce8\u610f\u529b\u673a\u5236\u672c\u8eab\u5e76\u4e0d\u5177\u5907\u6355\u6349\u5e8f\u5217\u4e2d\u5355\u8bcd\u987a\u5e8f\u7684\u80fd\u529b\uff0c\u5373\u201c\u4f4d\u7f6e\u65e0\u5173\u6027\u201d\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\uff0c\u4f4d\u7f6e\u7f16\u7801\u5e94\u8fd0\u800c\u751f\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#absolute-position-encoding","title":"\u7edd\u5bf9\u4f4d\u7f6e\u7f16\u7801\uff08Absolute Position Encoding\uff09","text":"<p>\u7ed9\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e2a\u4f4d\u7f6e\u4e00\u4e2a\u552f\u4e00\u7684\u5411\u91cf\uff0c\u628a\u4f4d\u7f6e\u4fe1\u606f\u76f4\u63a5\u52a0\u5230 token embedding \u4e0a\u3002</p> <ol> <li>\u56fa\u5b9a\u5f0f\uff1a\u4e0d\u7528\u5b66\u4e60\u53c2\u6570\uff0c\u80fd\u63a8\u5e7f\u5230\u6bd4\u8bad\u7ec3\u65f6\u66f4\u957f\u7684\u5e8f\u5217    \u5728\u6700\u521d\u7684 Transformer \u8bba\u6587\u300aAttention Is All You Need\u300b\u4e2d\uff0c\u4f5c\u8005\u4f7f\u7528\u6b63\u5f26\u548c\u4f59\u5f26\u51fd\u6570\u6765\u751f\u6210\u8fd9\u4e9b\u4f4d\u7f6e\u7f16\u7801\u3002\u5176\u6570\u5b66\u8868\u8fbe\u5f0f\u5982\u4e0b\uff1a</li> </ol> \\[ \\\\begin{aligned} PE\\_{(pos, 2i)} &amp;= \\\\sin\\\\left(\\\\frac{pos}{10000^{2i/d\\_{model}}}\\\\right) \\\\ PE\\_{(pos, 2i+1)} &amp;= \\\\cos\\\\left(\\\\frac{pos}{10000^{2i/d\\_{model}}}\\\\right) \\\\end{aligned} \\] <ol> <li>\u53ef\u5b66\u4e60\u5f0f\uff1a\u6a21\u578b\u53ef\u4ee5\u5b66\u5230\u9002\u5408\u4efb\u52a1\u7684\u4f4d\u7f6e\u4fe1\u606f\u3002\u8bad\u7ec3\u65f6\u6ca1\u89c1\u8fc7\u7684\u957f\u5e8f\u5217\u53ef\u80fd\u65e0\u6cd5\u6cdb\u5316    $$    PE_{pos} = \\text{Embedding}(pos)    $$</li> </ol>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#relative-position-encoding","title":"\u76f8\u5bf9\u4f4d\u7f6e\u7f16\u7801\uff08Relative Position Encoding\uff09","text":"<p>\u76f8\u5bf9\u4f4d\u7f6e\u7f16\u7801\u662f\u6839\u636e\u5355\u8bcd\u4e4b\u95f4\u7684\u76f8\u5bf9\u4f4d\u7f6e\u5173\u7cfb\u6765\u8ba1\u7b97\u4f4d\u7f6e\u7f16\u7801\u3002\u8fd9\u79cd\u7f16\u7801\u65b9\u5f0f\u66f4\u52a0\u7075\u6d3b\uff0c\u80fd\u591f\u6355\u6349\u5230\u4e0d\u540c\u5355\u8bcd\u4e4b\u95f4\u7684\u76f8\u5bf9\u4f4d\u7f6e\u4fe1\u606f\uff0c\u6709\u52a9\u4e8e\u6a21\u578b\u66f4\u597d\u5730\u7406\u89e3\u5e8f\u5217\u4e2d\u5355\u8bcd\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u4f46\u662f\u4e5f\u6709\u7f3a\u70b9\uff0c\u8ba1\u7b97\u6548\u7387\u4f4e\u4e0b\uff0c\u540c\u65f6\u5927\u90e8\u5206\u76f8\u5bf9\u7f16\u7801\u90fd\u6ca1\u6709\u843d\u5730\u53ef\u884c\u6027\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#rotary-position-embedding-rope","title":"Rotary Position Embedding (RoPE)","text":"<p>\u5c06\u4f4d\u7f6e\u7f16\u7801\u4e0e\u8bcd\u5411\u91cf\u901a\u8fc7\u65cb\u8f6c\u77e9\u9635\u76f8\u4e58\uff0c\u4f7f\u5f97\u8bcd\u5411\u91cf\u4e0d\u4ec5\u5305\u542b\u8bcd\u6c47\u7684\u8bed\u4e49\u4fe1\u606f\uff0c\u8fd8\u878d\u5165\u4e86\u4f4d\u7f6e\u4fe1\u606f</p> \\[ (R_mq)^T(R_nk) = q^TR_m^TR_nk = q^TR\\_{m-n}k \\] <p>\u7ed9\u4f4d\u7f6e\u4e3a m \u7684\u5411\u91cf q \u4e58\u4e0a\u77e9\u9635\\((R_m\\))\u3001\u4f4d\u7f6e\u4e3a n \u7684\u5411\u91cf k \u4e58\u4e0a\u77e9\u9635\\((R_n\\))\u7528\u53d8\u6362\u540e\u7684 Q,K \u5e8f\u5217\u505a Attention\uff0cAttention \u5c31\u81ea\u52a8\u5305\u542b\u76f8\u5bf9\u4f4d\u7f6e\u4fe1\u606f</p> <ul> <li> <p>\u76f8\u5bf9\u4f4d\u7f6e\u611f\u77e5\uff1a\u4f7f\u7528\u7edd\u5bf9\u4f4d\u7f6e\u7f16\u7801\u6765\u8fbe\u5230\u76f8\u5bf9\u4f4d\u7f6e\u7f16\u7801\u7684\u6548\u679c\uff0cRoPE \u80fd\u591f\u81ea\u7136\u5730\u6355\u6349\u8bcd\u6c47\u4e4b\u95f4\u7684\u76f8\u5bf9\u4f4d\u7f6e\u5173\u7cfb\u3002</p> </li> <li> <p>\u65e0\u9700\u989d\u5916\u7684\u8ba1\u7b97\uff1a\u4f4d\u7f6e\u7f16\u7801\u4e0e\u8bcd\u5411\u91cf\u7684\u7ed3\u5408\u5728\u8ba1\u7b97\u4e0a\u662f\u9ad8\u6548\u7684\u3002</p> </li> <li> <p>\u9002\u5e94\u4e0d\u540c\u957f\u5ea6\u7684\u5e8f\u5217\uff1aRoPE \u53ef\u4ee5\u7075\u6d3b\u5904\u7406\u4e0d\u540c\u957f\u5ea6\u7684\u8f93\u5165\u5e8f\u5217\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#_1","title":"\u76ee\u7684","text":"<p>\u6211\u4eec\u5047\u8bbe\u901a\u8fc7\u4e0b\u8ff0\u8fd0\u7b97\u6765\u7ed9 q,k \u6dfb\u52a0\u7edd\u5bf9\u4f4d\u7f6e\u4fe1\u606f\uff1a [ \\tilde{q}_m = f(q, m), \\quad \\tilde{k}_n = f(k, n) \\tag{1} ]</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u5206\u522b\u4e3a q,k \u8bbe\u8ba1\u64cd\u4f5c\\(f(\\\\cdot,m),f(\\\\cdot,n)\\)\uff0c\u4f7f\u5f97\u7ecf\u8fc7\u8be5\u64cd\u4f5c\u540e\uff0c\\(\\\\tilde{q}\\_m,\\\\tilde{k}\\_n\\)\u5c31\u5e26\u6709\u4e86\u4f4d\u7f6e m,n \u7684\u7edd\u5bf9\u4f4d\u7f6e\u4fe1\u606f\u3002Attention \u7684\u6838\u5fc3\u8fd0\u7b97\u662f\u5185\u79ef\uff0c\u6240\u4ee5\u6211\u4eec\u5e0c\u671b\u7684\u5185\u79ef\u7684\u7ed3\u679c\u5e26\u6709\u76f8\u5bf9\u4f4d\u7f6e\u4fe1\u606f\uff0c\u56e0\u6b64\u5047\u8bbe\u5b58\u5728\u6052\u7b49\u5173\u7cfb\uff1a</p> \\[ \u27e8f(q,m),f(k,n)\u27e9=g(q,k,m\u2212n)\\\\tag{2} \\] <p>\u6240\u4ee5\u6211\u4eec\u8981\u6c42\u51fa\u8be5\u6052\u7b49\u5f0f\u7684\u4e00\u4e2a\uff08\u5c3d\u53ef\u80fd\u7b80\u5355\u7684\uff09\u89e3\u3002\u6c42\u89e3\u8fc7\u7a0b\u8fd8\u9700\u8981\u4e00\u4e9b\u521d\u59cb\u6761\u4ef6\uff0c\u663e\u7136\u6211\u4eec\u53ef\u4ee5\u5408\u7406\u5730\u8bbe \\(f(q,0)=q\\) \u548c \\(f(k,0)=k\\)</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#_2","title":"\u5b9e\u73b0","text":"<p>\u4f4d\u7f6e m \u7684\u7f16\u7801\u8fdb\u884c\u89e3\u65b9\u7a0b\uff0c\u6211\u4eec\u5f97\u5230\u4e8c\u7ef4\u60c5\u51b5\u4e0b\u7528\u590d\u6570\u8868\u793a\u7684 RoPE\uff1a</p> \\[ f(q, m) = R\\*f(q, m) e^{i \\\\theta f(q,m)} = |q| e^{i(\\\\Theta(q) + m\\\\theta)} = qe^{im\\\\theta} \\\\tag{3} \\] <p>\u77e9\u9635\u5f62\u5f0f\uff1a</p> \\[ f(q, m) = \\\\begin{pmatrix} \\\\cos (m\\\\theta) &amp; -\\\\sin (m\\\\theta) \\\\ \\\\sin (m\\\\theta) &amp; \\\\cos (m\\\\theta) \\\\end{pmatrix} \\\\begin{pmatrix} q_0 \\\\ q_1 \\\\end{pmatrix} \\\\tag{4} \\] <p>\u7531\u4e8e\u5185\u79ef\u6ee1\u8db3\u7ebf\u6027\u53e0\u52a0\u6027\uff0c\u56e0\u6b64\u4efb\u610f\u5076\u6570\u7ef4\u7684 RoPE\uff0c\u6211\u4eec\u90fd\u53ef\u4ee5\u8868\u793a\u4e3a\u4e8c\u7ef4\u60c5\u5f62\u7684\u62fc\u63a5\uff0c\u5373</p> <p>  \u7531\u4e8e\\((R_m\\))\u5177\u6709\u7a00\u758f\u6027\uff0c\u4e0d\u5efa\u8bae\u4f7f\u7528 matmul \u8fdb\u884c\u5b9e\u73b0\uff0c\u5efa\u8bae\u4f7f\u7528\u4e0b\u9762\u7684\u65b9\u5f0f\u5b9e\u73b0\uff1a\u5176\u4e2d\\((\\\\odot\\))\u662f\u9010\u4f4d\u5bf9\u5e94\u76f8\u4e58\uff0c\u5373 Numpy\u3001Tensorflow \u7b49\u8ba1\u7b97\u6846\u67b6\u4e2d\u7684 \u2217 \u8fd0\u7b97</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#attention-series","title":"Attention Series","text":"<ul> <li>\u5728 MHA (Multi Head Attention) \u4e2d\uff0c\u6bcf\u4e2a\u5934\u6709\u81ea\u5df1\u5355\u72ec\u7684 key-value \u5bf9\uff1b\u6807\u51c6\u7684\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\uff0ch \u4e2a Query\u3001Key \u548c Value \u77e9\u9635\u3002</li> <li>\u5728 MQA (Multi Query Attention) \u4e2d\u53ea\u4f1a\u6709\u4e00\u7ec4 key-value \u5bf9\uff1b\u591a\u67e5\u8be2\u6ce8\u610f\u529b\u7684\u4e00\u79cd\u53d8\u4f53\uff0c\u4e5f\u662f\u7528\u4e8e\u81ea\u56de\u5f52\u89e3\u7801\u7684\u4e00\u79cd\u6ce8\u610f\u529b\u673a\u5236\u3002\u4e0e MHA \u4e0d\u540c\u7684\u662f\uff0cMQA \u8ba9\u6240\u6709\u7684\u5934\u4e4b\u95f4\u5171\u4eab\u540c\u4e00\u4efd Key \u548c Value \u77e9\u9635\uff0c\u6bcf\u4e2a\u5934\u53ea\u5355\u72ec\u4fdd\u7559\u4e86\u4e00\u4efd Query \u53c2\u6570\uff0c\u4ece\u800c\u5927\u5927\u51cf\u5c11 Key \u548c Value \u77e9\u9635\u7684\u53c2\u6570\u91cf\u3002</li> <li>\u5728 GQA (Grouped Query Attention) \u4e2d\uff0c\u4f1a\u5bf9 attention \u8fdb\u884c\u5206\u7ec4\u64cd\u4f5c\uff0cquery \u88ab\u5206\u4e3a N \u7ec4\uff0c\u6bcf\u4e2a\u7ec4\u5171\u4eab\u4e00\u4e2a Key \u548c Value \u77e9\u9635 GQA \u5c06\u67e5\u8be2\u5934\u5206\u6210 G \u7ec4\uff0c\u6bcf\u4e2a\u7ec4\u5171\u4eab\u4e00\u4e2a Key \u548c Value \u77e9\u9635\u3002</li> <li>GQA-G \u662f\u6307\u5177\u6709 G \u7ec4\u7684 grouped-query attention\u3002     &gt; GQA-1 \u5177\u6709\u5355\u4e2a\u7ec4\uff0c\u56e0\u6b64\u5177\u6709\u5355\u4e2a Key \u548c Value\uff0c\u7b49\u6548\u4e8e MQA\u3002\u800c GQA-H \u5177\u6709\u4e0e\u5934\u6570\u76f8\u7b49\u7684\u7ec4\uff0c\u7b49\u6548\u4e8e MHA\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#multi-head-latent-attentionmla","title":"Multi-Head Latent Attention(MLA)","text":"<p>MLA \u901a\u8fc7\u4f4e\u79e9\u8054\u5408\u538b\u7f29\u6280\u672f\uff0c\u51cf\u5c11\u4e86\u63a8\u7406\u65f6\u7684\u952e\u503c\uff08KV\uff09\u7f13\u5b58\uff0c\u4ece\u800c\u5728\u4fdd\u6301\u6027\u80fd\u7684\u540c\u65f6\u663e\u8457\u964d\u4f4e\u4e86\u5185\u5b58\u5360\u7528</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#_3","title":"\u516c\u5f0f","text":"<ul> <li>\u5728\u8bad\u7ec3\u9636\u6bb5\uff0c\u9664\u4e86\u591a\u4e86\u4e00\u6b65\u4f4e\u79e9\u6295\u5f71\u4ee5\u53ca\u53ea\u5728\u90e8\u5206\u7ef4\u5ea6\u52a0 RoPE \u5916\uff0cMLA \u4e0e Q\u3001K \u7684\u8ba1\u7b97\u4e0e MHA \u662f\u57fa\u672c\u76f8\u540c\u7684 <p>RoPE \u7684\\(R_m\\)\u8ba1\u7b97\u540e\u6295\u5f71\u77e9\u9635\u4e0e\u4f4d\u7f6e\u76f8\u5173\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5bf9 Q \u548c K \u7684\u4f4e\u79e9\u6295\u5f71\u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u4e00\u90e8\u5206\u662f\u539f\u59cb\u7684\u6295\u5f71\u77e9\u9635\uff0c\u53e6\u4e00\u90e8\u5206\u662f\u4e0e\u4f4d\u7f6e\u76f8\u5173\u7684\u6295\u5f71\u77e9\u9635</p> </li> <li>\u5728\u63a8\u7406\u9636\u6bb5\uff0cMLA \u7684\u8ba1\u7b97\u53ef\u4ee5\u7b49\u6548\u4e3a\u4e00\u4e2a MQA</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#_4","title":"\u6295\u5f71\u77e9\u9635\u5438\u6536","text":"<p>\u5728\u63a8\u7406\u9636\u6bb5\uff0c\u6211\u4eec\u5229\u7528</p> \\[ q_t^{(s)}k_i^{(s)T} = (x_tW^{(s)}\\_q)(c_iW^{(s)}\\_k)^T = x_t(W^{(s)}\\_qW^{(s)T}\\_k)c_i^T \\] <p>\u5c06 \\((W^{(s)}\\_qW^{(s)T}\\_k)\\) \u5408\u5e76\u8d77\u6765\u4f5c\u4e3a Q \u7684\u6295\u5f71\u77e9\u9635\uff0c\u90a3\u4e48 \\(c_i\\) \u5219\u53d6\u4ee3\u4e86\u539f\u672c\u7684 \\(k_i\\)\uff0c\u540c\u7406\uff0c\u5728 \\(o_t\\) \u540e\u9762\u6211\u4eec\u8fd8\u6709\u4e00\u4e2a\u6295\u5f71\u77e9\u9635\uff0c\u4e8e\u662f \\(v^(s)\\_i=c_iW^{(s)}\\_v\\) \u7684 \\(W^{(s)}\\_v\\) \u4e5f\u53ef\u4ee5\u5438\u6536\u5230\u540e\u9762\u7684\u6295\u5f71\u77e9\u9635\u4e2d\u53bb\uff0c\u4e5f\u5c31\u662f\u8bf4\u6b64\u65f6 KV Cache \u53ea\u9700\u8981\u5b58\u4e0b\u6240\u6709\u7684 \\(c_i\\) \u5c31\u884c\uff0c\u800c\u4e0d\u81f3\u4e8e\u5b58\u4e0b\u6240\u6709\u7684 \\(k^{(s)}\\_i\u3001v^{(s)}\\_i\\)\u3002\u6ce8\u610f\u5230 \\(c_i\\)\u8ddf\\(^{(s)}\\)\u65e0\u5173\uff0c\u4e5f\u5c31\u662f\u8bf4\u662f\u6240\u6709\u5934\u5171\u4eab\u7684\uff0c\u5373 MLA \u5728\u63a8\u7406\u9636\u6bb5\u5b83\u53ef\u4ee5\u6052\u7b49\u53d8\u6362\u4e3a\u4e00\u4e2a MQA\u3002</p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#rope","title":"RoPE \u89e3\u8026","text":"<p>\u4e3a RoPE \u662f\u4e00\u4e2a\u8ddf\u4f4d\u7f6e\u76f8\u5173\u5206\u5757\u5bf9\u89d2\u77e9\u9635\\(R_m\\)\uff0c\u6ee1\u8db3\\(R_mR^\u22a4_n=R_{m\u2212n}\\)\uff0cMLA \u52a0\u5165 RoPE \u4e4b\u540e\u4f1a\u8ba9\u56fa\u5b9a\u7684\u6295\u5f71\u77e9\u9635\u4e0e\u4f4d\u7f6e\u76f8\u5173\uff1a</p> \\[ q^{(s)}\\_i=x_iW^{(s)}\\_qR_i,k^{(s)}\\_i=x_iW^{(s)}\\_kR_i \\] \\[ q^{(s)}\\_tk^{(s)T}\\_i=(x_tW^{(s)}\\_q)(c_iW^{(s)}\\_k)^T = x_t(W^{(s)}\\_qR\\_{t-i} W^{(s)T}\\_k)c_i^T \\] <p>\u8fd9\u91cc\u7684 \\(W^{(s)}_qR_{t-i} W^{(s)T}\\_k\\) \u5c31\u65e0\u6cd5\u5408\u5e76\u4e3a\u4e00\u4e2a\u56fa\u5b9a\u7684\u6295\u5f71\u77e9\u9635\u4e86\uff08\u8ddf\u4f4d\u7f6e\u5dee \\(t\u2212i\\) \u76f8\u5173\uff09\uff0c\u4ece\u800c MLA \u7684\u60f3\u6cd5\u65e0\u6cd5\u7ed3\u5408 RoPE \u5b9e\u73b0\u3002</p> <p>\u6bcf\u4e2a Attention Head \u7684 Q\u3001K \u65b0\u589e \\(d_r\\) \u4e2a\u7ef4\u5ea6\u7528\u6765\u6dfb\u52a0 RoPE\uff0c\u5176\u4e2d K \u65b0\u589e\u7684\u7ef4\u5ea6\u6bcf\u4e2a Head \u5171\u4eab\uff1a</p> \\[ o_t = \\\\big[o_t^{(1)}, o_t^{(2)}, \\\\cdots, o_t^{(h)} ,\\\\big] \\] \\[ o_t^{(s)} = Attention!\\\\left(q_t^{(s)}, k\\_{\\\\le t}^{(s)}, v\\_{\\\\le t}^{(s)}\\\\right) = \\\\frac{\\\\sum\\_{i \\\\le t} \\\\exp!\\\\left(q_t^{(s)} k_i^{(s)\\\\top}\\\\right) v_i^{(s)}} {\\\\sum\\_{i \\\\le t} \\\\exp!\\\\left(q_t^{(s)} k_i^{(s)\\\\top}\\\\right)} \\] \\[ q_i^{(s)} = [x_i W\\_{qc}^{(s)},x_i W\\_{qr}^{(s)}R_i] ,\\\\quad k_i^{(s)} = [c_i W\\_{kc}^{(s)},x_i W\\_{kr}R_i] ,\\\\quad v_i^{(s)} = c_i W_v^{(s)}, \\\\quad c_i = x_i W_c \\]","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#normalization","title":"Normalization","text":"<ul> <li>LayerNorm: \u5bf9\u67d0\u4e2a\u6837\u672c\u7684\u6240\u6709\u7279\u5f81\u7ef4\u5ea6\u8fdb\u884c\u5f52\u4e00\u5316</li> </ul> <p>$$   \\text{LayerNorm}(x) = \\frac{x - \\mu}{\\sigma} \\cdot \\gamma + \\beta   $$</p> <ul> <li>RMSNorm: \u7b80\u5316\u7248\u7684 LayerNorm\uff0c\u5b83\u4e0d\u51cf\u53bb\u5747\u503c\uff0c\u53ea\u57fa\u4e8e\u5e73\u65b9\u5747\u503c (Root Mean Square) \u6765\u5f52\u4e00\u5316   $$   \\text{RMSNorm}(x) = \\frac{x}{\\sqrt{\\frac{1}{d}\\sum_{i=1}^{d} x_i^2 + \\epsilon}} \\cdot w   $$</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#why-rmsnorm","title":"Why RMSNorm?","text":"<ul> <li>Layer-Norm \u548c RMS-Norm \u5728\u6d4b\u8bd5\u96c6\u6548\u679c\u4e0a\u6ca1\u6709\u660e\u663e\u5dee\u5f02\uff0c\u57fa\u672c\u6301\u5e73</li> <li>RMS-Norm \u7684\u8ba1\u7b97\u6548\u7387\u8981\u66f4\u9ad8</li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#feed-forward-network-ffn","title":"Feed Forward Network (FFN)","text":"<ul> <li> <p>MLP: \u4e24\u5c42\u5168\u8fde\u63a5\u7f51\u7edc\uff0c\u4e2d\u95f4\u4f7f\u7528\u975e\u7ebf\u6027\u6fc0\u6d3b\u51fd\u6570\uff08\u5982 ReLU \u6216 SiLU\uff09   $$   \\text{FFN}(x) = \\text{ReLU}(0, xW_1)W_2   $$</p> </li> <li> <p>SwiGLU: \u4f7f\u7528 SiLU \u6fc0\u6d3b\u51fd\u6570\u7684\u53d8\u4f53\u5e76\u589e\u52a0\u95e8\u63a7\u673a\u5236   $$   \\begin{aligned}   \\text{SwiGLU}(x) &amp;= (\\text{Swish}(xW_1);\\odot;xW_2) \\   \\text{Swish}(x) &amp;= x \\cdot \\sigma(x)   \\end{aligned}   $$</p> </li> <li> <p>Mixture of Experts (MoE): \u591a\u4e2a\u4e13\u5bb6\u7f51\u7edc\u7684\u96c6\u5408\uff0c\u6bcf\u4e2a\u8f93\u5165\u6837\u672c\u901a\u8fc7\u4e00\u4e2a\u8def\u7531\u5668\u9009\u62e9\u90e8\u5206\u4e13\u5bb6\u8fdb\u884c\u5904\u7406\uff0c\u4ece\u800c\u63d0\u9ad8\u6a21\u578b\u7684\u8868\u8fbe\u80fd\u529b</p> </li> <li> <p>Switch Transformer\uff1aTop-1 gating\uff0c\u6bcf\u4e2a token \u53ea\u53bb 1 \u4e2a\u4e13\u5bb6\u3002</p> </li> <li>GShard / GLaM\uff1aTop-2 gating\uff0c\u6bcf\u4e2a token \u8d70 2 \u4e2a\u4e13\u5bb6\uff0c\u7ed3\u679c\u52a0\u6743\u3002 </li> </ul>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#llama2","title":"LLAMA2 \u6a21\u578b\u7ed3\u6784","text":"<ul> <li> <p>\u76f8\u8f83\u4e8e Transformer\uff0cllama2 \u4f7f\u7528\u4e86 pre-norm \u7ed3\u6784</p> </li> <li> <p>\u4f7f\u7528 RMSNorm \u66ff\u4ee3 LayerNorm\uff0c\u4e0d\u8ba1\u7b97\u6837\u672c\u5747\u503c</p> </li> <li> <p>\u4f7f\u7528 Rotary Positional Encoding (RoPE)\uff0c\u7528\u7edd\u5bf9\u7f16\u7801\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u76f8\u5bf9\u4f4d\u7f6e\u7f16\u7801</p> </li> <li> <p>\u4f7f\u7528 GQA (Grouped-Query Attention)\uff0c\u5e73\u8861\u6548\u7387\u548c\u6027\u80fd</p> </li> <li> <p>\u4f7f\u7528 SwiGLU \u66ff\u4ee3\u7b80\u5355\u7684 MLP\uff0c\u6fc0\u6d3b\u51fd\u6570\u4f7f\u7528 SiLU</p> </li> </ul> <p>$$   \\begin{aligned}   \\text{SwiGLU}(x) &amp;= \\text{Swish}(xW_1+b_1);\\odot;(xW_2+b_2) \\   \\text{Swish}(x) &amp;= x \\cdot \\sigma(x)   \\end{aligned}   $$</p> <p></p>","tags":["LLMInference"]},{"location":"notes/llm_inference/transformerbasedllm/#_5","title":"\u53c2\u8003\u8d44\u6599","text":"<ol> <li>\u7ed3\u6784\u7bc7| \u6d45\u6790 LLaMA \u7f51\u7edc\u67b6\u6784</li> <li>\u82cf\u5251\u6797. (Mar. 23, 2021). \u300aTransformer \u5347\u7ea7\u4e4b\u8def\uff1a2\u3001\u535a\u91c7\u4f17\u957f\u7684\u65cb\u8f6c\u5f0f\u4f4d\u7f6e\u7f16\u7801 \u300b[Blog post]. Retrieved from https://kexue.fm/archives/8265</li> <li>\u82cf\u5251\u6797. (May. 13, 2024). \u300a\u7f13\u5b58\u4e0e\u6548\u679c\u7684\u6781\u9650\u62c9\u626f\uff1a\u4ece MHA\u3001MQA\u3001GQA \u5230 MLA \u300b[Blog post]. Retrieved from https://spaces.ac.cn/archives/10091</li> <li>DeepSeek-V2: A Strong, Economical, and Efficient    Mixture-of-Experts Language Model</li> <li>Root Mean Square Layer Normalization</li> <li>Switch Transformers: Scaling to Trillion Parameter Models with Simple and Efficient Sparsity</li> </ol>","tags":["LLMInference"]},{"location":"notes/minilsm/week1-day1/","title":"Memtables","text":"2025-04-032025-12-10 <code>#MiniLSM</code> <code>#rust</code>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#memtables","title":"Memtables","text":"<p> \u7ea6 1432 \u4e2a\u5b57  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> <ul> <li>\u5c06 KV \u5bf9\u9996\u5148\u63d2\u5165\u5230 Memtable \u4e2d\uff0c\u8be5 Memtable \u5728\u5185\u5b58\u4e2d\u53ea\u6709\u4e00\u4e2a</li> </ul> <p></p> <ul> <li>\u5982\u679c Memtable \u5df2\u7ecf\u88c5\u6ee1\uff0c\u4f1a\u89e6\u53d1 frozen\uff0c\u5c06 memtable \u8f6c\u53d8\u4e3a immemtable\uff0c\u91cd\u65b0\u521b\u5efa\u65b0\u7684 memtable \u6765\u7ed9 KV \u5bf9\u63d2\u5165</li> </ul> <p></p>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#understanding-of-memtable-implement","title":"Understanding of Memtable Implement","text":"","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#1-why-doesnt-the-memtable-provide-a-delete-api","title":"1. Why doesn't the memtable provide a delete API?","text":"<ul> <li>lsm-tree \u662f append-only \u7ed3\u6784\uff0cdelete \u64cd\u4f5c\u662f\u628a\u4e00\u4e2a\u5893\u7891\u6807\u8bb0\u63d2\u5165 memtable</li> <li>\u8fd9\u79cd\u65b9\u5f0f\u5c06 delete \u7684\u968f\u673a\u5199\u8f6c\u53d8\u4e3a\u987a\u5e8f\u5199\uff0c\u66f4\u6709\u5229\u4e8e\u5199</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#2-does-it-make-sense-for-the-memtable-to-store-all-write-operations-instead-of-only-the-latest-version-of-a-key-for-example-the-user-puts-a-1-a-2-and-a-3-into-the-same-memtable","title":"2. Does it make sense for the memtable to store all write operations instead of only the latest version of a key? For example, the user puts a-&gt;1, a-&gt;2, and a-&gt;3 into the same memtable.","text":"<ul> <li>\u6709\u9053\u7406\u7684\uff0c\u5982\u679c\u9700\u8981\u66f4\u65b0\u6700\u65b0\u503c\uff0c\u65e0\u6cd5\u53d1\u6325\u987a\u5e8f\u5199\u7684\u4f18\u52bf\uff0c\u540e\u7eed\u7684 write_batch \u4e5f\u5c31\u65e0\u4ece\u8c08\u8d77\u4e86</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#3-is-it-possible-to-use-other-data-structures-as-the-memtable-in-lsm-what-are-the-proscons-of-using-the-skiplist","title":"3. Is it possible to use other data structures as the memtable in LSM? What are the pros/cons of using the skiplist?","text":"<ul> <li>SLM-DB \u8bba\u6587\u4e2d\u63d0\u51fa\u53ef\u4ee5\u7528 B+\u6811\u4f5c\u4e3a\u5185\u5b58\u7d22\u5f15\uff1bOceanbase \u4f7f\u7528\u7684\u5b58\u50a8\u5f15\u64ce\u4e5f\u662f lsm-tree based\uff0c\u5b83\u7684 memtable \u4f7f\u7528 B+tree \u6216\u8005 hash index</li> <li>\u4f7f\u7528\u8df3\u8868\u4f18\u70b9 <p>\u63d2\u5165\u3001\u5220\u9664\u3001\u67e5\u627e\u90fd\u662f O(logn)\u7ea7\u522b\uff0c\u5b9e\u73b0\u7b80\u5355\\ \u5929\u7136\u6709\u5e8f\\ \u5e76\u53d1\u63a7\u5236\u7b80\u5355</p> </li> <li>\u8df3\u8868\u7f3a\u70b9 <p>\u5199\u653e\u5927\\ \u5220\u9664\u64cd\u4f5c\u53ef\u80fd\u7ea7\u8054\u64cd\u4f5c\u591a\u7ea7\u6307\u9488</p> </li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#4-why-do-we-need-a-combination-of-state-and-state_lock-can-we-only-use-stateread-and-statewrite","title":"4. Why do we need a combination of state and state_lock? Can we only use state.read() and state.write()?","text":"<ul> <li>\u5fc5\u987b\u7528\u7ec4\u5408\u624d\u80fd\u4fdd\u8bc1\u771f\u6b63\u7684\u5e76\u53d1\u5b89\u5168</li> <li>\u5728 force_freeze_memtable \u4e2d\uff0c\u8003\u8651\u591a\u4e2a\u7ebf\u7a0b\u901a\u8fc7 ReadGuard \u5e76\u53d1 put \u6216\u8005 flush\uff0c\u5224\u65ad memtable \u6ee1\u4e86\u8fdb\u884c frozen\uff1b\u8fd9\u4e2a\u903b\u8f91\u5982\u679c\u6ca1\u6709\u4e00\u628a mutex \u6765\u4fdd\u62a4\uff0c\u4f1a\u51fa\u73b0\u95ee\u9898 <p>\u53ef\u80fd memtable \u5df2\u7ecf\u88ab\u5176\u4ed6\u7ebf\u7a0b\u7ed9 frozen \u4e86\uff0c\u53c8\u518d\u6b21 frozen\uff0c\u540e frozen \u7684 memtable \u6ca1\u6709\u8fbe\u5230\u5927\u5c0f\u9650\u5236</p> </li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#5-why-does-the-order-to-store-and-to-probe-the-memtables-matter-if-a-key-appears-in-multiple-memtables-which-version-should-you-return-to-the-user","title":"5. Why does the order to store and to probe the memtables matter? If a key appears in multiple memtables, which version should you return to the user?","text":"<ul> <li>\u56e0\u4e3a\u6211\u4eec\u59cb\u7ec8\u9700\u8981\u4fdd\u8bc1\u540e Put \u7684\u6570\u636e\u53ef\u4ee5\u9996\u5148\u88ab Get \u5230\uff0c\u4fdd\u8bc1\u7528\u6237\u53ef\u4ee5\u770b\u5230\u6700\u65b0\u7684\u6570\u636e</li> <li>\u5982\u679c\u5b58\u5728\u6700\u65b0\u7684\u7248\u672c\uff0c\u6211\u4eec\u5e94\u8be5\u8fd4\u56de\u5728\u8be5\u4e8b\u52a1\u63d0\u4ea4\u524d\u7684\u6700\u65b0\u7684\u6570\u636e</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#6-is-the-memory-layout-of-the-memtable-efficient-does-it-have-good-data-locality-think-of-how-byte-is-implemented-and-stored-in-the-skiplist-what-are-the-possible-optimizations-to-make-the-memtable-more-efficient","title":"6. Is the memory layout of the memtable efficient / does it have good data locality? (Think of how Byte is implemented and stored in the skiplist...) What are the possible optimizations to make the memtable more efficient?","text":"<ul> <li> <p>\u5982\u679c\u662f\u77ed\u6570\u636e\uff0cByte \u4f1a\u5185\u8054\u5b58\u50a8\u5728\u7ed3\u6784\u4f53\u4e2d\uff0c\u5185\u5b58\u8fde\u7eed\uff1b\u5bf9\u5927\u503c\uff08\u5982\u8d85\u8fc7 1KB \u7684 Blob\uff09\uff0cBytes \u901a\u8fc7\u5f15\u7528\u8ba1\u6570\u5171\u4eab\u5e95\u5c42 Vec\uff0c\u907f\u514d\u590d\u5236</p> </li> <li> <p>\u95f4\u63a5\u6307\u9488\u8bbf\u95ee\u4f1a\u589e\u52a0\u5185\u5b58\u95f4\u63a5\u6027\uff0c\u5f71\u54cd\u9884\u53d6\u6548\u7387</p> </li> <li> <p>Byte \u5143\u6570\u636e\u5360\u7528\u989d\u5916\u5185\u5b58\uff0c\u5982\u679c\u4f7f\u7528\u5185\u90e8\u5185\u5b58\u5206\u914d\uff0c\u53ef\u80fd\u9020\u6210\u5185\u5b58\u4e0d\u8fde\u7eed</p> </li> <li> <p>\u4f18\u5316</p> </li> </ul> <p>\u6784\u9020\u7edf\u4e00\u7684\u5185\u5b58\u5206\u914d\u5668\uff0c\u540c\u4e00\u5206\u914d\u5185\u5b58\\ \u5c06 key \u548c value \u5206\u5f00\u5b58\u50a8</p>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#7-so-we-are-using-parking_lot-locks-in-this-course-is-its-read-write-lock-a-fair-lock-what-might-happen-to-the-readers-trying-to-acquire-the-lock-if-there-is-one-writer-waiting-for-existing-readers-to-stop","title":"7. So we are using parking_lot locks in this course. Is its read-write lock a fair lock? What might happen to the readers trying to acquire the lock if there is one writer waiting for existing readers to stop?","text":"<ul> <li>\u5bf9\u5199\u8005\u5e76\u4e0d\u516c\u5e73\uff0c\u5982\u679c\u591a\u4e2a\u8bfb\u8005\u4e00\u76f4\u5728\u8bfb\uff0c\u5199\u8005\u4f1a\u4e00\u76f4\u963b\u585e</li> <li>\u5982\u679c\u6709\u4e00\u4e2a\u5199\u8005\u5728\u5199\uff0c\u5c31\u4f1a\u963b\u585e\u6240\u6709\u8bfb\u8005\u7684\u8bfb\u64cd\u4f5c</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#8-after-freezing-the-memtable-is-it-possible-that-some-threads-still-hold-the-old-lsm-state-and-wrote-into-these-immutable-memtables-how-does-your-solution-prevent-it-from-happening","title":"8. After freezing the memtable, is it possible that some threads still hold the old LSM state and wrote into these immutable memtables? How does your solution prevent it from happening?","text":"<ul> <li>\u53ef\u80fd\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\uff0c\u4e24\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5728 put\uff0c\u90fd\u53d1\u73b0\u4e86\u5f53\u524d\u8d85\u8fc7\u9650\u5236\uff0c\u9700\u8981\u5f3a\u5236 frozen</li> <li>\u6211\u4eec\u7684\u89e3\u51b3\u65b9\u6848\u662f\uff1a\u83b7\u53d6\u5230 state_lock \u540e\uff0c\u518d\u6b21\u5224\u65ad\u662f\u5426\u8d85\u8fc7\u5927\u5c0f\u9650\u5236\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u6ca1\u62ff\u5230\u9501\u7684\u7ebf\u7a0b\u4e00\u5b9a\u4f1a\u5728\u65b0\u7684 memtable \u4e2d\u8fdb\u884c\u66f4\u65b0</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#9-there-are-several-places-that-you-might-first-acquire-a-read-lock-on-state-then-drop-it-and-acquire-a-write-lock-these-two-operations-might-be-in-different-functions-but-they-happened-sequentially-due-to-one-function-calls-the-other-how-does-it-differ-from-directly-upgrading-the-read-lock-to-a-write-lock-is-it-necessary-to-upgrade-instead-of-acquiring-and-dropping-and-what-is-the-cost-of-doing-the-upgrade","title":"9. There are several places that you might first acquire a read lock on state, then drop it and acquire a write lock (these two operations might be in different functions but they happened sequentially due to one function calls the other). How does it differ from directly upgrading the read lock to a write lock? Is it necessary to upgrade instead of acquiring and dropping and what is the cost of doing the upgrade?","text":"<ul> <li> <p>\u7ed3\u8bba\uff1a\u9700\u8981\u6839\u636e\u4e0d\u540c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6765\u786e\u5b9a\uff0c\u8bfb\u591a\u5199\u5c11\u7684\u8d1f\u8f7d\u5c31\u53ef\u4ee5\u91c7\u7528\u5206\u6b65\u9501\uff0c\u5199\u5c11\u8bfb\u591a\u7684\u8d1f\u8f7d\u53ef\u4ee5\u91c7\u7528\u9501\u5347\u7ea7</p> </li> <li> <p>\u200b \u5148\u91ca\u653e\u8bfb\u9501\u518d\u83b7\u53d6\u5199\u9501\uff1a</p> </li> </ul> <p>\u5728\u8fd9\u4e24\u4e2a\u64cd\u4f5c\u4e4b\u95f4\uff0c\u5176\u4ed6\u7ebf\u7a0b\u53ef\u80fd\u4f1a\u4fee\u6539\u72b6\u6001\uff0c\u5bfc\u81f4\u4e4b\u524d\u8bfb\u53d6\u7684\u4fe1\u606f\u5931\u6548\u3002\u4f8b\u5982\uff0c\u7ebf\u7a0b A \u8bfb\u53d6 memtable \u672a\u6ee1\uff0c\u91ca\u653e\u8bfb\u9501\uff0c\u6b64\u65f6\u7ebf\u7a0b B \u53ef\u80fd\u83b7\u53d6\u5199\u9501\u5e76\u586b\u6ee1 memtable\uff0c\u5bfc\u81f4\u7ebf\u7a0b A \u518d\u6b21\u83b7\u53d6\u5199\u9501\u65f6\u53d1\u73b0\u9700\u8981 flush\uff0c\u4f46\u6b64\u65f6\u53ef\u80fd\u5df2\u7ecf\u88ab\u5904\u7406\u8fc7\u4e86\uff0c\u6216\u8005\u9700\u8981\u91cd\u65b0\u68c0\u67e5\u6761\u4ef6\u3002</p> <p>\u8fd9\u53ef\u80fd\u5bfc\u81f4\u7ade\u4e89\u6761\u4ef6\u6216\u9700\u8981\u989d\u5916\u7684\u68c0\u67e5\uff0c\u6bd4\u5982\u5728\u83b7\u53d6\u5199\u9501\u540e\u518d\u6b21\u9a8c\u8bc1\u6761\u4ef6\u662f\u5426\u4ecd\u7136\u6ee1\u8db3\uff08\u5373\u201c\u53cc\u91cd\u68c0\u67e5\u201d\uff09\u3002</p> <ul> <li>\u200b \u76f4\u63a5\u5347\u7ea7\u8bfb\u9501\u5230\u5199\u9501\uff1a</li> </ul> <p>\u5347\u7ea7\u9501\u7684\u8fc7\u7a0b\u4e2d\uff0c\u8bfb\u9501\u4e0d\u4f1a\u88ab\u91ca\u653e\uff0c\u56e0\u6b64\u5176\u4ed6\u7ebf\u7a0b\u65e0\u6cd5\u5728\u4e2d\u95f4\u63d2\u5165\u4fee\u6539\uff0c\u4fdd\u8bc1\u4e86\u64cd\u4f5c\u7684\u539f\u5b50\u6027\u3002\u8fd9\u6837\uff0c\u5728\u8bfb\u53d6\u72b6\u6001\u540e\u5230\u5199\u5165\u7684\u6574\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u72b6\u6001\u4e0d\u4f1a\u88ab\u5176\u4ed6\u7ebf\u7a0b\u6539\u53d8\u3002</p> <p>\u4f46\u662f\uff0c\u9501\u5347\u7ea7\u53ef\u80fd\u5e26\u6765\u6f5c\u5728\u7684\u95ee\u9898\uff0c\u6bd4\u5982\u6b7b\u9501\u3002\u4f8b\u5982\uff0c\u5f53\u591a\u4e2a\u7ebf\u7a0b\u5c1d\u8bd5\u5347\u7ea7\u8bfb\u9501\u65f6\uff0c\u53ef\u80fd\u5f62\u6210\u5faa\u73af\u7b49\u5f85\u3002\u6b64\u5916\uff0c\u67d0\u4e9b\u9501\u5b9e\u73b0\u53ef\u80fd\u4e0d\u652f\u6301\u5347\u7ea7\uff0c\u6216\u8005\u5347\u7ea7\u64cd\u4f5c\u672c\u8eab\u9700\u8981\u4e00\u5b9a\u7684\u6210\u672c\u3002</p>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day1/#_1","title":"\u5e76\u53d1\u6027\u4e0e\u6027\u80fd","text":"<ul> <li>acquire read -&gt; drop read -&gt; acquire write</li> </ul> <p>\u200b \u4f18\u52bf\uff1a\u91ca\u653e\u8bfb\u9501\u540e\uff0c\u5176\u4ed6\u7ebf\u7a0b\u53ef\u4ee5\u7ee7\u7eed\u83b7\u53d6\u8bfb\u9501\uff0c\u63d0\u9ad8\u5e76\u53d1\u8bfb\u53d6\u6027\u80fd\u3002\\ \u52a3\u52bf\uff1a\u5199\u5165\u7ebf\u7a0b\u53ef\u80fd\u9700\u8981\u7b49\u5f85\u66f4\u957f\u65f6\u95f4\u83b7\u53d6\u5199\u9501\uff08\u56e0\u4e2d\u95f4\u5b58\u5728\u5176\u4ed6\u7ade\u4e89\uff09\u3002</p> <ul> <li>\u200b \u9501\u5347\u7ea7</li> </ul> <p>\u200b \u4f18\u52bf\uff1a\u51cf\u5c11\u5199\u9501\u7ade\u4e89\uff0c\u56e0\u4e3a\u5347\u7ea7\u65f6\u5df2\u6301\u6709\u8bfb\u9501\uff0c\u53ef\u80fd\u66f4\u5feb\u83b7\u5f97\u5199\u9501\u3002\\ \u52a3\u52bf\uff1a\u82e5\u5176\u4ed6\u7ebf\u7a0b\u6301\u6709\u8bfb\u9501\uff0c\u5347\u7ea7\u4f1a\u963b\u585e\u76f4\u5230\u6240\u6709\u8bfb\u9501\u91ca\u653e\uff08\u7c7b\u4f3c\u76f4\u63a5\u83b7\u53d6\u5199\u9501\uff09\u3002\u5728\u9ad8\u5e76\u53d1\u8bfb\u573a\u666f\u4e0b\uff0c\u53ef\u80fd\u5bfc\u81f4\u957f\u65f6\u95f4\u963b\u585e\u3002</p>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/","title":"Merge Iterator","text":"2025-04-052025-12-10 <code>#MiniLSM</code> <code>#rust</code>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#merge-iterator","title":"Merge Iterator","text":"<p> \u7ea6 1139 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> <ul> <li>\u4e00\u4e2a lsm-tree \u4f1a\u6709\u4e00\u4e2a memtable \u548c\u591a\u4e2a immumemtable\uff0c\u5728\u6267\u884c get \u6216\u8005 scan \u65f6\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u6240\u6709\u7684 memtable \u8fdb\u884c\u67e5\u8be2</li> <li>\u4e00\u822c\u6211\u4eec\u4f1a\u4f7f\u7528\u8fed\u4ee3\u5668\u8fdb\u884c scan\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5bf9\u6240\u6709\u7684 memtable \u8fdb\u884c merge \u7684 iterator</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#understanding-of-merge-iterator-implement","title":"Understanding of Merge Iterator Implement","text":"","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#1-what-is-the-timespace-complexity-of-using-your-merge-iterator","title":"1. What is the time/space complexity of using your merge iterator?","text":"<ul> <li>\u521b\u5efa\u7684\u65f6\u5019 O(n)\uff0c\u904d\u5386\u6240\u6709\u7684 iterator\uff0c\u7136\u540e store</li> <li>next \u7684\u65f6\u5019\u662f O(Clogn)\uff0c\u6bcf\u6b21\u4e0e\u5806\u4e0a\u7684\u6700\u5c0f\u503c\u8fdb\u884c\u6bd4\u8f83\uff0c\u5411\u540e\u8fed\u4ee3</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#2-why-do-we-need-a-self-referential-structure-for-memtable-iterator","title":"2. Why do we need a self-referential structure for memtable iterator?","text":"<ul> <li>\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u5904\u7406\u751f\u547d\u5468\u671f\u7684\u95ee\u9898\uff0c\u4f7f\u7528\u7b2c\u4e09\u65b9\u5e93\u7684\u8df3\u8868\uff0c\u91cc\u9762\u7684\u8fed\u4ee3\u5668\u5468\u671f\u6211\u4eec\u5f88\u96be\u5904\u7406\uff0c\u6240\u4ee5\u6211\u4eec\u4f7f\u7528\u81ea\u5f15\u7528\u7ed3\u6784\uff0c\u89c4\u907f\u8fd9\u4e2a\u95ee\u9898</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#3-if-a-key-is-removed-there-is-a-delete-tombstone-do-you-need-to-return-it-to-the-user-where-did-you-handle-this-logic","title":"3. If a key is removed (there is a delete tombstone), do you need to return it to the user? Where did you handle this logic?","text":"<ul> <li>\u4e0d\u5e94\u8be5\uff0c\u5982\u679c\u662f scan \u7684\u8bdd\uff0c\u5e94\u8be5\u76f4\u63a5\u8df3\u8f6c\u5230\u4e0b\u4e00\u4e2a\u672a\u88ab\u5220\u9664\u7684 key \u8fdb\u884c\u67e5\u8be2</li> <li>\u5728<code>lsm_iterator</code>\u6267\u884c next \u4e2d\u8fdb\u884c\u5904\u7406\uff0c\u8fd8\u6709\u521a\u521a\u521b\u5efa\u8fed\u4ee3\u5668\u8fdb\u884c\u5904\u7406 <p>\u53ef\u80fd\u626b\u63cf\u7684\u7b2c\u4e00\u4e2a key \u5c31\u662f\u5df2\u7ecf\u88ab\u5220\u9664\u7684 key</p> </li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#4-if-a-key-has-multiple-versions-will-the-user-see-all-of-them-where-did-you-handle-this-logic","title":"4. If a key has multiple versions, will the user see all of them? Where did you handle this logic?","text":"<ul> <li>\u4e0d\u4f1a\uff0c\u53ea\u4f1a\u770b\u5230\u6700\u65b0\u7684\u4e00\u4e2a</li> <li>\u5728<code>lsm_iterator</code>\u7684 next \u4e2d\u8fdb\u884c\u5904\u7406\uff0c\u6700\u524d\u9762\u7684 iterator \u4e2d\u7684\u8bb0\u5f55\u662f lastest \u7684\uff0c\u4f1a\u8986\u76d6\u5176\u4ed6 iterator \u7684\u67e5\u8be2\u7ed3\u679c</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#5-if-we-want-to-get-rid-of-self-referential-structure-and-have-a-lifetime-on-the-memtable-iterator-ie-memtableiteratora-where-a-memtable-or-lsmstorageinner-lifetime-is-it-still-possible-to-implement-the-scan-functionality","title":"5. if we want to get rid of self-referential structure and have a lifetime on the memtable iterator (i.e., MemtableIterator\\&lt;'a&gt;, where 'a = memtable or LsmStorageInner lifetime), is it still possible to implement the scan functionality?","text":"<ul> <li>\u6211\u5bf9\u8fd9\u4e2a\u4e0d\u662f\u5f88\u719f\u6089\uff0c\u4f46\u662f\u6211\u7684\u770b\u6cd5\u662f memtable \u88ab\u5237\u5199\u5230\u78c1\u76d8\u540e\uff0citerator \u4ecd\u7136\u4fdd\u5b58\u7740\u5bf9 memtable \u7684\u5f15\u7528\uff1b\u8fd9\u662f memtable \u7684\u751f\u547d\u5468\u671f\u5df2\u7ecf\u7ed3\u675f\uff0c\u8be5 iterator \u5931\u6548\uff0c\u4f46\u662f scan \u6b63\u5728\u8fdb\u884c\u8fed\u4ee3\uff0c\u51fa\u73b0\u610f\u6599\u4e4b\u5916\u7684\u9519\u8bef</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#6-what-happens-if-1-we-create-an-iterator-on-the-skiplist-memtable-2-someone-inserts-new-keys-into-the-memtable-3-will-the-iterator-see-the-new-key","title":"6. What happens if (1) we create an iterator on the skiplist memtable (2) someone inserts new keys into the memtable (3) will the iterator see the new key?","text":"<ul> <li>\u4f7f\u7528\u7684\u662f Arc\uff0c\u6240\u6709\u7684 clone \u6307\u5411\u540c\u4e00\u4efd\u539f\u59cb\u6570\u636e\uff0c\u6240\u4ee5\u4f1a\u770b\u5230\u65b0\u63d2\u5165\u7684\u6570\u636e</li> <li>\u5982\u679c\u9700\u8981\u9694\u79bb\uff0c\u5e94\u8be5\u4f7f\u7528\u9501\uff0c\u6216\u8005\u63d0\u4f9b\u7248\u672c\u673a\u5236</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#7-what-happens-if-your-key-comparator-cannot-give-the-binary-heap-implementation-a-stable-order","title":"7. What happens if your key comparator cannot give the binary heap implementation a stable order?","text":"<ul> <li>\u5bf9\u540c\u4e00\u4e2a key \u8fdb\u884c\u63d2\u5165\u3001\u5220\u9664\u3001\u518d\u63d2\u5165\uff1b\u53ef\u80fd\u987a\u5e8f\u4f1a\u88ab\u641e\u6df7\uff0c\u9020\u6210\u770b\u5230\u5df2\u7ecf\u5220\u9664\u7684 key\uff0c\u6216\u8005\u770b\u5230\u65e7\u7248\u672c\u6570\u636e</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#8-why-do-we-need-to-ensure-the-merge-iterator-returns-data-in-the-iterator-construction-order","title":"8. Why do we need to ensure the merge iterator returns data in the iterator construction order?","text":"<ul> <li>\u5c06\u591a\u4e2a\u6709\u5e8f\u6570\u636e\u6e90\uff08\u5982\u5185\u5b58\u4e2d\u7684 MemTable \u548c\u78c1\u76d8\u4e0a\u7684 SSTable\uff09\u5408\u5e76\u6210\u4e00\u4e2a\u5168\u5c40\u6709\u5e8f\u7684\u89c6\u56fe\u3002\u4e3a\u4e86\u6b63\u786e\u6027\u548c\u6027\u80fd\uff0c\u5408\u5e76\u8fed\u4ee3\u5668\u5fc5\u987b\u9075\u5faa \u200b\u200b \u8fed\u4ee3\u5668\u7684\u6784\u9020\u987a\u5e8f \u200b\u200b\uff08\u5373\u6570\u636e\u6e90\u7684\u4f18\u5148\u7ea7\u987a\u5e8f\uff09\u6765\u51b3\u5b9a\u76f8\u540c\u952e\uff08Key\uff09\u7684\u8fd4\u56de\u987a\u5e8f</li> <li>\u907f\u514d\u65e7\u6570\u636e\u8986\u76d6\u65b0\u6570\u636e\uff0c\u4fdd\u8bc1\u8bfb\u53d6\u64cd\u4f5c\u8fd4\u56de\u6700\u65b0\u503c\u3002</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#9-is-it-possible-to-implement-a-rust-style-iterator-ie-nextself-key-value-for-lsm-iterators-what-are-the-proscons","title":"9. Is it possible to implement a Rust-style iterator (i.e., next(&amp;self) -&gt; (Key, Value)) for LSM iterators? What are the pros/cons?","text":"<ul> <li>\u53ef\u884c\uff0c\u4f46\u662f\u72b6\u6001\u53d8\u66f4\u5fc5\u987b\u901a\u8fc7 \u200b \u5171\u4eab\u4e14\u53ef\u53d8\u7684\u5185\u5b58\u5b9e\u73b0\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u4fee\u6539 self <p>single thread: \u4f7f\u7528 Cell/RefCell\\ multi thread: \u4f7f\u7528 Mutex/RwLock</p> </li> <li>\u4f18\u70b9 <p>\u5171\u4eab\u8fed\u4ee3\u5668\u72b6\u6001: &amp;self \u5141\u8bb8\u8fed\u4ee3\u5668\u88ab\u591a\u4e2a\u7ebf\u7a0b\u6216\u4e0a\u4e0b\u6587\u5171\u4eab\uff08\u4f8b\u5982\u901a\u8fc7 Arc\uff09\\ lazy init: \u8fed\u4ee3\u5668\u72b6\u6001\u53ef\u4ee5\u6309\u9700\u521d\u59cb\u5316</p> </li> <li>\u7f3a\u70b9 <p>\u6027\u80fd\u5f00\u9500\uff1a\u5185\u90e8\u53ef\u53d8\u6027\u6210\u672c\uff0cRefCell \u5728\u8fd0\u884c\u65f6\u68c0\u67e5\u501f\u7528\u89c4\u5219\uff08\u53ef\u80fd\u5bfc\u81f4 panic\uff09\uff1bMutex \u5f15\u5165\u7ebf\u7a0b\u540c\u6b65\u5f00\u9500\uff08\u9501\u7ade\u4e89\uff09\\ \u53ef\u80fd\u5b58\u5728\u60ac\u5782\u5f15\u7528\uff1a\u82e5\u5916\u90e8\u6570\u636e\uff08\u5982 SSTable \u6587\u4ef6\uff09\u5728\u8fed\u4ee3\u8fc7\u7a0b\u4e2d\u88ab\u5220\u9664\uff0c\u53ef\u80fd\u5f15\u53d1\u672a\u5b9a\u4e49\u884c\u4e3a\u3002</p> </li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#10-the-scan-interface-is-like-fn-scanself-lower-boundu8-upper-boundu8-how-to-make-this-api-compatible-with-rust-style-range-ie-key_akey_b-if-you-implement-this-try-to-pass-a-full-range-to-the-interface-and-see-what-will-happen","title":"10. The scan interface is like fn scan(&amp;self, lower: Bound\\&lt;&amp;[u8]&gt;, upper: Bound\\&lt;&amp;[u8]&gt;). How to make this API compatible with Rust-style range (i.e., key_a..key_b)? If you implement this, try to pass a full range .. to the interface and see what will happen.","text":"<ul> <li>\u5b9e\u73b0\u4e86\uff0c\u9700\u8981\u6211\u4eec\u63d0\u4f9b\u65b0\u7684 trait\uff0c\u8f6c\u6362\u4e3a Bound</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#11-the-starter-code-provides-the-merge-iterator-interface-to-store-box-instead-of-i-what-might-be-the-reason-behind-that","title":"11. The starter code provides the merge iterator interface to store Box instead of I. What might be the reason behind that?","text":"","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#_1","title":"\u751f\u547d\u5468\u671f","text":"<ul> <li>\u5b50\u8fed\u4ee3\u5668\u7684\u751f\u547d\u5468\u671f\u53ef\u80fd\u4f9d\u8d56\u4e8e\u5176\u6765\u6e90\uff08\u4f8b\u5982\uff0c\u4ece MemTable \u6216 SSTable \u4e2d\u501f\u7528\u7684\u8fed\u4ee3\u5668\uff09\u3002\u82e5\u76f4\u63a5\u5b58\u50a8\u5f15\u7528\uff08\u5982 &amp;'a mut I\uff09\uff0c\u9700\u8981\u4e3a MergeIterator \u6dfb\u52a0\u590d\u6742\u7684\u751f\u547d\u5468\u671f\u53c2\u6570\u3002</li> <li>\u4f7f\u7528 Box \u5c06\u5b50\u8fed\u4ee3\u5668\u7684\u6240\u6709\u6743\u8f6c\u79fb\u5230 MergeIterator \u4e2d\uff0c\u786e\u4fdd\u8fed\u4ee3\u5668\u5728\u5408\u5e76\u8fc7\u7a0b\u4e2d\u59cb\u7ec8\u6709\u6548\uff0c\u65e0\u9700\u7ed1\u5b9a\u5916\u90e8\u751f\u547d\u5468\u671f\u3002</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day2/#_2","title":"\u5806\u5206\u914d","text":"<ul> <li>trait \u5bf9\u8c61\uff08\u5982 dyn Iterator\uff09\u7684\u5927\u5c0f\u5728\u7f16\u8bd1\u65f6\u65e0\u6cd5\u786e\u5b9a\uff0c\u65e0\u6cd5\u76f4\u63a5\u5b58\u50a8\u5728\u6808\u4e0a\u3002</li> <li>\u4f7f\u7528 Box \u5c06 Trait \u5bf9\u8c61\u5206\u914d\u5230\u5806\u4e0a\uff0c\u901a\u8fc7\u6307\u9488\u95f4\u63a5\u5f15\u7528\u3002</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/","title":"Block","text":"2025-04-062025-12-10 <code>#MiniLSM</code> <code>#rust</code>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#block","title":"Block","text":"<p> \u7ea6 800 \u4e2a\u5b57  18 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <ul> <li>\u8fd9\u91cc\u6211\u4eec\u5b9e\u73b0\u4e86 SST Block \u7684 encode \u548c decode \u4ee5\u53ca block iterator </li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#block-encoding-format","title":"Block encoding format","text":"Bash<pre><code>----------------------------------------------------------------------------------------------------\n|             Data Section             |              Offset Section             |      Extra      |\n----------------------------------------------------------------------------------------------------\n| Entry #1 | Entry #2 | ... | Entry #N | Offset #1 | Offset #2 | ... | Offset #N | num_of_elements |\n----------------------------------------------------------------------------------------------------\n</code></pre>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#entry-format","title":"Entry format","text":"<ul> <li>\u91c7\u7528\u4e0e first key \u516c\u7528\u524d\u7f00\u7684\u65b9\u5f0f</li> </ul> Bash<pre><code>-----------------------------------------------------------------------\n|                           Entry #1                            | ... |\n-----------------------------------------------------------------------\n| overlap_with_first_key (2B) | key_len (2B) | key (keylen) | value_len (2B) | value (varlen) | ... |\n-----------------------------------------------------------------------\n</code></pre>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#the-end-of-block","title":"The end of block","text":"<ul> <li>store the offsets of each entry and the total number of entries</li> </ul> Bash<pre><code>-------------------------------\n|offset|offset|num_of_elements|\n-------------------------------\n|   0  |  12  |       2       |\n-------------------------------\n</code></pre>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#test-understanding-of-block-implement","title":"Test Understanding of Block implement","text":"","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#1-what-is-the-time-complexity-of-seeking-a-key-in-the-block","title":"1. What is the time complexity of seeking a key in the block?","text":"<ul> <li>\u4f7f\u7528\u4e8c\u5206\u67e5\u627e\uff0cO(logn)</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#2-where-does-the-cursor-stop-when-you-seek-a-non-existent-key-in-your-implementation","title":"2. Where does the cursor stop when you seek a non-existent key in your implementation?","text":"<ul> <li>cursor \u4f1a\u505c\u5728 block.offsets.len()\u5904\uff0c\u6b64\u65f6\u8fd4\u56de\u7684 key \u662f\u7a7a\u7684\uff0cvalue_range \u662f(0, 0)</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#3-so-block-is-simply-a-vector-of-raw-data-and-a-vector-of-offsets-can-we-change-them-to-byte-and-arcu16-and-change-all-the-iterator-interfaces-to-return-byte-instead-of-u8-assume-that-we-use-byteslice-to-return-a-slice-of-the-block-without-copying-what-are-the-proscons","title":"3. So Block is simply a vector of raw data and a vector of offsets. Can we change them to Byte and Arc\\&lt;[u16]&gt;, and change all the iterator interfaces to return Byte instead of &amp;[u8]? (Assume that we use Byte::slice to return a slice of the block without copying.) What are the pros/cons?","text":"","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#_1","title":"\u4f18\u70b9 \u200b\u200b","text":"<ul> <li> <p>\u96f6\u62f7\u8d1d\u64cd\u4f5c \u200b\uff1aBytes \u7c7b\u578b\u5929\u7136\u652f\u6301\u96f6\u62f7\u8d1d\u5207\u7247\uff08\u901a\u8fc7 Bytes::slice\uff09\uff0c\u907f\u514d\u6570\u636e\u590d\u5236\uff0c\u5c24\u5176\u9002\u7528\u4e8e\u5927\u5757\u6570\u636e\u6216\u591a\u5904\u5171\u4eab\u7684\u573a\u666f\u3002</p> </li> <li> <p>\u7ebf\u7a0b\u5b89\u5168 \u200b\u200b\uff1aArc\\&lt;[u16]&gt; \u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u4e0d\u53ef\u53d8\u7ed3\u6784\uff0c\u5141\u8bb8\u591a\u7ebf\u7a0b\u5b89\u5168\u5171\u4eab\u504f\u79fb\u91cf\u6570\u7ec4\uff0c\u65e0\u9700\u989d\u5916\u540c\u6b65\u3002Bytes \u5185\u90e8\u901a\u8fc7\u539f\u5b50\u5f15\u7528\u8ba1\u6570\u7ba1\u7406\u6570\u636e\uff0c\u652f\u6301\u8de8\u7ebf\u7a0b\u5b89\u5168\u5171\u4eab\u3002</p> </li> <li> <p>\u6027\u80fd\u4f18\u5316 \u200b\u200b\uff1a\u504f\u79fb\u91cf\u6570\u7ec4 Arc\\&lt;[u16]&gt; \u5728\u591a\u6b21\u5f15\u7528\u65f6\u5171\u4eab\u540c\u4e00\u5185\u5b58\uff0c\u6bd4 Vec \u7684\u72ec\u7acb\u5b58\u50a8\u66f4\u8282\u7701\u5185\u5b58\u3002   \u200b</p> </li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#_2","title":"\u7f3a\u70b9 \u200b\u200b","text":"<ul> <li>\u5185\u5b58\u788e\u7247\u5316 \u200b\u200b\uff1aArc\\&lt;[u16]&gt; \u7684\u6bcf\u4e2a\u5b9e\u4f8b\u72ec\u7acb\u5206\u914d\u5185\u5b58\uff0c\u53ef\u80fd\u5bfc\u81f4\u5185\u5b58\u788e\u7247\uff08\u5c24\u5176\u662f\u5927\u91cf\u5c0f Block \u65f6\uff09\u3002\u5bf9\u6bd4 Vec \u7684\u8fde\u7eed\u5185\u5b58\u5e03\u5c40\uff0cArc\\&lt;[u16]&gt; \u7684\u968f\u673a\u5206\u914d\u53ef\u80fd\u964d\u4f4e\u7f13\u5b58\u5c40\u90e8\u6027\u3002</li> <li>\u5f15\u7528\u8ba1\u6570\u5f00\u9500 \u200b\u200b\uff1aArc \u548c Bytes \u7684\u539f\u5b50\u64cd\u4f5c\uff08\u589e\u51cf\u5f15\u7528\u8ba1\u6570\uff09\u5728\u9ad8\u5e76\u53d1\u573a\u666f\u4e0b\u6709\u8f7b\u5fae\u6027\u80fd\u635f\u8017\u3002\u9891\u7e41\u521b\u5efa/\u9500\u6bc1 Block \u65f6\uff0c\u539f\u5b50\u64cd\u4f5c\u7684\u5f00\u9500\u53ef\u80fd\u7d2f\u79ef\u3002</li> <li>\u7075\u6d3b\u6027\u964d\u4f4e \u200b\u200b\uff1a\u4e0d\u53ef\u53d8\u8bbe\u8ba1\u4f7f\u5f97\u65e0\u6cd5\u52a8\u6001\u4fee\u6539 Block \u7684\u6570\u636e\u6216\u504f\u79fb\u91cf\uff0c\u82e5\u9700\u539f\u5730\u66f4\u65b0\u5219\u9700\u91cd\u5efa\u6574\u4e2a Block\u3002\u82e5\u7cfb\u7edf\u9700\u8981\u52a8\u6001\u8c03\u6574\u504f\u79fb\u91cf\uff08\u5982\u5408\u5e76 Block\uff09\uff0c\u9700\u989d\u5916\u7684\u6570\u636e\u62f7\u8d1d\u3002</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#4-what-is-the-endian-of-the-numbers-written-into-the-blocks-in-your-implementation","title":"4. What is the endian of the numbers written into the blocks in your implementation?","text":"<ul> <li>\u5927\u7aef\u5b58\u50a8</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#5-is-your-implementation-prune-to-a-maliciously-built-block-will-there-be-invalid-memory-access-or-ooms-if-a-user-deliberately-construct-an-invalid-block","title":"5. Is your implementation prune to a maliciously-built block? Will there be invalid memory access, or OOMs, if a user deliberately construct an invalid block?","text":"<ul> <li>\u5728\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u65f6\u8fdb\u884c\u68c0\u67e5</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#6-can-a-block-contain-duplicated-keys","title":"6. Can a block contain duplicated keys?","text":"<ul> <li>\u53ef\u4ee5\u7684\uff0c\u5408\u5e76\u76f8\u540c\u7684 key \u5728 compaction \u4e2d\u8fdb\u884c</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#7-what-happens-if-the-user-adds-a-key-larger-than-the-target-block-size","title":"7. What happens if the user adds a key larger than the target block size?","text":"<ul> <li>\u4f1a\u76f4\u63a5\u8fd4\u56de\u5931\u8d25\uff0c\u4e00\u822c\u5e94\u8be5\u538b\u7f29\u540e\u5b58\u5165</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day3/#8-consider-the-case-that-the-lsm-engine-is-built-on-object-store-services-s3-how-would-you-optimizechange-the-block-format-and-parameters-to-make-it-suitable-for-such-services","title":"8. Consider the case that the LSM engine is built on object store services (S3). How would you optimize/change the block format and parameters to make it suitable for such services?","text":"<p>\u9ad8\u5ef6\u8fdf\u3001\u4f4e\u968f\u673a\u8bbf\u95ee\u6027\u80fd\u3001\u6309\u8bf7\u6c42\u8ba1\u8d39\uff08PUT/GET\uff09\u7b49\u7279\u70b9\u8fdb\u884c\u4f18\u5316</p> <ul> <li>\u589e\u5927\u5757\u5927\u5c0f</li> <li>\u5143\u6570\u636e\u5916\u7f6e \u200b\u200b <p>\u8bbe\u8ba1 \u200b\u200b\uff1a\u5c06\u5757\u7d22\u5f15\u3001\u5e03\u9686\u8fc7\u6ee4\u5668\u7b49\u5143\u6570\u636e\u5355\u72ec\u5b58\u50a8\u4e3a\u5c0f\u6587\u4ef6\uff0c\u6216\u5185\u8054\u5728\u5757\u5934\u90e8\u3002 \u4f18\u70b9 \u200b\u200b\uff1a\u51cf\u5c11\u6bcf\u6b21 GET \u64cd\u4f5c\u4f20\u8f93\u7684\u6570\u636e\u91cf\uff08\u5148\u62c9\u53d6\u5143\u6570\u636e\uff0c\u518d\u6309\u9700\u62c9\u53d6\u6570\u636e\u5757\uff09\u3002\u652f\u6301\u5feb\u901f\u8fc7\u6ee4\u65e0\u6548\u67e5\u8be2\uff08\u5982\u5e03\u9686\u8fc7\u6ee4\u5668\u5224\u65ad\u952e\u4e0d\u5b58\u5728\uff09\u3002- \u5217\u5f0f\u5b58\u50a8\u5e03\u5c40</p> </li> <li>\u5c3d\u53ef\u80fd\u538b\u7f29\u66f4\u591a\u7684 KV \u5230\u4e00\u4e2a block \u4e2d</li> <li>\u5982\u679c\u662f scan\uff0c\u4f7f\u7528\u9884\u53d6\uff0c\u5c06\u591a\u4e2a block \u7684\u6570\u636e\u4e00\u6b21\u53d6\u51fa\u6765</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/","title":"SST","text":"2025-05-152025-12-10 <code>#MiniLSM</code> <code>#rust</code>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#block","title":"Block","text":"<p> \u7ea6 802 \u4e2a\u5b57  30 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <ul> <li>\u8fd9\u91cc\u6211\u4eec\u5b9e\u73b0\u4e86 Sorted String Table \u7684 encode \u548c decode \u4ee5\u53ca block iterator </li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#sorted-string-table-format","title":"Sorted String Table format","text":"Bash<pre><code>-------------------------------------------------------------------------------------------\n|         Block Section         |          Meta Section         |          Extra          |\n-------------------------------------------------------------------------------------------\n| data block | ... | data block |            metadata           | meta block offset (u32) |\n-------------------------------------------------------------------------------------------\n\n-------------------------------------\n|           Block Meta              |\n-------------------------------------\n| num of metas| Meta1 | Meta2 | ... |\n-------------------------------------\n\n---------------------------------\n|           Meta i              |\n---------------------------------\n| offset | first key | last key |\n---------------------------------\n</code></pre>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#entry-format","title":"Entry format","text":"<ul> <li>\u91c7\u7528\u4e0e first key \u516c\u7528\u524d\u7f00\u7684\u65b9\u5f0f</li> </ul> Bash<pre><code>-----------------------------------------------------------------------\n|                           Entry #1                            | ... |\n-----------------------------------------------------------------------\n| overlap_with_first_key (2B) | key_len (2B) | key (keylen) | value_len (2B) | value (varlen) | ... |\n-----------------------------------------------------------------------\n</code></pre>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#the-end-of-block","title":"The end of block","text":"<ul> <li>store the offsets of each entry and the total number of entries</li> </ul> Bash<pre><code>-------------------------------\n|offset|offset|num_of_elements|\n-------------------------------\n|   0  |  12  |       2       |\n-------------------------------\n</code></pre>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#test-understanding-of-block-implement","title":"Test Understanding of Block implement","text":"","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#1-what-is-the-time-complexity-of-seeking-a-key-in-the-block","title":"1. What is the time complexity of seeking a key in the block?","text":"<ul> <li>\u4f7f\u7528\u4e8c\u5206\u67e5\u627e\uff0cO(logn)</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#2-where-does-the-cursor-stop-when-you-seek-a-non-existent-key-in-your-implementation","title":"2. Where does the cursor stop when you seek a non-existent key in your implementation?","text":"<ul> <li>cursor \u4f1a\u505c\u5728 block.offsets.len()\u5904\uff0c\u6b64\u65f6\u8fd4\u56de\u7684 key \u662f\u7a7a\u7684\uff0cvalue_range \u662f(0, 0)</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#3-so-block-is-simply-a-vector-of-raw-data-and-a-vector-of-offsets-can-we-change-them-to-byte-and-arcu16-and-change-all-the-iterator-interfaces-to-return-byte-instead-of-u8-assume-that-we-use-byteslice-to-return-a-slice-of-the-block-without-copying-what-are-the-proscons","title":"3. So Block is simply a vector of raw data and a vector of offsets. Can we change them to Byte and Arc\\&lt;[u16]&gt;, and change all the iterator interfaces to return Byte instead of &amp;[u8]? (Assume that we use Byte::slice to return a slice of the block without copying.) What are the pros/cons?","text":"","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#_1","title":"\u4f18\u70b9 \u200b\u200b","text":"<ul> <li> <p>\u96f6\u62f7\u8d1d\u64cd\u4f5c \u200b\uff1aBytes \u7c7b\u578b\u5929\u7136\u652f\u6301\u96f6\u62f7\u8d1d\u5207\u7247\uff08\u901a\u8fc7 Bytes::slice\uff09\uff0c\u907f\u514d\u6570\u636e\u590d\u5236\uff0c\u5c24\u5176\u9002\u7528\u4e8e\u5927\u5757\u6570\u636e\u6216\u591a\u5904\u5171\u4eab\u7684\u573a\u666f\u3002</p> </li> <li> <p>\u7ebf\u7a0b\u5b89\u5168 \u200b\u200b\uff1aArc\\&lt;[u16]&gt; \u662f\u7ebf\u7a0b\u5b89\u5168\u7684\u4e0d\u53ef\u53d8\u7ed3\u6784\uff0c\u5141\u8bb8\u591a\u7ebf\u7a0b\u5b89\u5168\u5171\u4eab\u504f\u79fb\u91cf\u6570\u7ec4\uff0c\u65e0\u9700\u989d\u5916\u540c\u6b65\u3002Bytes \u5185\u90e8\u901a\u8fc7\u539f\u5b50\u5f15\u7528\u8ba1\u6570\u7ba1\u7406\u6570\u636e\uff0c\u652f\u6301\u8de8\u7ebf\u7a0b\u5b89\u5168\u5171\u4eab\u3002</p> </li> <li> <p>\u6027\u80fd\u4f18\u5316 \u200b\u200b\uff1a\u504f\u79fb\u91cf\u6570\u7ec4 Arc\\&lt;[u16]&gt; \u5728\u591a\u6b21\u5f15\u7528\u65f6\u5171\u4eab\u540c\u4e00\u5185\u5b58\uff0c\u6bd4 Vec \u7684\u72ec\u7acb\u5b58\u50a8\u66f4\u8282\u7701\u5185\u5b58\u3002   \u200b</p> </li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#_2","title":"\u7f3a\u70b9 \u200b\u200b","text":"<ul> <li>\u5185\u5b58\u788e\u7247\u5316 \u200b\u200b\uff1aArc\\&lt;[u16]&gt; \u7684\u6bcf\u4e2a\u5b9e\u4f8b\u72ec\u7acb\u5206\u914d\u5185\u5b58\uff0c\u53ef\u80fd\u5bfc\u81f4\u5185\u5b58\u788e\u7247\uff08\u5c24\u5176\u662f\u5927\u91cf\u5c0f Block \u65f6\uff09\u3002\u5bf9\u6bd4 Vec \u7684\u8fde\u7eed\u5185\u5b58\u5e03\u5c40\uff0cArc\\&lt;[u16]&gt; \u7684\u968f\u673a\u5206\u914d\u53ef\u80fd\u964d\u4f4e\u7f13\u5b58\u5c40\u90e8\u6027\u3002</li> <li>\u5f15\u7528\u8ba1\u6570\u5f00\u9500 \u200b\u200b\uff1aArc \u548c Bytes \u7684\u539f\u5b50\u64cd\u4f5c\uff08\u589e\u51cf\u5f15\u7528\u8ba1\u6570\uff09\u5728\u9ad8\u5e76\u53d1\u573a\u666f\u4e0b\u6709\u8f7b\u5fae\u6027\u80fd\u635f\u8017\u3002\u9891\u7e41\u521b\u5efa/\u9500\u6bc1 Block \u65f6\uff0c\u539f\u5b50\u64cd\u4f5c\u7684\u5f00\u9500\u53ef\u80fd\u7d2f\u79ef\u3002</li> <li>\u7075\u6d3b\u6027\u964d\u4f4e \u200b\u200b\uff1a\u4e0d\u53ef\u53d8\u8bbe\u8ba1\u4f7f\u5f97\u65e0\u6cd5\u52a8\u6001\u4fee\u6539 Block \u7684\u6570\u636e\u6216\u504f\u79fb\u91cf\uff0c\u82e5\u9700\u539f\u5730\u66f4\u65b0\u5219\u9700\u91cd\u5efa\u6574\u4e2a Block\u3002\u82e5\u7cfb\u7edf\u9700\u8981\u52a8\u6001\u8c03\u6574\u504f\u79fb\u91cf\uff08\u5982\u5408\u5e76 Block\uff09\uff0c\u9700\u989d\u5916\u7684\u6570\u636e\u62f7\u8d1d\u3002</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#4-what-is-the-endian-of-the-numbers-written-into-the-blocks-in-your-implementation","title":"4. What is the endian of the numbers written into the blocks in your implementation?","text":"<ul> <li>\u5927\u7aef\u5b58\u50a8</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#5-is-your-implementation-prune-to-a-maliciously-built-block-will-there-be-invalid-memory-access-or-ooms-if-a-user-deliberately-construct-an-invalid-block","title":"5. Is your implementation prune to a maliciously-built block? Will there be invalid memory access, or OOMs, if a user deliberately construct an invalid block?","text":"<ul> <li>\u5728\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u65f6\u8fdb\u884c\u68c0\u67e5</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#6-can-a-block-contain-duplicated-keys","title":"6. Can a block contain duplicated keys?","text":"<ul> <li>\u53ef\u4ee5\u7684\uff0c\u5408\u5e76\u76f8\u540c\u7684 key \u5728 compaction \u4e2d\u8fdb\u884c</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#7-what-happens-if-the-user-adds-a-key-larger-than-the-target-block-size","title":"7. What happens if the user adds a key larger than the target block size?","text":"<ul> <li>\u4f1a\u76f4\u63a5\u8fd4\u56de\u5931\u8d25\uff0c\u4e00\u822c\u5e94\u8be5\u538b\u7f29\u540e\u5b58\u5165</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/minilsm/week1-day4/#8-consider-the-case-that-the-lsm-engine-is-built-on-object-store-services-s3-how-would-you-optimizechange-the-block-format-and-parameters-to-make-it-suitable-for-such-services","title":"8. Consider the case that the LSM engine is built on object store services (S3). How would you optimize/change the block format and parameters to make it suitable for such services?","text":"<p>\u9ad8\u5ef6\u8fdf\u3001\u4f4e\u968f\u673a\u8bbf\u95ee\u6027\u80fd\u3001\u6309\u8bf7\u6c42\u8ba1\u8d39\uff08PUT/GET\uff09\u7b49\u7279\u70b9\u8fdb\u884c\u4f18\u5316</p> <ul> <li>\u589e\u5927\u5757\u5927\u5c0f</li> <li>\u5143\u6570\u636e\u5916\u7f6e \u200b\u200b <p>\u8bbe\u8ba1 \u200b\u200b\uff1a\u5c06\u5757\u7d22\u5f15\u3001\u5e03\u9686\u8fc7\u6ee4\u5668\u7b49\u5143\u6570\u636e\u5355\u72ec\u5b58\u50a8\u4e3a\u5c0f\u6587\u4ef6\uff0c\u6216\u5185\u8054\u5728\u5757\u5934\u90e8\u3002 \u4f18\u70b9 \u200b\u200b\uff1a\u51cf\u5c11\u6bcf\u6b21 GET \u64cd\u4f5c\u4f20\u8f93\u7684\u6570\u636e\u91cf\uff08\u5148\u62c9\u53d6\u5143\u6570\u636e\uff0c\u518d\u6309\u9700\u62c9\u53d6\u6570\u636e\u5757\uff09\u3002\u652f\u6301\u5feb\u901f\u8fc7\u6ee4\u65e0\u6548\u67e5\u8be2\uff08\u5982\u5e03\u9686\u8fc7\u6ee4\u5668\u5224\u65ad\u952e\u4e0d\u5b58\u5728\uff09\u3002- \u5217\u5f0f\u5b58\u50a8\u5e03\u5c40</p> </li> <li>\u5c3d\u53ef\u80fd\u538b\u7f29\u66f4\u591a\u7684 KV \u5230\u4e00\u4e2a block \u4e2d</li> <li>\u5982\u679c\u662f scan\uff0c\u4f7f\u7528\u9884\u53d6\uff0c\u5c06\u591a\u4e2a block \u7684\u6570\u636e\u4e00\u6b21\u53d6\u51fa\u6765</li> </ul>","tags":["MiniLSM","rust"]},{"location":"notes/python/Asyncio/","title":"Asyncio \u57fa\u7840","text":""},{"location":"notes/python/Asyncio/#python-asyncio","title":"Python \u4e2d\u7684Asyncio","text":"<p> \u7ea6 212 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-022025-12-10 <p>\u4f7f\u7528\u5355\u7ebf\u7a0b + \u4e8b\u4ef6\u5faa\u73af (Event Loop)\u3002\u8fd9\u662f\u4e00\u79cd\u534f\u4f5c\u5f0f\u591a\u4efb\u52a1\u3002 \u4ee3\u7801\u6267\u884c\u5230 <code>await</code>\uff08\u6bd4\u5982\u7b49\u5f85\u7f51\u7edc\u54cd\u5e94\uff09\u65f6\uff0c\u4e3b\u52a8\u4ea4\u51fa\u63a7\u5236\u6743\u6302\u8d77\u81ea\u5df1\uff0c\u8ba9\u4e8b\u4ef6\u5faa\u73af\u53bb\u6267\u884c\u5176\u4ed6\u4efb\u52a1\u3002\u7b49\u5230\u7f51\u7edc\u54cd\u5e94\u56de\u6765\u4e86\uff0c\u518d\u6062\u590d\u6267\u884c\u3002</p>"},{"location":"notes/python/Asyncio/#_1","title":"\u4f18\u7f3a\u70b9","text":"<ul> <li> <p>\u9002\u7528\u573a\u666f\uff1a\u9ad8\u5e76\u53d1 I/O\uff08\u7279\u522b\u662f\u7f51\u7edc\u8fde\u63a5\uff09\u3002</p> </li> <li> <p>\u6bd4\u5982\uff1a\u9ad8\u6027\u80fd Web \u670d\u52a1\u5668\uff08FastAPI\uff09\u3001WebSocket \u670d\u52a1\u3001\u540c\u65f6\u5904\u7406\u6570\u4e07\u4e2a\u957f\u8fde\u63a5\u3002</p> </li> <li> <p>\u4f18\u7f3a\u70b9\uff1a</p> </li> <li> <p>\u2705 \u6781\u81f4\u8f7b\u91cf\uff1a\u6ca1\u6709\u7ebf\u7a0b\u5207\u6362\u7684\u64cd\u4f5c\u7cfb\u7edf\u5f00\u9500\uff0c\u5185\u5b58\u5360\u7528\u6781\u4f4e\uff0c\u80fd\u5904\u7406 C10k\uff08\u4e07\u7ea7\u5e76\u53d1\uff09\u95ee\u9898\u3002</p> </li> <li> <p>\u274c \u4f20\u67d3\u6027\uff1a\u4e00\u65e6\u7528\u4e86 <code>async</code>\uff0c\u6574\u4e2a\u8c03\u7528\u94fe\u90fd\u8981\u53d8\u6210\u5f02\u6b65\u3002</p> </li> <li> <p>\u274c \u6015\u963b\u585e\uff1a\u56e0\u4e3a\u662f\u5355\u7ebf\u7a0b\uff0c\u5982\u679c\u4e2d\u95f4\u6df7\u5165\u4e86\u4e00\u4e2a\u8017\u65f6\u7684\u8ba1\u7b97\u6216\u963b\u585e I/O\uff08\u5982 <code>time.sleep</code>\uff09\uff0c\u6574\u4e2a\u7a0b\u5e8f\u90fd\u4f1a\u5361\u6b7b\u3002</p> </li> </ul>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/","title":"Python \u4e2d\u7684\u5e76\u884c","text":""},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/#python","title":"Python \u4e2d\u7684\u5e76\u884c","text":"<p> \u7ea6 878 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/#_1","title":"\u57fa\u4e8e\u7ebf\u7a0b\u7684\u5e76\u884c","text":"<p><code>threading</code>\u00a0\u6a21\u5757\u63d0\u4f9b\u4e86\u4e00\u79cd\u5728\u5355\u4e2a\u8fdb\u7a0b\u5185\u90e8\u5e76\u53d1\u5730\u8fd0\u884c\u591a\u4e2a\u00a0\u7ebf\u7a0b\u00a0(\u4ece\u8fdb\u7a0b\u5206\u51fa\u7684\u66f4\u5c0f\u5355\u4f4d) \u7684\u65b9\u5f0f\u3002 \u5b83\u5141\u8bb8\u521b\u5efa\u548c\u7ba1\u7406\u7ebf\u7a0b\uff0c\u4ee5\u4fbf\u80fd\u591f\u5e73\u884c\u5730\u6267\u884c\u591a\u4e2a\u4efb\u52a1\uff0c\u5e76\u5171\u4eab\u5185\u5b58\u7a7a\u95f4\u3002 \u7ebf\u7a0b\u7279\u522b\u9002\u7528\u4e8e I/O \u5bc6\u96c6\u578b\u7684\u4efb\u52a1\uff0c\u5982\u6587\u4ef6\u64cd\u4f5c\u6216\u53d1\u9001\u7f51\u7edc\u8bf7\u6c42\uff0c\u5728\u6b64\u7c7b\u4efb\u52a1\u4e2d\u5927\u90e8\u5206\u65f6\u95f4\u90fd\u4f1a\u6d88\u8017\u4e8e\u7b49\u5f85\u5916\u90e8\u8d44\u6e90\u3002</p>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/#_2","title":"\u4f2a\u5e76\u884c","text":"<p>\u5728 CPython \u4e2d\uff0c\u7531\u4e8e\u5b58\u5728\u00a0\u5168\u5c40\u89e3\u91ca\u5668\u9501(GIL)\uff0c\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u6267\u884c Python \u4ee3\u7801\uff08\u867d\u7136\u67d0\u4e9b\u6027\u80fd\u5bfc\u5411\u7684\u5e93\u53ef\u80fd\u4f1a\u53bb\u9664\u6b64\u9650\u5236\uff09\u3002 \u5982\u679c\u4f60\u60f3\u8ba9\u4f60\u7684\u5e94\u7528\u66f4\u597d\u5730\u5229\u7528\u591a\u6838\u5fc3\u8ba1\u7b97\u673a\u7684\u8ba1\u7b97\u8d44\u6e90\uff0c\u63a8\u8350\u4f60\u4f7f\u7528\u00a0<code>multiprocessing</code>\u00a0\u6216\u00a0<code>concurrent.futures.ProcessPoolExecutor</code>\u3002 \u4f46\u662f\uff0c\u5982\u679c\u4f60\u60f3\u8981\u540c\u65f6\u8fd0\u884c\u591a\u4e2a I/O \u5bc6\u96c6\u578b\u4efb\u52a1\uff0c\u5219\u591a\u7ebf\u7a0b\u4ecd\u7136\u662f\u4e00\u4e2a\u5408\u9002\u7684\u6a21\u578b\u3002</p> <p>&gt;<code>concurrent.futures.ThreadPoolExecutor</code>\u00a0\u63d0\u4f9b\u4e86\u4e00\u4e2a\u9ad8\u5c42\u7ea7\u63a5\u53e3\u7528\u6765\u5411\u540e\u53f0\u7ebf\u7a0b\u63a8\u9001\u4efb\u52a1\u800c\u4e0d\u4f1a\u963b\u585e\u8c03\u7528\u65b9\u7ebf\u7a0b\u7684\u6267\u884c\uff0c\u540c\u65f6\u4ecd\u7136\u80fd\u591f\u5728\u9700\u8981\u65f6\u83b7\u53d6\u4efb\u52a1\u7684\u7ed3\u679c\u3002</p> <p><code>queue</code>\u00a0\u63d0\u4f9b\u4e86\u4e00\u4e2a\u7ebf\u7a0b\u5b89\u5168\u7684\u63a5\u53e3\u7528\u6765\u5728\u8fd0\u884c\u4e2d\u7684\u7ebf\u7a0b\u4e4b\u95f4\u4ea4\u6362\u6570\u636e\u3002</p> <p><code>asyncio</code>\u00a0\u63d0\u4f9b\u4e86\u4e00\u4e2a\u66ff\u4ee3\u65b9\u5f0f\u7528\u6765\u5b9e\u73b0\u4efb\u52a1\u5c42\u7ea7\u7684\u5e76\u53d1\u800c\u4e0d\u8981\u6c42\u4f7f\u7528\u591a\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7ebf\u7a0b\u3002</p>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/#_3","title":"\u4f18\u7f3a\u70b9","text":"<ul> <li> <p>\u9002\u7528\u573a\u666f\uff1aI/O \u5bc6\u96c6\u578b\u4efb\u52a1\u3002</p> </li> <li> <p>\u6bd4\u5982\uff1a\u722c\u866b\u3001\u8bf7\u6c42 Web API\u3001\u8bfb\u5199\u78c1\u76d8\u6587\u4ef6\u3002</p> </li> <li> <p>\u4f18\u7f3a\u70b9\uff1a</p> </li> <li> <p>\u2705 \u5f00\u9500\u5c0f\uff1a\u7ebf\u7a0b\u542f\u52a8\u5feb\uff0c\u5185\u5b58\u5360\u7528\u5c11\u3002</p> </li> <li> <p>\u2705 \u901a\u4fe1\u6613\uff1a\u5171\u4eab\u5185\u5b58\uff0c\u6570\u636e\u4ea4\u6362\u65b9\u4fbf\uff08\u4f46\u8981\u5c0f\u5fc3\u7ebf\u7a0b\u5b89\u5168\uff09\u3002</p> </li> <li> <p>\u274c \u4f2a\u5e76\u884c\uff1a\u5728\u7eaf\u8ba1\u7b97\u4efb\u52a1\u4e2d\uff0c\u591a\u7ebf\u7a0b\u53cd\u800c\u53ef\u80fd\u56e0\u4e3a\u5207\u6362\u4e0a\u4e0b\u6587\u7684\u5f00\u9500\u53d8\u6162\u3002</p> </li> </ul>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/#_4","title":"\u57fa\u4e8e\u8fdb\u7a0b\u7684\u5e76\u884c","text":"<p><code>multiprocessing</code>\u00a0\u5305\u540c\u65f6\u63d0\u4f9b\u4e86\u672c\u5730\u548c\u8fdc\u7a0b\u5e76\u53d1\u64cd\u4f5c\uff0c\u901a\u8fc7\u4f7f\u7528\u5b50\u8fdb\u7a0b\u800c\u975e\u7ebf\u7a0b\u6709\u6548\u5730\u7ed5\u8fc7\u4e86\u00a0\u5168\u5c40\u89e3\u91ca\u5668\u9501\u3002 \u56e0\u6b64\uff0c<code>multiprocessing</code>\u00a0\u6a21\u5757\u5141\u8bb8\u7a0b\u5e8f\u5458\u5145\u5206\u5229\u7528\u7ed9\u5b9a\u673a\u5668\u4e0a\u7684\u591a\u4e2a\u5904\u7406\u5668\u3002</p> <p>\u4f7f\u7528\u591a\u8fdb\u7a0b\u65f6\uff0c\u4e00\u822c\u4f7f\u7528\u6d88\u606f\u673a\u5236\u5b9e\u73b0\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff0c\u5c3d\u53ef\u80fd\u907f\u514d\u4f7f\u7528\u540c\u6b65\u539f\u8bed\uff0c\u4f8b\u5982\u9501\u3002</p>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/#_5","title":"\u5728\u8fdb\u7a0b\u4e4b\u95f4\u4ea4\u6362\u5bf9\u8c61","text":"<p><code>multiprocessing</code>\u00a0\u652f\u6301\u8fdb\u7a0b\u4e4b\u95f4\u7684\u4e24\u79cd\u901a\u4fe1\u901a\u9053\uff1a</p> <p>\u961f\u5217</p> <p>\u961f\u5217\u662f\u7ebf\u7a0b\u548c\u8fdb\u7a0b\u5b89\u5168\u7684\u3002 \u4efb\u4f55\u653e\u5165\u00a0<code>multiprocessing</code>\u00a0\u961f\u5217\u7684\u5bf9\u8c61\u90fd\u5c06\u88ab\u5e8f\u5217\u5316\u3002</p> <p>\u7ba1\u9053</p> <p><code>Pipe()</code>\u00a0\u51fd\u6570\u8fd4\u56de\u4e00\u4e2a\u7531\u7ba1\u9053\u8fde\u63a5\u7684\u8fde\u63a5\u5bf9\u8c61\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u53cc\u5de5\uff08\u53cc\u5411\uff09\u3002\u4f8b\u5982:</p> <p>\u8fd4\u56de\u7684\u4e24\u4e2a\u8fde\u63a5\u5bf9\u8c61\u00a0<code>Pipe()</code>\u00a0\u8868\u793a\u7ba1\u9053\u7684\u4e24\u7aef\u3002\u6bcf\u4e2a\u8fde\u63a5\u5bf9\u8c61\u90fd\u6709\u00a0<code>send()</code>\u00a0\u548c\u00a0<code>recv()</code>\u00a0\u65b9\u6cd5\uff08\u76f8\u4e92\u4e4b\u95f4\u7684\uff09\u3002\u8bf7\u6ce8\u610f\uff0c\u5982\u679c\u4e24\u4e2a\u8fdb\u7a0b\uff08\u6216\u7ebf\u7a0b\uff09\u540c\u65f6\u5c1d\u8bd5\u8bfb\u53d6\u6216\u5199\u5165\u7ba1\u9053\u7684\u00a0\u540c\u4e00\u00a0\u7aef\uff0c\u5219\u7ba1\u9053\u4e2d\u7684\u6570\u636e\u53ef\u80fd\u4f1a\u635f\u574f\u3002\u5f53\u7136\uff0c\u5728\u4e0d\u540c\u8fdb\u7a0b\u4e2d\u540c\u65f6\u4f7f\u7528\u7ba1\u9053\u7684\u4e0d\u540c\u7aef\u7684\u60c5\u51b5\u4e0b\u4e0d\u5b58\u5728\u635f\u574f\u7684\u98ce\u9669\u3002</p> <p><code>send()</code>\u00a0\u65b9\u6cd5\u5c06\u5e8f\u5217\u5316\u5bf9\u8c61\u800c\u00a0<code>recv()</code>\u00a0\u5c06\u91cd\u65b0\u521b\u5efa\u5bf9\u8c61\u3002</p>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E5%B9%B6%E8%A1%8C/#_6","title":"\u4f18\u7f3a\u70b9","text":"<ul> <li> <p>\u9002\u7528\u573a\u666f\uff1aCPU \u5bc6\u96c6\u578b\u4efb\u52a1\u3002</p> </li> <li> <p>\u6bd4\u5982\uff1a\u7e41\u91cd\u7684\u6570\u5b66\u8ba1\u7b97\uff08\u77e9\u9635\u8fd0\u7b97\uff09\u3001\u56fe\u50cf\u5904\u7406\u3001\u89c6\u9891\u7f16\u7801\u3001\u5927\u89c4\u6a21\u6570\u636e\u6e05\u6d17\u3002</p> </li> <li> <p>\u4f18\u7f3a\u70b9\uff1a</p> </li> <li> <p>\u2705 \u771f\u5e76\u884c\uff1a\u5229\u7528\u591a\u6838\u4f18\u52bf\uff0c\u4e0d\u53d7 GIL \u9650\u5236\u3002</p> </li> <li> <p>\u274c \u5f00\u9500\u5927\uff1a\u542f\u52a8\u8fdb\u7a0b\u6162\uff0c\u5360\u7528\u5185\u5b58\u591a\uff08\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u8981\u590d\u5236\u4e00\u4efd\u8d44\u6e90\uff09\u3002</p> </li> <li> <p>\u274c \u901a\u4fe1\u96be\uff1a\u8fdb\u7a0b\u95f4\u5185\u5b58\u4e0d\u5171\u4eab\uff0c\u901a\u4fe1\u9700\u8981\u901a\u8fc7\u7279\u6b8a\u7684\u5e8f\u5217\u5316\uff08Pickle\uff09\u673a\u5236\uff0c\u5f00\u9500\u8f83\u5927\u3002</p> </li> </ul>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/","title":"Python \u4e2d\u7684\u88c5\u9970\u5668","text":""},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#python","title":"Python \u4e2d\u7684\u88c5\u9970\u5668","text":"<p> \u7ea6 711 \u4e2a\u5b57  28 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u5b83\u662f Python 3.7 \u5f15\u5165\u7684\u4e00\u4e2a\u6807\u51c6\u5e93\u5de5\u5177\uff08<code>from dataclasses import dataclass</code>\uff09\u3002\u5b83\u7684\u4e3b\u8981\u4f5c\u7528\u662f \u81ea\u52a8\u751f\u6210\u6837\u677f\u4ee3\u7801\u3002</p> <p>\u88c5\u9970\u5668\u672c\u8d28\u4e0a\u5c31\u662f\u4e00\u4e2a \u201c\u63a5\u6536\u4e00\u4e2a\u51fd\u6570/\u7c7b\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684\u51fd\u6570/\u7c7b\u201d\u7684\u9ad8\u9636\u51fd\u6570</p>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#_1","title":"\u5de5\u4f5c\u6d41\u7a0b","text":"<p><code>@dataclass</code> \u7684\u6838\u5fc3\u5de5\u4f5c\u6d41\u7a0b\u662f\u5229\u7528 Python \u7684 \u5143\u7f16\u7a0b (Metaprogramming) \u80fd\u529b\u3002\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li> <p>\u8bfb\u53d6\u7c7b\u578b\u6ce8\u89e3 (<code>__annotations__</code>)\uff1a Python \u7684\u7c7b\u4f1a\u628a\u53d8\u91cf\u5b9a\u4e49\u7684\u7c7b\u578b\u4fdd\u5b58\u5728 <code>__annotations__</code> \u5b57\u5178\u4e2d\u3002 <code>dataclass</code> \u51fd\u6570\u4f1a\u53bb\u8bfb\u53d6 <code>Student</code> \u7c7b\u4e2d\u7684 <code>name: str</code>, <code>age: int</code> \u7b49\u4fe1\u606f\u3002</p> </li> <li> <p>\u52a8\u6001\u751f\u6210\u4ee3\u7801\u5b57\u7b26\u4e32\uff1a \u6839\u636e\u8bfb\u53d6\u5230\u7684\u5b57\u6bb5\uff0c<code>dataclass</code> \u4f1a\u5728\u5185\u5b58\u4e2d\u52a8\u6001\u62fc\u63a5\u51fa\u65b9\u6cd5\u7684\u6e90\u4ee3\u7801\u5b57\u7b26\u4e32\u3002\u4f8b\u5982\uff0c\u5b83\u4f1a\u62fc\u51fa\u7c7b\u4f3c\u8fd9\u6837\u7684\u5b57\u7b26\u4e32\uff1a</p> </li> </ol> Python<pre><code>\"def __init__(self, name: str, age: int, score: float):\\n self.name=name\\n self.age=age...\"\n</code></pre> <ol> <li>\u7f16\u8bd1\u5e76\u6302\u8f7d\u65b9\u6cd5\uff1a \u5b83\u4f7f\u7528 Python \u5185\u7f6e\u7684 <code>exec()</code> \u51fd\u6570\u5c06\u8fd9\u4e9b\u5b57\u7b26\u4e32\u4ee3\u7801\u7f16\u8bd1\u6210\u771f\u6b63\u7684\u51fd\u6570\u5bf9\u8c61\uff0c\u7136\u540e\u901a\u8fc7 <code>setattr</code> \u628a\u8fd9\u4e9b\u51fd\u6570\u6302\u8f7d\u5230 <code>Student</code> \u7c7b\u4e0a\u3002</li> </ol> <ul> <li> <p><code>setattr(Student, '__init__', generated_init_func)</code></p> </li> <li> <p><code>setattr(Student, '__repr__', generated_repr_func)</code></p> </li> </ul>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#_2","title":"\u624b\u5199\u88c5\u9970\u5668\u793a\u4f8b","text":"Python<pre><code>def add_str_method(cls):\n    # 1. \u5b9a\u4e49\u4e00\u4e2a\u65b0\u65b9\u6cd5\n    def new_str(self):\n        return f\"\u6211\u662f\u7c7b {cls.__name__} \u7684\u5b9e\u4f8b\"\n\n    # 2. \u628a\u8fd9\u4e2a\u65b9\u6cd5\u5f3a\u884c\u585e\u7ed9\u4f20\u5165\u7684\u7c7b\n    cls.__str__ = new_str\n\n    # 3. \u8fd4\u56de\u4fee\u6539\u540e\u7684\u7c7b\n    return cls\n\n\n# \u4f7f\u7528\u88c5\u9970\u5668\n@add_str_method\nclass MyConfig:\n    pass\n\n\n# \u6d4b\u8bd5\nc = MyConfig()\nprint(c)  # \u8f93\u51fa: \"\u6211\u662f\u7c7b MyConfig \u7684\u5b9e\u4f8b\"\n</code></pre>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#pytorch","title":"pytorch \u4e2d\u5e38\u7528\u7684\u88c5\u9970\u5668","text":""},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#1","title":"1. \u68af\u5ea6\u4e0e\u8ba1\u7b97\u56fe\u63a7\u5236\uff08\u6700\u5e38\u7528\uff09","text":"<p>\u8fd9\u51e0\u4e2a\u88c5\u9970\u5668\u65e2\u53ef\u4ee5\u7528\u4f5c\u51fd\u6570\u88c5\u9970\u5668\uff0c\u4e5f\u53ef\u4ee5\u7528\u4f5c\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\uff08<code>with ...:</code>\uff09\u3002</p>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#torchno_grad","title":"<code>@torch.no_grad()</code>","text":"<ul> <li> <p>\u4f5c\u7528\uff1a\u7981\u7528\u68af\u5ea6\u8ba1\u7b97\u3002</p> </li> <li> <p>\u539f\u7406\uff1a\u5728\u88ab\u88c5\u9970\u7684\u51fd\u6570\u6267\u884c\u671f\u95f4\uff0cPyTorch \u7684 Autograd \u5f15\u64ce\u4f1a\u505c\u6b62\u8bb0\u5f55\u64cd\u4f5c\u5386\u53f2\u3002\u8fd9\u4f1a\u51cf\u5c11\u5185\u5b58\u6d88\u8017\uff08\u4e0d\u5b58\u4e2d\u95f4\u6fc0\u6d3b\u503c\uff09\u5e76\u52a0\u5feb\u8ba1\u7b97\u901f\u5ea6\u3002</p> </li> <li> <p>\u573a\u666f\uff1a\u6a21\u578b**\u9a8c\u8bc1\uff08Validation\uff09\u6216\u63a8\u7406\uff08Inference\uff09**\u9636\u6bb5\u3002</p> </li> <li> <p>\u4ee3\u7801\u793a\u4f8b\uff1a</p> </li> </ul> <p>Python</p> Text Only<pre><code>@torch.no_grad()\ndef evaluate(model, x):\n    return model(x)  # \u8fd9\u91cc\u7684\u8ba1\u7b97\u4e0d\u4f1a\u4ea7\u751f\u68af\u5ea6\uff0c\u663e\u5b58\u5360\u7528\u66f4\u4f4e\n</code></pre>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#torchinference_mode","title":"<code>@torch.inference_mode()</code> (\u63a8\u8350\u7528\u4e8e\u63a8\u7406)","text":"<ul> <li> <p>\u4f5c\u7528\uff1a\u66f4\u6781\u81f4\u7684\u63a8\u7406\u6a21\u5f0f\u3002</p> </li> <li> <p>\u539f\u7406\uff1a\u5b83\u662f <code>@torch.no_grad()</code> \u7684\u5347\u7ea7\u7248\u3002\u9664\u4e86\u7981\u7528\u68af\u5ea6\uff0c\u5b83\u8fd8\u7981\u7528\u4e86\u4e00\u4e9b\u5728\u63a8\u7406\u65f6\u4e0d\u9700\u8981\u7684\u8fd0\u884c\u65f6\u68c0\u67e5\uff08view tracking \u7b49\uff09\u3002</p> </li> <li> <p>\u573a\u666f\uff1a\u751f\u4ea7\u73af\u5883\u63a8\u7406\u3001\u90e8\u7f72\u3002\u6bd4 <code>no_grad</code> \u66f4\u5feb\uff0c\u662f PyTorch \u5b98\u65b9\u63a8\u8350\u7528\u4e8e\u7eaf\u63a8\u7406\u7684\u6a21\u5f0f\u3002</p> </li> <li> <p>\u6ce8\u610f\uff1a\u5728\u8fd9\u4e2a\u6a21\u5f0f\u4e0b\u751f\u6210\u7684 Tensor \u65e0\u6cd5\u88ab\u7528\u4e8e\u540e\u7eed\u7684\u8bad\u7ec3\uff08\u65e0\u6cd5\u53cd\u5411\u4f20\u64ad\uff09\u3002</p> </li> </ul>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#torchenable_grad","title":"<code>@torch.enable_grad()</code>","text":"<ul> <li> <p>\u4f5c\u7528\uff1a\u5f3a\u5236\u5f00\u542f\u68af\u5ea6\u8ba1\u7b97\u3002</p> </li> <li> <p>\u573a\u666f\uff1a\u6bd4\u8f83\u5c11\u7528\u3002\u901a\u5e38\u7528\u4e8e\u5728 <code>no_grad</code> \u7684\u5927\u73af\u5883\u4e0b\uff0c\u4e34\u65f6\u9700\u8981\u5bf9\u67d0\u539f\u672c\u51bb\u7ed3\u7684\u6a21\u578b\u90e8\u5206\u6c42\u5bfc\uff08\u4f8b\u5982\uff1aFreeze \u9aa8\u5e72\u7f51\u7edc\uff0c\u4f46\u5728\u63a8\u7406\u65f6\u60f3\u7528\u68af\u5ea6\u505a\u4e00\u4e9b\u53ef\u89c6\u5316\u6216\u5bf9\u6297\u653b\u51fb\uff09\u3002</p> </li> </ul>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#2-pytorch-2x","title":"2. \u7f16\u8bd1\u4e0e\u52a0\u901f (PyTorch 2.x)","text":"<p>\u8fd9\u4e00\u7c7b\u88c5\u9970\u5668\u6d89\u53ca PyTorch \u7684\u7f16\u8bd1\u5668\u524d\u7aef\uff0c\u5c06 Python \u4ee3\u7801\u8f6c\u6362\u4e3a\u66f4\u9ad8\u6548\u7684\u4e2d\u95f4\u8868\u793a\uff08IR\uff09\u3002</p>"},{"location":"notes/python/Python%20%E4%B8%AD%E7%9A%84%E8%A3%85%E9%A5%B0%E5%99%A8/#torchcompile-pytorch-20","title":"<code>@torch.compile</code> (PyTorch 2.0+ \u6838\u5fc3)","text":"<ul> <li> <p>\u4f5c\u7528\uff1a\u4e00\u884c\u4ee3\u7801\u52a0\u901f\u6a21\u578b\u3002</p> </li> <li> <p>\u539f\u7406\uff1a\u4f7f\u7528 TorchDynamo \u6355\u83b7\u8ba1\u7b97\u56fe\uff0c\u5e76\u4f7f\u7528 Triton \u7b49\u540e\u7aef\u5c06\u4e00\u7cfb\u5217\u7b97\u5b50\u878d\u5408\uff08Kernel Fusion\uff09\uff0c\u751f\u6210\u4f18\u5316\u540e\u7684\u4e8c\u8fdb\u5236\u4ee3\u7801\u3002</p> </li> <li> <p>\u573a\u666f\uff1a\u5927\u6a21\u578b\u8bad\u7ec3\u548c\u63a8\u7406\u52a0\u901f\u3002</p> </li> <li> <p>\u4ee3\u7801\u793a\u4f8b\uff1a</p> </li> </ul> Python<pre><code>import torch\n\n\n@torch.compile  # \u81ea\u52a8\u4f18\u5316\u8fd9\u4e2a\u51fd\u6570/\u6a21\u578b\ndef fast_inference(x, y):\n    return torch.sin(x) + torch.cos(y)\n</code></pre>"},{"location":"notes/rcore/BatchOS/","title":"BatchOS","text":"2025-12-022025-12-10 <p>title: BatchOS created: 2024-04-17 update: comments: true description: BatchOS\u4ecb\u7ecd katex: true tags:</p> <ul> <li>Operator System</li> <li>rust   categories: Project</li> </ul>"},{"location":"notes/rcore/BatchOS/#batchos","title":"BatchOS","text":"<p> \u7ea6 1415 \u4e2a\u5b57  394 \u884c\u4ee3\u7801  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 12 \u5206\u949f</p> <p></p> <ul> <li>\u5b9e\u73b0\u6279\u5904\u7406\u7a0b\u5e8f\u529f\u80fd\u7684 OS</li> <li>APP \u4e0e OS \u9694\u79bb</li> <li>\u81ea\u52a8\u52a0\u8f7d\u5e76\u8fd0\u884c\u591a\u4e2a\u7a0b\u5e8f</li> </ul>"},{"location":"notes/rcore/BatchOS/#_1","title":"\u7279\u6743\u7ea7\u673a\u5236","text":"<ul> <li><code>ecall</code> \u5177\u6709\u7528\u6237\u6001\u5230\u5185\u6838\u6001\u7684\u6267\u884c\u73af\u5883\u5207\u6362\u80fd\u529b\u7684\u51fd\u6570\u8c03\u7528\u6307\u4ee4\uff1b</li> <li><code>sret</code> \uff1a\u5177\u6709\u5185\u6838\u6001\u5230\u7528\u6237\u6001\u7684\u6267\u884c\u73af\u5883\u5207\u6362\u80fd\u529b\u7684\u51fd\u6570\u8fd4\u56de\u6307\u4ee4\u3002</li> <li>\u9996\u5148\uff0c\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u63d0\u4f9b\u76f8\u5e94\u7684\u529f\u80fd\u4ee3\u7801\uff0c\u80fd\u5728\u6267\u884c <code>sret</code> \u524d\u51c6\u5907\u548c\u6062\u590d\u7528\u6237\u6001\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0a\u4e0b\u6587\u3002\u5176\u6b21\uff0c\u5728\u5e94\u7528\u7a0b\u5e8f\u8c03\u7528 <code>ecall</code> \u6307\u4ee4\u540e\uff0c\u80fd\u591f\u68c0\u67e5\u5e94\u7528\u7a0b\u5e8f\u7684\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\uff0c\u786e\u4fdd\u53c2\u6570\u4e0d\u4f1a\u7834\u574f\u64cd\u4f5c\u7cfb\u7edf\u3002</li> </ul>"},{"location":"notes/rcore/BatchOS/#risc-v","title":"RISC-V \u5f02\u5e38","text":""},{"location":"notes/rcore/BatchOS/#risc-v-s","title":"RISC-V S \u6a21\u5f0f\u7279\u6743\u6307\u4ee4","text":"<ul> <li>sert\uff1a\u4ece S \u6a21\u5f0f\u8fd4\u56de U \u6a21\u5f0f</li> <li>wfi\uff1a\u5904\u7406\u5668\u5728\u7a7a\u95f2\u65f6\u8fdb\u5165\u4f4e\u529f\u8017\u72b6\u6001\u7b49\u5f85\u7ec8\u7aef</li> <li>sfence.vma\uff1a\u5237\u65b0 TLB \u7f13\u5b58</li> <li>\u8bbf\u95ee S \u6a21\u5f0f CSR \u6307\u4ee4\uff1a\u6539\u53d8\u7cfb\u7edf\u72b6\u6001</li> </ul>"},{"location":"notes/rcore/BatchOS/#_2","title":"\u63a7\u5236\u72b6\u6001\u5bc4\u5b58\u5668","text":"<ul> <li>sstatus\uff1aSPP \u5b57\u6bb5\u7ed9\u51fa Trap \u53d1\u751f\u524d CPU \u7684\u7279\u6743\u7ea7</li> <li>sepc\uff1a\u8bb0\u5f55\u5f02\u5e38\u53d1\u751f\u524d\u6267\u884c\u7684\u6700\u540e\u4e00\u6761\u6307\u4ee4\u7684\u5730\u5740</li> <li>scause\uff1a\u63cf\u8ff0 Trap \u7684\u539f\u56e0</li> <li>stval\uff1a\u7ed9\u51fa Trap \u7684\u9644\u52a0\u4fe1\u606f</li> <li>stvec\uff1a\u63a7\u5236 Trap \u5904\u7406\u4ee3\u7801\u7684\u5165\u53e3\u5730\u5740</li> </ul>"},{"location":"notes/rcore/BatchOS/#_3","title":"\u786c\u4ef6\u5207\u6362\u7684\u786c\u4ef6\u63a7\u5236\u673a\u5236","text":"<p>ecall</p> <ul> <li><code>sstatus</code>\u4e2d\u7684<code>SPP</code>\u5b57\u6bb5\u5207\u6362\u5230 CPU \u5f53\u524d\u7279\u6743\u7ea7</li> <li><code>sepc</code>\u4fee\u6539\u4e3a Trap \u5904\u7406\u5b8c\u6210\u540e\u9ed8\u8ba4\u6267\u884c\u7684\u4e0b\u4e00\u6761\u6307\u4ee4\u7684\u5730\u5740</li> <li><code>scause\\stval</code>\u4fee\u6539\u6210 Trap \u539f\u56e0\u548c Trap \u989d\u5916\u4fe1\u606f</li> <li>CPU \u8df3\u8f6c\u5230<code>stvec</code>\u8bbe\u7f6e\u7684 Trap \u5904\u7406\u5165\u53e3\u51fd\u6570\uff0c\u8bbe\u7f6e\u7279\u6743\u7ea7\u4e3a S</li> </ul> <p>sret</p> <ul> <li>CPU \u6309\u7167<code>sstatus</code>\u8bbe\u7f6e\u7279\u6743\u7ea7</li> <li>CPU \u8df3\u8f6c\u5230<code>sepc</code>\u6307\u5411\u7684\u5730\u5740\uff0c\u7136\u540e\u7ee7\u7eed\u6267\u884c</li> </ul>"},{"location":"notes/rcore/BatchOS/#_4","title":"\u7528\u6237\u5e93","text":"<ul> <li>\u4f7f\u7528 Rust \u7684\u5b8f\u5c06\u5176\u51fd\u6570\u7b26\u53f7 <code>main</code> \u6807\u5fd7\u4e3a\u5f31\u94fe\u63a5\u3002\u8fd9\u6837\u5728\u6700\u540e\u94fe\u63a5\u7684\u65f6\u5019\uff0c\u867d\u7136\u5728 <code>lib.rs</code> \u548c <code>bin</code> \u76ee\u5f55\u4e0b\u7684\u67d0\u4e2a\u5e94\u7528\u7a0b\u5e8f\u90fd\u6709 <code>main</code> \u7b26\u53f7\uff0c\u4f46\u7531\u4e8e <code>lib.rs</code> \u4e2d\u7684 <code>main</code> \u7b26\u53f7\u662f\u5f31\u94fe\u63a5\uff0c\u94fe\u63a5\u5668\u4f1a\u4f7f\u7528 <code>bin</code> \u76ee\u5f55\u4e0b\u7684\u5e94\u7528\u4e3b\u903b\u8f91\u4f5c\u4e3a <code>main</code></li> <li>\u8fd9\u91cc\u6211\u4eec\u4e3b\u8981\u662f\u8fdb\u884c\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u7684\u4fdd\u62a4\uff0c\u5982\u679c\u5728 <code>bin</code> \u76ee\u5f55\u4e0b\u627e\u4e0d\u5230\u4efb\u4f55 <code>main</code> \uff0c\u90a3\u4e48\u7f16\u8bd1\u4e5f\u80fd\u591f\u901a\u8fc7\uff0c\u4f46\u4f1a\u5728\u8fd0\u884c\u65f6\u62a5\u9519\u3002</li> </ul> Rust<pre><code>#[linkage=\"weak\"]\n#[no_mangle]\nfn main()-&gt;i32 {\n    panic!(\"Cannot find main!\");\n}\n</code></pre> <ul> <li><code>#![feature(linkage)]</code>\u652f\u6301\u94fe\u63a5\u64cd\u4f5c</li> </ul>"},{"location":"notes/rcore/BatchOS/#_5","title":"\u7cfb\u7edf\u8c03\u7528","text":"<ul> <li><code>&amp;[u8]</code> \u5207\u7247\u7c7b\u578b\u6765\u63cf\u8ff0\u7f13\u51b2\u533a\uff0c\u8fd9\u662f\u4e00\u4e2a \u80d6\u6307\u9488 (Fat Pointer)\uff0c\u91cc\u9762\u65e2\u5305\u542b\u7f13\u51b2\u533a\u7684\u8d77\u59cb\u5730\u5740\uff0c\u8fd8 \u5305\u542b\u7f13\u51b2\u533a\u7684\u957f\u5ea6\u3002</li> </ul> Rust<pre><code>// user/src/syscall.rs\nuse core::arch::asm;\nfn syscall(id: usize, args: [usize; 3]) -&gt; isize {\n    let mut ret: isize;\n    unsafe {\n        asm!(\n            \"ecall\",\n            inlateout(\"x10\") args[0] =&gt; ret,\n            in(\"x11\") args[1],\n            in(\"x12\") args[2],\n            in(\"x17\") id\n        );\n    }\n    ret\n}\nconst SYSCALL_WRITE: usize = 64;\nconst SYSCALL_EXIT: usize = 93;\n\npub fn sys_write(fd: usize, buffer: &amp;[u8]) -&gt; isize {\n    syscall(SYSCALL_WRITE, [fd, buffer.as_ptr() as usize, buffer.len()])\n}\n\npub fn sys_exit(xstate: i32) -&gt; isize {\n    syscall(SYSCALL_EXIT, [xstate as usize, 0, 0])\n}\n</code></pre>"},{"location":"notes/rcore/BatchOS/#app","title":"\u52a0\u8f7d\u4e0d\u540c\u7684 APP","text":""},{"location":"notes/rcore/BatchOS/#appmanager","title":"AppManager","text":"<ul> <li>\u5728 <code>RefCell</code> \u7684\u57fa\u7840\u4e0a\u518d\u5c01\u88c5\u4e00\u4e2a <code>UPSafeCell</code> \uff0c\u5b83\u540d\u5b57\u7684\u542b\u4e49\u662f\uff1a\u5141\u8bb8\u6211\u4eec\u5728 \u5355\u6838 \u4e0a\u5b89\u5168\u4f7f\u7528\u53ef\u53d8\u5168\u5c40\u53d8\u91cf\u3002</li> <li>\u5f53\u6211\u4eec\u8981\u8bbf\u95ee\u6570\u636e\u65f6\uff08\u65e0\u8bba\u8bfb\u8fd8\u662f\u5199\uff09\uff0c\u9700\u8981\u9996\u5148\u8c03\u7528 <code>exclusive_access</code> \u83b7\u5f97\u6570\u636e\u7684\u53ef\u53d8\u501f\u7528\u6807\u8bb0\uff0c\u901a\u8fc7\u5b83\u53ef\u4ee5\u5b8c\u6210\u6570\u636e\u7684\u8bfb\u5199\uff0c\u5728\u64cd\u4f5c\u5b8c\u6210\u4e4b\u540e\u6211\u4eec\u9700\u8981\u9500\u6bc1\u8fd9\u4e2a\u6807\u8bb0\uff0c\u6b64\u540e\u624d\u80fd\u5f00\u59cb\u5bf9\u8be5\u6570\u636e\u7684\u4e0b\u4e00\u6b21\u8bbf\u95ee</li> </ul> Rust<pre><code>// os/src/sync/up.rs\n\npub struct UPSafeCell&lt;T&gt; {\n    /// inner data\n    inner: RefCell&lt;T&gt;,\n}\n\n// unsafe\u5411\u7f16\u8bd1\u5668\u4fdd\u8bc1\u53ea\u5728\u5355\u6838\u4e0a\u8fdb\u884c\u64cd\u4f5c\nunsafe impl&lt;T&gt; Sync for UPSafeCell&lt;T&gt; {}\n\nimpl&lt;T&gt; UPSafeCell&lt;T&gt; {\n    /// User is responsible to guarantee that inner struct is only used in\n    /// uniprocessor.\n    pub unsafe fn new(value: T) -&gt; Self {\n        Self { inner: RefCell::new(value) }\n    }\n    /// Panic if the data has been borrowed.\n    pub fn exclusive_access(&amp;self) -&gt; RefMut&lt;'_, T&gt; {\n        self.inner.borrow_mut()\n    }\n}\n</code></pre>"},{"location":"notes/rcore/BatchOS/#new","title":"New","text":"<ul> <li>\u4f7f\u7528<code>core::slice::from_raw_parts</code>\u5c06\u6307\u9488\u89e3\u91ca\u4e3a<code>&amp;[usize]</code>\u5207\u7247\uff1b</li> <li>\u4f7f\u7528<code>copy_from_slice</code>\u5c06\u5207\u7247\u4e0a\u7684\u5143\u7d20\u590d\u5236\u5230<code>app_start</code>\u4e0a</li> </ul> Rust<pre><code>static ref APP_MANAGER: UPSafeCell&lt;AppManager&gt; = unsafe {\n    UPSafeCell::new({\n        extern \"C\" {\n            fn _num_app();\n        }\n        let num_app_ptr = _num_app as usize as *const usize;\n        let num_app = num_app_ptr.read_volatile();\n        let mut app_start: [usize; MAX_APP_NUM + 1] = [0; MAX_APP_NUM + 1];\n        let app_start_raw: &amp;[usize] =\n            core::slice::from_raw_parts(num_app_ptr.add(1), num_app + 1);\n        app_start[..=num_app].copy_from_slice(app_start_raw);\n        AppManager {\n            num_app,\n            current_app: 0,\n            app_start,\n        }\n    })\n};\n</code></pre>"},{"location":"notes/rcore/BatchOS/#load_app","title":"load_app","text":"<ul> <li> <p>CPU \u7528\u5b58\u5728\u6307\u4ee4\u7f13\u5b58\uff0c\u4f7f\u7528 load_app \u52a0\u8f7d\u65b0\u7684\u7a0b\u5e8f\uff0c\u9700\u8981\u8ba9 OS \u77e5\u9053\u53d6\u6307\u5185\u5b58\u7684\u53d8\u5316</p> </li> <li> <p>OS \u5728\u8fd9\u91cc\u5fc5\u987b\u4f7f\u7528\u53d6\u6307\u5c4f\u969c\u6307\u4ee4 <code>fence.i</code> \uff0c\u5b83\u7684\u529f\u80fd\u662f\u4fdd\u8bc1 \u5728\u5b83\u4e4b\u540e\u7684\u53d6\u6307\u8fc7\u7a0b\u5fc5\u987b\u80fd\u591f\u770b\u5230\u5728\u5b83\u4e4b\u524d\u7684\u6240\u6709\u5bf9\u4e8e\u53d6\u6307\u5185\u5b58\u533a\u57df\u7684\u4fee\u6539</p> </li> </ul> Rust<pre><code>unsafe fn load_app(&amp;self, app_id: usize) {\n    if app_id &gt;= self.num_app {\n        println!(\"All applications completed!\");\n        shutdown(false);\n    }\n    println!(\"[kernel] Loading app_{}\", app_id);\n    // clear app area\n    core::slice::from_raw_parts_mut(APP_BASE_ADDRESS as *mut u8, APP_SIZE_LIMIT).fill(0);\n    // \u5c06\u6307\u9488\u770b\u4f5c\u5207\u7247\uff0c\u4f7f\u7528\u62f7\u8d1d\u5b9e\u73b0App\u5207\u6362\n    let app_src = core::slice::from_raw_parts(\n        self.app_start[app_id] as *const u8,\n        self.app_start[app_id + 1] - self.app_start[app_id],\n    );\n    let app_dst = core::slice::from_raw_parts_mut(APP_BASE_ADDRESS as *mut u8, app_src.len());\n    app_dst.copy_from_slice(app_src);\n    // Memory fence about fetching the instruction memory\n    // It is guaranteed that a subsequent instruction fetch must\n    // observes all previous writes to the instruction memory.\n    // Therefore, fence.i must be executed after we have loaded\n    // the code of the next app into the instruction memory.\n    // See also: riscv non-priv spec chapter 3, 'Zifencei' extension.\n    asm!(\"fence.i\");\n}\n</code></pre>"},{"location":"notes/rcore/BatchOS/#run_next_app","title":"run_next_app","text":"<ul> <li>\u5148\u5c06\u4e00\u4e2a\u4e0a\u4e0b\u6587\u538b\u5165\u5185\u6838\u6808\u4e2d\uff1b\u5728<code>__restore</code>\u4e2d\u66f4\u65b0<code>sscrath</code>\u6307\u9488\u6307\u5411\u5185\u6838\u6808\u6808\u9876</li> <li>\u5982\u679c\u53d1\u751f\u7cfb\u7edf\u8c03\u7528\uff0c\u4ece<code>__alltraps</code>\u5f00\u59cb\u6267\u884c</li> </ul> Rust<pre><code>/// run next app\npub fn run_next_app() -&gt; ! {\n    let mut app_manager = APP_MANAGER.exclusive_access();\n    let current_app = app_manager.get_current_app();\n    unsafe {\n        app_manager.load_app(current_app);\n    }\n    app_manager.move_to_next_app();\n    drop(app_manager);\n    // before this we have to drop local variables related to resources manually\n    // and release the resources\n    extern \"C\" {\n        fn __restore(cx_addr: usize);\n    }\n    unsafe {\n        __restore(KERNEL_STACK.push_context(TrapContext::app_init_context(\n            APP_BASE_ADDRESS,\n            USER_STACK.get_sp(),\n        )) as *const _ as usize);\n    }\n    panic!(\"Unreachable in batch::run_current_app!\");\n}\n</code></pre>"},{"location":"notes/rcore/BatchOS/#trap","title":"Trap \u7ba1\u7406","text":""},{"location":"notes/rcore/BatchOS/#trapcontext","title":"TrapContext","text":"<ul> <li>Trap \u53d1\u751f\u65f6\u9700\u8981\u4fdd\u5b58\u7684\u7269\u7406\u8d44\u6e90\u5185\u5bb9\uff0c\u5305\u62ec 32 \u4e2a\u901a\u7528\u5bc4\u5b58\u5668\u3001sstatus \u4ee5\u53ca sepc</li> <li>\u5bf9\u4e8e CSR \u800c\u8a00\uff0c\u6211\u4eec\u77e5\u9053\u8fdb\u5165 Trap \u7684\u65f6\u5019\uff0c\u786c\u4ef6\u4f1a\u7acb\u5373\u8986\u76d6\u6389 <code>scause/stval/sstatus/sepc</code> \u7684\u5168\u90e8\u6216\u662f\u5176\u4e2d\u4e00\u90e8\u5206\u3002</li> <li><code>scause/stval</code> \u7684\u60c5\u51b5\u662f\uff1a\u5b83\u603b\u662f\u5728 Trap \u5904\u7406\u7684\u7b2c\u4e00\u65f6\u95f4\u5c31\u88ab\u4f7f\u7528\u6216\u8005\u662f\u5728\u5176\u4ed6\u5730\u65b9\u4fdd\u5b58\u4e0b\u6765\u4e86\uff0c\u56e0\u6b64\u5b83\u6ca1\u6709\u88ab\u4fee\u6539\u5e76\u9020\u6210\u4e0d\u826f\u5f71\u54cd\u7684\u98ce\u9669\u3002</li> <li>\u800c\u5bf9\u4e8e <code>sstatus/sepc</code> \u800c\u8a00\uff0c\u5b83\u4eec\u4f1a\u5728 Trap \u5904\u7406\u7684\u5168\u7a0b\u6709\u610f\u4e49\uff08\u5728 Trap \u63a7\u5236\u6d41\u6700\u540e <code>sret</code> \u7684\u65f6\u5019\u8fd8\u7528\u5230\u4e86\u5b83\u4eec\uff09\uff0c\u800c\u4e14\u786e\u5b9e\u4f1a\u51fa\u73b0 Trap \u5d4c\u5957\u7684\u60c5\u51b5\u4f7f\u5f97\u5b83\u4eec\u7684\u503c\u88ab\u8986\u76d6\u6389\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c06\u5b83\u4eec\u4e5f\u4e00\u8d77\u4fdd\u5b58\u4e0b\u6765\uff0c\u5e76\u5728 <code>sret</code> \u4e4b\u524d\u6062\u590d\u539f\u6837\u3002</li> </ul> Rust<pre><code>// os/src/trap/context.rs\n\n#[repr(C)]\npub struct TrapContext {\n    pub x: [usize; 32],\n    pub sstatus: Sstatus,\n    pub sepc: usize,\n}\n</code></pre>"},{"location":"notes/rcore/BatchOS/#trapcontext_1","title":"TrapContext \u7684\u4fdd\u5b58\u4e0e\u6062\u590d","text":"<ul> <li>\u9996\u5148\u901a\u8fc7 <code>__alltraps</code> \u5c06 Trap \u4e0a\u4e0b\u6587\u4fdd\u5b58\u5728\u5185\u6838\u6808\u4e0a\uff0c\u7136\u540e\u8df3\u8f6c\u5230\u4f7f\u7528 Rust \u7f16\u5199\u7684 <code>trap_handler</code> \u51fd\u6570\u5b8c\u6210 Trap \u5206\u53d1\u53ca\u5904\u7406\u3002\u5f53 <code>trap_handler</code> \u8fd4\u56de\u4e4b\u540e\uff0c\u4f7f\u7528 <code>__restore</code> \u4ece\u4fdd\u5b58\u5728\u5185\u6838\u6808\u4e0a\u7684 Trap \u4e0a\u4e0b\u6587\u6062\u590d\u5bc4\u5b58\u5668\u3002\u6700\u540e\u901a\u8fc7\u4e00\u6761 <code>sret</code> \u6307\u4ee4\u56de\u5230\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u3002</li> </ul> Rust<pre><code>// os/src/trap/mod.rs\n\nglobal_asm!(include_str!(\"trap.S\"));\n\npub fn init() {\n    extern \"C\" { fn __alltraps(); }\n    unsafe {\n        stvec::write(__alltraps as usize, TrapMode::Direct);\n    }\n}\n</code></pre>"},{"location":"notes/rcore/BatchOS/#__alltraps","title":"__alltraps","text":"<ul> <li><code>sscratch</code>\u5728<code>__restore</code>\u4e2d\u8bbe\u7f6e\u4e3a\u5185\u6838\u6808\u6808\u9876\uff0c<code>run_next_app</code>\u4ece<code>__restore</code>\u5148\u6267\u884c</li> </ul> Text Only<pre><code># os/src/trap/trap.S\n\n.macro SAVE_GP n\n    sd x\\n, \\n*8(sp)\n.endm\n\n.align 2\n__alltraps:\n    csrrw sp, sscratch, sp # exchange sp and sscratch(point to kernel stack)\n    # now sp-&gt;kernel stack, sscratch-&gt;user stack\n    # allocate a TrapContext on kernel stack\n    addi sp, sp, -34*8\n    # save general-purpose registers\n    sd x1, 1*8(sp)\n    # skip sp(x2), we will save it later\n    sd x3, 3*8(sp)\n    # skip tp(x4), application does not use it\n    # save x5~x31\n    .set n, 5\n    .rept 27\n        SAVE_GP %n\n        .set n, n+1\n    .endr\n    # we can use t0/t1/t2 freely, because they were saved on kernel stack\n    csrr t0, sstatus\n    csrr t1, sepc\n    sd t0, 32*8(sp)\n    sd t1, 33*8(sp)\n    # read user stack from sscratch and save it on the kernel stack\n    csrr t2, sscratch\n    sd t2, 2*8(sp)\n    # set input argument of trap_handler(cx: &amp;mut TrapContext)\n    mv a0, sp # a0 point to trap context and as arguement of trap_handler\n    call trap_handler\n</code></pre>"},{"location":"notes/rcore/BatchOS/#__restore","title":"__restore","text":"<ul> <li>\u5148\u6062\u590d CSR \u5bc4\u5b58\u5668\u518d\u6062\u590d\u901a\u7528\u5bc4\u5b58\u5668</li> <li><code>csrrw sp, sscratch, sp</code>\u6b64\u65f6 sscratch \u8bbe\u7f6e\u4e3a\u5185\u6838\u6808\u6808\u9876(\u7531\u5e94\u7528\u7a0b\u5e8f\u5728\u6267\u884c\u524d\u538b\u5165\u5185\u6838\u6808)</li> </ul> Text Only<pre><code># os/src/trap/trap.S\n\n.macro LOAD_GP n\n    ld x\\n, \\n*8(sp)\n.endm\n\n__restore:\n    # case1: start running app by __restore\n    # case2: back to U after handling trap\n    mv sp, a0\n    # now sp-&gt;kernel stack(after allocated), sscratch-&gt;user stack\n    # restore sstatus/sepc\n    ld t0, 32*8(sp)\n    ld t1, 33*8(sp)\n    ld t2, 2*8(sp)\n    csrw sstatus, t0\n    csrw sepc, t1\n    csrw sscratch, t2\n    # restore general-purpuse registers except sp/tp\n    ld x1, 1*8(sp)\n    ld x3, 3*8(sp)\n    .set n, 5\n    .rept 27\n        LOAD_GP %n\n        .set n, n+1\n    .endr\n    # release TrapContext on kernel stack\n    addi sp, sp, 34*8\n    # now sp-&gt;kernel stack, sscratch-&gt;user stack\n    csrrw sp, sscratch, sp # \u73b0\u5728 sp \u91cd\u65b0\u6307\u5411\u7528\u6237\u6808\u6808\u9876\uff0csscratch \u4e5f\u4f9d\u7136\u4fdd\u5b58\u8fdb\u5165 Trap \u4e4b\u524d\u7684\u72b6\u6001\u5e76\u6307\u5411\u5185\u6838\u6808\u6808\u9876\u3002\n    sret\n</code></pre>"},{"location":"notes/rcore/BatchOS/#trap_handler","title":"trap_handler","text":"Rust<pre><code>// os/src/trap/mod.rs\n\n#[no_mangle]\npub fn trap_handler(cx: &amp;mut TrapContext) -&gt; &amp;mut TrapContext {\n    let scause = scause::read();\n    let stval = stval::read();\n    match scause.cause() {\n        Trap::Exception(Exception::UserEnvCall) =&gt; {\n            cx.sepc += 4;\n            cx.x[10] = syscall(cx.x[17], [cx.x[10], cx.x[11], cx.x[12]]) as usize;\n        }\n        Trap::Exception(Exception::StoreFault) |\n        Trap::Exception(Exception::StorePageFault) =&gt; {\n            println!(\"[kernel] PageFault in application, kernel killed it.\");\n            run_next_app();\n        }\n        Trap::Exception(Exception::IllegalInstruction) =&gt; {\n            println!(\"[kernel] IllegalInstruction in application, kernel killed it.\");\n            run_next_app();\n        }\n        _ =&gt; {\n            panic!(\"Unsupported trap {:?}, stval = {:#x}!\", scause.cause(), stval);\n        }\n    }\n    cx\n}\n</code></pre>"},{"location":"notes/rcore/BatchOS/#practice","title":"Practice","text":""},{"location":"notes/rcore/BatchOS/#_6","title":"\u6269\u5c55\u5185\u6838\uff0c\u80fd\u591f\u7edf\u8ba1\u591a\u4e2a\u5e94\u7528\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\u7cfb\u7edf\u8c03\u7528\u7f16\u53f7\u548c\u8bbf\u95ee\u6b64\u7cfb\u7edf\u8c03\u7528\u7684\u6b21\u6570","text":"<ul> <li>\u589e\u52a0\u4e00\u4e2a SyscallNum \u7684\u7ed3\u6784\u4f53\u8bb0\u5f55\u53d1\u751f\u7cfb\u7edf\u8c03\u7528\u7684\u6b21\u6570</li> </ul> Rust<pre><code>// batch.rs\n/**\n * syscall num\n */\npub struct SyscallNum {\n    num: [usize; SYSCALL_NUM],\n}\n\nimpl SyscallNum {\n    /**\n     * get syscall num\n     */\n    pub fn get_syscall_num(&amp;self, syscall_id: usize) -&gt; usize {\n        self.num[syscall_id]\n    }\n    /**\n     * inc syscall num\n     */\n    pub fn inc_syscall_num(&amp;mut self, syscall_id: usize) {\n        self.num[syscall_id] += 1;\n    }\n}\n\nlazy_static!{\n     // ch2 add begin\n    /**\n     * syscall use syscall num\n     */\n    pub static ref NUM: UPSafeCell&lt;SyscallNum&gt; = unsafe {\n        UPSafeCell::new({\n            SyscallNum {\n                num: [0; SYSCALL_NUM],\n            }\n        })\n    };\n}\n\n// run_next_app\nif current_app == APP_MANAGER.exclusive_access().num_app - 1 || current_app == 0 {\n        println!(\n            \"sys_write num: {}\",\n            NUM.exclusive_access().get_syscall_num(0)\n        );\n        println!(\n            \"sys_exit num: {}\",\n            NUM.exclusive_access().get_syscall_num(1)\n        );\n    }\n</code></pre> Rust<pre><code>// syscall/mod.rs\nuse crate::batch::NUM;\n/// handle syscall exception with `syscall_id` and other arguments\npub fn syscall(syscall_id: usize, args: [usize; 3]) -&gt; isize {\n    match syscall_id {\n        SYSCALL_WRITE =&gt; {\n            let ret = sys_write(args[0], args[1] as *const u8, args[2]);\n            NUM.exclusive_access().inc_syscall_num(0);\n            ret\n        }\n        SYSCALL_EXIT =&gt; {\n            NUM.exclusive_access().inc_syscall_num(1);\n            sys_exit(args[0] as i32)\n        }\n        _ =&gt; panic!(\"Unsupported syscall_id: {}\", syscall_id),\n    }\n</code></pre>"},{"location":"notes/rcore/BatchOS/#_7","title":"\u6269\u5c55\u5185\u6838\uff0c\u80fd\u591f\u7edf\u8ba1\u6bcf\u4e2a\u5e94\u7528\u6267\u884c\u540e\u7684\u5b8c\u6210\u65f6\u95f4","text":"<ul> <li>\u5728<code>AppManager</code>\u4e2d\u589e\u52a0\u5e94\u7528\u6267\u884c\u65f6\u957f\u5b57\u6bb5\uff1b\u5728<code>run_next_app</code>\u4e2d\u83b7\u53d6\u7cfb\u7edf\u65f6\u949f\uff0c\u8bb0\u5f55\u5e94\u7528\u65f6\u95f4</li> </ul> Rust<pre><code>// batch.rs\n/**\n * AppManager\n */\nstruct AppManager {\n    num_app: usize,\n    current_app: usize,\n    app_start: [usize; MAX_APP_NUM + 1],\n    // ch2 add begin\n    app_runtime: [u64; MAX_APP_NUM],\n    // ch2 add end\n}\n\n// run_next_app\n// ch2 add begin\n\nlet time: u64;\nunsafe {\n    asm!(\"rdtime {0}\", out(reg) time);\n}\nif current_app &gt; 0 {\n    let runtime = time - APP_MANAGER.exclusive_access().app_runtime[current_app - 1];\n    APP_MANAGER\n        .exclusive_access()\n        .set_app_runtime(current_app - 1, runtime);\n    println!(\n        \"[kernel] app_{} runs {} cycles\",\n        current_app - 1,\n        APP_MANAGER\n            .exclusive_access()\n            .get_app_runtime(current_app - 1)\n    );\n}\n</code></pre>"},{"location":"notes/rcore/BatchOS/#sys_write","title":"sys_write \u4ec5\u80fd\u8f93\u51fa\u4f4d\u4e8e\u7a0b\u5e8f\u672c\u8eab\u5185\u5b58\u7a7a\u95f4\u5185\u7684\u6570\u636e\uff0c\u5426\u5219\u62a5\u9519","text":"<ul> <li>\u6784\u5efa ReliableAddr \u7ed3\u6784\u4f53\u8bb0\u5f55\u5e94\u7528\u7a0b\u5e8f\u8d77\u59cb\u548c\u7ec8\u6b62\u5730\u5740</li> </ul> Rust<pre><code>// batch.rs\n/**\n * Reliable address of program\n */\npub struct ReliableAddr {\n    start: usize,\n    end: usize,\n}\n\nimpl ReliableAddr {\n    /**\n     * get reliable start addr\n     */\n    pub fn get_reliable_start(&amp;self) -&gt; usize {\n        self.start\n    }\n    /**\n     * get reliable end addr\n     */\n    pub fn get_reliable_end(&amp;self) -&gt; usize {\n        self.end\n    }\n}\n\nlazy_static!{\n    /**\n     * reliable addr init\n     */\n    pub static ref RE_ADDR:UPSafeCell&lt;ReliableAddr&gt; = unsafe {\n        UPSafeCell::new({\n            ReliableAddr {\n                start: APP_BASE_ADDRESS,\n                end: APP_BASE_ADDRESS + APP_SIZE_LIMIT,\n            }\n        })\n    };\n}\n\n// run_next_app\n// \u6ce8\u610f\u6570\u636e\u9700\u8981\u4f7f\u7528clone()\nlet mut reliable_addr = RE_ADDR.exclusive_access();\nreliable_addr.start = app_manager.app_start[current_app].clone();\nreliable_addr.end = app_manager.app_start[current_app + 1].clone();\ndrop(reliable_addr);\n</code></pre> Rust<pre><code>// syscall/mod.rs\nuse crate::batch::RE_ADDR;\n\n/// handle syscall exception with `syscall_id` and other arguments\npub fn syscall(syscall_id: usize, args: [usize; 3]) -&gt; isize {\n    match syscall_id {\n        SYSCALL_WRITE =&gt; {\n            let start_addr = RE_ADDR.exclusive_access().get_reliable_start();\n            let end_addr = RE_ADDR.exclusive_access().get_reliable_end();\n            if args[1] &lt; start_addr {\n                return -1;\n            }\n            if args[1] &gt;= end_addr {\n                return -1;\n            }\n            if args[1] + args[2] &gt;= end_addr {\n                return -1;\n            }\n            let ret = sys_write(args[0], args[1] as *const u8, args[2]);\n            NUM.exclusive_access().inc_syscall_num(0);\n            ret\n        }\n        SYSCALL_EXIT =&gt; {\n            NUM.exclusive_access().inc_syscall_num(1);\n            sys_exit(args[0] as i32)\n        }\n        _ =&gt; panic!(\"Unsupported syscall_id: {}\", syscall_id),\n    }\n}\n</code></pre>"},{"location":"notes/rcore/LibOS/","title":"LibOS","text":"2025-12-022025-12-10 <p>title: LibOS created: 2024-04-17 update: comments: true description: LibOS\u4ecb\u7ecd katex: true tags:</p> <ul> <li>Operator System</li> <li>rust   categories: Project</li> </ul>"},{"location":"notes/rcore/LibOS/#libos","title":"LibOS","text":"<p> \u7ea6 77 \u4e2a\u5b57  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p> <p></p> <ul> <li>\u5b9e\u73b0\u4e0e OS \u65e0\u5173\u7684 OS \u7c7b\u578b\u7684\u7a0b\u5e8f</li> </ul>"},{"location":"notes/rcore/LibOS/#_1","title":"\u7ed3\u6784","text":"<ul> <li>OS \u5728 APP \u8fd0\u884c\u524d\u8fdb\u884c\u521d\u59cb\u5316\uff1a\u5efa\u7acb\u6808\u7a7a\u95f4 + .bss \u6bb5\u6e05\u96f6</li> <li>Bootloader \u5728 0x80000000 \u5904\u52a0\u8f7d\uff0c\u6240\u4ee5 OS \u53ea\u80fd\u5728 0x80200000 \u5904\u52a0\u8f7d</li> </ul>"},{"location":"notes/rcore/LibOS/#_2","title":"\u5185\u5b58\u5e03\u5c40","text":""},{"location":"notes/rcore/TimeSharingOS/","title":"TimeSharingOS","text":"2025-12-022025-12-10 <p>title: TimesharingOS created: 2024-04-23 update: comments: true description: \u5206\u65f6\u591a\u4efb\u52a1OS katex: true tags:</p> <ul> <li>Operator System</li> <li>rust   categories: Project</li> </ul>"},{"location":"notes/rcore/TimeSharingOS/#timesharingos","title":"TimesharingOS","text":"<p> \u7ea6 2081 \u4e2a\u5b57  314 \u884c\u4ee3\u7801  6 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 14 \u5206\u949f</p>"},{"location":"notes/rcore/TimeSharingOS/#multiprogos","title":"MultiprogOS","text":"<ul> <li>Qemu \u628a\u5305\u542b\u591a\u4e2a app \u7684\u5217\u8868\u548c MultiprogOS \u7684 image \u955c\u50cf\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\uff0cRustSBI\uff08bootloader\uff09\u5b8c\u6210\u57fa\u672c\u7684\u786c\u4ef6\u521d\u59cb\u5316\u540e\uff0c\u8df3\u8f6c\u5230 MultiprogOS \u8d77\u59cb\u4f4d\u7f6e</li> <li>MultiprogOS \u9996\u5148\u8fdb\u884c\u6b63\u5e38\u8fd0\u884c\u524d\u7684\u521d\u59cb\u5316\u5de5\u4f5c\uff0c\u5373\u5efa\u7acb\u6808\u7a7a\u95f4\u548c\u6e05\u96f6 bss \u6bb5\uff0c\u7136\u540e\u901a\u8fc7\u6539\u8fdb\u7684 AppManager \u5185\u6838\u6a21\u5757\u4ece app \u5217\u8868\u4e2d\u628a\u6240\u6709 app \u90fd\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\uff0c\u5e76\u6309\u6307\u5b9a\u987a\u5e8f\u8ba9 app \u5728\u7528\u6237\u6001\u4e00\u4e2a\u63a5\u4e00\u4e2a\u5730\u6267\u884c\u3002</li> <li>app \u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u7684\u65b9\u5f0f\u5f97\u5230 MultiprogOS \u63d0\u4f9b\u7684 OS \u670d\u52a1\uff0c\u5982\u8f93\u51fa\u5b57\u7b26\u4e32\u7b49\u3002</li> </ul>"},{"location":"notes/rcore/TimeSharingOS/#coopos","title":"CoopOS","text":"<ul> <li>CoopOS \u8fdb\u4e00\u6b65\u6539\u8fdb\u4e86 AppManager \u5185\u6838\u6a21\u5757\uff0c\u628a\u5b83\u62c6\u5206\u4e3a\u8d1f\u8d23\u52a0\u8f7d\u5e94\u7528\u7684 Loader \u5185\u6838\u6a21\u5757\u548c\u7ba1\u7406\u5e94\u7528\u8fd0\u884c\u8fc7\u7a0b\u7684 TaskManager \u5185\u6838\u6a21\u5757\u3002</li> <li>TaskManager \u901a\u8fc7 task \u4efb\u52a1\u63a7\u5236\u5757\u6765\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u652f\u6301\u5e94\u7528\u7a0b\u5e8f\u4e3b\u52a8\u653e\u5f03 CPU \u5e76\u5207\u6362\u5230\u53e6\u4e00\u4e2a\u5e94\u7528\u7ee7\u7eed\u6267\u884c\uff0c\u4ece\u800c\u63d0\u9ad8\u7cfb\u7edf\u6574\u4f53\u6267\u884c\u6548\u7387\u3002</li> <li>\u5e94\u7528\u7a0b\u5e8f\u5728\u8fd0\u884c\u65f6\u6709\u81ea\u5df1\u6240\u5728\u7684\u5185\u5b58\u7a7a\u95f4\u548c\u6808\uff0c\u786e\u4fdd\u88ab\u5207\u6362\u65f6\u76f8\u5173\u4fe1\u606f\u4e0d\u4f1a\u88ab\u5176\u4ed6\u5e94\u7528\u7834\u574f\u3002\u5982\u679c\u5f53\u524d\u5e94\u7528\u7a0b\u5e8f\u6b63\u5728\u8fd0\u884c\uff0c\u5219\u8be5\u5e94\u7528\u5bf9\u5e94\u7684\u4efb\u52a1\u5904\u4e8e\u8fd0\u884c\uff08Running\uff09\u72b6\u6001\uff1b\u5982\u679c\u8be5\u5e94\u7528\u4e3b\u52a8\u653e\u5f03\u5904\u7406\u5668\uff0c\u5219\u8be5\u5e94\u7528\u5bf9\u5e94\u7684\u4efb\u52a1\u5904\u4e8e\u5c31\u7eea\uff08Ready\uff09\u72b6\u6001\u3002</li> <li>\u64cd\u4f5c\u7cfb\u7edf\u8fdb\u884c\u4efb\u52a1\u5207\u6362\u65f6\uff0c\u9700\u8981\u628a\u8981\u6682\u505c\u4efb\u52a1\u7684\u4e0a\u4e0b\u6587\uff08\u5373\u4efb\u52a1\u7528\u5230\u7684\u901a\u7528\u5bc4\u5b58\u5668\uff09\u4fdd\u5b58\u8d77\u6765\uff0c\u628a\u8981\u7ee7\u7eed\u6267\u884c\u7684\u4efb\u52a1\u7684\u4e0a\u4e0b\u6587\u6062\u590d\u4e3a\u6682\u505c\u524d\u7684\u5185\u5bb9\uff0c\u8fd9\u6837\u5c31\u80fd\u8ba9\u4e0d\u540c\u7684\u5e94\u7528\u534f\u540c\u4f7f\u7528\u5904\u7406\u5668\u4e86\u3002</li> </ul>"},{"location":"notes/rcore/TimeSharingOS/#timersharingos","title":"TimersharingOS","text":"<ul> <li>TimesharingOS \u6700\u5927\u7684\u53d8\u5316\u662f\u6539\u8fdb\u4e86 Trap_handler \u5185\u6838\u6a21\u5757\uff0c\u652f\u6301\u65f6\u949f\u4e2d\u65ad\uff0c\u4ece\u800c\u53ef\u4ee5\u62a2\u5360\u5e94\u7528\u7684\u6267\u884c\u3002</li> <li>\u5e76\u901a\u8fc7\u8fdb\u4e00\u6b65\u6539\u8fdb TaskManager \u5185\u6838\u6a21\u5757\uff0c\u63d0\u4f9b\u4efb\u52a1\u8c03\u5ea6\u529f\u80fd\uff0c\u8fd9\u6837\u53ef\u4ee5\u5728\u6536\u5230\u65f6\u949f\u4e2d\u65ad\u540e\u7edf\u8ba1\u4efb\u52a1\u7684\u4f7f\u7528\u65f6\u95f4\u7247\uff0c\u5982\u679c\u4efb\u52a1\u7684\u65f6\u95f4\u7247\u7528\u5b8c\u540e\uff0c\u5219\u5207\u6362\u4efb\u52a1\u3002\u4ece\u800c\u53ef\u4ee5\u516c\u5e73\u548c\u9ad8\u6548\u5730\u5206\u65f6\u6267\u884c\u591a\u4e2a\u5e94\u7528\uff0c\u63d0\u9ad8\u7cfb\u7edf\u7684\u6574\u4f53\u6548\u7387\u3002</li> </ul>"},{"location":"notes/rcore/TimeSharingOS/#_1","title":"\u591a\u9053\u7a0b\u5e8f\u653e\u7f6e\u4e0e\u52a0\u8f7d","text":""},{"location":"notes/rcore/TimeSharingOS/#_2","title":"\u653e\u7f6e","text":"<ul> <li>\u6bcf\u4e2a app \u7684\u8d77\u59cb\u5730\u5740\u4e3a<code>hex(base_address+step*app_id)</code>\uff0c\u5b9e\u73b0\u8d77\u59cb\u5730\u5740\u7684\u4e0d\u540c</li> </ul> Python<pre><code> # user/build.py\n\n import os\n\n base_address = 0x80400000\n step = 0x20000\n linker = 'src/linker.ld'\n\n app_id = 0\n apps = os.listdir('src/bin')\n apps.sort()\n for app in apps:\n     app = app[:app.find('.')]\n     lines = []\n     lines_before = []\n     with open(linker, 'r') as f:\n         for line in f.readlines():\n             lines_before.append(line)\n             line = line.replace(hex(base_address), hex(base_address+step*app_id))\n             lines.append(line)\n     with open(linker, 'w+') as f:\n         f.writelines(lines)\n     os.system('cargo build --bin %s --release' % app)\n     print('[build.py] application %s start with address %s' %(app, hex(base_address+step*app_id)))\n     with open(linker, 'w+') as f:\n         f.writelines(lines_before)\n     app_id = app_id + 1\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#_3","title":"\u52a0\u8f7d","text":"<ul> <li>\u7b2c i \u4e2a\u5e94\u7528\u52a0\u8f7d\u5230\u4e0d\u540c\u7684\u7269\u7406\u5730\u5740\u4e0a<code>APP_BASE_ADDRESS + i * APP_SIZE_LIMIT</code></li> </ul> Rust<pre><code> // os/src/loader.rs\n\n fn get_base_i(app_id: usize) -&gt; usize {\n     APP_BASE_ADDRESS + app_id * APP_SIZE_LIMIT\n }\n\n pub fn load_apps() {\n     extern \"C\" { fn _num_app(); }\n     let num_app_ptr = _num_app as usize as *const usize;\n     let num_app = get_num_app();\n     let app_start = unsafe {\n         core::slice::from_raw_parts(num_app_ptr.add(1), num_app + 1)\n     };\n     // load apps\n     for i in 0..num_app {\n         let base_i = get_base_i(i);\n         // clear region\n         (base_i..base_i + APP_SIZE_LIMIT).for_each(|addr| unsafe {\n             (addr as *mut u8).write_volatile(0)\n         });\n         // load app from data section to memory\n         let src = unsafe {\n             core::slice::from_raw_parts(\n                 app_start[i] as *const u8,\n                 app_start[i + 1] - app_start[i]\n             )\n         };\n         let dst = unsafe {\n             core::slice::from_raw_parts_mut(base_i as *mut u8, src.len())\n         };\n         dst.copy_from_slice(src);\n     }\n     unsafe {\n         asm!(\"fence.i\");\n     }\n }\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#_4","title":"\u4efb\u52a1\u5207\u6362","text":"<ul> <li> <p>\u5728\u5185\u6838\u4e2d\u8fd9\u79cd\u673a\u5236\u662f\u5728 <code>__switch</code> \u51fd\u6570\u4e2d\u5b9e\u73b0\u7684\u3002 \u4efb\u52a1\u5207\u6362\u652f\u6301\u7684\u573a\u666f\u662f\uff1a\u4e00\u4e2a\u5e94\u7528\u5728\u8fd0\u884c\u9014\u4e2d\u4fbf\u4f1a\u4e3b\u52a8\u6216\u88ab\u52a8\u4ea4\u51fa CPU \u7684\u4f7f\u7528\u6743\uff0c\u6b64\u65f6\u5b83\u53ea\u80fd\u6682\u505c\u6267\u884c\uff0c\u7b49\u5230\u5185\u6838\u91cd\u65b0\u7ed9\u5b83\u5206\u914d\u5904\u7406\u5668\u8d44\u6e90\u4e4b\u540e\u624d\u80fd\u6062\u590d\u5e76\u7ee7\u7eed\u6267\u884c\u3002</p> </li> <li> <p>\u4efb\u52a1\u5207\u6362\u662f\u6765\u81ea\u4e24\u4e2a\u4e0d\u540c\u5e94\u7528\u5728\u5185\u6838\u4e2d\u7684 Trap \u63a7\u5236\u6d41\u4e4b\u95f4\u7684\u5207\u6362\u3002\u5f53\u4e00\u4e2a\u5e94\u7528 Trap \u5230 S \u6a21\u5f0f\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u4e2d\u8fdb\u884c\u8fdb\u4e00\u6b65\u5904\u7406\uff08\u5373\u8fdb\u5165\u4e86\u64cd\u4f5c\u7cfb\u7edf\u7684 Trap \u63a7\u5236\u6d41\uff09\u7684\u65f6\u5019\uff0c\u5176 Trap \u63a7\u5236\u6d41\u53ef\u4ee5\u8c03\u7528\u4e00\u4e2a\u7279\u6b8a\u7684 <code>__switch</code> \u51fd\u6570\u3002</p> </li> <li> <p>\u8fd9\u4e2a\u51fd\u6570\u8868\u9762\u4e0a\u5c31\u662f\u4e00\u4e2a\u666e\u901a\u7684\u51fd\u6570\u8c03\u7528\uff1a\u5728 <code>__switch</code> \u8fd4\u56de\u4e4b\u540e\uff0c\u5c06\u7ee7\u7eed\u4ece\u8c03\u7528\u8be5\u51fd\u6570\u7684\u4f4d\u7f6e\u7ee7\u7eed\u5411\u4e0b\u6267\u884c\u3002\u4f46\u662f\u5176\u95f4\u5374\u9690\u85cf\u7740\u590d\u6742\u7684\u63a7\u5236\u6d41\u5207\u6362\u8fc7\u7a0b\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u8c03\u7528 <code>__switch</code> \u4e4b\u540e\u76f4\u5230\u5b83\u8fd4\u56de\u524d\u7684\u8fd9\u6bb5\u65f6\u95f4\uff0c</p> </li> <li> <p>\u539f Trap \u63a7\u5236\u6d41 A \u4f1a\u5148\u88ab\u6682\u505c\u5e76\u88ab\u5207\u6362\u51fa\u53bb\uff0c CPU \u8f6c\u800c\u8fd0\u884c\u53e6\u4e00\u4e2a\u5e94\u7528\u5728\u5185\u6838\u4e2d\u7684 Trap \u63a7\u5236\u6d41 B \u3002</p> </li> <li>\u7136\u540e\u5728\u67d0\u4e2a\u5408\u9002\u7684\u65f6\u673a\uff0c\u539f Trap \u63a7\u5236\u6d41 A \u624d\u4f1a\u4ece\u67d0\u4e00\u6761 Trap \u63a7\u5236\u6d41 C \uff08\u5f88\u6709\u53ef\u80fd\u4e0d\u662f\u5b83\u4e4b\u524d\u5207\u6362\u5230\u7684 B \uff09\u5207\u6362\u56de\u6765\u7ee7\u7eed\u6267\u884c\u5e76\u6700\u7ec8\u8fd4\u56de\u3002</li> <li>\u4e0d\u8fc7\uff0c\u4ece\u5b9e\u73b0\u7684\u89d2\u5ea6\u8bb2\uff0c <code>__switch</code> \u51fd\u6570\u548c\u4e00\u4e2a\u666e\u901a\u7684\u51fd\u6570\u4e4b\u95f4\u7684\u6838\u5fc3\u5dee\u522b\u4ec5\u4ec5\u662f\u5b83\u4f1a \u6362\u6808 \u3002</li> </ul>"},{"location":"notes/rcore/TimeSharingOS/#_5","title":"\u8bbe\u8ba1\u4e0e\u5b9e\u73b0","text":"<ul> <li>\u5bf9\u4e8e\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u4efb\u52a1\u7684 Trap \u63a7\u5236\u6d41\uff0c\u6211\u4eec\u7528\u4e00\u4e2a\u540d\u4e3a <code>current_task_cx_ptr</code> \u7684\u53d8\u91cf\u6765\u4fdd\u5b58\u653e\u7f6e\u5f53\u524d\u4efb\u52a1\u4e0a\u4e0b\u6587\u7684\u5730\u5740\uff1b\u800c\u7528 <code>next_task_cx_ptr</code> \u7684\u53d8\u91cf\u6765\u4fdd\u5b58\u653e\u7f6e\u4e0b\u4e00\u4e2a\u8981\u6267\u884c\u4efb\u52a1\u7684\u4e0a\u4e0b\u6587\u7684\u5730\u5740\u3002\u5229\u7528 C \u8bed\u8a00\u7684\u5f15\u7528\u6765\u63cf\u8ff0\u7684\u8bdd\u5c31\u662f\uff1a</li> </ul> C<pre><code>TaskContext *current_task_cx_ptr = &amp;tasks[current].task_cx;\nTaskContext *next_task_cx_ptr    = &amp;tasks[next].task_cx;\n</code></pre> <ul> <li>\u4efb\u52a1\u5207\u6362\u5305\u542b 4 \u4e2a\u9636\u6bb5   1. \u5728 Trap \u63a7\u5236\u6d41 A \u8c03\u7528 <code>__switch</code> \u4e4b\u524d\uff0cA \u7684\u5185\u6838\u6808\u4e0a\u53ea\u6709 Trap \u4e0a\u4e0b\u6587\u548c Trap \u5904\u7406\u51fd\u6570\u7684\u8c03\u7528\u6808\u4fe1\u606f\uff0c\u800c B \u662f\u4e4b\u524d\u88ab\u5207\u6362\u51fa\u53bb\u7684\uff1b   1. A \u5728 A \u4efb\u52a1\u4e0a\u4e0b\u6587\u7a7a\u95f4\u5728\u91cc\u9762\u4fdd\u5b58 CPU \u5f53\u524d\u7684\u5bc4\u5b58\u5668\u5feb\u7167\uff1b   1. \u8bfb\u53d6 <code>next_task_cx_ptr</code> \u6307\u5411\u7684 B \u4efb\u52a1\u4e0a\u4e0b\u6587\uff0c\u6839\u636e B \u4efb\u52a1\u4e0a\u4e0b\u6587\u4fdd\u5b58\u7684\u5185\u5bb9\u6765\u6062\u590d <code>ra</code> \u5bc4\u5b58\u5668\u3001<code>s0~s11</code> \u5bc4\u5b58\u5668\u4ee5\u53ca <code>sp</code> \u5bc4\u5b58\u5668\u3002\u53ea\u6709\u8fd9\u4e00\u6b65\u505a\u5b8c\u540e\uff0c <code>__switch</code> \u624d\u80fd\u505a\u5230\u4e00\u4e2a\u51fd\u6570\u8de8\u4e24\u6761\u63a7\u5236\u6d41\u6267\u884c\uff0c\u5373 \u901a\u8fc7\u6362\u6808\u4e5f\u5c31\u5b9e\u73b0\u4e86\u63a7\u5236\u6d41\u7684\u5207\u6362 \u3002   1. \u4e0a\u4e00\u6b65\u5bc4\u5b58\u5668\u6062\u590d\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u770b\u5230\u901a\u8fc7\u6062\u590d <code>sp</code> \u5bc4\u5b58\u5668\u6362\u5230\u4e86\u4efb\u52a1 B \u7684\u5185\u6838\u6808\u4e0a\uff0c\u8fdb\u800c\u5b9e\u73b0\u4e86\u63a7\u5236\u6d41\u7684\u5207\u6362\u3002\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 <code>__switch</code> \u80fd\u505a\u5230\u4e00\u4e2a\u51fd\u6570\u8de8\u4e24\u6761\u63a7\u5236\u6d41\u6267\u884c\u3002\u6b64\u540e\uff0c\u5f53 CPU \u6267\u884c <code>ret</code> \u6c47\u7f16\u4f2a\u6307\u4ee4\u5b8c\u6210 <code>__switch</code> \u51fd\u6570\u8fd4\u56de\u540e\uff0c\u4efb\u52a1 B \u53ef\u4ee5\u4ece\u8c03\u7528 <code>__switch</code> \u7684\u4f4d\u7f6e\u7ee7\u7eed\u5411\u4e0b\u6267\u884c\u3002</li> <li>\u4ece\u7ed3\u679c\u6765\u770b\uff0c\u6211\u4eec\u770b\u5230 A \u63a7\u5236\u6d41 \u548c B \u63a7\u5236\u6d41\u7684\u72b6\u6001\u53d1\u751f\u4e86\u4e92\u6362\uff0c A \u5728\u4fdd\u5b58\u4efb\u52a1\u4e0a\u4e0b\u6587\u4e4b\u540e\u8fdb\u5165\u6682\u505c\u72b6\u6001\uff0c\u800c B \u5219\u6062\u590d\u4e86\u4e0a\u4e0b\u6587\u5e76\u5728 CPU \u4e0a\u7ee7\u7eed\u6267\u884c\u3002</li> </ul>"},{"location":"notes/rcore/TimeSharingOS/#__switch","title":"__switch \u5b9e\u73b0","text":"Rust<pre><code>// os/src/task/switch.rs\n\nglobal_asm!(include_str!(\"switch.S\"));\n\nuse super::TaskContext;\n\nextern \"C\" {\n    pub fn __switch(\n        current_task_cx_ptr: *mut TaskContext,\n        next_task_cx_ptr: *const TaskContext\n    );\n}\n</code></pre> Text Only<pre><code># os/src/task/switch.S\n\n.altmacro\n.macro SAVE_SN n\n    sd s\\n, (\\n+2)*8(a0)\n.endm\n.macro LOAD_SN n\n    ld s\\n, (\\n+2)*8(a1)\n.endm\n    .section .text\n    .globl __switch\n__switch:\n    # \u9636\u6bb5 [1]\n    # __switch(\n    #     current_task_cx_ptr: *mut TaskContext,\n    #     next_task_cx_ptr: *const TaskContext\n    # )\n    # \u9636\u6bb5 [2]\n    # save kernel stack of current task\n    sd sp, 8(a0)\n    # save ra &amp; s0~s11 of current execution\n    sd ra, 0(a0)\n    .set n, 0\n    .rept 12\n        SAVE_SN %n\n        .set n, n + 1\n    .endr\n    # \u9636\u6bb5 [3]\n    # restore ra &amp; s0~s11 of next execution\n    ld ra, 0(a1)\n    .set n, 0\n    .rept 12\n        LOAD_SN %n\n        .set n, n + 1\n    .endr\n    # restore kernel stack of next task\n    ld sp, 8(a1)\n    # \u9636\u6bb5 [4]\n    ret\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#taskcontext","title":"TaskContext","text":"Rust<pre><code>// os/src/task/context.rs\n\npub struct TaskContext {\n    ra: usize,\n    sp: usize,\n    s: [usize; 12],\n}\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#_6","title":"\u4efb\u52a1\u7ba1\u7406\u5668","text":""},{"location":"notes/rcore/TimeSharingOS/#tcb","title":"\u4efb\u52a1\u63a7\u5236\u5757(TCB)","text":"Rust<pre><code>// os/src/task/task.rs\n\n#[derive(Copy, Clone)]\npub struct TaskControlBlock {\n    pub task_status: TaskStatus,\n    pub task_cx: TaskContext,\n}\n</code></pre> <ul> <li><code>TaskContext::goto_restore</code>\u5c06<code>ra</code>\u8bbe\u7f6e\u4e3a<code>__restore</code>\uff1b\u56e0\u4e3a\u5207\u6362\u4efb\u52a1\u65f6\u6211\u4eec\u8bbe\u5b9a\u5185\u6838\u6808\u6808\u4e2d\u5305\u542b<code>__alltraps</code>\u548c<code>trap_handler</code>\u7684\u6808\u5e27</li> <li>\u5f53\u6267\u884c\u7b2c\u4e00\u4e2a\u7a0b\u5e8f\u65f6\uff0c\u6211\u4eec\u9700\u8981\u5411\u5185\u6838\u6808\u4e2d\u538b\u5165\u4e00\u4e2a<code>TrapContext</code></li> </ul> Rust<pre><code>// os/src/loader.rs\n\npub fn init_app_cx(app_id: usize) -&gt; usize {\n    KERNEL_STACK[app_id].push_context(\n        TrapContext::app_init_context(get_base_i(app_id), USER_STACK[app_id].get_sp()),\n    )\n}\n// os/src/task/mod.rs\n\npub struct TaskManager {\n    num_app: usize,\n    inner: UPSafeCell&lt;TaskManagerInner&gt;,\n}\n\nstruct TaskManagerInner {\n    tasks: [TaskControlBlock; MAX_APP_NUM],\n    current_task: usize,\n}\n\nlazy_static! {\n    pub static ref TASK_MANAGER: TaskManager = {\n        let num_app = get_num_app();\n        let mut tasks = [\n            TaskControlBlock {\n                task_cx: TaskContext::zero_init(),\n                task_status: TaskStatus::UnInit\n            };\n            MAX_APP_NUM\n        ];\n        for i in 0..num_app {\n            tasks[i].task_cx = TaskContext::goto_restore(init_app_cx(i));\n            tasks[i].task_status = TaskStatus::Ready;\n        }\n        TaskManager {\n            num_app,\n            inner: unsafe { UPSafeCell::new(TaskManagerInner {\n                tasks,\n                current_task: 0,\n            })},\n        }\n    };\n}\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#sys_yield-sys_exit","title":"sys_yield \u548c sys_exit \u7cfb\u7edf\u8c03\u7528","text":"Rust<pre><code>// os/src/syscall/process.rs\n\nuse crate::task::suspend_current_and_run_next;\n\npub fn sys_yield() -&gt; isize {\n    suspend_current_and_run_next();\n    0\n}\n// os/src/syscall/process.rs\n\nuse crate::task::exit_current_and_run_next;\n\npub fn sys_exit(exit_code: i32) -&gt; ! {\n    println!(\"[kernel] Application exited with code {}\", exit_code);\n    exit_current_and_run_next();\n    panic!(\"Unreachable in sys_exit!\");\n}\n</code></pre> <ul> <li><code>suspend_current_and_run_next</code>\u548c<code>exit_current_and_run_next</code>\u5747\u662f\u5207\u6362\u5f53\u524d Task \u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\u5e94\u7528</li> </ul> Rust<pre><code>// os/src/task/mod.rs\n\nfn mark_current_suspended() {\n    TASK_MANAGER.mark_current_suspended();\n}\n\nfn mark_current_exited() {\n    TASK_MANAGER.mark_current_exited();\n}\n\nimpl TaskManager {\n    fn mark_current_suspended(&amp;self) {\n        let mut inner = self.inner.borrow_mut();\n        let current = inner.current_task;\n        inner.tasks[current].task_status = TaskStatus::Ready;\n    }\n\n    fn mark_current_exited(&amp;self) {\n        let mut inner = self.inner.borrow_mut();\n        let current = inner.current_task;\n        inner.tasks[current].task_status = TaskStatus::Exited;\n    }\n}\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#run_next_task","title":"run_next_task","text":"Rust<pre><code>// os/src/task/mod.rs\n\nfn run_next_task() {\n    TASK_MANAGER.run_next_task();\n}\n\nimpl TaskManager {\n    fn run_next_task(&amp;self) {\n        if let Some(next) = self.find_next_task() {\n            let mut inner = self.inner.exclusive_access();\n            let current = inner.current_task;\n            inner.tasks[next].task_status = TaskStatus::Running;\n            inner.current_task = next;\n            let current_task_cx_ptr = &amp;mut inner.tasks[current].task_cx as *mut TaskContext;\n            let next_task_cx_ptr = &amp;inner.tasks[next].task_cx as *const TaskContext;\n            drop(inner);\n            // before this, we should drop local variables that must be dropped manually\n            unsafe {\n                __switch(\n                    current_task_cx_ptr,\n                    next_task_cx_ptr,\n                );\n            }\n            // go back to user mode\n        } else {\n            panic!(\"All applications completed!\");\n        }\n    }\n}\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#round-robin","title":"\u65f6\u95f4\u7247\u8f6e\u8f6c\u8c03\u5ea6(Round-Robin)","text":""},{"location":"notes/rcore/TimeSharingOS/#_7","title":"\u65f6\u949f\u4e2d\u65ad\u4e0e\u8ba1\u65f6\u5668","text":"<ul> <li>\u5728 RISC-V 64 \u67b6\u6784\u4e0a\uff0c\u8be5\u8ba1\u6570\u5668\u4fdd\u5b58\u5728\u4e00\u4e2a 64 \u4f4d\u7684 CSR <code>mtime</code> \u4e2d\uff0c\u6211\u4eec\u65e0\u9700\u62c5\u5fc3\u5b83\u7684\u6ea2\u51fa\u95ee\u9898\uff0c\u5728\u5185\u6838\u8fd0\u884c\u5168\u7a0b\u53ef\u4ee5\u8ba4\u4e3a\u5b83\u662f\u4e00\u76f4\u9012\u589e\u7684\u3002</li> <li>\u53e6\u5916\u4e00\u4e2a 64 \u4f4d\u7684 CSR <code>mtimecmp</code> \u7684\u4f5c\u7528\u662f\uff1a\u4e00\u65e6\u8ba1\u6570\u5668 <code>mtime</code> \u7684\u503c\u8d85\u8fc7\u4e86 <code>mtimecmp</code>\uff0c\u5c31\u4f1a\u89e6\u53d1\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u3002\u8fd9\u4f7f\u5f97\u6211\u4eec\u53ef\u4ee5\u65b9\u4fbf\u7684\u901a\u8fc7\u8bbe\u7f6e <code>mtimecmp</code> \u7684\u503c\u6765\u51b3\u5b9a\u4e0b\u4e00\u6b21\u65f6\u949f\u4e2d\u65ad\u4f55\u65f6\u89e6\u53d1\u3002</li> <li>\u53ef\u60dc\u7684\u662f\uff0c\u5b83\u4eec\u90fd\u662f M \u7279\u6743\u7ea7\u7684 CSR \uff0c\u800c\u6211\u4eec\u7684\u5185\u6838\u5904\u5728 S \u7279\u6743\u7ea7\uff0c\u662f\u4e0d\u88ab\u5141\u8bb8\u76f4\u63a5\u8bbf\u95ee\u5b83\u4eec\u7684\u3002\u597d\u5728\u8fd0\u884c\u5728 M \u7279\u6743\u7ea7\u7684 SEE \uff08\u8fd9\u91cc\u662f RustSBI\uff09\u5df2\u7ecf\u9884\u7559\u4e86\u76f8\u5e94\u7684\u63a5\u53e3\uff0c\u6211\u4eec\u53ef\u4ee5\u8c03\u7528\u5b83\u4eec\u6765\u95f4\u63a5\u5b9e\u73b0\u8ba1\u65f6\u5668\u7684\u63a7\u5236</li> <li>\u5e38\u6570 <code>CLOCK_FREQ</code> \u662f\u4e00\u4e2a\u9884\u5148\u83b7\u53d6\u5230\u7684\u5404\u5e73\u53f0\u4e0d\u540c\u7684\u65f6\u949f\u9891\u7387\uff0c\u5355\u4f4d\u4e3a\u8d6b\u5179\uff0c\u4e5f\u5c31\u662f\u4e00\u79d2\u949f\u4e4b\u5185\u8ba1\u6570\u5668\u7684\u589e\u91cf\u3002</li> </ul> Rust<pre><code>// os/src/timer.rs\n\nuse riscv::register::time;\n\npub fn get_time() -&gt; usize {\n    time::read()\n}\n// os/src/sbi.rs\n\nconst SBI_SET_TIMER: usize = 0;\n\npub fn set_timer(timer: usize) {\n    sbi_call(SBI_SET_TIMER, timer, 0, 0);\n}\n</code></pre> <ul> <li><code>set_next_trigger</code>\u8bbe\u7f6e\u4e0b\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad</li> <li><code>get_time_us</code> \u4ee5\u5fae\u79d2\u4e3a\u5355\u4f4d\u8fd4\u56de\u5f53\u524d\u8ba1\u6570\u5668\u7684\u503c</li> </ul> Rust<pre><code>// os/src/timer.rs\n\nuse crate::config::CLOCK_FREQ;\nconst TICKS_PER_SEC: usize = 100;\n\npub fn set_next_trigger() {\n    set_timer(get_time() + CLOCK_FREQ / TICKS_PER_SEC);\n}\n\n// os/src/timer.rs\n\nconst MICRO_PER_SEC: usize = 1_000_000;\n\npub fn get_time_us() -&gt; usize {\n    time::read() / (CLOCK_FREQ / MICRO_PER_SEC)\n}\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#_8","title":"\u62a2\u5360\u5f0f\u8c03\u5ea6","text":"Rust<pre><code>// os/src/trap/mod.rs\n\nmatch scause.cause() {\n    Trap::Interrupt(Interrupt::SupervisorTimer) =&gt; {\n        set_next_trigger();\n        suspend_current_and_run_next();\n    }\n}\n</code></pre> <ul> <li>\u6211\u4eec\u53ea\u9700\u5728 <code>trap_handler</code> \u51fd\u6570\u4e0b\u65b0\u589e\u4e00\u4e2a\u6761\u4ef6\u5206\u652f\u8df3\u8f6c\uff0c\u5f53\u53d1\u73b0\u89e6\u53d1\u4e86\u4e00\u4e2a S \u7279\u6743\u7ea7\u65f6\u949f\u4e2d\u65ad\u7684\u65f6\u5019\uff0c\u9996\u5148\u91cd\u65b0\u8bbe\u7f6e\u4e00\u4e2a 10ms \u7684\u8ba1\u65f6\u5668\uff0c\u7136\u540e\u8c03\u7528\u4e0a\u4e00\u5c0f\u8282\u63d0\u5230\u7684 <code>suspend_current_and_run_next</code> \u51fd\u6570\u6682\u505c\u5f53\u524d\u5e94\u7528\u5e76\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\u3002</li> <li>\u521d\u59cb\u5316\u8bbe\u7f6e</li> </ul> Rust<pre><code>// os/src/main.rs\n\n#[no_mangle]\npub fn rust_main() -&gt; ! {\n    clear_bss();\n    println!(\"[kernel] Hello, world!\");\n    trap::init();\n    loader::load_apps();\n\n    trap::enable_timer_interrupt();\n    timer::set_next_trigger();\n\n    task::run_first_task();\n    panic!(\"Unreachable in rust_main!\");\n}\n\n// os/src/trap/mod.rs\n\nuse riscv::register::sie;\n\npub fn enable_timer_interrupt() {\n    unsafe { sie::set_stimer(); }\n}\n</code></pre>"},{"location":"notes/rcore/TimeSharingOS/#sleep","title":"sleep","text":"<ul> <li>\u76ee\u524d\u5728\u7b49\u5f85\u67d0\u4e9b\u4e8b\u4ef6\u7684\u65f6\u5019\u4ecd\u7136\u9700\u8981<code>yield</code> \uff0c\u5176\u4e2d\u4e00\u4e2a\u539f\u56e0\u662f\u4e3a\u4e86\u8282\u7ea6 CPU \u8ba1\u7b97\u8d44\u6e90\uff0c\u53e6\u4e00\u4e2a\u539f\u56e0\u662f\u5f53\u4e8b\u4ef6\u4f9d\u8d56\u4e8e\u5176\u4ed6\u7684\u5e94\u7528\u7684\u65f6\u5019\uff0c\u7531\u4e8e\u53ea\u6709\u4e00\u4e2a CPU\uff0c\u5f53\u524d\u5e94\u7528\u7684\u7b49\u5f85\u53ef\u80fd\u6c38\u8fdc\u4e0d\u4f1a\u7ed3\u675f\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\u9700\u8981\u5148\u5c06\u5b83\u5207\u6362\u51fa\u53bb\uff0c\u4f7f\u5f97\u5176\u4ed6\u7684\u5e94\u7528\u5230\u8fbe\u5b83\u6240\u671f\u5f85\u7684\u72b6\u6001\u5e76\u6ee1\u8db3\u4e8b\u4ef6\u7684\u751f\u6210\u6761\u4ef6\uff0c\u518d\u5207\u6362\u56de\u6765\u3002</li> <li>\u8fd9\u91cc\u6211\u4eec\u5148\u901a\u8fc7 yield \u6765\u4f18\u5316 \u8f6e\u8be2 (Busy Loop) \u8fc7\u7a0b\u5e26\u6765\u7684 CPU \u8d44\u6e90\u6d6a\u8d39\u3002\u5728 <code>03sleep</code> \u8fd9\u4e2a\u5e94\u7528\u4e2d\uff1a</li> </ul> Rust<pre><code>// user/src/bin/03sleep.rs\n\n#[no_mangle]\nfn main() -&gt; i32 {\n    let current_timer = get_time();\n    let wait_for = current_timer + 3000;\n    while get_time() &lt; wait_for {\n        yield_();\n    }\n    println!(\"Test sleep OK!\");\n    0\n}\n</code></pre>"},{"location":"notes/rcore/rustlings/","title":"Rustlings","text":"2025-12-022025-12-10 <p>title: rustlings created: 2024-04-09 update: comments: true description: rustlings\u4e2d\u4f7f\u7528\u7684rust\u6280\u5de7 katex: true tags:</p> <ul> <li>rust   categories: Project</li> </ul>"},{"location":"notes/rcore/rustlings/#rustlings","title":"Rustlings","text":"<p> \u7ea6 831 \u4e2a\u5b57  142 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p>"},{"location":"notes/rcore/rustlings/#option2","title":"Option2","text":"<ul> <li>\u8c03\u7528\u00b7<code>vec</code>\u7684<code>pop</code> \u65b9\u6cd5\u65f6\uff0c\u5b83\u4f1a\u4ece\u6570\u7ec4\u7684\u672b\u5c3e\u79fb\u9664\u4e00\u4e2a\u5143\u7d20\uff0c\u5e76\u8fd4\u56de\u88ab\u79fb\u9664\u7684\u5143\u7d20\u4f5c\u4e3a <code>Option&lt;T&gt;</code>\u3002\u56e0\u6b64\uff0c\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u7531\u4e8e\u6570\u7ec4\u7684\u7c7b\u578b\u662f <code>Vec&lt;Option&lt;i8&gt;&gt;</code>\uff0c\u6240\u4ee5 <code>pop</code> \u65b9\u6cd5\u8fd4\u56de\u7684\u7c7b\u578b\u662f <code>Option&lt;Option&lt;i8&gt;&gt;</code></li> </ul>"},{"location":"notes/rcore/rustlings/#_1","title":"\u9519\u8bef\u5904\u7406","text":"<ul> <li><code>Result&lt;String, String&gt;</code>\uff1a\u7b2c\u4e00\u4e2a\u7c7b\u578b\u662f<code>Ok()</code>\u4e2d\u7684\u6570\u636e\u7c7b\u578b\uff0c\u7b2c\u4e8c\u4e2a\u7c7b\u578b\u662f<code>Err()</code>\u4e2d\u7684\u7c7b\u578b</li> </ul> Rust<pre><code>use std::fmt::Error;\n\npub fn generate_nametag_text(name: String) -&gt; Result&lt;String, String&gt; {\n    if name.is_empty() {\n        // Empty names aren't allowed.\n        Err(\"`name` was empty; it must be nonempty.\".into())\n    } else {\n        Ok(format!(\"Hi! My name is {}\", name))\n    }\n}\n</code></pre> <ul> <li><code>?</code>\u76f8\u5f53\u4e8e\u5982\u4e0b<code>match</code>\u5339\u914d\u4ee3\u7801\uff1b\u8c03\u7528<code>?</code>\u7684\u51fd\u6570\u8fd4\u56de\u503c\u5fc5\u987b\u4e3a<code>Result</code>\u6216<code>Option</code>\u7c7b\u578b\uff0c\u6709\u65f6\u5019\u9700\u8981\u6539\u5199<code>main</code>\u51fd\u6570\u8fd4\u56de\u503c\u7c7b\u578b</li> </ul> Rust<pre><code>let x = match qty {\n    Ok(x) =&gt; x * cost_per_item + processing_fee,\n    Err(e) =&gt; return Err(e),\n};\n\nOk(x)\n\nfn main() -&gt; Result&lt;(), ParseIntError&gt; {\n    let mut tokens = 100;\n    let pretend_user_input = \"8\";\n\n    let cost = total_cost(pretend_user_input)?;\n\n    if cost &gt; tokens {\n        println!(\"You can't afford that many!\");\n    } else {\n        tokens -= cost;\n        println!(\"You now have {} tokens.\", tokens);\n    }\n    Ok(())\n}\n</code></pre>"},{"location":"notes/rcore/rustlings/#test","title":"Test","text":"<ul> <li><code>#[should_panic]</code>\u7279\u6027\uff0c\u5141\u8bb8\u6d4b\u8bd5\u4ee3\u7801\u51fa\u73b0Panic\u800c\u4e0d\u7ec8\u6b62\u8fd0\u884c\u3002</li> </ul>"},{"location":"notes/rcore/rustlings/#_2","title":"\u8fed\u4ee3\u5668","text":"<ul> <li>\u6d88\u8d39\u8005\u9002\u914d\u5668\u662f\u6d88\u8d39\u6389\u8fed\u4ee3\u5668\uff0c\u7136\u540e\u8fd4\u56de\u4e00\u4e2a\u503c\u3002\u90a3\u4e48\u8fed\u4ee3\u5668\u9002\u914d\u5668\uff0c\u987e\u540d\u601d\u4e49\uff0c\u4f1a\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684\u8fed\u4ee3\u5668\uff0c\u8fd9\u662f\u5b9e\u73b0\u94fe\u5f0f\u65b9\u6cd5\u8c03\u7528\u7684\u5173\u952e\uff1a<code>v.iter().map().filter()...</code>\u3002</li> <li>\u4e0e\u6d88\u8d39\u8005\u9002\u914d\u5668\u4e0d\u540c\uff0c\u8fed\u4ee3\u5668\u9002\u914d\u5668\u662f\u60f0\u6027\u7684\uff0c\u610f\u5473\u7740\u4f60\u9700\u8981\u4e00\u4e2a\u6d88\u8d39\u8005\u9002\u914d\u5668\u6765\u6536\u5c3e\uff0c\u6700\u7ec8\u5c06\u8fed\u4ee3\u5668\u8f6c\u6362\u6210\u4e00\u4e2a\u5177\u4f53\u7684\u503c</li> </ul> Rust<pre><code>let v1: Vec&lt;i32&gt; = vec![1, 2, 3];\n\nlet v2: Vec&lt;_&gt; = v1.iter().map(|x| x + 1).collect();\n\nassert_eq!(v2, vec![2, 3, 4]);\n</code></pre> <ul> <li><code>collect</code>\u4f1a\u81ea\u52a8\u6839\u636e\u6307\u5b9a\u7c7b\u578b\u5bf9\u6570\u636e\u8fdb\u884c\u6536\u96c6</li> </ul> Rust<pre><code>// Complete the function and return a value of the correct type so the test\n// passes.\n// Desired output: Ok([1, 11, 1426, 3])\nfn result_with_list() -&gt; Result&lt;Vec&lt;i32&gt;, DivisionError&gt; {\n    let numbers = vec![27, 297, 38502, 81];\n    let division_results = numbers.into_iter().map(|n| divide(n, 27)).collect();\n    division_results\n}\n\n// Complete the function and return a value of the correct type so the test\n// passes.\n// Desired output: [Ok(1), Ok(11), Ok(1426), Ok(3)]\nfn list_of_results() -&gt; Vec&lt;Result&lt;i32, DivisionError&gt;&gt; {\n    let numbers = vec![27, 297, 38502, 81];\n    let division_results = numbers.into_iter().map(|n| divide(n, 27)).collect();\n    division_results\n}\n</code></pre> <ul> <li><code>product</code>\u76f4\u63a5\u5c06\u8fed\u4ee3\u5668\u5143\u7d20\u76f8\u4e58\uff0c\u8fd4\u56de\u4e00\u4e2a\u8fed\u4ee3\u5668</li> </ul> Rust<pre><code>pub fn factorial(num: u64) -&gt; u64 {\n    // Complete this function to return the factorial of num\n    // Do not use:\n    // - return\n    // Try not to use:\n    // - imperative style loops (for, while)\n    // - additional variables\n    // For an extra challenge, don't use:\n    // - recursion\n    // Execute `rustlings hint iterators4` for hints.\n    (1..num + 1).product()\n}// \u5b9e\u73b0\u9636\u4e58\n</code></pre> <ul> <li><code>flat_map</code>\u5c06\u5bf9\u5e94\u7684\u5143\u7d20\u5c55\u5e73\u6210\u4e3a\u65b0\u7684\u8fed\u4ee3\u5668</li> </ul> Rust<pre><code>fn count_collection_iterator(collection: &amp;[HashMap&lt;String, Progress&gt;], value: Progress) -&gt; usize {\n    // collection is a slice of hashmaps.\n    // collection = [{ \"variables1\": Complete, \"from_str\": None, ... },\n    //     { \"variables2\": Complete, ... }, ... ]\n    collection\n        .into_iter()\n        .flat_map(|x| x.values()) // \u8fd9\u91cc\u662fVec&lt;&amp;Progress&gt;\n        .filter(|&amp;progress| *progress == value)\n        .count()\n}\n</code></pre>"},{"location":"notes/rcore/rustlings/#threads","title":"Threads","text":""},{"location":"notes/rcore/rustlings/#channel","title":"Channel","text":"<ul> <li>\u53d1\u9001\u8005\u4f1a\u83b7\u53d6tx\u6240\u6709\u6743\uff0c\u591a\u53d1\u9001\u8005\u7684\u7ebf\u7a0b\u9700\u8981\u62f7\u8d1dtx</li> </ul> Rust<pre><code>fn send_tx(q: Queue, tx: mpsc::Sender&lt;u32&gt;) -&gt; () {\n    let qc = Arc::new(q);\n    let qc1 = Arc::clone(&amp;qc);\n    let qc2 = Arc::clone(&amp;qc);\n    let tx1 = tx.clone();\n    thread::spawn(move || {\n        for val in &amp;qc1.first_half {\n            println!(\"sending {:?}\", val);\n            tx.send(*val).unwrap();\n            thread::sleep(Duration::from_secs(1));\n        }\n    });\n\n    thread::spawn(move || {\n        for val in &amp;qc2.second_half {\n            println!(\"sending {:?}\", val);\n            tx1.send(*val).unwrap();\n            thread::sleep(Duration::from_secs(1));\n        }\n    });\n}\n</code></pre>"},{"location":"notes/rcore/rustlings/#as_ref_mut","title":"as_ref_mut","text":"<ul> <li>AsRef \u7684\u4e3b\u8981\u4f5c\u7528\u662f\u5141\u8bb8\u6211\u4eec\u4ee5\u7edf\u4e00\u7684\u65b9\u5f0f\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u4e4b\u95f4\u7684\u8f6c\u6362\u3002\u901a\u8fc7\u5b9e\u73b0 AsRef trait\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u7c7b\u578b\u8f6c\u6362\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u5c06\u4e00\u4e2a\u7c7b\u578b\u8f6c\u6362\u4e3a\u53e6\u4e00\u4e2a\u7c7b\u578b\u7684\u5f15\u7528\uff0c\u800c\u4e0d\u662f\u62e5\u6709\u65b0\u7684\u6240\u6709\u6743\u3002</li> <li>\u5177\u4f53\u6765\u8bf4\uff0c\u5982\u679c\u6211\u4eec\u6709\u4e00\u4e2a\u7c7b\u578b T\uff0c\u5e76\u4e14\u5e0c\u671b\u5c06\u5176\u8f6c\u6362\u4e3a\u7c7b\u578b U \u7684\u5f15\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u5b9e\u73b0 AsRef <code>&lt;U&gt;</code> trait \u6765\u5b8c\u6210\u8fd9\u4e2a\u8f6c\u6362\u3002\u5728\u5b9e\u73b0\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u540d\u4e3a as_ref \u7684\u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u8fd4\u56de\u7c7b\u578b &amp;U\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 as_ref \u65b9\u6cd5\u6765\u5c06 T \u8f6c\u6362\u4e3a U \u7684\u5f15\u7528\u3002</li> </ul> Rust<pre><code>// Obtain the number of bytes (not characters) in the given argument.\n// TODO: Add the AsRef trait appropriately as a trait bound.\nfn byte_counter&lt;T: AsRef&lt;str&gt;&gt;(arg: T) -&gt; usize {\n    arg.as_ref().as_bytes().len()\n}\n\n// Obtain the number of characters (not bytes) in the given argument.\n// TODO: Add the AsRef trait appropriately as a trait bound.\nfn char_counter&lt;T: AsRef&lt;str&gt;&gt;(arg: T) -&gt; usize {\n    arg.as_ref().chars().count()\n}\n</code></pre> <ul> <li>\u5f53\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\u9700\u8981\u5c06\u4e00\u4e2a\u7c7b\u578b\u8f6c\u6362\u4e3a\u53e6\u4e00\u4e2a\u7c7b\u578b\u7684\u5f15\u7528\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528 as_ref \u65b9\u6cd5\u6765\u8fdb\u884c\u8f6c\u6362\u3002\u8fd9\u5bf9\u4e8e\u63a5\u53d7\u4e0d\u540c\u7c7b\u578b\u5f15\u7528\u53c2\u6570\u7684\u51fd\u6570\u6216\u65b9\u6cd5\u975e\u5e38\u6709\u7528\uff0c\u56e0\u4e3a\u5b83\u4f7f\u5f97\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u76f8\u540c\u7684\u4ee3\u7801\u6765\u5904\u7406\u4e0d\u540c\u7684\u7c7b\u578b\u3002</li> <li>AsMut <code>&lt;T&gt;</code> \u662f\u4e00\u4e2a\u6807\u51c6\u5e93\u4e2d\u5b9a\u4e49\u7684 trait\uff0c\u5b83\u5c06\u7c7b\u578b T \u8f6c\u6362\u4e3a\u4e00\u4e2a\u6307\u5411\u5176\u5185\u90e8\u503c\u7684\u53ef\u53d8\u5f15\u7528\u3002\u5f53\u6211\u4eec\u5728\u6cdb\u578b\u51fd\u6570\u4e2d\u4f7f\u7528 T: AsMut <code>&lt;u32&gt;</code> \u8fd9\u4e2a trait bound \u65f6\uff0c\u6211\u4eec\u544a\u8bc9\u7f16\u8bd1\u5668\u8981\u6c42 T \u7c7b\u578b\u5fc5\u987b\u5177\u5907\u5c06\u5176\u5185\u90e8\u503c\u4f5c\u4e3a u32 \u7c7b\u578b\u7684\u53ef\u53d8\u5f15\u7528\u7684\u80fd\u529b</li> </ul> Rust<pre><code>// Squares a number using as_mut().\n// TODO: Add the appropriate trait bound.\nfn num_sq&lt;T: AsMut&lt;u32&gt;&gt;(arg: &amp;mut T) {\n    // TODO: Implement the function body.\n    *arg.as_mut()*=*arg.as_mut()\n}\n</code></pre>"},{"location":"notes/rcore/rustlings/#_3","title":"\u7f16\u8bd1\u6210\u5e93","text":"<ul> <li><code>#[no_mangle]</code>\u4fdd\u8bc1rust\u7f16\u8bd1\u65f6\u51fd\u6570\u540d\u4e0d\u6539\u53d8</li> <li><code>#[link_name=\"str\"]</code>\u5728\u5916\u90e8\u5757\u5185\uff0c\u901a\u8fc7\u5c5e\u6027link_name\uff0c\u6307\u5b9a\u539f\u751f\u5e93\u4e2d\u51fd\u6570\u6216\u9759\u6001\u5bf9\u8c61\u7684\u540d\u79f0\uff0c\u7f16\u8bd1\u5668\u6839\u636e\u5b83\u53ef\u4ee5\u4e3a\u5916\u90e8\u5757\u94fe\u63a5\u539f\u751f\u5e93\u5e76\u5bfc\u5165\u8be5\u540d\u79f0\u5b9a\u4e49\u7684\u51fd\u6570\u6216\u9759\u6001\u5bf9\u8c61</li> </ul> Rust<pre><code>// \u6807\u51c6\u5e93&lt;stdlib.h&gt;\u5185\u7f6e\u7684abs\u51fd\u6570\nextern \"C\" {\n    #[link_name = \"abs\"]\n    fn abs_in_rust(input: i32) -&gt; i32;\n}\n\nextern \"Rust\" {\n    fn my_demo_function(a: u32) -&gt; u32;\n    #[link_name = \"my_demo_function\"]\n    fn my_demo_function_alias(a: u32) -&gt; u32;\n}\n\nmod Foo {\n    // No `extern` equals `extern \"Rust\"`.\n    #[no_mangle]\n    pub fn my_demo_function(a: u32) -&gt; u32 {\n        a\n    }\n}\n</code></pre>"},{"location":"notes/rcore/rustlings/#_4","title":"\u53cd\u8f6c\u53cc\u5411\u94fe\u8868","text":"<ul> <li>\u4ece\u5934\u5f00\u59cb\u904d\u5386\u7ed3\u70b9\uff0c\u5bf9\u6bcf\u4e2a\u7ed3\u70b9\u4ea4\u6362<code>prev</code>\u548c<code>next</code>\u6307\u9488</li> <li>\u6700\u540e\u5bf9\u6574\u4e2a\u94fe\u8868\u4ea4\u6362<code>start</code>\u548c<code>end</code></li> </ul> Rust<pre><code>pub fn reverse(&amp;mut self) {\n    // TODO\n    let mut current_ptr = self.start;\n    while let Some(node_ptr) = current_ptr {\n        let mut node = unsafe { *node_ptr.as_ptr().as_mut().unwrap() };\n        std::mem::swap(&amp;mut node.prev, &amp;mut node.next);\n        current_ptr = node.prev;\n    }\n    std::mem::swap(&amp;mut self.start, &amp;mut self.end);\n}\n</code></pre>"},{"location":"notes/sglang/Constrained%20Decoding/","title":"Constrained Decoding","text":""},{"location":"notes/sglang/Constrained%20Decoding/#constrained-decoding","title":"Constrained Decoding","text":"<p> \u7ea6 810 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> 2025-12-022025-12-10 <p>SGLang \u4e2d\u5173\u4e8e \"Compressed FSM\" (\u538b\u7f29\u6709\u9650\u72b6\u6001\u673a) \u548c \"Jump Forward\" (\u8df3\u8dc3\u89e3\u7801) \u7684\u5b9e\u73b0\u4e3b\u8981\u96c6\u4e2d\u5728\u00a0sglang/srt/constrained\u00a0\u76ee\u5f55\u4e0b\u3002</p> <p>\u8fd9\u4e00\u673a\u5236\u7684\u6838\u5fc3\u601d\u60f3\u662f\uff1a\u5f53 FSM\uff08\u6709\u9650\u72b6\u6001\u673a\uff09\u5904\u4e8e\u786e\u5b9a\u6027\u8def\u5f84\u4e0a\u65f6\uff08\u5373\u540e\u7eed\u7684\u4e00\u7cfb\u5217\u5b57\u7b26/Token \u662f\u552f\u4e00\u7684\uff09\uff0c\u53ef\u4ee5\u76f4\u63a5\u201c\u8df3\u8fc7\u201d\u6a21\u578b\u751f\u6210\uff0c\u76f4\u63a5\u5c06\u8fd9\u4e9b\u786e\u5b9a\u7684 Token \u62fc\u63a5\u5230\u8f93\u51fa\u4e2d\uff0c\u4ece\u800c\u52a0\u901f\u89e3\u7801\u3002</p> <p>\u4ee5\u4e0b\u662f\u4ee3\u7801\u5c42\u9762\u7684\u5177\u4f53\u5b9e\u73b0\u89e3\u6790\uff1a</p>"},{"location":"notes/sglang/Constrained%20Decoding/#1-compressed-fsm","title":"1. Compressed FSM \u7684\u6784\u5efa (\u6838\u5fc3\u903b\u8f91)","text":"<p>\u6587\u4ef6\u4f4d\u7f6e:\u00a0outlines_jump_forward.py</p> <p>\u8fd9\u662f\u5b9e\u73b0\u201c\u538b\u7f29\u201d\u903b\u8f91\u7684\u5730\u65b9\u3002\u4ee3\u7801\u901a\u8fc7\u5206\u6790 FSM \u7684\u56fe\u7ed3\u6784\uff0c\u5c06\u7ebf\u6027\u7684\u3001\u786e\u5b9a\u6027\u7684\u8def\u5f84\u5408\u5e76\u4e3a\u201c\u8d85\u8fb9\u201d\uff08Jump Edge\uff09\u3002</p> <ul> <li>init_state_to_jump_forward(regex_string):</li> <li>\u8fd9\u662f\u5165\u53e3\u51fd\u6570\u3002\u5b83\u9996\u5148\u5c06\u6b63\u5219\u8868\u8fbe\u5f0f\u7f16\u8bd1\u4e3a\u5b57\u8282\u7ea7 FSM (outlines.fsm.regex.make_deterministic_fsm)\u3002</li> <li>\u5bfb\u627e\u786e\u5b9a\u6027\u8def\u5f84: \u5b83\u904d\u5386 FSM \u7684\u6bcf\u4e2a\u72b6\u6001\uff0c\u68c0\u67e5\u662f\u5426\u5b58\u5728\u201c\u5355\u51fa\u5ea6\u201d\u72b6\u6001\uff08Singular Transition\uff09\uff0c\u5373\u8be5\u72b6\u6001\u53ea\u6709\u4e00\u4e2a\u5408\u6cd5\u7684\u4e0b\u4e00\u4e2a\u5b57\u7b26\u3002</li> <li>\u8def\u5f84\u538b\u7f29: \u5982\u679c\u53d1\u73b0\u8fde\u7eed\u7684\u5355\u51fa\u5ea6\u72b6\u6001\uff0c\u5b83\u4f1a\u5c06\u8fd9\u4e9b\u5b57\u7b26\u62fc\u63a5\u6210\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u5f62\u6210\u4e00\u4e2a\u4ece\u8d77\u59cb\u72b6\u6001\u76f4\u63a5\u8df3\u8f6c\u5230\u76ee\u6807\u72b6\u6001\u7684\u6620\u5c04\u3002</li> <li>\u7ed3\u679c: \u751f\u6210\u00a0state_to_jump_forward\u00a0\u6620\u5c04\u8868\uff0cKey \u662f\u5f53\u524d\u72b6\u6001 ID\uff0cValue \u662f\u53ef\u4ee5\u76f4\u63a5\u8df3\u8fc7\u7684\u5b57\u7b26\u4e32\u53ca\u6700\u7ec8\u72b6\u6001\u3002</li> </ul>"},{"location":"notes/sglang/Constrained%20Decoding/#2-jump-forward","title":"2. Jump Forward \u7684\u6267\u884c (\u89e3\u7801\u9636\u6bb5)","text":"<p>\u6587\u4ef6\u4f4d\u7f6e:\u00a0outlines_backend.py</p> <p>\u5728\u89e3\u7801\u8fc7\u7a0b\u4e2d\uff0c\u540e\u7aef\u4f1a\u5229\u7528\u4e0a\u8ff0\u6784\u5efa\u7684\u6620\u5c04\u8868\u6765\u5c1d\u8bd5\u8df3\u8fc7\u751f\u6210\u6b65\u9aa4\u3002</p> <ul> <li>OutlinesGrammar.try_jump_forward(self, tokenizer):</li> <li>\u68c0\u67e5: \u6bcf\u6b21\u751f\u6210\u524d\uff0c\u68c0\u67e5\u5f53\u524d FSM \u72b6\u6001 (self.state) \u662f\u5426\u5728\u00a0jump_forward_map\u00a0\u4e2d\u3002</li> <li>\u83b7\u53d6: \u5982\u679c\u547d\u4e2d\uff0c\u76f4\u63a5\u83b7\u53d6\u9884\u8ba1\u7b97\u597d\u7684\u5b57\u8282\u5e8f\u5217 (jump_forward_bytes)\u3002</li> <li>\u5904\u7406: \u5c06\u8fd9\u4e9b\u5b57\u8282\u8f6c\u6362\u4e3a Token ID (suffix_ids) \u5e76\u8fd4\u56de\u3002\u8fd9\u544a\u8bc9\u8c03\u5ea6\u5668\uff1a\u201c\u4e0d\u7528\u8ba9\u6a21\u578b\u8dd1\u4e86\uff0c\u76f4\u63a5\u628a\u8fd9\u4e9b Token \u52a0\u5230\u8f93\u51fa\u91cc\uff0c\u5e76\u628a FSM \u72b6\u6001\u66f4\u65b0\u5230\u76ee\u6807\u72b6\u6001\u201d\u3002</li> </ul>"},{"location":"notes/sglang/Constrained%20Decoding/#3-tokenization-artifacts","title":"3. \u5904\u7406 Tokenization Artifacts (\u91cd\u5206\u8bcd\u95ee\u9898)","text":"<p>\u6587\u4ef6\u4f4d\u7f6e:\u00a0outlines_backend.py\u00a0\u548c\u00a0xgrammar_backend.py</p> <p>\u8fd9\u662f\u4f60\u63d0\u5230\u7684\u201c\u5fc5\u987b\u4f7f\u7528\u539f\u751f\u5206\u8bcd\u5668\u8fdb\u884c\u91cd\u5206\u8bcd\u201d\u7684\u5173\u952e\u70b9\u3002\u56e0\u4e3a\u76f4\u63a5\u62fc\u63a5\u5b57\u7b26\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5206\u8bcd\u8fb9\u754c\u53d8\u5316\uff08\u4f8b\u5982\u00a0[\"a\", \"b\"]\u00a0\u62fc\u63a5\u540e\u53ef\u80fd\u53d8\u6210\u00a0<code>[\"ab\"]</code>\uff09\uff0c\u7cfb\u7edf\u5fc5\u987b\u786e\u4fdd\u8df3\u8dc3\u540e\u7684 Token \u5e8f\u5217\u4e0e\u6a21\u578b\u8bcd\u8868\u4e00\u81f4\u3002</p> <ul> <li> <p>\u5728\u00a0outlines_backend.py\u00a0\u4e2d:</p> </li> <li> <p>try_jump_forward\u00a0\u65b9\u6cd5\u4e2d\u5305\u542b\u5904\u7406\u00a0Continuation Bytes\u00a0(UTF-8 \u7eed\u5b57\u8282) \u7684\u903b\u8f91\u3002\u5b83\u4f1a\u5c0f\u5fc3\u5730\u5904\u7406\u5b57\u8282\u8fb9\u754c\uff0c\u786e\u4fdd\u751f\u6210\u7684 Token \u662f\u5408\u6cd5\u7684\u3002</p> </li> <li> <p>\u5b83\u5c06\u8df3\u8fc7\u7684\u5b57\u8282\u5e8f\u5217\u8f6c\u6362\u56de Token IDs (tokenizer.convert_tokens_to_ids)\uff0c\u786e\u4fdd\u7b26\u5408 Tokenizer \u7684\u89c4\u8303\u3002</p> </li> <li> <p>\u5728\u00a0xgrammar_backend.py\u00a0\u4e2d (\u53e6\u4e00\u79cd\u540e\u7aef\u5b9e\u73b0):</p> </li> <li> <p>\u5b9e\u73b0\u4e86\u00a0jump_and_retokenize\u00a0\u65b9\u6cd5\u3002</p> </li> <li>\u5f53\u53d1\u751f\u8df3\u8dc3\u65f6\uff0c\u5b83\u4f1a\u5bf9\u6bd4\u201c\u65e7\u7684\u8f93\u51fa Token \u5e8f\u5217\u201d\u548c\u201c\u57fa\u4e8e\u5b8c\u6574\u5b57\u7b26\u4e32\u91cd\u65b0\u5206\u8bcd\u540e\u7684\u65b0\u5e8f\u5217\u201d\u3002</li> <li>Rollback (\u56de\u6eda): \u5982\u679c\u53d1\u73b0\u4e0d\u4e00\u81f4\uff08\u5373 Tokenization Artifacts\uff09\uff0c\u5b83\u4f1a\u56de\u6eda FSM \u7684\u72b6\u6001 (self.matcher.rollback)\uff0c\u4ee5\u786e\u4fdd\u72b6\u6001\u673a\u4e0e\u6700\u7ec8\u7684 Token \u5e8f\u5217\u4e25\u683c\u540c\u6b65\u3002</li> </ul>"},{"location":"notes/sglang/Constrained%20Decoding/#_1","title":"\u603b\u7ed3","text":"<p>SGLang \u901a\u8fc7\u9884\u5148\u5206\u6790\u6b63\u5219\u8868\u8fbe\u5f0f\u7684 FSM \u56fe\uff0c\u627e\u51fa\u786e\u5b9a\u6027\u7684\u201c\u6377\u5f84\u201d\uff08outlines_jump_forward.py\uff09\uff0c\u5e76\u5728\u89e3\u7801\u65f6\u901a\u8fc7\u00a0try_jump_forward\u00a0\u63a5\u53e3\uff08<code>out</code></p> <p>lines_backend.py<code>\uff09\u76f4\u63a5\u6ce8\u5165\u8fd9\u4e9b Token\uff0c\u540c\u65f6\u5229\u7528\u91cd\u5206\u8bcd\u903b\u8f91\u786e\u4fdd\u8bc1 Token \u7684\u6b63\u786e\u6027\u3002</code></p>"},{"location":"notes/sglang/DP%20Attention/","title":"Data Parallelism in Attention in SGLang","text":"2025-10-272025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#data-parallelism-in-attention-in-sglang","title":"Data Parallelism in Attention in SGLang","text":"<p> \u7ea6 1471 \u4e2a\u5b57  47 \u884c\u4ee3\u7801  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 8 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#what-is-data-parallelism-in-attention","title":"What is Data Parallelism in Attention?","text":"<p>\u26a0 \u8fd9\u91cc\u7684 <code>dp_size</code> \u4e0d\u662f\u4f20\u7edf\u7684\u6570\u636e\u5e76\u884c\u800c\u662f <code>attentnion dp</code> \u5176\u76ee\u7684\u662f\u5c06\u4e00\u4e2a\u5927\u7684\u5f20\u91cf\u5e76\u884c\uff08TP\uff09\u7ec4\u91cd\u7ec4\u4e3a\u51e0\u4e2a\u8f83\u5c0f\u7684 TP \u7ec4 \uff0c\u8fd9\u4e9b\u8f83\u5c0f\u7684 TP \u7ec4\u53c8\u5f62\u6210\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e\u6ce8\u610f\u529b\u5c42\u7684\u65b0\u7684\u6570\u636e\u5e76\u884c\uff08DP\uff09\u7ec4\u3002</p> <ol> <li>\u5bf9\u4e8e\u6a21\u578b\u4e2d\u9664 MLP \u5c42\u4ee5\u5916\u7684\u90e8\u5206\uff08\u5982 Embedding, Self-Attention\uff09\uff0c\u6bcf\u4e2a\u6570\u636e\u5e76\u884c\u5355\u5143\uff08DP_Rank\uff09\u5185\u90e8\u7684\u5f20\u91cf\u5e76\u884c\u89c4\u6a21\uff08TP_Size\uff09\u8bbe\u7f6e\u4e3a 1\uff0c\u5373\u6bcf\u4e2a DP_Rank \u72ec\u7acb\u8ba1\u7b97\u8fd9\u4e9b\u90e8\u5206\u3002</li> <li>\u5bf9\u4e8e MLP \u5c42\uff0c\u6240\u6709 DP_Rank \u5219\u5171\u540c\u7ec4\u6210\u4e00\u4e2a\u5927\u7684\u5f20\u91cf\u5e76\u884c\u7ec4\uff08TP_Group\uff09\uff0c\u8be5\u7ec4\u7684\u5927\u5c0f\u7b49\u4e8e\u6570\u636e\u5e76\u884c\u7684\u89c4\u6a21\uff08DP_Size\uff09\u3002</li> </ol> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#_1","title":"\u542f\u52a8\u6d41\u7a0b","text":"<ol> <li> <p>engine \u4f1a\u542f\u52a8\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u6267\u884c <code>run_data_parallel_control_process</code></p> </li> <li> <p>\u8be5\u51fd\u6570\u542f\u52a8 DataParallelController \u5e76\u6267\u884c <code>launch_dp_attention_schedulers</code></p> </li> </ol> <ul> <li>\u4e3a\u6bcf\u4e2a dp rank \u83b7\u53d6\u5355\u72ec\u7684 zmq \u901a\u4fe1\u63a5\u53e3</li> <li>\u8c03\u7528 <code>launch_tensor_parallel_group</code></li> </ul> <ol> <li><code>launch_tensor_parallel_group</code> \u5bf9\u6bcf\u4e2a (pp_rank, tp_rank) \u542f\u52a8\u4e00\u4e2a Schedular \u5b50\u8fdb\u7a0b - \u7236\u8fdb\u7a0b\u5728\u8fd9\u91cc\u963b\u585e\u7b49\u5f85\u6bcf\u4e2a\u5b50\u8fdb\u7a0b\u901a\u8fc7 pipe \u53d1\u9001\u521d\u59cb\u5316\u4fe1\u606f\uff08\u901a\u5e38\u5305\u542b\uff1a\u6a21\u578b\u5df2\u52a0\u8f7d\u5b8c\u6210\u3001\u6a21\u578b\u7684 buffer/kv \u914d\u7f6e\u3001\u6700\u5927 token \u957f\u5ea6\u7b49</li> </ol> Python<pre><code>scheduler = Scheduler(\n     server_args,\n     port_args,\n     gpu_id,\n     tp_rank,\n     moe_ep_rank,\n     pp_rank,\n     dp_rank,\n )\npipe_writer.send(\n         {\n             \"status\": \"ready\",\n             \"max_total_num_tokens\": scheduler.max_total_num_tokens,\n             \"max_req_input_len\": scheduler.max_req_input_len,\n         }\n     )\n\n# PP + TP\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Pipeline Stage 0 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\nTP=0\u2192 \u2502 TP Rank 0 \u2502 TP Rank 1 \u2502 TP Rank 2        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Pipeline Stage 1 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\nTP=1\u2192 \u2502 TP Rank 3 \u2502 TP Rank 4 \u2502 TP Rank 5        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 Pipeline Stage 2 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\nTP=2\u2192 \u2502 TP Rank 6 \u2502 TP Rank 7 \u2502 TP Rank 8        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <ol> <li>ModelRunner \u521d\u59cb\u5316\u65f6\u6267\u884c <code>initialize_dp_attention</code>\uff0c</li> </ol> <ul> <li>\u8ba1\u7b97 <code>attn_tp</code> \u7684\u5927\u5c0f\u4ee5\u53ca\u5bf9\u5e94\u7684 <code>attn_tp_rank</code> \u4ee5\u53ca <code>attn_dp_rank</code></li> <li>\u5e76\u636e\u6b64\u521b\u5efa attention-specific group coordinator\uff08attn_tp_group\uff09</li> <li>\u8bbe\u7f6e Gather \u65f6\u5019\u7684 Buffer      &gt; \u4e3a Gather buffer \u9884\u7559 <code>attn_tp_size</code> \u500d\u7684\u7a7a\u95f4</li> </ul> <p>\u4ee5\u4e0a\u9762\u7684\u56fe\u4e3a\u4f8b</p> tp_rank attn_tp_size attn_dp_rank attn_tp_rank 0 1 0 0 1 1 1 0 2 1 2 0 3 1 3 0","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#_2","title":"\u6267\u884c\u6d41\u7a0b","text":"<p>\u4e0e\u6b63\u5e38\u6267\u884c\u7c7b\u4f3c\uff0c\u90fd\u5148\u6267\u884c <code>recv_requests</code> \u548c <code>process_input_requests</code></p> <ol> <li> <p>\u5728 <code>get_next_batch_to_run</code> \u4e2d\u6267\u884c <code>prepare_mlp_sync_batch</code></p> </li> <li> <p><code>prepare_mlp_sync_batch</code> \u5728 (dp_size, attn_tp_size\uff09\u7ef4\u5ea6\u4e0a\u6536\u96c6\u6bcf\u4e2a worker \u7684 batch/forward-mode \u4fe1\u606f\uff08\u5305\u62ec token \u6570\u3001\u662f\u5426\u80fd\u8dd1 CUDA graph\u3001logprob \u76f8\u5173\u957f\u5ea6\u3001\u662f\u5426\u4e3a extend\u3001\u4ee5\u53ca TBO \u76f8\u5173\u7684 all-gather \u5143\u6570\u636e\uff09\uff0c\u7136\u540e\u5408\u5e76\u56de\u6bcf\u4e2a\u672c\u5730 <code>local_batch</code></p> </li> </ol> <ul> <li> <p>\u82e5\u672c\u5730\u6ca1\u4efb\u52a1\uff0c\u4f46\u4efb\u4e00\u5176\u5b83 DP \u526f\u672c\u6709\u4efb\u52a1\uff08\u8868\u793a\u5168\u5c40\u4e0d\u662f\u5b8c\u5168\u7a7a\u95f2\uff09\uff0c\u5219\u901a\u8fc7 <code>get_idle_batch()</code> \u83b7\u53d6\u4e00\u4e2a\u5360\u4f4d <code>ScheduleBatch</code>\uff0c\u4fbf\u4e8e\u8be5 worker \u53c2\u4e0e\u540e\u7eed\u540c\u6b65/\u5e76\u884c\uff08\u4f8b\u5982\u540c\u6b65 MLP gather \u6216 KV cache \u64cd\u4f5c\uff09\uff0c\u907f\u514d\u56e0\u4e3a\u67d0\u4e9b worker \u7f3a\u5931\u5bfc\u81f4\u6536\u96c6/\u901a\u4fe1\u5f02\u5e38\u3002</p> </li> <li> <p>\u6700\u540e\u8fd4\u56de <code>local_batch</code> \u4f5c\u4e3a\u6b64\u6b21\u7684 new_batch</p> Python<pre><code>\u00a0 \u00a0 def get_idle_batch(self):\n\u00a0 \u00a0 \u00a0 \u00a0 idle_batch = ScheduleBatch.init_new(\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 [],\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.req_to_token_pool,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.token_to_kv_pool_allocator,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.tree_cache,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.model_config,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.enable_overlap,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.spec_algorithm,\n\u00a0 \u00a0 \u00a0 \u00a0 )\n\u00a0 \u00a0 \u00a0 \u00a0 idle_batch.prepare_for_idle()\n\u00a0 \u00a0 \u00a0 \u00a0 return idle_batch\n</code></pre> </li> </ul> <ol> <li> <p>\u53d8\u4e3a <code>ModelWorkerBatch</code> \u540e\u8c03\u7528 <code>TpModelWorker::forward_batch_generation</code>\u8f6c\u5316\u4e3a <code>ForwardBatch</code>\uff0c\u8c03\u7528 <code>ModelRunner::forward</code> -&gt; <code>ModelRunner::_forward_raw</code> \u5728\u8fd9\u91cc\u8fdb\u884c padding</p> </li> <li> <p>\u5b9e\u9645\u4e0a\u662f\u8c03\u7528 <code>FowardBatch::prepare_mlp_sync_batch</code></p> </li> </ol> <ul> <li>\u628a\u5404\u4e2a dp rank \u7684 num_token \u4fe1\u606f\u5bf9\u9f50 Attention-tp-size<ul> <li>\u786e\u4fdd\u6bcf\u4e2a DP rank \u7684 token \u6570\u91cf\u662f <code>attn_tp_size</code>\u00a0 \u7684\u500d\u6570</li> <li>\u4e3a\u540e\u7eed\u53ef\u80fd\u7684 \u00a0reduce-scatter\u00a0 \u64cd\u4f5c\u505a\u51c6\u5907(reduce-scatter \u8981\u6c42\u53ef\u88ab\u6574\u9664\u7684\u5206\u5272)</li> </ul> </li> <li>\u6bcf\u4e2a dp rank \u672c\u5730\u7684 batch \u4f1a\u6839\u636e\u586b\u5145\u6a21\u5f0f\u88ab padding \u5230\u6307\u5b9a\u7684\u5927\u5c0f(bs = self.batchsize = num_tokens).<ul> <li>\u5f53 <code>dp_padding_mode</code> \u8bbe\u7f6e\u4e3a max \u65f6\uff0cpadding \u5230\u7684 batchsize \u5927\u5c0f\u4e3a\u6240\u6709 dp rank \u4e0a\u6700\u5927\u7684 local batch\uff0c\u540c\u65f6\u5bf9\u9f50\u5230 attention_tp_size;</li> <li>\u5f53 <code>dp_padding_mode</code> \u8bbe\u7f6e\u4e3a sum \u65f6\uff0cpadding \u5230\u7684 batchsize \u5927\u5c0f\u4e3a\u6240\u6709 dp rank \u4e0a local batch \u4e4b\u548c\uff0c\u5373 global batch size</li> <li>is_extend_in_batch \u8bbe\u7f6e SUM\uff0ccuda_graph \u8bbe\u7f6e MAX</li> </ul> </li> </ul> <ol> <li>\u5728\u5b8c\u6210 dp attention batch padding \u540e\uff0c\u6839\u636e batch \u7c7b\u578b\u8c03\u7528<code>self.forward_decode</code> \u8fdb\u884c\u6a21\u578b\u63a8\u7406\u3002\u5728\u5b8c\u6210\u63a8\u7406\u540e\uff0c\u8c03\u7528<code>forward_batch.post_forward_mlp_sync_batch(ret)</code></li> </ol> <ul> <li>\u590d\u539f\u88ab\u4e34\u65f6\u4fee\u6539\u7684\u5c5e\u6027</li> <li>\u5c06 padding \u540e\u7684 ForwardBatch \u8fd8\u539f\uff0c\u5177\u4f53\u505a\u6cd5\u662f\u5728 prepare \u65f6\u4f1a\u8bb0\u5f55\u539f batchsize\uff0c\u6b64\u65f6\u5bf9\u7ed3\u679c\u8fdb\u884c\u5207\u7247</li> </ul> Python<pre><code># prepare\nsetattr(self, \"_original_forward_mode\", self.forward_mode)\nsetattr(self, \"_original_batch_size\", self.batch_size)\n\n# post\nself.forward_mode = getattr(self, \"_original_forward_mode\", self.forward_mode)\nself.batch_size = getattr(self, \"_original_batch_size\", self.batch_size)\n\nlogits_output.next_token_logits = logits_output.next_token_logits[:bs]\nlogits_output.hidden_states = logits_output.hidden_states[:bs]\n</code></pre> <ol> <li>\u6700\u540e\u7684\u5904\u7406\u6d41\u7a0b\u4e0e\u5e38\u89c4\u65e0\u5dee\u522b\uff0c\u8c03\u7528 <code>process_batch_result</code> \u7ed3\u675f\u6b64\u8f6e\u8c03\u5ea6</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#why-dp-attention","title":"Why DP Attention?","text":"<p>\u5b83\u7528\u4e00\u6b21\u76f8\u5bf9\u5ec9\u4ef7\u7684\u5185\u5b58\u901a\u4fe1\uff08<code>All-Gather KV Cache</code>\uff09\u6362\u53d6\u4e86Attention \u7684\u5e76\u884c\u52a0\u901f\uff0c\u540c\u65f6\u8fd8\u4fdd\u6301\u4e86 MLP \u5c42\uff08\\(O(N)\\)\uff09\u7684\u96f6\u901a\u4fe1\u6570\u636e\u5e76\u884c\u6548\u7387\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#why-padding","title":"Why Padding?","text":"<p>\u5728 Attention \u5c42\u4e0e MoE \u5c42\u4e4b\u95f4\u9700\u8981\u8fdb\u884c\u540c\u6b65\u901a\u4fe1\uff0c\u5bf9\u5404 dp rank atttention \u90e8\u5206\u8ba1\u7b97\u5f97\u5230\u7684 hidden_state \u96c6\u5408\u8fdb\u884c\u540c\u6b65\uff0c\u5982\u679c\u91c7\u7528 Allgather \u6216\u8005 Allreduce \u901a\u4fe1\uff0c\u5176\u5bf9\u6570\u636e\u6027\u72b6\u6709\u4e00\u5b9a\u7684\u8981\u6c42</p> <ul> <li>allgather\uff1a\u8981\u6c42\u6bcf\u4e2a sub-batchsize \u5927\u5c0f\u76f8\u540c\u3002\u56e0\u6b64\u9700\u8981\u628a local batchsize padding \u5230 max batchsize\uff0c\u4e14\u6700\u540e gatheredbuffer \u5927\u5c0f\u4e3a\uff1amax_batchsize * sync_group_size </li> <li>allreduce\uff1a\u6bcf\u4e2a dp rank \u4e0a\u90fd\u6709\u5b8c\u6574\u7684\u6570\u636e\u96c6\u5408(\u5bf9\u5e94 padding \u5230 sum batchsize). \u6700\u540e gatheredbuffer \u5927\u5c0f\u4e3a\uff1asum_batchsize </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#padding-problems","title":"Padding Problems","text":"<p>\u8fd9\u79cd\u4e3a\u4e86\u201c\u6b63\u786e\u6027\u201d\u800c\u505a\u7684 padding\uff0c\u53cd\u8fc7\u6765\u53c8\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff0c\u4e3b\u8981\u4f53\u73b0\u5728\u4ee5\u4e0b\u4e24\u65b9\u9762\uff1a</p>","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#a-load-imbalance-stragglers","title":"A. \u8d1f\u8f7d\u4e0d\u5747\u4e0e\u201c\u6389\u961f\u8005\u201d (Load Imbalance &amp; Stragglers)","text":"<p><code>GPU_0</code> \u6709 4 \u4e2a\u771f\u5b9e\u7684\u8bf7\u6c42\u9700\u8981\u8ba1\u7b97\uff0c\u800c <code>GPU_1, 2, 3</code> \u53ea\u6709 3 \u4e2a\u771f\u5b9e\u7684\u8bf7\u6c42\uff08\u548c 1 \u4e2a\u51e0\u4e4e\u4e0d\u8017\u65f6\u7684\u865a\u62df\u8bf7\u6c42\uff09\u3002</p> <ul> <li>\u7ed3\u679c\uff1a<code>GPU_1, 2, 3</code> \u4f1a\u5f88\u5feb\u5b8c\u6210\u5b83\u4eec\u7684\u672c\u5730\u8ba1\u7b97\u3002</li> <li>\u7b49\u5f85\uff1a\u7136\u540e\uff0c\u5b83\u4eec\u5728 <code>All-Gather</code> \u8fd9\u4e2a\u540c\u6b65\u70b9\uff08Barrier\uff09\u4e0a\u88ab\u8feb\u7a7a\u8f6c\uff08Idle\uff09\uff0c\u7b49\u5f85 <code>GPU_0</code> \u5b8c\u6210\u5b83\u90a3\u4efd\u66f4\u91cd\u7684\u5de5\u4f5c\u3002</li> <li><code>GPU_0</code> \u6210\u4e3a\u4e86\u8fd9\u4e2a\u6279\u6b21\u7684**\u201c\u6389\u961f\u8005\u201d (Straggler)**\uff0c\u5b83\u62d6\u6162\u4e86\u6240\u6709\u5176\u4ed6 GPU \u7684\u8fdb\u5ea6\u3002</li> </ul> <p>\u7ed3\u8bba\uff1a \u8fd9\u5bfc\u81f4\u4e86\u6781\u4f4e\u7684 GPU \u5229\u7528\u7387\u3002\u5728 <code>dp_size=4</code> \u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u80fd\u6709 \u00be \u7684 GPU \u5728\u5927\u90e8\u5206\u65f6\u95f4\u91cc\u5904\u4e8e\u7a7a\u95f2\u7b49\u5f85\u72b6\u6001\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/DP%20Attention/#b-overhead","title":"B. \u8ba1\u7b97\u548c\u5185\u5b58\u7684\u989d\u5916\u5f00\u9500 (Overhead)","text":"<ol> <li>\u8ba1\u7b97\u5f00\u9500\uff1a</li> </ol> <ul> <li>\u5c3d\u7ba1\u662f\u201c\u865a\u62df\u201d\u8bf7\u6c42\uff0c\u4f46\u7cfb\u7edf\u4ecd\u7136\u9700\u8981\u542f\u52a8 CUDA Kernel \u6765\u5904\u7406\u5b83\u4eec\uff0c\u8fd9\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u8c03\u5ea6\u5f00\u9500\u3002</li> <li>\u66f4\u91cd\u8981\u7684\u662f\uff0c<code>All-Gather</code> \u64cd\u4f5c\u672c\u8eab\u3002\u6240\u6709 GPU \u73b0\u5728\u90fd\u5fc5\u987b\u4ea4\u6362\u4e00\u4e2a\u201c\u5927\u5c0f\u4e3a 4\u201d\u7684\u6279\u6b21\u6570\u636e\uff0c\u800c\u4e0d\u662f\u5b83\u4eec\u201c\u5b9e\u9645\u201d\u7684 <code>[4, 3, 3, 3]</code>\u3002\u901a\u4fe1\u91cf\u88ab\u653e\u5927\u4e86\u3002</li> </ul> <ol> <li>\u5185\u5b58\u5f00\u9500\uff1a</li> </ol> <ul> <li><code>All-Gather</code> \u4e4b\u540e\uff0c\u6bcf\u4e2a GPU \u90fd\u9700\u8981\u5206\u914d\u8db3\u591f\u5927\u7684\u5185\u5b58\u7f13\u51b2\u533a\u6765\u63a5\u6536\u6765\u81ea\u6240\u6709\u5176\u4ed6 rank \u7684\u6570\u636e\u3002</li> <li><code>GPU_1</code> \u660e\u660e\u53ea\u9700\u8981 <code>4+3+3+3 = 13</code> \u4e2a\u8bf7\u6c42\u7684\u6570\u636e\uff0c\u4f46\u5b83\u5fc5\u987b\u6309\u7167 <code>4+4+4+4 = 16</code> \u4e2a\u8bf7\u6c42\uff08\u5373<code>max_batch_per_rank * dp_size</code>\uff09\u7684\u6700\u5927\u53ef\u80fd\u6027\u6765\u5206\u914d\u5185\u5b58\u3002</li> <li>\u8fd9\u5bfc\u81f4\u4e86\u663e\u5b58\uff08VRAM\uff09\u7684\u6d6a\u8d39\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/","title":"RadixAttention \u4f60\u9700\u8981\u77e5\u9053\u7684\u7ec6\u8282","text":"2025-12-132025-12-13 <p>title: RadixAttention \u4f60\u9700\u8981\u77e5\u9053\u7684\u7ec6\u8282 tags:</p> <ul> <li>LLMInference   date: 2025/11/24</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#radixattention","title":"RadixAttention \u4f60\u9700\u8981\u77e5\u9053\u7684\u7ec6\u8282","text":"<p> \u7ea6 4474 \u4e2a\u5b57  79 \u884c\u4ee3\u7801  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 23 \u5206\u949f</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#why-radix-attention","title":"Why Radix Attention?","text":"<p>LLM \u63a8\u7406\u5206\u4e3a Prefill\uff08\u9884\u586b\u5145\uff09 \u548c Decode\uff08\u89e3\u7801\uff09\u4e24\u4e2a\u9636\u6bb5\u3002KV Cache \u5b58\u50a8\u4e86 Prefill \u9636\u6bb5\u8ba1\u7b97\u51fa\u7684\u4e2d\u95f4\u72b6\u6001\u3002 KV Cache \u7684\u8ba1\u7b97\u53ea\u4f9d\u8d56\u4e8e\u524d\u5e8f Token\u3002\u53ea\u8981\u524d\u7f00\uff08Prefix\uff09\u76f8\u540c\uff0cKV Cache \u5c31\u53ef\u4ee5\u5b8c\u5168\u590d\u7528\uff0c\u65e0\u9700\u91cd\u590d\u8ba1\u7b97\u3002</p> <p>\u5b9e\u9645\u5e94\u7528\u4e2d\uff0cPrompt \u7684\u7ed3\u6784\u975e\u5e38\u590d\u6742\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>Few-shot Learning\uff1a \u591a\u4e2a\u8bf7\u6c42\u5171\u7528\u4e00\u957f\u4e32 Examples\u3002</li> <li>Self-Consistency / Tree-of-Thought\uff1a \u4ece\u540c\u4e00\u4e2a\u95ee\u9898\u5206\u53c9\u51fa\u591a\u6761\u63a8\u7406\u8def\u5f84\u3002</li> <li>Chat Session\uff1a \u591a\u8f6e\u5bf9\u8bdd\u4e0d\u65ad\u8ffd\u52a0\u540e\u7f00\u3002</li> </ul> <p>\u4f20\u7edf\u7684 KV Cache \u590d\u7528\u901a\u5e38\u57fa\u4e8e\u201cPrompt \u5b8c\u6574\u54c8\u5e0c\u201d\u6216\u7b80\u5355\u7684\u201c\u5b8c\u5168\u5339\u914d\u201d\u3002\u7136\u800c\uff0c\u8fd9\u4e9b\u65b9\u6cd5\u96be\u4ee5\u5904\u7406\u6811\u72b6\u7ed3\u6784\u7684\u5171\u4eab\u6a21\u5f0f\uff08\u5982\u591a\u8f6e\u5bf9\u8bdd\u7684\u5206\u53c9\u3001\u591a\u8def\u63a8\u7406\uff09\uff0c\u4e14\u65e0\u6cd5\u9ad8\u6548\u5730\u5904\u7406\u52a8\u6001\u7684\u8282\u70b9\u5206\u88c2\u4e0e\u5408\u5e76\u3002\u6211\u4eec\u9700\u8981\u4e00\u79cd\u66f4\u7075\u6d3b\u7684\u6570\u636e\u7ed3\u6784\u2014\u2014Radix Tree\uff0c\u6765\u5c06 KV Cache \u7684\u7ba1\u7406\u7c92\u5ea6\u4ece\u201c\u6574\u6761\u8bf7\u6c42\u201d\u7cbe\u7ec6\u5316\u5230\u201cToken \u5e8f\u5217\u7247\u6bb5\u201d\u3002</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#radix-tree","title":"Radix Tree","text":"<p>Radix Attention \u7684\u6838\u5fc3\u5728\u4e8e\u7ef4\u62a4\u4e86\u4e00\u4e2aRadix Tree\uff08\u4e5f\u79f0\u4e3a\u538b\u7f29\u524d\u7f00\u6811\uff09\u3002</p> <ul> <li>\u8282\u70b9 (Node) - TreeNode:</li> <li>KV Cache \u6620\u5c04:\u00a0<code>self.value</code>\u00a0 \u5b58\u50a8\u7740\u8be5\u8282\u70b9\u5bf9\u5e94\u7684 Token \u5e8f\u5217\u5728 PagedAttention \u4e2d\u7684 \u00a0Block Indices\u00a0(\u7269\u7406\u663e\u5b58\u5757\u7d22\u5f15)\u3002</li> <li>\u5f15\u7528\u8ba1\u6570:\u00a0<code>self.lock_ref</code>\u00a0 \u8bb0\u5f55\u4e86\u5f53\u524d\u6709\u591a\u5c11\u4e2a\u8bf7\u6c42\u6b63\u5728\u4f7f\u7528\u8be5\u8282\u70b9\uff08\u6216\u5176\u5b50\u8282\u70b9\uff09\u3002</li> <li>LRU \u8ffd\u8e2a:\u00a0<code>self.last_access_time</code>\u00a0 \u7528\u4e8e\u8bb0\u5f55\u6700\u540e\u8bbf\u95ee\u65f6\u95f4\uff0c\u652f\u6301 LRU \u9a71\u9010\u7b56\u7565\u3002</li> <li>\u7236\u5b50\u5173\u7cfb:\u00a0<code>self.children</code>\u00a0 \u662f\u4e00\u4e2a\u5b57\u5178\uff0c\u6620\u5c04 child_key\u00a0 \u5230\u5b50\u8282\u70b9\uff1b<code>self.parent</code>\u00a0 \u6307\u5411\u7236\u8282\u70b9\u3002</li> <li>\u8fb9 (Edge) -\u00a0RadixKey:</li> <li>\u867d\u7136\u903b\u8f91\u4e0a\u79f0\u4e3a\u201c\u8fb9\u201d\uff0c\u4f46\u5728\u4ee3\u7801\u4e2d\uff0c\u8fb9\u4e0a\u7684 Token \u5e8f\u5217\u5b9e\u9645\u4e0a\u5b58\u50a8\u5728\u5b50\u8282\u70b9\u7684 \u00a0<code>self.key</code>\u00a0 \u4e2d\u3002</li> <li>RadixKey\u00a0 \u5305\u542b \u00a0<code>token_ids</code>(Token \u5e8f\u5217) \u548c \u00a0<code>extra_key</code>\u00a0(\u7528\u4e8e\u533a\u5206\u4e0d\u540c LoRA \u9002\u914d\u5668\u6216\u91c7\u6837\u53c2\u6570\u7684\u547d\u540d\u7a7a\u95f4)\u3002</li> </ul> Python<pre><code># sglang/srt/mem_cache/radix_cache.py\nclass TreeNode:\n\u00a0 \u00a0 def __init__(self, ...):\n\u00a0 \u00a0 \u00a0 \u00a0 self.children = defaultdict(TreeNode)\n\u00a0 \u00a0 \u00a0 \u00a0 self.parent: TreeNode = None\n\u00a0 \u00a0 \u00a0 \u00a0 self.key: RadixKey = None\n\u00a0 \u00a0 \u00a0 \u00a0 self.value: Optional[torch.Tensor] = None \u00a0# &lt;--- \u8fd9\u91cc\u5b58\u50a8 KV Cache \u7684 Block Indices\n\u00a0 \u00a0 \u00a0 \u00a0 self.lock_ref = 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0# &lt;--- \u5f15\u7528\u8ba1\u6570\n\u00a0 \u00a0 \u00a0 \u00a0 self.last_access_time = time.monotonic() \u00a0 # &lt;--- LRU \u65f6\u95f4\u6233\n\nclass RadixKey:\n\u00a0 \u00a0 def __init__(\n\u00a0 \u00a0 \u00a0 \u00a0 self,\n\u00a0 \u00a0 \u00a0 \u00a0 token_ids: List[int],\n\u00a0 \u00a0 \u00a0 \u00a0 extra_key: Optional[str] = None,\n\u00a0 \u00a0 \u00a0 \u00a0 is_bigram: bool = False,\n\u00a0 \u00a0 ):\n\u00a0 \u00a0 \u00a0 \u00a0 # token ids sequence\n\u00a0 \u00a0 \u00a0 \u00a0 self.token_ids = token_ids\n\u00a0 \u00a0 \u00a0 \u00a0 # extra key (e.g. lora_id, cache_salt)\n\u00a0 \u00a0 \u00a0 \u00a0 self.extra_key = extra_key\n\u00a0 \u00a0 \u00a0 \u00a0 # is bigram key\n\u00a0 \u00a0 \u00a0 \u00a0 self.is_bigram = is_bigram\n</code></pre>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_1","title":"\u8def\u5f84\u538b\u7f29","text":"<p>\u4ee3\u7801\u901a\u8fc7 \u00a0<code>_split_node()</code>\u00a0 \u65b9\u6cd5\u5b9e\u73b0\u4e86\u8def\u5f84\u538b\u7f29\u3002</p> <ul> <li>\u5408\u5e76: \u5f53\u4f60\u63d2\u5165\u4e00\u4e2a\u5e8f\u5217 \u00a0<code>[A, B, C]</code>\u00a0 \u65f6\uff0c\u5982\u679c\u6811\u662f\u7a7a\u7684\uff0c\u5b83\u4f1a\u521b\u5efa\u4e00\u4e2a\u5305\u542b\u5b8c\u6574\u5e8f\u5217 \u00a0<code>[A, B, C]</code>\u00a0 \u7684\u8282\u70b9\uff0c\u800c\u4e0d\u662f\u4e09\u4e2a\u8282\u70b9\u3002</li> <li>\u5206\u88c2 (Split): \u5f53\u6811\u4e2d\u5df2\u6709 \u00a0<code>[A, B, C]</code>\uff0c\u800c\u65b0\u8bf7\u6c42\u662f \u00a0<code>[A, F, DG]</code>\u00a0 \u65f6\uff0c<code>_match_prefix_helper()</code>\u00a0 \u4f1a\u53d1\u73b0\u5339\u914d\u5230 \u00a0<code>[A]</code>\uff0c\u7136\u540e\u5728 \u00a0<code>[B, C]</code>\u00a0 \u5904\u5206\u53c9\u3002\u6b64\u65f6\u4f1a\u8c03\u7528 \u00a0<code>_split_node()</code>\uff1a   1. \u539f\u6765\u7684\u8282\u70b9 \u00a0<code>[A, B, C]</code>\u00a0 \u88ab\u5207\u5206\u4e3a\u7236\u8282\u70b9 \u00a0<code>[A]</code>\u00a0 \u548c\u5b50\u8282\u70b9 \u00a0<code>[B, C]</code>\u3002   1. \u65b0\u8bf7\u6c42\u7684\u540e\u7f00 \u00a0<code>[F, G]</code>\u00a0 \u6210\u4e3a \u00a0<code>[A]</code>\u00a0 \u7684\u53e6\u4e00\u4e2a\u5b50\u8282\u70b9\u3002</li> </ul> <p></p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#workflow","title":"\u5de5\u4f5c\u6d41\u7a0b\uff08Workflow\uff09","text":"<p>Radix Attention \u4e3b\u8981\u6d89\u53ca\u6700\u957f\u524d\u7f00\u5339\u914d\uff0cRadix Tree \u7684\u66f4\u65b0\uff0c\u5185\u5b58\u7ba1\u7406\u4e0e\u9a71\u9010\u4e09\u90e8\u5206</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#prefix-matching","title":"\u524d\u7f00\u5339\u914d\uff08Prefix Matching\uff09","text":"<p>\u5f53\u65b0\u8bf7\u6c42\u5230\u6765\u65f6\uff0c<code>match_prefix()</code>\u00a0 \u51fd\u6570\u4f1a\u88ab\u8c03\u7528\u3002</p> <ol> <li>\u904d\u5386:\u00a0<code>_match_prefix_helper()</code>\u00a0 \u4ece\u6839\u8282\u70b9\u5f00\u59cb\uff0c\u6cbf\u7740\u8fb9\u5339\u914d Token\u3002</li> <li>\u6700\u957f\u516c\u5171\u524d\u7f00: \u5b83\u4f1a\u5c3d\u53ef\u80fd\u6df1\u5730\u5339\u914d\uff0c\u76f4\u5230\u65e0\u6cd5\u5339\u914d\u4e3a\u6b62\u3002</li> <li>\u8fd4\u56de\u7ed3\u679c: \u8fd4\u56de\u5339\u914d\u5230\u7684\u6240\u6709\u8282\u70b9\u7684 \u00a0<code>value</code>\u00a0(KV Cache Indices) \u62fc\u63a5\u540e\u7684 Tensor\u3002\u8fd9\u5c31\u662f \u00a0Cache Hit\u3002</li> </ol>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#update-insertion","title":"\u6811\u7684\u66f4\u65b0\u4e0e\u63d2\u5165\uff08Update &amp; Insertion\uff09","text":"<p>\u8bf7\u6c42\u751f\u6210\u7ed3\u675f\u540e\uff0c\u8c03\u5ea6\u5668\u4f1a\u8c03\u7528 \u00a0<code>cache_finished_req()</code>\u00a0(\u6216 \u00a0<code>cache_unfinished_req]()</code>)\u3002</p> <ul> <li>\u5148\u5bf9\u9f50\u5230 <code>page_size</code> \u7684\u500d\u6570\uff0cvalue \u5df2\u7ecf\u901a\u8fc7 <code>alloc_for_extend()</code> \u548c <code>alloc_for_decode()</code> \u5206\u914d\u4e86\u65b0\u7684 KV Cache</li> <li>\u6839\u636e <code>req.fill_ids</code> (\u5df2\u6709\u7684 token \u5e8f\u5217)\u6784\u9020 RadixKey \u63d2\u5165\u5230 Radix Tree \u4e2d</li> <li>\u5982\u679c\u6811\u4e2d\u5df2\u5b58\u5728\u90e8\u5206\u524d\u7f00\uff0c<code>insert()</code>\u00a0 \u4f1a\u81ea\u52a8\u5904\u7406\u8282\u70b9\u5206\u88c2\uff08Split\uff09\u6216\u5408\u5e76\uff0c\u5e76\u8fd4\u56de\u65b0\u63d2\u5165\u7684\u524d\u7f00\u957f\u5ea6 \u00a0<code>new_prefix_len</code>\u3002</li> <li>\u8fd9\u91cc\u901a\u8fc7 <code>token_to_kv_pool_allocator.free()</code>\u5c06 \u00a0req\u00a0 \u53ef\u4ee5\u590d\u7528\u6811\u4e2d\u8282\u70b9\u7684\u90a3\u4e9b\u65b0\u5206\u914d\u7684\u663e\u5b58\u5757\u91ca\u653e\u6389\uff0c\u907f\u514d\u6d6a\u8d39\u3002</li> <li>\u91cd\u65b0\u5339\u914d\u4ee5\u83b7\u53d6\u6811\u4e2d\u7684\u7269\u7406\u7d22\u5f15\uff08\u53ef\u80fd\u5305\u542b\u590d\u7528\u7684\u65e7\u5757\uff09</li> <li>\u5c06 Radix Tree \u8fd4\u56de\u7684 \u00a0<code>new_indices</code>\u00a0 \u5199\u56de \u00a0<code>req_to_token_pool]</code>\uff0c\u786e\u4fdd\u8bf7\u6c42\u540e\u7eed\u4f7f\u7528\u7684\u7269\u7406\u7d22\u5f15\u4e0e\u6811\u4e2d\u4e00\u81f4\u3002</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_2","title":"\u4f55\u65f6\u8fdb\u884c\u66f4\u65b0\uff1f","text":"<p>\u4e3b\u8981\u6709\u4e24\u4e2a\u89e6\u53d1\u65f6\u673a\uff1a</p> <ol> <li>\u8bf7\u6c42\u5b8c\u6210\u65f6 (<code>cache_finished_req()</code>):    - \u5f53\u4e00\u4e2a\u8bf7\u6c42\u751f\u6210\u7ed3\u675f\uff08\u9047\u5230 EOS \u6216\u8fbe\u5230\u6700\u5927\u957f\u5ea6\uff09\uff0c\u7cfb\u7edf\u4f1a\u5c06\u8be5\u8bf7\u6c42\u5b8c\u6574\u7684 Token \u5e8f\u5217\uff08Prompt + Output\uff09\u4f5c\u4e3a\u4e00\u6761\u8def\u5f84\u63d2\u5165\u5230 Radix Tree \u4e2d\u3002    - \u8fd9\u4f7f\u5f97\u540e\u7eed\u76f8\u540c\u7684 Prompt \u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u5b8c\u6574\u7684 KV Cache\u3002</li> <li>\u5206\u5757 Prefill \u7ed3\u675f\u65f6 (<code>cache_unfinished_req()</code>):    - \u5bf9\u4e8e\u8d85\u957f Prompt\uff0cSGLang \u4f1a\u5c06\u5176\u5207\u5206\u4e3a\u591a\u4e2a Chunk \u8fdb\u884c Prefill\u3002    - \u6bcf\u5904\u7406\u5b8c\u4e00\u4e2a Chunk\uff0c\u7cfb\u7edf\u4f1a\u8c03\u7528 <code>cache_unfinished_req()</code>\u00a0 \u5c06\u5f53\u524d\u5df2\u8ba1\u7b97\u597d\u7684\u90e8\u5206\u524d\u7f00\u63d2\u5165 Radix Tree\u3002    - \u8fd9\u6837\uff0c\u5373\u4f7f\u8bf7\u6c42\u8fd8\u6ca1\u5b8c\u5168\u5904\u7406\u5b8c\uff0c\u5176\u4e2d\u95f4\u72b6\u6001\u4e5f\u53ef\u4ee5\u88ab\u4fdd\u5b58\uff0c\u9632\u6b62\u88ab\u610f\u5916\u9a71\u9010\uff0c\u5e76\u5141\u8bb8\u5728\u540e\u7eed Chunk \u4e2d\u7ee7\u7eed\u590d\u7528\u3002</li> </ol>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#page","title":"\u5982\u4f55\u5904\u7406\u4e0d\u8db3\u4e00\u4e2a Page \u7684\u90e8\u5206\uff1f","text":"<p>\u5f53 \u00a0<code>page_size &gt; 1</code>\uff08\u4f8b\u5982 16\uff09\u65f6\uff0cRadix Tree\u00a0\u53ea\u5b58\u50a8\u5b8c\u6574\u7684 Page\u3002\u5bf9\u4e8e\u4e0d\u8db3\u4e00\u4e2a Page \u7684\u5c3e\u90e8\u6570\u636e\uff0c\u5904\u7406\u903b\u8f91\u5982\u4e0b\uff1a</p> <ul> <li>\u5bf9\u9f50\u622a\u65ad (Alignment &amp; Truncation):</li> <li>\u4f1a\u5c06 Token \u5e8f\u5217\u957f\u5ea6\u5411\u4e0b\u53d6\u6574\u5230 \u00a0<code>page_size</code> \u7684\u500d\u6570\u3002\u53ea\u6709\u5b8c\u6574\u7684 Page \u4f1a\u88ab\u63d2\u5165\u6811\u4e2d\u5e76\u5171\u4eab\u3002</li> <li>\u5c3e\u90e8\u5904\u7406 (Tail Handling):</li> <li>\u4e0d\u5165\u6811: \u5269\u4f59\u7684\u4e0d\u8db3 16 \u4e2a Token \u7684 KV Cache\u00a0\u4e0d\u4f1a\u00a0 \u88ab\u63d2\u5165 Radix Tree\u3002\u8fd9\u610f\u5473\u7740\u8fd9\u90e8\u5206\u6570\u636e\u65e0\u6cd5\u88ab\u5176\u4ed6\u8bf7\u6c42\u901a\u8fc7 Radix Tree \u5339\u914d\u5230\u3002</li> <li>\u79c1\u6709\u4fdd\u7559: \u867d\u7136\u4e0d\u5165\u6811\uff0c\u4f46\u8fd9\u90e8\u5206 KV Cache \u5bf9\u5e94\u7684\u7269\u7406\u7d22\u5f15\uff08Indices\uff09\u4f1a\u88ab\u4fdd\u7559\u5728\u5f53\u524d\u8bf7\u6c42\u5bf9\u8c61 (<code>req.prefix_indices</code>) \u4e2d\uff0c\u540e\u7eed\u540e\u7aef\u8fdb\u884c\u8ba1\u7b97\u65f6\u4f1a\u83b7\u53d6\u5bf9\u5e94\u7684 KV Cache\u3002</li> <li>\u540e\u7eed\u590d\u7528: \u5f53\u8be5\u8bf7\u6c42\u5904\u7406\u4e0b\u4e00\u4e2a Chunk \u65f6\uff0c\u5b83\u4f1a\u76f4\u63a5\u62fc\u63a5\u8fd9\u4e9b\u4fdd\u7559\u7684 Indices\uff0c\u4ece\u800c\u65e0\u7f1d\u7ee7\u7eed\u8ba1\u7b97\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u8fd9\u90e8\u5206\u5c3e\u5df4\u3002</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#eviction-policy","title":"\u5185\u5b58\u7ba1\u7406\u4e0e\u9a71\u9010\u7b56\u7565\uff08Eviction Policy\uff09","text":"<p>\u663e\u5b58\u662f\u6709\u9650\u7684\uff0cRadix Tree \u4e0d\u80fd\u65e0\u9650\u589e\u957f\u3002</p> <ul> <li>\u5f15\u7528\u8ba1\u6570\uff08Reference Counting\uff09\uff1a \u6bcf\u4e2a\u8282\u70b9\u90fd\u6709\u4e00\u4e2a\u5f15\u7528\u8ba1\u6570\uff0c\u8868\u793a\u5f53\u524d\u6709\u591a\u5c11\u4e2a\u6b63\u5728\u8fd0\u884c\u7684\u8bf7\u6c42\u6b63\u5728\u4f7f\u7528\u8fd9\u4e2a\u8282\u70b9\u5bf9\u5e94\u7684 KV Cache\u3002</li> <li>LRU \u9a71\u9010: <code>evict()</code> \u51fd\u6570   1. \u6536\u96c6\u53f6\u5b50:\u00a0<code>_collect_leaves()</code>\u00a0 \u627e\u5230\u6240\u6709\u5f15\u7528\u8ba1\u6570\u4e3a 0 \u7684\u53f6\u5b50\u8282\u70b9\u3002   1. \u6392\u5e8f: \u5bf9\u53f6\u5b50\u8282\u70b9\u6392\u5e8f\u3002   1. \u5220\u9664: \u5faa\u73af\u5220\u9664\u6700\u8fd1\u6700\u5c11\u4f7f\u7528\u7684\u53f6\u5b50\u8282\u70b9\uff0c\u5e76\u91ca\u653e\u5176\u5bf9\u5e94\u7684 KV Cache (<code>self.token_to_kv_pool_allocator.free(x.value)</code>).   1. \u9012\u5f52\u5220\u9664: \u5982\u679c\u5220\u9664\u53f6\u5b50\u540e\uff0c\u5176\u7236\u8282\u70b9\u53d8\u6210\u4e86\u65e0\u5b50\u8282\u70b9\u7684\u53f6\u5b50\u4e14\u5f15\u7528\u8ba1\u6570\u4e3a 0\uff0c\u7236\u8282\u70b9\u4e5f\u4f1a\u88ab\u52a0\u5165\u9a71\u9010\u5019\u9009\u961f\u5217\u3002</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_3","title":"\u4f55\u65f6\u8fdb\u884c\u9a71\u9010\uff1f","text":""},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#1-allocation","title":"1. \u663e\u5b58\u5206\u914d\u4e0d\u8db3\u65f6 (Allocation)","text":"<p>\u8fd9\u662f\u6700\u5e38\u89c1\u7684\u89e6\u53d1\u70b9\u3002\u5f53\u7cfb\u7edf\u5c1d\u8bd5\u4e3a\u65b0\u7684 Token \u5206\u914d\u7269\u7406\u663e\u5b58\uff08KV Cache Block\uff09\u4f46\u53d1\u73b0 \u00a0allocator \u4e2d\u7684\u7a7a\u95f2\u5757\u4e0d\u8db3\u65f6\uff0c\u91ca\u653e Radix Tree \u4e2d\u6700\u8fd1\u6700\u5c11\u4f7f\u7528\uff08LRU\uff09\u7684\u8282\u70b9\u3002</p> <ul> <li>Prefill \u9636\u6bb5:\u00a0alloc_paged_token_slots_extend\uff08\u4e3a Prompt \u9636\u6bb5\u5206\u914d\u663e\u5b58\u65f6\uff09\u3002</li> <li>Decode \u9636\u6bb5:\u00a0alloc_paged_token_slots_decode)\uff08\u4e3a\u751f\u6210\u65b0 Token \u5206\u914d\u663e\u5b58\u65f6\uff09\u3002</li> <li>\u901a\u7528\u5206\u914d:\u00a0alloc_token_slots\uff08\u975e\u5206\u9875\u6a21\u5f0f\u6216\u901a\u7528\u5206\u914d\u65f6\uff09\u3002</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#2-memory-check","title":"2. \u89e3\u7801\u524d\u7684\u5185\u5b58\u68c0\u67e5 (Memory Check)","text":"<p>\u5728\u6bcf\u4e00\u8f6e\u89e3\u7801\uff08Decode\uff09\u5f00\u59cb\u524d\uff0c\u8c03\u5ea6\u5668\u4f1a\u4e3b\u52a8\u68c0\u67e5\u662f\u5426\u6709\u8db3\u591f\u7684\u663e\u5b58\u6765\u5bb9\u7eb3\u5f53\u524d Batch \u4e2d\u6240\u6709\u8bf7\u6c42\u751f\u6210\u7684\u4e0b\u4e00\u4e2a Token\u3002</p> <p>\u5982\u679c\u9884\u6d4b\u5230\u663e\u5b58\u4e0d\u8db3\uff0c\u5b83\u4f1a\u5148\u5c1d\u8bd5\u8c03\u7528 \u00a0<code>evict_from_tree_cache()</code>\u00a0 \u6e05\u7406\u7a7a\u95f4\u3002\u5982\u679c\u6e05\u7406\u540e\u4ecd\u7136\u4e0d\u8db3\uff0c\u5219\u4f1a\u89e6\u53d1 \u00a0Retraction\uff08\u8bf7\u6c42\u56de\u9000/\u62a2\u5360\uff09\u3002</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#3-retraction","title":"3. \u8bf7\u6c42\u56de\u9000/\u62a2\u5360\u65f6 (Retraction)","text":"<p>\u5f53\u663e\u5b58\u4e25\u91cd\u4e0d\u8db3\uff0c\u5fc5\u987b\u5f3a\u5236\u505c\u6b62\u67d0\u4e9b\u6b63\u5728\u8fd0\u884c\u7684\u8bf7\u6c42\uff08Retract\uff09\u4ee5\u817e\u51fa\u7a7a\u95f4\u7ed9\u5176\u4ed6\u9ad8\u4f18\u5148\u7ea7\u8bf7\u6c42\u6216\u9632\u6b62 OOM \u65f6\u3002</p> <p>\u5f53\u4e00\u4e2a\u8bf7\u6c42\u88ab\u201c\u6740\u6389\u201d\u6216\u56de\u9000\u65f6\uff0c\u7cfb\u7edf\u4f1a\u7acb\u5373\u8c03\u7528 <code>evict()</code>\u00a0 \u6765\u786e\u4fdd\u5176\u5360\u7528\u7684\u8d44\u6e90\u88ab\u5f7b\u5e95\u91ca\u653e\u5e76\u8f6c\u5316\u4e3a\u53ef\u7528\u7684\u7a7a\u95f2\u5757\u3002</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#cache-aware-scheduling","title":"Cache-Aware Scheduling","text":""},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_4","title":"\u6ce8\u610f","text":"<p>\u8981\u542f\u7528\u8fd9\u4e2a\u903b\u8f91\uff0c\u542f\u52a8\u670d\u52a1\u65f6\u9700\u8981\u8bbe\u7f6e \u00a0<code>--schedule-policy lpm</code>\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8c03\u5ea6\u7b56\u7565\u662f \u00a0<code>fcfs</code>\uff0c\u6b64\u65f6\u4e0d\u4f1a\u8fdb\u884c\u57fa\u4e8e\u524d\u7f00\u957f\u5ea6\u7684\u6392\u5e8f\u3002</p> <p></p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_5","title":"\u6d41\u7a0b","text":"<ol> <li>\u8c03\u7528\u5165\u53e3\uff1a\u5728 \u00a0<code>scheduler.py</code>\u00a0 \u7684 \u00a0<code>get_new_batch_prefill()</code>\u00a0 \u65b9\u6cd5\u4e2d\u3002\\    \u5728\u4ece \u00a0<code>waiting_queue</code>\u00a0 \u53d6\u51fa\u8bf7\u6c42\u4e4b\u524d\uff0c\u4f1a\u8c03\u7528 \u00a0<code>self.policy.calc_priority()</code>\u3002 Python<pre><code># python/sglang/srt/managers/scheduler.py\ndef get_new_batch_prefill(self) -&gt; Optional[ScheduleBatch]:\n    # ...\n    # Get priority queue\n    self.policy.calc_priority(self.waiting_queue)  # &lt;--- \u8fd9\u91cc\u89e6\u53d1\u6392\u5e8f\n    # ...\n</code></pre></li> <li>\u6392\u5e8f\u5b9e\u73b0\uff1a\u5728 \u00a0schedule_policy.py\u00a0 \u4e2d\u3002\\ <code>calc_priority()</code>\u00a0 \u65b9\u6cd5\u4f1a\u6839\u636e\u5f53\u524d\u7684\u7b56\u7565\uff08\u5982 \u00a0<code>lpm</code>\uff09\u8ba1\u7b97\u524d\u7f00\u5339\u914d\u5e76\u6392\u5e8f\u3002 <p>\u201c\u5168\u91cf\u904d\u5386\u6536\u96c6 -&gt; \u5806\u6392\u5e8f\u201d </p>Python<pre><code># python/sglang/srt/managers/schedule_policy.py\ndef calc_priority(self, waiting_queue: List[Req]) -&gt; bool:\n    # ...\n    if isinstance(policy, CacheAwarePolicy):\n        # 1. \u8ba1\u7b97\u524d\u7f00\u5339\u914d (\u5bf9\u5e94\u56fe\u4e2d Search for the prefix matching)\n        temporary_deprioritized = self._compute_prefix_matches(waiting_queue, policy)\n        if policy == CacheAwarePolicy.LPM:\n            # 2. \u6839\u636e\u524d\u7f00\u957f\u5ea6\u6392\u5e8f (\u5bf9\u5e94\u56fe\u4e2d requests.sort())\n            SchedulePolicy._sort_by_longest_prefix(\n                waiting_queue, temporary_deprioritized\n            )\n    # ...\n\n\n@staticmethod\ndef _sort_by_longest_prefix(\n    waiting_queue: List[Req], temporary_deprioritized: Set[int]\n) -&gt; None:\n    \"\"\"Sorts the waiting queue based on the longest prefix match.\"\"\"\n    waiting_queue.sort(\n        key=lambda r: (\n            -len(r.prefix_indices)  # \u6309\u5339\u914d\u5230\u7684\u524d\u7f00\u957f\u5ea6\u964d\u5e8f\u6392\u5e8f\n            if r.rid not in temporary_deprioritized\n            else float(\"inf\")\n        )\n    )\n</code></pre><p></p> </li> </ol>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_6","title":"\u8865\u5145","text":"<p>\u4ece\u4ee3\u7801\u770b SGLang \u7684 KV Cache \u4e2d\u8bbe\u7f6e\u4e86 <code>page_size=1</code>\uff0c\u8fd9\u91cc\u8865\u4e0a <code>page_size &gt; 1</code> \u7684\u8ba8\u8bba\u3002</p> <p>\u4e3a\u4e86\u5229\u7528 PagedAttention\uff08\u6765\u81ea vLLM\uff09\u6216 FlashInfer \u7b49\u540e\u7aef\u7684\u9ad8\u6548\u8ba1\u7b97\uff0cpage_size \u901a\u5e38\u8bbe\u7f6e\u4e3a 16 \u6216 32\u3002</p> <p>\u5f53 page_size &gt; 1 \u65f6\uff0c\u6838\u5fc3\u601d\u60f3\u4ece\u201c\u9010 Token \u7ba1\u7406\u201d\u8f6c\u53d8\u4e3a\u201c\u9010 Page \u7ba1\u7406\u201d\uff0c\u4f46 SGLang \u4e3a\u4e86\u4fdd\u6301 RadixAttention \u7684\u7075\u6d3b\u6027\uff0c\u4f9d\u7136\u4fdd\u7559\u4e86\u7ec6\u7c92\u5ea6\u7684 Token \u6620\u5c04\u3002</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_7","title":"\u5206\u914d\u5668","text":"<p><code>token_to_kv_pool_allocator</code>\u5185\u5b58\u5206\u914d\u5fc5\u987b\u6309\u9875\u5bf9\u9f50 (Page Aligned)\u3002</p> <ul> <li>\u5982\u679c\u4e00\u4e2a\u8bf7\u6c42\u7684\u957f\u5ea6\u4e0d\u662f page_size \u7684\u500d\u6570\uff0c\u6700\u540e\u4e00\u4e2a Page \u4f1a\u6709\u672a\u4f7f\u7528\u7684\u69fd\u4f4d\uff08Padding\uff09\u3002</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_8","title":"\u6a21\u578b\u63a8\u7406\u6d41\u7a0b","text":""},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#prefill","title":"Prefill \u9636\u6bb5","text":"<ul> <li> <p>Prefix Matching: \u4f9d\u7136\u7cbe\u786e\u5339\u914d token\u3002\u5047\u8bbe\u5339\u914d\u4e86 20 \u4e2a token (page_size=16)\uff0c\u8fd9\u610f\u5473\u7740\u5339\u914d\u4e86\u5b8c\u6574\u7684 Page 0 \u548c Page 1 \u7684\u524d 4 \u4e2a token\u3002</p> </li> <li> <p>Memory Allocation: \u5047\u8bbe\u65b0\u8f93\u5165\u6709 10 \u4e2a token\u3002\u5982\u679c Page 1 \u8fd8\u6709\u5269\u4f59\u7a7a\u95f4\uff08\u5f53\u524d\u7528\u4e86 4 \u4e2a\uff0c\u5269 12 \u4e2a\uff09\uff0c\u5219\u76f4\u63a5\u586b\u5165 Page 1\u3002\u5982\u679c\u7a7a\u95f4\u4e0d\u8db3\uff0c\u5219\u5206\u914d\u65b0\u7684 Page\u3002<code>alloc_extend_kernel</code>\u5206\u914d\u903b\u8f91\u88ab\u660e\u786e\u5206\u4e3a\u4e86\u4e09\u90e8\u5206\uff1a</p> </li> <li> <p>Part 1 (Fill old partial page): \u8ba1\u7b97\u524d\u7f00\u6700\u540e\u4e00\u4e2a Page \u5269\u4f59\u7684 slot \u6570\u91cf (num_part1)\uff0c\u5e76\u5c06\u65b0\u751f\u6210\u7684 Token \u586b\u5165\u8fd9\u4e2a Page \u7684\u5269\u4f59\u4f4d\u7f6e\u3002</p> </li> <li>Part 2 (Fill new full pages): \u5982\u679c\u8fd8\u6709\u5269\u4f59 Token\uff0c\u5206\u914d\u65b0\u7684\u5b8c\u6574 Page\u3002</li> <li>Part 3 (Fill new partial page): \u5904\u7406\u6700\u540e\u5269\u4f59\u7684\u4e0d\u8db3\u4e00\u4e2a Page \u7684 Token\u3002</li> </ul> <p>\u5728 <code>common.py</code> \u7684 <code>alloc_for_extend()</code> \u51fd\u6570\u4e2d\uff0c\u7cfb\u7edf\u4f1a\u83b7\u53d6\u524d\u7f00\u6700\u540e\u4e00\u4e2a Token \u7684\u7269\u7406\u4f4d\u7f6e (last_loc) \u5e76\u4f20\u9012\u7ed9\u5206\u914d\u5668\uff0c\u4ece\u800c\u5b9e\u73b0\u8fd9\u4e00\u673a\u5236\u3002</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#decode","title":"Decode \u9636\u6bb5","text":"<p>SGLang \u7684 Decode \u5185\u5b58\u5206\u914d\u4e3b\u8981\u7531 <code>alloc_decode_kernel</code> \u548c <code>alloc_for_decode</code> \u534f\u540c\u5b8c\u6210\u3002</p> <ul> <li> <p>\u68c0\u67e5\u5f53\u524d Page (Check Page Full):</p> </li> <li> <p>\u8ba1\u7b97\u516c\u5f0f: <code>num_new_pages = (seq_len + page_size - 1) // page_size - (pre_len + page_size - 1) // page_size</code></p> </li> <li>\u5982\u679c num_new_pages == 0\uff0c\u8bf4\u660e\u5f53\u524d Page \u672a\u6ee1\u3002</li> <li> <p>\u5982\u679c num_new_pages &gt; 0\uff0c\u8bf4\u660e\u5f53\u524d Page \u5df2\u6ee1\uff0c\u9700\u8981\u65b0 Page\u3002</p> </li> <li> <p>\u5199\u5165\u6570\u636e (Write Data):</p> </li> <li> <p>\u672a\u6ee1 (Append): \u76f4\u63a5\u83b7\u53d6 last_loc (\u4e0a\u4e00\u4e2a token \u7684\u7269\u7406\u4f4d\u7f6e)\uff0c\u65b0 token \u5199\u5165 last_loc + 1\u3002</p> </li> <li> <p>\u5df2\u6ee1 (New Page): \u4ece free_page_ptr \u62ff\u4e00\u4e2a\u65b0\u7684\u7269\u7406 Page ID (\u4f8b\u5982 p)\uff0c\u65b0 token \u5199\u5165 p * page_size (\u5373\u8be5 Page \u7684\u7b2c 0 \u4e2a slot)\u3002</p> </li> <li> <p>\u66f4\u65b0\u6620\u5c04 (Update Mapping):: \u5c06\u65b0\u5206\u914d\u7684\u7269\u7406\u4f4d\u7f6e\u5199\u5165 <code>req_to_token_pool</code> \u7684\u5bf9\u5e94\u4f4d\u7f6e\u3002</p> </li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#block-table","title":"Block Table","text":"<p>SGLang \u4e0e vLLM \u7684\u4e00\u4e2a\u663e\u8457\u533a\u522b\u662f\uff1aSGLang \u7ef4\u62a4\u7684\u662f Token \u7ea7\u7684\u6620\u5c04 (req_to_token)\uff0cSGLang \u901a\u8fc7\u5bf9 <code>req_to_token_pool</code> \u8fdb\u884c\u6b65\u957f\u5207\u7247 (Strided Slice) \u6765\u751f\u6210 Block Table\u3002</p> Python<pre><code># python/sglang/srt/layers/attention/flashattention_backend.py\ndef init_forward_metadata(self, forward_batch: ForwardBatch):\n    # 1. \u9996\u5148\uff0c\u4ece req_to_token_pool \u4e2d\u83b7\u53d6 Token \u7ea7\u7684\u7269\u7406\u7d22\u5f15\n    # metadata.page_table \u6b64\u65f6\u5b58\u50a8\u7684\u662f [Batch, Max_Len] \u7684\u7269\u7406 Token ID \u77e9\u9635\n    # \u4f8b\u5982: [[40, 41, 42, 43, 48, 49, ...]]\n    metadata.page_table = forward_batch.req_to_token_pool.req_to_token[\n        forward_batch.req_pool_indices, : metadata.max_seq_len_k\n    ]\n\n    # 2. Convert the page table to a strided format which is needed by FA3 API\n    # \u5982\u679c page_size &gt; 1 (\u4f8b\u5982 4)\uff0c\u5219\u9700\u8981\u8fdb\u884c\u6b65\u957f\u5207\u7247\u8f6c\u6362\n    if self.page_size &gt; 1:\n        # \u751f\u6210\u6b65\u957f\u7d22\u5f15: [0, 4, 8, 12, ...]\n        self.strided_indices = torch.arange(\n            0, metadata.page_table.shape[1], self.page_size, device=self.device\n        )\n        # \u6838\u5fc3\u64cd\u4f5c\uff1a\n        # A. \u5207\u7247 (Slice): \u53d6\u51fa\u6bcf\u4e2a Page \u7684\u7b2c\u4e00\u4e2a Token \u7684\u7269\u7406\u7d22\u5f15\n        #    [40, 41, 42, 43, 48, 49] -&gt; [40, 48]\n        # B. \u8f6c\u6362 (Convert): \u5c06\u7269\u7406 Token ID \u8f6c\u6362\u4e3a\u7269\u7406 Page ID\n        #    40 // 4 = 10, 48 // 4 = 12\n        metadata.page_table = (\n            metadata.page_table[:, self.strided_indices] // self.page_size\n        )\n</code></pre>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_9","title":"\u95ee\u9898","text":""},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#q1-radix-tree-gil","title":"Q1\uff1a\u9ad8\u5e76\u53d1\u4e0b\uff0c\u5982\u4f55\u4fdd\u8bc1 Radix Tree \u5b89\u5168\uff1fGIL \u4f1a\u4e0d\u4f1a\u5f71\u54cd\u6548\u7387\uff1f","text":"<p>\u5728 SGLang \u7684\u67b6\u6784\u4e2d\uff0cRadix Tree \u7684\u7ebf\u7a0b\u5b89\u5168\u4e0d\u662f\u9760\u9501\uff08Lock\uff09\u6765\u5b9e\u73b0\u7684\uff0c\u800c\u662f\u9760\u201c\u4e32\u884c\u5316\u201d\u3002</p> <ul> <li>\u5355\u7ebf\u7a0b\u8c03\u5ea6\u5668 (Single-threaded Scheduler)\uff1a\\   SGLang \u7684\u6838\u5fc3\u8c03\u5ea6\u903b\u8f91\uff08<code>event_loop()</code>\uff09\u8fd0\u884c\u5728\u4e00\u4e2a\u5355\u7ebf\u7a0b\u7684\u4e3b\u5faa\u73af\u4e2d\u3002</li> <li>\u6240\u6709\u7684\u8bf7\u6c42\uff08Request\uff09\u901a\u8fc7 ZMQ \u961f\u5217\u8fdb\u5165\uff0c\u88ab\u4e32\u884c\u5730\u53d6\u51fa\u3002</li> <li>\u6240\u6709\u7684 Radix Tree \u64cd\u4f5c\uff08<code>insert</code>,\u00a0<code>match_prefix</code>,\u00a0<code>evict</code>\uff09\u90fd\u53ea\u5728\u8fd9\u4e2a\u4e3b\u7ebf\u7a0b\u4e2d\u6267\u884c\u3002</li> <li>\u56e0\u6b64\uff0c\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u5728\u4fee\u6539 Radix Tree\uff0c\u4ece\u6839\u672c\u4e0a\u907f\u514d\u4e86\u591a\u7ebf\u7a0b\u7ade\u4e89\uff08Race Condition\uff09\uff0c\u4e0d\u9700\u8981\u590d\u6742\u7684\u4e92\u65a5\u9501\uff08Mutex\uff09\u3002</li> <li>\u903b\u8f91\u5f15\u7528\u8ba1\u6570 (Logical Ref Counting)\uff1a\\   \u867d\u7136\u6ca1\u6709\u7ebf\u7a0b\u9501\uff0c\u4f46 Radix Tree \u5185\u90e8\u7ef4\u62a4\u4e86 \u00a0<code>lock_ref</code>\uff08\u5f15\u7528\u8ba1\u6570\uff09\u3002</li> <li>\u4f5c\u7528\uff1a\u8fd9\u4e0d\u662f\u4e3a\u4e86\u7ebf\u7a0b\u540c\u6b65\uff0c\u800c\u662f\u4e3a\u4e86\u5185\u5b58\u5b89\u5168\u3002\u5b83\u9632\u6b62\u8c03\u5ea6\u5668\u5728\u5904\u7406\u5f53\u524d Batch \u65f6\uff0c\u9519\u8bef\u5730\u628a\u6b63\u5728\u4f7f\u7528\u7684 KV Cache \u9875\uff08Page\uff09\u7ed9\u9a71\u9010\uff08Evict\uff09\u6389\u3002</li> <li>\u673a\u5236\uff1a\u5f53\u4e00\u4e2a Request \u6b63\u5728\u8fd0\u884c\uff08Running\uff09\u65f6\uff0c\u5b83\u6240\u5360\u7528\u7684 Radix Tree \u8282\u70b9\u7684 <code>lock_ref</code>\u00a0 \u4f1a\u589e\u52a0\uff0c\u786e\u4fdd \u00a0<code>evict()</code>\u00a0 \u51fd\u6570\u4e0d\u4f1a\u56de\u6536\u8fd9\u4e9b\u8282\u70b9\u3002</li> </ul> <p>GIL \u662f Python \u5b9e\u73b0\u7248\u672c\u7684\u4e3b\u8981\u74f6\u9888\u4e4b\u4e00\u3002</p> <ul> <li> <p>Python \u7248 Radix Tree (\u9ed8\u8ba4)\uff1a\\   \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cRadixCache\u00a0 \u662f\u7528\u7eaf Python \u5b9e\u73b0\u7684\u3002</p> </li> <li> <p>GIL \u7684\u9650\u5236\uff1a\u7531\u4e8e Python \u7684\u5168\u5c40\u89e3\u91ca\u5668\u9501\uff08GIL\uff09\uff0c\u8c03\u5ea6\u5668\u53ea\u80fd\u5229\u7528\u4e00\u4e2a CPU \u6838\u5fc3\u3002</p> </li> <li> <p>\u9ad8\u5e76\u53d1\u4e0b\u7684\u74f6\u9888\uff1a\u5728\u9ad8\u5e76\u53d1\uff08High Concurrency\uff09\u6216\u9ad8\u541e\u5410\uff08High Throughput\uff09\u573a\u666f\u4e0b\uff0c\u5927\u91cf\u7684 \u00a0<code>insert</code>\uff08\u63d2\u5165\uff09\u3001<code>match_prefix</code>\uff08\u524d\u7f00\u5339\u914d\uff09\u548c \u00a0<code>evict</code>\uff08\u9a71\u9010\uff09\u64cd\u4f5c\u4f1a\u6d88\u8017\u5927\u91cf CPU \u65f6\u95f4\u3002\u5982\u679c\u8fd9\u4e9b\u64cd\u4f5c\u592a\u6162\uff0c\u4f1a\u963b\u585e\u8c03\u5ea6\u5faa\u73af\uff0c\u5bfc\u81f4 GPU \u7b49\u5f85\uff08GPU Starvation\uff09\uff0c\u4ece\u800c\u964d\u4f4e\u6574\u4f53\u63a8\u7406\u6027\u80fd\u3002</p> </li> <li> <p>\u4e3a\u4e86\u89e3\u51b3 GIL \u5e26\u6765\u7684\u6548\u7387\u95ee\u9898\uff0cSGLang \u5f15\u5165\u4e86 C++ \u5b9e\u73b0\u7684 Radix Tree\u3002</p> </li> <li> <p>\u539f\u7406\uff1a\u5c06\u6811\u7684\u6570\u636e\u7ed3\u6784\u548c\u64cd\u4f5c\u4e0b\u6c89\u5230 C++ \u5c42\u3002\u5728\u6267\u884c\u8017\u65f6\u7684\u6811\u64cd\u4f5c\u65f6\uff0cC++ \u6269\u5c55\u53ef\u4ee5\u91ca\u653e GIL (Release GIL)\uff0c\u5141\u8bb8\u5176\u4ed6 Python \u7ebf\u7a0b\uff08\u5982\u6570\u636e\u63a5\u6536\u3001\u76d1\u63a7\u7ebf\u7a0b\uff09\u5e76\u884c\u8fd0\u884c\uff0c\u4e14 C++ \u672c\u8eab\u6267\u884c\u6548\u7387\u8fdc\u9ad8\u4e8e Python\u3002</p> </li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#q2-tail-page-token","title":"Q2\uff1a\u4e3a\u4ec0\u4e48\u5c3e\u90e8 (Tail) \u4e0d\u8db3\u4e00\u4e2a Page \u7684 Token \u4e0d\u5171\u4eab\uff1f\u771f\u7684\u65e0\u6cd5\u5171\u4eab\u5417\uff1f","text":"<ul> <li>\u5047\u8bbe\uff1a \u5047\u8bbe <code>page_size=16</code>\uff0c\u8bf7\u6c42 A \u751f\u6210\u4e86 20 \u4e2a Token\u3002\u524d 16 \u4e2a\u8fdb\u6811\u5171\u4eab\u3002\u540e 4 \u4e2a\u5728\u79c1\u6709\u663e\u5b58\u3002\u5982\u679c\u8bf7\u6c42 B \u6765\u4e86\uff0c\u6070\u597d\u4e5f\u662f\u8fd9 20 \u4e2a Token\uff0c\u524d 16 \u4e2a\u547d\u4e2d\u3002\u540e 4 \u4e2a\u5176\u5b9e\u662f\u4e00\u6837\u7684\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u628a\u90a3 4 \u4e2a Token \u7684 KV \u4ece\u8bf7\u6c42 A \u7684\u663e\u5b58 memcpy \u5230\u4e00\u4e2a\u65b0\u7684\u5b8c\u6574 Block \u91cc\u6765\u5f3a\u884c\u51d1\u5355\uff1f</li> </ul> <p>\u5c3e\u90e8\u4e0d\u8db3\u4e00\u4e2a Page \u7684 Token \u76ee\u524d\u786e\u5b9e\u4e0d\u5171\u4eab\u3002</p> <p>\u8fd9\u5e76\u975e\u201c\u65e0\u6cd5\u201d\u505a\u5230\uff0c\u800c\u662f\u57fa\u4e8e \u00a0\u5199\u51b2\u7a81\uff08Write Conflict\uff09\u3001\u7ba1\u7406\u590d\u6742\u5ea6\u00a0 \u7684\u6743\u8861\u7ed3\u679c\u3002</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_10","title":"\u5199\u51b2\u7a81","text":"<p>\u8fd9\u662f\u6700\u81f4\u547d\u7684\u539f\u56e0\u3002KV Cache Block \u5728\u201c\u751f\u6210\u9636\u6bb5\uff08Decode\uff09\u201d\u662f \u00a0\u53ef\u53d8\uff08Mutable\uff09\u00a0 \u7684\u3002</p> <ul> <li>\u573a\u666f\u590d\u73b0\uff1a</li> <li>\u8bf7\u6c42 A\uff1a\u751f\u6210\u4e86 20 \u4e2a Token\u3002\u524d 16 \u4e2a\u5728 Block X\uff08\u5171\u4eab\uff09\uff0c\u540e 4 \u4e2a\u5728 Block Y\uff08\u79c1\u6709\uff09\u3002</li> <li>\u8bf7\u6c42 B\uff1a\u547d\u4e2d\u524d 16 \u4e2a\u3002\u73b0\u5728\u5b83\u9700\u8981\u90a3\u540e 4 \u4e2a Token\u3002</li> <li>\u5982\u679c\u5171\u4eab Block Y\uff1a</li> <li>\u8bf7\u6c42 A \u6b63\u5728\u751f\u6210\u7b2c 21 \u4e2a Token\uff0c\u5b83\u4f1a\u5199\u5165 Block Y \u7684\u7b2c 5 \u4e2a\u69fd\u4f4d\uff08Slot 4\uff09\u3002</li> <li>\u8bf7\u6c42 B \u4e5f\u8981\u751f\u6210\u7b2c 21 \u4e2a Token\uff08\u53ef\u80fd\u662f\u4e0d\u540c\u7684\u5185\u5bb9\uff09\uff0c\u5b83\u4e5f\u8bd5\u56fe\u5199\u5165 Block Y \u7684\u7b2c 5 \u4e2a\u69fd\u4f4d\u3002</li> <li>\u51b2\u7a81\uff01\u00a0 \u4e24\u4e2a\u8bf7\u6c42\u4f1a\u4e92\u76f8\u8986\u76d6\u6570\u636e\u3002</li> <li>\u7ed3\u8bba\uff1a\u4e3a\u4e86\u4fdd\u8bc1\u8bf7\u6c42 B \u7684\u72ec\u7acb\u751f\u6210\uff0c\u5b83 \u00a0\u5fc5\u987b\u00a0 \u62e5\u6709\u4e00\u4e2a\u5c5e\u4e8e\u81ea\u5df1\u7684\u3001\u72ec\u7acb\u7684\u7269\u7406 Block \u6765\u5b58\u653e\u8fd9 4 \u4e2a Token \u4ee5\u53ca\u672a\u6765\u751f\u6210\u7684 Token\u3002</li> </ul> <p></p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_11","title":"\u7ba1\u7406\u590d\u6742\u5ea6","text":"<ul> <li> <p>\u5185\u5b58\u5206\u914d\u590d\u6742\u5ea6\uff1a\u5982\u679c\u5141\u8bb8\u5c3e\u90e8\u5171\u4eab\uff0c\u5185\u5b58\u5206\u914d\u5668\u9700\u8981\u8ddf\u8e2a\u54ea\u4e9b Block \u662f\u90e8\u5206\u5171\u4eab\u7684\uff0c\u54ea\u4e9b\u662f\u5b8c\u5168\u79c1\u6709\u7684\u3002\u8fd9\u4f1a\u5927\u5927\u589e\u52a0\u5206\u914d\u5668\u7684\u590d\u6742\u5ea6\u3002</p> </li> <li> <p>Memcpy \u4ee3\u4ef7\u5927\u4e8e Recompute\uff1a\u5728 GPU \u63a8\u7406\u4e2d\uff0c\u4e3a\u4e86\u51cf\u5c11\u788e\u7247\uff0c<code>page_size</code>\u00a0 \u901a\u5e38\u5f88\u5c0f\uff0816 \u6216 32\uff09\u3002\u5728\u8fd9\u79cd\u7c92\u5ea6\u4e0b\uff0c\u201c\u4e22\u5f03\u5c3e\u90e8\uff0c\u76f4\u63a5\u91cd\u7b97\u201d\u662f\u5de5\u7a0b\u4e0a\u7684\u6700\u4f18\u89e3\u3002</p> </li> <li> <p>\u8ba1\u7b97 vs. \u62f7\u8d1d\u7684\u5f00\u9500\u5bf9\u6bd4\uff1a</p> <ul> <li>\u91cd\u7b97\uff08Recompute\uff09\uff1a\u8ba1\u7b97 4 \u4e2a Token \u7684 Attention\uff08Prefill \u9636\u6bb5\uff09\u5728 GPU \u4e0a\u6781\u5feb\uff0c\u901a\u5e38\u662f\u5fae\u79d2\u7ea7\u3002</li> <li>\u62f7\u8d1d\uff08Memcpy\uff09\uff1a\u542f\u52a8\u4e00\u4e2a CUDA Kernel \u6765\u505a\u5185\u5b58\u62f7\u8d1d\uff08D2D Copy\uff09\u4e5f\u6709\u56fa\u5b9a\u5f00\u9500\uff08Kernel Launch Latency \u7ea6\u4e3a 5-10us\uff09\u3002</li> <li>\u7ed3\u679c\uff1a\u5bf9\u4e8e\u5c0f\u5c3e\u5df4\uff08&lt; 16 tokens\uff09\uff0c\u91cd\u7b97\u7684\u8017\u65f6\u53ef\u80fd\u6bd4\u542f\u52a8\u62f7\u8d1d Kernel \u8fd8\u8981\u77ed\uff0c\u6216\u8005\u4e24\u8005\u5dee\u4e0d\u591a\u3002</li> </ul> </li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#q3-radix-attention-prompt-insertedit-token-kv-cache","title":"Q3\uff1a\u5728 Radix Attention \u4e2d\uff0c\u5982\u679c\u5728\u4e00\u4e2a\u957f Prompt \u4e2d\u95f4\u63d2\u5165\uff08Insert\uff09\u6216\u4fee\u6539\uff08Edit\uff09\u4e86\u4e00\u4e2a Token\uff0c\u6574\u4e2a\u540e\u7eed\u7684 KV Cache \u8fd8\u80fd\u590d\u7528\u5417\uff1f\u5982\u679c\u4e0d\u80fd\uff0c\u6709\u6ca1\u6709\u4ec0\u4e48\u529e\u6cd5\u8ba9\u5b83\u590d\u7528\uff1f","text":"<p>\u901a\u5e38\u4e0d\u80fd\uff0cKV Cache \u5f97\u5230\u524d\u4f1a\u7ecf\u8fc7 RoPE\uff0c\u8be5\u7b97\u5b50\u5229\u7528\u7edd\u5bf9\u4f4d\u7f6e\u7f16\u7801\u6765\u5f97\u5230\u76f8\u5bf9\u4f4d\u7f6e\u4fe1\u606f\uff0c\u6240\u4ee5\u6539\u53d8 token \u4f4d\u7f6e\u4f1a\u5bf9 KV Cache \u6709\u4e0d\u53ef\u9006\u5f71\u54cd\u3002\u800c\u4e14 KV Cache \u5f3a\u4f9d\u8d56\u4e8e\u524d\u5e8f\u6240\u6709 Token\u3002\u4e2d\u95f4\u53d8\u4e86\uff0c\u540e\u9762\u7684 KV \u503c\u5168\u53d8</p> <p>\u56e0\u4e3a RoPE\uff08Rotary Positional Embedding\uff09\u662f\u7edd\u5bf9\u4f4d\u7f6e\u7f16\u7801\u7684\u4e00\u79cd\u53d8\u4f53\u3002KV Cache \u4e2d\u7684 Key \u5411\u91cf\u643a\u5e26\u4e86\u4f4d\u7f6e \\(m\\) \u7684\u65cb\u8f6c\u4fe1\u606f \\(R_m\\)\u3002\u5982\u679c\u5728\u4e2d\u95f4\u63d2\u5165 Token\uff0c\u540e\u7eed\u6240\u6709 Token \u7684\u7edd\u5bf9\u4f4d\u7f6e\u7d22\u5f15\u90fd\u4f1a\u53d1\u751f\u5e73\u79fb (\\(m \\\\to m+k\\))\uff0c\u5bfc\u81f4\u5176\u5bf9\u5e94\u7684\u65cb\u8f6c\u77e9\u9635\u53d1\u751f\u53d8\u5316\u3002\u65e7\u7684 KV Cache \u4e2d\u7684 \\(K\\) \u503c\u662f\u57fa\u4e8e\u65e7\u4f4d\u7f6e\u8ba1\u7b97\u7684\uff0c\u6570\u5b66\u4e0a\u65e0\u6cd5\u76f4\u63a5\u590d\u7528\uff0c\u5fc5\u987b\u91cd\u65b0\u8ba1\u7b97</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#q4-tensor-parallel-tp-radix-tree","title":"Q4\uff1a\u5728 Tensor Parallel (TP) \u6a21\u5f0f\u4e0b\uff0cRadix Tree \u5982\u4f55\u7ef4\u62a4\uff1f","text":"<p>\u56e0\u4e3a\u6bcf\u4e2a GPU \u90fd\u6709\u81ea\u5df1\u7684 Scheduler \u8fdb\u7a0b\uff0c\u6240\u4ee5 Radix Tree (RadixCache) \u5728\u6bcf\u4e2a GPU \u4e0a\u90fd\u7ef4\u62a4\u4e86\u4e00\u4efd\u5b8c\u6574\u7684\u526f\u672c\uff0c\u5e76\u4e14\u901a\u8fc7\u786e\u5b9a\u6027\u7684\u903b\u8f91\u4fdd\u6301\u5b8c\u5168\u4e00\u81f4\u201d\u3002</p>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#_12","title":"\u5de5\u4f5c\u6d41","text":"<p>\u5e7f\u64ad\u7684\u662f Request\uff0c\u800c\u4e0d\u662f Block Indices</p> <p>\u63a5\u6536\u4e0e\u5e7f\u64ad\uff1a</p> <ul> <li>Rank 0 \u7684 Scheduler \u63a5\u6536\u6765\u81ea Tokenizer \u7684\u8bf7\u6c42\u3002</li> <li>Rank 0 \u5c06\u8fd9\u4e9b Request \u5bf9\u8c61\uff08\u5305\u542b input_ids \u7b49\uff09\u901a\u8fc7 broadcast_pyobj \u5e7f\u64ad\u7ed9\u6240\u6709\u5176\u4ed6\u7684 TP Ranks\u3002 \u72ec\u7acb\u8c03\u5ea6\u4e0e\u5206\u914d\uff1a</li> <li>\u6240\u6709 Rank\uff080 \u5230 7\uff09\u6536\u5230\u76f8\u540c\u7684 Request \u5217\u8868\u3002</li> <li>\u6240\u6709 Rank \u8fd0\u884c \u5b8c\u5168\u76f8\u540c \u7684\u8c03\u5ea6\u7b97\u6cd5\uff08get_next_batch_to_run\uff09\u3002</li> <li>\u6240\u6709 Rank \u8fd0\u884c \u5b8c\u5168\u76f8\u540c \u7684\u5185\u5b58\u5206\u914d\u903b\u8f91\uff08alloc_for_extend / alloc_for_decode\uff09\u3002</li> <li>\u56e0\u4e3a\u8f93\u5165\u76f8\u540c\u3001\u7b97\u6cd5\u786e\u5b9a\u6027\u76f8\u540c\uff0c\u5b83\u4eec\u5404\u81ea\u8ba1\u7b97\u51fa\u7684 block_indices (\u5185\u5b58\u69fd\u4f4d) \u662f \u5b8c\u5168\u4e00\u81f4 \u7684\u3002 \u6267\u884c\uff1a</li> <li>\u6bcf\u4e2a Rank \u57fa\u4e8e\u81ea\u5df1\u8ba1\u7b97\u51fa\u7684 metadata \u548c\u5206\u914d\u597d\u7684\u5185\u5b58\uff0c\u9a71\u52a8\u672c\u5730\u7684 GPU (TpModelWorker) \u8fdb\u884c\u8ba1\u7b97\u3002</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#q5evict","title":"Q5\uff1aevict() \u73b0\u5728\u662f\u5982\u4f55\u505a\u7684\uff0c\u6709\u4f18\u5316\u7a7a\u95f4\u5417\uff1f","text":"<p>\u73b0\u5728 SGLang \u4e2d\u7684\u5904\u7406\u65b9\u5f0f\u662f DFS \u5168\u91cf\u6536\u96c6\u53f6\u5b50\u8282\u70b9 + \u5806\u6392\u5e8f\uff0c\u8fd9\u79cd\u5b9e\u73b0\u65b9\u5f0f\u5728\u9ad8\u5e76\u53d1\u6216\u957f\u4e0a\u4e0b\u6587\u573a\u666f\u4e0b\uff08\u5bfc\u81f4\u6811\u7684\u53f6\u5b50\u8282\u70b9\u6781\u591a\uff09\u4f1a\u6709\u660e\u663e\u7684\u6027\u80fd\u95ee\u9898\uff1a</p> <ul> <li>\u65f6\u95f4\u590d\u6742\u5ea6\uff1a\u6bcf\u6b21\u89e6\u53d1 Eviction\uff08\u901a\u5e38\u53d1\u751f\u5728\u663e\u5b58\u4e0d\u8db3\u9700\u8981 Swap out \u65f6\uff09\uff0c\u90fd\u9700\u8981 O(N) \u7684\u65f6\u95f4\u6765\u904d\u5386\u6811\u6536\u96c6\u53f6\u5b50\uff0c\u4ee5\u53ca O(N) \u7684\u65f6\u95f4\u6765\u5efa\u5806\uff08heapify\uff09\u3002\u6807\u51c6\u7684 LRU Cache \u914d\u5408 Hash Map + \u53cc\u5411\u94fe\u8868\u5e94\u8be5\u662f O(1) \u7684\u3002</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#q6-req_to_token-block-table","title":"Q6\uff1a\u4e3a\u4ec0\u4e48\u8bbe\u8ba1 <code>req_to_token</code> \u800c\u4e0d\u662f\u76f4\u63a5\u7ef4\u62a4 Block Table\uff1f","text":"<ul> <li>\u7edf\u4e00\u6027 (Unification): SGLang \u7684 RadixCache \u9700\u8981\u5904\u7406\u5404\u79cd\u590d\u6742\u7684 Token \u7ea7\u64cd\u4f5c\uff08\u5982\u524d\u7f00\u5339\u914d\u3001\u9a71\u9010\uff09\uff0c\u7ef4\u62a4 Token \u7ea7\u6620\u5c04\u6bd4\u7ef4\u62a4 Page \u7ea7\u6620\u5c04\u66f4\u7075\u6d3b\u3002</li> <li>\u96f6\u62f7\u8d1d (Zero-Copyish): \u867d\u7136\u4e3a\u4e86\u6784\u5efa\u903b\u8f91\u4e0a\u7684 Block Table \u505a\u4e86\u4e00\u6b21\u5207\u7247\u548c\u9664\u6cd5\uff0c\u4f46\u8fd9\u90fd\u662f\u5728 GPU \u4e0a\u6781\u5176\u9ad8\u6548\u7684 Tensor \u64cd\u4f5c\uff0c\u907f\u514d\u4e86\u5728 CPU \u4e0a\u91cd\u65b0\u6784\u5efa Block Table \u5e76\u4f20\u8f93\u5230 GPU \u7684\u5f00\u9500\uff08vLLM \u65e9\u671f\u7248\u672c\u662f\u5728 CPU \u6784\u5efa Block Table\uff09\u3002</li> <li>\u517c\u5bb9\u6027: \u8fd9\u79cd\u65b9\u5f0f\u8ba9 SGLang \u53ef\u4ee5\u8f7b\u677e\u9002\u914d\u9700\u8981 Block Table \u7684 Kernel (\u5982 FlashInfer, FlashAttention-3)\uff0c\u540c\u65f6\u4fdd\u7559\u5176\u72ec\u7279\u7684 RadixCache \u7ed3\u6784\u3002</li> </ul>"},{"location":"notes/sglang/RadixAttention%20%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%A8%E9%83%A8%E7%BB%86%E8%8A%82/#q7why-radix-tree-not-trie","title":"Q7\uff1aWhy Radix Tree Not Trie\uff1f","text":"<p>SGLang \u7684 RadixCache \u5728\u63d2\u5165\u65f6\uff0c\u5982\u679c page_size &gt; 1\uff0c\u5b9e\u9645\u4e0a\u662f\u5c06 Token \u5e8f\u5217\u7684\u957f\u5ea6\u622a\u65ad <code>(len // page_size * page_size)</code> \u540e\u4f5c\u4e3a Key \u63d2\u5165\u6811\u4e2d\u3002\u903b\u8f91\u4e0a Radix Tree \u7684\u8282\u70b9\u4ee3\u8868\u7684\u662f\u201c\u5b8c\u6574 Page \u5e8f\u5217\u201d\uff0c\u800c\u4e0d\u662f\u4efb\u610f Token \u5e8f\u5217\u3002\u8fd9\u4e0e Trie \u7684\u5b9a\u4e49\u4ea7\u751f\u4e86\u5fae\u5999\u7684\u504f\u79bb\uff08\u53d8\u4e3a Block-Trie\uff09\u3002</p> <p>\u666e\u901a\u7684 Trie \u6811\u6bcf\u4e2a\u8282\u70b9\u53ea\u5b58\u50a8\u4e00\u4e2a Token\uff0c\u4f1a\u5bfc\u81f4\u6811\u975e\u5e38\u6df1\uff0c\u904d\u5386\u548c\u7ef4\u62a4\u5f00\u9500\u5927\u3002Radix Tree \u8fdb\u884c\u4e86\u8def\u5f84\u538b\u7f29\uff0c\u5982\u679c\u4e00\u4e2a\u7236\u8282\u70b9\u53ea\u6709\u4e00\u4e2a\u5b50\u8282\u70b9\uff0c\u5b83\u4eec\u4f1a\u5408\u5e76\u3002\u8fd9\u610f\u5473\u7740\u4e00\u4e2a\u8282\u70b9\u53ef\u80fd\u5b58\u50a8\u5e8f\u5217 <code>[A, B, C]</code> \u800c\u4e0d\u4ec5\u4ec5\u662f <code>[A]</code>\u3002</p>"},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/","title":"Evolution of SGLang Scheduler","text":"2025-11-212025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#evolution-of-sglang-scheduler","title":"Evolution of SGLang Scheduler","text":"<p> \u7ea6 3246 \u4e2a\u5b57  287 \u884c\u4ee3\u7801  10 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 20 \u5206\u949f</p> <ul> <li>Initially, the Scheduler operated with CPU and GPU in serial, leading to significant GPU idle time.</li> <li>Later versions of the Scheduler allowed for CPU and GPU overlap, achieving a zero-overhead scheduler.</li> </ul> <p>The overall workflow of the Scheduler is shown in the figure below: [^code-walk]</p> <p></p> <p>We will analyze the entire Scheduler process in conjunction with the code. However, before diving into the workflow, we first need to understand the key data structures in scheduling and how they transform into one another.</p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#key-structure","title":"Key Structure","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#scheduler","title":"Scheduler","text":"<p>The <code>Scheduler</code> component is responsible for managing Active Requests. The following core global data structures are used to maintain these Active Requests within the <code>Scheduler</code>.</p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#waiting_queue","title":"<code>waiting_queue</code>","text":"<ul> <li>Purpose: <code>waiting_queue</code> is a data structure designed to hold Active Requests. It dynamically reorders these requests based on priority (longest prefix of the Request) or available memory to optimize batch processing.</li> <li>Additional Points</li> <li>Enqueue<ul> <li>Newly arrived Requests.</li> <li>Requests returned from <code>retract_decode</code>.</li> </ul> </li> <li>Dequeue The request with the highest current priority is dequeued to form a batch.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#new_batch","title":"<code>new_batch</code>","text":"<ul> <li>Purpose: Represents a batch of Requests ready for the prefill/extend phase.</li> <li>Additional Points</li> <li>Chunked Prefill: If the number of tokens required by a Request exceeds available memory (<code>remaining_tokens</code>), it may be chunked into smaller parts.</li> <li>Requests in <code>new_batch</code> will undergo prefill/extend.</li> <li>After prefill/extend, <code>new_batch</code> will transition to the Global Batch for the next iteration.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#running_batch","title":"<code>running_batch</code>","text":"<ul> <li>Purpose: A batch of Requests ready for the decode phase.</li> <li>Initialized as an empty batch: <code>ScheduleBatch(reqs=[], batch_is_full=False)</code></li> <li>Can dynamically add newly prefilled requests.</li> <li>Can remove completed requests.</li> <li>Additional Points</li> <li>Retracted: If available memory is insufficient during decode, the <code>Scheduler</code> may retract certain Requests from the <code>running_batch</code> via <code>retract_decode</code>, returning them to the <code>waiting_queue</code> for later processing.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#cur_batch","title":"<code>cur_batch</code>","text":"<ul> <li>Purpose: The batch of Requests currently being processed in the <code>Scheduler</code> main loop (<code>run_batch</code> function). <code>prefill</code> takes precedence.</li> <li>Additional Points</li> <li><code>cur_batch</code> is assigned in <code>event_loop_normal</code>.</li> <li>The logic for forming <code>cur_batch</code> is:<ul> <li>If there are Requests ready for prefill (<code>new_batch</code>) in this round, <code>new_batch</code> is used as <code>cur_batch</code>.</li> <li>Otherwise, <code>cur_batch</code> will process Requests ready for decode, so <code>running_batch</code> is used as <code>cur_batch</code>.</li> </ul> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#three-important-batches","title":"Three Important Batches","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#overview","title":"Overview","text":"<ul> <li><code>ScheduleBatch</code> is managed by <code>schedule.py::Scheduler</code>. It contains high-level scheduling data, most of which resides on the CPU.</li> <li><code>ModelWorkerBatch</code> is managed by <code>tp_worker.py::TpModelWorker</code>. It is a subset of <code>ScheduleBatch</code>, containing only data relevant to model forward on the GPU, and it transitions from the CPU scheduler to the GPU model runner.</li> <li><code>ForwardBatch</code> is managed by <code>model_runner.py::ModelRunner</code> and contains low-level tensor data.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#schedulebatch","title":"ScheduleBatch","text":"Python<pre><code>class ScheduleBatch:\n    reqs: List[Req]  # List of requests\n    req_to_token_pool: ReqToTokenPool  # Request to token mapping pool\n    token_to_kv_pool_allocator: BaseTokenToKVPoolAllocator  # KV cache allocator\n    tree_cache: BasePrefixCache  # Prefix cache tree\n    forward_mode: ForwardMode  # Forward mode\n\n    # Batch related\n    input_ids: torch.Tensor  # Input token IDs\n    seq_lens: torch.Tensor  # Sequence lengths\n    extend_lens: List[int]  # Extend lengths (seq_len - prefix_len)\n    prefix_lens: List[int]  # Prefix lengths\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#modelworkerbatch","title":"ModelWorkerBatch","text":"Python<pre><code>class ModelWorkerBatch:\n    forward_mode: ForwardMode\n    input_ids: torch.Tensor  # Input token IDs\n    req_pool_indices: torch.Tensor  # Indices of out_cache_loc corresponding to req\n    seq_lens: torch.Tensor  # Sequence lengths\n    out_cache_loc: torch.Tensor  # Allocated KV cache\n\n    # Extension related (seq - prefix)\n    extend_num_tokens: Optional[int]\n    extend_seq_lens: Optional[List[int]]\n    extend_prefix_lens: Optional[List[int]]\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#forwardbatch","title":"ForwardBatch","text":"Python<pre><code>class ForwardBatch:\n    forward_mode: ForwardMode\n    batch_size: int\n    input_ids: torch.Tensor\n    seq_lens: torch.Tensor\n    positions: torch.Tensor  # Position encoding\n\n    # Attention related\n    attn_backend: AttentionBackend\n    token_to_kv_pool: KVCache\n\n    # Extension information (seq - prefix)\n    extend_num_tokens: Optional[int]\n    extend_start_loc: Optional[torch.Tensor]\n    extend_prefix_lens: Optional[torch.Tensor]\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#batch-transformation","title":"Batch Transformation","text":"Python<pre><code># 1. Scheduler creates ScheduleBatch\ndef run_batch(self, batch: ScheduleBatch):\n    # 2. Convert to ModelWorkerBatch\n    model_worker_batch = batch.get_model_worker_batch()\n\n\n# 3. TpModelWorker processing\ndef forward_batch_generation(self, model_worker_batch: ModelWorkerBatch):\n    # 4. Convert to ForwardBatch\n    forward_batch = ForwardBatch.init_new(model_worker_batch, self.model_runner)\n\n    # 5. ModelRunner executes forward pass\n    logits_output, can_run_cuda_graph = self.model_runner.forward(forward_batch)\n\n    # 6. Sample to generate token\n    next_token_ids = self.model_runner.sample(logits_output, forward_batch)\n\n    return GenerationBatchResult(\n        logits_output=logits_output,\n        next_token_ids=next_token_ids,\n        can_run_cuda_graph=can_run_cuda_graph,\n    )\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#cache","title":"Cache","text":"<p>In SGLang, caching mainly involves three structures: <code>req_to_token_pool</code>, <code>token_to_kv_pool</code>, and <code>tree_cache</code>.</p> Python<pre><code>req_to_token_pool[req_idx]:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Prefix Part (1984 tokens)    \u2502    New Chunk Part (2000 tokens)    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 [loc_1, loc_2, ..., loc_1984] \u2502 [loc_1985, ..., loc_3984] \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nPosition:  0                    1984                         3984\n\nKV Cache Pool:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502loc_1 \u2502loc_2 \u2502 ... \u2502loc_1984\u2502loc_1985\u2502 ... \u2502loc_3984\u2502 ... \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 k1,v1\u2502 k2,v2\u2502 ... \u2502k1984,v1984\u2502k1985,v1985\u2502 ... \u2502k3984,v3984\u2502 ... \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#reqtotokenpool","title":"ReqToTokenPool","text":"<ul> <li>Manages the mapping from req_idx to token position.</li> <li>Allocates fixed memory slots for each request.</li> <li>Maintains the logical contiguous layout of the request's token sequence in memory.</li> </ul> Python<pre><code>class ReqToTokenPool:\n    def __init__(\n        self, size: int, max_context_len: int, device: str, enable_memory_saver: bool\n    ):\n        # Main storage structure: [number of requests, max context length]\n        self.req_to_token = torch.zeros(\n            (size, max_context_len), dtype=torch.int32, device=device\n        )\n        self.free_slots = list(range(size))  # List of free slots\n        self.size = size\n        self.max_context_len = max_context_len\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#token_to_kv_pool","title":"token_to_kv_pool","text":"<ul> <li>Manages allocation and deallocation of physical KV cache.</li> <li>Handles page-aligned memory allocation (if paging is enabled).</li> <li>Supports different allocation strategies (contiguous allocation, paged allocation, etc.).</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#tree-cache","title":"Tree Cache","text":"<p>It is essentially the organizational structure connecting the two pools. The scheduler accesses it frequently during scheduling to allocate slots in <code>req_to_token_pool</code> and <code>token_to_kv_pool</code> for requests.</p> <ul> <li> <p><code>tree_cache</code> plays a key role in scheduling policy, determining when the current request is prefilled based on prefix matching.</p> </li> <li> <p><code>page_size</code> determines the granularity of prefix matching, key matching strategy, and paged matching algorithm.</p> </li> <li> <p><code>page_size = 1</code> means exact token-by-token matching, capable of matching prefixes of any length.</p> </li> <li><code>page_size &gt; 1</code> means prefix matching by page (using <code>tuple(tokens)</code> as key).</li> </ul> Python<pre><code># page_size = 1\nroot\n\u2514\u2500\u2500 1 (child_key=1)\n    \u2514\u2500\u2500 2 (child_key=2)\n        \u2514\u2500\u2500 3 (child_key=3)\n            \u2514\u2500\u2500 4 (child_key=4)\n                \u2514\u2500\u2500 5 (child_key=5)\n\n# page_size = 4\nroot\n\u2514\u2500\u2500 (1,2,3,4) (child_key=(1,2,3,4))\n\u2514\u2500\u2500 (5,6,7,8) (child_key=(5,6,7,8))\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#relationship","title":"Relationship","text":"<p>When a new request enters:</p> <ul> <li>First, perform longest prefix matching to find the corresponding KV index.</li> <li><code>req_to_token_pool</code> allocates free slots for <code>extend_token</code> to get the <code>req_pool_idx</code>.</li> <li><code>token_to_kv_pool_allocator</code> allocates new KV Cache.</li> <li>Update the mapping between <code>req_pool_idx</code> and KV Cache.</li> </ul> Python<pre><code># Directly allocate KV cache needed for extend tokens of all reqs in this batch\nout_cache_loc = alloc_token_slots(batch.tree_cache, batch.extend_num_tokens)\n# update mapping (prefix + extend)\nreq_to_token_pool.write(\n    (req_idx, slice(0, prefix_len)),\n    prefix_tensors[i],\n)\nreq_to_token_pool.write(\n    (req_idx, slice(prefix_len, seq_len)),\n    out_cache_loc[pt : pt + extend_len],\n)\n</code></pre> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#prefilladder","title":"PrefillAdder","text":"<p>It is the core component in SGLang Scheduler responsible for batching prefill and decode requests. Its main role is to select suitable requests from the waiting queue and assemble them into a prefill batch that can be executed efficiently.</p> <p>If Mixed Chunk is enabled, a batch can contain both prefill and decode requests simultaneously.</p> Python<pre><code>class PrefillAdder:\n    def __init__(self, ...):\n        self.page_size = page_size # memory page size\n        self.tree_cache = tree_cache  # radix kv cache\n        self.token_to_kv_pool_allocator = token_to_kv_pool_allocator # kv cache pool\n        self.running_batch = running_batch # currently running decode batch\n        self.new_token_ratio = new_token_ratio # new token generation ratio\n        self.can_run_list = []      # list of runnable requests\n        self.preempt_list = []      # list of preempted requests\n        self.new_chunked_req = None   # new chunked request\n        self.log_hit_tokens = 0     # number of cache hit tokens\n        self.log_input_tokens = 0   # input token statistics\n\n    @property\n    def rem_total_tokens(self):\n        \"\"\"Calculate total remaining available tokens\"\"\"\n\n    def add_one_req(self, req: Req, has_chunked_req: bool, truncation_align_size: Optional[int]):\n        \"\"\"Add a request to the batch\"\"\"\n\n    def add_chunked_req(self, req: Req):\n        \"\"\"Handle chunked prefill request\"\"\"\n\n    def preempt_to_schedule(self, req: Req, server_args: ServerArgs) -&gt; bool:\n        \"\"\"Preempt low-priority requests to make way for high-priority ones\"\"\"\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#generationbatchresult","title":"GenerationBatchResult","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#1-logits_output-optionallogitsprocessoroutput","title":"1. logits_output: Optional[LogitsProcessorOutput]","text":"<ul> <li>Role: Contains the complete logits output and related information from the model's forward pass.</li> <li>Content:</li> <li>next_token_logits: Logits distribution of the next token <code>[batch_size, vocab_size]</code></li> <li>input_token_logprobs: Log probabilities of input tokens</li> <li>hidden_states: Hidden states (used for speculative decoding)</li> <li>Various top-k logprobs and token probability information</li> <li>Usage: Used for sampling, calculating probabilities, and returning logprob information to the user.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#2-next_token_ids-optionaltorchtensor","title":"2. next_token_ids: Optional[torch.Tensor]","text":"<ul> <li>Role: The next token ID after sampling.</li> <li>Shape:\u00a0<code>[batch_size]</code></li> <li>Content:</li> <li>Prefill mode: The first generated token sampled based on the last position.</li> <li>Decode mode: The next token generated in the current step.</li> <li>Prefill-only: All-zero placeholder tensor.</li> <li>Usage: Directly used to update the request's <code>output_ids</code> to advance the generation process.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#3-num_accepted_tokens-optionalint","title":"3. num_accepted_tokens: Optional[int]","text":"<ul> <li>Role: Number of tokens accepted in speculative decoding.</li> <li>Usage: Statistics on acceptance rate of speculative decoding, used for performance optimization and metric collection.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#4-next_draft_input-optionaleagledraftinput","title":"4. next_draft_input: Optional[EagleDraftInput]","text":"<ul> <li>Role: Input information for the next round of EAGLE speculative decoding.</li> <li>Content: Includes top-k probabilities, indices, hidden states, etc.</li> <li>Usage: Preparing input data for the next round of speculative decoding.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#5-extend_input_len_per_req-optionallistint","title":"5. extend_input_len_per_req: Optional[List[int]]","text":"<ul> <li>Role: Extended input length for each request.</li> <li>Usage: Knowing how many new tokens were actually processed for each request when processing batch results.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#6-extend_logprob_start_len_per_req-optionallistint","title":"6. extend_logprob_start_len_per_req: Optional[List[int]]","text":"<ul> <li>Role: The position where each request starts calculating logprob.</li> <li>Usage: Determining from which position to start returning logprob information to the user.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#7-copy_done-optionaltorchcudaevent","title":"7. copy_done: Optional[torch.cuda.Event]","text":"<ul> <li>Role: Synchronization event for GPU to CPU data transfer completion.</li> <li>Usage: Ensuring data transfer is complete before processing results in overlapped scheduling.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#8-delay_sample_func-optionalcallable","title":"8. delay_sample_func: Optional[callable]","text":"<ul> <li>Role: Delayed sampling function.</li> <li>Usage: In overlapped scheduling, execute forward pass first, then execute sampling operation later.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#9-future_indices-optionalfutureindices","title":"9. future_indices: Optional[FutureIndices]","text":"<ul> <li>Role: Index information in the Future mechanism.</li> <li>Usage: Managing storage and retrieval of asynchronous results in overlapped scheduling.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#normal-no-overlap","title":"Normal (No overlap)","text":"<p>LLMs have an autoregressive structure, so whether in Prefill or Decode, what drives them to the next inference step is the predicted next token of the sequence. Data containing <code>next_token_ids</code> is therefore crucial.</p> <p>In prefill mode, <code>next_token_ids</code> contains:</p> <ul> <li>Shape:\u00a0<code>[batch_size]</code>\u00a0- one token ID per request.</li> <li>Content: The next token for each sequence, i.e., the token sampled based on logits from the last position of the input sequence.</li> <li>Position: For prefill, only the last position of the sequence is used for sampling.</li> </ul> <p>In decode mode, <code>next_token_ids</code> contains:</p> <ul> <li>Shape:\u00a0<code>[batch_size]</code>\u00a0- one token ID per request.</li> <li>Content: The next token generated by each request in the current decoding step.</li> <li>Position: Sampling using the current decoding position.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#overview_1","title":"Overview","text":"<p>When a Request enters SGLang Scheduler, it goes through the following stages:</p> Bash<pre><code>Req -&gt; Pre Schedule(CPU) -&gt; Compute Batch -&gt; Sample(GPU) -&gt; Post Schedule(CPU) -&gt; next Schedule ...\n</code></pre> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#pre-schedule","title":"Pre Schedule","text":"<ul> <li>Collect requests from the TokenizerManager and put them into the waiting queue. (<code>Schedule::recv_request()</code> &amp; <code>Schedule::process_input_requests()</code>)</li> <li>Schedule from the waiting queue and <code>running_batch</code>. (<code>Schedule::get_batch_to_run()</code>)</li> <li>Prefill involves Radix Tree and Longest Prefix Matching algorithm. (<code>Req::init_next_round_input()</code>)</li> <li>Allocate memory resources required for Tokens for each request. (<code>ScheduleBatch::prepare_for_extend()</code> &amp; <code>ScheduleBatch::prepare_for_decode()</code>)</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#compute-batch","title":"Compute batch","text":"<p>New requests enter the Prefill phase, and after Prefill ends, they enter the Decode phase.</p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#prefill-schedule","title":"Prefill Schedule","text":"<ol> <li> <p><code>get_next_batch_to_run</code>: Prefill takes precedence here, so <code>get_new_batch_prefill</code> is called, and the returned <code>new_batch</code> is directly used as the batch for this execution round (i.e., <code>cur_batch</code>).</p> </li> <li> <p><code>get_new_batch_prefill</code>:</p> </li> </ol> <ul> <li>Create <code>PrefillAdder</code> to manage batch construction, selecting requests from <code>waiting_queue</code>.</li> <li><code>init_next_round_input</code> updates the prefix of the radix tree cache.</li> <li>Create a new <code>ScheduleBatch</code>, call <code>prepare_for_extend</code>:<ul> <li>Allocate <code>req_pool_indices</code>: Assign a unique index position in the request pool for each request. This index is used to store the request's token-to-KV mapping in <code>req_to_token_pool</code>.</li> <li>allocate KV cache</li> <li>Write the mapping of req to kv cache into <code>req_to_token_pool</code>.</li> </ul> </li> </ul> <ol> <li><code>run_batch()</code>: Execute Prefill inference, call <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward()</code> -&gt; <code>ModelRunner::_forward_raw()</code> -&gt; <code>ModelRunner::forward_extend()</code>, then execute backend operators and wait for results.</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#decode-schedule","title":"Decode Schedule","text":"<ol> <li><code>get_next_batch_to_run()</code>: Process completed requests from the previous batch, then merge with <code>running_batch</code>.</li> <li><code>update_running_batch()</code>:    - Call <code>prepare_for_decode()</code>:<ul> <li><code>output_ids</code> from the previous schedule become <code>input_ids</code> for this one.</li> <li>Allocate (batch size * 1) slots for <code>out_cache_loc</code>, because in decode mode we generate only one token per batch at a time. Python<pre><code>out_cache_loc = alloc_token_slots(batch.tree_cache, bs * 1)\n</code></pre></li> </ul> </li> <li><code>run_batch()</code>: Execute Decode inference, call <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward()</code> -&gt; <code>ModelRunner::_forward_raw()</code> -&gt; <code>ModelRunner::forward_decode()</code>, then execute backend operators and wait for results.</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#sample","title":"Sample","text":"<p><code>TpModelWorker::forward_batch_generation()</code>:</p> <ul> <li>If not in overlap mode, perform Sample immediately; otherwise, overlap CPU and GPU for delayed sampling.</li> <li>Sample to get <code>next_token_ids</code> of the batch for use in the next batch forward. Python<pre><code>sampling_info.update_regex_vocab_mask()\n  sampling_info.apply_logits_bias(logits_output.next_token_logits)\n  next_token_ids = self.sampler(\n      logits_output,\n      forward_batch.sampling_info,\n      forward_batch.return_logprob,\n      forward_batch.top_logprobs_nums,\n      forward_batch.token_ids_logprobs,\n      # For prefill, we only use the position of the last token.\n      (\n          forward_batch.positions\n          if forward_batch.forward_mode.is_decode()\n          else forward_batch.seq_lens - 1\n      ),\n  )\n</code></pre></li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#post-schedule","title":"Post Schedule","text":"<ul> <li>Prefill: <code>process_batch_result_prefill()</code></li> <li>Get results, call <code>tree_cache</code>'s <code>cache_unfinished_req()</code> to retain the cache for that req.</li> <li>Decode: <code>process_batch_result_decode()</code>:</li> <li>Check each Req; if completed, release the corresponding KV cache in <code>tree_cache</code> (batch release after loop interpretation).</li> <li>Return batch results via <code>stream_out()</code> to detokenizer for next steps.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#event-loop","title":"Event Loop","text":"<ul> <li>Requests will first execute the prefill phase and then the decode phase until EOS is obtained or exit for other reasons.</li> </ul> Python<pre><code>def event_loop_normal(self):\n\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"A normal scheduler loop.\"\"\"\n\u00a0 \u00a0 \u00a0 \u00a0 while True:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 recv_reqs = self.recv_requests()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.process_input_requests(recv_reqs)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 batch = self.get_next_batch_to_run()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.cur_batch = batch\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if batch:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result = self.run_batch(batch)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.process_batch_result(batch, result)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 else:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # When the server is idle, do self-check and re-init some states\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.self_check_during_idle()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.last_batch = batch\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#pre-schedule_1","title":"Pre Schedule","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#req-waiting_queue","title":"Req -&gt; Waiting_queue","text":"<ul> <li> <p>First execute <code>recv_requests</code>:</p> </li> <li> <p>Only Pipeline rank = 0 can get requests from tokenizer via zmq.</p> </li> <li>Other pipeline ranks get requests from the previous pipeline.</li> <li> <p><code>work_reqs</code> are broadcast in <code>attn_tp</code>; system <code>control_reqs</code> are broadcast across the entire <code>tp_size</code>.</p> </li> <li> <p>Then execute <code>process_input_requests</code></p> </li> </ul> <ol> <li>Extract worker_id:\u00a0<code>worker_id = recv_req.worker_id</code></li> <li>Unpack request:\u00a0<code>recv_req = recv_req.obj</code></li> <li>Dispatch processing:\u00a0<code>output = self._request_dispatcher(recv_req)</code> Call request dispatcher.<ul> <li>Construct <code>recv_req</code> as a new <code>Req</code> object.</li> <li>Call <code>_add_request_to_queue()</code> to insert <code>Req</code> into <code>waiting_queue</code>.</li> </ul> </li> <li>Send response: Send output back to the corresponding tokenizer worker process.</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#waiting_queuerunning_batch-cur_batch","title":"Waiting_queue/running_batch -&gt; cur_batch","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#get-prefill-batch-get_new_batch_prefill","title":"Get prefill batch <code>get_new_batch_prefill</code>","text":"<ul> <li> <p>Create <code>PrefillAdder</code>, chunk new requests, then process multiple chunks at a time.</p> </li> <li> <p><code>init_next_round_input()</code>:</p> <ul> <li>Construct full sequence: original input tokens + generated output tokens.</li> <li>Max prefix length calculation: Cache up to the second to last token (<code>input_len - 1</code>). <p>The model needs an input token to query these cached historical information and calculate the logits (probability distribution) for the current step. If we count all tokens as prefix tokens and read them from cache, then there is no \"input token\" fed to the model for the current step, and the model cannot calculate the logits for \\(t+1\\). Therefore, we must keep the last token out of prefix matching and let it be the <code>input_ids</code> to the model for this inference.</p> </li> <li>Prefix matching:</li> <li>When Request <code>ABC</code> arrives, assume there is a node <code>AFG</code> in the current radix cache.</li> <li><code>match_prefix</code> will try to find the longest prefix of existing <code>ABC</code> in the current radix cache, meaning it will find <code>A</code> in the <code>AFG</code> node.</li> <li>Radix cache will split this node <code>AFG</code> into <code>A</code> and <code>FG</code>, with node <code>A</code> becoming the last node of the current Request.</li> </ul> </li> <li> <p>Create a new <code>ScheduleBatch</code>.</p> </li> <li> <p>Call <code>ScheduleBatch::prepare_for_extend()</code></p> </li> <li> <p>Allocate <code>req_pool_indices</code> to assign a unique index position in the request pool for each request. This index is used to store the request's token-to-KV mapping in <code>req_to_token_pool</code>.</p> <ul> <li>allocate kv cache: [Total input tokens per Request - matched prefix tokens] <code>out_cache_loc</code>.</li> <li>Write mapping of req to kv cache into <code>req_to_token_pool</code>.</li> </ul> Python<pre><code>req_to_token_pool[req_idx]:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Prefix Part (1984 tokens)    \u2502    New Chunk Part (2000 tokens)    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 [loc_1, loc_2, ..., loc_1984] \u2502 [loc_1985, ..., loc_3984] \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nPosition:  0                    1984                         3984\n\nKV Cache Pool:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502loc_1 \u2502loc_2 \u2502 ... \u2502loc_1984\u2502loc_1985\u2502 ... \u2502loc_3984\u2502 ... \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 k1,v1\u2502 k2,v2\u2502 ... \u2502k1984,v1984\u2502k1985,v1985\u2502 ... \u2502k3984,v3984\u2502 ... \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#get-decode-batch","title":"Get decode batch","text":"<ul> <li> <p>First remove completed or errored batches from the batch, then merge the previous round's decode batch with <code>running_batch</code>.</p> </li> <li> <p>Essentially concatenating <code>seq_lens</code>, <code>orig_seq_lens</code>, <code>output_ids</code>, etc. using <code>torch.cat</code>.</p> </li> <li> <p>Call <code>update_running_batch()</code> to get decode batch.</p> </li> <li> <p>First check if requests need to be retracted.</p> </li> <li> <p>If so, re-insert requests to be retracted into <code>waiting_queue</code> and re-queue for scheduling.</p> </li> <li> <p>Call <code>ScheduleBatch::prepare_for_decode()</code></p> <ul> <li>Previous round output as this round's input.</li> <li>Memory allocation + sequence length update.</li> </ul> Python<pre><code># Assume batch has 3 requests, current lengths are [10, 15, 8]\n# Decode needs to allocate space for the next position of each request\n\n# KV cache mapping before allocation\nreq_to_token_pool[req1_idx, 0:10] = [loc1, loc2, ..., loc10]\nreq_to_token_pool[req2_idx, 0:15] = [loc11, loc12, ..., loc25]\nreq_to_token_pool[req3_idx, 0:8] = [loc26, loc27, ..., loc33]\n\n# After executing alloc_for_decode\nreq_to_token_pool[req1_idx, 10] = loc34    # Allocate for position 10\nreq_to_token_pool[req2_idx, 15] = loc35    # Allocate for position 15\nreq_to_token_pool[req3_idx, 8] = loc36     # Allocate for position 8\n\n# out_cache_loc = [loc34, loc35, loc36]\n\n# A faster in-place version\nself.seq_lens.add_(1)\nself.seq_lens_cpu.add_(1)\nself.orig_seq_lens.add_(1)\n# update all length\nself.seq_lens_sum += bs \u00a0# bs = batch_size\n</code></pre> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#compute-batch-sample","title":"Compute Batch &amp; Sample","text":"<p>Here we temporarily only consider the generation case (there is also the Embedding case).</p> <ul> <li>Convert <code>ScheduleBatch</code> to <code>ModelWorkerBatch</code>.</li> <li>Call <code>TpModelWorker::forward_batch_generation()</code></li> <li>Convert <code>ModelWorkerBatch</code> to <code>ForwardBatch</code>.</li> <li>Call <code>ModelRunner::forward()</code>, finally calling backend flashinfer operators.<ul> <li>Prefill executes <code>ModelRunner::forward_extend()</code>.</li> <li>Decode executes <code>ModelRunner::forward_decode()</code>.</li> </ul> </li> <li>Immediately perform Sample to get the next token based on logits.</li> <li>Return result <code>GenerationBatchResult</code>.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#post-schedule_1","title":"Post Schedule","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#prefill","title":"Prefill","text":"<ul> <li>Unpack <code>GenerationBatchResult</code>.</li> <li>Execute <code>synchronize()</code> to wait for GPU\u2192CPU copy completion, ensuring subsequent data access is available on CPU.</li> <li>Iterate through each request in the batch.</li> <li>Update generation results.</li> <li>Update logprob.</li> <li>Special handling for Chunked requests: <code>is_chunked &gt; 0</code> indicates prefill is not yet fully complete, need to decrement counter and skip streaming output.</li> <li>Output streaming results: Call <code>stream_output()</code> to send results (token, logprob, etc.) to the client (e.g., WebSocket / API response).</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#decode","title":"Decode","text":"Python<pre><code>[GPU forward kernel]\n   \u2193 (Result written to GenerationBatchResult)\n[Scheduler.process_batch_result_decode()]\n   \u251c\u2500\u2500 copy_done.synchronize()\n   \u251c\u2500\u2500 next_token_ids.tolist()\n   \u251c\u2500\u2500 Update req status\n       \u251c\u2500\u2500 req.output_ids.append(next_token_id)\n       \u251c\u2500\u2500 if finished, self.tree_cache.cache_finished_req(req) # Release kv cache\n   \u251c\u2500\u2500 stream_output()\n   \u2514\u2500\u2500 free KV pages\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#why-overlap","title":"Why Overlap?","text":"<p>Running the actual scheduling algorithm accounts for only a small fraction of the total scheduling overhead. Most of the overhead comes from model input preparation and model output post-processing. Specifically, the largest overheads come from constructing input tensors (Pre Schedule), executing output detokenization (Post Schedule), and preparing metadata for each request (Pre Schedule)[^overhead].</p> <p>Overhead in constructing model input tensors and sampling metadata mainly stems from Python.</p> <p>Using multi-step scheduling can reduce total scheduling overhead, but it also has drawbacks. For example, between two scheduling calls, even if some requests finish early, new requests cannot be added to the batch.</p> <ul> <li>vLLM's multi-step decode</li> <li>SGLang's speculative group execution</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#zero-overhead-scheduling-overlap","title":"Zero-Overhead Scheduling (Overlap)","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#principle","title":"Principle","text":"<p>Before introducing the principle, we need to recall the four major steps of the inference process above and consider which steps can be overlapped to reduce GPU bubbles (idle periods). Here is a diagram of the current overlap pipeline.</p> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#inference-overview","title":"Inference Overview","text":"<p>SGLang's inference process is mainly divided into the following four stages:</p> <ol> <li>Pre schedule:    - Collect requests from TokenizerManager and put them into waiting queue. (<code>Scheduler::recv_request()</code> &amp; <code>Scheduler::process_input_requests()</code>)    - Schedule from waiting queue and <code>running_batch</code>. (<code>Scheduler::get_batch_to_run()</code>)<ul> <li>Prefill involves Radix Tree and Longest Prefix Matching algorithm. (<code>Req::init_next_round_input()</code>)</li> <li>Allocate memory resources required for Tokens for each request. (<code>ScheduleBatch::prepare_for_extend()</code> &amp; <code>ScheduleBatch::prepare_for_decode()</code>)</li> </ul> </li> <li>Compute batch:    - Send batch to GPU for one step (i.e., one iter of Continue Batch) inference. (<code>Scheduler::run_batch()</code>)</li> <li>Sample:    - Sample based on Logit output from model to generate next Token. (<code>ModelRunner::sample()</code>)</li> <li>Post schedule:    - After one inference step, dynamically check if requests meet finish condition (Check Finish Condition). (<code>Scheduler::process_batch_result()</code>)</li> </ol> <ul> <li>Remove completed requests from the batch, send them to the detokenizer, then return results to the DetokenizerManager, and finally forward them to the TokenizerManager.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#overlap-overviewoverlap","title":"Overlap Overview[^overlap]","text":"<p>The <code>Compute batch</code> and <code>Sample</code> stages, which are adjacent, are GPU-heavy, while the two schedule stages are CPU-heavy. When multiple batches are pipelined, we can use GPU Compute and Sample to overlap the post scheduler of the previous batch with the pre scheduler of the current batch.</p> <p>Actually, our Prefill request entry does not depend on unfinished batches; the first request can execute normally.</p> <p>We implement overlap by using Forward CUDA Stream, specifically:</p> <ul> <li>In <code>Run Batch</code>, two operations are submitted to the <code>forward_stream</code> stream: one retrieves the next token of the previous batch from <code>FutureMap</code>; the other uses this token as <code>input_id</code> for the next calculation.</li> <li>In <code>Sample</code>, two operations are also submitted to the <code>forward_stream</code> stream: one performs sampling; the other writes the obtained next token back to FutureMap.</li> <li>We need to synchronize CPU and GPU before processing data in <code>Post Schedule</code> to ensure <code>next_token_ids</code> on CPU can be processed.</li> <li>We perform synchronization in Post Schedule, ensuring subsequent processing runs normally without affecting GPU pipeline work. Python<pre><code>def process_batch_result_decode(\n\u00a0 \u00a0 \u00a0 \u00a0 self: Scheduler,\n\u00a0 \u00a0 \u00a0 \u00a0 batch: ScheduleBatch,\n\u00a0 \u00a0 \u00a0 \u00a0 result: GenerationBatchResult,\n\u00a0 \u00a0 ):\n\u00a0 \u00a0 \u00a0 \u00a0 if result.copy_done is not None:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.copy_done.synchronize()\n\u00a0 \u00a0 \u00a0 \u00a0 logits_output, next_token_ids, can_run_cuda_graph = (\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.logits_output,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.next_token_ids,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.can_run_cuda_graph,\n\u00a0 \u00a0 \u00a0 \u00a0 )\n  next_token_ids = next_token_ids.tolist()\n  next_token_logprobs = logits_output.next_token_logprobs.tolist()\n</code></pre></li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#init-overlap","title":"Init Overlap","text":"<ul> <li>forward_stream: Dedicated to GPU forward computation, parallel to default stream.</li> <li>copy_stream: Handles GPU-&gt;CPU data transfer.</li> <li>future_map: Manages asynchronous calculation results, using negative indices as future identifiers.</li> <li><code>output_id</code> calculated by previous batch serves as <code>input_id</code> for next batch, implemented by accessing <code>future_map</code>.</li> <li>batch_record_buf: Batch buffer (prevents GPU tensors from being GC'd).</li> </ul> Python<pre><code>def init_overlap(self):\n    if not self.enable_overlap:\n        return\n    self.forward_stream = torch.cuda.Stream()  # GPU forward computation stream\n    # Future map manages asynchronous results\n    self.future_map = FutureMap(max_running_requests, device, spec_algorithm)\n    # batch buffer (prevents GPU tensors from being GC'd)\n    self.batch_record_buf = [None] * 2\n    self.batch_record_ct = 0\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#futuremap","title":"FutureMap","text":"<p>Stored on GPU.</p> <ul> <li> <p><code>future_ct</code>: Current ring counter (pointer), used to generate new future indices (not \"number of unfinished\").</p> </li> <li> <p><code>future_limit</code>: Modulo for ring pointer (used for <code>% self.future_limit</code>). The code uses a factor of <code>*3</code> to reduce index collision probability (preventing <code>future_ct</code> from wrapping around quickly and overwriting slots not yet written back).</p> </li> <li> <p><code>future_buffer_len</code>: Actual physical buffer length (<code>*5</code>), longer than <code>future_limit</code> to ensure enough space in write interval (preventing slice out-of-bounds or wrap-around write/read conflicts).</p> </li> <li> <p>These two factors (3 and 5) are engineering empirical values used to increase safety margin; you can adjust based on concurrency and outstanding futures.</p> </li> </ul> Python<pre><code>class FutureMap:\n    def __init__(\n        self,\n        max_running_requests: int,\n    ):\n        self.future_ct = 0\n        # A factor of 3 is used to avoid collision in the circular buffer.\n        self.future_limit = max_running_requests * 3\n        # A factor of 5 is used to ensure the buffer is large enough.\n        self.future_buffer_len = max_running_requests * 5\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#overlap-event-loop","title":"Overlap Event Loop","text":"Python<pre><code>def event_loop_overlap(self):\n    self.result_queue = deque()  # Store (batch, result) pairs\n    while True:\n        # === Pre Schedule 2 ===\n        recv_reqs = self.recv_requests()\n        self.process_input_requests(recv_reqs)\n        batch = self.get_next_batch_to_run()\n        self.cur_batch = batch\n\n        batch_result = None\n        if batch:\n            # === Launch Compute Batch 2 ===\n            batch_result = self.run_batch(batch)  # Non-blocking launch\n            self.result_queue.append((batch.copy(), batch_result))\n\n        # === Post Schedule 1 ===\n        # compute batch 2 executes in parallel with post schedule 1\n        if self.last_batch:\n            # Process results in queue (GPU is computing current batch in parallel at this time)\n            tmp_batch, tmp_result = self.result_queue.popleft()\n            self.process_batch_result(tmp_batch, tmp_result)\n        elif batch is None:\n            self.self_check_during_idle()\n\n        # === Launch Sample 2 ===\n        self.launch_batch_sample_if_needed(batch_result)  # update vocab mask\n        self.last_batch = batch\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#differences-from-normal-event-loop","title":"Differences from normal event loop","text":"<ul> <li><code>Schedule::run_batch()</code></li> <li><code>Schedule::record_batch_in_overlap()</code>: Alternately stores <code>model_worker_batch</code> references in two overlapping batches, avoiding CUDA kernel accessing dangling pointers or freed memory when overlap forward is not yet finished.</li> <li><code>FutureMap::resolve_future()</code>: Replaces negative index placeholders with real tokens obtained from previous batch sample.</li> <li><code>TpModelWorker::forward_batch_generation()</code>, this function merely delays execution of <code>model_runner.sample</code> function, returning <code>batch_result</code> first.</li> <li>Added <code>Scheduler::launch_batch_sample_if_needed()</code>:</li> <li>Execute real Sample operation.<ul> <li>Mask illegal tokens, allocate <code>vocab_mask</code> tensor size <code>[batch, vocab_size]</code>.</li> <li>Move mask to CPU.</li> </ul> </li> <li>Store obtained <code>next_token_id</code> to corresponding position in <code>FutureMap</code>'s <code>future_indices</code>.<ul> <li>For next batch to get real token in <code>resolve_future</code> during <code>run_batch</code>.</li> </ul> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#stream-synchronization","title":"Stream Synchronization","text":"<ul> <li>In decode mode, <code>batch.output_ids</code> of previous batch is <code>batch.input_ids</code> of next batch.</li> <li>First: After last batch's <code>output_id</code> stored in FutureMap.</li> <li>Second: current batch gets <code>output_id</code> from FutureMap and uses it as <code>input_id</code> for next batch calculation.</li> <li>Limitation of CUDA Stream itself.</li> <li>Implemented on CPU side using negative placeholders, waiting for GPU to fill real tokens.</li> </ul> Python<pre><code># previous batch output is negative indices\nbatch.output_ids = -self.future_map.alloc_future_indices(bs).indices\nwith self.forward_stream_ctx:\n    self.forward_stream.wait_stream(self.default_stream)\n    _batch_result = batch_result.delay_sample_func()\n    assert _batch_result is batch_result\n    # store token to negative indices\n    self.future_map.store_to_map(batch_result.future_indices, batch_result)\n    batch_result.copy_to_cpu()\n\n# next batch input is output of previous batch\n\u00a0with self.forward_stream_ctx:\n    self.forward_stream.wait_stream(self.default_stream)\n    # get token from negative indices\n    self.future_map._resolve_future_token_ids(model_worker_batch.input_ids, self.token_ids_buf)\n    batch_result = self.model_worker.forward_batch_generation(\n        model_worker_batch\n    )\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#differences-from-previous-overlap-version","title":"Differences from previous overlap version","text":"<ul> <li>Moved <code>update_vocab_mask</code> to GPU for calculation, <code>vocab_mask</code> is also allocated directly on GPU, no longer transferred.</li> <li>Current GPU is additionally responsible for storing (after sample) and retrieving (before compute) <code>next_token_ids</code> to/from <code>FutureMap</code>.</li> <li><code>FutureMap</code> is also completely stored on GPU.</li> <li>GPU scheduling changed from CPU launch to directly submitting operations to the CUDA stream, scheduled by the stream itself.</li> <li>For sample synchronization, the previous version used a CUDA event; here we directly use CUDA stream ordering constraints for synchronization.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#pros-and-cons-of-the-two-versions","title":"Pros and Cons of the Two Versions","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#cuda-stream-version","title":"CUDA stream version","text":"<ul> <li>Higher execution efficiency: No CPU-GPU transfer for <code>vocab_mask</code> and <code>token_ids_buf</code>; fully utilizes GPU memory bandwidth.</li> <li>Lower latency: <code>token_ids_buf</code> modified in-place directly on GPU, no need for repeated transfer.</li> <li>On same device as model inference, facilitating pipelining.</li> <li>Large non-model VRAM usage: <code>token_ids_buf</code> occupies GPU VRAM, fixed overhead.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#cpu-launch-version","title":"CPU launch version","text":"<ul> <li>Occupies GPU memory only when in use.</li> <li>Increased synchronization points: <code>vocab_mask</code> adds one CPU-GPU synchronization.</li> <li>CPU-GPU synchronization breaks pipeline.</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20Evolution/#reference","title":"Reference","text":"<p>[^overlap]: Zero-Overhead Batch Scheduler [^overhead]: Can Scheduling Overhead Dominate LLM Inference Performance? A Study of CPU Scheduling Overhead on Two Popular LLM Inference Systems [^code-walk]: SGLang Code Walk Through</p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/","title":"SGLang Scheduler \u6280\u672f\u53d8\u8fc1","text":"2025-10-282025-12-13 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#sglang-scheduler","title":"SGLang Scheduler \u6280\u672f\u53d8\u8fc1","text":"<p> \u7ea6 4692 \u4e2a\u5b57  282 \u884c\u4ee3\u7801  10 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 27 \u5206\u949f</p> <ul> <li>\u6700\u5f00\u59cb\u7684 Scheduler \u4e2d CPU \u548c GPU \u662f\u4e32\u884c\u7684\uff0c\u5bfc\u81f4 GPU \u7684\u5927\u91cf\u7a7a\u95f2</li> <li>\u540e\u9762\u7684 Scheduler \u5141\u8bb8 CPU \u548c GPU overlap\uff0c\u5b9e\u73b0\u4e86 zero overhead scheduler</li> </ul> <p>Scheduler \u6574\u4f53\u7684\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a[^code-walk]</p> <p></p> <p>\u6211\u4eec\u5c06\u7ed3\u5408\u4ee3\u7801\u5206\u6790\u4e00\u4e0b\u6574\u4e2a Scheduler \u7684\u6d41\u7a0b\u3002\u4f46\u5728\u5206\u6790\u6574\u4e2a\u6d41\u7a0b\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u4e86\u89e3\u4e00\u4e0b\u8c03\u5ea6\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684\u6570\u636e\u7ed3\u6784\u4ee5\u53ca\u8fd9\u4e9b\u7ed3\u6784\u4e4b\u95f4\u7684\u5173\u7cfb\u5982\u4f55\u8f6c\u6362</p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#key-structure","title":"Key Structure","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#scheduler","title":"Scheduler","text":"<p><code>Scheduler</code>\u00a0 \u7ec4\u4ef6\u8d1f\u8d23\u7ba1\u7406 Active Request\u3002\u4ee5\u4e0b\u6838\u5fc3\u5168\u5c40\u72b6\u6001\u7528\u4e8e\u5728 \u00a0<code>Scheduler</code>\u00a0 \u4e2d\u7ef4\u62a4\u8fd9\u4e9b Active Request\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#waiting_queue","title":"<code>waiting_queue</code>","text":"<ul> <li>\u7528\u9014\uff1a <code>waiting_queue</code>\u662f\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\uff0c\u8bbe\u8ba1\u7528\u4e8e\u5b58\u653e Active Request\u3002\u5b83\u6839\u636e\u4f18\u5148\u7ea7\uff08Request \u7684\u6700\u957f\u524d\u7f00\uff09\u6216\u53ef\u7528\u5185\u5b58\u52a8\u6001\u91cd\u65b0\u6392\u5e8f\u8fd9\u4e9b Request\uff0c\u4ee5\u4f18\u5316\u6279\u5904\u7406\u4efb\u52a1\u3002</li> <li>\u4e00\u4e9b\u989d\u5916\u8981\u70b9</li> <li>\u5165\u961f<ul> <li>\u65b0\u5230\u8fbe\u7684 Request\u3002</li> <li>\u4ece \u00a0<code>retract_decode</code>\u00a0 \u8fd4\u56de\u7684 Request\u3002</li> </ul> </li> <li>\u51fa\u961f\u00a0 \u5f53\u524d\u6709\u6700\u9ad8\u4f18\u5148\u7ea7\u7684 Request \u4ece\u961f\u5217\u4e2d\u51fa\u961f\u4ee5\u5f62\u6210 batch\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#new_batch","title":"<code>new_batch</code>","text":"<ul> <li>\u7528\u9014\uff1a\uff1a\u4e00\u6279\u51c6\u5907\u597d\u8fdb\u884c prefill/extend \u9636\u6bb5\u7684 Request\u3002</li> <li>\u4e00\u4e9b\u989d\u5916\u8981\u70b9</li> <li>\u5206\u5757\u9884\u586b\u5145\uff1a\u5982\u679c Request \u6240\u9700\u7684 token \u6570\u8d85\u8fc7\u53ef\u7528\u5185\u5b58\uff08<code>remaining_tokens</code>\uff09\uff0c\u53ef\u80fd\u4f1a\u88ab\u5206\u5757\u6210\u8f83\u5c0f\u7684\u90e8\u5206\u3002</li> <li><code>new_batch</code>\u00a0 \u4e2d\u7684 Request \u5c06\u7ecf\u5386 prefill/extend\u3002</li> <li>prefill/extend \u540e\uff0c<code>new_batch</code>\u00a0 \u5c06\u8fc7\u6e21\u5230 \u00a0\u5168\u5c40\u6279\u6b21\uff08Global Batch\uff09\uff0c\u7528\u4e8e\u4e0b\u4e00\u6b21\u8fed\u4ee3\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#running_batch","title":"<code>running_batch</code>","text":"<ul> <li>\u7528\u9014\uff1a\uff1a\u4e00\u6279\u51c6\u5907\u597d\u8fdb\u884c decode \u9636\u6bb5\u7684 Request\u3002</li> <li>\u521d\u59cb\u5316\u4e3a\u7a7a\u6279\u6b21\uff1a<code>ScheduleBatch(reqs=[], batch_is_full=False)</code></li> <li>\u53ef\u4ee5\u52a8\u6001\u6dfb\u52a0\u65b0\u5b8c\u6210 prefill \u7684\u8bf7\u6c42</li> <li>\u53ef\u4ee5\u79fb\u9664\u5df2\u5b8c\u6210\u7684\u8bf7\u6c42</li> <li>\u4e00\u4e9b\u989d\u5916\u8981\u70b9</li> <li>Retracted\uff1a\u5982\u679c decode \u671f\u95f4\u53ef\u7528\u5185\u5b58\u4e0d\u8db3\uff0c<code>Scheduler</code>\u53ef\u80fd\u4f1a\u901a\u8fc7 \u00a0<code>retract_decode</code>\u00a0 \u4ece \u00a0<code>running_batch</code>\u00a0 \u4e2d\u64a4\u56de\u67d0\u4e9b Request\uff0c\u5c06\u5176\u8fd4\u56de\u5230 \u00a0<code>waiting_queue</code>\u00a0 \u4ee5\u4f9b\u540e\u7eed\u5904\u7406\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#cur_batch","title":"<code>cur_batch</code>","text":"<ul> <li>\u7528\u9014\uff1a\uff1a<code>Scheduler</code>\u00a0 \u4e3b\u5faa\u73af\uff08<code>run_batch</code>\u00a0 \u51fd\u6570\uff09\u4e2d\u5f53\u524d\u6b63\u5728\u5904\u7406\u7684 Request \u6279\u6b21\u3002<code>prefill</code> \u4f18\u5148</li> <li>\u4e00\u4e9b\u989d\u5916\u8981\u70b9</li> <li><code>cur_batch</code>\u00a0 \u5728 \u00a0<code>event_loop_normal</code>\u00a0 \u4e2d\u5206\u914d\u3002</li> <li>\u5f62\u6210 \u00a0<code>cur_batch</code>\u00a0 \u7684\u903b\u8f91\u662f\uff1a<ul> <li>\u5982\u679c\u672c\u8f6e\u6709\u51c6\u5907\u597d prefill \u7684 Request\uff08<code>new_batch</code>\uff09\uff0c\u5219\u4f7f\u7528 \u00a0<code>new_batch</code>\u00a0 \u4f5c\u4e3a \u00a0<code>cur_batch</code>\u3002</li> <li>\u5426\u5219\uff0c<code>cur_batch</code>\u00a0 \u5c06\u5904\u7406\u51c6\u5907\u597d decode \u7684 Request\uff0c\u56e0\u6b64\u4f7f\u7528 \u00a0<code>running_batch</code>\u00a0 \u4f5c\u4e3a \u00a0<code>cur_batch</code>\u3002</li> </ul> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#batch","title":"\u4e09\u4e2a\u91cd\u8981\u7684 Batch","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overview","title":"Overview","text":"<ul> <li>ScheduleBatch \u7531 schedule.py::Scheduler \u7ba1\u7406\u3002\u5b83\u5305\u542b\u9ad8\u7ea7\u8c03\u5ea6\u6570\u636e\uff0c\u5927\u90e8\u5206\u6570\u636e\u4f4d\u4e8e CPU \u4e0a\u3002</li> <li>ModelWorkerBatch \u7531 tp_worker.py::TpModelWorker \u7ba1\u7406\u3002\u5b83\u662f ScheduleBatch \u7684\u5b50\u96c6\uff0c\u53ea\u5305\u542b\u4e0e GPU \u4e0a\u6a21\u578b forward \u76f8\u5173\u7684\u6570\u636e\uff0c\u5b83\u5c06\u4ece CPU scheduler \u8f6c\u6362\u5230 GPU model runner\u3002</li> <li>ForwardBatch \u7531 model_runner.py::ModelRunner \u7ba1\u7406\uff0c\u5b83\u5305\u542b\u4f4e\u7ea7 tensor \u6570\u636e</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#schedulebatch","title":"ScheduleBatch","text":"Python<pre><code>class ScheduleBatch:\n    reqs: List[Req]  # \u8bf7\u6c42\u5217\u8868\n    req_to_token_pool: ReqToTokenPool  # \u8bf7\u6c42\u5230token\u7684\u6620\u5c04\u6c60\n    token_to_kv_pool_allocator: BaseTokenToKVPoolAllocator  # KV\u7f13\u5b58\u5206\u914d\u5668\n    tree_cache: BasePrefixCache  # \u524d\u7f00\u7f13\u5b58\u6811\n    forward_mode: ForwardMode  # \u524d\u5411\u6a21\u5f0f\n\n    # \u6279\u5904\u7406\u76f8\u5173\n    input_ids: torch.Tensor  # \u8f93\u5165token IDs\n    seq_lens: torch.Tensor  # \u5e8f\u5217\u957f\u5ea6\n    extend_lens: List[int]  # \u6269\u5c55\u957f\u5ea6(seq_len - prefix_len)\n    prefix_lens: List[int]  # \u524d\u7f00\u957f\u5ea6\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#modelworkerbatch","title":"ModelWorkerBatch","text":"Python<pre><code>class ModelWorkerBatch:\n    forward_mode: ForwardMode\n    input_ids: torch.Tensor  # \u8f93\u5165token IDs\n    req_pool_indices: torch.Tensor  # req \u5bf9\u5e94\u7684 out_cache_loc \u7684\u7d22\u5f15\n    seq_lens: torch.Tensor  # \u5e8f\u5217\u957f\u5ea6\n    out_cache_loc: torch.Tensor  # \u5206\u914d\u7684 KV cache\n\n    # \u6269\u5c55\u76f8\u5173(seq - prefix)\n    extend_num_tokens: Optional[int]\n    extend_seq_lens: Optional[List[int]]\n    extend_prefix_lens: Optional[List[int]]\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#forwardbatch","title":"ForwardBatch","text":"Python<pre><code>class ForwardBatch:\n    forward_mode: ForwardMode\n    batch_size: int\n    input_ids: torch.Tensor\n    seq_lens: torch.Tensor\n    positions: torch.Tensor  # \u4f4d\u7f6e\u7f16\u7801\n\n    # \u6ce8\u610f\u529b\u76f8\u5173\n    attn_backend: AttentionBackend\n    token_to_kv_pool: KVCache\n\n    # \u6269\u5c55\u4fe1\u606f(seq - prefix)\n    extend_num_tokens: Optional[int]\n    extend_start_loc: Optional[torch.Tensor]\n    extend_prefix_lens: Optional[torch.Tensor]\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#batch-transformation","title":"Batch Transformation","text":"Python<pre><code># 1. Scheduler\u521b\u5efaScheduleBatch\ndef run_batch(self, batch: ScheduleBatch):\n    # 2. \u8f6c\u6362\u4e3aModelWorkerBatch\n    model_worker_batch = batch.get_model_worker_batch()\n\n\n# 3. TpModelWorker\u5904\u7406\ndef forward_batch_generation(self, model_worker_batch: ModelWorkerBatch):\n    # 4. \u8f6c\u6362\u4e3aForwardBatch\n    forward_batch = ForwardBatch.init_new(model_worker_batch, self.model_runner)\n\n    # 5. ModelRunner\u6267\u884c\u524d\u5411\u4f20\u64ad\n    logits_output, can_run_cuda_graph = self.model_runner.forward(forward_batch)\n\n    # 6. \u91c7\u6837\u751f\u6210token\n    next_token_ids = self.model_runner.sample(logits_output, forward_batch)\n\n    return GenerationBatchResult(\n        logits_output=logits_output,\n        next_token_ids=next_token_ids,\n        can_run_cuda_graph=can_run_cuda_graph,\n    )\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#cache","title":"Cache","text":"<p>cache \u5728 sglang \u4e2d\uff0c\u76f8\u5173\u7684\u4e3b\u8981\u662f``req_to_token_pool<code>,</code>token_to_kv_pool<code>,</code>tree_cache` \u4e09\u4e2a\u7ed3\u6784\u3002</p> Python<pre><code>req_to_token_pool[req_idx]:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u524d\u7f00\u90e8\u5206 (1984 tokens)    \u2502    \u65b0chunk\u90e8\u5206 (2000 tokens)    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 [loc_1, loc_2, ..., loc_1984] \u2502 [loc_1985, ..., loc_3984] \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u4f4d\u7f6e:  0                    1984                         3984\n\nKV Cache Pool:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502loc_1 \u2502loc_2 \u2502 ... \u2502loc_1984\u2502loc_1985\u2502 ... \u2502loc_3984\u2502 ... \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 k1,v1\u2502 k2,v2\u2502 ... \u2502k1984,v1984\u2502k1985,v1985\u2502 ... \u2502k3984,v3984\u2502 ... \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#reqtotokenpool","title":"ReqToTokenPool","text":"<ul> <li>\u7ba1\u7406 req_idx \u5230 token \u4f4d\u7f6e\u7684\u6620\u5c04\u5173\u7cfb</li> <li>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5206\u914d\u56fa\u5b9a\u7684\u5185\u5b58\u69fd\u4f4d</li> <li>\u7ef4\u62a4\u8bf7\u6c42\u7684 token \u5e8f\u5217\u5728\u5185\u5b58\u4e2d\u7684\u8fde\u7eed\u5e03\u5c40</li> </ul> Python<pre><code>class ReqToTokenPool:\n    def __init__(\n        self, size: int, max_context_len: int, device: str, enable_memory_saver: bool\n    ):\n        # \u4e3b\u8981\u5b58\u50a8\u7ed3\u6784\uff1a[\u8bf7\u6c42\u6570\u91cf, \u6700\u5927\u4e0a\u4e0b\u6587\u957f\u5ea6]\n        self.req_to_token = torch.zeros(\n            (size, max_context_len), dtype=torch.int32, device=device\n        )\n        self.free_slots = list(range(size))  # \u53ef\u7528\u69fd\u4f4d\u5217\u8868\n        self.size = size\n        self.max_context_len = max_context_len\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#token_to_kv_pool","title":"token_to_kv_pool","text":"<ul> <li>\u7ba1\u7406\u7269\u7406 KV \u7f13\u5b58\u7684\u5206\u914d\u548c\u91ca\u653e</li> <li>\u5904\u7406\u9875\u5bf9\u9f50\u7684\u5185\u5b58\u5206\u914d\uff08\u5982\u679c\u542f\u7528\u5206\u9875\uff09</li> <li>\u652f\u6301\u4e0d\u540c\u7684\u5206\u914d\u7b56\u7565\uff08\u8fde\u7eed\u5206\u914d\u3001\u5206\u9875\u5206\u914d\u7b49\uff09</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#tree-cache","title":"Tree Cache","text":"<p>\u5176\u5b9e\u662f\u8054\u7cfb\u4e24\u4e2a pool \u7684\u7ec4\u7ec7\u7ed3\u6784\uff0cscheduler \u8c03\u5ea6\u8fc7\u7a0b\u4e2d\u4f1a\u9891\u7e41\u8bbf\u95ee\uff0c\u5e76\u4e3a\u8bf7\u6c42\u5206\u914d <code>req_to_token_pool</code> \u548c <code>token_to_kv_pool</code> \u4e2d\u7684 slot</p> <ul> <li> <p>tree_cache \u5728\u8c03\u5ea6\u7b56\u7565\u4e2d\u662f\u4e2a\u5173\u952e\u89d2\u8272\uff0c\u6839\u636e prefix match \u7684\u60c5\u51b5\uff0c\u4f1a\u51b3\u5b9a\u5f53\u524d\u8bf7\u6c42\u4f55\u65f6\u88ab prefill</p> </li> <li> <p><code>page_size</code> \u51b3\u5b9a\u524d\u7f00\u5339\u914d\u7684\u7c92\u5ea6\uff0c\u952e\u5339\u914d\u7b56\u7565\u4ee5\u53ca\u5206\u9875\u5339\u914d\u7b97\u6cd5</p> </li> <li> <p>page_size = 1 \u662f\u9010 token \u7cbe\u786e\u5339\u914d\uff0c\u53ef\u4ee5\u5339\u914d\u4efb\u610f\u957f\u5ea6\u7684\u524d\u7f00</p> </li> <li>page_size &gt; 1 \u662f\u6309\u9875\u8fdb\u884c\u524d\u7f00\u5339\u914d(\u4f7f\u7528 tuple(tokens) \u4e3a key Python<pre><code># page_size = 1\nroot\n\u2514\u2500\u2500 1 (child_key=1)\n    \u2514\u2500\u2500 2 (child_key=2)\n        \u2514\u2500\u2500 3 (child_key=3)\n            \u2514\u2500\u2500 4 (child_key=4)\n                \u2514\u2500\u2500 5 (child_key=5)\n</code></pre></li> </ul> <p># page_size = 4</p> <p>root   \u2514\u2500\u2500 (1,2,3,4) (child_key=(1,2,3,4))   \u2514\u2500\u2500 (5,6,7,8) (child_key=(5,6,7,8))</p> Text Only<pre><code>\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#relationship","title":"RelationShip","text":"<p>\u4e00\u4e2a\u65b0\u8bf7\u6c42\u8fdb\u5165</p> <ul> <li>\u9996\u5148\u8fdb\u884c\u6700\u957f\u524d\u7f00\u5339\u914d\u627e\u5230\u5bf9\u5e94\u7684 KV \u7d22\u5f15</li> <li><code>req_to_token_pool</code> \u5206\u914d <code>extend_token</code> \u7684\u7a7a\u95f2\u69fd\u4f4d\uff0c\u5f97\u5230 <code>req_pool_idx</code> \u7d22\u5f15</li> <li><code>token_to_kv_pool_allocator</code> \u5206\u914d\u65b0\u7684 KV Cache</li> <li>\u66f4\u65b0 <code>req_pool_idx</code> \u4e0e KV Cache \u95f4\u7684\u6620\u5c04\u5173\u7cfb</li> </ul> Python<pre><code># \u76f4\u63a5\u5206\u914d\u8fd9\u4e00\u4e2a batch \u6240\u6709 req \u7684 extend tokens \u9700\u8981\u7684 kv cache\nout_cache_loc = alloc_token_slots(batch.tree_cache, batch.extend_num_tokens)\n# update \u6620\u5c04(prefix + extend)\nreq_to_token_pool.write(\n    (req_idx, slice(0, prefix_len)),\n    prefix_tensors[i],\n)\nreq_to_token_pool.write(\n    (req_idx, slice(prefix_len, seq_len)),\n    out_cache_loc[pt : pt + extend_len],\n)\n</code></pre> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#prefilladder","title":"PrefillAdder","text":"<p>\u662f SGLang Scheduler \u4e2d\u8d1f\u8d23\u667a\u80fd\u6279\u5904\u7406\u9884\u586b\u5145\u548c\u89e3\u7801\u8bf7\u6c42\u7684\u6838\u5fc3\u7ec4\u4ef6\u3002\u5b83\u7684\u4e3b\u8981\u4f5c\u7528\u662f\u4ece\u7b49\u5f85\u961f\u5217\u4e2d\u9009\u62e9\u5408\u9002\u7684\u8bf7\u6c42\uff0c\u7ec4\u88c5\u6210\u4e00\u4e2a\u53ef\u4ee5\u9ad8\u6548\u6267\u884c\u7684\u9884\u586b\u5145\u6279\u6b21</p> <p>\u5982\u679c\u542f\u7528\u4e86 Mixed Chunk\uff0c\u53ef\u4ee5\u5728\u4e00\u4e2a batch \u4e2d\u540c\u65f6\u5305\u542b prefill \u548c decode \u8bf7\u6c42</p> Python<pre><code>class PrefillAdder:\n    def __init__(self, ...):\n        self.page_size = page_size # memory page size\n        self.tree_cache = tree_cache  # radix kv cache\n        self.token_to_kv_pool_allocator = token_to_kv_pool_allocator # kv cache pool\n        self.running_batch = running_batch # currently running decode batch\n        self.new_token_ratio = new_token_ratio # new token generation ratio\n        self.can_run_list = []      # list of runnable requests\n        self.preempt_list = []      # list of preempted requests\n        self.new_chunked_req = None   # new chunked request\n        self.log_hit_tokens = 0     # number of cache hit tokens\n        self.log_input_tokens = 0   # input token statistics\n\n    @property\n    def rem_total_tokens(self):\n        \"\"\"Calculate total remaining available tokens\"\"\"\n\n    def add_one_req(self, req: Req, has_chunked_req: bool, truncation_align_size: Optional[int]):\n        \"\"\"Add a request to the batch\"\"\"\n\n    def add_chunked_req(self, req: Req):\n        \"\"\"Handle chunked prefill request\"\"\"\n\n    def preempt_to_schedule(self, req: Req, server_args: ServerArgs) -&gt; bool:\n        \"\"\"Preempt low-priority requests to make way for high-priority ones\"\"\"\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#generationbatchresult","title":"GenerationBatchResult","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#1-logits_output-optionallogitsprocessoroutput","title":"1. logits_output: Optional[LogitsProcessorOutput]","text":"<ul> <li>\u4f5c\u7528: \u5305\u542b\u6a21\u578b\u524d\u5411\u4f20\u64ad\u7684\u5b8c\u6574 logits \u8f93\u51fa\u548c\u76f8\u5173\u4fe1\u606f</li> <li>\u5185\u5bb9:</li> <li>next_token_logits: \u4e0b\u4e00\u4e2a token \u7684 logits \u5206\u5e03 \u00a0<code>[batch_size, vocab_size]</code></li> <li>input_token_logprobs: \u8f93\u5165 token \u7684 log \u6982\u7387</li> <li>hidden_states: \u9690\u85cf\u72b6\u6001\uff08\u7528\u4e8e\u63a8\u6d4b\u89e3\u7801\uff09</li> <li>\u5404\u79cd top-k logprobs \u548c token \u6982\u7387\u4fe1\u606f</li> <li>\u7528\u9014: \u7528\u4e8e\u91c7\u6837\u3001\u8ba1\u7b97\u6982\u7387\u3001\u8fd4\u56de logprob \u4fe1\u606f\u7ed9\u7528\u6237</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#2-next_token_ids-optionaltorchtensor","title":"2. next_token_ids: Optional[torch.Tensor]","text":"<ul> <li>\u4f5c\u7528: \u7ecf\u8fc7\u91c7\u6837\u540e\u7684\u4e0b\u4e00\u4e2a token ID</li> <li>\u5f62\u72b6:\u00a0<code>[batch_size]</code></li> <li>\u5185\u5bb9:</li> <li>Prefill \u6a21\u5f0f\uff1a\u57fa\u4e8e\u6700\u540e\u4f4d\u7f6e\u91c7\u6837\u7684\u7b2c\u4e00\u4e2a\u751f\u6210 token</li> <li>Decode \u6a21\u5f0f\uff1a\u5f53\u524d\u6b65\u9aa4\u751f\u6210\u7684\u4e0b\u4e00\u4e2a token</li> <li>Prefill-only\uff1a\u5168\u96f6\u5360\u4f4d\u7b26 tensor</li> <li>\u7528\u9014: \u76f4\u63a5\u7528\u4e8e\u66f4\u65b0\u8bf7\u6c42\u7684 <code>output_ids</code>\uff0c\u63a8\u8fdb\u751f\u6210\u8fc7\u7a0b</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#3-num_accepted_tokens-optionalint","title":"3. num_accepted_tokens: Optional[int]","text":"<ul> <li>\u4f5c\u7528: \u63a8\u6d4b\u89e3\u7801\u4e2d\u88ab\u63a5\u53d7\u7684 token \u6570\u91cf</li> <li>\u7528\u9014: \u7edf\u8ba1\u63a8\u6d4b\u89e3\u7801\u7684\u63a5\u53d7\u7387\uff0c\u7528\u4e8e\u6027\u80fd\u4f18\u5316\u548c\u6307\u6807\u6536\u96c6</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#4-next_draft_input-optionaleagledraftinput","title":"4. next_draft_input: Optional[EagleDraftInput]","text":"<ul> <li>\u4f5c\u7528: EAGLE \u63a8\u6d4b\u89e3\u7801\u7684\u4e0b\u4e00\u8f6e\u8f93\u5165\u4fe1\u606f</li> <li>\u5185\u5bb9: \u5305\u542b top-k \u6982\u7387\u3001\u7d22\u5f15\u3001\u9690\u85cf\u72b6\u6001\u7b49</li> <li>\u7528\u9014: \u4e3a\u4e0b\u4e00\u8f6e\u63a8\u6d4b\u89e3\u7801\u51c6\u5907\u8f93\u5165\u6570\u636e</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#5-extend_input_len_per_req-optionallistint","title":"5. extend_input_len_per_req: Optional[List[int]]","text":"<ul> <li>\u4f5c\u7528: \u6bcf\u4e2a\u8bf7\u6c42\u7684\u6269\u5c55\u8f93\u5165\u957f\u5ea6</li> <li>\u7528\u9014: \u5728\u5904\u7406 batch \u7ed3\u679c\u65f6\uff0c\u77e5\u9053\u6bcf\u4e2a\u8bf7\u6c42\u5b9e\u9645\u5904\u7406\u4e86\u591a\u5c11\u4e2a\u65b0 token</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#6-extend_logprob_start_len_per_req-optionallistint","title":"6. extend_logprob_start_len_per_req: Optional[List[int]]","text":"<ul> <li>\u4f5c\u7528: \u6bcf\u4e2a\u8bf7\u6c42\u5f00\u59cb\u8ba1\u7b97 logprob \u7684\u4f4d\u7f6e</li> <li>\u7528\u9014: \u786e\u5b9a\u4ece\u54ea\u4e2a\u4f4d\u7f6e\u5f00\u59cb\u8fd4\u56de logprob \u4fe1\u606f\u7ed9\u7528\u6237</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#7-copy_done-optionaltorchcudaevent","title":"7. copy_done: Optional[torch.cuda.Event]","text":"<ul> <li>\u4f5c\u7528: GPU \u5230 CPU \u6570\u636e\u4f20\u8f93\u5b8c\u6210\u7684\u540c\u6b65\u4e8b\u4ef6</li> <li>\u7528\u9014: \u5728\u91cd\u53e0\u8c03\u5ea6\u4e2d\u786e\u4fdd\u6570\u636e\u4f20\u8f93\u5b8c\u6210\u518d\u5904\u7406\u7ed3\u679c</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#8-delay_sample_func-optionalcallable","title":"8. delay_sample_func: Optional[callable]","text":"<ul> <li>\u4f5c\u7528: \u5ef6\u8fdf\u91c7\u6837\u51fd\u6570</li> <li>\u7528\u9014: \u5728\u91cd\u53e0\u8c03\u5ea6\u4e2d\uff0c\u5148\u6267\u884c\u524d\u5411\u4f20\u64ad\uff0c\u540e\u7eed\u518d\u6267\u884c\u91c7\u6837\u64cd\u4f5c</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#9-future_indices-optionalfutureindices","title":"9. future_indices: Optional[FutureIndices]","text":"<ul> <li>\u4f5c\u7528: Future \u673a\u5236\u4e2d\u7684\u7d22\u5f15\u4fe1\u606f</li> <li>\u7528\u9014: \u5728\u91cd\u53e0\u8c03\u5ea6\u4e2d\u7ba1\u7406\u5f02\u6b65\u7ed3\u679c\u7684\u5b58\u50a8\u548c\u68c0\u7d22</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#normal-no-overlap","title":"Normal (No overlap)","text":"<p>LLM \u662f\u81ea\u56de\u5f52\u7ed3\u6784\uff0c\u6240\u4ee5\u65e0\u8bba\u662f Prefill \u8fd8\u662f Decode\uff0c\u9a71\u52a8\u5b83\u4eec\u8fdb\u884c\u4e0b\u4e00\u6b65\u63a8\u7406\u7684\u90fd\u662f\u9884\u6d4b\u5e8f\u5217\u7684\u4e0b\u4e00\u4e2a token\uff0c\u5305\u542b <code>next_token_ids</code> \u7684\u6570\u636e\u5c31\u975e\u5e38\u5173\u952e</p> <p>\u5728 prefill \u6a21\u5f0f\u4e0b\uff0c<code>next_token_ids</code> \u5305\u542b\u7684\u662f\uff1a</p> <ul> <li>\u5f62\u72b6:\u00a0<code>[batch_size]</code>\u00a0- \u6bcf\u4e2a\u8bf7\u6c42\u4e00\u4e2a token ID</li> <li>\u5185\u5bb9: \u6bcf\u4e2a\u5e8f\u5217\u7684\u4e0b\u4e00\u4e2a token\uff0c\u5373\u57fa\u4e8e\u8f93\u5165\u5e8f\u5217\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\u7684 logits \u91c7\u6837\u5f97\u5230\u7684 token</li> <li>\u4f4d\u7f6e: \u5bf9\u4e8e prefill\uff0c\u53ea\u4f7f\u7528\u5e8f\u5217\u7684\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\u8fdb\u884c\u91c7\u6837</li> </ul> <p>\u5728 decode \u6a21\u5f0f\u4e0b\uff0c<code>next_token_ids</code> \u5305\u542b\u7684\u662f\uff1a</p> <ul> <li>\u5f62\u72b6:\u00a0<code>[batch_size]</code>\u00a0- \u6bcf\u4e2a\u8bf7\u6c42\u4e00\u4e2a token ID</li> <li>\u5185\u5bb9: \u6bcf\u4e2a\u8bf7\u6c42\u5f53\u524d\u89e3\u7801\u6b65\u9aa4\u751f\u6210\u7684\u4e0b\u4e00\u4e2a token</li> <li>\u4f4d\u7f6e: \u4f7f\u7528\u5f53\u524d\u89e3\u7801\u4f4d\u7f6e\u8fdb\u884c\u91c7\u6837</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overview_1","title":"Overview","text":"<p>\u4e00\u4e2a\u8bf7\u6c42 Request \u8fdb\u5165 SGLang Scheduler\uff0c\u4f1a\u7ecf\u8fc7\u5982\u4e0b\u9636\u6bb5</p> Bash<pre><code>Req -&gt; Pre Schedule(CPU) -&gt; Compute Batch -&gt; Sample(GPU) -&gt; Post Schedule(CPU) -&gt; next Schedule ...\n</code></pre> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#pre-schedule","title":"Pre Schedule","text":"<ul> <li>\u6536\u96c6\u524d\u7aef\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u5e76\u5c06\u5176\u653e\u5165\u7b49\u5f85\u961f\u5217\u3002(<code>Schedule::recv_request()</code> &amp; <code>Schedule::process_input_requests()</code>)</li> <li>\u4ece\u7b49\u5f85\u961f\u5217\u548c running_batch \u4e2d\u8fdb\u884c\u8c03\u5ea6 (<code>Schedule::get_batch_to_run()</code>)</li> <li>Prefill \u4e2d\u6d89\u53ca Radix Tree \u548c\u6700\u957f\u524d\u7f00\u5339\u914d\uff08Longest Prefix Matching\uff09\u7b97\u6cd5\u3002(<code>Req::init_next_round_input()</code>)</li> <li>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5206\u914d Token \u6240\u9700\u7684\u5185\u5b58\u8d44\u6e90\u3002\u3002(<code>ScheduleBatch::prepare_for_extend()</code> &amp; <code>ScheduleBatch::prepare_for_decode()</code>)</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#compute-batch","title":"Compute batch","text":"<p>\u65b0\u7684\u8bf7\u6c42\u4f1a\u8fdb\u5165 Prefill \u9636\u6bb5\uff0cPrefill \u9636\u6bb5\u7ed3\u675f\u540e\u8fdb\u5165 Decode \u9636</p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#prefill-schedule","title":"Prefill Schedule","text":"<ol> <li> <p><code>get_next_batch_to_run</code>\uff1a\u8fd9\u91cc\u662f Prefill \u4f18\u5148\uff0c\u6240\u4ee5\u4f1a\u8c03\u7528 <code>get_new_batch_prefill</code>\uff0c\u5e76\u76f4\u63a5\u628a\u51fd\u6570\u8fd4\u56de\u7684<code>new_batch</code>\u4f5c\u4e3a\u8fd9\u4e00\u8f6e\u6267\u884c\u7684 batch(\u5373 <code>cur_batch</code>)</p> </li> <li> <p><code>get_new_batch_prefill</code>:</p> </li> </ol> <ul> <li>\u521b\u5efa PrefillAdder \u6765\u7ba1\u7406\u6279\u6b21\u6784\u5efa\uff0c\u4ece waiting_queue \u4e2d\u9009\u62e9\u8bf7\u6c42</li> <li><code>init_next_round_input</code> \u66f4\u65b0 radix tree cache \u7684\u524d\u7f00</li> <li>\u521b\u5efa\u65b0\u7684 ScheduleBatch\uff0c\u8c03\u7528 <code>prepare_for_extend</code>:<ul> <li>\u5206\u914d<code>req_pool_indices</code>\uff1a\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5728\u8bf7\u6c42\u6c60\u4e2d\u5206\u914d\u4e00\u4e2a\u552f\u4e00\u7684\u7d22\u5f15\u4f4d\u7f6e\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7528\u4e8e\u5728 \u00a0<code>req_to_token_pool</code>\u00a0 \u4e2d\u5b58\u50a8\u8be5\u8bf7\u6c42\u7684 token-to-KV \u6620\u5c04\u3002</li> <li>allocate kv cache</li> <li>\u5c06 req \u4e0e kv cache \u7684\u6620\u5c04\u5199\u5165\u5230 <code>req_to_token_pool</code></li> </ul> </li> </ul> <ol> <li><code>run_batch()</code>\uff1a\u6267\u884c Decode \u63a8\u7406\uff0c\u8c03\u7528 <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward()</code> -&gt; <code>ModelRunner::_forward_raw()</code> -&gt; <code>ModelRunner::forward_decode()</code>\u540e\u9762\u6267\u884c backend \u7684\u7b97\u5b50\u7b49\u5f85\u8fd4\u56de\u7ed3\u679c</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#decode-schedule","title":"Decode Schedule","text":"<ol> <li><code>get_next_batch_to_run()</code>\uff1a\u5904\u7406\u4e0a\u4e00\u6279\u6b21\u7684\u5b8c\u6210\u8bf7\u6c42\uff0c\u7136\u540e\u4e0e running_batch \u8fdb\u884c merge</li> <li><code>update_running_batch()</code>\uff1a    - \u8c03\u7528 \u00a0<code>prepare_for_decode()</code>\uff1a<ul> <li>\u4e0a\u4e00\u6b21 schedule \u7684 <code>output_ids</code> \u53d8\u4e3a\u8fd9\u4e00\u6b21\u7684 <code>input_ids</code></li> <li>\u4e3a \u00a0<code>out_cache_loc</code>\u00a0 \u5206\u914d\uff08batch size * 1\uff09\u4e2a slot\uff0c\u56e0\u4e3a\u5728 decode \u6a21\u5f0f\u4e0b\u6211\u4eec\u5bf9\u6bcf\u4e2a batch \u4e00\u6b21\u53ea\u751f\u6210\u4e00\u4e2a token Python<pre><code>out_cache_loc = alloc_token_slots(batch.tree_cache, bs * 1)\n</code></pre></li> </ul> </li> <li><code>run_batch()</code>\uff1a\u6267\u884c Decode \u63a8\u7406\uff0c\u8c03\u7528 <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward()</code> -&gt; <code>ModelRunner::_foward_raw()</code> -&gt; <code>ModelRunner::forward_decode()</code>\u540e\u9762\u6267\u884c backend \u7684\u7b97\u5b50\u7b49\u5f85\u8fd4\u56de\u7ed3\u679c</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#sample","title":"Sample","text":"<p><code>TpModelWorker::forward_batch_generation()</code>\uff1a</p> <ul> <li>\u5982\u679c\u4e0d\u662f overlap \u6a21\u5f0f\uff0c\u7acb\u5373\u8fdb\u884c Sample\uff0c\u5426\u5219\u91cd\u53e0 CPU \u548c GPU \u8fdb\u884c\u5ef6\u8fdf\u91c7\u6837</li> <li>Sample \u5f97\u5230 batch \u7684 <code>next_token_ids</code>\uff0c\u4f9b\u4e0b\u4e00\u6b21 batch forward \u4f7f\u7528 Python<pre><code>sampling_info.update_regex_vocab_mask()\n  sampling_info.apply_logits_bias(logits_output.next_token_logits)\n  next_token_ids = self.sampler(\n      logits_output,\n      forward_batch.sampling_info,\n      forward_batch.return_logprob,\n      forward_batch.top_logprobs_nums,\n      forward_batch.token_ids_logprobs,\n      # For prefill, we only use the position of the last token.\n      (\n          forward_batch.positions\n          if forward_batch.forward_mode.is_decode()\n          else forward_batch.seq_lens - 1\n      ),\n  )\n</code></pre></li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#post-schedule","title":"Post Schedule","text":"<ul> <li>Prefill\uff1a <code>process_batch_result_prefill()</code></li> <li>\u83b7\u53d6\u7ed3\u679c\uff0c\u8c03\u7528 tree_cache \u7684 <code>cache_unfinished_req()</code> \u4fdd\u7559\u8be5 req \u7684 cache</li> <li>Decode\uff1a <code>process_batch_result_decode()</code>\uff1a</li> <li>\u5bf9\u6bcf\u4e2a Req \u8fdb\u884c\u5224\u65ad\uff0c\u5982\u679c\u5df2\u7ecf\u5b8c\u6210\u5c31\u91ca\u653e tree_cache \u4e2d\u5bf9\u5e94\u7684 KV cache(\u5faa\u73af\u89e3\u91ca\u540e\u6279\u91cf\u91ca\u653e)</li> <li>\u5c06 batch \u7684\u7ed3\u679c\u901a\u8fc7 <code>stream_out()</code> \u8fd4\u56de\u7ed9 detokenizer \u8fdb\u884c\u4e0b\u4e00\u6b65\u5904\u7406</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_1","title":"\u4e8b\u4ef6\u5faa\u73af","text":"<ul> <li>\u8bf7\u6c42\u90fd\u4f1a\u5148\u6267\u884c prefill \u9636\u6bb5\u7136\u540e\u6267\u884c decode \u9636\u6bb5\uff0c\u76f4\u5230\u83b7\u5f97 EOS \u6216\u5176\u4ed6\u539f\u56e0\u9000\u51fa</li> </ul> Python<pre><code>def event_loop_normal(self):\n\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"A normal scheduler loop.\"\"\"\n\u00a0 \u00a0 \u00a0 \u00a0 while True:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 recv_reqs = self.recv_requests()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.process_input_requests(recv_reqs)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 batch = self.get_next_batch_to_run()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.cur_batch = batch\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if batch:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result = self.run_batch(batch)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.process_batch_result(batch, result)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 else:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # When the server is idle, do self-check and re-init some states\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.self_check_during_idle()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.last_batch = batch\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#pre-schedule_1","title":"Pre Schedule","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#req-waiting_queue","title":"Req -&gt; Waiting_queue","text":"<ul> <li> <p>\u9996\u5148\u6267\u884c <code>recv_requests</code>\uff1a</p> </li> <li> <p>\u53ea\u6709 Pipeline rank = 0 \u7684\u53ef\u4ee5\u4ece zmq \u4e2d\u83b7\u53d6 tokenizer \u4f20\u6765\u7684 requests</p> </li> <li>\u5176\u4ed6 pipeline rank \u4ece\u524d\u4e00\u4e2a pipeline \u83b7\u53d6 requests</li> <li> <p>work_reqs \u5728 attn_tp \u4e2d\u8fdb\u884c\u5e7f\u64ad\uff1b\u7cfb\u7edf\u7684 control_reqs \u5728\u6574\u4e2a tp_size \u4e2d\u5e7f\u64ad</p> </li> <li> <p>\u7136\u540e\u6267\u884c <code>process_input_requests</code></p> </li> </ul> <ol> <li>\u63d0\u53d6 worker_id:\u00a0<code>worker_id = recv_req.worker_id</code></li> <li>\u89e3\u5305\u8bf7\u6c42:\u00a0<code>recv_req = recv_req.obj</code></li> <li>\u5206\u53d1\u5904\u7406:\u00a0<code>output = self._request_dispatcher(recv_req)</code> \u8c03\u7528\u8bf7\u6c42\u5206\u53d1\u5668<ul> <li>\u5c06 recv_req \u6784\u5efa\u4e3a\u65b0\u7684 <code>Req</code> \u5bf9\u8c61</li> <li>\u8c03\u7528 <code>_add_request_to_queue()</code> \u5c06 <code>Req</code> \u63d2\u5165 waiting_queue \u4e2d</li> </ul> </li> <li>\u53d1\u9001\u56de\u5e94: \u5c06\u8f93\u51fa\u53d1\u9001\u56de\u5bf9\u5e94\u7684 tokenizer \u5de5\u4f5c\u8fdb\u7a0b</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#waiting_queuerunning_batch-cur_batch","title":"Waiting_queue/running_batch -&gt; cur_batch","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#prefill-batch-get_new_batch_prefill","title":"\u83b7\u53d6 prefill batch <code>get_new_batch_prefill</code>","text":"<ul> <li> <p>\u521b\u5efa PrefillAdder\uff0c\u5bf9\u65b0\u6765\u7684\u8bf7\u6c42\u8fdb\u884c\u5206\u5757\uff0c\u7136\u540e\u6bcf\u6b21\u5904\u7406\u591a\u4e2a\u5206\u5757</p> </li> <li> <p><code>init_next_round_input()</code>\uff1a</p> <ul> <li>\u6784\u5efa\u5b8c\u6574\u586b\u5145\u5e8f\u5217\uff1a\u539f\u59cb\u8f93\u5165 token + \u5df2\u751f\u6210\u7684\u8f93\u51fa token</li> <li>\u6700\u5927\u524d\u7f00\u957f\u5ea6\u8ba1\u7b97\uff1a\u6700\u591a\u7f13\u5b58\u5230\u5012\u6570\u7b2c\u4e8c\u4e2a token\uff08<code>input_len - 1</code>\uff09 <p>\u6a21\u578b\u9700\u8981\u4e00\u4e2a\u8f93\u5165 Token \u6765\u67e5\u8be2\uff08Query\uff09\u8fd9\u4e9b\u7f13\u5b58\u7684\u5386\u53f2\u4fe1\u606f\uff0c\u5e76\u8ba1\u7b97\u51fa\u5f53\u524d\u6b65\u7684 Logits\uff08\u6982\u7387\u5206\u5e03\uff09\u3002\u5982\u679c\u6211\u4eec\u628a\u6240\u6709 Token \u90fd\u7b97\u4f5c Prefix \u5e76\u4ece Cache \u4e2d\u8bfb\u53d6\uff0c\u90a3\u4e48\u5f53\u524d\u6b65\u5c31\u6ca1\u6709\u201c\u8f93\u5165\u201d\u5582\u7ed9\u6a21\u578b\u4e86\uff0c\u6a21\u578b\u4e5f\u5c31\u65e0\u6cd5\u8ba1\u7b97\u51fa \\(t+1\\) \u7684 Logits\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u5fc5\u987b \u4fdd\u7559\u6700\u540e\u4e00\u4e2a Token \u4e0d\u653e\u5165 Prefix \u5339\u914d\u4e2d\uff0c\u8ba9\u5b83\u4f5c\u4e3a\u672c\u6b21\u63a8\u7406\u7684 input_ids \u8f93\u5165\u7ed9\u6a21\u578b\u3002</p> </li> <li>\u524d\u7f00\u5339\u914d\uff1a</li> <li>\u5f53 Request\u00a0<code>ABC</code>\u5230\u8fbe\u65f6\uff0c\u5047\u8bbe\u5f53\u524d radix cache \u91cc\u5b58\u5728\u4e00\u4e2a\u8282\u70b9<code>AFG</code></li> <li><code>match_prefix</code>\u00a0 \u4f1a\u5c1d\u8bd5\u5728\u5f53\u524d radix cache \u91cc\u627e\u5230\u73b0\u5b58\u7684<code>ABC</code>\u7684\u6700\u957f\u524d\u7f00\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b83\u4f1a\u5728<code>AFG</code>\u8282\u70b9\u91cc\u627e\u5230<code>A</code></li> <li>Radix cache \u4f1a\u628a\u8fd9\u4e2a\u8282\u70b9<code>AFG</code>\u62c6\u5206\u6210<code>A</code>\u548c<code>FG</code>\uff0c<code>A</code>\u8282\u70b9\u6210\u4e3a\u5f53\u524d Request \u7684\u6700\u540e\u4e00\u4e2a\u8282\u70b9</li> </ul> </li> <li> <p>\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 ScheduleBatch</p> </li> <li> <p>\u8c03\u7528 <code>ScheduleBatch::prepare_for_extend()</code></p> </li> <li> <p>\u5206\u914d<code>req_pool_indices</code>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5728\u8bf7\u6c42\u6c60\u4e2d\u5206\u914d\u4e00\u4e2a\u552f\u4e00\u7684\u7d22\u5f15\u4f4d\u7f6e\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7528\u4e8e\u5728 \u00a0<code>req_to_token_pool</code>\u00a0 \u4e2d\u5b58\u50a8\u8be5\u8bf7\u6c42\u7684 token-to-KV \u6620\u5c04\u3002</p> <ul> <li>allocate kv cache\uff1a[\u6bcf\u4e2a Request \u7684\u603b input token \u6570 - match \u5230\u7684 prefix token \u6570] \u4e2a<code>out_cache_loc</code></li> <li>\u5c06 req \u4e0e kv cache \u7684\u6620\u5c04\u5199\u5165\u5230 <code>req_to_token_pool</code></li> </ul> Python<pre><code>req_to_token_pool[req_idx]:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u524d\u7f00\u90e8\u5206 (1984 tokens)    \u2502    \u65b0chunk\u90e8\u5206 (2000 tokens)    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 [loc_1, loc_2, ..., loc_1984] \u2502 [loc_1985, ..., loc_3984] \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u4f4d\u7f6e:  0                    1984                         3984\n\nKV Cache Pool:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502loc_1 \u2502loc_2 \u2502 ... \u2502loc_1984\u2502loc_1985\u2502 ... \u2502loc_3984\u2502 ... \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 k1,v1\u2502 k2,v2\u2502 ... \u2502k1984,v1984\u2502k1985,v1985\u2502 ... \u2502k3984,v3984\u2502 ... \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#decode-batch","title":"\u83b7\u53d6 decode batch","text":"<ul> <li> <p>\u5148\u4ece batch \u4e2d\u5220\u9664\u5df2\u7ecf\u5b8c\u6210\u6216\u8005\u5df2\u7ecf\u51fa\u9519\u7684 batch\uff0c\u7136\u540e\u5c06\u4e0a\u4e00\u8f6e\u7684 decode batch \u4e0e running_batch \u5408\u5e76</p> </li> <li> <p>\u5b9e\u9645\u4e0a\u5c31\u662f\u5c06 <code>seq_lens</code>, <code>orig_seq_lens</code>, <code>output_ids</code> \u7b49\u8fdb\u884c <code>torch.cat</code> \u62fc\u63a5</p> </li> <li> <p>\u8c03\u7528 <code>update_running_batch()</code> \u83b7\u53d6 decode batch</p> </li> <li> <p>\u5148\u68c0\u67e5\u662f\u5426\u9700\u8981\u56de\u9000\u8bf7\u6c42</p> </li> <li> <p>\u5982\u679c\u9700\u8981\uff0c\u628a\u8981\u56de\u9000\u7684\u8bf7\u6c42\u91cd\u65b0\u63d2\u5165 <code>waiting_queue</code>\uff0c\u91cd\u65b0\u6392\u961f\u8fdb\u884c\u8c03\u5ea6</p> </li> <li> <p>\u8c03\u7528 <code>ScheduleBatch::prepare_for_decode()</code></p> <ul> <li>\u4e0a\u4e00\u8f6e\u8f93\u51fa\u4f5c\u4e3a\u8fd9\u4e00\u8f6e\u7684\u8f93\u5165</li> <li>\u5185\u5b58\u5206\u914d + \u5e8f\u5217\u957f\u5ea6\u66f4\u65b0</li> </ul> Python<pre><code># \u5047\u8bbebatch\u67093\u4e2a\u8bf7\u6c42\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u5f53\u524d\u957f\u5ea6\u5206\u522b\u4e3a[10, 15, 8]\n# decode\u9700\u8981\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u7684\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\u5206\u914d\u7a7a\u95f4\n\n# \u5206\u914d\u524d\u7684KV cache\u6620\u5c04\nreq_to_token_pool[req1_idx, 0:10] = [loc1, loc2, ..., loc10]\nreq_to_token_pool[req2_idx, 0:15] = [loc11, loc12, ..., loc25]\nreq_to_token_pool[req3_idx, 0:8] = [loc26, loc27, ..., loc33]\n\n# \u6267\u884c alloc_for_decode \u540e\nreq_to_token_pool[req1_idx, 10] = loc34    # \u4e3a\u4f4d\u7f6e10\u5206\u914d\nreq_to_token_pool[req2_idx, 15] = loc35    # \u4e3a\u4f4d\u7f6e15\u5206\u914d\nreq_to_token_pool[req3_idx, 8] = loc36     # \u4e3a\u4f4d\u7f6e8\u5206\u914d\n\n# out_cache_loc = [loc34, loc35, loc36]\n\n# A faster in-place version\nself.seq_lens.add_(1)\nself.seq_lens_cpu.add_(1)\nself.orig_seq_lens.add_(1)\n# update all length\nself.seq_lens_sum += bs \u00a0# bs = batch_size\n</code></pre> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#compute-batch-sample","title":"Compute batch &amp; Sample","text":"<p>\u8fd9\u91cc\u6211\u4eec\u6682\u65f6\u53ea\u8003\u8651 generation \u7684\u60c5\u51b5\uff08\u8fd8\u6709 Embedding \u7684\u60c5\u51b5\uff09</p> <ul> <li>\u5c06 <code>ScheduleBatch</code> \u8f6c\u5316\u4e3a <code>ModelWorkerBatch</code></li> <li>\u8c03\u7528 <code>TpModelWorker::forward_batch_generation()</code></li> <li>\u5c06 <code>ModelWorkerBatch</code> \u8f6c\u5316\u4e3a <code>ForwardBatch</code></li> <li>\u8c03\u7528 <code>ModelRunner::forward()</code>\uff0c\u6700\u540e\u8c03\u7528\u540e\u7aef flashinfer \u7684\u7b97\u5b50<ul> <li>Prefill \u6267\u884c <code>ModelRunner::forward_extend()</code></li> <li>Decode \u6267\u884c <code>ModelRunner::forward_decode()</code></li> </ul> </li> <li>\u7acb\u5373\u8fdb\u884c Sample\uff0c\u6839\u636e logits \u83b7\u5f97\u4e0b\u4e00\u4e2a token</li> <li>\u8fd4\u56de\u7ed3\u679c <code>GenerationBatchResult</code></li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#post-schedule_1","title":"Post Schedule","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#prefill","title":"Prefill","text":"<ul> <li>\u89e3\u5305 <code>GenerationBatchResult</code></li> <li>\u6267\u884c <code>synchronize()</code> \u7b49\u5f85 GPU\u2192CPU \u62f7\u8d1d\u5b8c\u6210\uff0c\u4fdd\u8bc1\u4e4b\u540e\u8bbf\u95ee\u7684\u6570\u636e\u5df2\u5728 CPU \u4e0a\u53ef\u7528\u3002</li> <li>\u904d\u5386 batch \u4e2d\u6bcf\u4e2a\u8bf7\u6c42</li> <li>\u66f4\u65b0\u751f\u6210\u7ed3\u679c</li> <li>\u66f4\u65b0 logprob</li> <li>Chunked \u8bf7\u6c42\u7684\u7279\u6b8a\u5904\u7406\uff1a<code>is_chunked &gt; 0</code> \u8868\u793a prefill \u5c1a\u672a\u5168\u90e8\u5b8c\u6210\uff0c\u9700\u8981\u9012\u51cf\u8ba1\u6570\u5e76\u8df3\u8fc7\u6d41\u5f0f\u8f93\u51fa\u3002</li> <li>\u8f93\u51fa\u6d41\u5f0f\u7ed3\u679c\uff1a\u8c03\u7528 <code>stream_output()</code> \u5c06\u7ed3\u679c\uff08token\u3001logprob \u7b49\uff09\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\uff08\u4f8b\u5982 WebSocket / API response\uff09</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#decode","title":"Decode","text":"Python<pre><code>[GPU forward kernel]\n   \u2193 (\u7ed3\u679c\u5199\u5165 GenerationBatchResult)\n[Scheduler.process_batch_result_decode()]\n   \u251c\u2500\u2500 copy_done.synchronize()\n   \u251c\u2500\u2500 next_token_ids.tolist()\n   \u251c\u2500\u2500 \u66f4\u65b0 req \u72b6\u6001\n       \u251c\u2500\u2500 req.output_ids.append(next_token_id)\n       \u251c\u2500\u2500 if finished, self.tree_cache.cache_finished_req(req) # \u91ca\u653e kv cache\n   \u251c\u2500\u2500 stream_output()\n   \u2514\u2500\u2500 free KV pages\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#why-overlap","title":"Why Overlap?","text":"<p>\u8fd0\u884c\u5b9e\u9645\u8c03\u5ea6\u7b97\u6cd5\u4ec5\u5360\u603b\u4f53\u8c03\u5ea6\u5f00\u9500\u7684\u4e00\u5c0f\u90e8\u5206\u3002\u5927\u90e8\u5206\u5f00\u9500\u6765\u81ea\u4e8e\u6a21\u578b\u8f93\u5165\u7684\u51c6\u5907\u548c\u6a21\u578b\u8f93\u51fa\u7684\u540e\u5904\u7406\u3002\u5177\u4f53\u800c\u8a00\uff0c\u6700\u5927\u7684\u5f00\u9500\u6765\u81ea\u4e8e\u6784\u5efa\u8f93\u5165\u5f20\u91cf(Pre Schedule)\u3001\u6267\u884c\u8f93\u51fa\u53bb\u6807\u8bb0\u5316(Post Schedule)\u4ee5\u53ca\u51c6\u5907\u6bcf\u4e2a\u8bf7\u6c42\u7684\u5143\u6570\u636e(Pre Schedule)[^overhead]</p> <p>\u6784\u5efa\u6a21\u578b\u8f93\u5165\u5f20\u91cf\u548c\u91c7\u6837\u5143\u6570\u636e\u65b9\u9762\u7684\u5f00\u9500\u4e3b\u8981\u6e90\u4e8e Python</p> <p>\u4f7f\u7528\u591a\u6b65\u8c03\u5ea6\u53ef\u4ee5\u964d\u4f4e\u603b\u4f53\u8c03\u5ea6\u5f00\u9500\uff0c\u4f46\u4e5f\u5b58\u5728\u4e00\u4e9b\u5f0a\u7aef\u3002\u4f8b\u5982\uff0c\u5728\u4e24\u6b21\u8c03\u5ea6\u8c03\u7528\u4e4b\u95f4\uff0c\u5373\u4f7f\u67d0\u4e9b\u8bf7\u6c42\u63d0\u524d\u5b8c\u6210\uff0c\u4e5f\u65e0\u6cd5\u5c06\u65b0\u7684\u8bf7\u6c42\u6dfb\u52a0\u5230\u6279\u6b21\u4e2d\u3002</p> <ul> <li>vLLM \u7684 multi-step decode</li> <li>SGLang \u7684 speculative group execution</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#zero-overhead-scheduleoverlap","title":"Zero-Overhead Schedule(Overlap)","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_2","title":"\u539f\u7406","text":"<p>\u5728\u4ecb\u7ecd\u539f\u7406\u4e4b\u524d\u6211\u4eec\u9700\u8981\u56de\u5fc6\u4e00\u4e0b\u4e0a\u9762\u63a8\u7406\u8fc7\u7a0b\u7684 4 \u4e2a\u5927\u6b65\u9aa4\uff0c\u8003\u8651\u54ea\u4e9b\u6b65\u9aa4\u53ef\u4ee5\u8fdb\u884c Overlap\uff0c\u51cf\u5c11 GPU Bubble\uff0c\u5148\u653e\u4e00\u5f20\u73b0\u5728 Overlap \u7684\u6d41\u6c34\u7ebf\u56fe</p> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#inference-overview","title":"Inference Overview","text":"<p>SGLang \u7684\u63a8\u7406\u8fc7\u7a0b\u4e3b\u8981\u5206\u4e3a\u4ee5\u4e0b\u56db\u4e2a\u9636\u6bb5\uff1a</p> <ol> <li>Pre schedule\uff1a    - \u6536\u96c6\u524d\u7aef\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u5e76\u5c06\u5176\u653e\u5165\u7b49\u5f85\u961f\u5217\u3002(<code>Scheduler::recv_request()</code> &amp; <code>Scheduler::process_input_requests()</code>)    - \u4ece\u7b49\u5f85\u961f\u5217\u548c running_batch \u4e2d\u8fdb\u884c\u8c03\u5ea6 (<code>Scheduler::get_batch_to_run()</code>)<ul> <li>Prefill \u4e2d\u6d89\u53ca Radix Tree \u548c\u6700\u957f\u524d\u7f00\u5339\u914d\uff08Longest Prefix Matching\uff09\u7b97\u6cd5\u3002(<code>Req::init_next_round_input()</code>)</li> <li>\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5206\u914d Token \u6240\u9700\u7684\u5185\u5b58\u8d44\u6e90\u3002(<code>ScheduleBatch::prepare_for_extend()</code> &amp; <code>ScheduleBatch::prepare_for_decode()</code>)</li> </ul> </li> <li>Compute batch\uff1a    - \u5c06 batch \u53d1\u9001\u5230 GPU \u4e0a\u8fdb\u884c\u4e00\u6b65\uff08\u5373 Continue Batch \u7684\u4e00\u4e2a iter\uff09\u63a8\u7406(<code>Scheduler::run_batch()</code>)</li> <li>Sample\uff1a    - \u6839\u636e\u6a21\u578b\u8f93\u51fa\u7684 Logit \u8fdb\u884c\u91c7\u6837\uff0c\u751f\u6210\u4e0b\u4e00\u6b65\u7684 Token\u3002(<code>ModelRunner::sample()</code>)</li> <li>Post schedule\uff1a    - \u5728\u4e00\u6b65\u63a8\u7406\u5b8c\u6210\u540e\uff0c\u52a8\u6001\u68c0\u67e5\u8bf7\u6c42\u662f\u5426\u6ee1\u8db3\u7ed3\u675f\u6761\u4ef6\uff08Check Finish Condition\uff09\u3002(<code>Scheduler::process_batch_result()</code>)    - \u5c06\u5df2\u5b8c\u6210\u7684\u8bf7\u6c42\u4ece\u6279\u6b21\u4e2d\u79fb\u9664\uff0c\u5e76\u9001\u5165 Detokenizer \u5904\u7406\uff0c\u6700\u7ec8\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9\u524d\u7aef\u3002</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overlap-overviewoverlap","title":"Overlap Overview[^overlap]","text":"<p>Compute batch \u548c Sample \u8fd9\u4e24\u4e2a\u6328\u5728\u4e00\u8d77\u7684\u9636\u6bb5\u662f GPU heavy \u7684\uff0c\u800c schedule \u7684\u4e24\u4e2a\u9636\u6bb5\u662f CPU heavy \u7684\u3002\u5f53\u591a\u4e2a batch \u6d41\u6c34\u7ebf\u5316\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u7528 GPU \u7684 Compute \u548c Sample \u6765\u91cd\u53e0\u4e0a\u4e00\u4e2a batch \u7684 post scheduler \u4e0e\u5f53\u524d batch \u7684 pre scheduler\u3002</p> <p>\u5b9e\u9645\u4e0a\u6211\u4eec\u7684 Prefill \u8bf7\u6c42\u8fdb\u5165\u5e76\u4e0d\u4f9d\u8d56\u672a\u5b8c\u6210\u7684 batch\uff0c\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u8fdb\u6765\u53ef\u4ee5\u76f4\u63a5\u6b63\u5e38\u6267\u884c</p> <p>\u6211\u4eec\u901a\u8fc7\u4f7f\u7528 Forward CUDA Stream \u7684\u65b9\u5f0f\u6765\u5b9e\u73b0 overlap\uff0c\u5177\u4f53\u6765\u8bf4\uff1a</p> <ul> <li>Run Batch \u4e2d\u5c06\u4e24\u4e2a\u64cd\u4f5c\u63d0\u4ea4\u5230 forward_stream \u961f\u5217\uff1a\u4e00\u4e2a\u662f\u4ece FutureMap \u83b7\u53d6\u4e0a\u4e00\u6b21 batch \u7684 next token\uff1b\u4e00\u4e2a\u7528\u8fd9\u4e2a token \u4f5c\u4e3a <code>input_id</code> \u8fdb\u884c\u4e0b\u4e00\u6b21\u8ba1\u7b97</li> <li>Sample \u4e2d\u4e5f\u628a\u4e24\u4e2a\u64cd\u4f5c\u63d0\u4ea4\u5230 forward_stream \u961f\u5217\uff1a\u4e00\u4e2a\u662f\u8fdb\u884c\u91c7\u6837\uff1b\u4e00\u4e2a\u662f\u5c06\u5f97\u5230\u7684 next token \u5199\u56de FutureMap</li> <li>\u6211\u4eec\u9700\u8981\u5728 Post Schedule \u5904\u7406\u6570\u636e\u524d\u5bf9 CPU \u548c GPU \u505a\u4e00\u4e2a\u540c\u6b65\uff0c\u4fdd\u8bc1\u53ef\u4ee5\u5904\u7406\u5230 CPU \u7684 <code>next_token_ids</code></li> <li>\u6211\u4eec\u5728 Post Schedule \u4e2d\u8fdb\u884c\u540c\u6b65\u64cd\u4f5c\uff0c\u786e\u4fdd\u540e\u7eed\u7684\u5904\u7406\u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\u4e14\u4e0d\u5f71\u54cd GPU \u7684\u6d41\u6c34\u7ebf\u5de5\u4f5c Python<pre><code>def process_batch_result_decode(\n\u00a0 \u00a0 \u00a0 \u00a0 self: Scheduler,\n\u00a0 \u00a0 \u00a0 \u00a0 batch: ScheduleBatch,\n\u00a0 \u00a0 \u00a0 \u00a0 result: GenerationBatchResult,\n\u00a0 \u00a0 ):\n\u00a0 \u00a0 \u00a0 \u00a0 if result.copy_done is not None:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.copy_done.synchronize()\n\u00a0 \u00a0 \u00a0 \u00a0 logits_output, next_token_ids, can_run_cuda_graph = (\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.logits_output,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.next_token_ids,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.can_run_cuda_graph,\n\u00a0 \u00a0 \u00a0 \u00a0 )\n  next_token_ids = next_token_ids.tolist()\n  next_token_logprobs = logits_output.next_token_logprobs.tolist()\n</code></pre></li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overlap","title":"\u521d\u59cb\u5316 Overlap","text":"<ul> <li>forward_stream\uff1a\u4e13\u95e8\u7528\u4e8e GPU \u524d\u5411\u8ba1\u7b97\uff0c\u4e0e\u9ed8\u8ba4\u6d41\u5e76\u884c</li> <li>copy_stream\uff1a\u5904\u7406 GPU-&gt;CPU \u6570\u636e\u4f20\u8f93</li> <li>future_map\uff1a\u7ba1\u7406\u5f02\u6b65\u8ba1\u7b97\u7ed3\u679c\uff0c\u4f7f\u7528\u8d1f\u7d22\u5f15\u4f5c\u4e3a future \u6807\u8bc6\u7b26</li> <li>\u4e0a\u4e00\u4e2a batch \u8ba1\u7b97\u7684 <code>output_id</code> \u4f5c\u4e3a\u4e0b\u4e00\u4e2a batch \u7684 <code>input_id</code>\uff0c\u901a\u8fc7\u5b58\u53d6 <code>future_map</code> \u5b9e\u73b0</li> </ul> Python<pre><code>def init_overlap(self):\n    if not self.enable_overlap:\n        return\n    self.forward_stream = torch.cuda.Stream()  # GPU\u524d\u5411\u8ba1\u7b97\u6d41\n    # Future\u6620\u5c04\u7ba1\u7406\u5f02\u6b65\u7ed3\u679c\n    self.future_map = FutureMap(max_running_requests, device, spec_algorithm)\n    # batch \u7f13\u51b2\u533a\uff08\u9632\u6b62GPU\u5f20\u91cf\u88abGC\u56de\u6536\uff09\n    self.batch_record_buf = [None] * 2\n    self.batch_record_ct = 0\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#futuremap","title":"FutureMap","text":"<ul> <li> <p>\u5b58\u653e\u5728 GPU \u4e0a</p> </li> <li> <p><code>future_ct</code>\uff1a\u5f53\u524d\u73af\u5f62\u8ba1\u6570\u5668\uff08\u6307\u9488\uff09\uff0c\u7528\u4e8e\u751f\u6210\u65b0\u7684 future indices\uff08\u5e76\u975e\u201c\u5c1a\u672a\u5b8c\u6210\u7684\u6570\u91cf\u201d\uff09\u3002</p> </li> <li> <p><code>future_limit</code>\uff1a\u73af\u5f62\u6307\u9488\u7684\u6a21\uff08\u7528\u6765\u505a <code>% self.future_limit</code>\uff09\u3002\u4ee3\u7801\u91cc\u7528 <code>*3</code> \u7684\u56e0\u5b50\u6765 \u51cf\u5c0f\u7d22\u5f15\u51b2\u7a81\u6982\u7387\uff08\u9632\u6b62 <code>future_ct</code> \u5feb\u901f\u56de\u7ed5\u8986\u76d6\u5c1a\u672a\u5199\u56de\u7684 slot\uff09\u3002</p> </li> <li> <p><code>future_buffer_len</code>\uff1a\u5b9e\u9645\u7f13\u51b2\u533a\u7269\u7406\u957f\u5ea6\uff08<code>*5</code>\uff09\uff0c\u6bd4 <code>future_limit</code> \u66f4\u957f\u4ee5\u4fdd\u8bc1\u5199\u5165\u533a\u95f4\u6709\u8db3\u591f\u7a7a\u95f4\uff08\u9632\u6b62 slice \u8d8a\u754c\u6216\u56de\u7ed5\u5199\u5165\u4e0e\u8bfb\u51b2\u7a81\uff09\u3002</p> </li> <li> <p>\u8fd9\u4e24\u4e2a\u56e0\u5b50\uff083 \u548c 5\uff09\u662f\u5de5\u7a0b\u7ecf\u9a8c\u503c\uff0c\u7528\u6765\u589e\u52a0\u5b89\u5168\u88d5\u91cf\uff1b\u4f60\u53ef\u4ee5\u6839\u636e\u5e76\u53d1\u91cf\u548c outstanding futures \u8c03\u6574\u3002</p> </li> </ul> Python<pre><code>class FutureMap:\n    def __init__(\n        self,\n        max_running_requests: int,\n    ):\n        self.future_ct = 0\n        # A factor of 3 is used to avoid collision in the circular buffer.\n        self.future_limit = max_running_requests * 3\n        # A factor of 5 is used to ensure the buffer is large enough.\n        self.future_buffer_len = max_running_requests * 5\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overlap_1","title":"Overlap \u4e8b\u4ef6\u5faa\u73af","text":"Python<pre><code>def event_loop_overlap(self):\n    self.result_queue = deque()  # \u5b58\u50a8(batch, result)\u5bf9\n    while True:\n        # === Pre Schedule 2 ===\n        recv_reqs = self.recv_requests()\n        self.process_input_requests(recv_reqs)\n        batch = self.get_next_batch_to_run()\n        self.cur_batch = batch\n\n        batch_result = None\n        if batch:\n            # === Launch Compute Batch 2 ===\n            batch_result = self.run_batch(batch)  # \u975e\u963b\u585e\u542f\u52a8\n            self.result_queue.append((batch.copy(), batch_result))\n\n        # === Post Schedule 1 ===\n        # compute batch 2 \u4e0e post schedule 1 \u5e76\u884c\u6267\u884c\n        if self.last_batch:\n            # \u5904\u7406\u961f\u5217\u4e2d\u7684\u7ed3\u679c\uff08\u6b64\u65f6GPU\u5728\u5e76\u884c\u8ba1\u7b97\u5f53\u524d\u6279\u6b21\uff09\n            tmp_batch, tmp_result = self.result_queue.popleft()\n            self.process_batch_result(tmp_batch, tmp_result)\n        elif batch is None:\n            self.self_check_during_idle()\n\n        # === Launch Sample 2 ===\n        self.launch_batch_sample_if_needed(batch_result)  # update vocab mask\n        self.last_batch = batch\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#normal-event-loop","title":"\u4e0e normal event loop \u7684\u4e0d\u540c","text":"<ul> <li><code>Schedule::run_batch()</code></li> <li><code>Schedule::record_batch_in_overlap()</code>\uff1a\u5728\u4e24\u4e2a overlap \u7684 batch \u4e2d\u4ea4\u66ff\u5b58\u50a8 model_worker_batch \u5f15\u7528\uff0c\u907f\u514d\u5728 overlap \u7684 forward \u5c1a\u672a\u7ed3\u675f\u65f6\uff0cCUDA kernel \u8bbf\u95ee\u91ce\u6307\u9488\u6216\u5df2\u91ca\u653e\u7684\u663e\u5b58</li> <li><code>FutureMap::resolve_future()</code>\uff1a\u7528\u4e0a\u4e00\u8f6e batch sample \u5f97\u5230\u7684\u771f\u5b9e token \u66ff\u6362\u8d1f\u7d22\u5f15\u7684\u5360\u4f4d\u7b26</li> <li><code>TpModelWorker::forward_batch_generation()</code>\uff0c\u8be5\u51fd\u6570\u4ec5\u4ec5\u5c06 <code>model_runner.sample</code> \u51fd\u6570 delay \u6267\u884c\uff0c\u5148\u8fd4\u56de batch_result</li> <li>\u589e\u52a0\u4e86 <code>Scheduler::launch_batch_sample_if_needed()</code>\uff1a</li> <li>\u6267\u884c\u771f\u6b63\u7684 Sample \u64cd\u4f5c<ul> <li>\u5c4f\u853d\u975e\u6cd5 token\uff0c\u5206\u914d vocab_mask \u5f20\u91cf\u5927\u5c0f [batch, vocab_size]</li> <li>\u79fb\u52a8 mask \u5230 CPU</li> </ul> </li> <li>\u5c06\u5f97\u5230\u7684 <code>next_token_id</code> \u5b58\u50a8\u5230 FutureMap \u7684 <code>future_indices</code> \u7684\u5bf9\u5e94\u4f4d\u7f6e<ul> <li>\u4e3a\u4e86\u4e0b\u4e00\u6b21 batch \u5728 <code>run_batch</code> \u4e2d\u7684 <code>resolve_future</code> \u83b7\u53d6\u5230\u771f\u6b63\u7684 token</li> </ul> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_3","title":"\u6d41\u540c\u6b65","text":"<ul> <li>decode \u6a21\u5f0f\u4e0b\u524d\u4e00\u6b21 batch \u7684 <code>batch.output_ids</code> \u662f\u540e\u4e00\u6b21 batch \u7684 <code>batch.input_ids</code></li> <li>First: last batch \u7684 <code>output_id</code> store in FutureMap \u540e</li> <li>Second: current batch get <code>output_id</code> from FutureMap \u5e76\u4f5c\u4e3a\u4e0b\u4e00\u6b21 batch \u7684 <code>input_id</code> \u8fdb\u884c\u8ba1\u7b97</li> <li>CUDA Stream \u7684\u672c\u8eab\u7684\u9650\u5236</li> <li>CPU \u4fa7\u4f7f\u7528\u8d1f\u6570\u5360\u4f4d\u7b26\u5b9e\u73b0\uff0c\u7b49\u5f85 GPU \u8fdb\u884c\u771f\u6b63 token \u7684\u586b\u5145</li> </ul> Python<pre><code># previous batch output is negative indices\nbatch.output_ids = -self.future_map.alloc_future_indices(bs).indices\nwith self.forward_stream_ctx:\n    self.forward_stream.wait_stream(self.default_stream)\n    _batch_result = batch_result.delay_sample_func()\n    assert _batch_result is batch_result\n    # store token to negative indices\n    self.future_map.store_to_map(batch_result.future_indices, batch_result)\n    batch_result.copy_to_cpu()\n\n# next batch input is output of previous batch\n\u00a0with self.forward_stream_ctx:\n    self.forward_stream.wait_stream(self.default_stream)\n    # get token from negative indices\n    self.future_map._resolve_future_token_ids(model_worker_batch.input_ids, self.token_ids_buf)\n    batch_result = self.model_worker.forward_batch_generation(\n        model_worker_batch\n    )\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#overlap_2","title":"\u4e0e\u4e0a\u4e00\u7248 overlap \u5dee\u5f02","text":"<ul> <li>\u5c06 update_vocab_mask \u79fb\u52a8\u5230 GPU \u8fdb\u884c\u8ba1\u7b97\uff0c<code>vocab_mask</code> \u4e5f\u5728 GPU \u76f4\u63a5\u8fdb\u884c\u5206\u914d\uff0c\u4e0d\u518d\u8fdb\u884c\u4f20\u8f93</li> <li>\u73b0\u5728\u7684 GPU \u989d\u5916\u8d1f\u8d23\u5411 FutureMap \u5b58\u50a8(after sample)\u4ee5\u53ca\u83b7\u53d6(before compute) <code>next_token_ids</code></li> <li>FutureMap \u4e5f\u662f\u5b8c\u5168\u5b58\u50a8\u5728 GPU \u4e0a</li> <li>\u5bf9 GPU \u8c03\u5ea6\u7531\u539f\u6765 CPU \u8fdb\u884c launch\uff0c\u53d8\u6210\u76f4\u63a5\u5c06\u64cd\u4f5c\u63d0\u4ea4\u5230 cuda stream\uff0c\u7531 stream \u81ea\u5df1\u6765\u8c03\u5ea6</li> <li>\u5bf9 sample \u7684\u540c\u6b65\uff0c\u4e0a\u4e00\u7248\u4f7f\u7528 cuda event \u8fdb\u884c\u540c\u6b65\uff0c\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528 cuda stream \u987a\u5e8f\u9650\u5236\u6765\u8fdb\u884c\u540c\u6b65</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#_4","title":"\u4e24\u4e2a\u7248\u672c\u7684\u4f18\u7f3a\u70b9","text":"","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#cuda-stream","title":"CUDA stream \u7248\u672c","text":"<ul> <li>\u6267\u884c\u6548\u7387\u66f4\u9ad8\uff1a<code>vocab_mask</code> \u548c <code>token_ids_buf</code> \u65e0 CPU-GPU \u4f20\u8f93\uff1b\u5145\u5206\u5229\u7528 GPU \u5185\u5b58\u5e26\u5bbd</li> <li>\u5ef6\u8fdf\u66f4\u4f4e\uff1a<code>token_ids_buf</code> \u76f4\u63a5\u5728 GPU \u4e0a\u539f\u5730\u4fee\u6539\uff0c\u4e0d\u5fc5\u53cd\u590d\u4f20\u8f93</li> <li>\u4e0e\u6a21\u578b\u63a8\u7406\u5728\u540c\u4e00\u8bbe\u5907\u4e0a\uff0c\u4fbf\u4e8e\u6d41\u6c34\u7ebf</li> <li>\u975e\u6a21\u578b\u5360\u7528\u663e\u5b58\u5927\uff1a<code>token_ids_buf</code> \u5360\u7528 GPU \u663e\u5b58\uff0c\u5f00\u9500\u56fa\u5b9a</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#cpu-launch","title":"CPU launch \u7248\u672c","text":"<ul> <li>\u53ea\u6709\u5728\u4f7f\u7528\u65f6\u624d\u5360\u7528 GPU \u5185\u5b58</li> <li>\u540c\u6b65\u70b9\u589e\u52a0\uff1a<code>vocab_mask</code> \u4f1a\u589e\u52a0\u4e00\u6b21 CPU-GPU \u540c\u6b65</li> <li>CPU-GPU \u540c\u6b65\u4f1a\u7834\u574f\u6d41\u6c34\u7ebf</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20Scheduler%20%E6%8A%80%E6%9C%AF%E5%8F%98%E8%BF%81/#reference","title":"Reference","text":"<p>[^overlap]: Zero-Overhead Batch Scheduler [^overhead]: Can Scheduling Overhead Dominate LLM Inference Performance? A Study of CPU Scheduling Overhead on Two Popular LLM Inference Systems [^code-walk]: SGLang Code Walk Through</p>","tags":["LLMInference"]},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/","title":"SGLang \u4e2d\u7684 TP + PP","text":"2025-12-132025-12-13 <p>title: SGLang \u4e2d\u7684 TP + PP tags:</p> <ul> <li>LLMInference   date: 2025/11/22</li> </ul>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#sglang-tp-pp","title":"SGLang \u4e2d\u7684 TP+ PP","text":"<p> \u7ea6 1933 \u4e2a\u5b57  54 \u884c\u4ee3\u7801  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 10 \u5206\u949f</p> <p>\u8fd9\u91cc\u6211\u4eec\u4ee5 <code>Qwen2</code> \u6a21\u578b\u4e3a\u4f8b\uff0c\u5f00\u542f PP + TP \u5206\u6790\u4e00\u4e0b SGLang \u662f\u5982\u4f55\u5b9e\u73b0\u6a21\u578b\u63a8\u7406\u7684\u5e76\u884c\u7684</p>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#_1","title":"\u4e0d\u540c\u8282\u70b9\u7684\u804c\u8d23","text":"\u8282\u70b9 \u5de5\u4f5c\u5185\u5bb9 Rank 0 tokenizer\u3001detokenizer\u3001HTTP\u670d\u52a1\u3001\u8c03\u5ea6\u5668\u3001\u6a21\u578b worker Rank &gt; 0 \u53ea\u8fd0\u884c\u8c03\u5ea6\u5668 + worker\uff0c\u4e0d\u5904\u7406\u524d\u7aef\u670d\u52a1"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#initiallize-server","title":"Initiallize Server","text":"<ol> <li><code>launch_server.py</code> \u4e2d\u6839\u636e <code>grpc_mode</code> \u53c2\u6570\u51b3\u5b9a\u6267\u884c <code>serve_grpc()</code> \u6216\u8005 <code>launch_server()</code></li> </ol> <p>\u540e\u7eed\u4ee5 <code>launch_server()</code> \u4e3a\u4f8b\u8fdb\u884c\u8bb2\u89e3</p> <ol> <li>\u8c03\u7528 <code>engine.py</code> \u4e2d\u7684 <code>_launch_subprocesses()</code></li> </ol> <p>\u8fd9\u91cc\u6240\u6709\u7684\u5b50\u8fdb\u7a0b\u4ee5 spawn \u65b9\u5f0f\u6d3e\u751f\u5168\u65b0 Python \u8fdb\u7a0b</p> <ul> <li>\u6309\u7167 pp \u548c tp \u91cd\u65b0\u6620\u5c04 GPU Id\uff0c\u7136\u540e\u4e3a\u6bcf\u4e2a GPU \u521b\u5efa\u4e00\u4e2a<code>mp.Pipe()</code></li> <li>\u63a5\u7740\u542f\u52a8\u4e00\u4e2a Scheduler \u5b50\u8fdb\u7a0b\uff0c\u4f20\u5165 pipe \u7684\u5199\u7aef\uff08\u4f7f\u7528 <code>run_scheduler_process()</code>\uff09\uff0c\u7136\u540e\u7236\u8fdb\u7a0b\u4fdd\u7559\u5b50\u8fdb\u7a0b\u5f15\u7528\u548c pipe \u7684\u8bfb\u7aef</li> <li>\u591a\u673a\u573a\u666f\u4e0b\u975e 0 \u8282\u70b9\u4e0d\u53c2\u4e0e\u524d\u7aef\u670d\u52a1\uff0c\u4ec5\u8d1f\u8d23\u542f\u52a8 scheduler \u8fdb\u7a0b\u5e76\u4fdd\u6301\u8282\u70b9\u5065\u5eb7\uff0c\u907f\u514d\u91cd\u590d\u8fd0\u884c tokenizer / detokenizer / \u63a5\u5165\u670d\u52a1\u3002</li> <li>0 \u53f7\u8282\u70b9\u542f\u52a8 detokenizer \u5b50\u8fdb\u7a0b by <code>run_detokenizer_process()</code>\uff0c</li> <li>\u542f\u52a8 TokenizerManager\uff0c\u7b49\u5f85\u6240\u6709\u7684 GPU \u90fd\u52a0\u8f7d\u4e86 model \u5e76\u62e5\u6709\u76f8\u540c\u7684 <code>scheduler_info</code>(By <code>mp.Pipe()</code>)</li> </ul> <ol> <li>\u4ece <code>_launch_subprocesses()</code> \u4e2d\u83b7\u5f97 <code>tokenizer_manager</code> \u548c <code>scheduler_info</code>\uff0c\u76f4\u63a5\u5728\u4e3b\u8fdb\u7a0b\u542f\u52a8 HTTP \u670d\u52a1 TokenizerManager \u8fdb\u884c\u8bf7\u6c42\u7684\u63a5\u6536</li> </ol> <p>\ud83d\ude06\u73b0\u5728\uff0cTokenizer \u8fdb\u7a0b\uff0cScheduler \u8fdb\u7a0b\uff0cDetokenizer \u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7\u4e8b\u4ef6\u5faa\u73af\u4e0d\u505c\u9a71\u52a8\uff0c\u5b9e\u73b0\u7528\u6237\u8bf7\u6c42\u7684\u5904\u7406</p>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#scheduler","title":"Scheduler","text":"<p>\u5148\u521b\u5efa Scheduler \u5bf9\u8c61\uff0c\u5728 <code>__init__</code> \u4e2d\u8fdb\u884c TpModelWorker \u521d\u59cb\u5316\uff0cDraftWorker \u521d\u59cb\u5316\uff0cmemory pool \u548c memory cache \u521d\u59cb\u5316</p> <p>\u7136\u540e\u6839\u636e <code>server_args</code> \u4e0d\u540c\uff0c\u542f\u52a8\u4e0d\u540c\u7684\u4e8b\u4ef6\u5faa\u73af</p> Python<pre><code>if disaggregation_mode == DisaggregationMode.NULL:\n    if scheduler.enable_pdmux:\n        scheduler.event_loop_pdmux()\n    elif server_args.pp_size &gt; 1:\n        scheduler.event_loop_pp()\n    elif scheduler.enable_overlap:\n        scheduler.event_loop_overlap()\n    else:\n        scheduler.event_loop_normal()\n</code></pre>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#tpmodelworker-modelrunner","title":"TpModelWorker &amp; ModelRunner","text":"<p>TpModelWoker \u7684 <code>__init__()</code> \u4e2d\u8fdb\u884c\u4e86 ModelRunner \u7684\u521d\u59cb\u5316</p> <p>ModelRunner \u7684 <code>__init__()</code> \u8c03\u7528\u4e86 <code>self.init_torch_distributed()</code></p> <ul> <li>\u786e\u8ba4\u4f7f\u7528\u7684\u901a\u4fe1\u540e\u7aef\uff0c\u8fd9\u91cc\u4ee5 NCCL \u4e3a\u4f8b</li> <li>\u6700\u7ec8\u8c03\u7528\u00a0parallel_state.py\u00a0\u4e2d\u7684\u00a0<code>initialize_model_parallel()</code>\u3002</li> <li>\u521b\u5efa\u5168\u5c40\u7684\u00a0<code>_TP</code>\u00a0(Tensor Parallelism) \u8fdb\u7a0b\u7ec4\u3002\u5047\u8bbe TP=4\uff0cGPU 0-3 \u4f1a\u88ab\u5212\u5165\u540c\u4e00\u4e2a NCCL \u901a\u4fe1\u7ec4\u3002</li> <li>\u521b\u5efa\u5168\u5c40\u7684 <code>_PP</code>(Pipeline Parallelism) \u8fdb\u7a0b\u7ec4\uff0c\u4e3a\u6bcf\u4e2a\u6d41\u6c34\u7ebf stage \u521b\u5efa 1 \u4e2a\u72ec\u7acb\u7684\u901a\u4fe1 group</li> </ul> i ranks = range(i, 8, 4) PP Stage 0 0,4 [0,4] 1 1,5 [1,5] 2 2,6 [2,6] 3 3,7 [3,7]"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#detokenizer","title":"Detokenizer","text":"<p>\u5b9e\u9645\u4e0a detokenizer \u4f1a\u4e00\u76f4\u4e8b\u4ef6\u5faa\u73af\uff0c\u4ece Scheduler \u5f97\u5230 TODO\uff0c\u89e3\u7801\u6210 <code>BatchTokenIDOutput</code> \u4f20\u9012\u7ed9 Tokenizer \u5b50\u8fdb\u7a0b</p> Python<pre><code>def event_loop(self):\n\"\"\"The event loop that handles requests\"\"\"\n    while True:\n        recv_obj = self.recv_from_scheduler.recv_pyobj()\n        output = self._request_dispatcher(recv_obj)\n        if output is not None:\n            self.send_to_tokenizer.send_pyobj(output)\n</code></pre>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#parallel-linear-in-sglang","title":"Parallel Linear in SGLang","text":"<p>\u5728 SGLang\u4e2d\uff0c<code>Parallel Linear</code>\u00a0\u662f\u5b9e\u73b0 Tensor Parallel (TP) \u7684\u6838\u5fc3\u7ec4\u4ef6\u3002\u5b83\u901a\u8fc7\u5c06\u5de8\u5927\u7684\u6743\u91cd\u77e9\u9635\u5207\u5206\u5230\u591a\u4e2a GPU \u4e0a\uff0c\u4f7f\u5f97\u6bcf\u4e2a GPU \u53ea\u9700\u8ba1\u7b97\u4e00\u90e8\u5206\u6570\u636e\uff0c\u4ece\u800c\u51cf\u5c11\u663e\u5b58\u5360\u7528\u5e76\u52a0\u901f\u8ba1\u7b97\u3002</p> <p>\u4e3b\u8981\u6709\u4e24\u79cd\u5e76\u884c\u65b9\u5f0f\uff1aColumn Parallel (\u5217\u5e76\u884c)\u00a0\u548c\u00a0Row Parallel (\u884c\u5e76\u884c)\u3002\u901a\u5e38\u5b83\u4eec\u4f1a\u6210\u5bf9\u51fa\u73b0\uff08\u4f8b\u5982\u5728 MLP \u4e2d\uff1a\u5148 Column \u540e Row\uff09\uff0c\u4ee5\u6700\u5c0f\u5316\u901a\u4fe1\u5f00\u9500\u3002</p>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#columnparallellinear","title":"ColumnParallelLinear","text":"<p>\u6570\u5b66\u539f\u7406\uff1a \u5047\u8bbe\u7ebf\u6027\u5c42\u8fd0\u7b97\u4e3a \\(Y =XA\\) \u6211\u4eec\u5c06\u6743\u91cd\u77e9\u9635\u00a0\\(A\\)\u00a0\u6309\u5217\u5207\u5206\u4e3a\u00a0\\([A_1\u200b,A_2\u200b,...,A_p\u200b]\\)\u3002\\ \u6bcf\u4e2a GPU \u6301\u6709\u00a0\\(A_i\\)\u200b\u3002\\ \u8f93\u5165\u00a0\\(X\\)\u00a0\u662f\u5b8c\u6574\u7684\uff08\u590d\u5236\u5728\u6240\u6709 GPU \u4e0a\uff09\u3002\\ \u6bcf\u4e2a GPU \u8ba1\u7b97\u00a0\\(Y_i=XA_i\\)\u200b\u3002\\ \u8f93\u51fa\u00a0\\(Y\\)\u88ab \u5207\u5206\u4e3a \\([Y_1,Y_2,...,Y_p]\\)\uff0c\u5373\u6bcf\u4e2a GPU \u5f97\u5230\u8f93\u51fa\u5411\u91cf\u7684\u4e00\u90e8\u5206\u7279\u5f81\u3002</p> <p>\u5178\u578b\u5e94\u7528:</p> <ul> <li>Attention \u7684 QKV Projection (<code>QKVParallelLinear</code>)\u3002</li> <li>MLP \u7684 Gate / Up Projection (<code>MergedColumnParallelLinear</code>)\u3002</li> </ul>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#rowparallellinear","title":"RowParallelLinear","text":"<p>\u6570\u5b66\u539f\u7406\uff1a \u5047\u8bbe\u7ebf\u6027\u5c42\u8fd0\u7b97\u4e3a \\(Y =XA\\) \u3002\\ \u6211\u4eec\u5c06\u6743\u91cd\u77e9\u9635\u00a0\\(A\\)\u00a0\u6309\u884c\u5207\u5206\u4e3a $$\\begin{bmatrix} A_1 \\ A_2 \\ \\dots \\ A_p \\end{bmatrix} \\((\u200b\u200b\u200b\\ \u4e3a\u4e86\u5339\u914d\u77e9\u9635\u4e58\u6cd5\u89c4\u5219\uff0c\u8f93\u5165\u00a0\\(X\\)\u00a0\u4e5f\u5fc5\u987b\u6309\u5217\u5207\u5206\u4e3a\u00a0\\([X_1\u200b,X_2\u200b,...,X_p\u200b]\\)\uff08\u8fd9\u6b63\u597d\u662f ColumnParallelLinear \u7684\u8f93\u51fa\u683c\u5f0f\uff09\u3002\\ \u6bcf\u4e2a GPU \u8ba1\u7b97\u00a0\\(Y_i=XA_i\\)\u200b\u3002\u6ce8\u610f\uff0c\\)Y_i\\) \u7684\u5f62\u72b6\u4e0e\u6700\u7ec8\u8f93\u51fa\u00a0\\(Y\\)\u00a0\u76f8\u540c\uff0c\u4f46\u5b83\u53ea\u662f\u90e8\u5206\u548c\u3002\\ \u6700\u7ec8\u8f93\u51fa\u00a0\\(Y = \\\\sum Y_i\\)\u200b \uff0c\u9700\u8981\u4e00\u6b21\u00a0All-Reduce (Sum)\u00a0\u64cd\u4f5c</p> <p>\u5178\u578b\u5e94\u7528\uff1a</p> <ul> <li>Attention \u7684 Output Projection (<code>o_proj</code>)\u3002</li> <li>MLP \u7684 Down Projection (<code>down_proj</code>)\u3002</li> </ul>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#columnparallellinear-rowparallellinear","title":"ColumnParallelLinear + RowParallelLinear","text":"<p>\u8ba1\u7b97\u91cf\u51cf\u534a\uff0c\u591a\u4e86\u4e00\u6b21\u96c6\u7fa4\u901a\u4fe1\uff08allReduce\uff09\uff0c\u4e2d\u95f4\u503c\u7684\u5b58\u50a8\u5927\u5c0f\u51cf\u534a\uff0cInput, Weight \u51cf\u534a</p> <p></p>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#qwen2-model","title":"Qwen2 Model","text":"<p>\u6bcf\u4e2a GPU \u8fdb\u7a0b\u90fd\u4f1a\u5b9e\u4f8b\u5316\u4e00\u4e2a\u00a0<code>Qwen2ForCausalLM</code>\u00a0\u5bf9\u8c61\uff0c\u4f46\u6839\u636e\u5176\u6240\u5728\u7684\u00a0PP Rank\u00a0\u548c\u00a0TP Rank\uff0c\u52a0\u8f7d\u7684\u5185\u5bb9\u4e0d\u540c</p>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#embedding","title":"Embedding \u5c42","text":"<ul> <li>\u53ea\u6709\u00a0PP Rank 0\u00a0\u7684\u8fdb\u7a0b\u4f1a\u521d\u59cb\u5316 <code>VocabParallelEmbedding</code>(Row Parallel)\u3002</li> <li>TP \u5904\u7406: \u8bcd\u8868 (Vocab) \u88ab\u5207\u5206\u5230 TP \u7ec4\u7684\u5404\u4e2a GPU \u4e0a\u3002\u6bcf\u4e2a GPU \u53ea\u6301\u6709\u00a0<code>VocabSize / TP_Size</code>\u00a0\u5927\u5c0f\u7684\u6743\u91cd\u3002</li> <li>\u5176\u4ed6 PP Rank: \u521d\u59cb\u5316\u4e3a PPMissingLayer\u00a0(\u5360\u4f4d\u7b26\uff0c\u4e0d\u5360\u7528\u663e\u5b58)\u3002</li> </ul> Python<pre><code># perform weight tying for PP\nif self.pp_group.world_size &gt; 1 and config.tie_word_embeddings:\n    if self.pp_group.is_first_rank:\n        self.pp_group.send(self.model.embed_tokens.weight, dst=self.pp_group.last_rank)\n    elif self.pp_group.is_last_rank:\n        emb_token_weight = self.pp_group.recv(\n            size=(config.vocab_size, config.hidden_size),\n            dtype=next(self.model.parameters()).dtype,\n            src=self.pp_group.first_rank,\n        )\n        self.lm_head.weight.copy_(emb_token_weight)\n</code></pre>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#transformer-layers-pp-rank","title":"Transformer Layers (\u6240\u6709 PP Rank)","text":"<ul> <li>\u4f7f\u7528 <code>make_layers</code> \u8fdb\u884c\u6784\u5efa\u3002\u6240\u6709\u5c42\u90fd\u4f1a\u6784\u5efa\uff0c\u53ea\u6709\u672c\u5730\u5c42\u4f1a\u52a0\u8f7d\u6743\u91cd(\u5373\u5360\u7528\u663e\u5b58)</li> <li>PP \u5207\u5206: \u603b\u5c42\u6570\uff08\u4f8b\u5982 32 \u5c42\uff09\u4f1a\u88ab\u5747\u5300\u5206\u914d\u7ed9 PP \u7ec4\u7684\u5404\u4e2a Rank\u3002</li> <li>\u4f8b\u5982 PP=4\uff0cRank 0 \u8d1f\u8d23 0-7 \u5c42\uff0cRank 1 \u8d1f\u8d23 8-15 \u5c42\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002</li> <li>\u672c\u5730\u5c42: \u5f53\u524d Rank \u53ea\u5b9e\u9645\u521d\u59cb\u5316\u5b83\u8d1f\u8d23\u7684\u90a3\u90e8\u5206\u00a0<code>Qwen2DecoderLayer</code>\u3002</li> <li>\u7f3a\u5931\u5c42: \u4e0d\u5c5e\u4e8e\u5f53\u524d Rank \u7684\u5c42\u88ab\u521d\u59cb\u5316\u4e3a\u00a0<code>PPMissingLayer</code>\u3002</li> </ul> Python<pre><code>modules = torch.nn.ModuleList(\n    [PPMissingLayer(return_tuple=return_tuple) for _ in range(start_layer)]\n    + get_offloader().wrap_modules(\n        (\n            layer_fn(idx=idx, prefix=add_prefix(idx, prefix))\n            for idx in range(start_layer, end_layer)\n        ),\n        **(offloader_kwargs or {}),\n    )\n    + [\n        PPMissingLayer(return_tuple=return_tuple)\n        for _ in range(end_layer, num_hidden_layers)\n    ]\n)\n</code></pre> <p>Qwen2DecodeLayer \u5b9e\u9645\u4e0a\u4e3b\u8981\u662f\u7531 Qwen2Attention\uff0cQwen2MLP\uff0cRMSNorm \u7ec4\u6210\u7684</p> <ol> <li>Qwen2Attention:</li> </ol> <ul> <li>\u8f93\u5165 -&gt; \u4e2d\u95f4: \u4f7f\u7528\u00a0QKVParallelLinear\u00a0(\u7ee7\u627f\u81ea\u00a0ColumnParallelLinear)\u3002\u5c06\u8f93\u5165\u6295\u5f71\u5230 Q, K, V\u3002</li> <li>\u4e2d\u95f4 -&gt; \u8f93\u51fa: \u4f7f\u7528\u00a0RowParallelLinear\u3002\u5c06 Attention \u7684\u8f93\u51fa\u6295\u5f71\u56de hidden size\u3002</li> </ul> <ol> <li>Qwen2MLP:</li> </ol> <ul> <li>\u8f93\u5165 -&gt; \u4e2d\u95f4: \u4f7f\u7528\u00a0MergedColumnParallelLinear\u00a0(\u7ee7\u627f\u81ea\u00a0ColumnParallelLinear)\u3002\u5c06\u8f93\u5165\u6295\u5f71\u5230 Gate \u548c Up \u72b6\u6001\u3002</li> <li>\u4e2d\u95f4 -&gt; \u8f93\u51fa: \u4f7f\u7528\u00a0RowParallelLinear\u3002\u5c06\u6fc0\u6d3b\u540e\u7684\u72b6\u6001\u6295\u5f71\u56de hidden size\u3002</li> </ul>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#lmhead","title":"LMHead \u5c42","text":"<p>\u662f\u4e00\u4e2a\u00a0\u6309\u8bcd\u8868\u7ef4\u5ea6\u5207\u5206 (Column Parallel)\u00a0\u7684\u7ebf\u6027\u5c42</p> <ul> <li>\u53ea\u6709\u00a0\u6700\u540e\u4e00\u4e2a PP Rank\u00a0\u4f1a\u521d\u59cb\u5316\u00a0<code>RMSNorm</code>\u00a0\u548c\u00a0<code>ParallelLMHead</code>\u3002</li> <li>\u5176\u4ed6 PP Rank: \u521d\u59cb\u5316\u4e3a\u00a0PPMissingLayer\u3002</li> </ul>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#inference-process","title":"Inference Process","text":"<p>\u5f53\u4e00\u4e2a Batch \u7684\u8bf7\u6c42\u5230\u6765\u65f6\uff0c\u6570\u636e\u6d41\u4f1a\u5728 GPU \u4e4b\u95f4\u901a\u8fc7\u6d41\u6c34\u7ebf\u4f20\u9012\u3002</p>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#a","title":"A. \u8f93\u5165\u5904\u7406","text":"<ul> <li>\u8bf7\u6c42\u5206\u53d1\uff1a\u5f53\u8bf7\u6c42\u8fdb\u5165\u7cfb\u7edf\u65f6\uff0cScheduler \u4f1a\u5c06\u8bf7\u6c42\u5bf9\u8c61\uff08\u5305\u542b\u00a0<code>input_ids</code>\uff09\u5e7f\u64ad\u7ed9\u6240\u6709\u7684 Rank\uff08\u5305\u62ec\u4e0d\u540c\u7684 PP Rank \u548c TP Rank\uff09\u3002</li> <li>Batch \u6784\u5efa\uff1a\u6bcf\u4e2a Rank \u4e0a\u7684 Scheduler \u90fd\u4f1a\u72ec\u7acb\u6784\u5efa\u00a0<code>ForwardBatch</code>\u00a0\u5bf9\u8c61\u3002</li> </ul> <p>\u53ea\u6709 PP Rank 0 \u4f7f\u7528\u00a0<code>input_ids</code>\u00a0\u8fdb\u884c\u8ba1\u7b97\uff0c\u5bf9\u4e8e PP Rank &gt; 0 \u7684\u8282\u70b9\uff0c\u5b83\u4eec\u7684\u8f93\u5165\u6570\u636e\u4e0d\u662f\u6765\u81ea\u00a0<code>input_ids</code>\uff0c\u800c\u662f\u6765\u81ea\u4e0a\u4e00\u4e2a Rank \u901a\u8fc7 P2P \u901a\u4fe1\u53d1\u9001\u7684\u4e2d\u95f4\u7ed3\u679c\u3002</p> Python<pre><code>if self.pp_group.is_first_rank:\n    # Rank 0: \u771f\u6b63\u4f7f\u7528 input_ids \u8fdb\u884c Embedding \u67e5\u627e\n    if input_embeds is None:\n        hidden_states = self.embed_tokens(input_ids)\n    else:\n        hidden_states = input_embeds\n    residual = None\nelse:\n    # Rank &gt; 0: \u5ffd\u7565 input_ids\uff0c\u76f4\u63a5\u4f7f\u7528\u4e0a\u4e00\u4e2a\u9636\u6bb5\u4f20\u8fc7\u6765\u7684 hidden_states\n    assert pp_proxy_tensors is not None\n    hidden_states = pp_proxy_tensors[\"hidden_states\"]\n    residual = pp_proxy_tensors[\"residual\"]\n</code></pre>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#b-pipeline-forward","title":"B. \u6d41\u6c34\u7ebf\u4f20\u9012 (Pipeline Forward)","text":"<p>\u6d41\u7a0b\u6309 PP Rank \u987a\u5e8f\u4f9d\u6b21\u6267\u884c\uff1a</p> <ol> <li>PP Rank 0 (\u8d77\u59cb\u9636\u6bb5):</li> </ol> <ul> <li>Embedding:<ul> <li>\u8f93\u5165\u00a0<code>input_ids</code>\u3002</li> <li>\u6267\u884c\u00a0<code>VocabParallelEmbedding</code>\u3002</li> <li>\u6bcf\u4e2a GPU \u90fd\u5728\u5176\u672c\u5730\u7684\u5c0f\u6743\u91cd\u77e9\u9635\u4e0a\u8fdb\u884c\u67e5\u8868\u64cd\u4f5c\u3002</li> <li>\u5bf9\u4e8e\u5c5e\u4e8e\u8be5 GPU \u7684 Token\uff0c\u67e5\u51fa\u7684\u5411\u91cf\u662f\u6b63\u786e\u7684\u3002</li> <li>\u5bf9\u4e8e\u4e0d\u5c5e\u4e8e\u8be5 GPU \u7684 Token\uff0c\u67e5\u51fa\u7684\u5411\u91cf\u662f\u65e0\u610f\u4e49\u7684\uff08\u5783\u573e\u503c\uff09\u3002</li> <li>TP \u52a8\u4f5c: \u5404 TP Rank \u8ba1\u7b97\u90e8\u5206 Embedding\uff0c\u7136\u540e\u901a\u8fc7\u00a0AllReduce\u00a0\u805a\u5408\uff0c\u4f7f\u5f97\u6bcf\u4e2a TP Rank \u83b7\u5f97\u5b8c\u6574\u7684 Embedding \u5411\u91cf\u3002 Python<pre><code>output_parallel = tensor_model_parallel_all_reduce(output_parallel)\n</code></pre></li> </ul> </li> <li>Layers (0 ~ N):<ul> <li>\u987a\u5e8f\u6267\u884c\u5206\u914d\u7ed9\u8be5 Rank \u7684 Transformer \u5c42\u3002</li> </ul> </li> <li>\u8f93\u51fa: \u5c06\u8ba1\u7b97\u51fa\u7684\u00a0<code>hidden_states</code>\u00a0\u53d1\u9001\u7ed9 PP Rank 1\u3002</li> </ul> <ol> <li>PP Rank i (\u4e2d\u95f4\u9636\u6bb5):</li> </ol> <ul> <li>\u8f93\u5165: \u901a\u8fc7 P2P\u00a0<code>recv</code>\u00a0\u63a5\u6536\u4e0a\u4e00\u7ea7 (Rank i-1) \u53d1\u6765\u7684\u00a0<code>hidden_states</code>\u3002</li> <li>Layers (M ~ K):<ul> <li>\u987a\u5e8f\u6267\u884c\u5206\u914d\u7ed9\u8be5 Rank \u7684 Transformer \u5c42\u3002</li> </ul> </li> <li>\u8f93\u51fa: \u5c06\u66f4\u65b0\u540e\u7684\u00a0<code>hidden_states</code>\u00a0\u53d1\u9001\u7ed9\u4e0b\u4e00\u7ea7 (Rank i+1)\u3002</li> </ul> <ol> <li>PP Rank Last (\u6700\u7ec8\u9636\u6bb5):</li> </ol> <ul> <li>\u8f93\u5165: \u63a5\u6536\u4e0a\u4e00\u7ea7\u53d1\u6765\u7684\u00a0<code>hidden_states</code>\u3002</li> <li>Layers (X ~ End): \u6267\u884c\u5269\u4f59\u7684 Transformer \u5c42\u3002</li> <li>Final Norm: \u6267\u884c\u00a0<code>RMSNorm</code>\u3002</li> <li>Logits:<ul> <li>\u6267\u884c\u00a0<code>ParallelLMHead</code>\u3002</li> <li>TP \u52a8\u4f5c: \u7c7b\u4f3c\u4e8e Embedding\uff0c\u8f93\u51fa Logits \u901a\u5e38\u9700\u8981\u805a\u5408\uff08\u6216\u8005\u5728\u91c7\u6837\u65f6\u5904\u7406\uff09\u3002</li> </ul> </li> <li>\u91c7\u6837: \u8ba1\u7b97\u6982\u7387\u5e76\u91c7\u6837\u4e0b\u4e00\u4e2a Token\u3002</li> </ul>"},{"location":"notes/sglang/SGLang%20%E4%B8%AD%E7%9A%84%20TP%20%2B%20PP/#c-inside-a-layer-with-tp","title":"C. \u5c42\u5185\u5e76\u884c\u7ec6\u8282 (Inside a Layer with TP)","text":"<p>\u5728\u6bcf\u4e00\u4e2a Transformer \u5c42\u5185\u90e8\uff0cTP \u662f\u8fd9\u6837\u5de5\u4f5c\u7684\uff1a</p> <ol> <li>Qwen2Attention:</li> </ol> <ul> <li>\u8f93\u5165: \u5b8c\u6574\u7684\u00a0<code>hidden_states</code>\u00a0(\u6240\u6709 TP Rank \u90fd\u6709\u526f\u672c)\u3002</li> <li>QKV Proj (Column Parallel): \u6bcf\u4e2a TP Rank \u53ea\u8ba1\u7b97\u4e00\u90e8\u5206 Head \u7684 Q/K/V\u3002</li> <li>Attention \u8ba1\u7b97: \u6bcf\u4e2a Rank \u72ec\u7acb\u8ba1\u7b97\u81ea\u5df1\u90a3\u90e8\u5206 Head \u7684 Attention\u3002</li> <li>Output Proj (Row Parallel): \u6bcf\u4e2a Rank \u8ba1\u7b97\u90e8\u5206\u8f93\u51fa\u3002</li> <li>AllReduce: \u5728 Output Proj \u4e4b\u540e\uff0c\u6267\u884c\u4e00\u6b21\u00a0AllReduce (Sum)\uff0c\u8ba9\u6240\u6709 TP Rank \u91cd\u65b0\u83b7\u5f97\u5b8c\u6574\u7684 Attention \u8f93\u51fa\uff0c\u5e76\u52a0\u5230 Residual \u4e0a\u3002</li> </ul> <ol> <li>Qwen2MLP:</li> </ol> <ul> <li>Gate/Up Proj (Column Parallel): \u8f93\u5165\u5b8c\u6574\uff0c\u8f93\u51fa\u88ab\u5207\u5206\uff08\u6bcf\u4e2a Rank \u8ba1\u7b97\u4e00\u90e8\u5206\u4e2d\u95f4\u7279\u5f81\uff09\u3002</li> <li>Activation: \u5728\u5207\u5206\u7684\u6570\u636e\u4e0a\u72ec\u7acb\u6267\u884c (\u5982 SiLU)\u3002</li> <li>Down Proj (Row Parallel): \u8f93\u5165\u662f\u5217\u5207\u5206\u7684\uff08\u6765\u81ea Activation \u7684\u8f93\u51fa\uff09\uff0c\u6743\u91cd\u6309\u884c\u5207\u5206\u3002\u6bcf\u4e2a Rank \u8ba1\u7b97\u51fa\u90e8\u5206\u8f93\u51fa\u3002</li> <li>AllReduce: \u6267\u884c\u00a0AllReduce (Sum)\uff0c\u805a\u5408\u6700\u7ec8\u7ed3\u679c\u3002 </li> </ul>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/","title":"\ud83d\udea7 SGLang \u4e2d\u7684 Speculative Decoding","text":"2025-12-132025-12-13 <p>title: SGlang \u4e2d\u7684 Sepeculative Decoding tags:</p> <ul> <li>LLMInference   date: 2025/11/4</li> </ul>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#sglang-sepeculative-decoding","title":"SGlang \u4e2d\u7684 Sepeculative Decoding","text":"<p> \u7ea6 1554 \u4e2a\u5b57  14 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 8 \u5206\u949f</p> <p>\u5728\u6b63\u5f0f\u8fdb\u5165 SGLang \u6e90\u7801\u524d\uff0c\u6211\u4eec\u9700\u8981\u77e5\u9053\u4e3a\u4ec0\u4e48\u6211\u4eec\u9700\u8981 speculative decoding \u4ee5\u53ca\u4ec0\u4e48\u662f speculative decoding\u3002\u6709\u4e86\u8fd9\u4e9b\u8ba4\u8bc6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6df1\u5165\u6e90\u7801\u6765\u4e86\u89e3 SGLang \u662f\u5982\u4f55\u5c06 speculative decoding \u4e0e scheduler \u96c6\u6210\u8d77\u6765\u7684</p> <p>\u8fd9\u91cc\u5148\u5927\u6982\u7ed9\u4e00\u4e0b speculative decoding \u7684\u793a\u610f\u56fe</p> <p></p>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#why-speculative-decoding","title":"Why Speculative Decoding","text":"<p>LLM \u662f\u81ea\u56de\u5f52\uff08autoregressive\uff09\u7684\uff1a\u751f\u6210\u4e00\u4e2a token \u8981\u4f9d\u8d56\u524d\u9762\u7684\u6240\u6709 token\u3002</p> <p>\u6362\u53e5\u8bdd\u8bf4\uff0c\u5b83\u6bcf\u6b21\u53ea\u80fd\u751f\u6210\u4e00\u4e2a token\uff0c\u518d\u628a\u7ed3\u679c\u53cd\u9988\u7ed9\u6a21\u578b\u7ee7\u7eed\u4e0b\u4e00\u6b21\u3002</p> <p>\u5373\u4f7f GPU \u541e\u5410\u5f88\u9ad8\uff0c\u8fd9\u79cd \u201ctoken-by-token\u201d \u63a8\u7406\u65b9\u5f0f\u4f9d\u7136\u6210\u4e3a\u74f6\u9888\u3002\u6240\u4ee5\u7814\u7a76\u4eba\u5458\u5c06\u76ee\u5149\u653e\u5728\u4e86 decoding algorithms \u4e0a\uff0c\u63d0\u51fa\u4e86 speculative decoding \u8fd9\u79cd\u5e76\u884c\u9a8c\u8bc1\u7b56\u7565\uff1a</p> <ul> <li>\u7528\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u6a21\u578b\uff08\u6216\u673a\u5236\uff09\u6765\u201c\u9884\u5224\u201d\u5927\u6a21\u578b\u7684\u8f93\u51fa\uff0c\u7136\u540e\u8ba9\u5927\u6a21\u578b\u4e00\u6b21\u9a8c\u8bc1\u4e00\u6574\u6bb5\uff08chunk\uff09 \u800c\u4e0d\u662f\u4e00\u4e2a token\u3002</li> <li>\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u80fd\u7528\u5c11\u91cf\u7684\u6a21\u578b\u8c03\u7528\uff0c\u751f\u6210\u66f4\u591a token\u3002</li> </ul> <p>\u5728\u6574\u4e2a\u6295\u673a\u91c7\u6837\u7684\u6d41\u7a0b\u4e2d\uff0c\u5047\u8bbe\u8f7b\u91cf LLM \u751f\u6210 Draft Tokens \u7684\u5f00\u9500\u4e3a \u00a0\\(p\\)\u00a0\uff0c\u539f\u59cb LLM \u9a8c\u8bc1 &amp; Next Token \u751f\u6210\u7684\u5f00\u9500\u8fd1\u4f3c\u4e3a 1 \uff0c\u90a3\u4e48\u6295\u673a\u91c7\u6837\u5728\u63a5\u53d7 Tokens \u6570\u5927\u4e8e \u00a0\\(1 + p\\)\u00a0 \u7684\u60c5\u51b5\u4e0b\u624d\u6709\u6027\u80fd\u6536\u76ca\uff0c\u5e76\u4e14\u968f\u7740\u63a5\u53d7\u7684 Tokens \u6570\u589e\u52a0\u800c\u6027\u80fd\u6536\u76ca\u8d8a\u5927\u3002\u6240\u4ee5\u6295\u673a\u91c7\u6837\u8981\u60f3\u83b7\u5f97\u6027\u80fd\u6536\u76ca\uff0c\u6838\u5fc3\u8981\u89e3\u51b3\u4ee5\u4e0b\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ol> <li>\u5982\u4f55\u964d\u4f4e\u6295\u673a\u91c7\u6837\u7684 overhead\uff1f</li> <li>\u5982\u4f55\u63d0\u5347 Verify \u9636\u6bb5\u7684\u63a5\u53d7\u7387\uff1f</li> </ol>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#what-is-speculative-decoding","title":"What is Speculative Decoding","text":"<p>\u9996\u5148\u6211\u4eec\u4f1a\u4ecb\u7ecd\u4ec0\u4e48\u662f\u63a8\u6d4b\u89e3\u7801\uff0c\u7136\u540e\u6211\u4eec\u4f1a\u6982\u8ff0\u4e0b\u63a8\u6d4b\u89e3\u7801\u6280\u672f\u7684\u53d1\u5c55\u5386\u7a0b</p> <p>\u73b0\u5728\u63a8\u6d4b\u89e3\u7801\u6d41\u7a0b\u57fa\u672c\u9075\u5faa <code>draft-then-verify</code> \u7684\u8303\u5f0f</p> <ul> <li>\u4f7f\u7528\u66f4\u9ad8\u6548\u7684\u6a21\u578b \\(M_q\\) \u751f\u6210 \u03b3 \u2208 \u2124\u207a \u4e2a\u5019\u9009 token\uff1b</li> <li>\u7136\u540e\u4f7f\u7528\u76ee\u6807\u6a21\u578b \\(M_p\\)\u200b \u5e76\u884c Verify \u8fd9\u4e9b\u5019\u9009\u6837\u672c\u53ca\u5176\u5728 \\(M_q\\) \u4e2d\u7684\u6982\u7387\uff0c \u5e76\u63a5\u53d7\u6240\u6709\u80fd\u4f7f\u5206\u5e03\u4e0e \\(M_p\\) \u4e00\u81f4\u7684\u5019\u9009\uff1b <p>\u51b3\u5b9a\u88ab\u63a5\u53d7\u7684\u6570\u91cf n\uff08\u7528\u968f\u673a\u6570\u8fdb\u884c\u62d2\u7edd\u91c7\u6837\uff09</p> </li> <li>\u5bf9\u7b2c\u4e00\u4e2a\u88ab\u62d2\u7edd\u7684\u5019\u9009\uff0c\u4ece\u4e00\u4e2a\u8c03\u6574\u540e\u7684\u5206\u5e03\u4e2d\u91cd\u65b0\u91c7\u6837\uff1b\u5982\u679c\u6240\u6709\u5019\u9009\u90fd\u88ab\u63a5\u53d7\uff0c\u5219\u518d\u91c7\u6837\u4e00\u4e2a\u989d\u5916\u7684 token\u3002 <p>\u4f46\u82e5 \\(n &lt; \\\\gamma\\)\uff08\u8bf4\u660e\u5728\u7b2c n+1 \u6b65\u7684\u8349\u7a3f \\(x\\_{n+1}\\)\u200b \u88ab\u62d2\u7edd\uff09\uff0c\u6211\u4eec\u9700\u8981\u4ece \\(p\\_{n+1}\\) \u4e2d\u53bb\u6389\u90a3\u4e9b\u5df2\u7ecf\u7531 \\(q\\_{n+1}\\)\u200b \u8986\u76d6\u6389\u7684\u8d28\u91cf\uff0c\u5e76\u5bf9\u5269\u4f59\u90e8\u5206\u91cd\u65b0\u6807\u51c6\u5316</p> </li> </ul> <p></p>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#_1","title":"\u53d1\u5c55\u5386\u7a0b","text":""},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#speculative-decoding-leviathan-et-al-2023-google","title":"Speculative Decoding (Leviathan et al., 2023, Google)","text":"<ul> <li>\ud83d\udcc4 \u8bba\u6587: \u201cFast Inference from Transformers via Speculative Decoding\u201d</li> <li>\ud83d\udccd \u9996\u6b21\u63d0\u51fa\u8be5\u65b9\u6cd5\uff0c\u601d\u8def\uff1a</li> <li>\u7528\u4e00\u4e2a\u5c0f\u6a21\u578b\uff08draft model\uff09\u751f\u6210\u591a\u4e2a\u5019\u9009 token\uff1b</li> <li>\u7528\u5927\u6a21\u578b\uff08target model\uff09\u9a8c\u8bc1\u5176\u4e2d\u7684\u4e00\u90e8\u5206\uff1b</li> <li>\u82e5\u9a8c\u8bc1\u901a\u8fc7\uff0c\u5219\u4e00\u6b21\u63d0\u4ea4\u591a\u4e2a token\uff0c\u51cf\u5c11\u5927\u6a21\u578b\u8c03\u7528\u6b21\u6570\u3002 </li> </ul>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#medusa","title":"Medusa","text":"<ul> <li>\ud83d\udcc4 \u201cMEDUSA: Simple LLM Inference Acceleration Framework with Multiple Decoding Heads\u201d</li> </ul> <ul> <li> <p>\ud83d\udca1 \u8d21\u732e\uff1a</p> </li> <li> <p>\u4e0d\u662f\u5355\u72ec\u7684\u5c0f\u6a21\u578b\uff0c\u800c\u662f \u5728\u5927\u6a21\u578b decoder \u4e0a\u76f4\u63a5\u52a0\u591a\u4e2a\u9884\u6d4b\u5934\uff1b</p> </li> <li>\u6bcf\u4e2a\u5934\u9884\u6d4b\u63a5\u4e0b\u6765\u7b2c 1\u30012\u30013\u2026 \u4e2a token\uff1b</li> <li>\u53ea\u9700\u4e00\u6b21\u524d\u5411\u4f20\u64ad\u5373\u53ef\u9a8c\u8bc1\u591a\u4e2a\u5019\u9009\u3002<ul> <li>\u4e3a\u4e86\u52a0\u901f\u4e0e\u8ba1\u7b97\u4ee3\u4ef7\u4e4b\u95f4\u53d6\u5f97\u5e73\u8861\uff0c\u5f15\u5165\u4e86\u4e00\u79cd \u6811\u72b6\u7ed3\u6784\u7684\u6ce8\u610f\u529b\u673a\u5236\uff08tree-structured attention\uff09\uff0c\u53ef\u4ee5\u5e76\u884c\u5904\u7406\u591a\u4e2a\u5019\u9009\u5e8f\u5217</li> <li>Tree Mask\uff1a\u6bcf\u4e2a token \u53ea\u80fd\u770b\u5230\u6765\u81ea\u540c\u4e00\u6761\u5019\u9009\u5e8f\u5217\uff08continuation\uff09\u7684\u5386\u53f2 token\uff0c\u4e0d\u80fd\u201c\u8d8a\u652f\u8bbf\u95ee\u201d\u5176\u4ed6\u5019\u9009\u7684 token\u3002 </li> </ul> </li> </ul>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#lookahead-decoding","title":"Lookahead Decoding","text":"<ul> <li> <p>\ud83d\udcc4 \u201cLookahead: An Inference Acceleration Framework for Large Language Model with Lossles\u201d</p> </li> <li> <p>\u5c42\u6b21\u5316\u591a\u5206\u652f\u8349\u7a3f\u7b56\u7565 (Hierarchical Multi-Branch Draft Strategy)</p> </li> </ul> Text Only<pre><code>\u5229\u7528**\u5171\u540c\u7684\u524d\u7f00\u6807\u8bb0**\u5c06\u591a\u4e2a\u9884\u6d4b\u7684\u8349\u7a3f\u5e8f\u5217\uff08\u5206\u652f\uff09\u8fdb\u884c**\u5408\u5e76\u548c\u538b\u7f29**\n</code></pre> <ul> <li> <p>\u57fa\u4e8e Trie \u6811\u7684\u8349\u7a3f\u68c0\u7d22\u548c\u7ba1\u7406 (Trie-tree-based Retrieval and Management)</p> </li> <li> <p>Trie \u6811\u5b58\u50a8\u4e86\u8f93\u5165\u63d0\u793a (Prompt) \u548c\u5df2\u751f\u6210\u54cd\u5e94 (Generated response) \u4e2d\u51fa\u73b0\u7684 n-gram \u6807\u8bb0\u5e8f\u5217\uff08\u5373\u5206\u652f\uff09\u3002</p> </li> <li>\u5f15\u5165\u4e86 \u201c\u751f\u6210\u5206\u652f\u63d2\u5165\u201d (Generated branch Inserting) \u673a\u5236\uff0c\u80fd\u591f\u52a8\u6001\u5730 (on-the-fly) \u5c06\u751f\u6210\u7684\u91cd\u590d\u5e8f\u5217\u653e\u5165 Trie \u6811\u4e2d\uff0c\u4ece\u800c\u5229\u7528\u8f93\u51fa\u4e2d\u7684\u91cd\u590d\u6a21\u5f0f\u8fdb\u884c\u52a0\u901f\u3002</li> <li>\u901a\u8fc7\u5206\u652f\u6d88\u9664\u548c\u8282\u70b9\u4fee\u526a\u7b56\u7565\u6765\u4fdd\u6301 Trie \u6811\u7684\u9ad8\u6548\u6027\uff0c\u63a7\u5236\u5185\u5b58\u6d88\u8017\u3002</li> </ul> <p></p>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#eagle","title":"EAGLE","text":"<ul> <li> <p>\ud83d\udcc4 \u201cEAGLE: Speculative Sampling Requires Rethinking Feature Uncertainty\u201d</p> </li> <li> <p>\ud83d\udca1 \u521b\u65b0\uff1a</p> </li> <li> <p>\u6d88\u9664\u4e0d\u786e\u5b9a\u6027\uff1aEAGLE \u5728\u8349\u7a3f\u6a21\u578b\u7684\u8f93\u5165\u4e2d\u52a0\u5165\u524d\u4e00\u6b65\u91c7\u6837\u5f97\u5230\u7684 token \u5e8f\u5217\uff08\u5373 shifted token\uff09</p> <p>Medusa \u7528\u591a\u4e2a\u201c\u5206\u5934\uff08heads\uff09\u201d\u9884\u6d4b\u672a\u6765 token\uff08\u5982 +1, +2, +3 \u6b65\uff09\u3002\u4f46\u7531\u4e8e\u751f\u6210\u8fc7\u7a0b\u5177\u6709\u968f\u673a\u6027\uff08\u91c7\u6837\u5e26\u6765\u7684\u4e0d\u786e\u5b9a\u6027\uff09\uff0c\u8fd9\u4e9b\u672a\u6765 token \u53ef\u80fd\u6839\u672c\u4e0d\u662f\u552f\u4e00\u786e\u5b9a\u7684\u76ee\u6807\u5e8f\u5217\u2014\u2014\u8fd9\u5bfc\u81f4 draft head \u5b66\u4e0d\u5230\u7a33\u5b9a\u7684\u6620\u5c04\u3002</p> <p></p> <p>\u5b83\u4f7f\u7528 feature + shifted token \u7684\u7ec4\u5408\uff0c\u800c\u4e0d\u662f\u4ec5\u5728 token \u5c42\u9762\u9884\u6d4b\u3002</p> <p></p> </li> <li> <p>EAGLE \u7684\u751f\u6210\u5faa\u73af\uff1a   $$   (feature_seq,token_seq)\u2192next_feature\u2192next_token\u2192concat\u2192next_step   $$</p> </li> <li> <p>Tree Attention\uff1a\u5efa\u4e00\u4e2a\u6811\u5f62\u8349\u7a3f\u7ed3\u6784\uff0c\u53ea\u9700 m \u6b21\u524d\u5411\u8ba1\u7b97\u5373\u53ef\u751f\u6210\u6df1\u5ea6\u4e3a m\u3001\u8d85\u8fc7 m \u4e2a token \u7684\u8349\u7a3f\u6811\u3002</p> </li> </ul> <p></p>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#eagle-2","title":"EAGLE-2","text":"<ul> <li> <p>\ud83d\udcc4 \u201cEAGLE-2: Faster Inference of Language Models with Dynamic Draft Trees\u201d</p> </li> <li> <p>\u4e24\u4e2a\u89c2\u5bdf\uff1a</p> </li> <li> <p>\u63a5\u53d7\u7387\u9664\u4e86\u4e0e Token \u6240\u5728\u4f4d\u7f6e\u76f8\u5173\u4ee5\u5916\uff08\u5728\u6811\u4e2d\u6240\u5904\u7684\u4f4d\u7f6e\uff09\uff0c\u8fd8\u548c\u4e0a\u6587\u76f8\u5173\uff08\u6811\u4e2d\u7684\u7956\u5b97\u8282\u70b9\uff09\u3002     &gt; </p>Text Only<pre><code>P3\u3001P4 \u548c P5\u3001P6 \u867d\u7136\u90fd\u662f\u540c\u4e00\u5c42\u7684\u8282\u70b9\uff08\u5373\u540c\u4e00\u4e2a Step \u7684 Draft Tokens\uff09\uff0c\u4f46\u63a5\u6536\u7387\u4e0a P3\u3001P4 \u666e\u904d\u9ad8\u4e8eP5\u3001P6 \u8282\u70b9\uff0c**\u4e00\u4e2a\u91cd\u8981\u7684\u539f\u56e0\u662f P3\u3001P4 \u7684\u7236\u8282\u70b9\u4e3a P1\uff0c\u5176\u6982\u7387\u9ad8\u4e8e P5\u3001P6 \u8282\u70b9\u7684\u7236\u8282\u70b9 P2\u3002P3\u3001P4\u7684\u6982\u7387\u751a\u81f3\u666e\u904d\u9ad8\u4e8e P2**\u8fd9\u66f4\u52a0\u8bf4\u660e\u5728\u751f\u6210 Draft \u6811\u7684\u65f6\u5019\uff0c\u91c7\u7528\u9759\u6001 Draft \u6811\u5e76\u4e0d\u662f\u4e00\u4e2a\u6700\u4f18\u9009\u62e9\uff0c\u66f4\u5e94\u8be5\u9009\u62e9\u52a8\u6001 Draft \u6811\u3002\n</code></pre><p></p> </li> </ul> <p></p> <ul> <li>\u539f\u59cb LLM \u81ea\u56de\u5f52\u751f\u6210\u7684 Token \u6982\u7387\u5206\u5e03\u8868\u793a Token \u63a5\u6536\u6982\u7387\u3002Eagle \u7684 Draft \u6a21\u578b\u751f\u6210\u7684 Draft Tokens \u6982\u7387\u5206\u5e03\u4e0e Token \u63a5\u6536\u7387\u5206\u5e03\u63a5\u8fd1\u3002\u4e0b\u56fe\u5c55\u793a\u4e86 Draft Tokens \u751f\u6210\u6982\u7387\u548c Token \u63a5\u6536\u7387\u7684\u5206\u5e03\u56fe\uff0c\u53ef\u4ee5\u770b\u51fa\u5206\u5e03\u5f88\u63a5\u8fd1\uff0c\u53ef\u4ee5\u901a\u8fc7 Draft Tokens \u751f\u6210\u6982\u7387\u9884\u4f30 Token \u7684\u63a5\u6536\u7387\u3002</li> </ul> <p></p> <ul> <li> <p>\ud83d\udca1 \u521b\u65b0\uff1a</p> </li> <li> <p>Context-Aware Dynamic Draft Tree\uff1aEAGLE-2 \u4e0d\u4fee\u6539 draft \u6a21\u578b\u7684\u8bad\u7ec3\u4e0e\u63a8\u7406\u65b9\u5f0f\uff0c\u4e5f\u4e0d\u6539\u53d8\u9a8c\u8bc1\u9636\u6bb5\u3002\u5b83\u7684\u6539\u8fdb\u96c6\u4e2d\u5728\u4e24\u4e2a\u65b9\u9762\uff1a</p> <ol> <li>\u5982\u4f55\u6269\u5c55\u8349\u7a3f\u6811\uff1b</li> <li>\u5982\u4f55\u5bf9\u8349\u7a3f token \u8fdb\u884c\u91cd\u65b0\u6392\u5e8f</li> </ol> </li> <li> <p>Expand \u9636\u6bb5\uff1a\u4ece\u5f53\u524d\u5c42\u9009\u62e9 \u5168\u5c40\u63a5\u53d7\u6982\u7387\uff08global acceptance probability\uff09\u6700\u9ad8\u7684\u524d k \u4e2a token \u8fdb\u884c\u6269\u5c55\u3002</p> <ul> <li>\u4e00\u4e2a token \u7684\u5168\u5c40\u63a5\u53d7\u6982\u7387\u662f\u5b83\u4ece\u6839\u8282\u70b9\u5230\u8be5\u8282\u70b9\u8def\u5f84\u4e0a\u6240\u6709 token \u7684\u63a5\u53d7\u6982\u7387\u7684\u4e58\u79ef\uff1a\\(\\(V_i = \\\\prod\\_{t_j \\\\in \\\\text{Path(root, }t_i\\\\text{)}} p_j \\\\approx \\\\prod c_j\u200b\\)\\)\uff0c\u5176\u4e2d \\(c_j\\) \u662f draft \u6a21\u578b\u7684\u7f6e\u4fe1\u5ea6\uff08confidence score\uff09\u3002</li> </ul> </li> </ul> <p></p> <ul> <li> <p>ReRank \u9636\u6bb5\uff1a\u4e0d\u4f1a\u76f4\u63a5\u4f7f\u7528\u6269\u5c55\u9636\u6bb5\u7684\u7ed3\u679c\uff0c\u800c\u662f\u5bf9\u6240\u6709\u8349\u7a3f token \u91cd\u65b0\u6392\u5e8f\uff0c\u9009\u51fa\u5168\u5c40 top-m \u7684\u8282\u70b9\u3002</p> <p>\u6269\u5c55\u9636\u6bb5\u7684\u76ee\u6807\u662f\u52a0\u6df1\u8349\u7a3f\u6811\u3002\u7136\u800c\uff0c\u7531\u4e8e\u63a5\u53d7\u7387\u5728 0\u20131 \u4e4b\u95f4\uff0c\u8d8a\u6df1\u7684 token \u5176\u503c\u8d8a\u5c0f\u3002\u4e00\u4e9b\u6d45\u5c42\u672a\u6269\u5c55\u8282\u70b9\u53ef\u80fd\u6bd4\u6df1\u5c42\u8282\u70b9\u66f4\u6709\u4ef7\u503c\u3002</p> <ul> <li> <p>\u5bf9\u4e8e\u503c\u76f8\u540c\u7684\u8282\u70b9\uff0c\u4f18\u5148\u9009\u62e9\u6d45\u5c42\u8282\u70b9\uff0c\u59cb\u7ec8\u4fdd\u6301\u7236\u8282\u70b9\u5728\u5b50\u8282\u70b9\u4e4b\u524d\u88ab\u9009\u4e2d\u3002 \u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1 top-m \u8282\u70b9\u4ecd\u6784\u6210\u4e00\u68f5\u8fde\u901a\u6811\u3002</p> </li> <li> <p>Tree Mask\uff1a\u628a\u8fd9\u4e9b\u9009\u4e2d\u7684 token \u62c9\u5e73\u6210\u4e00\u7ef4\u5e8f\u5217\uff0c\u9001\u5165\u4e3b\u6a21\u578b\u8fdb\u884c\u9a8c\u8bc1\u9636\u6bb5\u3002\u4e3a\u4e86\u4e0e\u6807\u51c6\u81ea\u56de\u5f52\u89e3\u7801\u4fdd\u6301\u4e00\u81f4\uff0c\u6211\u4eec\u9700\u8981\u8c03\u6574\u6ce8\u610f\u529b\u63a9\u7801\u3002\u4e0d\u540c\u5206\u652f\u7684 token \u4e0d\u5e94\u4e92\u76f8\u53ef\u89c1\uff0c\u56e0\u6b64\u6ce8\u610f\u529b\u63a9\u7801\u9700\u6839\u636e\u6811\u7ed3\u6784\u4fee\u6539\uff0c\u4f7f\u6bcf\u4e2a token \u4ec5\u80fd\u770b\u5230\u5b83\u7684\u7956\u5148\u8282\u70b9\u3002</p> </li> </ul> </li> </ul> <p></p>"},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#eagle-in-sglang","title":"Eagle in SGLang","text":""},{"location":"notes/sglang/SGlang%20%E4%B8%AD%E7%9A%84%20Speculative%20Decoding/#reference","title":"Reference","text":"<p>[^spec1]: Clover: Regressive Lightweight Speculative Decoding with Sequential Knowledge</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/","title":"\u4e00\u6761 Request \u5728 SGLang \u7684\u524d\u4e16\u4eca\u751f","text":"2025-12-132025-12-13 <p>title: \u4e00\u6761 Request \u5728 SGLang \u7684\u524d\u4e16\u4eca\u751f tags:</p> <ul> <li>LLMInference   created: 2025-11-25   ai_summary_lang: zh   include:</li> <li>ai-summary   ai-summary-config:   api: \"tongyi\"   model: \"qwen-turbo\"   prompt: \"\u5e2e\u6211\u628a\u8fd9\u7bc7\u6587\u7ae0\u603b\u7ed3\u4e3a500\u5b57\u4ee5\u5185\u7684\u6458\u8981\uff1a\"</li> </ul>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#request-sglang","title":"\u4e00\u6761 Request \u5728 SGLang \u7684\u524d\u4e16\u4eca\u751f","text":"<p> \u7ea6 3712 \u4e2a\u5b57  60 \u884c\u4ee3\u7801  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 19 \u5206\u949f</p> <p>Note</p> <p>\u8fd9\u91cc\u6211\u4eec\u8bbe\u7f6e\u4e00\u4e9b\u53c2\u6570\u66f4\u63a5\u8fd1\u771f\u5b9e\u7684\u63a8\u7406\u573a\u666f\uff0c\u542f\u7528 <code>mixed chunked</code> \u53c2\u6570\uff0cprefill \u5f00\u542f <code>chunked_prefill</code>\uff0ccache \u4f7f\u7528 <code>page_size &gt; 1</code>\uff0cscheduler \u4f7f\u7528 <code>overlap scheduler</code></p> <p>Continuous Batching \u7684\u91cd\u70b9\u5728 Scheduler[^sglang]\uff0cPage Attention \u91cd\u70b9\u5728\u7b97\u5b50\u5c42\u4ee5\u53ca\u5bf9\u5e94\u7684\u5c01\u88c5\uff0c\u6240\u4ee5\u6211\u4eec\u4e3b\u8981\u5173\u6ce8\u8fd9\u4e24\u90e8\u5206\u3002\u5728\u5f00\u59cb\u524d\uff0c\u6211\u4eec\u63d0\u51fa\u51e0\u4e2a\u95ee\u9898\uff0c\u5728\u6211\u4eec\u68b3\u7406\u5b8c\u6574\u4e2a\u4ee3\u7801\u6d41\u7a0b\u540e\u518d\u6765\u56de\u7b54\uff1a</p> <ol> <li>SGLang \u8c03\u5ea6\u7b56\u7565\u662f prefill \u4f18\u5148\u5417\uff1f</li> <li>prefill \u548c decode \u5982\u4f55\u5728\u4e00\u4e2a batch \u4e2d\u8fdb\u884c\u63a8\u7406\uff1f</li> <li>\u4e00\u4e2a batch \u4e2d\u53ef\u4ee5\u6709\u591a\u4e2a chunked prefill \u5417\uff1f</li> <li>chunked prefill \u5982\u4f55\u5904\u7406 KV Cache\uff1f</li> </ol> <p>\u73b0\u5728\u6211\u4eec\u8003\u8651\u4e0b\u6574\u4e2a\u7cfb\u7edf\u4e2d\u53ef\u80fd\u540c\u65f6\u51fa\u73b0\u7684\u8bf7\u6c42\u7c7b\u578b\uff1a</p> <ul> <li>Scenario 1\uff1a\u4e00\u4e2a\u9700\u8981\u5206\u5757\u7684\u65b0\u8bf7\u6c42\u8fdb\u5165\uff0c\u6b64\u65f6\u7cfb\u7edf\u5185\u6ca1\u6709\u65b0\u7684\u8bf7\u6c42</li> <li>Scenario 2\uff1a\u8be5\u65b0\u8bf7\u6c42 prefill \u5b8c\u7b2c\u4e00\u4e2a chunk req\uff0c\u5f00\u59cb prefill \u4e0b\u4e00\u4e2a chunk req</li> <li>Scenario 3\uff1a\u8be5\u8bf7\u6c42\u8fdb\u5165 decode \u9636\u6bb5\uff0c\u540c\u65f6\u6709\u9700\u8981\u5206\u5757\u7684\u65b0\u8bf7\u6c42\u8fdb\u5165 <p>\u8fd9\u91cc\u9700\u8981\u8003\u8651\u662f\u5426\u4f1a\u6709\u591a\u4e2a\u9700\u8981\u5206\u5757\u7684\u65b0\u8bf7\u6c42\u8fdb\u5165</p> </li> </ul> <p>\u4e0b\u9762\u4f1a\u5206\u8fd9\u4e09\u79cd\u60c5\u51b5\u8fdb\u884c\u5206\u522b\u8be6\u7ec6\u89e3\u91ca\uff1a</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#prerequisite-knowledge","title":"Prerequisite knowledge","text":""},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#continuous-batching","title":"Continuous batching","text":"<p>Continuous Batching[^orca] \u653e\u5f03\u4e86\u201c\u8bf7\u6c42\u7ea7\u201d\u540c\u6b65\uff0c\u8f6c\u800c\u91c7\u7528\u8fed\u4ee3\u7ea7(Token-level) \u8c03\u5ea6\u3002</p> <ul> <li>\u5de5\u4f5c\u539f\u7406\uff1a   1. \u63a8\u7406\u5f15\u64ce\u5728\u6bcf\u4e00\u4e2a Token \u751f\u6210\u6b65\u9aa4\uff08Iteration\uff09\u7ed3\u675f\u65f6\uff0c\u90fd\u4f1a\u68c0\u67e5\u5f53\u524d Batch \u4e2d\u54ea\u4e9b\u8bf7\u6c42\u5df2\u7ecf\u5b8c\u6210\u4e86\u751f\u6210\uff08\u9047\u5230\u4e86 <code>&lt;EOS&gt;</code> \u7b26\uff09\u3002   1. \u5982\u679c\u6709\u8bf7\u6c42\u5b8c\u6210\uff0c\u7cfb\u7edf\u4f1a\u7acb\u5373\u5c06\u5176\u79fb\u9664\uff0c\u91ca\u653e\u5176\u5360\u7528\u7684\u663e\u5b58\u69fd\u4f4d\u3002   1. \u5173\u952e\u70b9\uff1a\u7cfb\u7edf\u4f1a\u7acb\u5373\u4ece\u7b49\u5f85\u961f\u5217\uff08Waiting Queue\uff09\u4e2d\u62c9\u53d6\u4e00\u4e2a\u65b0\u7684\u8bf7\u6c42\uff0c\u586b\u8865\u521a\u521a\u7a7a\u51fa\u6765\u7684\u69fd\u4f4d\uff0c\u52a0\u5165\u5230\u4e0b\u4e00\u4e2a Token \u7684\u751f\u6210\u8fed\u4ee3\u4e2d [^cse234]\u3002</li> </ul> <p></p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#chunked-prefill","title":"Chunked Prefill","text":"<p>Continuous Batching \u4e2d\u4e3a\u4e86\u63d0\u9ad8\u541e\u5410\u7387\u662f prefill \u4f18\u5148\uff0c\u957f\u7684 prefill \u4efb\u52a1\u4f1a\u963b\u585e decode \u8fdb\u884c\uff0c\u9020\u6210 TBT \u589e\u5927\uff0c\u7528\u6237\u4f53\u9a8c\u53d8\u5dee</p> <p>Chunked Prefill [^chunk]\u7684\u6838\u5fc3\u601d\u60f3\u662f\uff1a\u628a\u957f Prompt \u628a\u5b83\u5207\u6210\u5c0f\u5757\uff0c\u5206\u591a\u6b21\u7b97\u3002</p> <p></p> <ul> <li>\u5de5\u4f5c\u539f\u7406\uff1a   1. \u5047\u8bbe\u6709\u4e00\u4e2a 1000 Token \u7684 Prompt \u8fdb\u6765\uff0c\u7cfb\u7edf\u8bbe\u5b9a Chunk Size \u4e3a 256\u3002   1. \u5728\u7b2c 1 \u4e2a\u8fed\u4ee3\uff0c\u7cfb\u7edf\u5904\u7406\u8fd9\u4e2a Prompt \u7684\u524d 256 \u4e2a Token\uff0c\u540c\u65f6\u5904\u7406\u5176\u4ed6\u7528\u6237\u7684 Decode \u4efb\u52a1\u3002   1. \u5728\u7b2c 2 \u4e2a\u8fed\u4ee3\uff0c\u5904\u7406\u63a5\u4e0b\u6765\u7684 256 \u4e2a Token\uff08\u5229\u7528 KV Cache \u7d2f\u79ef\uff09\uff0c\u7ee7\u7eed\u4e0e\u5176\u4ed6\u7528\u6237\u7684 Decode \u5e76\u884c\u3002   1. \u76f4\u5230 Prompt \u5904\u7406\u5b8c\uff0c\u8f6c\u5165 Decode \u9636\u6bb5\u3002</li> <li>\u6df7\u5408\u6279\u5904\u7406 (Mixed Batching)\uff1a\u8fd9\u5c31\u5f62\u6210\u4e86\u4e00\u4e2a\u7279\u6b8a\u7684 Batch\uff0c\u91cc\u9762\u65e2\u5305\u542b\u4e00\u4e9b\u8bf7\u6c42\u7684 Decode Token\uff0c\u4e5f\u5305\u542b\u53e6\u4e00\u4e9b\u8bf7\u6c42\u7684 Prefill Chunk\u3002</li> <li>\u4f18\u5148\u5904\u7406\u4e0a\u4e00\u8f6e\u7684 decode batch</li> <li>\u5982\u679c budget \u8fd8\u6709\u5269\u4f59\uff0c\u5bf9 chunked prefill \u540e\u7eed\u7684 chunk \u8fdb\u884c\u5904\u7406</li> <li>\u5982\u679c\u8fd8\u6709\u5269\u4f59\uff0c\u5bf9\u65b0\u52a0\u5165\u7684 request \u8fdb\u884c chunked prefill\uff0c\u7136\u540e\u5904\u7406\u7b2c\u4e00\u4e2a chunk</li> </ul> <p></p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#prefilladder-in-sglang","title":"PrefillAdder in SGLang","text":"<p>\u5b9e\u9645\u4e0a\u662f\u5bf9 Chunked Prefill \u8bba\u6587\u8fdb\u884c\u9884\u7b97\u6bd4\u8f83\u7684\u5de5\u7a0b\u5316\u5b9e\u73b0\uff0c\u4e0e Radix Cache \u548c HiCache \u7ed3\u5408\uff1b\u6240\u6709\u672c\u6b21\u8c03\u5ea6\u53ef\u4ee5\u8fdb\u884c\u63a8\u7406\u7684 <code>Req</code> \u90fd\u4f1a\u88ab\u653e\u5165 <code>can_run_list</code>\uff0c\u540e\u7eed\u7ec4\u88c5\u6210 <code>ScheduleBatch</code> \u4ea4\u7ed9\u540e\u9762\u6a21\u578b\u5c42\u63a8\u7406\u3002</p> <p>\u521d\u59cb\u5316\uff1a</p> <ul> <li>\u4fdd\u7559 Decode \u8bf7\u6c42\u9700\u8981\u7684 token\uff0c\u5269\u4f59\u7684 token \u662f\u7ed9 Prefill \u8bf7\u6c42\u5206\u914d\u7684</li> </ul> <p>\u65b0\u8bf7\u6c42\u5230\u8fbe\u540e\u6d41\u7a0b\uff1a</p> <ol> <li> <p>\u8c03\u7528 <code>add_one_req</code>\uff0c\u8ba1\u7b97 <code>total_tokens</code>\u3001<code>real_input_tokens</code>\uff0c\u5feb\u901f\u5224\u5b9a\u662f\u5426\u76f4\u63a5 <code>NO_TOKEN</code>/<code>OTHER</code>\u3002</p> </li> <li> <p>\u53d6 <code>last_node</code> \u9501\uff08\u4fdd\u8bc1 tree node \u5728\u64cd\u4f5c\u671f\u95f4\u4e0d\u88ab\u9a71\u9010\uff09\u3002</p> </li> <li> <p>\u82e5 <code>host_hit_length&gt;0</code>\uff0c\u56de\u586b host node \u7684 prefix\u3002</p> </li> <li> <p>\u5224\u65ad\u662f\u5426\u80fd\u4e00\u6b21\u6027 prefill\uff08\u975e chunk\uff09\uff1a</p> </li> </ol> <ul> <li>\u82e5\u53ef\u4ee5\uff1a\u5bf9 <code>last_node</code> \u589e\u52a0\u9501\u5f15\u7528\uff0c\u52a0\u5165 <code>can_run_list</code>\uff0c\u8c03\u7528 <code>_update_prefill_budget</code>\uff08\u540c\u65f6\u4e3a new_tokens \u9884\u7559\uff09\u3002</li> <li>\u82e5\u4e0d\u80fd\uff08\u9700\u8981 chunk\uff09\uff1a\u8ba1\u7b97 <code>trunc_len</code>\uff08page \u5bf9\u9f50 + <code>truncation_align</code>\uff09\uff0c\u622a\u65ad <code>fill_ids</code>\uff0c\u52a0\u5165 <code>can_run_list</code>\uff0c\u6807\u8bb0 <code>new_chunked_req</code>\uff0c\u53ea\u4e3a\u8fd9\u5757\u66f4\u65b0\u9884\u7b97\uff08\u4e0d\u4fdd\u7559 new token \u9884\u7b97\uff09\u3002</li> </ul> <ol> <li> <p>\u8fd4\u56de <code>budget_state()</code>\uff08CONTINUE/NO_TOKEN/OTHER\uff09\uff0c\u5b9e\u9645\u4e0a\u8fd9\u91cc\u5bf9\u662f\u5426\u53ef\u4ee5\u8fdb\u884c\u591a\u4e2a Prefill \u7684 Chunked \u8fdb\u884c\u4e86\u9650\u5236(\u540e\u9762\u4f1a\u8be6\u7ec6\u8bf4\u660e)\u3002</p> </li> <li> <p>\u7cfb\u7edf\u4f1a\u5bf9 <code>can_run_list</code> \u5b9e\u9645\u6267\u884c prefill\u3002\u82e5\u662f chunked\uff0c\u540e\u7eed\u518d\u63d0\u4ea4\u5269\u4f59 chunk\uff08<code>add_chunked_req</code>\uff09\u65f6\u4f1a\u7ee7\u7eed\u5904\u7406\u3002</p> </li> </ol>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#overview","title":"Overview","text":"<p>\u7528\u6237\u4f20\u6765\u7684 Prompt \u7ecf\u8fc7 TokenizerManager \u8fdb\u884c tokenization \u8f6c\u53d1\u7ed9 Scheduler \u8fdb\u7a0b\uff1b\u7136\u540e Scheduler \u7ecf\u8fc7\u4e00\u7cfb\u5217\u5904\u7406\uff0c\u5c06\u6a21\u578b\u7684 output \u5c01\u88c5\u6210 <code>BatchTokenIDOut</code> \u53d1\u9001\u7ed9 DeTokenizerManager\uff1bDetokenizerManager \u5728\u5176\u4e8b\u4ef6\u5faa\u73af\u4e2d\u63a5\u6536 \u00a0<code>BatchTokenIDOut</code>\uff0c\u5904\u7406\u540e\u751f\u6210 \u00a0<code>BatchStrOut</code>\u00a0 \u5e76\u8fd4\u56de\u7ed9 TokenizerManager\u3002\u81f3\u6b64 SGLang \u540e\u7aef\u7684\u4efb\u52a1\u5c31\u5b8c\u6210\u4e86</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#scenario-1-one-new-request","title":"Scenario 1: One New Request","text":"<p>\u73b0\u5728\u5047\u8bbe\u6211\u4eec\u6709\u4e00\u6761 Prompt \u8fdb\u6765\uff0c\u957f\u5ea6\u8d85\u8fc7\u4e00\u6b21 Prefill \u5904\u7406\u7684 <code>max_tokens</code> \u7684\u6781\u9650\uff0c\u5206\u522b\u6765\u770b Scheduler \u548c ModelRunner \u4ee5\u53ca\u540e\u9762\u7684\u6ce8\u610f\u529b\u540e\u7aef\u5982\u4f55\u5904\u7406</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#processing","title":"Processing","text":"<ul> <li>\u84dd\u8272\u90e8\u5206\u662f\u6d89\u53ca\u5230\u7684\u5185\u90e8\u53d8\u91cf\uff0c\u9ec4\u8272\u662f\u6d89\u53ca\u5230\u7684\u6570\u636e\u7ed3\u6784\uff0c\u7ea2\u8272\u662f sample \u51fd\u6570</li> </ul> <ol> <li> <p>\u5f53\u524d Scheduler \u4e2d\u65e0\u8bf7\u6c42\uff0c\u8be5 <code>req</code> \u653e\u5165 <code>waiting_queue</code> \u4e2d</p> </li> <li> <p>\u521b\u5efa <code>PrefillAdder</code>\uff0c\u4ece <code>waiting_queue</code> \u4e2d\u53d6\u51fa\u8be5\u8bf7\u6c42\uff0c\u8c03\u7528 <code>PrefillAdder::add_one_req()</code> prefill \u4f1a\u88ab\u622a\u65ad\u5206\u5757\uff0c<code>can_run_list</code> \u4e2d\u53ea\u6709\u8fd9\u4e2a <code>req</code>\uff0c\u5355\u4e2a\u8bf7\u6c42\u88ab\u6253\u5305\u6210 <code>ScheduleBatch</code></p> </li> <li> <p>\u8c03\u7528 <code>ScheduleBatch::prepare_for_extend()</code> \uff0c\u5b9e\u9645\u4e0a\u8c03\u7528 <code>alloc_for_extend()</code>\uff0c\u5206\u914d <code>req_pool_indices</code> \u4ee5\u53ca\u4e3a\u9700\u8981 extend \u7684\u957f\u5ea6\u7533\u8bf7\u771f\u5b9e\u7684 KV \u663e\u5b58 <code>out_cache_loc</code>\uff0c\u5e76\u628a\u5bf9\u5e94\u5173\u7cfb\u8bb0\u5f55\u5230\u7684 <code>req_to_token_pool</code></p> </li> <li> <p>\u6a21\u578b\u63a8\u7406 (<code>TpModelWorker</code>\u00a0&amp;\u00a0<code>ModelRunner</code>)    \u8fdb\u5165 \u00a0<code>TpModelWorker::forward_batch_generation()</code>\u00a0-&gt;\u00a0<code>ModelRunner::forward_extend()</code>\u00a0-&gt; \u6a21\u578b\u5c42 \u00a0<code>forward_extend()</code>\u3002</p> </li> </ol> <ul> <li>\u6b64\u65f6\u4f20\u5165\u7684\u5143\u6570\u636e\u4e2d\uff1a<ul> <li><code>input_ids</code>\u00a0 \u53ea\u6709\u672c\u6b21 chunk \u7684 token\u3002</li> <li><code>prefix_lens</code>\u00a00\u3002</li> <li><code>extend_lens</code>\u00a0 \u662f\u672c\u6b21 chunk \u7684\u957f\u5ea6\u3002</li> <li><code>req_pool_indices</code>\u00a0 \u6307\u5411\u5305\u542b\u4e86\u5b8c\u6574 KV \u5386\u53f2\u7684\u6620\u5c04\u8868\u3002</li> </ul> </li> </ul> <ol> <li>Attention \u6267\u884c (<code>FlashAttentionBackend</code>)    \u8c03\u7528 \u00a0<code>flash_with_kv_cache()</code>\uff1a - Attention Kernel \u4f1a\u8bfb\u53d6 \u00a0<code>req_pool_indices</code>\u00a0 \u83b7\u53d6 KV Cache \u7684\u7269\u7406\u5730\u5740\u3002 - \u5bf9\u4e8e\u672c\u6b21 chunk \u7684 Query\uff0c\u5b83\u4f1a\u8ba1\u7b97\u4e0e \u00a0Self (\u672c\u6b21 chunk \u7684 KV)\u00a0 \u7684 Attention\u3002</li> </ol> Python<pre><code> flash_attn_with_kvcache(\n</code></pre> <p>q=q.contiguous().view(-1, layer.tp_q_head_num, layer.head_dim), k_cache=key_cache, v_cache=value_cache, page_table=page_table, cache_seqlens=cache_seqlens, cu_seqlens_q=cu_seqlens_q, cu_seqlens_k_new=cu_seqlens_k if not use_local_attn else None, max_seqlen_q=max_seqlen_q, softmax_scale=layer.scaling, causal=False if use_cascade_attn else causal, window_size=window_size, softcap=layer.logit_cap, k_descale=k_descale, v_descale=v_descale, return_softmax_lse=use_cascade_attn, num_splits=self.num_splits, **kwargs, ) ```</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#scenario-2-next-chunked-prefill","title":"Scenario 2: Next Chunked Prefill","text":"<p>\u540c\u4e00\u4e2a\u8bf7\u6c42\u7684\u7b2c\u4e8c\u6b21 chunked prefill \u6267\u884c\uff08\u5373\u8be5\u8bf7\u6c42\u88ab\u622a\u65ad\uff0c\u73b0\u5728\u6267\u884c\u4e0b\u4e00\u4e2a chunk\uff09</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#processing_1","title":"Processing","text":"<ol> <li>Scheduler \u5904\u7406\u4e0a\u4e00\u4e2a Chunk \u7684\u7ed3\u675f    \u5728 \u00a0<code>Scheduler::get_next_batch_to_run()</code>\u00a0 \u4e2d\uff0cScheduler \u4f1a\u68c0\u6d4b\u5230 \u00a0<code>self.chunked_req</code>\u00a0 \u5b58\u5728\uff08\u5373\u4e0a\u4e00\u6b65\u662f chunked prefill\uff09\u3002    - \u8c03\u7528 \u00a0<code>self.tree_cache.cache_unfinished_req(self.chunked_req, chunked=True)</code> \u5c06\u4e0a\u4e00\u4e2a chunk \u8ba1\u7b97\u597d\u7684 KV Cache \u7d22\u5f15\u63d2\u5165\u5230 RadixCache \u4e2d\u3002    - \u8c03\u7528 \u00a0<code>self.req_to_token_pool.free(self.chunked_req.req_pool_idx)</code> \u91ca\u653e\u4e0a\u4e00\u4e2a chunk \u4f7f\u7528\u7684 \u00a0<code>req_pool_idx</code>\uff08\u6ce8\u610f\uff1aKV Cache \u672c\u8eab\u56e0\u4e3a\u88ab RadixCache \u5f15\u7528\uff0c\u4e0d\u4f1a\u88ab\u7269\u7406\u91ca\u653e\uff0c\u53ea\u662f\u91ca\u653e\u4e86\u903b\u8f91\u6620\u5c04\u69fd\u4f4d\uff09\u3002</li> <li>\u51c6\u5907\u4e0b\u4e00\u4e2a Chunk \u7684\u8bf7\u6c42    \u5728 \u00a0<code>Scheduler::get_new_batch_prefill()</code>\u00a0 \u4e2d\uff1a    - \u8c03\u7528 \u00a0<code>self.chunked_req.init_next_round_input()</code>\u3002<ul> <li>\u8be5\u51fd\u6570\u5185\u90e8\u8c03\u7528 \u00a0<code>tree_cache.match_prefix()</code>\u3002</li> <li>\u5173\u952e\u70b9\uff1a\u5b83\u4f1a\u4ece RadixCache \u4e2d\u5339\u914d\u5230\u4e0a\u4e00\u4e2a chunk \u521a\u521a\u5b58\u5165\u7684 KV Cache \u7d22\u5f15\uff0c\u5e76\u5c06\u8fd9\u4e9b\u7d22\u5f15\u8d4b\u503c\u7ed9 \u00a0<code>req.prefix_indices</code>\u3002\u6b64\u65f6 \u00a0<code>req.prefix_indices</code>\u00a0 \u5305\u542b\u4e86\u7b2c\u4e00\u4e2a chunk \u7684\u6240\u6709 KV \u4f4d\u7f6e\u3002</li> <li>\u8c03\u7528 \u00a0<code>PrefillAdder::add_chunked_req()</code>\u3002</li> <li>\u8ba1\u7b97\u672c\u6b21 chunk \u9700\u8981\u5904\u7406\u7684 token \u6570\u91cf\uff08extend_input_len\uff09\u3002</li> <li>\u66f4\u65b0 \u00a0<code>req.fill_ids</code>\u00a0 \u4e3a\u672c\u6b21 chunk \u7684 token\u3002</li> <li>\u5c06\u8bf7\u6c42\u52a0\u5165<code>can_run_list</code>\u3002</li> <li>\u521b\u5efa\u65b0\u7684 \u00a0<code>ScheduleBatch</code>\u3002</li> </ul> </li> <li>\u5206\u914d\u663e\u5b58\u4e0e\u6784\u5efa\u6620\u5c04    \u8c03\u7528 \u00a0<code>ScheduleBatch::prepare_for_extend()</code>\uff0c\u8fdb\u800c\u8c03\u7528 \u00a0<code>alloc_for_extend()</code>\uff1a    - \u5206\u914d\u65b0\u7684 \u00a0<code>req_pool_indices</code>\uff1a\u4e3a\u5f53\u524d chunk \u5206\u914d\u4e00\u4e2a\u65b0\u7684\u8bf7\u6c42\u69fd\u4f4d\u3002    - \u5206\u914d\u589e\u91cf KV \u663e\u5b58\uff1a\u53ea\u4e3a\u672c\u6b21 chunk \u7684\u65b0 token (<code>extend_input_len</code>) \u7533\u8bf7\u771f\u5b9e\u7684 KV \u663e\u5b58 \u00a0<code>out_cache_loc</code>\u3002    - \u6784\u5efa\u5b8c\u6574\u7684 KV \u6620\u5c04 (<code>write_cache_indices</code>)\uff1a<ul> <li>\u5c06 \u00a0<code>req.prefix_indices</code>\u00a0(\u7b2c\u4e00\u4e2a chunk \u7684 KV \u5730\u5740) \u5199\u5165\u5230\u65b0\u7684 \u00a0<code>req_pool_idx</code>\u00a0 \u5bf9\u5e94\u7684\u6620\u5c04\u8868\u4e2d\u3002</li> <li>\u5c06 \u00a0<code>out_cache_loc</code>\u00a0(\u672c\u6b21 chunk \u7684 KV \u5730\u5740) \u5199\u5165\u5230\u6620\u5c04\u8868\u7684\u540e\u7eed\u4f4d\u7f6e\u3002</li> <li>\u8fd9\u6837\uff0c\u65b0\u7684 \u00a0<code>req_pool_idx</code>\u00a0 \u5c31\u62e5\u6709\u4e86\u6307\u5411 [Chunk 1 KV, Chunk 2 KV] \u7684\u5b8c\u6574\u8fde\u7eed\u903b\u8f91\u89c6\u56fe\u3002</li> </ul> </li> <li>\u6a21\u578b\u63a8\u7406 (<code>TpModelWorker</code>\u00a0&amp;\u00a0<code>ModelRunner</code>)\\    \u8fdb\u5165 \u00a0<code>TpModelWorker::forward_batch_generation()</code>\u00a0-&gt;\u00a0<code>ModelRunner::forward_extend()</code>\u00a0-&gt; \u6a21\u578b\u5c42 \u00a0<code>forward_extend()</code>\u3002    - \u6b64\u65f6\u4f20\u5165\u7684\u5143\u6570\u636e\u4e2d\uff1a<ul> <li><code>input_ids</code>\u00a0 \u53ea\u6709\u672c\u6b21 chunk \u7684 token\u3002</li> <li><code>prefix_lens</code>\u00a0 \u662f\u7b2c\u4e00\u4e2a chunk \u7684\u957f\u5ea6\u3002</li> <li><code>extend_lens</code>\u00a0 \u662f\u672c\u6b21 chunk \u7684\u957f\u5ea6\u3002</li> <li><code>req_pool_indices</code>\u00a0 \u6307\u5411\u5305\u542b\u4e86\u5b8c\u6574 KV \u5386\u53f2\u7684\u6620\u5c04\u8868\u3002</li> </ul> </li> <li>Attention \u6267\u884c (<code>FlashAttentionBackend</code>)\\    \u8c03\u7528 \u00a0<code>flash_with_kv_cache()</code>\uff08\u6216\u7c7b\u4f3c\u63a5\u53e3\uff09\uff1a    - Attention Kernel \u4f1a\u8bfb\u53d6 \u00a0<code>req_pool_indices</code>\u00a0 \u83b7\u53d6 KV Cache \u7684\u7269\u7406\u5730\u5740\u3002    - \u5bf9\u4e8e\u672c\u6b21 chunk \u7684 Query\uff0c\u5b83\u4f1a\u8ba1\u7b97\u4e0e \u00a0Self (\u672c\u6b21 chunk \u7684 KV)\u00a0 \u4ee5\u53ca \u00a0Prefix (\u7b2c\u4e00\u4e2a chunk \u7684 KV)\u00a0 \u7684 Attention\u3002    - \u7531\u4e8e Prefix \u7684 KV \u5df2\u7ecf\u5728\u663e\u5b58\u4e2d\uff08\u901a\u8fc7 \u00a0<code>prefix_indices</code> \u590d\u7528\uff09\uff0c\u65e0\u9700\u91cd\u65b0\u8ba1\u7b97\uff0c\u53ea\u9700\u52a0\u8f7d\u5373\u53ef\u3002</li> </ol>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#scenario-3-one-decode-one-new-request","title":"Scenario 3: One Decode &amp; One New Request","text":"<p>\u9488\u5bf9 One Decode (\u6b63\u5728\u751f\u6210\u7684\u8bf7\u6c42) &amp; One New Request (\u65b0\u6765\u7684 Prefill \u8bf7\u6c42) \u540c\u65f6\u5b58\u5728\u7684\u573a\u666f\uff08\u5373 Mixed Batch\uff09</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#output-id-generate-in-mixed-batching","title":"Output Id Generate in Mixed Batching","text":"<p>\u5047\u8bbe\u8bf7\u6c42\u7684 Input \u957f\u5ea6\u4e3a \u00a0\\(I\\)\uff0c\u76ee\u524d\u5df2\u7ecf\u751f\u6210\u4e86 \u00a0\\(N\\)\u00a0 \u4e2a Token\u3002\u6211\u4eec\u73b0\u5728\u8981\u8c03\u5ea6\u7b2c \u00a0\\(N+1\\)\u00a0 \u6b65\u751f\u6210\u3002\u6b64\u65f6\uff0c\u7b2c \u00a0\\(N\\)\u00a0 \u6b65\u751f\u6210\u7684 Token\u00a0\\(T_N\\)\u200b\u00a0 \u5e94\u8be5\u4f5c\u4e3a\u7b2c \u00a0\\(N+1\\)\u00a0 \u6b65\u7684\u8f93\u5165\uff0c\u800c KV Cache \u4e2d\u5e94\u8be5\u5305\u542b \u00a0\\(I+(N\u22121)\\)\u00a0 \u4e2a Token\uff08\u5373 Input + \u524d \u00a0\\(N\u22121\\)\u00a0 \u4e2a\u751f\u6210\u8bcd\uff09\u3002</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#1-overlap","title":"1. \u975e Overlap \u6a21\u5f0f","text":"<ul> <li>\u6d41\u7a0b\uff1aGPU \u8dd1\u5b8c\u7b2c \u00a0\\(N\\)\u00a0 \u6b65 -&gt; CPU \u62ff\u5230\u7ed3\u679c -&gt; \u66f4\u65b0 \u00a0<code>req.output_ids</code>\u00a0-&gt; CPU \u8c03\u5ea6\u7b2c \u00a0\\(N+1\\)\u00a0 \u6b65\u3002</li> <li>\u72b6\u6001\uff1a\u6b64\u65f6 \u00a0<code>req.output_ids</code>\u00a0 \u5df2\u7ecf\u5305\u542b\u4e86\u521a\u521a\u751f\u6210\u7684 \u00a0\\(T_N\\)\u200b\u3002</li> <li>\u957f\u5ea6\uff1alen(<code>output_ids</code>)\u00a0=\u00a0\\(N\\)\u3002</li> <li>\u8ba1\u7b97\uff1a</li> <li>\u603b\u957f\u5ea6 =\u00a0\\(I+N\\)\u3002</li> <li>\u6211\u4eec\u9700\u8981\u6307\u5411 \u00a0\\(T_N\\)\u200b\u00a0 \u4e4b\u524d\u7684\u4f4d\u7f6e\uff08\u56e0\u4e3a \u00a0\\(T_N\\)\u200b\u00a0 \u662f\u5f53\u524d\u8f93\u5165\uff0c\u8fd8\u6ca1\u8fdb KV Cache\uff09\u3002</li> <li><code>prefix_len</code>\u00a0= \u603b\u957f\u5ea6 - 1 =\u00a0\\(I+N\u22121\\)\u3002</li> <li>\u4ee3\u7801\u5bf9\u5e94\uff1a<code>delta = -1</code>\u3002</li> </ul>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#2-overlap","title":"2. Overlap \u6a21\u5f0f","text":"<ul> <li>\u6d41\u7a0b\uff1aCPU \u8c03\u5ea6\u7b2c \u00a0\\(N\\)\u00a0 \u6b65 -&gt; GPU \u4e0a\u5f00\u59cb\u6267\u884c\u961f\u5217\u91cc\u7684\u4efb\u52a1(\\(comput_N\\) or \\(sample_N\\)) -&gt;\u00a0CPU \u7d27\u63a5\u7740\u8c03\u5ea6\u7b2c \u00a0\\(N+1\\)\u00a0 \u6b65\u00a0-&gt; ... -&gt; CPU \u7a0d\u540e\u5904\u7406\u7b2c \u00a0\\(N\\)\u00a0 \u6b65\u7684\u7ed3\u679c\u3002</li> <li>\u72b6\u6001\uff1a\u5f53 CPU \u6b63\u5728\u8c03\u5ea6\u7b2c \u00a0\\(N+1\\)\u00a0 \u6b65\uff08\u8fd9\u91cc\u6267\u884c Decode \u548c Prefill \u6279\u6b21\u6df7\u5408\uff09\u65f6\uff0c\u7b2c \u00a0\\(N\\)\u00a0 \u6b65\u7684 Sample \u8fd8\u672a\u6267\u884c\uff0c\u6240\u4ee5 \u00a0<code>req.output_ids</code> \u8fd8\u505c\u7559\u5728\u7b2c \u00a0\\(N\u22121\\)\u00a0 \u6b65\u7684\u72b6\u6001\uff0c\u4e0d\u5305\u542b \u00a0\\(T_N\\)\u200b\u3002</li> <li>\u957f\u5ea6\uff1alen(<code>output_ids</code>)\u00a0=\u00a0\\(N - 1\\)\u3002</li> <li>\u8ba1\u7b97\uff1a</li> <li>\u603b\u957f\u5ea6 =\u00a0\\(I+N - 1\\)\u3002</li> <li><code>prefix_len</code>\u00a0= \u603b\u957f\u5ea6 - 1 =\u00a0\\(I+N\u22121\\)\u3002</li> <li>delta \u5fc5\u987b\u4e3a \u00a00\u3002</li> <li>\u4ee3\u7801\u5bf9\u5e94\uff1a<code>delta = 0</code>\u3002</li> </ul>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#summary","title":"Summary","text":"<p>\u5728 Overlap \u6a21\u5f0f\u4e0b\uff0c\u5f53 Scheduler \u5b89\u6392\u4e0b\u4e00\u4e2a Batch \u65f6\uff0c\u4e0a\u4e00\u4e2a Batch \u521a\u521a\u751f\u6210\u7684 Token \u8fd8\u6ca1\u6709\u66f4\u65b0\u5230 \u00a0<code>req.output_ids</code>\u00a0 \u4e2d\uff0c\u5373 <code>req.output_ids</code> \u7684\u66f4\u65b0\u6709\u4e00\u4e2a step \u7684\u5ef6\u8fdf</p>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#just-one-chunked-prefill","title":"Just One Chunked Prefill","text":"<p>SGLang \u4f7f\u7528\u4e86 PrefillAdder \u8fdb\u884c stall-free \u8c03\u5ea6\uff0c\u4e00\u4e2a Prefill \u8bf7\u6c42\u8fdb\u5165\u53ea\u6709\u4e0b\u9762\u4e24\u79cd\u60c5\u51b5\uff1a</p> <ol> <li>\u4e00\u6574\u4e2a\u8bf7\u6c42\u52a0\u5165 \u00a0<code>can_run_list</code>\uff1a    - \u5982\u679c\u5f53\u524d\u8bf7\u6c42\u80fd\u5b8c\u6574\u653e\u5165\u5269\u4f59\u7a7a\u95f4\uff0c\u5b83\u4f1a\u88ab\u52a0\u5165\u3002    - \u6b64\u65f6 \u00a0<code>rem_chunk_tokens</code>\u00a0 \u8fd8\u6709\u5269\u4f59\uff0c\u8c03\u5ea6\u5668\u4f1a\u7ee7\u7eed\u5c1d\u8bd5\u52a0\u5165\u4e0b\u4e00\u4e2a\u8bf7\u6c42\u3002    - \u6700\u7ec8\u7ed3\u679c\u53ef\u80fd\u662f \u00a0<code>[Full_Req_1, Full_Req_2, ...]</code>\u3002</li> <li>Chunked prefill request \u52a0\u5165\uff0c\u4e14\u6ca1\u6709\u5269\u4f59 token \u52a0\u5165\u7b2c\u4e8c\u4e2a\u8bf7\u6c42\uff1a    - \u5982\u679c\u5f53\u524d\u8bf7\u6c42\u653e\u4e0d\u4e0b\uff08\u9700\u8981 Chunk\uff09\uff0c\u4ee3\u7801\u5f3a\u5236\u8981\u6c42\u5b83\u5fc5\u987b\u662f\u5f53\u524d Batch \u7684\u7b2c\u4e00\u4e2a\u8bf7\u6c42\uff08<code>len(self.can_run_list) == 0</code>\uff09\u3002    - \u4e00\u65e6\u51b3\u5b9a Chunk\uff0c\u5b83\u4f1a\u8d2a\u5a6a\u5730\u6d88\u8017\u6389\u6240\u6709\u5269\u4f59\u7684 \u00a0<code>rem_chunk_tokens</code>\u3002    - <code>budget_state()</code>\u00a0 \u68c0\u6d4b\u5230 Token \u8017\u5c3d\uff0c\u8fd4\u56de \u00a0<code>OTHER</code>\uff0c\u5bfc\u81f4\u8c03\u5ea6\u5faa\u73af\u7acb\u5373\u7ec8\u6b62\u3002    - \u56e0\u6b64\uff0cChunked Request \u540e\u9762\u4e0d\u53ef\u80fd\u518d\u6709\u4efb\u4f55\u8bf7\u6c42\u52a0\u5165\u3002\u6700\u7ec8\u7ed3\u679c\u662f \u00a0<code>[Chunked_Req]</code>\u3002</li> <li>\u4e0d\u53ef\u80fd\u51fa\u73b0 \u00a0<code>[Full_Req, Chunked_Req]</code> \u6216\u8005 <code>[Chunked_Req, Chunked_Req]</code>\u00a0 \u8fd9\u6837\u7684\u7ec4\u5408\uff0c\u56e0\u4e3a\u5982\u679c\u7b2c\u4e00\u4e2a\u662f Full Req\uff0c\u7b2c\u4e8c\u4e2a\u653e\u4e0d\u4e0b\u65f6\u4f1a\u88ab\u76f4\u63a5\u62d2\u7edd\uff08\u800c\u4e0d\u662f\u88ab Chunk \u8fdb\u6765\uff09\u3002</li> </ol> Python<pre><code>def add_one_req(\n    self, req: Req, has_chunked_req: bool, truncation_align_size: Optional[int]\n):\n    # \u3010\u5173\u952e\u70b9 1\u3011\uff1a\u5982\u679c\u5f53\u524d\u8bf7\u6c42\u653e\u4e0d\u4e0b\uff08\u9700\u8981 Chunk\uff09\uff0c\u4e14\u961f\u5217\u4e2d\u5df2\u7ecf\u6709\u5176\u4ed6\u8bf7\u6c42\u4e86\uff0c\u76f4\u63a5\u505c\u6b62\uff01\n    # \u8fd9\u4fdd\u8bc1\u4e86 Chunked Request \u4e0d\u4f1a\u8ddf\u5728 Full Request \u540e\u9762\u3002\n    if real_input_tokens &gt;= self.rem_input_tokens and len(self.can_run_list) != 0:\n        return AddReqResult.OTHER\n\n    with self._lock_node(req.last_node):\n        if self.rem_chunk_tokens is None or input_tokens &lt;= self.rem_chunk_tokens:\n            # \u3010\u60c5\u51b5 1\u3011\uff1aNon-chunked prefill (\u4e00\u6574\u4e2a\u8bf7\u6c42\u52a0\u5165)\n            # \u8bf7\u6c42\u80fd\u5b8c\u6574\u653e\u4e0b\uff0c\u52a0\u5165 can_run_list\n            self.can_run_list.append(req)\n            # \u66f4\u65b0\u5269\u4f59\u9884\u7b97\uff0c\u5982\u679c\u8fd8\u6709\u5269\u4f59\uff0cbudget_state() \u4f1a\u8fd4\u56de CONTINUE\uff0c\u5141\u8bb8\u5c1d\u8bd5\u52a0\u5165\u4e0b\u4e00\u4e2a\u8bf7\u6c42\n            self._update_prefill_budget(...)\n        else:\n            # \u3010\u60c5\u51b5 2\u3011\uff1aChunked prefill (\u5206\u5757\u8bf7\u6c42\u52a0\u5165)\n            # \u8bf7\u6c42\u653e\u4e0d\u4e0b\uff0c\u4e14 can_run_list \u4e3a\u7a7a\uff08\u7531\u5173\u952e\u70b9 1 \u4fdd\u8bc1\uff09\n            # \u8ba1\u7b97\u622a\u65ad\u957f\u5ea6\uff0c\u628a\u5269\u4f59\u6240\u6709\u7684 rem_chunk_tokens \u5168\u90e8\u7528\u5b8c\u5e76\u52a0\u5165 can_run_list\n            self.can_run_list.append(req)\n            self.new_chunked_req = req\n            # \u66f4\u65b0\u9884\u7b97\uff0c\u8fd9\u91cc\u4f1a\u628a rem_chunk_tokens \u51cf\u4e3a 0\n            self._update_prefill_budget(prefix_len, trunc_len, 0)\n    # \u3010\u5173\u952e\u70b9 2\u3011\uff1a\u68c0\u67e5\u9884\u7b97\u72b6\u6001\n    return self.budget_state()\n\n\ndef budget_state(self):\n    # ...\n    # \u5982\u679c rem_chunk_tokens \u53d8\u6210\u4e86 0 (\u60c5\u51b5 2 \u53d1\u751f\u540e)\uff0c\u8fd4\u56de OTHER\uff0c\u505c\u6b62\u8c03\u5ea6\u5faa\u73af\n    if self.rem_input_tokens &lt;= 0 or (\n        self.rem_chunk_tokens is not None and self.rem_chunk_tokens &lt;= 0\n    ):\n        return AddReqResult.OTHER\n\n    return AddReqResult.CONTINUE\n</code></pre>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#processing_2","title":"Processing","text":"<ol> <li>Scheduler \u51c6\u5907\u9636\u6bb5 (Scheduler::get_next_batch_to_run)</li> </ol> <ul> <li>\u7ef4\u62a4 Decode \u8bf7\u6c42\uff1a<code>self.last_batch</code> \u4e2d\u5305\u542b\u6b63\u5728 Decode \u7684\u8bf7\u6c42\uff0c\u5c06 Decode \u8bf7\u6c42\u6570\u91cf\u4f20\u5165 PrefillAdder \u7528\u4e8e\u4fdd\u7559 Decode \u7684 token \u6570\u91cf\u3002</li> <li>\u5c1d\u8bd5\u52a0\u5165 Prefill \u8bf7\u6c42\uff1a\u8c03\u7528 <code>self.get_new_batch_prefill()</code>\u3002<ul> <li>PrefillAdder \u521b\u5efa\u65f6\u5df2\u7ecf\u8ba1\u7b97\u51fa Decode \u8bf7\u6c42\u9700\u8981\u7684 token \u6570\u91cf\uff0c\u4f1a\u8ba1\u7b97\u5269\u4f59\u663e\u5b58\u662f\u5426\u8db3\u591f\u5bb9\u7eb3\u65b0\u8bf7\u6c42\u7684 Prefill\uff0c</li> <li>\u5982\u679c\u8db3\u591f\uff0c<code>adder.add_one_req()</code> \u5c06\u65b0\u8bf7\u6c42\u52a0\u5165 <code>can_run_list</code>\uff0c\u5982\u679c\u8be5\u8bf7\u6c42\u8fc7\u7a0b\uff0c\u8fd8\u662f\u4f1a\u88ab\u622a\u65ad\u3002</li> </ul> </li> <li>\u6df7\u5408 Batch \uff1a<ul> <li>\u68c0\u6d4b\u5230 <code>self.is_mixed_chunk</code> \u4e14 <code>running_batch</code> \u4e0d\u4e3a\u7a7a\uff0c\u8c03\u7528 <code>new_batch.mix_with_running(self.running_batch)</code>\u3002 Python<pre><code>self.running_batch.filter_batch()\nif not self.running_batch.is_empty():\n    self.running_batch.prepare_for_decode()\n    new_batch.mix_with_running(self.running_batch)\n    new_batch.decoding_reqs = self.running_batch.reqs\nself.running_batch = ScheduleBatch(\n    reqs=[], batch_is_full=self.running_batch.batch_is_full\n)\n</code></pre></li> <li>\u6570\u636e\u5408\u5e76\uff1a\u5c06 Decode \u8bf7\u6c42\u7684\u6570\u636e\uff08<code>input_ids</code>, <code>out_cache_loc</code>, <code>req_pool_indices</code> \u7b49\uff09\u62fc\u63a5\u5230 <code>new_batch</code> \u540e\u9762\u3002<code>running_batch</code> \u5904\u7406\u7684 reqs \u8bbe\u7f6e\u4e3a\u7a7a\u3002</li> <li>\u8f6c\u6362 Decode \u4e3a Extend\uff1aDecode \u8bf7\u6c42\u88ab\u89c6\u4e3a\u957f\u5ea6\u4e3a 1 \u7684 Extend \u8bf7\u6c42\u3002</li> <li><code>extend_input_len</code> \u8bbe\u4e3a 1\u3002</li> <li><code>prefix_lens</code> \u8bbe\u4e3a Decode \u8bf7\u6c42\u5df2\u6709\u7684\u5386\u53f2\u957f\u5ea6 <code>len(r.origin_input_ids) + len(r.output_ids) + delta</code>\u3002      &gt; \u89c1 output id generate \u7ae0\u8282</li> </ul> </li> <li>\u6700\u7ec8 <code>new_batch</code> \u5305\u542b\u4e86\u4e24\u4e2a\u8bf7\u6c42\u7684\u5143\u6570\u636e\uff0c\u4e00\u4e2a\u662f\u591a Token \u7684 Extend(Prefill)\uff0c\u4e00\u4e2a\u662f\u5355 Token \u7684 Extend(Decode)\u3002\u6a21\u578b\u5c42\u53ef\u4ee5\u6309\u7167\u76f8\u540c\u7684\u65b9\u5f0f\u5904\u7406\u8fd9\u4e24\u79cd\u8bf7\u6c42\u3002</li> </ul> <ol> <li>\u6a21\u578b\u63a8\u7406 (TpModelWorker &amp; ModelRunner)</li> </ol> <ul> <li>\u8fdb\u5165 <code>TpModelWorker::forward_batch_generation()</code> -&gt; <code>ModelRunner::forward_extend()</code>\u3002</li> <li>\u867d\u7136\u4e00\u4e2a\u662f Prefill \u4e00\u4e2a\u662f Decode\uff0c\u4f46\u5728 SGLang \u5e95\u5c42\uff0cDecode \u88ab\u89c6\u4e3a\u4e00\u79cd\u7279\u6b8a\u7684 Extend\uff08Input Length = 1\uff09\u3002</li> </ul> <ol> <li>Attention \u6267\u884c (FlashAttentionBackend)</li> </ol> <ul> <li>\u8c03\u7528 <code>flash_with_kv_cache()</code></li> <li>\u4e24\u8005\u5728\u540c\u4e00\u4e2a Kernel Launch \u4e2d\u5b8c\u6210\u8ba1\u7b97\uff0c\u5b9e\u73b0\u4e86\u8ba1\u7b97\u8d44\u6e90\u7684\u6d41\u6c34\u7ebf\u5e76\u884c\uff0c\u586b\u8865\u4e86 Decode \u9636\u6bb5 GPU \u8ba1\u7b97\u80fd\u529b\u7684\u7a7a\u95f2\u3002</li> </ul>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#q-a","title":"Q &amp; A","text":""},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#1-sglang-prefill","title":"1. SGLang \u8c03\u5ea6\u7b56\u7565\u662f Prefill \u4f18\u5148\u5417\uff1f","text":"<p>\u662f\u7684\uff0cPrefill \u4f18\u5148\u3002</p> <p>\u5728 \u00a0<code>Scheduler.get_next_batch_to_run</code>\u00a0 \u65b9\u6cd5\u4e2d\uff0c\u8c03\u5ea6\u5668\u603b\u662f\u5148\u5c1d\u8bd5\u6784\u5efa\u4e00\u4e2a\u65b0\u7684 Prefill Batch\u3002\u53ea\u6709\u5f53\u65e0\u6cd5\u6784\u5efa Prefill Batch\uff08\u4f8b\u5982\u6ca1\u6709\u65b0\u8bf7\u6c42\u6216\u663e\u5b58\u4e0d\u8db3\uff09\u65f6\uff0c\u624d\u4f1a\u53bb\u8c03\u5ea6\u6b63\u5728\u8fd0\u884c\u7684 Decode Batch\u3002</p> Python<pre><code>def get_next_batch_to_run(self) -&gt; Optional[ScheduleBatch]:\n    # \u5c1d\u8bd5\u83b7\u53d6\u4e00\u4e2a\u65b0\u7684 Prefill Batch\n    new_batch = self.get_new_batch_prefill()\n    # ...\n    if new_batch is not None:\n        # \u5982\u679c\u6210\u529f\u6784\u5efa\u4e86 Prefill Batch\uff0c\u4f18\u5148\u8fd0\u884c\u5b83\n        ret = new_batch\n    else:\n        # \u5426\u5219\uff0c\u8fd0\u884c Decode Batch (running_batch)\n        if not self.running_batch.is_empty():\n            self.running_batch = self.update_running_batch(self.running_batch)\n            ret = self.running_batch if not self.running_batch.is_empty() else None\n        else:\n            ret = None\n    return ret\n</code></pre>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#2-prefill-decode-batch","title":"2. Prefill \u548c Decode \u5982\u4f55\u5728\u4e00\u4e2a Batch \u4e2d\u8fdb\u884c\u63a8\u7406\uff1f","text":"<p>SGLang \u652f\u6301 \u00a0Mixed Batch\uff08\u6df7\u5408\u6279\u5904\u7406\uff09\uff0c\u5373\u5728\u4e00\u4e2a Batch \u4e2d\u540c\u65f6\u5305\u542b Prefill \u8bf7\u6c42\u548c Decode \u8bf7\u6c42\u3002\u9700\u8981\u5f00\u542f \u00a0<code>enable_mixed_chunk</code>\u00a0 \u4e14\u6709 <code>Chunked Prefill</code> \u3002</p> <ol> <li>\u6784\u5efa\u9636\u6bb5\uff1a\u5728 \u00a0<code>get_new_batch_prefill</code>\u00a0 \u4e2d\uff0c\u5982\u679c\u6ee1\u8db3\u6df7\u5408\u6761\u4ef6\uff08<code>is_mixed_chunk</code>\u00a0 \u4e3a\u771f\uff0c\u4e14\u4e0d\u6d89\u53ca logprob \u8ba1\u7b97\uff09\uff0c\u8c03\u5ea6\u5668\u4f1a\u5c06\u5f53\u524d\u7684 \u00a0<code>running_batch</code>\uff08Decode \u8bf7\u6c42\uff09\u5408\u5e76\u5230\u65b0\u6784\u5efa\u7684 \u00a0<code>new_batch</code>\uff08Prefill \u8bf7\u6c42\uff09\u4e2d\u3002</li> <li>\u5408\u5e76\u903b\u8f91\uff1a\u8c03\u7528 \u00a0<code>ScheduleBatch.mix_with_running</code>\u3002    - Decode \u8bf7\u6c42\u88ab\u89c6\u4e3a \u00a0<code>extend_input_len = 1</code>\u00a0 \u7684 Prefill \u8bf7\u6c42\u3002    - <code>input_ids</code>\u00a0 \u548c \u00a0<code>out_cache_loc</code>\u00a0 \u4f1a\u88ab\u62fc\u63a5\u3002    - Batch \u7684 \u00a0<code>forward_mode</code>\u00a0 \u88ab\u8bbe\u7f6e\u4e3a \u00a0<code>ForwardMode.MIXED</code>\u3002</li> </ol>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#3-batch-chunked-prefill","title":"3. \u4e00\u4e2a batch \u4e2d\u53ef\u4ee5\u6709\u591a\u4e2a chunked prefill \u5417\uff1f","text":"<p>\u5728\u5f53\u524d\u7684 SGLang \u5b9e\u73b0\u4e2d\uff0c\u4e0d\u53ef\u80fd\u540c\u65f6\u6709\u4e24\u4e2a\u8bf7\u6c42\u90fd\u5904\u4e8e chunked prefill\uff08\u5206\u5757\u9884\u586b\u5145\uff09\u9636\u6bb5\u3002</p> <ol> <li>\u8c03\u5ea6\u5668\u72b6\u6001\uff1aScheduler\u00a0 \u7c7b\u4e2d\u7ef4\u62a4\u7684\u662f\u5355\u4e2a \u00a0<code>self.chunked_req</code>\u00a0 \u53d8\u91cf\uff0c\u800c\u4e0d\u662f\u5217\u8868\u3002</li> <li>\u6dfb\u52a0\u7b56\u7565\uff1a\u5728 \u00a0<code>PrefillAdder.add_one_req</code>\u00a0 \u4e2d\uff0c\u4e00\u65e6\u51b3\u5b9a\u5c06\u67d0\u4e2a\u8bf7\u6c42\u8fdb\u884c Chunk\uff08\u56e0\u4e3a\u5b83\u592a\u957f\u653e\u4e0d\u4e0b\uff09\uff0c\u4ee3\u7801\u4f1a\u7acb\u5373\u6d88\u8017\u5b8c\u6240\u6709\u5269\u4f59\u7684 \u00a0<code>rem_chunk_tokens</code>\uff0c\u5e76\u8fd4\u56de \u00a0<code>AddReqResult.OTHER</code>\uff0c\u8fd9\u4f1a\u76f4\u63a5\u7ec8\u6b62\u5f53\u524d Batch \u7684\u6784\u5efa\u5faa\u73af\u3002</li> </ol>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#4-chunked-prefill-kv-cache","title":"4. Chunked Prefill \u5982\u4f55\u5904\u7406 KV Cache\uff1f","text":"<p>Chunked Prefill \u7684\u6838\u5fc3\u5728\u4e8e\u5229\u7528 Radix Cache \u4fdd\u5b58\u4e2d\u95f4\u72b6\u6001\u3002\u6bcf\u5904\u7406\u5b8c\u4e00\u4e2a Chunk\uff0c\u7cfb\u7edf\u4f1a\u5c06\u8fd9\u90e8\u5206\u8ba1\u7b97\u597d\u7684 KV Cache \u63d2\u5165\u5230 Radix Tree \u4e2d\uff0c\u4f7f\u5176\u6210\u4e3a\u4e0b\u4e00\u4e2a Chunk \u7684\u201c\u524d\u7f00\u201d\u3002</p> <p>\u5904\u7406\u6d41\u7a0b\uff1a</p> <ol> <li>\u6267\u884c\u524d\uff1aScheduler\u00a0 \u5c06 \u00a0<code>chunked_req</code>\u00a0 \u4ece Batch \u4e2d\u6682\u65f6\u79fb\u9664\uff08<code>running_batch</code> \u53ea\u63a5\u6536\u9700\u8981 Decode \u7684\u8bf7\u6c42\uff09\u3002</li> <li>\u7f13\u5b58\u4e2d\u95f4\u7ed3\u679c\uff1a\u8c03\u7528 \u00a0<code>cache_unfinished_req</code>\u3002    - \u5c06\u5f53\u524d\u5df2\u5904\u7406\u7684 Token (<code>req.fill_ids</code>) \u548c\u5bf9\u5e94\u7684 KV Cache \u7d22\u5f15\u63d2\u5165 Radix Tree\u3002    - \u91ca\u653e\u65e7\u7684 KV \u7d22\u5f15\uff0c\u7533\u8bf7\u65b0\u7684 Radix Tree \u8282\u70b9\u3002</li> <li>\u66f4\u65b0\u8bf7\u6c42\u72b6\u6001\uff1a    - <code>req.prefix_indices</code>\u00a0 \u66f4\u65b0\u4e3a\u6307\u5411 Radix Tree \u4e2d\u65b0\u63d2\u5165\u7684\u8282\u70b9\u3002    - <code>req.last_node</code>\u00a0 \u66f4\u65b0\u4e3a\u65b0\u7684\u6811\u8282\u70b9\u3002</li> <li>\u4e0b\u4e00\u8f6e\u8c03\u5ea6\uff1a\u5f53\u8be5\u8bf7\u6c42\u518d\u6b21\u88ab\u8c03\u5ea6\u65f6\uff0c\u5b83\u4f1a\u53d1\u73b0\u81ea\u5df1\u6709\u5f88\u957f\u7684 \u00a0<code>prefix_indices</code>\uff08\u5373\u4e0a\u4e00\u6b21\u5904\u7406\u5b8c\u7684 Chunk\uff09\uff0c\u4ece\u800c\u53ea\u9700\u8ba1\u7b97\u5269\u4f59\u7684\u90e8\u5206\u3002</li> </ol>"},{"location":"notes/sglang/%E4%B8%80%E6%9D%A1%20Request%20%E5%9C%A8%20SGLang%20%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/#reference","title":"Reference","text":"<p>[^orca]: Orca: A Distributed Serving System for Transformer-Based Generative Models [^cse234]: cse234-w25 [^chunk]: SARATHI: Efficient LLM Inference by Piggybacking Decodes with Chunked Prefills [^sglang]: SGLang</p>"},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/","title":"\u4ece\u4ee3\u7801\u770b SGLang \u7684 KV Cache","text":"2025-11-022025-12-13 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#sglang-kv-cache","title":"\u4ece\u4ee3\u7801\u770b SGLang \u7684 KV Cache","text":"<p> \u7ea6 1098 \u4e2a\u5b57  49 \u884c\u4ee3\u7801  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> <p>Info</p> <p>\u5efa\u8bae\u9605\u8bfb SGLang Scheduler \u6280\u672f\u53d8\u8fc1\u540e\u8fdb\u884c\u9605\u8bfb\uff0c\u6548\u679c\u66f4\u597d</p> <p>\u5b9e\u9645\u4e0a SGLang \u7684 Cache \u7ba1\u7406\u7531\u4e09\u4e2a\u7ec4\u4ef6\u6784\u6210 <code>tree_cache</code> \u3001 <code>req_to_token_pool</code> \u548c <code>token_to_kv_pool_allocator</code> \u3002</p> <ul> <li> <p><code>tree_cache</code> \u5145\u5f53\u534f\u8c03\u5c42 \uff0c\u4f4d\u4e8e\u4e24\u4e2a\u5185\u5b58\u6c60\u4e4b\u4e0a\u3002</p> </li> <li> <p><code>req_to_token_pool</code> \u5b58\u50a8\u4e86\u4ece\u8bf7\u6c42\u5230\u4ee4\u724c\u4f4d\u7f6e\u7684\u903b\u8f91\u6620\u5c04</p> </li> <li> <p><code>token_to_kv_pool_allocator</code> \u7ba1\u7406 KV \u7f13\u5b58\u69fd\u7684\u7269\u7406\u5206\u914d</p> </li> </ul> <p><code>tree_cache</code> \u901a\u8fc7 <code>match_prefix()</code> \u8fd4\u56de\u73b0\u6709\u7684 KV \u7d22\u5f15(<code>out_cache_loc</code>)\uff0c\u4ece\u800c\u5b9e\u73b0\u524d\u7f00\u91cd\u7528 \uff0c\u907f\u514d\u4e86\u91cd\u65b0\u8ba1\u7b97\u548c\u91cd\u65b0\u5206\u914d\u3002</p> <p><code>tree_cache</code> \u901a\u8fc7 <code>cache_finished_req()</code> \u6216\u8005 <code>cache_unfinished_req()</code>(chunked prefill \u4f7f\u7528) \u6765\u91cd\u65b0\u63d2\u5165<code>prefix + new allocate</code> \u7684 <code>cache_loc</code>\uff0c\u7136\u540e\u91ca\u653e\u5197\u4f59\u7684 kv cache\u3002</p> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#_1","title":"\u7ec4\u4ef6\u8be6\u89e3","text":"","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#req_to_token_pool","title":"req_to_token_pool","text":"<p>\u8fd9\u662f\u4ece\u8bf7\u6c42\u5230\u5176\u4ee4\u724c\u7684\u952e\u503c\u7f13\u5b58\u7d22\u5f15\u7684\u6620\u5c04\u3002\u8fd9\u5c31\u662f\u6211\u4eec\u5728\u6ce8\u610f\u529b\u540e\u7aef\u56fe\u4e2d\u63d0\u5230\u7684 <code>req_to_token</code></p> <ul> <li> <p>\u5f62\u72b6\uff1a\u6700\u5927\u5141\u8bb8\u8bf7\u6c42\u6570\uff08\u7531\u53c2\u6570 <code>max-running-requests</code> \u8bbe\u7f6e\uff0c\u7528\u4e8e\u6307\u5b9a\u53ef\u540c\u65f6\u8fd0\u884c\u7684\u6700\u5927\u8bf7\u6c42\u6570\uff09* \u6bcf\u4e2a\u8bf7\u6c42\u7684\u6700\u5927\u4e0a\u4e0b\u6587\u957f\u5ea6\uff08\u7531\u914d\u7f6e model_config.context_len \u8bbe\u7f6e\uff09</p> </li> <li> <p>\u8bbf\u95ee\uff1a</p> </li> <li> <p>Dim0\uff1a <code>req_pool_indices</code> \u6807\u8bc6\u5177\u4f53\u8bf7\u6c42</p> </li> <li>Dim1\uff1a\u8bf7\u6c42\u4e2d\u6807\u8bb0\u7684\u4f4d\u7f6e\uff08\u4ece 0\u30011\u30012\u2026 \u5f00\u59cb\uff09\uff0c\u7528\u4e8e\u6807\u8bc6\u8bf7\u6c42\u4e2d\u7684\u7279\u5b9a\u6807\u8bb0\u3002</li> <li>Value: <code>out_cache_loc</code> \uff0c\u8868\u793a\u4ee4\u724c\u6307\u5411\u7531 Dim0 \u548c Dim1 \u6807\u8bc6\u7684\u4e0e\u8be5\u4ee4\u724c\u5173\u8054\u7684 KV \u7f13\u5b58\u7d22\u5f15\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#token_to_kv_pool","title":"token_to_kv_pool","text":"<p><code>req_to_token_pool</code> \u7ef4\u62a4\u4e86 Request \u5230 token KV \u7f13\u5b58\u7d22\u5f15\u7684\u6620\u5c04\u5173\u7cfb\uff0c <code>token_to_kv_pool</code> \u8fdb\u4e00\u6b65\u5c06 token \u4ece\u5176 KV \u7f13\u5b58\u7d22\u5f15\u6620\u5c04\u5230\u5176\u5b9e\u9645\u7684 KV \u7f13\u5b58\u6570\u636e\u3002</p> <ul> <li>Layout: Number of Layers _ Max Allowed Tokens Number _ Number of Head * Head Dimension</li> <li>\u8bbf\u95ee\uff1a</li> <li>Dim0\uff1a<code>layer_id</code> \u6807\u8bc6\u7279\u5b9a\u56fe\u5c42</li> <li>Dim1\uff1a<code>out_cache_loc</code> \u6807\u8bc6\u7279\u5b9a\u7684 KV \u7f13\u5b58\u7d22\u5f15\uff08\u7a7a\u95f2\u69fd\u4f4d\uff09</li> <li>Dim2\uff1a<code>head</code></li> <li>Dim3\uff1a<code>head_dim</code></li> <li>Value: k_buffer \u7684\u503c\u4e3a cache_k \uff0cv_buffer \u7684\u503c\u4e3a cache_v \uff0c\u8868\u793a\u5b9e\u9645\u7684\u952e\u503c\u7f13\u5b58\u6570\u636e\u3002</li> </ul> <p>\u8bf7\u6ce8\u610f\uff0c\u6211\u4eec\u901a\u5e38\u4f1a\u4e00\u6b21\u6027\u68c0\u7d22\u6574\u4e2a\u5c42\u7684 KV \u7f13\u5b58\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u8bf7\u6c42\u4e2d\u6240\u6709\u5148\u524d token \u7684 KV \u624d\u80fd\u8fdb\u884c forward\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#example","title":"Example","text":"\u8bf7\u6c42 prefix \u65b0chunk decode \u72b6\u6001 req\u2080 [A, B, C] [D, E] \u751f\u6210 [F] \u540e\u7ed3\u675f \u2705\u5148\u7ed3\u675f req\u2081 [A, B, C]\uff08\u5171\u4eabprefix\uff09 [G, H] \u751f\u6210 [I, J] \u540e\u7ed3\u675f \u540e\u7ed3\u675f <ul> <li>\u7cfb\u7edf\u4e2d\u5df2\u7ecf\u6709\u4e00\u4e2a prefix cache\uff1a</li> </ul> Python<pre><code>prefix_cache = {\"ABC\": [0, 1, 2]}  # KV\u69fd\u4f4d\n\ntoken_to_kv_pool = {\n    0: (k_A, v_A),\n    1: (k_B, v_B),\n    2: (k_C, v_C),\n}\n</code></pre> <p>Chunked Prefill\uff08\u4ec5\u5206\u914d\u65b0chunk\u90e8\u5206\uff09</p> <ul> <li><code>req\u2080</code> \u65b0chunk: [D, E]</li> <li><code>req\u2081</code> \u65b0chunk: [G, H]</li> <li>prefix <code>[A,B,C]</code> \u4e0d\u518d\u91cd\u7b97\uff0c\u76f4\u63a5\u590d\u7528\u69fd\u4f4d <code>[0,1,2]</code>\u3002</li> </ul> Python<pre><code>req_to_token_pool = {\n    0: [0, 1, 2, 3, 4],\n    1: [0, 1, 2, 5, 6],\n}\n\ntoken_to_kv_pool.update(\n    {\n        3: (k_D, v_D),\n        4: (k_E, v_E),\n        5: (k_G, v_G),\n        6: (k_H, v_H),\n    }\n)\n</code></pre> <p>\u7b2c\u4e00\u6b21Decode</p> <ul> <li><code>req\u2080</code> \u751f\u6210\u65b0 token F\uff08\u69fd\u4f4d7\uff09</li> <li><code>req\u2081</code> \u751f\u6210\u65b0 token I\uff08\u69fd\u4f4d8\uff09</li> </ul> Python<pre><code>req_to_token_pool = {\n    0: [0, 1, 2, 3, 4, 7],\n    1: [0, 1, 2, 5, 6, 8],\n}\n\ntoken_to_kv_pool.update(\n    {\n        7: (k_F, v_F),\n        8: (k_I, v_I),\n    }\n)\n</code></pre> <p><code>req\u2080</code> \u5df2\u751f\u6210\u5b8c\u6bd5\uff0c\u56e0\u6b64\u7cfb\u7edf\u91ca\u653e\u5176 \u975eprefix\u69fd\u4f4d <code>[3,4,7]</code>\uff0cprefix <code>[0,1,2]</code> \u4fdd\u7559\u4ee5\u4f9b\u590d\u7528\u3002<code>req\u2081</code> \u7ee7\u7eed\u8fdb\u884c decode</p> Python<pre><code>req_to_token_pool = {1: [0, 1, 2, 5, 6, 8]}\n\ntoken_to_kv_pool = {\n    0: (k_A, v_A),\n    1: (k_B, v_B),\n    2: (k_C, v_C),\n    5: (k_G, v_G),\n    6: (k_H, v_H),\n    8: (k_I, v_I),\n}\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#kv-cache","title":"\u6a21\u578b\u63a8\u7406\u4e2d\u7684 KV Cache \u7ba1\u7406\u6d41\u7a0b","text":"<p>\u8fd9\u91cc\u4e3a\u4e86\u7b80\u5316\u63d0\u53d6\u5173\u952e\u6d41\u7a0b\uff0c\u6211\u4eec\u5047\u8bbe\u8bbe\u7f6e <code>page_size=1</code> \uff0c\u5373\u9010 token \u7cbe\u786e\u5339\u914d\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#prefill","title":"Prefill","text":"<ol> <li>Step 1: Prefix Matching</li> </ol> <ul> <li>\u5f53\u6709\u65b0\u8bf7\u6c42\u5230\u8fbe\u65f6\uff0c <code>tree_cache.match_prefix()</code> \u65b9\u6cd5\u4f1a\u904d\u5386\u57fa\u6570\u6811\u4ee5\u627e\u5230\u6700\u957f\u7684\u7f13\u5b58\u524d\u7f00</li> <li><code>match_prefix()</code> \u51fd\u6570\u8fd4\u56de <code>prefix_indices</code> \uff08\u952e\u503c\u7f13\u5b58\u4f4d\u7f6e\u5f20\u91cf\uff09\u548c <code>last_node</code> \uff08\u8868\u793a\u5339\u914d\u524d\u7f00\u7684\u6811\u8282\u70b9\uff09\u3002\u8fd9\u4e9b <code>prefix_indices</code> \u76f4\u63a5\u6307\u5411\u53ef\u91cd\u7528\u7684\u7269\u7406\u952e\u503c\u7f13\u5b58\u69fd\u4f4d\u3002</li> </ul> <ol> <li>Step 2: Memory Allocation</li> </ol> <ul> <li>\u4e3a\u6279\u6b21\u5206\u914d\u952e\u503c\u7f13\u5b58\u65f6\uff0c\u7cfb\u7edf\u4f1a\u4f7f\u7528\u6811\u7f13\u5b58\u4e2d\u5df2\u7f13\u5b58\u7684<code>prefix_indices</code>\uff0c\u5e76\u4e14\u4ec5\u4e3a\u672a\u7f13\u5b58\u7684\u6807\u8bb0\u5206\u914d\u65b0\u7684\u7f13\u5b58</li> </ul> Python<pre><code># prefix reuse: \u4ece\u6811\u7f13\u5b58\u4e2d\u68c0\u7d22\u7f13\u5b58\u7684\u952e\u503c\u7d22\u5f15\nprefix_tensors = [r.prefix_indices for r in batch.reqs]\n# req_to_token_pool alloc: allocates slots for new tokens\nreq_pool_indices = alloc_req_slots(batch.req_to_token_pool, ...)\n# token_to_kv_pool alloc: kv cache allocation for new tokens\nout_cache_loc = alloc_token_slots(batch.tree_cache, ...)\n# mapping: writes both cached and new indices to req_to_token_pool\nwrite_cache_indices(...)\n</code></pre> <ol> <li>Step 3: Cache Insertion</li> </ol> <ul> <li>\u8ba1\u7b97\u5b8c\u6210\u540e\uff0c\u65b0\u7684\u952e\u503c\u7f13\u5b58\u901a\u8fc7 <code>cache_finished_req()</code> \u6216\u8005 <code>cache_unfinished_req()</code>\u88ab\u63d2\u5165\u56de\u6811\u7f13\u5b58\u4e2d\uff0c\u63d2\u5165\u8fc7\u7a0b\u4e2d\uff0c\u6811\u7f13\u5b58\uff1a<ul> <li>\u8bc6\u522b\u6811\u4e2d\u5df2\u5b58\u5728\u7684\u91cd\u590d\u524d\u7f00\uff08\u8fd4\u56de new_prefix_len \uff09</li> <li>\u901a\u8fc7 <code>token_to_kv_pool_allocator.free()</code> \u91ca\u653e\u91cd\u590d\u7684 KV \u7d22\u5f15</li> <li>\u4f7f\u7528\u65b0\u8282\u70b9\u66f4\u65b0 radix tree</li> <li>\u589e\u52a0/\u51cf\u5c11\u9501\u5f15\u7528\u4ee5\u4fdd\u62a4\u7f13\u5b58\u8282\u70b9\u514d\u53d7\u9a71\u9010</li> </ul> </li> </ul> <ol> <li>Step 4\uff1a\u7ecf\u8fc7 Scheduler \u8c03\u5ea6\u540e\uff0cmodelrunner \u8fdb\u884c\u6a21\u578b\u771f\u6b63\u6267\u884c\uff0c\u8fd9\u91cc\u4ee5 flash attention \u4f5c\u4e3a\u540e\u7aef\u4e3a\u4f8b</li> </ol> <ul> <li>\u83b7\u53d6 metadata\uff0c\u6bd4\u5982\u591a\u4e2a\u5e8f\u5217 <code>cur_q_len</code>\uff0c<code>cur_q_len</code> \u4ee5\u53ca\u6bcf\u4e2a\u5e8f\u5217\u7684 token \u9700\u8981\u7684 KV cache \u7d22\u5f15</li> <li>\u8c03\u7528 <code>flash-attn.flash_attn_with_kvcache()</code>\uff0c\u5c06 page table \u548c meta data \u4f5c\u4e3a\u53c2\u6570\u4f20\u5165\uff0c\u5c31\u7ed3\u675f\u4e86 prefill \u7684\u8fc7\u7a0b</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#decode","title":"Decode","text":"<p>Decode \u7684\u6d41\u7a0b\u5b9e\u9645\u4e0a\u4e0e Prefill \u76f8\u4f3c\uff0c\u53ea\u662f\u5206\u914d\u5185\u5b58\u65f6\uff0c\u6bcf\u4e2a token \u53ea\u9700\u8981\u5206\u914d 1 \u4e2a\u5373\u53ef\uff0c\u5176\u4f59\u64cd\u4f5c\u57fa\u672c\u76f8\u540c</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#summary","title":"Summary","text":"<p>\u501f\u7528[^kvcache] \u7684\u4e00\u5f20\u56fe\u4f5c\u4e3a\u603b\u7ed3</p> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/%E4%BB%8E%E4%BB%A3%E7%A0%81%E7%9C%8B%20SGLang%20%E7%9A%84%20KV%20Cache/#reference","title":"Reference","text":"<p>[^kvcache]: KV Cache \u4ee3\u7801\u89e3\u6790</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/","title":"\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u4e2d\u7684 Batching","text":"2025-11-202025-12-13 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#batching","title":"\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u4e2d\u7684 Batching","text":"<p> \u7ea6 5694 \u4e2a\u5b57  57 \u884c\u4ee3\u7801  11 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 29 \u5206\u949f</p> <p>AI Summary powered by \u901a\u4e49\u5343\u95ee</p> <p>\u5728\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u4e2d\uff0cBatching \u662f\u63d0\u5347 GPU \u5229\u7528\u7387\u3001\u964d\u4f4e\u5ef6\u8fdf\u7684\u5173\u952e\u6280\u672f\u3002LLM \u63a8\u7406\u5206\u4e3a Prefill\uff08\u9884\u586b\u5145\uff09 \u548c Decode\uff08\u89e3\u7801\uff09 \u4e24\u4e2a\u9636\u6bb5\uff0c\u524d\u8005\u8ba1\u7b97\u5bc6\u96c6\uff0c\u540e\u8005\u8bbf\u5b58\u5bc6\u96c6\u3002\u7531\u4e8e Decode \u9636\u6bb5\u7684\u5355 token \u8ba1\u7b97\u91cf\u5c0f\uff0c\u96be\u4ee5\u5145\u5206\u5229\u7528 GPU\uff0c\u56e0\u6b64\u901a\u8fc7 Batching \u5c06\u591a\u4e2a\u8bf7\u6c42\u5408\u5e76\u5904\u7406\uff0c\u63d0\u5347\u541e\u5410\u91cf\u3002</p> <p>\u65e9\u671f\u7684 \u9759\u6001\u6279\u5904\u7406\uff08Static Batching\uff09 \u867d\u7136\u80fd\u63d0\u5347\u6548\u7387\uff0c\u4f46\u5b58\u5728\u8ba1\u7b97\u6d6a\u8d39\u3001\u663e\u5b58\u6d6a\u8d39\u548c\u7a7a\u95f2 GPU cycles \u7b49\u95ee\u9898\u3002\u968f\u540e\u63d0\u51fa\u7684 Continuous Batching \u901a\u8fc7 \u8fed\u4ee3\u7ea7\u8c03\u5ea6\uff08Iteration-level Scheduling\uff09 \u5b9e\u73b0\u52a8\u6001\u6279\u6b21\u7ba1\u7406\uff0c\u5141\u8bb8\u8bf7\u6c42\u63d0\u524d\u9000\u51fa\u548c\u65b0\u8bf7\u6c42\u5373\u65f6\u52a0\u5165\uff0c\u51cf\u5c11\u7b49\u5f85\u65f6\u95f4\u3002\u4f46\u5176\u4ecd\u53d7\u9650\u4e8e Attention \u64cd\u4f5c\u5bf9\u5f20\u91cf\u5f62\u72b6\u7684\u8981\u6c42\uff0c\u65e0\u6cd5\u5b8c\u5168\u5b9e\u73b0\u9ad8\u6548\u6279\u5904\u7406\u3002</p> <p>\u4e3a\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0cPage Attention \u5f15\u5165\u5206\u9875\u673a\u5236\uff0c\u5c06 KV Cache \u5206\u6210\u7269\u7406\u5757\uff0c\u907f\u514d\u5185\u5b58\u788e\u7247\uff0c\u540c\u65f6\u652f\u6301\u4e0d\u540c\u957f\u5ea6\u548c\u9636\u6bb5\u7684\u8bf7\u6c42\u6279\u5904\u7406\u3002\u6b64\u5916\uff0cChunked Prefill \u548c FlashInfer \u7b49\u6280\u672f\u8fdb\u4e00\u6b65\u4f18\u5316\u4e86 Prefill \u548c Decode \u7684\u6df7\u5408\u6279\u6b21\u5904\u7406\uff0c\u63d0\u5347\u4e86\u6574\u4f53\u6027\u80fd\u4e0e\u670d\u52a1\u8d28\u91cf\u3002\u8fd9\u4e9b\u6280\u672f\u6f14\u8fdb\u5171\u540c\u63a8\u52a8\u4e86\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u5411\u66f4\u9ad8\u6548\u3001\u7075\u6d3b\u7684\u65b9\u5411\u53d1\u5c55\u3002</p> <p>\u73b0\u5728\u7684\u5927\u6a21\u578b\u63a8\u7406\u7684\u6846\u67b6\u57fa\u672c\u90fd\u5b9e\u73b0\u4e86 Continuous Batching\uff0c\u672c\u6587\u5c06\u4ece\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u4e3a\u4ec0\u4e48\u9700\u8981 Batching \u5f00\u59cb\uff0c\u9010\u6b65\u8bb2\u89e3\u8be5\u9886\u57df\u7684\u6280\u672f\u6f14\u8fdb\u3002</p> <p>Warning</p> <p>\u8fd9\u91cc\u5927\u6a21\u578b\u7279\u6307\u81ea\u56de\u5f52\u7c7b\u5927\u6a21\u578b(GPT \u7c7b)</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#two-phase-in-llm-inference","title":"Two Phase in LLM Inference","text":"<p>LLM \u63a8\u7406\u7531\u4e24\u4e2a\u9636\u6bb5\u7ec4\u6210 Prefill \u9636\u6bb5\u548c Decode \u9636\u6bb5</p> <ul> <li>\u9636\u6bb5 1\uff1a\u9884\u586b\u5145 (Prefill) - \u8ba1\u7b97\u5bc6\u96c6\u578b\uff1a\u5728\u9884\u586b\u5145\u9636\u6bb5\uff0c\u6a21\u578b\u5e76\u884c\u5904\u7406\u8f93\u5165\u63d0\u793a\u4e2d\u7684\u6240\u6709 \u00a0Token\uff0c\u4ee5\u8ba1\u7b97\u751f\u6210\u7b2c\u4e00\u4e2a\u8f93\u51fa Token \u6240\u9700\u7684\u952e\u503c\u7f13\u5b58 (KV Cache)\u00a0\u3002</li> <li>\u9636\u6bb5 2\uff1a\u89e3\u7801 (Decode) - \u8bbf\u5b58\u5bc6\u96c6\u578b\uff1a\u5728\u89e3\u7801\u9636\u6bb5\uff0c\u6a21\u578b\u4ee5\u81ea\u56de\u5f52 (Autoregressive) \u7684\u65b9\u5f0f_\u9010\u4e2a\u751f\u6210 Token\u00a0\u3002GPU \u9700\u8981\u4e3a\u751f\u6210\u7684\u6bcf\u4e00\u4e2a Token\u00a0 \u4ece\u9ad8\u5e26\u5bbd\u5185\u5b58 (HBM, \u5373 GPU \u663e\u5b58) \u4e2d\u91cd\u590d\u8bfb\u53d6\u5b8c\u6574\u7684\u6a21\u578b\u6743\u91cd\u548c\u5df2\u7d2f\u79ef\u7684\u3001\u89c4\u6a21\u5e9e\u5927\u7684 KV Cache\u00a0\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#why-batching","title":"Why Batching?","text":"<p>\u5bf9\u4e8e Prefill \u6765\u8bf4\uff0c\u5bf9\u6240\u6709 token \u8fdb\u884c Attention \u548c MLP \u64cd\u4f5c\uff0c\u8fd9\u662f\u4e00\u4e2a\u5927\u77e9\u9635\u4e58\u6cd5\uff08<code>[batch_size x hidden_dim] @ [hidden_dim x hidden_dim]</code>\uff09\uff0c\u53ef\u4ee5\u5145\u5206\u5229\u7528 GPU \u7684\u8ba1\u7b97\u8d44\u6e90</p> <p>\u800c Decode \u9636\u6bb5\uff0c\u4e00\u4e2a request \u4e00\u6b21\u53ea\u4f1a\u6839\u636e\u4e0a\u4e00\u4e2a token \u751f\u6210\u4e0b\u4e00\u4e2a token\uff0c\u76f8\u5f53\u4e8e\u505a\u4e00\u4e2a batch size = 1 \u7684\u77e9\u9635\u4e58\u6cd5\uff08<code>[1 x hidden_dim] @ [hidden_dim x hidden_dim]</code>\uff09\u3002\u8fd9\u662f\u4e00\u4e2a\u6781\u5c0f\u7684\u77e9\u9635\u4e58\u6cd5\u2014\u2014GPU \u65e0\u6cd5\u88ab\u6709\u6548\u5229\u7528</p> <p>Batching \u628a\u591a\u4e2a\u7528\u6237\u8bf7\u6c42\u5728\u540c\u4e00\u65f6\u95f4 \u201c\u6253\u5305\u201d \u5230\u4e00\u8d77\uff0c\u8ba9 GPU \u4e00\u6b21\u8ba1\u7b97\u591a\u4e2a\u5e8f\u5217\u7684 forward\u3002 \u8fd9\u6837\u77e9\u9635\u4e58\u6cd5\u4ece <code>[1 x hidden_dim] @ [hidden_dim x hidden_dim]</code> \u53d8\u6210 <code>[batch_size x hidden_dim] @ [hidden_dim x hidden_dim]</code> \u8fd9\u65f6 batch_size \u53ef\u4ee5\u662f\u51e0\u5341\u751a\u81f3\u4e0a\u767e\uff0c\u4ece\u800c\u663e\u8457\u63d0\u9ad8 GPU \u5229\u7528\u7387\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#batching-problems","title":"Batching Problems","text":"<p>\u9664\u4e86\u63d0\u5347\u63a8\u7406\u670d\u52a1\u7684\u541e\u5410\u91cf\uff0c\u964d\u4f4e TTFT\uff0cTBT \u5ef6\u8fdf\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u4e3a\u4e0b\u9762\u8fd9\u4e09\u79cd batching \u95ee\u9898\u63d0\u4f9b\u9ad8\u6548\u7684\u89e3\u51b3\u65b9\u6848\uff1a</p> <ol> <li> <p>\u4e24\u4e2a\u8bf7\u6c42\u90fd\u5904\u4e8e Prefill \u9636\u6bb5\uff0c\u4f46\u5404\u81ea\u7684\u8f93\u5165 token \u6570\u91cf\u4e0d\u540c\u3002</p> </li> <li> <p>\u4e24\u4e2a\u8bf7\u6c42\u90fd\u5904\u4e8e Decode \u9636\u6bb5\uff0c\u4f46\u5f53\u524d\u5904\u7406\u7684 token \u7d22\u5f15\uff08index\uff09\u4e0d\u540c\u3002</p> </li> <li> <p>\u4e24\u4e2a\u8bf7\u6c42\u5206\u5c5e\u4e0d\u540c\u9636\u6bb5\u2014\u2014\u4e00\u4e2a\u5728 Prefill \u9636\u6bb5\uff0c\u53e6\u4e00\u4e2a\u5728 Decode \u9636\u6bb5\u3002</p> </li> </ol> <p>\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e09\u4e2a\u95ee\u9898\u7684\u4ea7\u751f\u4e0e\u8ba1\u7b97\u5c42\u7684 kernel \u606f\u606f\u76f8\u5173\uff0c\u6240\u4ee5\u6211\u4eec\u9664\u4e86\u9700\u8981\u8003\u8651\u8c03\u5ea6\u5c42\u7684\u4f18\u5316\uff0c\u4e5f\u9700\u8981\u5bf9 kernel \u8fdb\u884c\u6539\u8fdb\uff0c\u4ece padding \u5230 prepacking\uff0c\u51cf\u5c0f\u8ba1\u7b97\u8d44\u6e90\u7684\u6d6a\u8d39\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#batching-technology-evolution","title":"Batching Technology Evolution","text":"<p>\u672c\u8282\u5c06\u7cfb\u7edf\u68b3\u7406\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u4e2d Batching \u6280\u672f\u7684\u6f14\u8fdb\u8def\u5f84\uff0c\u9610\u8ff0\u5176\u5982\u4f55\u4ece\u65e9\u671f\u7684\u9759\u6001\u6279\u5904\u7406\u9010\u6b65\u53d1\u5c55\u5230\u8fde\u7eed\u6279\u5904\u7406 + chunked prefill\u3002\u672c\u8282\u4e3b\u8981\u5173\u4e8e\u8c03\u5ea6\u5c42\u7684\u4f18\u5316\uff0c\u8ba1\u7b97\u5c42\u7684\u4f18\u5316\u7565\u6709\u6d89\u53ca\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#overview","title":"Overview","text":"<p>\u6700\u5f00\u59cb\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u662f\u901a\u8fc7\u9759\u6001\u6279\u5904\u7406\u5904\u7406\u591a\u4e2a\u8bf7\u6c42\uff0c\u4f46\u662f\u8fd9\u5e26\u6765\u4e86\u8ba1\u7b97\u6d6a\u8d39\u548c\u5927\u91cf\u7a7a\u95f2 GPU cycles \u7b49\u95ee\u9898\u3002\u9759\u6001\u6279\u5904\u7406\u53ef\u4ee5\u8ba4\u4e3a\u662f request-level \u7684\u8c03\u5ea6\uff0c\u540e\u7eed\u63d0\u51fa\u4e86token-level \u7684\u8fde\u7eed\u6279\u5904\u7406\uff0c\u5141\u8bb8\u8bf7\u6c42\u63d0\u524d\u9000\u51fa\u548c\u7acb\u5373\u5f00\u59cb\u63a8\u7406\u3002</p> <p>\u4f46\u662f\u771f\u6b63\u9ad8\u6548\u89e3\u51b3\u4e86 Batching Problems \u662f\u591a\u79cd\u6280\u672f\u7684\u878d\u5408\uff1a</p> <ul> <li> <p>ORCA \u63d0\u51fa\u4e86 <code>iteration-level scheduling</code>\uff0c\u5141\u8bb8\u8bf7\u6c42\u63d0\u524d\u9000\u51fa\u548c\u7acb\u5373\u8fdb\u5165\u3002</p> </li> <li> <p>Page Attention \u89e3\u51b3\u4e86\u95ee\u9898 2\uff0c\u901a\u8fc7\u5b9a\u5236\u5316\u7684 kernel \u5b9e\u73b0\u4e86\u5bf9\u53d8\u957f kv cache \u7684 attention \u8ba1\u7b97\u3002\u800c\u95ee\u9898 1 \u7531\u5176\u4ed6\u7b2c\u4e09\u65b9\u5e93\u7684 kernel \u89e3\u51b3\u3002</p> </li> <li> <p>Chunked Prefill \u5229\u7528 FlashInfer \u63d0\u4f9b\u7684 Kernel\uff0c\u89e3\u51b3\u4e86\u4e09\u4e2a Batching \u95ee\u9898\u3002\u540c\u65f6\u5c06 prefill \u5206\u5757\u4e0e decode \u5171\u540c\u7ec4\u6210\u4e00\u4e2a batch\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u5728 TBT \u670d\u52a1\u8d28\u91cf\u540c\u65f6\u589e\u52a0 decode \u9636\u6bb5\u7684\u7b97\u672f\u5bc6\u96c6\u7a0b\u5ea6\u3002</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#static-batching","title":"Static Batching(\u9759\u6001\u6279\u5904\u7406)","text":"<p>\u9759\u6001\u6279\u5904\u7406\uff08Static Batching\uff09\uff1a\u5728\u63a8\u7406\u5f00\u59cb\u4e4b\u524d\uff0c\u56fa\u5b9a\u4e00\u7ec4\u8bf7\u6c42\uff08\u56fa\u5b9a batch size\uff09\uff0c\u5c06\u4e00\u7ec4 \\(N\\) \u4e2a\u5177\u6709\u4e0d\u540c\u957f\u5ea6 \\(L_1, L_2, \\\\dots, L_N\\) \u7684\u8f93\u5165\u8bf7\u6c42\uff08prompts\uff09\u5f3a\u884c\u8f6c\u6362\u4e3a\u4e00\u4e2a\u5bc6\u96c6\u7684\u3001\u77e9\u5f62\u7684\u5f20\u91cf\u3002\u8be5\u64cd\u4f5c\u901a\u8fc7\u5c06\u6240\u6709\u5e8f\u5217\u586b\u5145 (Padding) \u5230\u6279\u6b21\u4e2d\u201c\u6700\u957f\u5e8f\u5217\u7684\u957f\u5ea6\u201d \\(L\\_{max}\\) \u6765\u5b9e\u73b0\uff0c\u6700\u7ec8\u5f62\u6210\u4e00\u4e2a\u5f62\u72b6\u4e3a \\([N, L\\_{max}]\\) \u7684\u5f20\u91cf\u3002</p> <p>Note</p> <p>\u6807\u51c6\u7684 MatMul Kernel \u65e0\u6cd5\u76f4\u63a5\u64cd\u4f5c \u201c\u4e0d\u89c4\u5219\u201d (ragged) \u6216\u53ef\u53d8\u957f\u5ea6\u7684\u5e8f\u5217\u3002\u56e0\u6b64\uff0c\u586b\u5145\u6210\u4e3a\u4e86\u4e00\u79cd\u5fc5\u9700\u7684\u201c\u9884\u5904\u7406\u201d\u6b65\u9aa4\uff0c\u4ee5\u4fbf\u5c06\u591a\u4e2a\u72ec\u7acb\u8bf7\u6c42 flatten \u4e3a GPU \u53ef\u4ee5\u4e00\u6b21\u6027\u5904\u7406\u7684\u5355\u4e00\u3001\u5927\u578b\u8ba1\u7b97\u4efb\u52a1\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#problems","title":"Problems","text":"<p>\u8fd9\u79cd\u5904\u7406\u65b9\u5f0f\u6765\u89e3\u51b3\u4e0a\u9762\u7684 batching Problems \u5e26\u6765\u4e86\u4e00\u7cfb\u5217\u7684\u95ee\u9898\uff1a</p> <ul> <li> <p>\u95ee\u9898 1\uff1a\u8ba1\u7b97\u6d6a\u8d39 (Compute Waste)</p> </li> <li> <p>GPU \u5df2\u7ecf\u4e3a\u8ba1\u7b97\u6574\u4e2a \\([N, L\\_{max}, L\\_{max}]\\) \u77e9\u9635\uff08\u5305\u62ec\u6240\u6709 padding Token \u5bf9\uff09\u6d88\u8017\u4e86\u5927\u91cf\u7684 FLOPs\u3002</p> </li> <li> <p>\u95ee\u9898 2\uff1a\u663e\u5b58\u6d6a\u8d39 (VRAM Waste)</p> </li> <li> <p>\u9ad8\u663e\u5b58\u5360\u7528\u4e3b\u8981\u5f52\u548e\u4e8e KV Cache\u3002KV Cache \u7684\u5927\u5c0f\u4e0e\u5e8f\u5217\u957f\u5ea6\u548c\u6279\u6b21\u5927\u5c0f\u6210\u7ebf\u6027\u5173\u7cfb\\(Size = b \\\\times t \\\\times n_layers \\\\times n_heads \\\\times d_head \\\\times p_a\\)\uff0c\u5176\u4e2d \\(b\\) \u662f\u6279\u6b21\u5927\u5c0f\uff0c\\(t\\) \u662f\u5e8f\u5217\u603b\u957f\u5ea6\u3002</p> </li> <li> <p>\u5728\u9759\u6001\u6279\u5904\u7406\u4e2d\uff0c\u7cfb\u7edf\u5fc5\u987b\u4e3a\u6279\u6b21\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5e8f\u5217\uff0c\u9884\u5148\u5206\u914d\u4e00\u4e2a\u8db3\u4ee5\u5bb9\u7eb3\u5b8c\u6574\u586b\u5145\u957f\u5ea6 \\(L\\_{max}\\) \u7684 KV Cache \u7f13\u51b2\u533a \u3002</p> </li> <li> <p>\u95ee\u9898 3\uff1a\u7a7a\u95f2\u7684 GPU cycles</p> </li> <li> <p>\u8bf7\u6c42\u5728\u4e0d\u540c\u7684\u8fed\u4ee3\u4e2d\u7ed3\u675f\uff0c\u4e0d\u80fd\u63d0\u524d\u9000\u51fa\u3002\u53ea\u6709\u6574\u4e2a batch \u4e2d\u6700\u957f\u8bf7\u6c42\u7684\u7ed3\u675f\uff0c\u6574\u4e2a batch \u6240\u6709\u8bf7\u6c42\u624d\u80fd\u9000\u51fa</p> </li> <li>\u65b0\u7684\u8bf7\u6c42\u4e5f\u4e0d\u80fd\u7acb\u523b\u8fdb\u884c\u63a8\u7406\uff0c\u5fc5\u987b\u7b49\u5f85\u6574\u4e2a batch \u63a8\u7406\u7ed3\u675f</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#continuous-batching","title":"Continuous Batching","text":"<p><code>ORCA\uff1aA Distributed Serving System for Transformer-Based Generative Models</code> \u9996\u5148\u63d0\u51fa\u4e86 <code>iteration-level scheduling</code> \u7684\u8c03\u5ea6\u7b56\u7565\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f <code>token-levle scheduling</code>\u3002\u7531\u4e8e\u4e0d\u4f7f\u7528 padding\u4ee5\u53ca\u8ba1\u7b97\u5c42 kernel \u672c\u8eab\u7684\u9650\u5236\uff0c\u63d0\u51fa\u4e86 <code>selective batching</code> \u7b56\u7565\uff0c\u53ea\u5bf9 non-attention \u64cd\u4f5c\u8fdb\u884c batching</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#motivation","title":"Motivation","text":"<ul> <li> <p>\u6211\u4eec\u4e0d\u5e0c\u671b\u6d6a\u8d39\u8ba1\u7b97\u8d44\u6e90\uff0c\u8fd9\u91cc\u4e0d\u7528 padding\uff0c\u56e0\u4e3a padding \u5bf9\u8ba1\u7b97\u8d44\u6e90\u662f\u6781\u5927\u7684\u6d6a\u8d39</p> </li> <li> <p>\u6211\u4eec\u5e0c\u671b\u5c3d\u53ef\u80fd\u51cf\u5c0f TTFT \u548c TBT\uff0c\u6240\u4ee5\u63d0\u524d\u5b8c\u6210\u7684\u8bf7\u6c42\u8981\u7acb\u5373\u9000\u51fa\u63a8\u7406\u4ee5\u53ca\u540e\u6765\u7684\u8bf7\u6c42\u8981\u7acb\u5373\u5f00\u59cb\u63a8\u7406</p> </li> <li> <p>\u6211\u4eec\u5e0c\u671b Batching \u4efb\u610f\u4e00\u7ec4\u5927\u5c0f\u4e0d\u540c\u7684\u8bf7\u6c42\uff0c\u4f46\u662f\u5b58\u5728\u4e09\u79cd\u60c5\u5f62\u4f7f\u5f97\u4e00\u5bf9\u8bf7\u6c42\u65e0\u6cd5\u5728\u4e0b\u4e00\u6b21\u8fed\u4ee3\u4e2d\u5171\u540c\u6279\u5904\u7406\uff08length \u4e0d\u540c\uff0cKV Cache \u957f\u5ea6\u4e0d\u540c\uff09\uff1a</p> </li> </ul> <ol> <li>\u4e24\u4e2a\u8bf7\u6c42\u90fd\u5904\u4e8e\u542f\u52a8\u9636\u6bb5\uff08initiation phase\uff09\uff0c\u4f46\u5404\u81ea\u7684\u8f93\u5165 token \u6570\u91cf\u4e0d\u540c\u3002</li> <li>\u4e24\u4e2a\u8bf7\u6c42\u90fd\u5904\u4e8e\u589e\u91cf\u9636\u6bb5\uff08increment phase\uff09\uff0c\u4f46\u5f53\u524d\u5904\u7406\u7684 token \u7d22\u5f15\uff08index\uff09\u4e0d\u540c\u3002</li> <li>\u4e24\u4e2a\u8bf7\u6c42\u5206\u5c5e\u4e0d\u540c\u9636\u6bb5\u2014\u2014\u4e00\u4e2a\u5728\u542f\u52a8\u9636\u6bb5\uff0c\u53e6\u4e00\u4e2a\u5728\u589e\u91cf\u9636\u6bb5\u3002</li> </ol>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#design","title":"Design","text":"","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#iteration-level-scheduling","title":"\u8fed\u4ee3\u7ea7\u8c03\u5ea6\uff08Iteration-level scheduling\uff09","text":"<p>ORCA \u7684\u8c03\u5ea6\u5668\u53ef\u4ee5\u5728\u6bcf\u4e00\u6b21\u8fed\u4ee3\u540e\u52a8\u6001\u6539\u53d8\u8981\u5904\u7406\u7684\u8bf7\u6c42\u96c6\u5408\uff1a</p> <ul> <li>\u8c03\u5ea6\u5668\u5728\u6bcf\u6b21\u8fed\u4ee3\u7ed3\u675f\u540e\u90fd\u4f1a\u6536\u5230\u8fd4\u56de\u7ed3\u679c\uff0c\u56e0\u6b64\u5b83\u80fd\u591f\u68c0\u6d4b\u5230\u8bf7\u6c42\u662f\u5426\u5df2\u5b8c\u6210\uff0c\u5e76\u53ef\u4ee5\u7acb\u5373\u5c06\u751f\u6210\u7684 tokens \u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> <li>\u5bf9\u4e8e\u4e00\u4e2a\u65b0\u5230\u8fbe\u7684\u8bf7\u6c42\uff0c\u8be5\u8bf7\u6c42\u53ef\u4ee5\u5728\u5f53\u524d\u8fed\u4ee3\u6267\u884c\u5b8c\u4e4b\u540e\u7acb\u523b\u83b7\u5f97\u8c03\u5ea6\u673a\u4f1a\uff08\u5373\u8c03\u5ea6\u5668\u53ef\u5728\u4e0b\u4e00\u6b21\u8fed\u4ee3\u9009\u62e9\u5b83\u8fd0\u884c\uff09\uff0c\u4ece\u800c\u663e\u8457\u51cf\u5c11\u6392\u961f\u7b49\u5f85\u5ef6\u8fdf\u3002</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#selective-batching","title":"\u9009\u62e9\u6027\u6279\u5904\u7406\uff08Selective Batching\uff09","text":"<p>\u7531\u4e8e GPU \u8981\u6c42\u8f93\u5165\u9700\u8981 shape \u5b8c\u5168\u5bf9\u9f50\uff0c\u6240\u4ee5\u5373\u4f7f\u91c7\u7528 <code>iteration-level scheduling</code>\uff0c\u4ecd\u7136\u4e0d\u80fd\u5bf9 Attention \u5b9e\u73b0 batcing\u3002</p> <p>Warning</p> <p><code>torch.bmm</code> \u53ca\u5176\u4ee3\u8868\u7684\u6807\u51c6\u8ba1\u7b97\u8303\u5f0f\uff0c\u5728\u8bbe\u8ba1\u4e0a\u8981\u6c42\u6240\u6709\u6570\u636e\u5728\u5185\u5b58\u4e2d\u662f\u8fde\u7eed\u4e14\u7edf\u4e00\u7684\uff08contiguous and dense\uff09\u3002\u5b83\u5047\u8bbe\u6279\u6b21\u4e2d\u7684\u6240\u6709 K/V \u7f13\u5b58\u53ef\u4ee5\u88ab\u7ec4\u7ec7\u6210\u4e00\u4e2a\u5355\u4e00\u7684\u3001\u5de8\u5927\u7684\u3001\u5f62\u72b6\u89c4\u6574\u7684\u5f20\u91cf</p> <p>\u6240\u4ee5\u8fd9\u91cc\u53ea\u5bf9\u90e8\u5206\u64cd\u4f5c\u8fdb\u884c\u6279\u5904\u7406\uff0c\ud83d\udc80 \u5b9e\u9645\u4e0a\u8fd9\u662f\u5bf9\u8ba1\u7b97\u5c42\u7684\u59a5\u534f\uff1a</p> <ul> <li>Attention \u64cd\u4f5c\u4e0d\u80fd\u5904\u7406\u8fd9\u79cd\u4e0d\u89c4\u5219\u5f62\u72b6 tensor\uff0c\u5b83\u5fc5\u987b\u77e5\u9053\u6bcf\u4e2a token \u5c5e\u4e8e\u54ea\u4e2a\u8bf7\u6c42\uff0c\u4ee5\u786e\u4fdd\u6ce8\u610f\u529b\u4ec5\u5728\u540c\u4e00\u8bf7\u6c42\u7684 tokens \u4e4b\u95f4\u8ba1\u7b97</li> <li>\u975e\u6ce8\u610f\u529b\u7c7b\uff08non-Attention\uff09\u7684\u77e9\u9635\u4e58\u6cd5\uff08Linear\uff09\u3001\u5c42\u5f52\u4e00\u5316\uff08LayerNorm\uff09\u7b49\u64cd\u4f5c\u53ef\u4ee5\u76f4\u63a5 flatten \u6765\u5904\u7406\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u64cd\u4f5c\u4e0d\u9700\u8981\u533a\u5206 token \u5c5e\u4e8e\u54ea\u4e2a\u8bf7\u6c42</li> </ul> <p>Selective Batching \u673a\u5236\u80fd\u591f\u6839\u636e\u4e0d\u540c\u64cd\u4f5c\u7684\u7279\u6027\u505a\u51fa\u533a\u5206\uff1a</p> <ul> <li>\u5bf9\u4e8e Attention \u64cd\u4f5c\uff0c\u62c6\u5206\u6279\u6b21\uff0c\u5728\u6bcf\u4e2a\u8bf7\u6c42\u4e0a\u5355\u72ec\u6267\u884c\uff1b</li> <li>\u5bf9\u4e8e\u5176\u4ed6 \u975e Attention \u64cd\u4f5c\uff0c\u4e0d\u4ee5\u8bf7\u6c42\u4e3a\u5355\u4f4d\uff0c\u800c\u4ee5 token \u4e3a\u5355\u4f4d\u8fdb\u884c\u6279\u5904\u7406\u3002</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#problems_1","title":"Problems","text":"<p>\u5728 Orca (OSDI\u201922) \u4e2d\uff0c\u5fae\u8f6f\u63d0\u51fa\u4e86\u201c\u8fed\u4ee3\u7ea7\u8c03\u5ea6\uff08iteration-level scheduling\uff09\u201d\uff0c\u8ba9\u63a8\u7406\u7cfb\u7edf\u80fd\u52a8\u6001\u63a5\u5165\u548c\u91ca\u653e\u8bf7\u6c42\uff0c\u4ece\u800c\u6253\u7834\u4e86\u4f20\u7edf\u201c\u9759\u6001\u6279\u5904\u7406\u201d\u7684\u56fa\u5b9a\u6279\u6b21\u3002\u4f46\u4ecd\u7136\u6709\u4e24\u4e2a\u95ee\u9898\u4e9f\u9700\u89e3\u51b3\uff1a</p> <ul> <li>\u4ecd\u7136\u65e0\u6cd5\u5c06\u4e0d\u540c\u9636\u6bb5\u3001\u4e0d\u540c\u957f\u5ea6\u7684\u8bf7\u6c42\u6279\u5728\u4e00\u8d77\u6267\u884c\u3002</li> <li>Orca \u7528 Selective Batching \u5c40\u90e8\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898 \u2014\u2014 \u8ba9\u975e-Attention \u5c42\uff08\u5982 Linear\u3001LayerNorm\uff09\u8de8\u8bf7\u6c42\u6df7\u5408\u6267\u884c\uff0c\u4f46 Attention \u4ecd\u9700\u201c\u6309\u8bf7\u6c42\u62c6\u5f00\u201d\u8fd0\u884c\u3002</li> <li>\ud83d\udc80 \u672c\u8d28\u4e0a\uff0c\u5b83\u4ecd\u53d7\u9650\u4e8e\u300c\u540c\u5f62\u5f20\u91cf\u300d\u7684\u8981\u6c42\uff0cBatch \u5e76\u975e\u771f\u6b63\u8fde\u7eed\u6216\u65e0\u7f1d\u3002</li> <li>\u5185\u5b58\u788e\u7247\uff1a \u4f20\u7edf\u7684\u5185\u5b58\u5206\u914d\u5668\uff08\u5982 PyTorch \u4e2d\u7684\uff09\u8981\u6c42\u4e3a KV Cache \u5206\u914d\u8fde\u7eed\u7684(contiguous) VRAM \u5757(\u5916\u90e8\u788e\u7247)\uff0c\u5e76\u4e14\u4f1a\u5206\u914d\u6bd4 req \u66f4\u957f\u7684\u5185\u5b58\u4f5c\u4e3a\u9884\u7559\u7a7a\u95f4(\u5185\u90e8\u788e\u7247)</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#page-attention","title":"Page Attention","text":"<p><code>Efficient Memory Management for Large Language  Model Serving with PagedAttention</code> \u501f\u9274\u64cd\u4f5c\u7cfb\u7edf\u7684\u865a\u62df\u5185\u5b58\u548c\u5206\u9875\uff0c\u5c06 KV Cache \u5206\u6210\u4e0d\u540c\u7684 physical block\uff1b\u7cfb\u7edf\u4e3a\u6bcf\u4e2a request \u7ef4\u62a4\u4e00\u4e2a block table \u6620\u5c04\u903b\u8f91 token \u4f4d\u7f6e\u5230\u5b9e\u9645\u663e\u5b58\u7684\u7269\u7406\u5757\u4f4d\u7f6e\uff1b\u901a\u8fc7\u9ad8\u5ea6\u5b9a\u5236\u5316\u7684 PageAttention kernel \u89e3\u51b3\u4e86\u4e0d\u540c token index \u7684 decoding request \u6279\u5904\u7406\u95ee\u9898</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#movtivation","title":"Movtivation","text":"<p>\u4e3a\u4e86\u80fd\u591f\u5c06\u8bf7\u6c42 \u00a0<code>i</code>\u00a0 \u4e0e\u5176\u4ed6\u8bf7\u6c42\u6279\u5904\u7406\uff0c\u7cfb\u7edf\u5fc5\u987b\u63d0\u524d\u4e3a\u8bf7\u6c42 \u00a0<code>i</code>\u00a0 \u5206\u914d\u4e00\u5757\u8fde\u7eed\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u8fd9\u5757\u7a7a\u95f4\u5fc5\u987b\u5927\u5230\u8db3\u4ee5\u5bb9\u7eb3\u5176\u53ef\u80fd\u751f\u6210\u7684\u6700\u5927\u5e8f\u5217\u957f\u5ea6\uff08\u4f8b\u5982 2048 \u6216 4096 tokens\uff09\u3002\u8fd9\u79cd\u7b56\u7565\u5bfc\u81f4\u4e86\u707e\u96be\u6027\u7684\u5185\u5b58\u788e\u7247\uff1a</p> <ol> <li>\u5185\u90e8\u788e\u7247\uff08Internal Fragmentation\uff09\uff1a\u00a0 \u4e00\u4e2a\u7528\u6237\u53ea\u8f93\u5165\u4e86 10 \u4e2a token\uff0c\u751f\u6210\u4e86 190 \u4e2a token\uff08\u603b\u5171 200 tokens\uff09\u5c31\u7ed3\u675f\u4e86\u3002\u4f46\u7cfb\u7edf\u4e3a\u4ed6\u9884\u7559\u4e86 2048 tokens \u7684\u7a7a\u95f4\u3002\u8fd9\u5bfc\u81f4\u8be5\u8bf7\u6c42 90% \u7684\u9884\u7559\u663e\u5b58\u88ab\u767d\u767d\u6d6a\u8d39 \u00a0\u3002</li> <li>\u5916\u90e8\u788e\u7247\uff08External Fragmentation\uff09\uff1a\u00a0 \u968f\u7740\u8bf7\u6c42\u7684\u8fdb\u8fdb\u51fa\u51fa\uff0cGPU \u663e\u5b58\u88ab\u5206\u5272\u6210\u8bb8\u591a\u5c0f\u7684\u3001\u4e0d\u8fde\u7eed\u7684\u7a7a\u95f2\u5757\u3002\u5f53\u4e00\u4e2a\u65b0\u8bf7\u6c42\uff08\u4f8b\u5982\u9700\u8981 1024 tokens \u7684\u8fde\u7eed\u7a7a\u95f4\uff09\u5230\u8fbe\u65f6\uff0c\u5373\u4f7f\u603b\u7684\u7a7a\u95f2\u663e\u5b58\uff08\u4f8b\u5982 2000 tokens\uff09\u8db3\u591f\uff0c\u4f46\u7531\u4e8e\u627e\u4e0d\u5230\u8fde\u7eed\u7684 1024 tokens \u7a7a\u95f4\uff0c\u7cfb\u7edf\u4e5f\u4f1a\u56e0 OOM (Out-of-Memory) \u800c\u5d29\u6e83 \u00a0\u3002</li> </ol> <p></p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cvLLM \u63d0\u51fa\u4e86 PageAttention \u673a\u5236\u4ee5\u53ca\u5bf9\u5e94\u7684 Attention kernel \u89e3\u51b3\u4e86\u663e\u5b58\u788e\u7247\u95ee\u9898\u4ee5\u53ca Batching Problems \u4e2d\uff0c\u4e0d\u540c token index \u7684 decoding request \u6279\u5904\u7406\u7684\u95ee\u9898\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#design_1","title":"Design","text":"","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#page-attention_1","title":"Page Attention","text":"<p>vLLM \u7684 PagedAttention \u673a\u5236\uff0c\u5176\u7075\u611f\u6765\u81ea\u4e8e\u73b0\u4ee3\u64cd\u4f5c\u7cfb\u7edf\uff08OS\uff09\u4e2d\u6210\u719f\u7684\u865a\u62df\u5185\u5b58\u548c\u5206\u9875\u6280\u672f \u00a0\u3002</p> <p>vLLM \u7684\u5185\u5b58\u7ba1\u7406\u5668\u9996\u5148\u5c06 GPU \u663e\u5b58\u4e2d\u7528\u4e8e KV \u7f13\u5b58\u7684\u533a\u57df\uff0c\u5212\u5206\u4e3a\u6570\u5343\u4e2a\u5927\u5c0f\u56fa\u5b9a\u7684\u201c\u7269\u7406\u5757\u201d\uff08Physical Blocks\uff09\uff0c\u4f8b\u5982\uff0c\u6bcf\u4e2a\u5757\u56fa\u5b9a\u4e3a 16 tokens \u7684\u5927\u5c0f \u00a0\u3002</p> <p>\u5f53\u8bf7\u6c42\u751f\u6210 token \u65f6\uff0c\u7cfb\u7edf\u4f1a\u201c\u6309\u9700\u201d\uff08on-demand\uff09\u4e3a\u5176\u5206\u914d\u7269\u7406\u5757 \u00a0\u3002\u4e00\u4e2a 100-token \u7684 KV \u7f13\u5b58\uff0c\u73b0\u5728\u88ab\u5b58\u50a8\u5728 7 \u4e2a\uff08<code>100/16</code>\u00a0 \u5411\u4e0a\u53d6\u6574\uff09\u7269\u7406\u5757\u4e2d\u3002\u6700\u5173\u952e\u7684\u662f\uff0c\u8fd9\u4e9b\u7269\u7406\u5757\u5728\u663e\u5b58\u4e2d\u5b8c\u5168\u4e0d\u9700\u8981\u662f\u8fde\u7eed\u7684\u00a0\u3002</p> <p>\u8fd9\u79cd\u201c\u5206\u9875\u201d\u7ba1\u7406\u65b9\u5f0f\u5e26\u6765\u4e86\u7acb\u7aff\u89c1\u5f71\u7684\u5185\u5b58\u4f18\u52bf\uff1a</p> <ul> <li>\u6d88\u9664\u5185\u90e8\u788e\u7247\uff1a\u00a0 \u5185\u5b58\u6309\u9700\u5206\u914d\uff0c\u6700\u5c0f\u5355\u4f4d\u662f 1 \u4e2a\u5757\uff0816 tokens\uff09\uff0c\u53ea\u6709\u6700\u540e\u4e00\u4e2a\u5757\u7684\u5c3e\u90e8\u4f1a\u6709\u6d6a\u8d39\u3002</li> <li>\u6d88\u9664\u5916\u90e8\u788e\u7247\uff1a\u00a0 \u6240\u6709\u5757\u7684\u5927\u5c0f\u90fd\u76f8\u540c\uff0c\u4efb\u4f55\u4e00\u4e2a\u7a7a\u95f2\u5757\u90fd\u53ef\u4ee5\u88ab\u4efb\u4f55\u8bf7\u6c42\u4f7f\u7528 \u00a0\u3002</li> <li>\u5b9e\u73b0\u9ad8\u6548\u5171\u4eab\uff1a\u00a0 \u8fd9\u4e00\u8bbe\u8ba1\u4f7f\u5f97 KV \u7f13\u5b58\u7684\u5171\u4eab\u53d8\u5f97\u6781\u5176\u7b80\u5355\u548c\u5ec9\u4ef7\u3002\u4f8b\u5982\uff0c\u5728\u5e76\u884c\u91c7\u6837\uff08parallel sampling\uff09\u6216\u524d\u7f00\u7f13\u5b58\uff08prefix caching\uff09\u4e2d\uff0c\u591a\u4e2a\u903b\u8f91\u8bf7\u6c42\uff08\u4f8b\u5982\uff0c\u5177\u6709\u76f8\u540c prompt \u7684 3 \u4e2a\u8bf7\u6c42\uff09\u7684 KV \u7f13\u5b58\u53ef\u4ee5\u6307\u5411\u76f8\u540c\u7684\u7269\u7406\u5757\u00a0\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#prefill-first-schedule-policy","title":"Prefill First Schedule Policy","text":"<ul> <li>vLLM \u4f1a\u5c3d\u53ef\u80fd\u591a\u5730\u8c03\u5ea6\u65b0\u7684 prefill\uff0c\u7136\u540e\u624d\u6062\u590d\u6b63\u5728\u8fdb\u884c\u7684 decode\uff0c\u4ece\u800c\u5f15\u53d1 generation stall\u3002(\u727a\u7272 token \u95f4\u5ef6\u8fdf\uff08TBT\uff09\u6765\u6362\u53d6\u66f4\u9ad8\u541e\u5410\u7387)</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#pagedattention-kernel","title":"PagedAttention Kernel\uff1a\u5f02\u6784\u6279\u5904\u7406\u5728\u8ba1\u7b97\u5c42\u9762\u7684\u5b9e\u73b0","text":"<p>vLLM \u5b9e\u73b0\u4e86\u4e00\u4e2a\u9ad8\u5ea6\u5b9a\u5236\u5316\u7684 CUDA kernel\uff0c\u901a\u5e38\u79f0\u4e3a \u00a0<code>paged_attention_kernel</code>\u3002\u8fd9\u4e2a kernel \u4ece\u4e00\u5f00\u59cb\u5c31\u662f\u4e3a\u4e86\u5728 PagedAttention \u63d0\u4f9b\u7684\u975e\u8fde\u7eed\u3001\u5206\u9875\u7684\u5185\u5b58\u5e03\u5c40\u4e0a\u6267\u884c Attention \u8ba1\u7b97\u800c\u8bbe\u8ba1\u7684 \u00a0\u3002\u8fd9\u662f\u4e00\u4e2a\u5178\u578b\u7684\u201c\u5185\u5b58-\u8ba1\u7b97\u534f\u540c\u8bbe\u8ba1\u201d\uff08Memory-Compute Co-design\uff09\u7684\u8303\u4f8b \u00a0\u3002</p> <p>vLLM \u7684\u8c03\u5ea6\u7b56\u7565\u53ea\u4f1a\u5b58\u5728 all decode \u548c all prefill \u7684 batch\uff0cPageAttention Kernel \u5904\u7406\u7684\u6b63\u662f\u5305\u542b\u4e0d\u540c\u957f\u5ea6 KV Cache \u7684 decode batch\uff1b\u800c all prefill \u5219\u7531\u5176\u4ed6\u7684 batching kernel \u5904\u7406\uff0c\u5982 flashinfer kernel \u6216\u8005 flash attention\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#problems_2","title":"Problems","text":"<ul> <li>Prefill Block Decode\uff1a\u5b83\u4eec\u5728\u6267\u884c\u65b0\u7684 prefill\uff08\u9884\u586b\u5145\uff09\u65f6\u4f1a\u6682\u505c\u6b63\u5728\u8fdb\u884c\u7684 decode\uff08\u89e3\u7801\uff09\uff0c\u663e\u8457\u589e\u52a0 TBT\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#chunked-prefill","title":"Chunked Prefill","text":"<p><code>Taming Throughput-Latency Tradeoff in LLM Inference with Sarathi-Serve</code> \u63d0\u51fa\u4e86 <code>chunked prefill</code> \u548c\u4e00\u79cd\u6df7\u5408 <code>prefill</code> \u548c <code>decode</code> \u7684 <code>stall-free scheduling</code> \u8c03\u5ea6\u7b56\u7565\u3002\u53ef\u4ee5\u5728\u4fdd\u8bc1 TBT \u7684\u670d\u52a1\u8d28\u91cf\u540c\u65f6\uff0c\u5c3d\u53ef\u80fd\u589e\u52a0\u541e\u5410\u91cf\u3002</p> <p>\u5728\u7b97\u672f\u5bc6\u96c6\u5ea6\u6bd4\u8f83\u4f4e\u7684 decode \u9636\u6bb5\uff0c\u4e0e\u88ab\u5206\u5757\u7684 prefill \u4efb\u52a1\u4e00\u8d77\u4f5c\u4e3a\u4e00\u4e2a batch \u8fdb\u884c\u6279\u5904\u7406\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#motivation_1","title":"Motivation","text":"<ul> <li> <p>Cost Analysis of Prefill and Decode</p> </li> <li> <p>\u6279\u5904\u7406\u6781\u5927\u5730\u63d0\u9ad8\u4e86\u89e3\u7801\u9636\u6bb5\u7684\u541e\u5410\u91cf\uff0c\u4f46\u5bf9\u9884\u586b\u5145\u541e\u5410\u91cf\u5f71\u54cd\u5f88\u5c0f</p> </li> </ul> <p></p> <ul> <li> <p>Low Compute Utilization during Decodes</p> </li> <li> <p>Decode \u9636\u6bb5\u7684\u7b97\u672f\u5bc6\u96c6\u7a0b\u5ea6\u5f88\u4f4e\uff0cPrefill \u7b97\u672f\u5bc6\u96c6\u7a0b\u5ea6\u5f88\u9ad8</p> </li> <li>\u6211\u4eec\u53ef\u4ee5\u5728 decode \u9636\u6bb5\u8003\u8651\u52a0\u5165 prefill\uff0c\u5171\u540c\u7ec4\u6210\u4e00\u4e2a batch</li> </ul> <p></p> <ul> <li> <p>Throughput-Latency Trade-off</p> </li> <li> <p>vLLM \u4f1a\u5c3d\u53ef\u80fd\u591a\u5730\u8c03\u5ea6\u65b0\u7684 prefill\uff0c\u7136\u540e\u624d\u6062\u590d\u6b63\u5728\u8fdb\u884c\u7684 decode\uff0c\u4ece\u800c\u5f15\u53d1 generation stall\u3002(\u727a\u7272 token \u95f4\u5ef6\u8fdf\uff08TBT\uff09\u6765\u6362\u53d6\u66f4\u9ad8\u541e\u5410\u7387)</p> </li> <li> <p>Orca \u652f\u6301\u6df7\u5408\u6279\u6b21\uff08prefill + decode \u6df7\u5408\uff09\uff0c\u800c vLLM \u53ea\u80fd\u5904\u7406\u5168 prefill \u6216\u5168 decode \u7684\u6279\u6b21\u3002(\u727a\u7272 token \u95f4\u5ef6\u8fdf\uff08TBT\uff09\u6765\u6362\u53d6\u66f4\u9ad8\u541e\u5410\u7387)</p> <p>Warning</p> <p>\u5373\u4fbf\u5982\u6b64\uff0cOrca \u4ecd\u65e0\u6cd5\u5b8c\u5168\u907f\u514d stall\uff0c\u56e0\u4e3a\u542b\u6709\u957f prompt \u7684 prefill \u6279\u6b21\u6267\u884c\u65f6\u95f4\u592a\u957f\u3002</p> </li> <li> <p>FasterTransformer \u91c7\u53d6 \u4e25\u683c\u7684\u8bf7\u6c42\u7ea7\uff08request-level\uff09\u6279\u5904\u7406\uff0c\u4e0d\u4ea4\u53c9 prefill \u4e0e decode\u3002\u8fd9\u79cd\u201c\u5148\u5168\u90e8 decode\uff0c\u518d prefill \u65b0\u8bf7\u6c42\u201d\u7684\u65b9\u5f0f\u4fdd\u6301\u7a33\u5b9a\u5ef6\u8fdf\uff0c\u4f46 GPU \u95f2\u7f6e\u65f6\u95f4\u591a\uff0c\u541e\u5410\u7387\u8f83\u5dee\u3002</p> </li> <li> <p>Pipeline Bubbles waste GPU Cycles</p> </li> <li> <p>\u6211\u4eec\u5728\u63a8\u7406\u8fc7\u7a0b\u4e2d\u8bc6\u522b\u51fa\u4e09\u79cd\u7c7b\u578b\u7684\u6d41\u6c34\u7ebf\u6c14\u6ce1\uff08Pipeline Bubbles\uff09\uff1a</p> <ol> <li>\\(PB_1\\) \u578b\u6c14\u6ce1\uff1a\u7531\u4e8e\u76f8\u90bb\u4e24\u4e2a\u5fae\u6279\u6b21\u4e2d\u7684\u9884\u586b\u5145 token \u6570\u91cf\u4e0d\u540c\u800c\u4ea7\u751f\uff1b</li> <li>\\(PB_2\\) \u578b\u6c14\u6ce1\uff1a\u5f53\u9884\u586b\u5145\u9636\u6bb5\u4e0e\u89e3\u7801\u9636\u6bb5\u4ea4\u66ff\u6267\u884c\u65f6\uff0c\u7531\u4e8e\u4e24\u8005\u8ba1\u7b97\u65f6\u95f4\u4e0d\u540c\u800c\u4ea7\u751f\uff1b</li> <li>\\(PB_3\\) \u578b\u6c14\u6ce1\uff1a\u5f53\u4e0d\u540c\u5fae\u6279\u6b21\u7684\u89e3\u7801\u9636\u6bb5\u8ba1\u7b97\u65f6\u95f4\u4e0d\u540c\u800c\u4ea7\u751f\u3002</li> </ol> </li> <li> <p>\u8fd9\u79cd\u5dee\u5f02\u7684\u6839\u672c\u539f\u56e0\u5728\u4e8e\u6ce8\u610f\u529b\u8ba1\u7b97\u7684\u5f00\u9500\u53d6\u51b3\u4e8e\u7d2f\u79ef\u7684\u4e0a\u4e0b\u6587\u957f\u5ea6\uff08\u5373 KV-cache \u5927\u5c0f\uff09\uff0c\u800c\u8be5\u957f\u5ea6\u5728\u4e0d\u540c\u8bf7\u6c42\u4e4b\u95f4\u662f\u4e0d\u540c\u7684\u3002</p> </li> <li> <p>\u5982\u679c\u6211\u4eec\u80fd\u591f\u786e\u4fdd\u6bcf\u4e2a micro-batch \u6267\u884c\u7684\u8ba1\u7b97\u91cf\u5927\u81f4\u76f8\u540c\uff0c\u5c31\u80fd\u663e\u8457\u51cf\u5c11\u8fd9\u4e9b\u6d41\u6c34\u7ebf\u6c14\u6ce1\u3002</p> </li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#design_2","title":"Design","text":"<p>Sarathi-Serve \u91c7\u7528\u4e86\uff1a</p> <ul> <li> <p>Chunked Prefill\uff08\u5206\u5757\u9884\u586b\u5145\uff09\uff1a\u5c06\u957f prefill \u62c6\u5206\u4e3a\u591a\u4e2a\u5c0f\u5757\uff1b</p> </li> <li> <p>Stall-free Scheduling\uff08\u65e0\u505c\u987f\u8c03\u5ea6\uff09\uff1adecode \u4e0e\u5c0f\u5757 prefill \u4ea4\u9519\u6267\u884c\uff0c\u4e0d\u4f1a\u963b\u585e\uff1b</p> </li> <li> <p>Uniform Batching\uff08\u5747\u5300\u6279\u6b21\uff09\uff1a\u4f7f\u5f97\u540c\u4e00\u6279\u5185\u4efb\u52a1\u6267\u884c\u65f6\u95f4\u66f4\u63a5\u8fd1\uff0c\u5c3d\u53ef\u80fd\u51cf\u5c11\u6d41\u6c34\u7ebf\u6c14\u6ce1\u3002</p> </li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#chunked-prefill_1","title":"Chunked Prefill","text":"<p>\u89e3\u7801\u6279\u6b21\uff08decode batches\uff09\u53d7\u5236\u4e8e\u663e\u5b58\u5e26\u5bbd\uff0c\u5176\u7b97\u672f\u5f3a\u5ea6\uff08arithmetic intensity\uff09\u8f83\u4f4e\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u89e3\u7801\u6279\u6b21\u4e2d\u53e0\u52a0\u989d\u5916\u7684 prefill \u8ba1\u7b97\u4efb\u52a1\uff0c\u4f46\u662f\u5982\u679c\u76f4\u63a5\u5c06\u5982\u6b64\u957f\u7684\u9884\u586b\u5145\u4e0e\u89e3\u7801\u6279\u6b21\u6df7\u5408\u6267\u884c\uff0c\u4f1a\u5bfc\u81f4time-between-tokens\uff08TBT\uff09\u663e\u8457\u4e0a\u5347\u3002</p> <p>Chunked-Prefill\uff08\u5206\u5757\u9884\u586b\u5145\uff09 \u6280\u672f\uff0c\u5c06\u5927\u578b\u7684\u9884\u586b\u5145\u4efb\u52a1\u62c6\u5206\u4e3a\u591a\u4e2a\u5c0f\u5757\uff08chunk\uff09\uff0c\u5c06\u8fd9\u4e9b\u5206\u5757\u540e\u7684\u9884\u586b\u5145\u4e0e\u89e3\u7801\u4efb\u52a1\u7ec4\u5408\u6210\u5408\u9002 token \u6570\u91cf\u7684\u6279\u6b21\uff0c\u4ece\u800c\u5728\u4e0d\u8fdd\u53cd TBT SLO\uff08\u670d\u52a1\u7b49\u7ea7\u76ee\u6807\uff09 \u7684\u524d\u63d0\u4e0b\uff0c\u5145\u5206\u5229\u7528\u89e3\u7801\u9636\u6bb5\u7684\u7b97\u529b\u6f5c\u80fd\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#stall-free-scheduling","title":"Stall-free Scheduling","text":"<p>\u4e0e Orca \u548c vLLM \u4e0d\u540c\uff0c\u5b83\u4eec\u5728\u6267\u884c\u65b0\u7684 prefill\uff08\u9884\u586b\u5145\uff09\u65f6\u4f1a\u6682\u505c\u6b63\u5728\u8fdb\u884c\u7684 decode\uff08\u89e3\u7801\uff09\u3002</p> <p>\u65e0\u505c\u987f\u6279\u5904\u7406\uff08stall-free batching) \u5219\u5229\u7528\u89e3\u7801\u9636\u6bb5\u4e2d\u7b97\u672f\u5bc6\u96c6\u5ea6\u7684\u201c\u7a7a\u95f2\u7a97\u53e3\u201d\uff08arithmetic intensity slack\uff09\u6765\u63d2\u5165 Chunked Prefill\uff0c\u4ece\u800c\u4e0d\u6253\u65ad decode \u7684\u6267\u884c\u3002</p> <ul> <li>\u4f18\u5148\u5904\u7406\u4e0a\u4e00\u8f6e\u7684 decode batch</li> <li>\u5982\u679c budget \u8fd8\u6709\u5269\u4f59\uff0c\u5bf9 chunked prefill \u540e\u7eed\u7684 chunk \u8fdb\u884c\u5904\u7406</li> <li>\u5982\u679c\u8fd8\u6709\u5269\u4f59\uff0c\u5bf9\u65b0\u52a0\u5165\u7684 request \u8fdb\u884c chunked prefill\uff0c\u7136\u540e\u5904\u7406\u7b2c\u4e00\u4e2a chunk</li> </ul> <p></p> <ul> <li>Continuous Batching \u7ed3\u5408 Chunked Prefill \u57fa\u672c\u6784\u6210\u4e86\u73b0\u5728\u4e3b\u6d41\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u6846\u67b6\u7684\u8c03\u5ea6\u5c42\uff0c\u5728\u4fdd\u8bc1 TBT \u8d28\u91cf\u7684\u60c5\u51b5\u4e0b\u589e\u52a0 GPU \u5229\u7528\u7387\u3002</li> </ul> <p>\u4e0b\u4e00\u8282\u5c06\u4ecb\u7ecd\u8ba1\u7b97\u5c42\u662f\u5982\u4f55\u9002\u914d\u4e0d\u540c\u7684 batching \u7684</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#batching-kernel","title":"Batching Kernel","text":"<p>\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u9700\u8981\u65b0\u7684 kernel \u6765\u9002\u914d\u4e0a\u9762\u4e09\u4e2a\u4e0d\u540c\u7684 Batching \u60c5\u51b5\u3002\u6211\u4eec\u4f1a\u4ecb\u7ecd\u9488\u5bf9\u53d8\u957f prefill \u7684 prepacking \u6280\u672f\u4ee5\u53ca vLLM \u4f7f\u7528\u7684 flashinfer \u548c flashattention \u5185\u6838\u51fd\u6570\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#prepacking-technology","title":"Prepacking Technology","text":"<p>\u8be5\u6280\u672f\u662f\u89e3\u51b3\u53d8\u957f Prefill \u7684\u5173\u952e\uff0c\u628a\u591a\u4e2a\u8f83\u77ed\u7684 prompt \u653e\u5165\u4e00\u4e2a\u201c\u5bb9\u5668\u201d\u91cc\uff0c\u4f7f\u5f97\u603b\u957f\u5ea6\u63a5\u8fd1\u67d0\u4e00\u6700\u5927\u957f\u5ea6\uff0c\u907f\u514d padding\u3002</p> <ul> <li>\u5408\u5e76\u5e8f\u5217 + \u4fee\u6539 Attention Mask \u4e0e\u4f4d\u7f6e\u7f16\u7801 (Positional Encoding Restart)</li> <li>\u5728\u62fc\u63a5\u591a\u4e2a prompt \u4e3a\u4e00\u4e2a\u5e8f\u5217\u540e\uff0c\u5f15\u5165\u4e86\u72ec\u7acb\u63a9\u7801\uff08independent masking\uff09 \u4fdd\u8bc1\u4e0d\u540c prompt \u4e4b\u95f4 \u4e0d\u4f1a\u4e92\u76f8 attend\u3002</li> <li>\u4e00\u6b21 Prefill \u8c03\u7528\u591a\u4e2a Prompts \u7684 KV-Cache \u751f\u6210</li> <li>\u5229\u7528\u4e0a\u8ff0\u6253\u5305\u673a\u5236\uff0c\u53ef\u4ee5\u5728\u4e00\u6b21\u6a21\u578b\u8c03\u7528\u4e2d\u5904\u7406\u591a\u4e2a prompt\uff0c\u4ece\u800c\u751f\u6210\u591a\u4e2a KV-\u7f13\u5b58\u3002\u51cf\u5c11 kernel \u542f\u52a8\u5f00\u9500\u3001\u51cf\u5c11\u586b\u5145 token \u7684\u8ba1\u7b97\u6d6a\u8d39</li> </ul> <p></p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#flashinfer-flash-attention","title":"FlashInfer &amp; Flash Attention","text":"<p>vLLM \u7b49\u5927\u6a21\u578b\u63a8\u7406\u670d\u52a1\u7cfb\u7edf\u4f1a\u4f9d\u8d56\u4e13\u4e1a\u7684\u5185\u6838\u5e93\u5982 FlashInfer \u548c Flash Attention\u3002</p> <ul> <li>\u5b83\u4eec\u4e13\u95e8\u63d0\u4f9b\u9488\u5bf9\u5206\u9875 KV Cache \u7684\u9ad8\u6548 Batch \u6ce8\u610f\u529b\u5185\u6838 \u00a0\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#flashinfer","title":"FlashInfer","text":"<ul> <li> <p>\u63d0\u4f9b\u4e86\u4e00\u4e2a BatchPrefillWithPagedKVCacheWrapper\uff0c\u5141\u8bb8\u5bf9\u591a\u4e2a\u8bf7\u6c42\u5e26\u6709\u5206\u9875 KV Cache \u7684 prefill \u8fdb\u884c\u5904\u7406\u3002</p> </li> <li> <p><code>qo_indptr</code>\uff08length = num_sequences + 1\uff09</p> <ul> <li>\u542b\u4e49\uff1a<code>qo_indptr[i]</code> \u662f\u7b2c i \u4e2a sequence \u5728 q \u4e2d\u7684\u8d77\u59cb\u4f4d\u7f6e\uff08offset\uff09\uff0c<code>qo_indptr[i+1] - qo_indptr[i]</code> \u662f\u8be5 sequence \u5bf9\u5e94\u7684 query token \u6570\uff08prefill \u53ef\u80fd\u4e3a chunk \u957f\u5ea6\uff0cdecode \u4e3a 1\uff09\u3002</li> </ul> </li> <li> <p><code>kv_page_indptr</code>\uff08length = num_sequences + 1\uff09</p> <ul> <li>\u542b\u4e49\uff1a\u628a\u6241\u5e73\u9875\u8868 <code>kv_page_indices</code> \u5207\u5206\u6210\u6bcf\u4e2a sequence \u7684\u9875\u8303\u56f4\u3002\u7b2c i \u4e2a sequence \u4f7f\u7528\u7684\u9875\u662f <code>kv_page_indices[kv_page_indptr[i]:kv_page_indptr[i+1]]</code>\u3002</li> </ul> </li> <li> <p><code>kv_page_indices</code>\uff08flat list\uff09</p> <ul> <li>\u542b\u4e49\uff1a\u6309\u5e8f\u5217\u62fc\u63a5\u7684\u7269\u7406\u9875 id \u5217\u8868\uff0c\u6bcf\u4e2a entry \u662f\u4e00\u4e2a page \u7684\u5168\u5c40\u7d22\u5f15\uff08\u8303\u56f4 <code>0..max_num_pages-1</code>\uff09\u3002kernel \u7528\u8fd9\u4e2a\u7d22\u5f15\u53bb\u4ece <code>paged_kv_cache</code> \u4e2d\u53d6\u51fa\u8be5\u9875\u7684 K/V \u6570\u636e\u3002</li> </ul> </li> <li> <p><code>kv_last_page_len</code>\uff08length = num_sequences\uff09</p> <ul> <li>\u542b\u4e49\uff1a\u5bf9\u4e8e\u6bcf\u4e2a sequence\uff0c\u6700\u540e\u4e00\u4e2a page \u53ef\u80fd\u672a\u586b\u6ee1\uff08\u53ea\u6709 L \u4e2a\u6709\u6548 token\uff09\uff0c\u8fd9\u91cc\u8bb0\u5f55\u6700\u540e\u4e00\u4e2a page \u7684\u6709\u6548 token \u6570\uff08\u82e5\u6ee1\u9875\u5219\u7b49\u4e8e <code>page_size</code>\uff09\u3002\u7528\u4e8e\u8ba1\u7b97 attention \u65f6\u5c4f\u853d page \u5c3e\u90e8\u7684\u975e\u6cd5\u5143\u7d20\u3001\u907f\u514d\u8d8a\u754c\u4e0e\u9519\u8bef attention\u3002</li> </ul> </li> </ul> Python<pre><code>prefill_wrapper = flashinfer.BatchPrefillWithPagedKVCacheWrapper(\n    workspace_buffer, \"NHD\"\n)\n\nprefill_wrapper.plan(\n    qo_indptr,\n    paged_kv_indptr,\n    paged_kv_indices,\n    paged_kv_last_page_len,\n    num_qo_heads,\n    num_kv_heads,\n    head_dim,\n    page_size,\n    causal=True,\n)\n\n# =========================\n# \u9010\u5c42\u6267\u884c batch prefill attention\n# =========================\noutputs = []\nfor i in range(num_layers):\n    q = q_at_layer[i]\n    kv_cache = kv_cache_at_layer[i]\n    # \u8ba1\u7b97 batched prefill attention\uff08\u53ef\u590d\u7528 plan\uff09\n    o = prefill_wrapper.run(q, kv_cache)\n    outputs.append(o)\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#flash-attention","title":"Flash Attention","text":"<ul> <li>Flash Attention \u63d0\u4f9b\u4e86 \u00a0<code>flash_attn_with_kvcache</code> \u51fd\u6570\uff0c\u5b83\u76f4\u63a5\u63a5\u53d7\u6574\u4e2a\u9875\u8868\uff0c\u5b83\u63d0\u4f9b\u4e86\u5bf9\u5206\u9875 KV \u7f13\u5b58\uff08\u9875\u9762\u5927\u5c0f &gt; 1\uff09\u7684\u539f\u751f\u652f\u6301\uff0c\u5141\u8bb8 \u201cragged tensor\uff08\u4e0d\u89c4\u5219\u5f20\u91cf\uff09\u201d \u7684\u5904\u7406\uff0c\u800c \u00a0<code>flash_attn_varlen_func</code>\u00a0 \u4e0d\u652f\u6301\u9875\u8868\u3002</li> </ul> <p><code>flash_attn_varlen_func</code> \u7528\u4e8e MLA\uff0c\u76f4\u63a5\u8ba1\u7b97 attention\uff0c\u4e0d\u4ece\u9884\u5b58\u7684 KV cache \u8bfb\u53d6</p> Python<pre><code>def flash_attn_with_kvcache(\n    q,\n    k_cache,\n    v_cache,\n    cache_seqlens: Optional[Union[(int, torch.Tensor)]] = None,\n    page_table: Optional[torch.Tensor] = None,\n    cu_seqlens_q: Optional[torch.Tensor] = None,\n    cu_seqlens_k_new: Optional[torch.Tensor] = None,\n    max_seqlen_q: Optional[int] = None,\n    causal=False,\n):\n    \"\"\"\n    Arguments:\n        q: (batch_size, seqlen, nheads, headdim)\n        k_cache: (batch_size_cache, seqlen_cache, nheads_k, headdim) if there's no page_table,\n            or (num_blocks, page_block_size, nheads_k, headdim) if there's a page_table (i.e. paged KV cache)\n            page_block_size must be a multiple of 256.\n        v_cache: (batch_size_cache, seqlen_cache, nheads_k, headdim_v) if there's no page_table,\n            or (num_blocks, page_block_size, nheads_k, headdim_v) if there's a page_table (i.e. paged KV cache)\n        cache_seqlens: int, or (batch_size,), dtype torch.int32. The sequence lengths of the\n            KV cache.\n        page_table [optional]: (batch_size, max_num_blocks_per_seq), dtype torch.int32.\n            The page table for the KV cache. It will derived attention backend's req_to_token_pool.\n        cu_seqlens_q: (batch_size,), dtype torch.int32. The cumulative sequence lengths of the query.\n        cu_seqlens_k_new: (batch_size,), dtype torch.int32. The cumulative sequence lengths of the new key/value.\n        max_seqlen_q: int. The maximum sequence length of the query.\n        causal: bool. Whether to apply causal attention mask (e.g., for auto-regressive modeling).\n\n    Return:\n        out: (batch_size, seqlen, nheads, headdim).\n    \"\"\"\n</code></pre>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#summary","title":"Summary","text":"<p>\u5728\u5927\u6a21\u578b\u63a8\u7406\u7cfb\u7edf\u4e2d\uff0cBatching \u662f\u541e\u5410\u91cf\u4e0e\u5ef6\u8fdf\u5e73\u8861\u7684\u6838\u5fc3\u673a\u5236\u3002\u5b83\u7684\u76ee\u6807\u662f\uff1a\u5728\u4e0d\u727a\u7272\u670d\u52a1\u8d28\u91cf\uff08TTFT\u3001TBT\uff09\u7684\u524d\u63d0\u4e0b\uff0c\u6700\u5927\u5316 GPU \u7684\u5229\u7528\u7387\uff0c\u5145\u5206\u6316\u6398\u7b97\u529b\u6f5c\u80fd\u3002</p> <p>\u4e0b\u9762\u6211\u4eec\u5c06\u91cd\u65b0\u56de\u987e\u4e0a\u9762\u7684\u6280\u672f\u6f14\u8fdb\u8fc7\u7a0b\uff1a\u4ece\u9759\u6001\u6279\u5904\u7406\u5230\u8fde\u7eed\u6279\u5904\u7406\u518d\u5230\u5206\u5757\u9884\u586b\u5145\u7684\u6f14\u5316\u8109\u7edc\uff0c\u4f53\u73b0\u4e86\u8c03\u5ea6\u5c42\u4e0e\u8ba1\u7b97\u5c42\u7684\u534f\u540c\u4f18\u5316\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#_1","title":"\u8c03\u5ea6\u5c42","text":"<ul> <li> <p>\u9759\u6001\u6279\u5904\u7406\uff08Static Batching\uff09\u2014\u2014Padding</p> </li> <li> <p>\u7279\u70b9\uff1a\u4e00\u6b21\u56fa\u5b9a batch \u6279\u91cf\u63a8\u7406\uff1b\u6240\u6709\u5e8f\u5217\u586b\u5145\u5230\u76f8\u540c\u957f\u5ea6\u3002</p> </li> <li>\u4f18\u52bf\uff1a\u5b9e\u73b0\u7b80\u5355\uff1b\u53ef\u76f4\u63a5\u5229\u7528\u6807\u51c6 dense kernel\u3002</li> <li>\u7f3a\u9677\uff1a\u5e26\u6765\u4e25\u91cd\u7684 \u8ba1\u7b97\u6d6a\u8d39\u3001\u663e\u5b58\u6d6a\u8d39 \u548c GPU \u7a7a\u95f2\u5468\u671f\uff1b\\     \u65e0\u6cd5\u52a8\u6001\u63a5\u5165\u8bf7\u6c42\u6216\u63d0\u524d\u9000\u51fa\u3002</li> </ul> <p>Note</p> <p>\u672c\u8d28\uff1arequest-level batching\uff0c\u4f4e\u6548\u4f46\u6613\u4e8e\u5b9e\u73b0\u3002</p> <ul> <li> <p>\u8fde\u7eed\u6279\u5904\u7406\uff08Continuous Batching / Iteration-level Scheduling\uff09\u2014\u2014\u8fed\u4ee3\u8c03\u5ea6\uff0c\u975e\u5bf9\u9f50\u6267\u884c</p> </li> <li> <p>\u4ee3\u8868\u7cfb\u7edf\uff1aORCA</p> </li> <li>\u6838\u5fc3\u601d\u60f3\uff1a\u6bcf\u6b21\u8fed\u4ee3\u540e\u53ef\u52a8\u6001\u8c03\u6574\u6279\u6b21\u7ec4\u6210\uff0c\u8ba9\u5df2\u5b8c\u6210\u8bf7\u6c42\u9000\u51fa\u3001\u65b0\u8bf7\u6c42\u7acb\u5373\u52a0\u5165\u3002</li> <li>\u5173\u952e\u4f18\u5316\uff1aSelective Batching \u2014\u2014 \u5bf9 non-Attention \u64cd\u4f5c\u8fdb\u884c\u8de8\u8bf7\u6c42 batching\uff0c\u907f\u514d padding\u3002</li> <li>\u74f6\u9888\uff1aAttention \u4ecd\u9700\u5355\u72ec\u6267\u884c\uff0c\u4ecd\u53d7\u9650\u4e8e\u201c\u540c\u5f62\u5f20\u91cf\u201d\u5047\u8bbe\uff1b\\     \u5185\u5b58\u5206\u914d\u788e\u7247\u4e25\u91cd\uff0c\u5f71\u54cd\u957f\u671f\u7a33\u5b9a\u6027\u3002</li> </ul> <p>Note</p> <p>\u672c\u8d28\uff1atoken-level batching\uff0c\u4f46\u53d7\u9650\u4e8e kernel \u80fd\u529b\u3002</p> <ul> <li> <p>Page Attention \u2014\u2014\u5206\u9875\u5185\u5b58\u7ba1\u7406 + page attention kernel</p> </li> <li> <p>\u4ee3\u8868\u7cfb\u7edf\uff1avLLM</p> </li> <li>\u521b\u65b0\u70b9\uff1a\u5f15\u5165 KV Cache \u5206\u9875\u673a\u5236\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u7ef4\u62a4 block table\uff0c\u5b9e\u73b0\u975e\u8fde\u7eed\u663e\u5b58\u7ba1\u7406\u3002</li> <li>\u4f18\u52bf\uff1a<ul> <li>\u6d88\u9664\u5185/\u5916\u90e8\u788e\u7247\uff1b</li> <li>\u652f\u6301\u4e0d\u540c token index \u7684\u89e3\u7801\u8bf7\u6c42\u6279\u5904\u7406\uff1b</li> <li>\u6781\u5927\u63d0\u5347\u5185\u5b58\u5229\u7528\u7387\u3002</li> </ul> </li> <li>\u5c40\u9650\uff1a<ul> <li>\u4ecd\u91c7\u7528 Prefill-First \u7b56\u7565\uff0c\u89e3\u7801\u9636\u6bb5\u4f1a\u88ab prefill \u963b\u585e\uff1b</li> <li>\u541e\u5410\u4e0e\u5ef6\u8fdf\u5b58\u5728\u663e\u8457\u6743\u8861\u3002</li> </ul> </li> </ul> <p>Note</p> <p>\u672c\u8d28\uff1a\u5728\u8ba1\u7b97\u5c42\u901a\u8fc7 PagedAttention Kernel \u652f\u6301\u4e0d\u540c\u957f\u5ea6 KV Cache \u7684 batch\u3002</p> <ul> <li> <p>Chunked Prefill + Stall-free Scheduling \u2014\u2014\u7b97\u529b\u5e73\u8861\u4e0e\u5ef6\u8fdf\u5171\u8d62</p> </li> <li> <p>\u4ee3\u8868\u7cfb\u7edf\uff1aSarathi-Serve</p> </li> <li>\u6838\u5fc3\u521b\u65b0\uff1a\u5c06\u957f prefill \u5206\u5757\uff08Chunked Prefill\uff09\uff0c\u4e0e decode \u9636\u6bb5\u4ea4\u9519\u6267\u884c\uff08Stall-free Scheduling\uff09\u3002</li> <li>\u4f18\u52bf\uff1a<ul> <li>\u517c\u987e\u7b97\u672f\u5bc6\u96c6\u4e0e\u8bbf\u5b58\u5bc6\u96c6\u9636\u6bb5\uff1b</li> <li>\u6d88\u9664 pipeline bubble\uff1b</li> <li>\u5728\u4fdd\u8bc1 TBT SLO \u7684\u524d\u63d0\u4e0b\u63d0\u5347\u541e\u5410\u7387\u3002</li> </ul> </li> </ul> <p>Note</p> <p>\u672c\u8d28\uff1aPrefill-Decode \u6df7\u5408\u6279\u6b21\u8c03\u5ea6\uff0c\u5b9e\u73b0\u541e\u5410\u4e0e\u5ef6\u8fdf\u7684\u52a8\u6001\u5e73\u8861\u3002</p>","tags":["LLMInference"]},{"location":"notes/sglang/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84%20Batching/#_2","title":"\u8ba1\u7b97\u5c42","text":"<ul> <li> <p>Kernel-Level \u6f14\u8fdb\uff1a\u4ece Padding \u5230 Prepacking</p> </li> <li> <p>Prepacking \u6280\u672f\u901a\u8fc7\u6253\u5305\u591a\u4e2a prompt\u3001\u4fee\u6539 attention mask \u548c positional encoding\uff0c\u5b9e\u73b0\u53d8\u957f prefill \u7684\u4e00\u6b21\u6027 KV-Cache \u751f\u6210\u3002</p> </li> <li> <p>FlashInfer / FlashAttention \u5219\u63d0\u4f9b\u5e95\u5c42\u9ad8\u6548\u7684 kernel \u5b9e\u73b0\uff0c\u652f\u6301 ragged tensor \u4e0e paged KV cache\uff0c\u771f\u6b63\u5b9e\u73b0\u4e86\u8ba1\u7b97\u5c42\u5bf9\u53d8\u957f\u5e8f\u5217\u7684\u53cb\u597d\u652f\u6301\u3002</p> </li> </ul> <p>Note</p> <p>\u672c\u8d28\uff1a\u7b97\u5b50\u5c42\u7684\u7ed3\u6784\u6027\u4f18\u5316\uff0c\u4e3a Continuous Batching \u4e0e Chunked Prefill \u63d0\u4f9b\u7b97\u529b\u652f\u6491\u3002</p>","tags":["LLMInference"]},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","title":"Slam","text":""},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#slam","title":"Slam","text":"<p> \u7ea6 892 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#_1","title":"\u56e0\u5b50\u56fe\u540e\u7aef\u4f18\u5316","text":""},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#_2","title":"\u56e0\u5b50\u56fe\u7684\u57fa\u672c\u601d\u60f3","text":"<p>\u5728 SLAM / VIO / V-SLAM \u4e2d\uff0c**\u56e0\u5b50\u56fe\uff08Factor Graph\uff09**\u662f\u63cf\u8ff0\u4f18\u5316\u95ee\u9898\u7ed3\u6784\u7684\u56fe\u6a21\u578b\uff1a</p> <ul> <li> <p>\u8282\u70b9\uff08Variables\uff09\uff1a\u8868\u793a\u5f85\u4f30\u8ba1\u7684\u72b6\u6001\u53d8\u91cf\uff0c\u4f8b\u5982\uff1a</p> </li> <li> <p>\u4f4d\u59ff\uff08camera pose\uff09\\(\\\\mathbf{T}\\_i = [\\\\mathbf{R}\\_i, \\\\mathbf{t}\\_i]\\)</p> </li> <li>\u5730\u6807\uff08landmark\uff09\\(\\\\mathbf{p}\\_j\\)</li> <li>IMU \u504f\u7f6e\uff08bias\uff09\\(\\\\mathbf{b}\\_i\\)</li> <li> <p>\u5bf9\u8c61\u8bed\u4e49\u7279\u5f81\uff08object feature\uff09\\(\\\\mathbf{o}\\_m\\)</p> </li> <li> <p>\u56e0\u5b50\uff08Factors\uff09\uff1a\u8868\u793a\u6d4b\u91cf\u7ea6\u675f \\(f_k(X_k) - z_k\\)\uff0c\u4f8b\u5982\uff1a</p> </li> <li> <p>\u76f8\u673a\u89c2\u6d4b\u56e0\u5b50\uff08\u89c6\u89c9\u91cd\u6295\u5f71\u8bef\u5dee\uff09</p> </li> <li>IMU \u56e0\u5b50\uff08\u60ef\u6027\u79ef\u5206\u8bef\u5dee\uff09</li> <li>\u8bed\u4e49\u7ea6\u675f\u56e0\u5b50\uff08\u8bed\u4e49\u4e00\u81f4\u6027\u8bef\u5dee\uff09</li> </ul> <p>\u6700\u7ec8\u7684\u76ee\u6807\u662f\uff1a</p> \\(\\(X^\\* = \\\\underset{X}{\\\\operatorname{argmin}} \\\\sum\\_{k} \\\\left\\| f_k(X_k) - z_k \\\\right\\|\\_{\\\\Sigma_k}^2\\)\\)"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#_3","title":"\u8054\u5408\u4f18\u5316\u7684\u603b\u4f53\u6d41\u7a0b","text":""},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#1variables","title":"\u6b65\u9aa4 1\uff1a\u72b6\u6001\u5b9a\u4e49\uff08Variables\uff09","text":"<p>\u5b9a\u4e49\u72b6\u6001\u91cf\u96c6\u5408 \\(X\\)\uff1a \\(\\(X = {\\\\mathbf{T}\\_1, \\\\mathbf{T}\\_2, \\\\ldots, \\\\mathbf{T}\\_N, \\\\mathbf{p}\\_1, \\\\mathbf{p}\\_2, \\\\ldots, \\\\mathbf{p}\\_M, \\\\mathbf{b}\\_1, \\\\mathbf{o}\\_1, \\\\ldots}\\)\\) \u5176\u4e2d\uff1a</p> <ul> <li>\\(\\\\mathbf{T}\\_i\\)\uff1a\u7b2c i \u5e27\u76f8\u673a\u7684\u4f4d\u59ff\uff08SE(3)\uff09</li> <li>\\(\\\\mathbf{p}\\_j\\)\uff1a\u7b2c j \u4e2a\u8def\u6807\u70b9\uff08\u5730\u56fe\u70b9\uff09</li> <li>\\(\\\\mathbf{b}\\_i\\)\u200b\uff1aIMU \u96f6\u504f\uff08bias\uff09</li> <li>\\(\\\\mathbf{o}\\_m\\)\u200b\uff1a\u8bed\u4e49\u5bf9\u8c61\u7279\u5f81\uff08\u5982\u68c0\u6d4b\u6846\u3001\u8bed\u4e49\u4e2d\u5fc3\uff09</li> </ul>"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#2measurement-factors","title":"\u6b65\u9aa4 2\uff1a\u6784\u5efa\u56e0\u5b50\uff08Measurement Factors\uff09","text":"<p>\u6211\u4eec\u6839\u636e\u4e0d\u540c\u4f20\u611f\u5668\u5efa\u7acb\u4e0d\u540c\u7c7b\u578b\u7684\u56e0\u5b50\uff0c\u6bcf\u4e2a\u56e0\u5b50\u5bf9\u5e94\u4e00\u4e2a\u6d4b\u91cf\u6a21\u578b \\(f_k(X_k)\\))\u3002</p>"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#1-reprojection-factor","title":"(1) \u89c6\u89c9\u56e0\u5b50\uff08Reprojection Factor\uff09","text":"<ul> <li> <p>\u6d4b\u91cf\uff1a\u56fe\u50cf\u4e2d\u50cf\u7d20\u5750\u6807 \\(z\\_{ij}\\)</p> </li> <li> <p>\u6a21\u578b\uff1a \\(\\(f\\_{\\\\text{vision}}(X_k) = \\\\pi(\\\\mathbf{T}\\_i^{-1}\\\\mathbf{p}\\_j)\\)\\)</p> </li> <li> <p>\u5176\u4e2d \\(\\\\pi(\\\\cdot)\\) \u662f\u76f8\u673a\u6295\u5f71\u6a21\u578b\u3002</p> </li> <li> <p>\u8bef\u5dee\uff1a \\(\\(e\\_{ij}^{\\\\text{vision}} = f\\_{\\\\text{vision}}(X_k) - z\\_{ij}\\)\\)\u200b</p> </li> <li> <p>\u7269\u7406\u542b\u4e49\uff1a\u5f53\u524d\u4f30\u8ba1\u7684\u4f4d\u59ff\u548c\u8def\u6807\u80fd\u5426\u5728\u50cf\u7d20\u5e73\u9762\u4e0a\u91cd\u6295\u5f71\u5230\u771f\u5b9e\u89c2\u6d4b\u70b9\u3002</p> </li> </ul>"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#2-imu-preintegration-factor","title":"(2) IMU \u56e0\u5b50\uff08Preintegration Factor\uff09","text":"<ul> <li> <p>\u6d4b\u91cf\uff1aIMU \u5728\u4e24\u5e27\u4e4b\u95f4\u7684\u52a0\u901f\u5ea6\u3001\u89d2\u901f\u5ea6\u8bfb\u6570\u3002</p> </li> <li> <p>\u6a21\u578b\uff08\u7ecf\u8fc7\u9884\u79ef\u5206\uff09\uff1a \\(\\(f\\_{\\\\text{imu}}(X_k) = \\\\text{Preintegrate}(\\\\mathbf{b}\\_i, \\\\Delta t)\\)\\)</p> </li> <li> <p>\u9884\u6d4b\u76f8\u90bb\u4e24\u5e27\u4e4b\u95f4\u7684\u8fd0\u52a8\u3002</p> </li> <li> <p>\u8bef\u5dee\u9879\uff1a \\(\\(e\\_{ij}^{\\\\text{imu}} = \\\\text{Log}\\\\left( (\\\\mathbf{T}\\_i^{-1}\\\\mathbf{T}_j) \\\\ominus f_{\\\\text{imu}}(X_k) \\\\right)\\)\\)</p> </li> <li> <p>\u7269\u7406\u542b\u4e49\uff1a\u5f53\u524d\u4f4d\u59ff\u4f30\u8ba1\u4e0eIMU\u6d4b\u5f97\u7684\u8fd0\u52a8\u53d8\u5316\u662f\u5426\u4e00\u81f4\u3002</p> </li> </ul>"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#3-semantic-factor","title":"(3) \u8bed\u4e49\u56e0\u5b50\uff08Semantic Factor\uff09","text":"<p>\u8bed\u4e49\u4fe1\u606f\u6765\u81ea\u8bed\u4e49\u5206\u5272\u6216\u76ee\u6807\u68c0\u6d4b\u6a21\u578b\uff0c\u7ea6\u675f\u5730\u56fe\u4e2d\u67d0\u4e9b\u7ed3\u6784\uff08\u5982\u5899\u9762\u3001\u884c\u4eba\u3001\u8f66\u8f86\uff09\u7684\u51e0\u4f55\u4e00\u81f4\u6027\u3002</p> <p>\u4f8b\u5982\uff1a</p> <ul> <li>\u8bed\u4e49\u5206\u5272\u63d0\u4f9b\u6bcf\u4e2a\u50cf\u7d20\u7684\u7c7b\u522b\u6982\u7387\uff1b</li> <li>\u68c0\u6d4b\u6846\u63d0\u4f9b\u8bed\u4e49\u5bf9\u8c61\u7684\u7a7a\u95f4\u7ea6\u675f\u3002</li> </ul> <p>\u53ef\u5b9a\u4e49\uff1a \\(\\(f\\_{\\\\text{sem}}(X_k) = g(\\\\mathbf{T}\\_i, \\\\mathbf{o}\\_m)\\)\\) \u8868\u793a\u5f53\u524d\u76f8\u673a\u59ff\u6001\u4e0e\u5bf9\u8c61\u4f4d\u7f6e\u4e4b\u95f4\u7684\u51e0\u4f55\u8bed\u4e49\u4e00\u81f4\u6027\u9884\u6d4b\u3002</p> <ul> <li> <p>\u8bef\u5dee\u9879\uff1a \\(\\(e\\_{im}^{\\\\text{sem}} = f\\_{\\\\text{sem}}(X_k) - z\\_{im}\\)\\)</p> </li> <li> <p>\u5176\u4e2d\\(z\\_{im}\\) \u662f\u8bed\u4e49\u89c2\u6d4b\uff08\u4f8b\u5982\u7269\u4f53\u7c7b\u522b\u3001\u50cf\u7d20\u4f4d\u7f6e\u6216mask\uff09\u3002</p> </li> <li> <p>\u7269\u7406\u542b\u4e49\uff1a\u5f53\u524d\u4f4d\u59ff\u4f30\u8ba1\u4e0b\uff0c\u9884\u6d4b\u7684\u7269\u4f53\u6295\u5f71\u5e94\u4e0e\u8bed\u4e49\u5206\u5272\u7ed3\u679c\u5339\u914d\u3002</p> </li> </ul>"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#3","title":"\u6b65\u9aa4 3\uff1a\u7ec4\u5408\u4ee3\u4ef7\u51fd\u6570","text":"<p>\u5c06\u6240\u6709\u8bef\u5dee\u9879\u52a0\u6743\u6c42\u548c\uff1a</p> \\(\\(J(X) = \\\\sum\\_{(i,j)\\\\in \\\\mathcal{C}} \\| e\\_{ij}^{\\\\text{vision}} \\|_{\\\\Sigma_v}^2 + \\\\sum_{(i,j)\\\\in \\\\mathcal{I}} \\| e\\_{ij}^{\\\\text{imu}} \\|_{\\\\Sigma_i}^2 + \\\\sum_{(i,m)\\\\in \\\\mathcal{S}} \\| e\\_{im}^{\\\\text{sem}} \\|\\_{\\\\Sigma_s}^2\\)\\)"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#4","title":"\u6b65\u9aa4 4\uff1a\u7ebf\u6027\u5316\u4e0e\u8fed\u4ee3\u4f18\u5316","text":"<p>\u7531\u4e8e\\(f_k(X_k\\) \u975e\u7ebf\u6027\uff0c\u9700\u7ebf\u6027\u5316\u540e\u4f7f\u7528 \u9ad8\u65af\u725b\u987f (Gauss-Newton) \u6216 LM (Levenberg\u2013Marquardt) \u4f18\u5316\u3002</p> <ol> <li>\u7ebf\u6027\u5316\uff1a \\(\\(f_k(X_k + \\\\delta X_k) \\\\approx f_k(X_k) + J_k \\\\delta X_k\\)\\)\u200b</li> <li>\u6784\u5efa\u7ebf\u6027\u65b9\u7a0b\uff1a \\(\\((J^T \\\\Sigma^{-1} J)\\\\delta X = -J^T \\\\Sigma^{-1} e\\)\\)</li> <li>\u6c42\u89e3\u589e\u91cf\\(\\\\delta X\\)\uff0c\u66f4\u65b0\u72b6\u6001\uff1a \\(\\(X \\\\leftarrow X \\\\oplus \\\\delta X\\)\\)</li> <li>\u91cd\u590d\u8fed\u4ee3\u76f4\u81f3\u6536\u655b\u3002</li> </ol>"},{"location":"notes/slam/Slam%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#5","title":"\u6b65\u9aa4 5\uff1a\u7ed3\u679c\u4e0e\u610f\u4e49","text":"<p>\u4f18\u5316\u540e\u5f97\u5230\uff1a \\(\\(X^\\* = {\\\\mathbf{T}\\_i^*, \\\\mathbf{p}\\_j^*, \\\\mathbf{b}\\_i^*, \\\\mathbf{o}\\_m^*}\\)\\) \u5373\u6700\u4f18\u4f30\u8ba1\u7684\u76f8\u673a\u8f68\u8ff9\u3001\u5730\u56fe\u70b9\u4f4d\u7f6e\u3001IMU\u504f\u7f6e\u4ee5\u53ca\u8bed\u4e49\u5bf9\u8c61\u4f4d\u7f6e\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/","title":"\u6bd5\u8bbe\uff1a\u9762\u5411\u590d\u6742\u5ba4\u5185\u73af\u5883\u7684\u65e0\u4eba\u673a\u81ea\u4e3b\u63a2\u7d22\u6846\u67b6","text":"2025-12-132025-12-13"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_1","title":"\u56e0\u5b50\u56fe\u540e\u7aef\u4f18\u5316","text":""},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_2","title":"\u56e0\u5b50\u56fe\u7684\u57fa\u672c\u601d\u60f3","text":"<p>\u5728 SLAM \u4e2d\uff0c\u56e0\u5b50\u56fe\uff08Factor Graph\uff09 \u662f\u63cf\u8ff0\u4f18\u5316\u95ee\u9898\u7ed3\u6784\u7684\u56fe\u6a21\u578b\uff1a</p> <ul> <li> <p>\u8282\u70b9\uff08Variables\uff09\uff1a\u8868\u793a\u5f85\u4f30\u8ba1\u7684\u72b6\u6001\u53d8\u91cf\uff0c\u4f8b\u5982\uff1a</p> </li> <li> <p>\u4f4d\u59ff\uff08camera pose\uff09\\(\\\\mathbf{T}\\_i = [\\\\mathbf{R}\\_i, \\\\mathbf{t}\\_i]\\)</p> </li> <li>\u5730\u6807\uff08landmark\uff09\\(\\\\mathbf{p}\\_j\\)</li> <li>IMU \u504f\u7f6e\uff08bias\uff09\\(\\\\mathbf{b}\\_i\\)</li> <li> <p>\u5bf9\u8c61\u8bed\u4e49\u7279\u5f81\uff08object feature\uff09\\(\\\\mathbf{o}\\_m\\)</p> </li> <li> <p>\u56e0\u5b50\uff08Factors\uff09\uff1a\u8868\u793a\u6d4b\u91cf\u7ea6\u675f \\(f_k(X_k) - z_k\\)\uff0c\u4f8b\u5982\uff1a</p> </li> <li> <p>\u76f8\u673a\u89c2\u6d4b\u56e0\u5b50\uff08\u89c6\u89c9\u91cd\u6295\u5f71\u8bef\u5dee\uff09</p> </li> <li>IMU \u56e0\u5b50\uff08\u60ef\u6027\u79ef\u5206\u8bef\u5dee\uff09</li> <li>\u8bed\u4e49\u7ea6\u675f\u56e0\u5b50\uff08\u8bed\u4e49\u4e00\u81f4\u6027\u8bef\u5dee\uff09</li> </ul> <p>\u6700\u7ec8\u7684\u76ee\u6807\u662f\uff1a \\(\\(X^\\* = \\\\underset{X}{\\\\operatorname{argmin}} \\\\sum\\_{k} \\\\left| f_k(X_k) - z_k \\\\right|\\_{\\\\Sigma_k}^2\\)\\)</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_3","title":"\u8054\u5408\u4f18\u5316\u7684\u603b\u4f53\u6d41\u7a0b","text":""},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#1variables","title":"\u6b65\u9aa4 1\uff1a\u72b6\u6001\u5b9a\u4e49\uff08Variables\uff09","text":"<p>\u5b9a\u4e49\u72b6\u6001\u91cf\u96c6\u5408 \\(X\\)\uff1a \\(\\(X = {\\\\mathbf{T}\\_1, \\\\mathbf{T}\\_2, \\\\ldots, \\\\mathbf{T}\\_N, \\\\mathbf{p}\\_1, \\\\mathbf{p}\\_2, \\\\ldots, \\\\mathbf{p}\\_M, \\\\mathbf{b}\\_1, \\\\mathbf{o}\\_1, \\\\ldots}\\)\\) \u5176\u4e2d\uff1a</p> <ul> <li>\\(\\\\mathbf{T}\\_i\\)\uff1a\u7b2c i \u5e27\u76f8\u673a\u7684\u4f4d\u59ff\uff08SE(3)\uff09</li> <li>\\(\\\\mathbf{p}\\_j\\)\uff1a\u7b2c j \u4e2a\u8def\u6807\u70b9\uff08\u5730\u56fe\u70b9\uff09</li> <li>\\(\\\\mathbf{b}\\_i\\)\u200b\uff1aIMU \u96f6\u504f\uff08bias\uff09</li> <li>\\(\\\\mathbf{o}\\_m\\)\u200b\uff1a\u8bed\u4e49\u5bf9\u8c61\u7279\u5f81\uff08\u5982\u68c0\u6d4b\u6846\u3001\u8bed\u4e49\u4e2d\u5fc3\uff09</li> </ul>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#2measurement-factors","title":"\u6b65\u9aa4 2\uff1a\u6784\u5efa\u56e0\u5b50\uff08Measurement Factors\uff09","text":"<p>\u6211\u4eec\u6839\u636e\u4e0d\u540c\u4f20\u611f\u5668\u5efa\u7acb\u4e0d\u540c\u7c7b\u578b\u7684\u56e0\u5b50\uff0c\u6bcf\u4e2a\u56e0\u5b50\u5bf9\u5e94\u4e00\u4e2a\u6d4b\u91cf\u6a21\u578b \\(f_k(X_k)\\))\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#1-reprojection-factor","title":"(1) \u89c6\u89c9\u56e0\u5b50\uff08Reprojection Factor\uff09","text":"<ul> <li> <p>\u6d4b\u91cf\uff1a\u56fe\u50cf\u4e2d\u50cf\u7d20\u5750\u6807 \\(z\\_{ij}\\)</p> </li> <li> <p>\u6a21\u578b\uff1a \\(\\(f\\_{\\\\text{vision}}(X_k) = \\\\pi(\\\\mathbf{T}\\_i^{-1}\\\\mathbf{p}\\_j)\\)\\)</p> </li> <li> <p>\u5176\u4e2d \\(\\\\pi(\\\\cdot)\\) \u662f\u76f8\u673a\u6295\u5f71\u6a21\u578b\u3002</p> </li> <li> <p>\u8bef\u5dee\uff1a \\(\\(e\\_{ij}^{\\\\text{vision}} = f\\_{\\\\text{vision}}(X_k) - z\\_{ij}\\)\\)\u200b</p> </li> <li> <p>\u7269\u7406\u542b\u4e49\uff1a\u5f53\u524d\u4f30\u8ba1\u7684\u4f4d\u59ff\u548c\u8def\u6807\u80fd\u5426\u5728\u50cf\u7d20\u5e73\u9762\u4e0a\u91cd\u6295\u5f71\u5230\u771f\u5b9e\u89c2\u6d4b\u70b9\u3002</p> </li> </ul>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#2-imu-preintegration-factor","title":"(2) IMU \u56e0\u5b50\uff08Preintegration Factor\uff09","text":"<ul> <li> <p>\u6d4b\u91cf\uff1aIMU \u5728\u4e24\u5e27\u4e4b\u95f4\u7684\u52a0\u901f\u5ea6\u3001\u89d2\u901f\u5ea6\u8bfb\u6570\u3002</p> </li> <li> <p>\u6a21\u578b\uff08\u7ecf\u8fc7\u9884\u79ef\u5206\uff09\uff1a \\(\\(f\\_{\\\\text{imu}}(X_k) = \\\\text{Preintegrate}(\\\\mathbf{b}\\_i, \\\\Delta t)\\)\\)</p> </li> <li> <p>\u9884\u6d4b\u76f8\u90bb\u4e24\u5e27\u4e4b\u95f4\u7684\u8fd0\u52a8\u3002</p> </li> <li> <p>\u8bef\u5dee\u9879\uff1a \\(\\(e\\_{ij}^{\\\\text{imu}} = \\\\text{Log}\\\\left( (\\\\mathbf{T}\\_i^{-1}\\\\mathbf{T}_j) \\\\ominus f_{\\\\text{imu}}(X_k) \\\\right)\\)\\)</p> </li> <li> <p>\u7269\u7406\u542b\u4e49\uff1a\u5f53\u524d\u4f4d\u59ff\u4f30\u8ba1\u4e0eIMU\u6d4b\u5f97\u7684\u8fd0\u52a8\u53d8\u5316\u662f\u5426\u4e00\u81f4\u3002</p> </li> </ul>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#3-semantic-factor","title":"(3) \u8bed\u4e49\u56e0\u5b50\uff08Semantic Factor\uff09","text":"<p>\u8bed\u4e49\u4fe1\u606f\u6765\u81ea\u8bed\u4e49\u5206\u5272\u6216\u76ee\u6807\u68c0\u6d4b\u6a21\u578b\uff0c\u7ea6\u675f\u5730\u56fe\u4e2d\u67d0\u4e9b\u7ed3\u6784\uff08\u5982\u5899\u9762\u3001\u884c\u4eba\u3001\u8f66\u8f86\uff09\u7684\u51e0\u4f55\u4e00\u81f4\u6027\u3002</p> <p>\u4f8b\u5982\uff1a</p> <ul> <li>\u8bed\u4e49\u5206\u5272\u63d0\u4f9b\u6bcf\u4e2a\u50cf\u7d20\u7684\u7c7b\u522b\u6982\u7387\uff1b</li> <li>\u68c0\u6d4b\u6846\u63d0\u4f9b\u8bed\u4e49\u5bf9\u8c61\u7684\u7a7a\u95f4\u7ea6\u675f\u3002</li> </ul> <p>\u53ef\u5b9a\u4e49\uff1a \\(\\(f\\_{\\\\text{sem}}(X_k) = g(\\\\mathbf{T}\\_i, \\\\mathbf{o}\\_m)\\)\\) \u8868\u793a\u5f53\u524d\u76f8\u673a\u59ff\u6001\u4e0e\u5bf9\u8c61\u4f4d\u7f6e\u4e4b\u95f4\u7684\u51e0\u4f55\u8bed\u4e49\u4e00\u81f4\u6027\u9884\u6d4b\u3002</p> <ul> <li> <p>\u8bef\u5dee\u9879\uff1a \\(\\(e\\_{im}^{\\\\text{sem}} = f\\_{\\\\text{sem}}(X_k) - z\\_{im}\\)\\)</p> </li> <li> <p>\u5176\u4e2d\\(z\\_{im}\\) \u662f\u8bed\u4e49\u89c2\u6d4b\uff08\u4f8b\u5982\u7269\u4f53\u7c7b\u522b\u3001\u50cf\u7d20\u4f4d\u7f6e\u6216mask\uff09\u3002</p> </li> <li> <p>\u7269\u7406\u542b\u4e49\uff1a\u5f53\u524d\u4f4d\u59ff\u4f30\u8ba1\u4e0b\uff0c\u9884\u6d4b\u7684\u7269\u4f53\u6295\u5f71\u5e94\u4e0e\u8bed\u4e49\u5206\u5272\u7ed3\u679c\u5339\u914d\u3002</p> </li> </ul>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#3","title":"\u6b65\u9aa4 3\uff1a\u7ec4\u5408\u4ee3\u4ef7\u51fd\u6570","text":"<p>\u5c06\u6240\u6709\u8bef\u5dee\u9879\u52a0\u6743\u6c42\u548c\uff1a</p> \\(\\(J(X) = \\\\sum\\_{(i,j)\\\\in \\\\mathcal{C}} \\| e\\_{ij}^{\\\\text{vision}} \\|_{\\\\Sigma_v}^2 + \\\\sum_{(i,j)\\\\in \\\\mathcal{I}} \\| e\\_{ij}^{\\\\text{imu}} \\|_{\\\\Sigma_i}^2 + \\\\sum_{(i,m)\\\\in \\\\mathcal{S}} \\| e\\_{im}^{\\\\text{sem}} \\|\\_{\\\\Sigma_s}^2\\)\\)"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#4","title":"\u6b65\u9aa4 4\uff1a\u7ebf\u6027\u5316\u4e0e\u8fed\u4ee3\u4f18\u5316","text":"<p>\u7531\u4e8e\\(f_k(X_k\\) \u975e\u7ebf\u6027\uff0c\u9700\u7ebf\u6027\u5316\u540e\u4f7f\u7528 \u9ad8\u65af\u725b\u987f (Gauss-Newton) \u6216 LM (Levenberg\u2013Marquardt) \u4f18\u5316\u3002</p> <ol> <li>\u7ebf\u6027\u5316\uff1a \\(\\(f_k(X_k + \\\\delta X_k) \\\\approx f_k(X_k) + J_k \\\\delta X_k\\)\\)\u200b</li> <li>\u6784\u5efa\u7ebf\u6027\u65b9\u7a0b\uff1a \\(\\((J^T \\\\Sigma^{-1} J)\\\\delta X = -J^T \\\\Sigma^{-1} e\\)\\)</li> <li>\u6c42\u89e3\u589e\u91cf\\(\\\\delta X\\)\uff0c\u66f4\u65b0\u72b6\u6001\uff1a \\(\\(X \\\\leftarrow X \\\\oplus \\\\delta X\\)\\)</li> <li>\u91cd\u590d\u8fed\u4ee3\u76f4\u81f3\u6536\u655b\u3002</li> </ol>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#5","title":"\u6b65\u9aa4 5\uff1a\u7ed3\u679c\u4e0e\u610f\u4e49","text":"<p>\u4f18\u5316\u540e\u5f97\u5230\uff1a \\(\\(X^\\* = {\\\\mathbf{T}\\_i^*, \\\\mathbf{p}\\_j^*, \\\\mathbf{b}\\_i^*, \\\\mathbf{o}\\_m^*}\\)\\) \u5373\u6700\u4f18\u4f30\u8ba1\u7684\u76f8\u673a\u8f68\u8ff9\u3001\u5730\u56fe\u70b9\u4f4d\u7f6e\u3001IMU\u504f\u7f6e\u4ee5\u53ca\u8bed\u4e49\u5bf9\u8c61\u4f4d\u7f6e\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_4","title":"\u6ed1\u52a8\u7a97\u53e3\u4f18\u5316\u539f\u7406","text":""},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#1","title":"1. \u95ee\u9898\u7684\u63d0\u51fa\uff1a\u5168\u5c40\u4f18\u5316\u7684\u5c40\u9650\u6027","text":"<p>\u5728\u89c6\u89c9-\u60ef\u6027 SLAM\uff08VIO\uff09\u6216\u5927\u89c4\u6a21 SLAM \u7cfb\u7edf\u4e2d\uff0c\u5168\u5c40\u675f\u8c03\u6574\uff08Full Bundle Adjustment, FBA\uff09\u65e8\u5728\u4f18\u5316\u6240\u6709\u5386\u53f2\u72b6\u6001\uff08\u4f4d\u59ff\u3001\u8def\u6807\u3001IMU \u504f\u7f6e\u7b49\uff09\uff0c\u5982\u516c\u5f0f (1) \u6240\u793a\uff1a</p> \\[ X^\\* = \\\\underset{X}{\\\\operatorname{argmin}} \\\\sum\\_{k} \\\\left| f_k(X_k) - z_k \\\\right|\\_{\\\\Sigma_k}^2 \\] <p>\u7136\u800c\uff0c\u968f\u7740\u65f6\u95f4 \\(t \\\\rightarrow \\\\infty\\)\uff0c\u72b6\u6001\u5411\u91cf ( X ) \u7684\u7ef4\u5ea6\u662f \u65e0\u754c\uff08unbounded\uff09 \u7684\u3002\u8fd9\u5bfc\u81f4\u975e\u7ebf\u6027\u6700\u5c0f\u4e8c\u4e58\u95ee\u9898\u4e2d\u7684 Hessian\uff08\u6216\u4fe1\u606f\u77e9\u9635\uff09</p> \\[ H = J^T \\\\Sigma^{-1} J \\] <p>\u7684\u89c4\u6a21\u65e0\u9650\u589e\u957f\uff0c\u5b9e\u65f6\u6c42\u89e3\u7684\u8ba1\u7b97\u590d\u6742\u5ea6\u6025\u5267\u4e0a\u5347\uff0c\u65e0\u6cd5\u6ee1\u8db3\u5b9e\u65f6\u6027\u8981\u6c42\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#2","title":"2. \u89e3\u51b3\u65b9\u6848\uff1a\u57fa\u4e8e\u6ed1\u52a8\u7a97\u53e3\u7684\u6709\u9650\u72b6\u6001\u4f18\u5316","text":"<p>\u4e3a\u4fdd\u8bc1\u8ba1\u7b97\u91cf\u7684\u6709\u754c\u6027\uff08bounded complexity\uff09\uff0c\u63d0\u51fa \u6ed1\u52a8\u7a97\u53e3\u4f18\u5316\uff08Sliding Window Optimization\uff09\u3002</p> <p>\u5176\u6838\u5fc3\u601d\u60f3\u662f\uff1a\\ \u5728\u4efb\u610f\u65f6\u523b \\(t\\)\uff0c\u4ec5\u5bf9\u4e00\u4e2a\u56fa\u5b9a\u5927\u5c0f\uff08Size \\(N\\)\uff09\u7684\u201c\u7a97\u53e3\u201d\u5185\u7684\u72b6\u6001\u5b50\u96c6 \\(X_w\\) \u8fdb\u884c\u4f18\u5316\u3002</p> \\[ X_w = {\\\\mathbf{T}\\_{t-N+1}, \\\\ldots, \\\\mathbf{T}\\_t, \\\\mathbf{p}\\_j, \\\\ldots} \\] <p>\u5176\u4e2d\u5305\u542b\u6700\u8fd1\u7684 \\(N\\) \u5e27\u4f4d\u59ff\u4ee5\u53ca\u5b83\u4eec\u6240\u89c2\u6d4b\u5230\u7684\u8def\u6807\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#3-marginalization","title":"3. \u6838\u5fc3\u539f\u7406\uff1a\u8fb9\u7f18\u5316\uff08Marginalization\uff09","text":"<p>\u5f53\u65b0\u7684\u5173\u952e\u5e27 \\(\\\\mathbf{T}_{t+1}\\) \u8fdb\u5165\u7a97\u53e3\u65f6\uff0c\u6700\u8001\u7684\u5173\u952e\u5e27 \\(\\\\mathbf{T}_{t-N+1}\\)\u4f1a\u88ab\u79fb\u51fa\u7a97\u53e3\u3002</p> <p>\u5982\u679c\u7b80\u5355\u4e22\u5f03\u8fd9\u4e9b\u72b6\u6001\u53ca\u5176\u56e0\u5b50\uff0c\u4f1a\u5bfc\u81f4\uff1a</p> <ul> <li>\u4fe1\u606f\u635f\u5931</li> <li>\u53ef\u89c2\u6027\uff08observability\uff09\u7834\u574f</li> <li>\u7cfb\u7edf\u5feb\u901f\u6f02\u79fb</li> </ul> <p>\u56e0\u6b64\u9700\u8981 \u8fb9\u7f18\u5316\uff1a\\ \u628a \\(\\\\mathbf{T}\\_{t-N+1}\\) \u4e2d\u5305\u542b\u7684\u4fe1\u606f\u201c\u8f6c\u79fb\u201d\u7ed9\u7a97\u53e3\u5185\u5269\u4f59\u53d8\u91cf\uff0c\u800c\u4e0d\u662f\u4e22\u5f03\u5b83\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#4-schur-complement","title":"4. \u6570\u5b66\u5b9e\u73b0\uff1a\u8212\u5c14\u8865\uff08Schur Complement\uff09","text":"<p>\u5c06\u5f85\u4f18\u5316\u7684\u72b6\u6001\u5206\u6210\u4e24\u90e8\u5206\uff1a</p> <ul> <li>\\(X_m\\)\uff1a\u5f85\u8fb9\u7f18\u5316\u7684\u72b6\u6001</li> <li>\\(X_r\\)\uff1a\u4fdd\u7559\u5728\u7a97\u53e3\u7684\u72b6\u6001</li> </ul> <p>\u7ebf\u6027\u5316\u540e\u7684\u7cfb\u7edf\uff1a</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#beginbmatrix-h_mm-h_mr-h_rm-h_rr-endbmatrix-beginbmatrix-delta-x_m-delta-x_r-endbmatrix","title":"$$ \\begin{bmatrix} H_{mm} &amp; H_{mr} \\ H_{rm} &amp; H_{rr} \\end{bmatrix} \\begin{bmatrix} \\delta X_m \\ \\delta X_r \\end{bmatrix}","text":"<p> \u7ea6 2964 \u4e2a\u5b57  27 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 15 \u5206\u949f</p> <p>\\begin{bmatrix} b_m \\ b_r \\end{bmatrix} $$</p> <p>\u4f7f\u7528\u8212\u5c14\u8865\u6d88\u53bb \\(\\\\delta X_m\\)\uff1a</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#h_rr-h_rm-h_mm-1-h_mr-delta-x_r","title":"$$ (H_{rr} - H_{rm} H_{mm}^{-1} H_{mr}) , \\delta X_r","text":"<p>(b_r - H_{rm} H_{mm}^{-1} b_m) $$</p> <p>\u5b9a\u4e49\uff1a</p> \\[ H' = H\\_{rr} - H\\_{rm} H\\_{mm}^{-1} H\\_{mr} \\] \\[ b' = b_r - H\\_{rm} H\\_{mm}^{-1} b_m \\] <p>\u65b0\u7cfb\u7edf \\(H' \\\\delta X_r = b'\\) \u4e0e\u539f\u7cfb\u7edf\u7269\u7406\u7b49\u4ef7\uff0c\u4f46\u53d8\u91cf \\(X_m\\)\u5df2\u88ab\u79fb\u9664\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#5-prior-factor","title":"5. \u5f62\u6210\u5148\u9a8c\u56e0\u5b50\uff08Prior Factor\uff09","text":"<p>\u4ee5\u4e0a\u5f97\u5230\u7684 \\(H'\\) \u548c \\(b'\\) \u6784\u6210\u4e00\u4e2a\u65b0\u7684 \u5148\u9a8c\u56e0\u5b50\uff08Prior Factor\uff09\u3002</p> <p>\u52a0\u5165\u5230\u7a97\u53e3\u4ee3\u4ef7\u51fd\u6570\u4e2d\uff1a</p> \\[ J(X_w) = \\\\sum\\_{k \\\\in \\\\text{Window}} | e_k |_{\\\\Sigma_k}^2 \\+ | e_{\\\\text{prior}} |_{\\\\Sigma_{\\\\text{prior}}}^2 \\] <p>\u5176\u4e2d \\(e\\_{\\\\text{prior}}\\) \u7531 \\(H'\\) \u548c \\(b'\\) \u6784\u6210\uff0c\u7528\u6765\u4fdd\u7559\u5df2\u88ab\u8fb9\u7f18\u5316\u5386\u53f2\u72b6\u6001\u5bf9\u5f53\u524d\u7684\u7ea6\u675f\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#6","title":"6. \u603b\u7ed3\u4e0e\u6743\u8861","text":"<p>\u6ed1\u52a8\u7a97\u53e3\u4f18\u5316\u901a\u8fc7\u8fb9\u7f18\u5316\uff0c\u5c06\u65e0\u9650\u589e\u957f\u7684\u5168\u5c40\u4f18\u5316\u95ee\u9898\uff0c\u8f6c\u5316\u4e3a\u4e00\u4e2a \u8ba1\u7b97\u590d\u6742\u5ea6\u6709\u754c\u3001\u53ef\u5b9e\u65f6 \u7684\u4f18\u5316\u8fc7\u7a0b\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_5","title":"\u4f18\u70b9","text":"<ul> <li>\u4fdd\u8bc1\u7cfb\u7edf\u5b9e\u65f6\u6027</li> <li>\u9002\u7528\u4e8e VIO\u3001\u524d\u7aef\u7d27\u8026\u5408 SLAM \u7b49\u9ad8\u9891\u4f18\u5316\u573a\u666f</li> </ul>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_6","title":"\u7f3a\u70b9\uff08\u5173\u952e\uff09","text":"<ul> <li>\u8fb9\u7f18\u5316\u662f\u4e00\u79cd\u4e0d\u53ef\u9006\u8fd1\u4f3c</li> <li>\u4f1a\u56fa\u5b9a\u88ab\u8fb9\u7f18\u5316\u53d8\u91cf\u7684\u7ebf\u6027\u5316\u70b9</li> <li>\u82e5\u7ebf\u6027\u5316\u70b9\u4e0d\u51c6\u786e\uff0c\u5c06\u5bfc\u81f4\u7cfb\u7edf \u4e0d\u4e00\u81f4\u6027\uff08Inconsistency\uff09</li> </ul> <p>\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u5f88\u591a\u73b0\u4ee3 SLAM\uff08\u5982 VINS-Mono\u3001OKVIS\u3001GVINS\uff09\u9700\u8981 carefully designed marginalization \u7b56\u7565\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_7","title":"\u63a2\u7d22\u7684\u8fc7\u7a0b","text":""},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#31","title":"3.1 \u603b\u4f53\u63a2\u7d22\u5faa\u73af\uff08\u4f2a\u4ee3\u7801\uff09","text":"Python<pre><code>Initialize SLAM, hierarchical maps\n\nwhile True:\n\n    Update sensor frames -&gt; SLAM update -&gt; update metric-semantic submap\n    Update topological map (cluster / split submaps)\n\n    # \u4e0a\u5c42\u51b3\u7b56\uff1a\u9009\u62e9\u4e0b\u4e00\u4e2a\u76ee\u6807 submap \u6216 viewpoint cluster\n    target = TopologicalSelector(topology, frontier_set, battery, time)\n    if target is None:\n        if ShouldStop(): break\n        else: continue\n\n    # \u4e0b\u5c42\u6267\u884c\uff1a\u5230\u76ee\u6807\u5e76\u5728\u5c40\u90e8\u7ef4\u62a4\u53ef\u89c2\u6d4b\u6027\n    success = LocalExecutionController(target)\n    if not success:\n        Mark target as failed / increase cost in topology\n        continue\n\n    # \u95ed\u73af\u68c0\u6d4b\uff1a\u88ab\u52a8\u6216\u4e3b\u52a8\u89e6\u53d1\n    LoopClosureManager.check_and_execute()\n\n    # \u540e\u5904\u7406\uff1a\u4f18\u5316\u4f4d\u59ff\u56fe\u3001\u66f4\u65b0 map consistency\n    if pose_graph_needs_optimization:\n        OptimizePoseGraph()\n\nend\n</code></pre>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#32-topologicalselector","title":"3.2 \u4e0a\u5c42\uff1a\u62d3\u6251\u9009\u62e9\u5668\uff08TopologicalSelector\uff09","text":"<p>\u8f93\u5165\uff1a \u62d3\u6251\u56fe\u3001\u672a\u8bbf\u95ee/\u90e8\u5206\u8bbf\u95ee submap \u5217\u8868\u3001\u6bcf\u4e2a submap \u7684\u9884\u671f\u4fe1\u606f\u589e\u76ca\u3001\u4efb\u52a1\u7ea7\u7ea6\u675f\uff08\u5269\u4f59\u7535\u91cf\u3001\u65f6\u95f4\uff09\u3001\u4f18\u5148\u7ea7\u7b56\u7565\u3002</p> <p>\u8f93\u51fa\uff1a \u76ee\u6807 submap \u6216\u89c6\u70b9\u7c07\u3002</p> <p>\u7b56\u7565\u793a\u4f8b\uff1a</p> <ul> <li> <p>\u8ba1\u7b97\u6bcf\u4e2a candidate \u7684\u6548\u7528\uff1a <code>U = IG / (travel_cost + \u03bb * uncertainty)</code>\u3002</p> </li> <li> <p>IG\uff08\u4fe1\u606f\u589e\u76ca\uff09\u53ef\u7531 submap \u7684 frontier \u9762\u79ef\u3001\u8bed\u4e49\u672a\u89c1\u533a\u57df\u3001\u53ca\u9884\u671f\u89c2\u5bdf\u7684\u8bed\u4e49\u591a\u6837\u6027\u5408\u6210\u3002</p> </li> <li> <p>\u9009\u62e9\u4f7f U \u6700\u5927\u7684 candidate\u3002\u5982\u679c\u6700\u5927 U &lt; \u9608\u503c\uff0c\u5219\u4e0d\u518d\u7ee7\u7eed\u9ad8\u5c42\u63a2\u7d22\u3002</p> </li> </ul>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#33-localexecutioncontroller","title":"3.3 \u4e0b\u5c42\uff1a\u5c40\u90e8\u6267\u884c\u63a7\u5236\uff08LocalExecutionController\uff09","text":"<p>\u804c\u8d23\uff1a\u4ece\u5f53\u524d\u4f4d\u59ff\u5230\u4e0a\u5c42\u6307\u5b9a\u7684\u5c40\u90e8\u76ee\u6807\u89c6\u70b9\u96c6\u5408\uff0c\u6267\u884c\u5c40\u90e8\u8def\u5f84\u89c4\u5212\uff08\u907f\u969c\uff09\u3001\u5728\u8def\u5f84\u4e0a\u7ef4\u62a4\u7279\u5f81\u89c2\u6d4b\u8d28\u91cf\uff08visibility preserving\uff09\uff0c\u5e76\u5728\u5230\u8fbe\u540e\u6267\u884c\u5c40\u90e8\u89c2\u6d4b\u7b56\u7565\uff08sweep\u3001\u89c6\u89d2\u53d8\u6362\uff09\u3002</p> <p>\u5c40\u90e8\u8f68\u8ff9\u4f18\u5316\u4ee3\u4ef7\u51fd\u6570\u793a\u4f8b\uff1a \\(\\(J(\\\\xi)=\\\\alpha J\\_{collision}(\\\\xi)+\\\\beta J\\_{smooth}(\\\\xi)+\\\\gamma J\\_{visibility}(\\\\xi)+\\\\delta J\\_{energy}(\\\\xi)\\)\\)</p> <ul> <li> <p>\\(J\\_{collision}\\)\uff1a\u6700\u5c0f\u5316\u4e0e\u969c\u788d\u7269\u8ddd\u79bb\u7684\u8d1f\u503c\uff1b</p> </li> <li> <p>\\(J\\_{smooth}\\)\uff1a\u8f68\u8ff9\u5e73\u6ed1\u9879\uff08\u52a0\u901f\u5ea6\u3001\u89d2\u52a0\u901f\u5ea6\u6210\u672c\uff09\uff1b</p> </li> <li> <p>\\(J\\_{visibility}\\)\uff1a\u4fdd\u8bc1\u5173\u952e\u8bed\u4e49/\u51e0\u4f55\u7279\u5f81\u5728\u53ef\u89c6\u9525\u5185\uff0c\u6216\u4fdd\u8bc1\u5c40\u90e8\u7279\u5f81\u6570 &gt;= N_min\uff1b</p> </li> <li> <p>\\(J\\_{energy}\\)\uff1a\u4f30\u8ba1\u80fd\u8017\u3002</p> </li> </ul> <p>\u89c4\u5212\u5668\u9009\u62e9\uff1a</p> <ul> <li> <p>\u5148\u7528\u5168\u5c40\u53ef\u5230\u8fbe\u6027\u68c0\u67e5\uff08A* / D* on 2D grid \u6216 visibility graph\uff09\uff1b</p> </li> <li> <p>\u5c40\u90e8\u7528\u91c7\u6837/\u68af\u5ea6\u4f18\u5316 (RRT*/CHOMP/TrajOpt) \u4f18\u5316\u4e0a\u9762\u4ee3\u4ef7\u51fd\u6570\u3002</p> </li> </ul> <p>\u5230\u8fbe\u76ee\u6807\u540e\uff1a\u6267\u884c\u89c6\u89d2\u626b\u67e5\uff08\u82e5IG\u9ad8\uff0c\u73af\u7ed5\u6216\u505a\u5c0f\u89d2\u5ea6\u8f6c\u52a8\u4ee5\u83b7\u53d6\u66f4\u591a\u8bed\u4e49\u4fe1\u606f\uff09\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#34-frontier-detection","title":"3.4 \u524d\u6cbf\u68c0\u6d4b\uff08Frontier Detection\uff09","text":"<p>\u5728\u6bcf\u4e2a submap \u5185\u505a\u7ecf\u5178\u7684 frontier \u68c0\u6d4b\uff08\u5df2\u77e5 free \u7a7a\u95f4\u8fb9\u754c\u4e0e\u672a\u77e5\u7a7a\u95f4\u7684\u63a5\u58e4\uff09\uff0c\u7528\u4e8e\u4f30\u8ba1 IG \u4e0e\u751f\u6210 candidate viewpoints\u3002</p> <p>\u52a0\u901f\u6280\u5de7\uff1a</p> <ul> <li>\u5728\u5206\u5c42\u5730\u56fe\u4e0a\u4ec5\u5bf9 Level1 \u4e2d\u672a\u5b8c\u5168\u8986\u76d6\u7684 submap \u505a frontier \u68c0\u6d4b\uff0c\u907f\u514d\u5168\u56fe\u66f4\u65b0\u6210\u672c\u3002</li> <li>\u4f7f\u7528\u5c40\u90e8 BFS/\u8fed\u4ee3\u81a8\u80c0\u4ee5\u8fb9\u7f18\u4f18\u5148\u68c0\u6d4b\u3002</li> </ul>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#35","title":"3.5 \u89c6\u70b9\u751f\u6210\u4e0e\u4fe1\u606f\u589e\u76ca\u4f30\u8ba1","text":"<p>\u6bcf\u4e2a frontier \u70b9\u751f\u6210\u82e5\u5e72\u5019\u9009\u89c6\u70b9\uff08\u4e0d\u540c\u9ad8\u5ea6/\u671d\u5411\uff09\u3002\u5bf9\u6bcf\u4e2a\u5019\u9009\u89c6\u70b9\u7528\u5feb\u901f\u8fd1\u4f3c\uff08ray-casting on local occupancy grid + semantic prior\uff09\u4f30\u8ba1\u89c2\u6d4b\u5230\u7684\u65b0\u8bed\u4e49/\u51e0\u4f55\u4fe1\u606f\u91cf\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#metric-semantic-slam","title":"Metric-Semantic SLAM","text":""},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_8","title":"\u5206\u5c42\u4f53\u7d20\u5730\u56fe","text":"<ol> <li>\u5206\u5c42\u5730\u56fe\u8868\u793a (Hierarchical Map Representation):</li> </ol> <ul> <li> <p>\u5c40\u90e8\u5ea6\u91cf-\u8bed\u4e49\u5730\u56fe (Local Metric-Semantic Grid, L-MSG): \u4e00\u4e2a\u4ee5UAV\u4e3a\u4e2d\u5fc3\u7684\u3001\u9ad8\u5206\u8fa8\u7387\u7684\u4f53\u7d20\u7f51\u683c\uff08Voxel Grid\uff09\u3002\u5176\u4e3b\u8981\u804c\u8d23\u662f\u5b9e\u65f6\u907f\u969c\u4e0e\u5c40\u90e8\u611f\u77e5\u3002</p> </li> <li> <p>\u5168\u5c40\u5ea6\u91cf-\u8bed\u4e49\u5730\u56fe (Global Metric-Semantic Grid, G-MSG): \u4e00\u4e2a\u6301\u4e45\u5316\u7684\u3001\u5168\u5c40\u5750\u6807\u7cfb\u4e0b\u7684\u5206\u5c42\uff08\u5982Octree\uff09\u4f53\u7d20\u5730\u56fe\u3002\u5176\u4e3b\u8981\u804c\u8d23\u662f\u957f\u671f\u5b58\u50a8\u3001\u5168\u5c40\u89c4\u5212\u4e0e\u95ed\u73af\u68c0\u6d4b\u6570\u636e\u5e93\u3002</p> </li> </ul> <ol> <li>\u53cc\u91cd\u72b6\u6001\u4f30\u8ba1 (Dual State Estimation):</li> </ol> <ul> <li> <p>VIO \u524d\u7aef (VIO Front-end): \u63d0\u4f9b\u9ad8\u9891\u3001\u5b9e\u65f6\u4f46\u5b58\u5728\u6f02\u79fb\u7684\u91cc\u7a0b\u8ba1\uff08Odometry\uff09\u59ff\u6001 \\(T\\_{\\\\text{VIO}}\\)\u3002</p> </li> <li> <p>SLAM \u540e\u7aef (SLAM Back-end): \u4e00\u4e2a\u57fa\u4e8e\u56e0\u5b50\u56fe\u7684\u4f18\u5316\u5668\uff0c\u7528\u4e8e\u4f18\u5316\u5173\u952e\u5e27\uff08Keyframe\uff09\u59ff\u6001 \\(T\\_{\\\\text{SLAM}}\\)\uff0c\u5b9e\u73b0\u4f4e\u9891\u3001\u9ad8\u7cbe\u5ea6\u3001\u5168\u5c40\u4e00\u81f4\u7684\u8f68\u8ff9\u4f30\u8ba1\u3002</p> </li> </ul>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_9","title":"\u5206\u5c42\u5730\u56fe\u7684\u6784\u5efa\u4e0e\u53cc\u91cd\u66f4\u65b0","text":"<p>\u8be5\u6846\u67b6\u7684\u7cbe\u9ad3\u5728\u4e8e\u5176\u53cc\u91cd\u66f4\u65b0\u673a\u5236\uff0c\u5b83**\u89e3\u8026\uff08decouples\uff09**\u4e86\u5b9e\u65f6\u907f\u969c\u4e0e\u5168\u5c40\u4e00\u81f4\u6027\u7684\u66f4\u65b0\u9700\u6c42\u3002</p> <ul> <li>\u5c40\u90e8\u5730\u56fe\u66f4\u65b0\uff08VIO\u9a71\u52a8\uff09\uff1a</li> </ul> <p>L-MSG \u4ec5\u7531 VIO \u524d\u7aef\u7684\u5b9e\u65f6\u59ff\u6001 \\(T\\_{\\\\text{VIO}}\\) \u66f4\u65b0\u3002</p> <ul> <li> <p>\u76ee\u7684\uff1a \u4fdd\u8bc1\u6700\u4f4e\u7684\u5ef6\u8fdf\uff08low-latency\uff09\u3002</p> </li> <li> <p>\u6d41\u7a0b\uff1a \u4f20\u611f\u5668\u6570\u636e\uff08\u6df1\u5ea6\u3001\u8bed\u4e49\uff09\u6839\u636e \\(T\\_{\\\\text{VIO}}\\) \u88ab\u7acb\u5373\u6295\u5f71\uff08project\uff09\u548c\u878d\u5408\uff08fuse\uff09\u5230 L-MSG \u4e2d\u3002\u8fd9\u4fdd\u8bc1\u4e86\u65e0\u4eba\u673a\u201c\u811a\u4e0b\u201d\u7684\u5730\u56fe\u59cb\u7ec8\u662f\u6700\u65b0\uff08up-to-date\uff09\u7684\uff0c\u5373\u4f7f\u5b83\u4f1a\u968fVIO\u6f02\u79fb\u3002</p> </li> <li> <p>\u5168\u5c40\u5730\u56fe\u66f4\u65b0\uff08SLAM\u9a71\u52a8\uff09\uff1a</p> </li> </ul> <p>G-MSG \u4ec5\u7531 SLAM \u540e\u7aef\u4f18\u5316\u540e\u7684\u59ff\u6001 \\(T\\_{\\\\text{SLAM}}\\) \u66f4\u65b0\u3002</p> <ul> <li> <p>\u76ee\u7684\uff1a \u4fdd\u8bc1\u5168\u5c40\u4e00\u81f4\u6027\u3002</p> </li> <li> <p>\u6d41\u7a0b\uff1a \u5f53\u540e\u7aef\uff08\u4f8b\u5982\uff0c\u901a\u8fc7\u6ed1\u52a8\u7a97\u53e3\u6216\u95ed\u73af\uff09\u4f18\u5316\u4e86\u5173\u952e\u5e27 \\(KF_i\\) \u7684\u59ff\u6001\u540e\uff0c\u7cfb\u7edf\u624d\u4f7f\u7528\u8fd9\u4e2a\u4fee\u6b63\u8fc7\u7684\u59ff\u6001 \\(T\\_{\\\\text{SLAM}, i}\\)\uff0c\u5c06 \\(KF_i\\) \u643a\u5e26\u7684\u5ea6\u91cf\u4e0e\u8bed\u4e49\u4fe1\u606f\uff08\u5b58\u50a8\u5728\u5176\u7f13\u5b58\u4e2d\uff09\u878d\u5408\u5230 G-MSG \u4e2d\u3002</p> </li> </ul> <p>\u6b64\u7b56\u7565\u786e\u4fdd\u4e86 G-MSG \u4e0d\u4f1a\u88ab VIO \u7684\u6f02\u79fb\u6240\u201c\u6c61\u67d3\u201d\uff0c\u59cb\u7ec8\u4ee3\u8868\u4e86\u7cfb\u7edf\u5bf9\u4e16\u754c\u7684\u201c\u6700\u4f73\u4fe1\u5ff5\u201d\uff08best belief\uff09\u3002</p>"},{"location":"notes/slam/%E6%AF%95%E8%AE%BE%EF%BC%9A%E9%9D%A2%E5%90%91%E5%A4%8D%E6%9D%82%E5%AE%A4%E5%86%85%E7%8E%AF%E5%A2%83%E7%9A%84%E6%97%A0%E4%BA%BA%E6%9C%BA%E8%87%AA%E4%B8%BB%E6%8E%A2%E7%B4%A2%E6%A1%86%E6%9E%B6/#_10","title":"\u57fa\u4e8e\u8bed\u4e49\u5b50\u56fe\u7684\u4e3b\u52a8\u95ed\u73af","text":"<p>\u8be5\u6d41\u7a0b\u5468\u671f\u6027\u8fd0\u884c\uff0c\u7528\u4e8e\u4e3b\u52a8\u5bfb\u627e\u5e76\u786e\u8ba4\u95ed\u73af\uff0c\u800c\u975e\u88ab\u52a8\u7b49\u5f85\u3002</p> <ul> <li> <p>\u9636\u6bb5 1\uff1a\u67e5\u8be2\u5b50\u56fe\u751f\u6210 (Query Subgraph Generation)</p> </li> <li> <p>\u65e0\u4eba\u673a\u9996\u5148\u4ece\u5176**\u5c40\u90e8\u8bed\u4e49\u5730\u56fe\uff08L-MSG\uff09**\u4e2d\uff0c\u63d0\u53d6\u5f53\u524d\u89c6\u91ce\u5185\u6240\u6709\u53ef\u89c2\u6d4b\u5230\u7684\u3001\u9ad8\u7f6e\u4fe1\u5ea6\u7684\u8bed\u4e49\u5bf9\u8c61\u3002</p> </li> <li> <p>\u8fd9\u4e9b\u5bf9\u8c61\u53ca\u5176\u76f8\u5bf9\u7a7a\u95f4\u5173\u7cfb\uff08\u5982\u8ddd\u79bb\u3001\u65b9\u4f4d\uff09\u88ab\u6784\u5efa\u4e3a\u4e00\u4e2a \u201c\u67e5\u8be2-\u5c5e\u6027\u5173\u7cfb\u56fe\u201d (Query-Attributed Relational Graph, Q-ARG)\u3002</p> </li> <li> <p>\u793a\u4f8b\uff1a \u8282\u70b9 {<code>\u51b0\u7bb1</code>, <code>\u5fae\u6ce2\u7089</code>}\uff0c\u8fb9 {<code>\u8ddd\u79bb=1.5m</code>, <code>\u65b9\u4f4d=30\u00b0</code>}\u3002</p> </li> <li> <p>\u9636\u6bb5 2\uff1a\u5019\u9009\u5339\u914d (Candidate Matching)</p> </li> <li> <p>\u7cfb\u7edf\u4f7f\u7528\u8fd9\u4e2a Q-ARG\uff0c\u5728\u5168\u5c40\u8bed\u4e49\u5730\u56fe\uff08G-MSG\uff09 \u7684\u6570\u636e\u5e93\u4e2d\u8fdb\u884c\u5b50\u56fe\u5339\u914d\uff08Subgraph Matching\uff09 \u67e5\u8be2\u3002</p> </li> <li> <p>\u67e5\u8be2\uff1a \u201c\u5728 G-MSG \u4e2d\uff0c\u662f\u5426\u5b58\u5728\u4e00\u4e2a\u5386\u53f2\u201c\u573a\u666f\u201d\uff0c\u5176\u5305\u542b\u7684\u8bed\u4e49\u5bf9\u8c61\u548c\u7a7a\u95f4\u5173\u7cfb\u4e0e Q-ARG \u540c\u6784\uff08isomorphic\uff09\uff1f\u201d</p> </li> <li> <p>\u5339\u914d\u6210\u529f\u5c06\u8fd4\u56de\u4e00\u4e2a\u6216\u591a\u4e2a\u5019\u9009\uff08Candidate\uff09\u3002</p> </li> <li> <p>\u9636\u6bb5 3\uff1a\u751f\u6210\u5019\u9009\u201c\u5b50\u56fe-\u89c2\u6d4b\u70b9\u5bf9\u201d</p> </li> <li> <p>\u6bcf\u4e2a\u5019\u9009\u5339\u914d\u4e0d\u4ec5\u5305\u542b\u4e00\u4e2a \u201c\u5386\u53f2-\u8bed\u4e49\u5b50\u56fe\u201d (H-ARG) \uff0c\u8fd8\u5305\u542b\u4e86\u5f53\u65f6\u89c2\u6d4b\u5230\u8be5 H-ARG \u7684\u5386\u53f2\u5173\u952e\u5e27\uff08Historical Keyframe\uff09 \\(KF\\_{\\\\text{hist}}\\)\u3002</p> </li> <li> <p>\u7cfb\u7edf\u56e0\u6b64\u751f\u6210\u4e86\u4e00\u7ec4 <code>{Q-ARG, H-ARG, KF_hist}</code> \u5bf9\uff0c\u5373 \u201c\u8bed\u4e49\u95ed\u73af\u5b50\u56fe-\u89c2\u6d4b\u70b9\u5bf9\u201d \u3002</p> </li> <li> <p>\u9636\u6bb5 4\uff1a\u4fe1\u606f\u589e\u76ca\u8bc4\u4f30\u4e0e\u51b3\u7b56 (IG-Based Decision)</p> </li> <li> <p>\u5bf9\u4e8e\u6bcf\u4e2a\u5019\u9009 \\(KF\\_{\\\\text{hist}}\\)\uff0c\u7cfb\u7edf\u5e76\u4e0d\u7acb\u5373\u6267\u884c\u95ed\u73af\uff0c\u800c\u662f\u5728\u56e0\u5b50\u56fe\u4e2d\u6dfb\u52a0\u865a\u62df\u56e0\u5b50\u3002</p> <ul> <li>\u5b83\u4e34\u65f6\u5728\u540e\u7aef\u56e0\u5b50\u56fe\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u865a\u62df\u95ed\u73af\u56e0\u5b50 (Virtual LC Factor)\uff0c\u8fde\u63a5\u5f53\u524d\u5e27 \\(KF\\_{\\\\text{now}}\\) \u548c \\(KF\\_{\\\\text{hist}}\\)\u3002</li> <li>\u901a\u8fc7\u8ba1\u7b97\u534f\u65b9\u5dee\u77e9\u9635\u8ff9\uff08Trace\uff09\u7684\u9884\u671f\u51cf\u5c11\u91cf\u6765\u91cf\u5316\u4fe1\u606f\u589e\u76ca \\(IG\\)\uff1a   $$ \\ IG = tr(\\Sigma_{\\text{prior}}) - tr(\\Sigma_{\\text{posterior}})$$</li> <li>\u7cfb\u7edf\u6743\u8861 \\(IG\\)\uff08\u6536\u76ca\uff09\u4e0e\u524d\u5f80 \\(KF\\_{\\\\text{hist}}\\) \u9644\u8fd1\u6240\u9700\u8def\u5f84\u6210\u672c \\(C\\)\uff08\u6210\u672c\uff09\uff0c\u9009\u62e9\u6548\u7528\uff08Utility\uff09\u6700\u9ad8\u7684\u5019\u9009\uff0c\u5e76\u4e3b\u52a8\u89c4\u5212\u8def\u5f84\u6267\u884c\u95ed\u73af\u3002</li> </ul> </li> </ul>"},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/","title":"Batching Inference & KV Cache","text":"2025-10-132025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#batching-inference-kv-cache","title":"Batching Inference &amp; KV Cache","text":"<p> \u7ea6 3110 \u4e2a\u5b57  126 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 17 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#kv-cache","title":"KV Cache","text":"","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#question-without-kv-cache","title":"Question without KV Cache","text":"<ul> <li>Attention \u8ba1\u7b97\u5b9e\u9645\u4e0a\u662f\u4e0e <code>seq_len</code> \u5e73\u65b9\u6210\u6b63\u6bd4\u7684\uff0c\u6240\u4ee5 prompt \u53d8\u957f\u7684\u8bdd\uff0c\u6211\u4eec\u7684 FLOPs \u4f1a\u5f88\u5feb\u589e\u957f\u5230\u8d85\u8fc7 Single GPU \u7684\u8ba1\u7b97\u80fd\u529b(Compute-Bound)</li> <li>\u201cAha!\u201d\u65f6\u523b\uff1a \u5f53\u6211\u4eec\u53bb\u9884\u6d4b\u7b2c 9 \u4e2a\u8bcd\u65f6\uff0c\u6211\u4eec\u9700\u8981\uff1a</li> <li>\\(Q\\) = \u7b2c 8 \u4e2a token \u7684 Query \u5411\u91cf\u3002</li> <li>\\(K\\) = <code>[\"The\", ..., \"and\", \"the\"]</code>\uff08\u6240\u6709 8 \u4e2a token\uff09\u7684 Key \u5411\u91cf\u3002</li> <li>\\(V\\) = <code>[\"The\", ..., \"and\", \"the\"]</code>\uff08\u6240\u6709 8 \u4e2a token\uff09\u7684 Value \u5411\u91cf\u3002</li> <li>**<code>Key</code> \u548c <code>Value</code> \u5411\u91cf\u4e00\u65e6\u4e3a\u67d0\u4e2a token \u8ba1\u7b97\u51fa\u6765\uff0c\u5c31\u6c38\u8fdc\u4e0d\u4f1a\u6539\u53d8\u4e86\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u91cd\u590d\u8ba1\u7b97\u201d</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#definition","title":"Definition","text":"<p>KV Cache\uff08\u952e\u503c\u7f13\u5b58\uff09 \u662f\u4e00\u4e2a\u5728\u663e\u5b58\uff08VRAM\uff09\u4e2d\u5f00\u8f9f\u7684\u5b58\u50a8\u7a7a\u95f4\uff0c\u7528\u4e8e\u4fdd\u5b58\u6a21\u578b\u6bcf\u4e00\u5c42\u8ba1\u7b97\u8fc7\u7684\u6240\u6709\u5386\u53f2 token \u7684 <code>Key</code> \u548c <code>Value</code> \u5411\u91cf\u3002</p> <ul> <li>Prefill (\u9636\u6bb5\u4e00): \u5904\u7406 \\(N\\) \u4e2a token\uff08\u63d0\u793a\u8bcd\u957f\u5ea6\uff09\u3002</li> <li>Decode (\u9636\u6bb5\u4e8c): \u6bcf\u4e00\u6b65\u90fd\u53ea\u5904\u7406 1 \u4e2a token\u3002</li> <li>\u751f\u6210 \\(M\\) \u4e2a\u8bcd\u7684\u603b\u8ba1\u7b97\u91cf\u73b0\u5728\u662f \\(O(N + M)\\)\uff0c\u8fd9\u662f\u4e00\u4e2a\u7ebf\u6027\u590d\u6742\u5ea6</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#new-question-with-kv-cache","title":"New Question with KV Cache","text":"<p>\u6211\u4eec\u5b9e\u9645\u4e0a\u662f\u5728\u7528\u7a7a\u95f4\u6362\u8ba1\u7b97 (Compute-Bound =&gt; Memory-Bound)</p> <ul> <li>\u5927\u5c0f: \u7f13\u5b58\u7684\u5927\u5c0f\u4e0e <code>seq_len x num_layer x hidden_size</code> \u6210\u6b63\u6bd4\u3002</li> <li>\u95ee\u9898: \u8fd9\u662f\u4e00\u4e2a\u5de8\u5927\u7684\u663e\u5b58\u6d88\u8017\u3002\u5f53\u4f60\u8bf4\u4e00\u4e2a\u6a21\u578b\u652f\u6301 128k \u7684\u4e0a\u4e0b\u6587\u7a97\u53e3\u65f6\uff0c\u4e0d\u4ec5\u9700\u8981\u663e\u5b58\u6765\u52a0\u8f7d\u6a21\u578b\u6743\u91cd\uff0c\u8fd8\u9700\u8981\u989d\u5916\u7684\u3001\u6d77\u91cf\u7684\u663e\u5b58\u6765\u5bb9\u7eb3\u8fd9\u4e2a 128k \u957f\u5ea6\u7684 KV Cache\u3002</li> <li>\u4f18\u5316: \u8fd9\u4e5f\u50ac\u751f\u4e86\u65b0\u7684\u4f18\u5316\u6280\u672f\uff0c\u6bd4\u5982Grouped-Query Attention (GQA) \u548c Multi-Query Attention (MQA)\uff0c\u5b83\u4eec\u7684\u6838\u5fc3\u76ee\u7684\u5c31\u662f\u901a\u8fc7\u51cf\u5c11 K \u548c V \u5934\u7684\u6570\u91cf\uff0c\u6765\u51cf\u5c0f KV Cache \u7684\u663e\u5b58\u5360\u7528\uff0c\u4ece\u800c\u5728\u4e0d\u727a\u7272\u592a\u591a\u6027\u80fd\u7684\u60c5\u51b5\u4e0b\u652f\u6301\u66f4\u957f\u7684\u4e0a\u4e0b\u6587\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#implement","title":"Implement","text":"<p>\u5b9e\u9645\u4e0a KV Cache \u7684\u6700\u7b80\u5355\u5b9e\u73b0\u5c31\u662f\u7b80\u5355\u7684\u8fdb\u884c keys \u548c values \u7684\u62fc\u63a5</p> <ul> <li>Prefill\uff1a\u521d\u59cb\u5316\u7684 KV Cache</li> <li>Decode\uff1a\u5728\u539f\u6709\u7684 KV Cache \u540e\u9762\u589e\u52a0\u65b0 token \u7684 KV Cache</li> <li>\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u52a8\u6001\u6784\u5efa\uff0c\u5b9e\u9645\u4e0a\u53ef\u4ee5\u8fdb\u884c\u9884\u5206\u914d\u51cf\u5c11 <code>torch.cat</code> \u91cd\u65b0\u5206\u914d\u663e\u5b58\u548c\u62f7\u8d1d\u6570\u636e\u7684\u5f00\u9500\uff1b\u6216\u8005\u50cf vllm \u6216\u8005 SGlang \u4f7f\u7528 <code>page kv cache</code> \u7c7b\u4f3c OS \u4e2d\u7684\u9875\u8868\u7ba1\u7406\uff0c\u51cf\u5c11\u5185\u90e8\u788e\u7247</li> </ul> Python<pre><code>class SimplestKVCache:\n\u00a0 \u00a0 def __init__(self):\n\u00a0 \u00a0 \u00a0 \u00a0 self.key_values = None\n\u00a0 \u00a0 \u00a0 \u00a0 self.offset = 0\n\u00a0 \u00a0 @torch.no_grad()\n\u00a0 \u00a0 def update_and_fetch(\n\u00a0 \u00a0 \u00a0 \u00a0 self,\n\u00a0 \u00a0 \u00a0 \u00a0 key: torch.Tensor,\n\u00a0 \u00a0 \u00a0 \u00a0 value: torch.Tensor,\n\u00a0 \u00a0 ):\n\u00a0 \u00a0 \u00a0 \u00a0 key = key.detach() \u00a0# do not keep autograd\n\u00a0 \u00a0 \u00a0 \u00a0 value = value.detach()\n\u00a0 \u00a0 \u00a0 \u00a0 B, H, S, D = key.shape\n\u00a0 \u00a0 \u00a0 \u00a0 if self.key_values is None:\n    \u00a0 \u00a0 \u00a0 \u00a0 # prefill\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.key_values = (key, value)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.offset = S\n\u00a0 \u00a0 \u00a0 \u00a0 else:\n    \u00a0 \u00a0 \u00a0 \u00a0 # decode\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 prev_key, prev_value = self.key_values\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 new_key = torch.cat([prev_key, key], dim=2)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 new_value = torch.cat([prev_value, value], dim=2)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.key_values = (new_key, new_value)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 self.offset += S\n\u00a0 \u00a0 \u00a0 \u00a0 return self.key_values[0], self.key_values[1], self.offset\n</code></pre> <ul> <li>\u4f46\u5b9e\u9645\u4e0a KV Cache \u901a\u5e38\u4e0e Batch Inference \u6280\u672f\u4e00\u540c\u51fa\u73b0\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u4ecb\u7ecd Continuous Batching \u6280\u672f\u548c Chunked Prefill \u6280\u672f\uff0c\u6700\u540e\u4ecb\u7ecd\u5982\u4f55\u6539\u8fdb KV Cache \u53ef\u4ee5\u9002\u914d\u8fd9\u4e24\u4e2a\u6280\u672f</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#continuous-batching","title":"Continuous Batching","text":"","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#why-continuous-batching","title":"Why Continuous Batching","text":"<p>\u5728\u8fd9\u79cd Batching \u6280\u672f\u51fa\u73b0\u4e4b\u524d\uff0c\u4e00\u822c\u6279\u5904\u7406\u6709\u4e24\u79cd\u6a21\u5f0f\uff1a</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#static-batching","title":"Static Batching","text":"<p>\u9759\u6001\u6279\u5904\u7406\u662f\u6700\u7b80\u5355\u7684\u6279\u5904\u7406\u5f62\u5f0f\u3002\u5728\u8fd9\u79cd\u6a21\u5f0f\u4e0b\uff0c\u670d\u52a1\u5668\u4f1a\u7b49\u5f85\uff0c\u76f4\u5230\u79ef\u7d2f\u4e86\u56fa\u5b9a\u6570\u91cf\u7684\u8bf7\u6c42\uff0c\u7136\u540e\u5c06\u5b83\u4eec\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u8fdb\u884c\u5904\u7406 \u00a0\u3002</p> <ul> <li> <p>\u673a\u5236\uff1a\u6240\u6709\u8bf7\u6c42\u88ab\u7ec4\u5408\u6210\u4e00\u4e2a\u6279\u6b21\uff0c\u5e76\u88ab\u586b\u5145\uff08gpaddin\uff09\u5230\u8be5\u6279\u6b21\u4e2d\u6700\u957f\u5e8f\u5217\u7684\u957f\u5ea6\uff08\u5305\u62ec prompt \u548c\u9884\u671f\u7684\u6700\u5927\u751f\u6210\u957f\u5ea6\uff09\u3002\u7136\u540e\uff0c\u8fd9\u4e2a\u6279\u6b21\u4ece\u5934\u5230\u5c3e\u88ab\u4f5c\u4e3a\u4e00\u4e2a\u4e0d\u53ef\u5206\u5272\u7684\u5355\u5143\u8fdb\u884c\u5904\u7406 \u00a0\u3002</p> </li> <li> <p>\u7f3a\u9677\uff1a\u8fd9\u79cd\u65b9\u6cd5\u5bfc\u81f4\u4e86\u4e25\u91cd\u7684 GPU \u8d44\u6e90\u6d6a\u8d39\u548c\u6027\u80fd\u74f6\u9888\uff0c\u4e3b\u8981\u6e90\u4e8e\u4e24\u4e2a\u95ee\u9898\uff1a</p> </li> </ul> <ol> <li>\u961f\u5934\u963b\u585e\uff08Head-of-Line Blocking\uff09\uff1a\u6279\u6b21\u4e2d\u7684\u6240\u6709\u8bf7\u6c42\u5fc5\u987b\u7b49\u5f85\u6700\u957f\u7684\u90a3\u4e2a\u8bf7\u6c42\u5b8c\u6210\u751f\u6210\u3002\u8fd9\u610f\u5473\u7740\u90a3\u4e9b\u65e9\u5df2\u5b8c\u6210\u751f\u6210\uff08\u4f8b\u5982\uff0c\u751f\u6210\u4e86\u8f83\u77ed\u56de\u590d\uff09\u7684\u8bf7\u6c42\u6240\u5360\u7528\u7684 GPU \u8d44\u6e90\u5c06\u5904\u4e8e\u95f2\u7f6e\u72b6\u6001\uff0c\u65e0\u6cd5\u88ab\u91ca\u653e\u6216\u7528\u4e8e\u5904\u7406\u65b0\u8bf7\u6c42 \u00a0\u3002</li> <li>\u586b\u5145\u5f00\u9500\uff08Padding Overhead\uff09\uff1a\u4e3a\u4e86\u5c06\u4e0d\u540c\u957f\u5ea6\u7684\u5e8f\u5217\u7ec4\u5408\u6210\u4e00\u4e2a\u89c4\u6574\u7684\u5f20\u91cf\uff0c\u7cfb\u7edf\u5fc5\u987b\u6dfb\u52a0\u5927\u91cf\u7684\u586b\u5145\u4ee4\u724c\u3002GPU \u5728\u8fd9\u4e9b\u586b\u5145\u4ee4\u724c\u4e0a\u6267\u884c\u7684\u8ba1\u7b97\u662f\u5b8c\u5168\u65e0\u6548\u7684\uff0c\u4e0d\u4ea7\u751f\u4efb\u4f55\u6709\u610f\u4e49\u7684\u8f93\u51fa\uff0c\u6784\u6210\u4e86\u5de8\u5927\u7684\u8ba1\u7b97\u6d6a\u8d39 \u00a0\u3002</li> </ol>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#dynamic-batching","title":"Dynamic Batching","text":"<p>\u4f5c\u4e3a\u9759\u6001\u6279\u5904\u7406\u7684\u6539\u8fdb\uff0c\u52a8\u6001\u6279\u5904\u7406\u5f15\u5165\u4e86\u66f4\u7075\u6d3b\u7684\u6210\u6279\u7b56\u7565\u3002\u5b83\u901a\u5e38\u57fa\u4e8e\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\u6216\u6279\u6b21\u5927\u5c0f\u4e0a\u9650\uff0c\u4ee5\u5148\u5230\u8005\u4e3a\u51c6\u00a0\u3002</p> <ul> <li>\u673a\u5236\uff1a\u670d\u52a1\u5668\u5728\u6536\u5230\u7b2c\u4e00\u4e2a\u8bf7\u6c42\u540e\u542f\u52a8\u4e00\u4e2a\u77ed\u6682\u7684\u8ba1\u65f6\u5668\u3002\u5982\u679c\u5728\u8ba1\u65f6\u5668\u7ed3\u675f\u524d\u6279\u6b21\u5927\u5c0f\u8fbe\u5230\u4e86\u4e0a\u9650\uff0c\u5219\u7acb\u5373\u5f00\u59cb\u5904\u7406\uff1b\u5426\u5219\uff0c\u5728\u8ba1\u65f6\u5668\u7ed3\u675f\u540e\uff0c\u65e0\u8bba\u6279\u6b21\u662f\u5426\u5df2\u6ee1\uff0c\u90fd\u5c06\u5f53\u524d\u79ef\u7d2f\u7684\u8bf7\u6c42\u4f5c\u4e3a\u4e00\u4e2a\u6279\u6b21\u8fdb\u884c\u5904\u7406\u3002\u8fd9\u79cd\u65b9\u5f0f\u5728\u5ef6\u8fdf\u548c\u541e\u5410\u91cf\u4e4b\u95f4\u53d6\u5f97\u4e86\u66f4\u597d\u7684\u5e73\u8861 \u00a0\u3002</li> <li>Head-of-Line Blocking\uff1a\u5c3d\u7ba1\u6709\u6240\u6539\u8fdb\uff0c\u52a8\u6001\u6279\u5904\u7406\u4ecd\u7136\u5728\u8bf7\u6c42\u7ea7\u522b\u4e0a\u8fd0\u4f5c\u3002\u8fd9\u610f\u5473\u7740\u4e00\u65e6\u4e00\u4e2a\u6279\u6b21\u5f00\u59cb\u5904\u7406\uff0c\u5b83\u4ecd\u7136\u662f\u4e00\u4e2a\u540c\u6b65\u7684\u3001\u4e0d\u53ef\u5206\u5272\u7684\u5355\u5143\u3002\u6574\u4e2a\u6279\u6b21\u5fc5\u987b\u7b49\u5f85\u5176\u4e2d\u6700\u6162\u7684\u8bf7\u6c42\u5b8c\u6210\uff0c\u624d\u80fd\u5f00\u59cb\u4e0b\u4e00\u4e2a\u6279\u6b21\u7684\u5904\u7406\u3002\u5bf9\u4e8e\u8f93\u51fa\u957f\u5ea6\u6781\u4e0d\u786e\u5b9a\u7684 LLM \u63a8\u7406\u4efb\u52a1\uff0c\u961f\u5934\u963b\u585e\u95ee\u9898\u4f9d\u7136\u5b58\u5728\uff0c\u53ea\u662f\u7a0b\u5ea6\u6709\u6240\u51cf\u8f7b \u00a0\u3002</li> </ul> <p>\u4e3a\u4e86\u89e3\u51b3\u4e0a\u9762\u7684\u961f\u5934\u963b\u585e\u95ee\u9898\uff0c\u63d0\u51fa\u4e86 Continuous Batching \u6280\u672f</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#what-is-continuous-batchingorca","title":"What is Continuous Batching[^orca]","text":"<ol> <li>\u5355\u6b21\u8fed\u4ee3\u8c03\u7528\uff1a\u8c03\u5ea6\u5668\u6bcf\u6b21\u53ea\u8c03\u7528\u6267\u884c\u5f15\u64ce\u8fd0\u884c\u6a21\u578b\u7684\u4e00\u4e2a\u8fed\u4ee3\u6b65\u9aa4\uff0c\u800c\u4e0d\u662f\u8fd0\u884c\u6574\u4e2a\u8bf7\u6c42\u7684\u751f\u6210\u8fc7\u7a0b \u00a0\u3002</li> <li>late-arrived enter\uff1a\u8fd9\u79cd\u7ec6\u7c92\u5ea6\u7684\u8c03\u5ea6\u4f7f\u5f97\u65b0\u5230\u8fbe\u7684\u8bf7\u6c42\u51e0\u4e4e\u53ef\u4ee5\u7acb\u5373\u52a0\u5165\u5230\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u6279\u6b21\u4e2d\uff0c\u53ea\u9700\u7b49\u5f85\u5f53\u524d\u8fed\u4ee3\uff08\u901a\u5e38\u662f\u6beb\u79d2\u7ea7\uff09\u7ed3\u675f\u5373\u53ef\u3002\u8fd9\u6781\u5927\u5730\u7f29\u77ed\u4e86\u8bf7\u6c42\u5728\u961f\u5217\u4e2d\u7684\u7b49\u5f85\u65f6\u95f4 \u00a0\u3002</li> <li>early exit\uff1a\u4e00\u65e6\u67d0\u4e2a\u8bf7\u6c42\u5b8c\u6210\uff0c\u5b83\u53ef\u4ee5\u5728\u4e0b\u4e00\u6b21\u8fed\u4ee3\u5f00\u59cb\u524d\u5c31\u7acb\u5373\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\uff0c\u5f7b\u5e95\u89e3\u51b3\u4e86\u201c\u65e9\u5b8c\u6210\u3001\u665a\u8fd4\u56de\u201d\u7684\u95ee\u9898 \u00a0\u3002</li> </ol> \u7279\u6027 \u9759\u6001\u6279\u5904\u7406 (Static Batching) \u52a8\u6001\u6279\u5904\u7406 (Dynamic Batching) \u8fde\u7eed\u6279\u5904\u7406 (Continuous Batching) \u8c03\u5ea6\u7c92\u5ea6 \u8bf7\u6c42\u7ea7 (Request-level)\u00a0\u00a0 \u8bf7\u6c42\u7ea7\uff08Request-level\uff09 \u8bf7\u6c42\u7ea7 (Request-level)\u00a0\u00a0 \u8bf7\u6c42\u7ea7\uff08Request-level\uff09 \u8fed\u4ee3\u7ea7 (Iteration-level)\u00a0\u00a0 \u8fed\u4ee3\u7ea7\uff08Iteration-level\uff09 \u8c03\u5ea6\u903b\u8f91 \u7b49\u5f85\u56fa\u5b9a\u6570\u91cf\u7684\u8bf7\u6c42 \u7b49\u5f85\u65f6\u95f4\u7a97\u53e3\u6216\u6570\u91cf\u4e0a\u9650 \u5728\u6bcf\u6b21\u4ee4\u724c\u751f\u6210\u540e\u52a8\u6001\u8c03\u6574 GPU \u5229\u7528\u7387\u6a21\u5f0f \u952f\u9f7f\u72b6\uff0c\u5927\u91cf\u7a7a\u95f2 \u952f\u9f7f\u72b6\uff0c\u7a7a\u95f2\u65f6\u95f4\u51cf\u5c11 \u6301\u7eed\u9ad8\u4f4d\uff0c\u63a5\u8fd1\u9971\u548c \u5ef6\u8fdf\u7279\u5f81 \u961f\u5934\u963b\u585e\u4e25\u91cd\uff0c\u9996\u4ee4\u724c\u5ef6\u8fdf\u9ad8 \u961f\u5934\u963b\u585e\u6709\u6240\u7f13\u89e3 \u9996\u4ee4\u724c\u5ef6\u8fdf\u663e\u8457\u964d\u4f4e \u541e\u5410\u91cf\u7279\u5f81 \u53d8\u5316\u8d1f\u8f7d\u4e0b\u541e\u5410\u91cf\u4f4e \u541e\u5410\u91cf\u6709\u6240\u63d0\u5347 \u5404\u79cd\u8d1f\u8f7d\u4e0b\u5747\u80fd\u5b9e\u73b0\u9ad8\u541e\u5410 \u4e3b\u8981\u5f31\u70b9 \u961f\u5934\u963b\u585e\u548c\u586b\u5145\u5f00\u9500 \u961f\u5934\u963b\u585e\u95ee\u9898\u4f9d\u7136\u5b58\u5728 \u5185\u5b58\u7ba1\u7406\u590d\u6742\u6027\u9ad8","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#chanllenges-resolutions","title":"Chanllenges &amp; Resolutions","text":"<p>\u4e0d\u540c\u8bf7\u6c42\u7531\u4e8e\u5df2\u751f\u6210\u7684 tokens \u6570\u91cf\u4e0d\u540c\uff0c\u5176 KV Cache \u7684\u957f\u5ea6\u4e5f\u4e0d\u540c\u3002Attention \u8ba1\u7b97\u4e2d\u9700\u8981\u67e5\u8be2\u5b8c\u6574\u7684 KV Cache</p> <ul> <li>\u65e0\u6cd5\u76f4\u63a5\u7528\u89c4\u5219\u5f20\u91cf\u6279\u5904\u7406\uff08\u7ef4\u5ea6\u4e0d\u5339\u914d\uff09</li> <li>\u5982\u679c padding \u5230\u6700\u5927\u957f\u5ea6\uff0c\u4f1a\u6d6a\u8d39\u5927\u91cf\u5185\u5b58\u548c\u8ba1\u7b97   MLP \u5c42\u7684\u8ba1\u7b97\u53ea\u4f9d\u8d56\u4e8e\u5f53\u524d\u65f6\u95f4\u6b65\u7684 hidden state\uff0c\u4e0d\u9700\u8981\u8bbf\u95ee\u5386\u53f2 KV Cache   \u6240\u4ee5 Orca[^orca] \u4f7f\u7528\u4e86\u5bf9 MLP \u8fdb\u884c batching \u52a0\u901f\uff0c\u800c Attention \u5219\u662f\u9010\u4e2a\u8fdb\u884c\u8ba1\u7b97</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#implement_1","title":"Implement","text":"<p>\u8fd9\u91cc\u5b9e\u9645\u4e0a\u4e5f\u7ed3\u5408\u4e86 Chunked Prefill</p> <ul> <li>\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u7b80\u5316\u7684\u65b9\u6cd5\uff1a\u9884\u586b\u5145\u4e00\u4e2a\u8bf7\u6c42\uff0c\u7136\u540e\u4e3a\u6bcf\u4e2a\u6b63\u5728\u8fdb\u884c\u7684\u8bf7\u6c42\u89e3\u7801\u4e00\u4e2a\u4ee4\u724c</li> </ul> Python<pre><code>while requests_in_queue_or_in_progress:\n    if prefill_request exists:\n        prefill_request.try_prefill()  # perform a chunk of chunked prefill\n        if prefill_request.ready:\n            if kv_cache.try_add(prefill_request):\n                prefill_request = next(requests)\n    tokens = decode(model, kv_cache)\n    requests.append(tokens)\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#chunked-prefill","title":"Chunked Prefill","text":"","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#why-chunked-prefill","title":"Why Chunked Prefill\uff1f","text":"<p>\u901a\u8fc7 Continuous Batching\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u591f\u5b9e\u73b0 token-level \u7684\u8c03\u5ea6\uff0c\u4f46\u662f prefill \u662f\u4e00\u4e2a\u6f2b\u957f\u4e14\u4e0d\u53ef\u5206\u5272\u7684\u5de5\u4f5c\u5355\u5143\uff0c\u5b83\u4f1a\u963b\u585e\u6574\u4e2a\u7cfb\u7edf\uff0c\u5e26\u6765\u961f\u5934\u963b\u585e\u95ee\u9898\uff1a</p> <ol> <li>\u961f\u5934\u963b\u585e\uff08Head-of-Line, HOL Blocking\uff09\uff1a\u5728\u670d\u52a1\u961f\u5217\u4e2d\uff0c\u4e00\u4e2a\u957f\u4e0a\u4e0b\u6587\u8bf7\u6c42\u7684 Prefill \u4efb\u52a1\u4f1a\u957f\u65f6\u95f4\u72ec\u5360 GPU \u8d44\u6e90\uff0c\u5bfc\u81f4\u540e\u7eed\u6240\u6709\u8bf7\u6c42\uff08\u5373\u4f7f\u662f\u5904\u7406\u65f6\u95f4\u5f88\u77ed\u7684\u8bf7\u6c42\uff09\u90fd\u5fc5\u987b\u6392\u961f\u7b49\u5f85\uff0c\u6781\u5927\u5730\u589e\u52a0\u4e86\u5b83\u4eec\u7684 TTFT\u00a0\u3002\u8fd9\u5bf9\u4e8e\u5728\u591a\u79df\u6237\u73af\u5883\u4e2d\u7ef4\u6301\u670d\u52a1\u8d28\u91cf\uff08QoS\uff09\u662f\u81f4\u547d\u7684\u3002</li> </ol> <p>\u89e3\u51b3\u6b64\u95ee\u9898\u7684\u552f\u4e00\u9014\u5f84\u662f\u4f7f\u8fd9\u4e2a\u957f\u4efb\u52a1\u53d8\u5f97\u53ef\u5206\u5272\u548c\u53ef\u62a2\u5360</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#what-is-chunked-prefill","title":"What is Chunked Prefill?","text":"<p>\u5c06\u4e00\u4e2a\u5b8c\u6574\u7684 Prefill \u4efb\u52a1\u5206\u89e3\u4e3a\u4e00\u7cfb\u5217\u66f4\u5c0f\u7684\u201c\u5757\u201d\uff08chunks\uff09\uff0c\u5b83\u5c06\u4e00\u4e2a\u6f2b\u957f\u3001\u4e0d\u53ef\u4e2d\u65ad\u7684\u4efb\u52a1\u8f6c\u53d8\u4e3a\u4e00\u7cfb\u5217\u77ed\u6682\u3001\u53ef\u4e2d\u65ad\u7684\u5b50\u4efb\u52a1\u3002\u8fd9\u4f7f\u5f97\u8c03\u5ea6\u5668\u80fd\u591f\u5728\u5904\u7406\u957f\u8bf7\u6c42\u7684\u5404\u4e2a chunk \u4e4b\u95f4\uff0c\u7a7f\u63d2\u6267\u884c\u5176\u4ed6\u77ed\u8bf7\u6c42\uff0c\u4ece\u800c\u6709\u6548\u7f13\u89e3\u961f\u5934\u963b\u585e\uff0c\u5b9e\u73b0\u66f4\u516c\u5e73\u7684\u8d44\u6e90\u5171\u4eab</p> <ul> <li> <p>\u5b9e\u73b0 Prefill \u4e0e Decode \u64cd\u4f5c\u7684\u66f4\u4f18\u5e76\u884c\u4e0e\u4ea4\u9519\uff1a\u901a\u8fc7\u5c06 Prefill \u4efb\u52a1\u7ec6\u7c92\u5ea6\u5316\uff0c\u8c03\u5ea6\u5668\u53ef\u4ee5\u5728\u6267\u884c\u4e00\u4e2a chunk \u7684 Prefill \u8ba1\u7b97\u540e\uff0c\u7acb\u5373\u8f6c\u53bb\u6267\u884c\u5176\u4ed6\u8bf7\u6c42\u7684 Decode \u6b65\u9aa4\uff0c\u7136\u540e\u518d\u56de\u6765\u5904\u7406\u4e0b\u4e00\u4e2a chunk\u00a0\u3002</p> </li> <li> <p>\u5904\u7406\u8d85\u957f\u4e0a\u4e0b\u6587\uff1a\u5f53\u8f93\u5165\u63d0\u793a\u7684\u957f\u5ea6\u8d85\u8fc7 GPU \u663e\u5b58\u5355\u6b21\u6240\u80fd\u5904\u7406\u7684\u6781\u9650\u65f6\uff0c\u5206\u5757\u5904\u7406\u6210\u4e3a\u4e00\u79cd\u5fc5\u8981\u624b\u6bb5 \u00a0\u3002</p> </li> <li> <p>\u521b\u5efa\u53ef\u9884\u6d4b\u7684\u8c03\u5ea6\u5355\u5143\uff1a\u5c06\u957f\u5ea6\u4e0d\u5b9a\u7684\u7528\u6237\u8f93\u5165\u8f6c\u5316\u4e3a\u56fa\u5b9a\u5927\u5c0f\u7684\u8ba1\u7b97\u4efb\u52a1\uff0c\u4f7f\u8c03\u5ea6\u66f4\u52a0\u89c4\u6574\u548c\u53ef\u9884\u6d4b</p> </li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#chanllenge-resolutions","title":"Chanllenge &amp; Resolutions","text":"<ul> <li>\u8ba1\u7b97\u6548\u7387\u4f4e\uff1a\u5c0f chunk \u4f1a\u964d\u4f4e\u6ce8\u610f\u529b\u8ba1\u7b97\u6838\uff08kernel\uff09\u7684\u6267\u884c\u6548\u7387\uff0c\u5bfc\u81f4\u541e\u5410\u91cf\u4e0b\u964d \u00a0\u3002 <p>\u8fd9\u662f\u56e0\u4e3a\u6ce8\u610f\u529b\u8ba1\u7b97\u7684\u6027\u80fd\u5bf9\u8f93\u5165\u77e9\u9635\u7684\u89c4\u6a21\u5f88\u654f\u611f\uff0c\u5c0f chunk \u610f\u5473\u7740\u67e5\u8be2\uff08Query\uff09\u77e9\u9635\u5f88\u5c0f\uff0c\u800c\u65e9\u671f\u7684\u6ce8\u610f\u529b\u6838\u5e76\u672a\u9488\u5bf9\u8fd9\u79cd\u201c\u957f Key\u3001\u77ed Query\u201d\u7684\u573a\u666f\u8fdb\u884c\u4f18\u5316 \u00a0\u3002</p> </li> <li>\u201c\u8bfb\u653e\u5927\u201d\uff08read amplification\uff09\uff1a\u5728\u8ba1\u7b97\u6bcf\u4e2a\u65b0 chunk \u7684\u6ce8\u610f\u529b\u65f6\uff0c\u7cfb\u7edf\u9700\u8981\u4ece\u901f\u5ea6\u8f83\u6162\u7684 HBM\uff08\u9ad8\u5e26\u5bbd\u5185\u5b58\uff09\u4e2d\u91cd\u65b0\u8bfb\u53d6\u4e4b\u524d\u6240\u6709 chunk \u7d2f\u79ef\u7684\u5b8c\u6574 KV Cache</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#resolutions","title":"Resolutions","text":"<ul> <li>PD \u5206\u79bb\uff1aPrefill \u548c Decode \u4efb\u52a1\u88ab\u7269\u7406\u5730\u5206\u914d\u5230\u4e0d\u540c\u7684 GPU \u96c6\u7fa4\u6216\u201c\u5de5\u4f5c\u8282\u70b9\u201d\uff08workers\uff09\u4e0a \u00a0\u3002\u4e00\u4e2a\u4e13\u7528\u7684 GPU \u6c60\u8d1f\u8d23\u5904\u7406\u8ba1\u7b97\u5bc6\u96c6\u7684 Prefill \u4efb\u52a1\uff0c\u751f\u6210 KV Cache\uff0c\u7136\u540e\u5c06\u8ba1\u7b97\u597d\u7684 KV Cache \u4f20\u8f93\u7ed9\u53e6\u4e00\u4e2a\u4e13\u7528\u4e8e\u5904\u7406 Decode \u4efb\u52a1\u7684 GPU \u6c60\u3002</li> </ul> <p>\u8ba1\u7b97\u5bc6\u96c6\u7684 Prefill \u4efb\u52a1\u4e0d\u518d\u4e0e\u5ef6\u8fdf\u654f\u611f\u7684 Decode \u4efb\u52a1\u5728\u540c\u4e00\u4e2a GPU \u4e0a\u4e89\u62a2\u8d44\u6e90\uff0c\u4ece\u800c\u6781\u5927\u5730\u63d0\u5347\u4e86 ITL \u7684\u7a33\u5b9a\u6027\u548c\u7cfb\u7edf\u7684\u53ef\u9884\u6d4b\u6027 \u00a0\u3002</p> <ul> <li>Flash Attention\uff1aFlashAttention \u662f\u4e00\u79cd I/O \u611f\u77e5\u7684\u6ce8\u610f\u529b\u7b97\u6cd5\uff0c\u5b83\u53ef\u4ee5\u5728\u4e0d\u5c06\u5b8c\u6574\u7684\u6ce8\u610f\u529b\u77e9\u9635\u5199\u5165 HBM \u7684\u60c5\u51b5\u4e0b\uff0c\u8ba1\u7b97\u51fa\u5b8c\u5168\u76f8\u540c\u7684\u7cbe\u786e\u7ed3\u679c</li> </ul> <p>\u5c06\u5c0f\u7684 Query \u5757\u52a0\u8f7d\u5230 SRAM\uff0c\u7136\u540e\u9ad8\u6548\u5730\u8fed\u4ee3\u5904\u7406\u5e9e\u5927\u7684 Key/Value \u77e9\u9635\u7684\u5404\u4e2a\u5206\u5757\uff0c\u907f\u514d\u4e86\u6027\u80fd\u9000\u5316\u3002</p> <p>\u5176\u6b21\uff0c\u901a\u8fc7\u5728 SRAM \u5185\u90e8\u5b8c\u6210\u5927\u90e8\u5206\u8ba1\u7b97\uff0cFlashAttention \u6781\u5927\u5730\u51cf\u5c11\u4e86\u5bf9 HBM \u7684\u8bbf\u95ee\uff0c\u4ece\u800c\u6709\u6548\u4e2d\u548c\u4e86\u56e0\u91cd\u590d\u8bfb\u53d6 KV Cache \u800c\u4ea7\u751f\u7684\u201c\u8bfb\u653e\u5927\u201d\u95ee\u9898</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#implement_2","title":"Implement","text":"<ul> <li>\u5728\u6574\u4e2a prefill \u4efb\u52a1\u7ed3\u675f\u4e4b\u524d\uff0c\u6211\u4eec\u4ec5\u4ec5\u53ea\u662f\u66f4\u65b0 model \u4e2d\u7684 KV Cache</li> <li>\u5728 prefill \u6700\u540e\u4e00\u4e2a chunk \u7ed3\u675f\u65f6\uff0c\u6211\u4eec\u9700\u8981\u751f\u6210\u4e00\u4e2a\u65b0\u7684 token(\u5373\u7b2c\u4e00\u4e2a output token)</li> </ul> Python<pre><code>def try_prefill(self):\n    new_token = update_kv_cache(key, value)\n    self.offset += tokens_to_prefill\n    if self.offset == self.prefill_tokens.size(-1):\n        self.is_prefill_done = True\n        self.decode_done(token.item(), False)\n\ndef decode_done(self, token, update_offset=True):\n    if token == self.eos_token_id:\n        self.is_done = True\n        return\n    self.generated_tokens.append(token)\n    self.next_token = token\n    if update_offset:\n        self.offset += 1\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#combine-kv-cache-with-batching","title":"Combine KV Cache with Batching","text":"<ul> <li>\u6211\u4eec\u8fd9\u91cc\u7684\u5b9e\u73b0\u5e76\u4e0d\u9ad8\u6548\uff0c\u53ea\u662f\u7b80\u5355\u5730\u5c06\u6240\u6709 KV Cache \u90fd padding \u5230 <code>max seq_len</code> \u4e0a\uff0c\u65b9\u4fbf GPU \u505a\u77e9\u9635\u8ba1\u7b97</li> <li>\u8fd9\u91cc\u7684\u8c03\u5ea6\u89c4\u5219\u662f prefill \u4f18\u5148\uff0c\u4f46\u662f prefill \u6309 chunk \u8c03\u5ea6</li> <li>\u5982\u679c\u6b64\u65f6\u6ca1\u6709\u7a7a\u95f2\u7684 slot\uff0cprefill \u5c31\u4e00\u76f4 pending</li> </ul> Python<pre><code>def batch_generate(\n\u00a0 \u00a0 model: any,\n\u00a0 \u00a0 tokenizer: AutoTokenizer,\n\u00a0 \u00a0 prompts: list[str],\n\u00a0 \u00a0 max_seq_len=512,\n\u00a0 \u00a0 batch_size=5,\n\u00a0 \u00a0 prefill_step=128,\n):\n\u00a0 \u00a0 decode_requests: list[Request] = [None] * batch_size\n\u00a0 \u00a0 is_idle = [True] * batch_size\n\u00a0 \u00a0 kv_cache = [\n\u00a0 \u00a0 \u00a0 \u00a0 BatchingKvCache(max_active_requests=batch_size, max_seq_len=max_seq_len)\n\u00a0 \u00a0 \u00a0 \u00a0 for _ in range(model.num_hidden_layers)\n\u00a0 \u00a0 ]\n\u00a0 \u00a0 result = []\n\u00a0 \u00a0 pending_prefill_request = None\n\u00a0 \u00a0 next_request_idx = 0\n\u00a0 \u00a0 progress_cnt = 0\n\u00a0 \u00a0 start_time = datetime.now()\n\n\u00a0 \u00a0 while True:\n\u00a0 \u00a0 \u00a0 \u00a0 # prefill until no idle slots\n\u00a0 \u00a0 \u00a0 \u00a0 if len(prompts) &gt; 0 and pending_prefill_request is None:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 prompt = prompts.pop(0)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pending_prefill_request = Request(\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 model, tokenizer, prompt, prefill_step, next_request_idx\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 )\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 next_request_idx += 1\n\n\u00a0 \u00a0 \u00a0 \u00a0 # In every iteration, we do a prefill first\n\u00a0 \u00a0 \u00a0 \u00a0 if pending_prefill_request is not None:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if not pending_prefill_request.is_prefill_done:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pending_prefill_request.try_prefill()\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if pending_prefill_request.is_prefill_done:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 prefill_kv_cache = pending_prefill_request.kv_cache\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 found_slot = False\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # found an idel slot in batch size\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 for i in range(batch_size):\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if is_idle[i]:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # Add this request to the decode requests\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 is_idle[i] = False\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 for prefill_cache, batch_cache in zip(\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 prefill_kv_cache, kv_cache\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ):\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 batch_cache.add_request(prefill_cache, i)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 decode_requests[i] = pending_prefill_request\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 found_slot = True\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 break\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if found_slot:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pending_prefill_request = None\n\n\u00a0 \u00a0 \u00a0 \u00a0 # After the prefill request moves forward one step, we do the decode\n\u00a0 \u00a0 \u00a0 \u00a0 if not all(is_idle):\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 next_tokens = []\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 offsets = []\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 for req in decode_requests:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if req is not None:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 next_tokens.append(req.next_token)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 offsets.append(req.offset)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 else:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 next_tokens.append(0)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 offsets.append(0)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # batch decode\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 next_tokens = _step(model, next_tokens.reshape(-1, 1), offsets, kv_cache)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 for i in range(batch_size):\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if not is_idle[i]:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 req = decode_requests[i]\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 remove_reason = None\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if req.is_done:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 for batch_cache in kv_cache:\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 batch_cache.remove_request(i)\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 is_idle[i] = True\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 result.append((req.prompt_idx, req.text()))\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 decode_requests[i] = None\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 continue\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # decode a new token\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 req.decode_done(next_tokens[i].item())\n\u00a0 \u00a0 return result\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#a-better-design","title":"A Better Design","text":"<p>\u4f7f\u7528 Page Attention + Continuous Batching + Chunked Prefill[^vllm]</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#continuous-batching_1","title":"\u8c03\u5ea6\u5668\uff1a\u8fde\u7eed\u6279\u5904\u7406 (Continuous Batching)","text":"<p>vLLM \u7684\u8c03\u5ea6\u5668\u6bcf\u4e00\u6b65\u90fd\u4f1a\u68c0\u67e5\u6240\u6709\u6b63\u5728\u8fd0\u884c\u7684\u5e8f\u5217\u3002\u5b83\u4f1a\u628a\u6240\u6709\u51c6\u5907\u597d\u751f\u6210\u4e0b\u4e00\u4e2a token \u7684\u5e8f\u5217\uff08\u65e0\u8bba\u5b83\u4eec\u5904\u4e8e\u4ec0\u4e48\u9636\u6bb5\uff0c\u957f\u5ea6\u662f\u591a\u5c11\uff09\u52a8\u6001\u5730\u7ec4\u5408\u6210\u4e00\u4e2a \"\u6279\u6b21\"\uff08Batch\uff09\u3002</p> <ul> <li>\u8fd9\u4e2a batch \u91cc\u53ef\u80fd\u5305\u542b\uff1a</li> <li>\u5e8f\u5217 A\uff08\u521a\u5904\u7406\u5b8c Prompt\uff0c\u957f\u5ea6 500\uff0c\u7b49\u5f85\u751f\u6210\u7b2c 501 \u4e2a token\uff09</li> <li>\u5e8f\u5217 B\uff08\u5df2\u7ecf\u751f\u6210\u4e86 80 \u4e2a token\uff0c\u7b49\u5f85\u751f\u6210\u7b2c 81 \u4e2a token\uff09</li> <li>\u5e8f\u5217 C\uff08\u4e00\u4e2a\u65b0\u8bf7\u6c42\uff0c\u6b63\u5728\u8fdb\u884c Preill\uff0c\u5904\u7406\u5b83\u7684 200 \u4e2a prompt token\uff09</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#attention-custom-kernel","title":"\u81ea\u5b9a\u4e49 Attention \u6838 (Custom Kernel)","text":"<p>vLLM \u7684 PagedAttention \u81ea\u5b9a\u4e49 CUDA \u6838 \u88ab\u8bbe\u8ba1\u4e3a\u53ef\u4ee5\u76f4\u63a5\u5904\u7406\u8fd9\u79cd \"\u5f02\u6784\" \u6279\u6b21\u3002</p> <ul> <li>Prefill \u8bf7\u6c42\u4f7f\u7528 \u00a0<code>context_attention_fwd</code>\u00a0 \u51fd\u6570\u5904\u7406\uff08\u652f\u6301\u591a token \u7684\u4e0a\u4e0b\u6587\u6ce8\u610f\u529b\uff09</li> <li>Decode \u8bf7\u6c42\u4f7f\u7528 <code>PagedAttention kernel</code> \u5904\u7406\uff08\u4f18\u5316\u7684\u5355 token \u6ce8\u610f\u529b\uff09</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#prons","title":"Prons","text":"<ul> <li>\u65e0\u9700 Padding\uff1a Kernel \u76f4\u63a5\u64cd\u4f5c\u4e0d\u540c\u957f\u5ea6\u7684\u6570\u636e\uff0c\u56e0\u4e3a Block Table \u660e\u786e\u544a\u8bc9\u4e86\u5b83\u6bcf\u4e2a\u5e8f\u5217\u5230\u5e95\u6709\u591a\u5c11 K/V\uff0c\u4ee5\u53ca\u5b83\u4eec\u7684\u4f4d\u7f6e\u3002</li> <li>\u7edf\u4e00\u5904\u7406\uff1a \u65e0\u8bba\u662f\u9884\u586b\u5145\uff08Prefill\uff09\u8fd8\u662f\u89e3\u7801\uff08Decoding\uff09\uff0c\u5728 PagedAttention Kernel \u770b\u6765\u90fd\u662f\u4e00\u6837\u7684\uff1a\u90fd\u662f\u4e00\u4e2a Query \u548c\u4e00\u4e2a\u6307\u5411\u5176\u5386\u53f2 K/V \u7684 Block Table\u3002\u8fd9\u4f7f\u5f97 vLLM \u53ef\u4ee5\u5c06 Preill \u548c Decoding \u8bf7\u6c42\u6df7\u5408\u5728\u540c\u4e00\u4e2a\u6279\u6b21\u4e2d\u5904\u7406\uff0c\u6781\u5927\u5730\u63d0\u9ad8\u4e86 GPU \u5229\u7528\u7387\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Batching%20Inference%20%26%20KV%20Cache/#reference","title":"Reference","text":"<p>[^orca]: Orca: A Distributed Serving System for Transformer-Based Generative Models [^vllm]: vllm</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/","title":"Group Query Attention","text":"2025-10-122025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#gqa-group-query-attention","title":"GQA: Group Query Attention","text":"<p> \u7ea6 637 \u4e2a\u5b57  101 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#group-query-attention","title":"Group Query Attention","text":"<p>\u8fd9\u662f\u4e00\u79cd\u9488\u5bf9\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u7684\u4f18\u5316\u6280\u672f\uff0c\u53ef\u4ee5\u964d\u4f4e\u4e0e\u952e (K) \u548c\u503c (V) \u6295\u5f71\u76f8\u5173\u7684\u8ba1\u7b97\u548c\u5185\u5b58\u6210\u672c\u3002\u4e0e\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236 (MHA) \u4e2d\u6bcf\u4e2a\u67e5\u8be2 (Q) \u5934\u90fd\u6709\u81ea\u5df1\u7684 K \u5934\u548c V \u5934\u4e0d\u540c\uff0c\u591a\u4e2a Q \u5934\u5171\u4eab\u76f8\u540c\u7684 K \u5934\u548c V \u5934\u3002\u591a\u67e5\u8be2\u6ce8\u610f\u529b\u673a\u5236 (MQA) \u662f GQA \u7684\u4e00\u4e2a\u7279\u4f8b\uff0c\u5176\u4e2d\u6240\u6709 Q \u5934\u5171\u4eab\u4e00\u4e2a K/V \u5934\u5bf9\u3002</p> <p>\u5b9e\u9645\u4e0a\u5728\u5e94\u7528\u65f6\uff0c\u6211\u4eec\u8fd8\u4f1a\u518d\u8ba1\u7b97 <code>q @ k</code> \u540e\u8fdb\u884c mask \u53e0\u52a0\uff0c\u8fd9\u91cc\u4e00\u822c\u6709\u4e24\u79cd\u60c5\u51b5\uff1a</p> <ul> <li>\u4e00\u79cd\u5c31\u662f\u6211\u4eec\u81ea\u5df1\u8bbe\u8ba1\u7684 mask \u5f62\u5f0f</li> <li>\u4e00\u79cd\u5c31\u662f <code>causal mask(\u56e0\u679c\u63a9\u7801)</code>\uff0c\u7528\u4e8e\u9632\u6b62\u6ce8\u610f\u529b\u673a\u5236\u5173\u6ce8\u5e8f\u5217\u4e2d\u672a\u6765 tokens \u7684\u6280\u672f</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#pytorch","title":"PyTorch \u793a\u4f8b","text":"Python<pre><code># Efficient implementation equivalent to the following:\ndef scaled_dot_product_attention(query, key, value, attn_mask=None, dropout_p=0.0,\n        is_causal=False, scale=None, enable_gqa=False) -&gt; torch.Tensor:\n    L, S = query.size(-2), key.size(-2)\n    scale_factor = 1 / math.sqrt(query.size(-1)) if scale is None else scale\n    attn_bias = torch.zeros(L, S, dtype=query.dtype, device=query.device)\n    if is_causal:\n        \"\"\"PyTorch: \u5982\u679c S &gt; L(\u5373\u5728\u63a8\u7406\u9636\u6bb5KV cache \u7d2f\u79ef\u7684 key \u66f4\u591a),\n        \u90a3\u4e48 query \u53ea\u80fd\u770b\u5230\u524d L \u4e2a key, \u8fd9\u662f\u4e0d\u6b63\u786e\u7684\n    \u00a0 \u00a0 [[1, 0, 0, 0, 0],\n         [1, 1, 0, 0, 0],\n         [1, 1, 1, 0, 0]]\n        \"\"\"\n        assert attn_mask is None\n        temp_mask = torch.ones(L, S, dtype=torch.bool).tril(diagonal=0)\n        attn_bias.masked_fill_(temp_mask.logical_not(), float(\"-inf\"))\n\n    if attn_mask is not None:\n        if attn_mask.dtype == torch.bool:\n            attn_bias.masked_fill_(attn_mask.logical_not(), float(\"-inf\"))\n        else:\n            attn_bias = attn_mask + attn_bias\n\n    if enable_gqa:\n        key = key.repeat_interleave(query.size(-3)//key.size(-3), -3)\n        value = value.repeat_interleave(query.size(-3)//value.size(-3), -3)\n\n    attn_weight = query @ key.transpose(-2, -1) * scale_factor\n    attn_weight += attn_bias\n    attn_weight = torch.softmax(attn_weight, dim=-1)\n    attn_weight = torch.dropout(attn_weight, dropout_p, train=True)\n    return attn_weight @ value\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#causal-masking","title":"Causal Masking","text":"<p>\u56e0\u679c\u63a9\u7801\u662f\u4e00\u79cd\u9632\u6b62\u6ce8\u610f\u529b\u673a\u5236\u5173\u6ce8\u5e8f\u5217\u4e2d\u672a\u6765 tokens \u7684\u6280\u672f\u3002\u5f53 \u00a0<code>mask</code>\u00a0 \u8bbe\u7f6e\u4e3a \u00a0<code>causal</code>\u00a0 \u65f6\uff0c\u6211\u4eec\u5c06\u5e94\u7528\u56e0\u679c\u63a9\u7801\u3002</p> <p>\u56e0\u679c\u63a9\u7801\u662f\u4e00\u4e2a\u5f62\u72b6\u4e3a \u00a0<code>(L, S)</code>\u00a0 \u7684\u65b9\u9635\uff0c\u5176\u4e2d \u00a0<code>L</code>\u00a0 \u662f\u67e5\u8be2\u5e8f\u5217\u957f\u5ea6\uff0c\u00a0<code>S</code>\u00a0 \u662f\u952e/\u503c\u5e8f\u5217\u957f\u5ea6\u3002\u63a9\u7801\u662f\u4e00\u4e2a\u4e0b\u4e09\u89d2\u77e9\u9635\uff0c\u5bf9\u89d2\u7ebf\u4e0a\u548c\u5bf9\u89d2\u7ebf\u4e0b\u65b9\u7684\u5143\u7d20\u4e3a 0\uff0c\u5bf9\u89d2\u7ebf\u4e0a\u7684\u5143\u7d20\u4e3a -inf\u3002\u4f8b\u5982\uff0c\u5982\u679c \u00a0<code>L = 3</code>\u00a0 \u4e14 \u00a0<code>S = 5</code>\u00a0\uff0c\u5219\u63a9\u7801\u5c06\u4e3a\uff1a</p> Bash<pre><code>0   0   0   -inf -inf\n0   0   0   0    -inf\n0   0   0   0    0\n</code></pre> <p>\u26a0 \u6211\u4eec\u7684\u5b9e\u73b0\u5b9e\u9645\u4e0a\u4e0e PyTorch API \u4e0d\u540c</p> Python<pre><code>def causal_mask(L: int, S: int, dtype: torch.dtype, device: str) -&gt; torch.Tensor:\n\u00a0 \u00a0 \"\"\"\n\u00a0 \u00a0 PyTorch: \u5982\u679c S &gt; L (\u5373\u5728\u63a8\u7406\u9636\u6bb5KV cache \u7d2f\u79ef\u7684 key \u66f4\u591a),\n\u00a0 \u00a0 \u90a3\u4e48 query \u53ea\u80fd\u770b\u5230\u524d L \u4e2a key, \u8fd9\u662f\u4e0d\u6b63\u786e\u7684\n\u00a0 \u00a0 [[1, 0, 0, 0, 0],\n\u00a0 \u00a0  [1, 1, 0, 0, 0],\n\u00a0 \u00a0  [1, 1, 1, 0, 0]]\n\n\u00a0 \u00a0 Ours:\n\u00a0 \u00a0 [[1, 1, 1, 0, 0],\n     [1, 1, 1, 1, 0],\n\u00a0 \u00a0  [1, 1, 1, 1, 1]]\n\u00a0 \u00a0 \"\"\"\n\u00a0 \u00a0 offset = S - L\n\u00a0 \u00a0 mask = torch.tril(torch.ones((L, S), device=device), diagonal=offset)\n\u00a0 \u00a0 mask = torch.where(mask.bool(), 0.0, -torch.inf).to(dtype=dtype, device=device)\n\u00a0 \u00a0 return mask\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#qwen2-grouped-query-attention","title":"Qwen2 Grouped Query Attention","text":"","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#overview","title":"Overview","text":"<p>\u6574\u4e2a LLM \u6d41\u7a0b\u662f\uff1a</p> <ul> <li>\u8f93\u5165 x \u5148\u7ecf\u8fc7 Embedding\uff0c<code>shape=(B, L, E)</code></li> <li>\u7136\u540e Embedding \u540e\u7684\u8f93\u5165\u518d\u7ecf\u8fc7 RoPE\uff0c<code>shape=(B, L, E)</code></li> <li>\u63a5\u7740\u8ba1\u7b97 Q\uff0cK\uff0cV\uff0c<code>Q shape=(B, L, E) -&gt; (B, L, H_q, D)</code>\uff0c<code>K&amp;V shape=(B, L, E) -&gt; (B, L, H, D)</code></li> <li>\u7136\u540e\u8fdb\u884c Grouped Query Attention \u64cd\u4f5c\uff0c\u5f97\u5230 query \u5bf9 key \u7684\u8ba1\u7b97\u76f8\u5173\u6027\u5206\u6570\u5e76\u5f52\u4e00\u5316\uff0c\u7136\u540e\u5bf9 V \u7684\u8fdb\u884c\u52a0\u6743\u6c42\u548c\uff0c\u6bcf\u4e2a\u6ce8\u610f\u529b\u5934\u90fd\u5728\u505a\u8fd9\u4ef6\u4e8b<code>shape=(B, L, H_q, D)</code></li> <li>\u6700\u540e\u5bf9\u62fc\u63a5\u540e\u7684\u591a\u4e2a\u6ce8\u610f\u529b\u5934\u7684\u7ed3\u679c\u901a\u8fc7\u6700\u540e\u4e00\u4e2a\u7ebf\u6027\u5c42\u8fdb\u884c\u53d8\u6362\uff0c\u5f97\u5230\u591a\u5934\u6ce8\u610f\u529b\u5c42\u7684\u6700\u7ec8\u8f93\u51fa<code>shape=(B, L, E)</code></li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#gqa","title":"GQA","text":"<p>\u793a\u4f8b\u4f2a\u4ee3\u7801\u5982\u4e0b\uff1a</p> Python<pre><code>x: B, L, E\nq = linear(x, wq, bq) -&gt; B, L, H_q, D\nk = linear(x, wk, bk) -&gt; B, L, H, D\nv = linear(x, wv, bv) -&gt; B, L, H, D\n\nq = rope(q, offset=slice(0, L))\nk = rope(k, offset=slice(0, L))\n(transpose as needed)\nx = scaled_dot_product_attention_grouped(q, k, v, scale, mask) -&gt; B, L, H_q, D ; Do this at float32 precision\n(transpose as needed)\nx = linear(x, wo) -&gt; B, L, E\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#rope","title":"RoPE","text":"<p>Qwen2 \u6a21\u578b\u91c7\u7528\u4e86\u4e00\u79cd\u975e\u4f20\u7edf\u7684 RoPE \u5f62\u5f0f\u3002\u5728\u8fd9\u79cd\u5f62\u5f0f\u4e0b\uff0c\u5934\u90e8\u5d4c\u5165\u7ef4\u5ea6\u88ab\u62c6\u5206\u6210\u4e24\u534a\uff0c\u5e76\u4e14\u8fd9\u4e24\u534a\u4ee5\u4e0d\u540c\u7684\u9891\u7387\u5e94\u7528\u3002\u5047\u8bbe \u00a0<code>x1 = x[.., :HALF_DIM]</code>\u00a0\uff0c\u00a0<code>x2 = x[.., HALF_DIM:]</code>\u00a0\u3002</p> Python<pre><code>output[0] = x1[0] * cos_freqs[0] + x2[0] * -sin_freqs[0]\noutput[HALF_DIM] = x1[0] * sin_freqs[0] + x2[0] * cos_freqs[0]\n\noutput[1] = x1[1] * cos_freqs[1] + x2[1] * -sin_freqs[1]\noutput[HALF_DIM + 1] = x1[1] * sin_freqs[1] + x2[1] * cos_freqs[1]\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/Group%20Query%20Attention/#transformers","title":"transformers \u7684\u5b9e\u73b0","text":"<p>\u9700\u8981\u5148\u8bbe\u7f6e Qwen2 \u7684 config\uff0c\u7136\u540e\u8bbe\u7f6e attention \u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u8fd9\u91cc\u9700\u8981\u8bbe\u7f6e\u6210 <code>sdpa(scale dot product attention)</code> \u624d\u80fd\u8fdb\u884c GQA \u7684\u8ba1\u7b97</p> Python<pre><code>from transformers import Qwen2Config\nfrom transformers.models.qwen2.modeling_qwen2 import (\n    Qwen2Attention,\n    Qwen2RotaryEmbedding,\n)\n\nconfig = Qwen2Config(\n    hidden_size=hidden_size,\n    num_hidden_layers=2,\n    intermediate_size=hidden_size * 4,\n    num_attention_heads=num_heads,\n    num_key_value_heads=num_kv_heads,\n    rms_norm_eps=1e-6,\n    vocab_size=1000,\n    rope_theta=theta,\n    max_position_embeddings=max_seq_len,\n)\n\nconfig._attn_implementation = \"sdpa\" \u00a0# \u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528causal mask\nrotary_emb = Qwen2RotaryEmbedding(config)\ntorch_attention = Qwen2Attention(config, layer_idx=0).to(device=dev, dtype=dtype)\n\ntorch.manual_seed(42)\nx = torch.rand(batch_size, seq_len, hidden_size, dtype=dtype, device=dev) * 2 - 1\nposition_ids = torch.arange(seq_len, device=dev).unsqueeze(0)\nposition_embeddings = rotary_emb(x, position_ids) # \u8f93\u5165\u5148\u8fdb\u884c RoPE\uff0c\u7136\u540e\u518d\u8fdb\u884c attention\n\ntorch_output = torch_attention(\n    x,\n    position_embeddings\n    attention_mask=None,\n    is_causal=True if mask == \"causal\" else False,\n)[0].to(device=dev, dtype=dtype)\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/","title":"RMSNorm & MLP","text":"2025-10-112025-12-10 <code>#LLMInference</code>","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#rmsnorm-mlp","title":"RMSNorm &amp; MLP","text":"<p> \u7ea6 1226 \u4e2a\u5b57  10 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#rmsnorm","title":"RMSNorm","text":"<p>RMSNorm[^rmsnorm] \u7684\u5b9a\u4e49\uff1a</p> \\[ y = \\\\frac{x}{\\\\sqrt{mean(x^2) + \\\\epsilon}} \\\\cdot weight \\] <ul> <li><code>x</code>\u00a0 \u662f\u8f93\u5165\u5f20\u91cf\u3002</li> <li><code>weight</code>\u00a0 \u662f\u4e00\u4e2a\u53ef\u5b66\u4e60\u7684\u7f29\u653e\u53c2\u6570\u3002</li> <li><code>epsilon(eps)</code> \u662f\u4e3a\u4e86\u6570\u503c\u7a33\u5b9a\u6027\u800c\u6dfb\u52a0\u7684\u4e00\u4e2a\u5c0f\u5e38\u6570\uff08\u4f8b\u5982\uff0c1e-5 \u6216 1e-6\uff09\u3002</li> <li>\\(mean(x^2)\\) \u662f\u5e73\u65b9\u548c\u7136\u540e\u9664\u4ee5\u5143\u7d20\u7684\u6570\u91cf</li> <li>LayerNorm \u6210\u529f\u7684\u5173\u952e\u5728\u4e8e\u5176 \u201c\u91cd\u65b0\u7f29\u653e\u201d (re-scaling) \u7684\u4e0d\u53d8\u6027\uff0c\u800c \u201c\u91cd\u65b0\u4e2d\u5fc3\u5316\u201d (re-centering\uff0c\u5373\u51cf\u53bb\u5747\u503c) \u8fd9\u4e00\u6b65\u53ef\u80fd\u4e0d\u662f\u5fc5\u9700\u7684</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#_1","title":"\u5f52\u4e00\u5316\u65b9\u6cd5","text":"\u65b9\u6cd5 \u5f52\u4e00\u5316\u7ef4\u5ea6 \u662f\u5426\u4f9d\u8d56\u6279\u6b21 \u4e3b\u8981\u5e94\u7528\u9886\u57df BatchNorm \u8de8\u6279\u6b21 (<code>N</code>)\uff0c\u5728\u6bcf\u4e2a\u7279\u5f81 (<code>D</code>) \u4e0a\u72ec\u7acb \u662f \u8ba1\u7b97\u673a\u89c6\u89c9 (CNN) LayerNorm\u00a0\u00a0 \u5c42\u8303\u6570 \u8de8\u7279\u5f81 (<code>D</code>)\uff0c\u5728\u6bcf\u4e2a\u6837\u672c (<code>N, S</code>) \u4e0a\u72ec\u7acb \u5426 \u81ea\u7136\u8bed\u8a00\u5904\u7406 (Transformer) GroupNorm\u00a0\u00a0 \u7fa4\u4f53\u89c4\u8303 \u8de8\u7279\u5f81\u5206\u7ec4\uff0c\u5728\u6bcf\u4e2a\u6837\u672c\u4e0a\u72ec\u7acb \u5426 \u8ba1\u7b97\u673a\u89c6\u89c9 (\u5c0f\u6279\u6b21\u573a\u666f) RMSNorm\u00a0\u00a0 \u5747\u65b9\u6839\u8303\u6570 \u8de8\u7279\u5f81 (<code>D</code>)\uff0c\u5728\u6bcf\u4e2a\u6837\u672c\u4e0a\u72ec\u7acb (\u7b80\u5316\u7248 LayerNorm) \u5426 \u5927\u8bed\u8a00\u6a21\u578b (LLM)","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#llm-rmsnorm","title":"\u4e3a\u4ec0\u4e48 LLM \u4f7f\u7528 RMSNorm","text":"<ul> <li>\u6781\u81f4\u7684\u6548\u7387 \ud83d\ude80\uff1aLLM \u53c2\u6570\u91cf\u6781\u5927\uff0cRMSNorm \u53bb\u6389\u4e00\u4e2a\u53ef\u8bad\u7ec3\u53c2\u6570\u5bf9 FLOPs \u51cf\u5c11\u6548\u679c\u975e\u5e38\u660e\u663e\u3002\u53ef\u4ee5\u5b9e\u73b0\u66f4\u5feb\u7684\u8bad\u7ec3\u901f\u5ea6\u548c\u66f4\u4f4e\u7684\u63a8\u7406\u5ef6\u8fdf\u3002</li> <li>\u6027\u80fd\u76f8\u5f53\uff1a\u8fd9\u79cd\u7b80\u5316\u5e76\u6ca1\u6709\u5e26\u6765\u660e\u663e\u7684\u6027\u80fd\u635f\u5931\u3002\u5728 Transformer \u8fd9\u79cd\u7ed3\u6784\u4e2d\uff0c\u53bb\u6389\u5747\u503c\u4e2d\u5fc3\u5316\u8fd9\u4e00\u6b65\uff0c\u6a21\u578b\u7684\u6027\u80fd\u4f9d\u7136\u975e\u5e38\u7a33\u5b9a\u548c\u5f3a\u5927\u3002</li> <li>\u8bad\u7ec3\u7a33\u5b9a\u6027\uff1aRMSNorm \u4fdd\u7559\u4e86 LayerNorm \u6700\u91cd\u8981\u7684\u7279\u6027\u2014\u2014\u91cd\u65b0\u7f29\u653e\u7684\u4e0d\u53d8\u6027\u3002\u8fd9\u610f\u5473\u7740\u5b83\u4f9d\u7136\u80fd\u591f\u6709\u6548\u5730\u63a7\u5236\u5c42\u4e0e\u5c42\u4e4b\u95f4\u6fc0\u6d3b\u503c\u7684\u5c3a\u5ea6\uff08scale\uff09\uff0c\u9632\u6b62\u68af\u5ea6\u7206\u70b8\u6216\u6d88\u5931\uff0c\u4fdd\u8bc1\u4e86\u6df1\u5ea6\u7f51\u7edc\u8bad\u7ec3\u7684\u7a33\u5b9a\u6027\u3002   RMSNorm \u63d0\u4f9b\u4e86\u4e00\u4e2a \u6027\u4ef7\u6bd4\u6781\u9ad8 \u7684\u65b9\u6848\uff0c\u7528\u6700\u5c0f\u7684\u6539\u52a8\u6362\u6765\u4e86\u663e\u8457\u7684\u6548\u7387\u63d0\u5347\uff0c\u540c\u65f6\u53c8\u6ca1\u6709\u727a\u7272\u6a21\u578b\u6027\u80fd\uff0c\u56e0\u6b64\u8fc5\u901f\u6210\u4e3a\u50cf Llama\u3001Qwen \u7b49\u4e3b\u6d41\u5927\u6a21\u578b\u7684\u6807\u914d\u3002</li> </ul>","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#mlp","title":"MLP","text":"","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#ffn-v1","title":"FFN v1","text":"<p>\u5728\u539f\u59cb Transformer\uff08Vaswani et al., 2017[^transformer]\uff09\u4e2d\uff0c\u524d\u9988\u5c42\uff08FFN\uff09\u901a\u5e38\u662f\uff1a \\(\\(\\\\text{FFN}(x) = W_2 \\\\cdot \\\\text{ReLU}(W_1 x)\\)\\) \u540e\u6765\u5f88\u591a\u6a21\u578b\uff08\u5982 BERT\uff09\u6539\u6210\u4e86 <code>GELU</code> \u6fc0\u6d3b\uff0c\u4f46\u6574\u4f53\u7ed3\u6784\u4ecd\u7136\u662f\u201c\u7ebf\u6027 \u2192 \u975e\u7ebf\u6027 \u2192 \u7ebf\u6027\u201d\uff0c\u6ca1\u6709\u95e8\u63a7\u673a\u5236\u3002</p> <p>\u26a0 \u5b58\u5728\u95ee\u9898</p> <p>Transformer \u7684 FFN \u5c42\u53ea\u4f7f\u7528\u4e00\u4e2a\u5355\u4e00\u7684\u975e\u7ebf\u6027\u6fc0\u6d3b\uff08\u5982 ReLU/GELU\uff09\uff0c\\ \u9650\u5236\u4e86\u6a21\u578b\u7684\u8868\u8fbe\u80fd\u529b\u548c\u68af\u5ea6\u6d41\u52a8\u3002</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#ffn-v2","title":"FFN v2","text":"<p>\u53ef\u4ee5\u501f\u9274\u5377\u79ef\u7f51\u7edc\u4e2d \u95e8\u63a7\u673a\u5236\uff08Gated Linear Unit, GLU\uff09 \u7684\u601d\u60f3\uff0c \u8ba9\u524d\u9988\u5c42\u7684\u8f93\u51fa\u7531\u4e24\u6761\u8def\u5f84\u5171\u540c\u51b3\u5b9a\uff1a\u4e00\u6761\u4e3b\u8def\u5f84 + \u4e00\u6761\u95e8\u63a7\u8def\u5f84\u3002</p> \\[ GLU(X)=(xW_a + b_a)\\\\odot \\\\sigma(xW_b + b_b) \\] <p>\\(W_a\\) \u662f\u4e3b\u901a\u9053\uff0c\\(W_b\\) \u662f\u95e8\u63a7\u901a\u9053\uff0c\u95e8\u63a7\u8def\u5f84\u63a7\u5236\u4e3b\u8def\u5f84\u4e2d\u54ea\u4e9b\u7279\u5f81\u53ef\u4ee5\u201c\u901a\u8fc7\u201d</p>","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#ffn-v3","title":"FFN v3","text":"<p>Shazeer [^swiglu]\u7cfb\u7edf\u5730\u6d4b\u8bd5\u4e86 \u5404\u79cd GLU \u53d8\u4f53 \u66ff\u6362 Transformer \u7684 FFN \u5b50\u5c42\u4e2d\u7684\u6fc0\u6d3b\u51fd\u6570\u3002</p> <p>\u4ed6\u628a\u4f20\u7edf FFN\uff1a \\(\\(W2\\\\cdot ReLU(W1x)\\)\\) \u66ff\u6362\u6210\uff1a \\(\\(W_3 \\\\cdot \\\\big( f(W_1 x) \\\\odot g(W_2 x) \\\\big)\\)\\) \u5176\u4e2d f \u548c g \u662f\u4e0d\u540c\u7684\u6fc0\u6d3b\u51fd\u6570\u7ec4\u5408\uff08sigmoid, ReLU, GELU, Swish...\uff09\u3002</p> \u540d\u79f0 \u516c\u5f0f \u6fc0\u6d3b\u51fd\u6570 \u7279\u70b9 GLU \\(a \\\\odot \\\\sigma(b)\\) sigmoid \u539f\u59cb\u7248\u672c ReGLU \\(a \\\\odot ReLU(b)\\) ReLU \u7a00\u758f\u6fc0\u6d3b\uff0c\u8ba1\u7b97\u7b80\u5355 GeGLU \\(a \\\\odot GELU(b)\\) GELU \u5e73\u6ed1\u68af\u5ea6 SwiGLU \\(a \\\\odot Swish(b)\\) Swish (SiLU) \u6700\u5e73\u6ed1\u3001\u6548\u679c\u6700\u597d <p>\ud83d\ude80 \u7528\u95e8\u63a7\u6fc0\u6d3b\u66ff\u6362\u4f20\u7edf FFN \u6fc0\u6d3b\u80fd\u663e\u8457\u63d0\u5347 Transformer \u6027\u80fd\u3002</p> \u540e\u7eed\u6a21\u578b \u91c7\u7528\u7684\u53d8\u4f53 \u6765\u6e90 T5 GeGLU \u6765\u81ea[^swiglu] PaLM / Qwen2 / LLaMA2-3 / Falcon SwiGLU \u6765\u81ea[^swiglu]\u7ed3\u8bba GPT-NeoX / MPT / Baichuan SwiGLU \u540c\u6e90\u601d\u60f3","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#_2","title":"\u635f\u5931\u51fd\u6570","text":"<ul> <li>GELU: \\(\\\\text{GELU}(x) = x \\\\cdot \\\\Phi(x)\\)\uff0c\u662f\u4e00\u4e2a\u6982\u7387\u95e8\u63a7\uff0c\u5bf9\u8f93\u5165\u4e58\u4ee5\u4e00\u4e2a\u4ecb\u4e8e 0 \uff5e 1 \u7684\u6982\u7387\uff08\u7531\u9ad8\u65af\u5206\u5e03\u51b3\u5b9a\uff09   \u5176\u4e2d\uff0c\\(\\\\Phi(x)\\) \u662f\u6807\u51c6\u6b63\u6001\u5206\u5e03\u7684\u7d2f\u79ef\u5206\u5e03\u51fd\u6570 (CDF)\uff1a   $$   \\Phi(x) = \\frac{1}{2}\\left[1 + \\operatorname{erf}\\left(\\frac{x}{\\sqrt{2}}\\right)\\right]   $$   \u7b49\u4ef7\u7684\u8fd1\u4f3c\u5f62\u5f0f\uff08\u4fbf\u4e8e\u8ba1\u7b97\uff09\u4e3a\uff1a   $$   \\text{GELU}(x) \\approx 0.5x \\left(1 + \\tanh\\left[\\sqrt{\\frac{2}{\\pi}}\\left(x + 0.044715x^3\\right)\\right]\\right)   $$</li> <li>SiLU: \\(SiLU(x)=x \\\\cdot \\\\sigma(x)\\)\uff0c\u5e73\u6ed1\u53ef\u5bfc\uff0c\u65e0\u96f6\u68af\u5ea6\u6b7b\u533a\uff1b</li> <li>\u5bf9\u5c0f\u8d1f\u503c\u4ecd\u7136\u6709\u90e8\u5206\u54cd\u5e94</li> <li>\u5bf9\u5927\u6b63\u503c\u8d8b\u8fd1\u4e8e\u7ebf\u6027\uff1b<ul> <li>\u5bf9\u5927\u8d1f\u503c\u8d8b\u8fd1\u4e8e 0\u3002</li> </ul> </li> </ul> \u7279\u6027 GELU SiLU (Swish) \u5b9a\u4e49 \\(x \\\\cdot \\\\Phi(x)\\) \\(x \\\\cdot \\\\sigma(x)\\) \u6765\u6e90 BERT, GPT \u7b49 EfficientNet, LLaMA, Qwen2 \u5e73\u6ed1\u6027 \u9ad8 \u9ad8 \u662f\u5426\u5bf9\u79f0 \u5426 \u5426 \u662f\u5426\u6709\u95e8\u63a7\u5f62\u5f0f \u5426 \u2705 \u53ef\u76f4\u63a5\u95e8\u63a7\uff08GLU \u53d8\u4f53\u4e2d\u5e38\u7528\uff09 \u8ba1\u7b97\u590d\u6742\u5ea6 \u7a0d\u9ad8\uff08\u542b tanh/erf\uff09 \u7565\u4f4e \u6548\u679c Transformer \u7ecf\u5178\u9009\u62e9 \u73b0\u4ee3 LLM\uff08\u5982 Qwen2\u3001LLaMA\uff09\u504f\u7231","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#qwen2-mlp","title":"Qwen2 MLP","text":"<p>Qwen2 \u7684 MLP \u4e2d\u7684\u6240\u6709\u7ebf\u6027\u6295\u5f71\u901a\u5e38\u90fd\u662f\u65e0 bias \u5b9e\u73b0\u7684\u3002</p> <ul> <li>A gate linear projection (\\(W\\_{gate}\\)\u200b).</li> <li>An up linear projection (\\(W\\_{up}\\)\u200b).</li> <li>A SiLU activation function applied to the output of\u00a0\\(W\\_{gate}\\)</li> <li>An element-wise multiplication of the SiLU-activated\u00a0\\(W\\_{gate}\\)\u00a0output and the\\(W\\_{up}\\)\u00a0output. This forms the \"gated\" part.</li> <li>A final down linear projection (\\(W\\_{down}\\)\u200b).   $$   MLP(x) = (SiLu(W_{gate}(x))\\odot W_{up}(x))W_{down}   $$</li> </ul> Python<pre><code>N.. is zero or more dimensions for batches\nE is hidden_size (embedding dimension of the model)\nI is intermediate_size (dimension of the hidden layer in MLP)\nL is the sequence length\n\ninput: N.. x L x E\nw_gate: I x E\nw_up: I x E\nw_down: E x I\noutput: N.. x L x E\n</code></pre>","tags":["LLMInference"]},{"location":"notes/tiny-llm/RMSNorm%20%26%20MLP/#reference","title":"Reference","text":"<p>[^transformer]: Attention Is All You Need [^swiglu]: GLU Variants Improve Transformer [^rmsnorm]: Root Mean Square Layer Normalization</p>","tags":["LLMInference"]},{"location":"paperreadings/","title":"index","text":""},{"location":"paperreadings/#paper-readings","title":"Paper Readings \ud83d\udcda","text":"2025-12-022025-12-10 <p>Abstract</p> <p>\u4e00\u4e9b\u8bba\u6587\u7cbe\u8bfb\u548c\u7b14\u8bb0\u90fd\u505a\u5728\u8fd9\u91cc\uff0c\u65b9\u4fbf\u67e5\u9605\u3002</p> Text Only<pre><code>\u672c\u90e8\u5206\u5185\u5bb9\uff08\u9664\u7279\u522b\u58f0\u660e\u5916\uff09\u91c7\u7528 [**\u7f72\u540d-\u975e\u5546\u4e1a\u6027\u4f7f\u7528-\u4fdd\u6301\u4e00\u81f4 4.0 \u56fd\u9645 (CC BY-NC-SA 4.0)**](https://creativecommons.org/licenses/by-nc-sa/4.0/) \u8bb8\u53ef\u534f\u8bae\u8fdb\u884c\u8bb8\u53ef\u3002\n</code></pre>"},{"location":"paperreadings/template/","title":"3D Active Metric-Semantic SLAM \u8bba\u6587\u7cbe\u8bfb","text":"2025-10-132025-12-10 <code>#VINS</code>","tags":["VINS"]},{"location":"paperreadings/template/#3d-active-metric-semantic-slam","title":"3D Active Metric-Semantic SLAM \u8bba\u6587\u7cbe\u8bfb","text":"<p> \u7ea6 104 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> <p>RA-L 2024 \u4f5c\u8005\u4fe1\u606f\uff1aYuezhan Tao, \u5bbe\u897f\u6cd5\u5c3c\u4e9a\u5927\u5b66\u7684 GRASP \u5b9e\u9a8c\u5ba4\uff0c\u4e3b\u8981\u7814\u7a76\u65b9\u5411\u4e3a\u673a\u5668\u4eba\u81ea\u4e3b\u5bfc\u822a\u548c 3D \u91cd\u5efa\u4ee5\u53ca\u5c06\u8fd9\u4e9b\u4e1c\u897f\u4e0e AI \u548c LLM \u878d\u5408</p>","tags":["VINS"]},{"location":"paperreadings/template/#abstract","title":"Abstract","text":"","tags":["VINS"]},{"location":"paperreadings/template/#introduction","title":"Introduction \u603b\u4f53\u4ecb\u7ecd","text":"","tags":["VINS"]},{"location":"paperreadings/template/#background","title":"Background","text":"","tags":["VINS"]},{"location":"paperreadings/template/#method","title":"Method","text":"","tags":["VINS"]},{"location":"paperreadings/template/#experimentsevaluationresults","title":"Experiments/Evaluation/Results","text":"","tags":["VINS"]},{"location":"paperreadings/template/#conclusion","title":"Conclusion","text":"","tags":["VINS"]},{"location":"paperreadings/template/#my-summary","title":"My Summary","text":"","tags":["VINS"]},{"location":"paperreadings/template/#reference","title":"Reference","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/","title":"3D Active Metric-Semantic SLAM \u8bba\u6587\u7cbe\u8bfb","text":"2025-10-132025-12-10 <code>#VINS</code>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#3d-active-metric-semantic-slam","title":"3D Active Metric-Semantic SLAM \u8bba\u6587\u7cbe\u8bfb","text":"<p> \u7ea6 6863 \u4e2a\u5b57  7 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 34 \u5206\u949f</p> <p>RA-L 2024 \u4f5c\u8005\u4fe1\u606f\uff1aYuezhan Tao, \u5bbe\u897f\u6cd5\u5c3c\u4e9a\u5927\u5b66\u7684 GRASP \u5b9e\u9a8c\u5ba4\uff0c\u4e3b\u8981\u7814\u7a76\u65b9\u5411\u4e3a\u673a\u5668\u4eba\u81ea\u4e3b\u5bfc\u822a\u548c 3D \u91cd\u5efa\u4ee5\u53ca\u5c06\u8fd9\u4e9b\u4e1c\u897f\u4e0e AI \u548c LLM \u878d\u5408</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#abstract","title":"Abstract","text":"<p>\u4e3b\u8981\u89e3\u51b3\u4e86\u5728 SWaP(Size Weight and Power)\u53d7\u9650\u7684\u5e73\u53f0\u4e0a\u5728\u65e0 GPS \u7684\u591a\u5c42\u5ba4\u5185\u73af\u5883\u4e2d\u81ea\u4e3b\u63a2\u7d22\u548c metric-semantic mapping\u7684\u95ee\u9898</p> <ul> <li>previous work: \u5047\u8bbe localization \u662f\u7cbe\u786e\u7684\uff0c\u4f1a\u5bfc\u81f4\u4e0d\u786e\u5b9a\u6027\u7684\u79ef\u7d2f\uff1b\u540c\u65f6\u51cf\u5c0f\u4e0d\u786e\u5b9a\u6027\u7684\u64cd\u4f5c\u4e0e\u63a2\u7d22\u672a\u77e5\u73af\u5883\u7684\u64cd\u4f5c\u662f\u51b2\u7a81\u7684</li> <li>this work: \u63d0\u51fa\u4e86\u4e00\u79cd\u5e73\u8861\u4e0d\u786e\u5b9a\u6027\u548c\u63a2\u7d22\u7684\u89c4\u5212\u6846\u67b6</li> <li>\u4ece\u4f20\u611f\u5668\u7684\u539f\u59cb\u4fe1\u606f\u63d0\u53d6\u7684\u7a00\u758f\u4fe1\u606f\u8fdb\u884c metric-semantic SLAM</li> <li>\u4e0e\u8fd9\u4e2a\u5b9e\u9a8c\u5ba4\u5176\u4ed6\u7684\u5de5\u4f5c\u4e00\u8d77\uff0c\u7ec4\u6210\u4e86\u4e00\u4e2a\u65e0\u4eba\u673a\u81ea\u4e3b\u63a2\u7d22\u7cfb\u7edf</li> <li>\u5bf9\u65e0\u4eba\u673a\u59ff\u6001\u4f30\u8ba1\u7684\u8bef\u5dee\u51cf\u5c11\u6548\u679c\u663e\u8457     &gt; \u673a\u5668\u4eba\u59ff\u6001\u4f30\u8ba1\u7684\u5e73\u79fb\u8bef\u5dee\u51cf\u5c11\u8d85\u8fc7 90%     &gt; \u504f\u822a\u8bef\u5dee\u51cf\u5c11\u7ea6 75%     &gt; \u59ff\u6001\u4f30\u8ba1\u548c\u8bed\u4e49\u56fe\u7684\u4e0d\u786e\u5b9a\u6027\u5206\u522b\u51cf\u5c11 70% \u548c 65%</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#introduction","title":"Introduction \u603b\u4f53\u4ecb\u7ecd","text":"<p>2D \u73af\u5883\u4e3b\u8981\u5173\u5fc3\u73af\u5883\u7684\u51e0\u4f55\u4fe1\u606f\uff1b\u57fa\u4e8e 3D \u73af\u5883\u7684 metric-semantic maps \u540c\u65f6\u5173\u5fc3\u73af\u5883\u7684\u51e0\u4f55\u548c\u8bed\u4e49\u4fe1\u606f\uff0c\u5f88\u591a metric-semantic SLAM \u4f7f\u7528\u6df1\u5ea6\u7f51\u7edc\u6a21\u578b\u6765\u63d0\u53d6\u73af\u5883\u7684\u8bed\u4e49\u4fe1\u606f</p> <p>semantic objects: \u63d0\u4f9b\u7a00\u758f\u4f46\u662f\u4fe1\u606f\u5316\u7684\u73af\u5883\u8868\u793a \u81ea\u4e3b\u63a2\u7d22\u95ee\u9898\u73b0\u5728\u88ab\u5e7f\u6cdb\u7814\u7a76\uff0c\u4f46\u662f\u4e4b\u524d\u7684\u5de5\u4f5c\u5f88\u5c11\u8003\u8651 metric-semantic mapping \u6216 active metric-semantic mapping \u95ee\u9898\uff1b\u5373\u4f7f\u6709\u4e00\u4e9b\u5de5\u4f5c\u8003\u8651\u4e86 active metric-semantic mapping \u95ee\u9898\uff0c\u4f46\u662f\u5b83\u4eec\u5c06 mapping \u548c localization \u89e3\u8026 \u89e3\u8026 mapping \u548c localization \u4f1a\u5bfc\u81f4\u4e0d\u786e\u5b9a\u6027\u7684\u79ef\u7d2f\uff0c\u4f1a\u5bfc\u81f4\u673a\u5668\u4eba\u504f\u79bb\u671f\u671b\u7684\u8f68\u8ff9</p> <p>\u63d0\u51fa\u4e86\u4e00\u4e2a\u7edf\u4e00\u7684\u6846\u67b6\uff0c\u89e3\u51b3 exploration, localization \u548c metric-semantic mapping \u95ee\u9898</p> <ol> <li>\u4e3b\u52a8\u8bed\u4e49\u95ed\u73af\u68c0\u6d4b (SLC) \u6a21\u5757\u548c SLC \u7b97\u6cd5\uff1a\u4e3b\u52a8 SLC \u6a21\u5757\u4f7f\u7528\u7a00\u758f\u4f46\u8bed\u4e49\u4e0a\u6709\u610f\u4e49\u7684\u73af\u5883\u8868\u793a\u6765\u751f\u6210\u548c\u8bc4\u4f30 SLC \u5019\u9009\u8005\u3002 SLC \u7b97\u6cd5\u5efa\u7acb\u5728\u8fd9\u79cd\u8868\u793a\u7684\u57fa\u7840\u4e0a\u6765\u68c0\u6d4b\u95ed\u73af\u5e76\u4f30\u8ba1\u76f8\u5bf9\u59ff\u6001\u53d8\u6362\u3002</li> <li>\u6743\u8861 exploraion \u548c exploitation \u7684\u6846\u67b6\uff1a\u524d\u8005\u88ab\u5efa\u6a21\u4e3a\u76f8\u5173\u6027\u5bfb\u8def\u95ee\u9898\uff08COP\uff09\uff0c\u540e\u8005\u662f\u4f7f\u7528 SLC-enbaled \u7684 active uncertainty reduction planning \u6765\u5b9e\u73b0\u7684</li> <li>\u7528\u4e8e\u5b8c\u5168\u81ea\u4e3b\u65e0\u4eba\u673a\u7684 3D \u63a2\u7d22\u548c\u5bfc\u822a\u5806\u6808\uff0c\u5177\u6709\u5b9e\u65f6 metric-semantic \u5b9a\u4f4d\u548c\u5efa\u56fe\u529f\u80fd\u3002</li> </ol>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#background","title":"Background","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#3d","title":"3D \u81ea\u4e3b\u63a2\u7d22","text":"<p>\u4e4b\u524d\u5bf9 2D \u73af\u5883\u7684\u63a2\u7d22\u65b9\u6cd5\u8f83\u591a\uff0c\u5bf9\u6574\u4e2a 3D \u73af\u5883\u63a2\u7d22\u51fa\u73b0\u4e86\u4e00\u4e9b\u65b0\u7684\u65b9\u6cd5</p> <ul> <li>\u4f7f\u7528\u968f\u673a\u8fc7\u7a0b\u65b9\u7a0b\u6765\u68c0\u67e5 3D frontiers</li> <li>\u4f7f\u7528\u4fe1\u606f\u8bba\u65b9\u6cd5\u6765\u9009\u62e9\u4e0b\u4e00\u4e2a\u6700\u4f73\u89c6\u56fe(NBV)</li> <li>\u5c06\u63a2\u7d22\u95ee\u9898\u770b\u4f5c\u662f TSP \u95ee\u9898\uff0c\u5bf9\u8fb9\u754c\u5468\u56f4\u7684 3D viewpoint \u8fdb\u884c\u4e86\u91c7\u6837\uff0c\u5e76\u5728\u6574\u4e2a\u63a2\u7d22\u8fc7\u7a0b\u4e2d\u89c4\u5212 TSP tour\u3002TSP \u4ec5\u4ec5\u8981\u6c42\u8bbf\u95eeall viewpoints\u800c\u4e0d\u8003\u8651\u6bcf\u4e2a viewpoint \u7684\u4fe1\u606f</li> <li>This work \u5c06\u63a2\u7d22\u95ee\u9898\u5efa\u6a21\u4e3a\u76f8\u5173\u6027\u5bfb\u8def\u95ee\u9898(COP)\uff0c\u5b83\u5177\u6709\u4e09\u4e2a\u4e3b\u8981\u5c5e\u6027\uff1a</li> <li>\u9876\u70b9\u6709\u4e0e\u4e4b\u76f8\u5173\u7684\u5956\u52b1</li> <li>\u9876\u70b9\u4e4b\u95f4\u7684\u5956\u52b1\u5b58\u5728\u76f8\u5173\u6027</li> <li>\u9884\u7b97\u7ea6\u675f\u9650\u5236\u4e86\u53ef\u4ee5\u8bbf\u95ee\u7684\u9876\u70b9\u6570\u91cf\u3002</li> <li>COP \u662f\u5b9a\u5411\u95ee\u9898 (OP) \u7684\u63a8\u5e7f\uff0c\u5b83\u5728\u5229\u7528\u9876\u70b9\u4e4b\u95f4\u7684\u76f8\u5173\u6027\u7684\u540c\u65f6\u6700\u5927\u5316\u603b\u5956\u52b1\u3002     &gt; \u7ed3\u5408\u73b0\u6709\u7684\u5b9a\u6027\u548c\u5b9a\u91cf\u7ed3\u679c\uff0cCOP \u5bf9\u73af\u5883\u7684\u5efa\u6a21\u6bd4 OP \u548c TSP \u66f4\u51c6\u786e\u3002\u56e0\u6b64\uff0cCOP \u662f\u6211\u4eec\u8fdb\u884c 3D \u81ea\u4e3b\u63a2\u7d22\u8def\u5f84\u89c4\u5212\u7684\u9009\u62e9\u3002</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#active-semantic-slam","title":"Active Semantic SLAM","text":"<p>metric-semantic SLAM \u4e0e\u4f20\u7edf SLAM \u7684\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e\uff0c\u5b83\u4e0d\u4ec5\u5229\u7528\u4f20\u7edf\u7684\u51e0\u4f55\u7279\u5f81\uff0c\u5982\u70b9\u3001\u7ebf\u6216\u5e73\u9762\uff0c\u800c\u4e14\u8fd8\u5229\u7528\u8bed\u4e49\u7279\u5f81\uff0c\u5982object classes\u3002</p> <ul> <li>\u5b83\u6709\u52a9\u4e8e\u673a\u5668\u4eba\u5b9a\u4f4d\uff0c\u56e0\u4e3a object \u7279\u5f81\u4fe1\u606f\u66f4\u4e30\u5bcc\uff0c\u5b58\u50a8\u6548\u7387\u66f4\u9ad8\uff0c\u5e76\u4e14\u5bf9 viewpoint \u53d8\u5316\u5177\u6709\u9c81\u68d2\u6027\u3002\u5f53\u5728\u65e0\u6cd5\u4f7f\u7528 GPS \u7684\u975e\u7ed3\u6784\u5316\u73af\u5883\u4e2d\u4e0e\u81ea\u4e3b\u5bfc\u822a\u5b9e\u65f6\u96c6\u6210\u65f6\uff0c\u8fd9\u4e00\u70b9\u5c24\u5176\u6709\u7528\u3002</li> <li>\u5176\u6b21\uff0c\u5b83\u4e3a\u673a\u5668\u4eba\u63d0\u4f9b\u4e86\u5bf9\u73af\u5883\u7684\u9ad8\u5c42\u6b21\u7684\u7406\u89e3\uff0c\u8fd9\u79cd\u5148\u8fdb\u7684\u611f\u77e5\u80fd\u529b\u4f7f\u673a\u5668\u4eba\u80fd\u591f\u6267\u884c\u5177\u6709\u8bed\u4e49\u610f\u4e49\u7684\u4efb\u52a1\u89c4\u8303\u7684\u4efb\u52a1\uff0c\u4f8b\u5982\u4e3b\u52a8\u6536\u96c6\u611f\u5174\u8da3 object \u7684\u4fe1\u606f\u6216\u534f\u4f5c\u8c03\u67e5\u73af\u5883\u4ee5\u53d1\u73b0 objects</li> </ul> <p>\u6211\u4eec\u5229\u7528\u73af\u5883\u4e2d\u7684\u7a00\u758f\u8bed\u4e49 landmark \u6765\u51cf\u5c11\u63a2\u7d22\u8fc7\u7a0b\u4e2d\u673a\u5668\u4eba\u72b6\u6001\u4f30\u8ba1\u7684\u4e0d\u786e\u5b9a\u6027\u3002\u6211\u4eec\u901a\u8fc7\u79ef\u6781\u5efa\u7acb Semantic Loop Closure \u6765\u5b9e\u73b0\u8fd9\u4e00\u76ee\u6807\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u76ee\u6807\u662f\u91cd\u65b0\u5ba1\u89c6 SLC \u7684 viewpoint\uff0c\u5373\u53d1\u73b0\u4e00\u7ec4 semantic object \u6765\u51cf\u5c11 SLAM \u4e2d\u7684\u4e0d\u786e\u5b9a\u6027\u3002</p> <p>\u73b0\u6709\u65b9\u6cd5\u53ef\u4ee5\u5229\u7528\u8bed\u4e49\u56fe\u8fdb\u884c\u88ab\u52a8\u95ed\u73af \uff0c\u6216\u4f7f\u7528\u51e0\u4f55\u89c2\u5bdf\u8fdb\u884c opportunistic loop closure\u3002</p> <p>\u6211\u4eec\u5efa\u8bae\u5c06\u8bed\u4e49\u5730\u56fe\u7528\u4e8e\u4e3b\u52a8 SLC\uff0c\u8fd9\u4f7f\u5f97\u673a\u5668\u4eba\u80fd\u591f\u5728\u66f4\u5927\u8303\u56f4\u5185\u8ddf\u8e2a\u73af\u5883\uff0c\u6709\u6548\u68c0\u6d4b\u548c\u4f30\u8ba1\u95ed\u73af\u65f6\u7684\u76f8\u5bf9\u53d8\u6362\uff0c\u5e76\u540c\u65f6\u4f18\u5316\u59ff\u6001\u4f30\u8ba1\u548c semantic mapping \u7684\u7cbe\u5ea6</p> <p>\u8def\u6807 (Landmark) \u662f\u73af\u5883\u4e2d\u4e00\u4e2a\u7a33\u5b9a\u3001\u53ef\u8bc6\u522b\u3001\u4e14\u80fd\u88ab\u91cd\u590d\u89c2\u6d4b\u7684\u7279\u5f81\u70b9\u3002</p> <ul> <li>Active Loop Closure: \u8be5\u7b97\u6cd5\u7684\u672c\u8d28\u662f\u4e00\u4e2a\u51b3\u7b56\u8fc7\u7a0b\uff0c\u7528\u4e8e\u5728\u4e24\u4e2a\u9009\u9879\u4e2d\u505a\u51fa\u9009\u62e9\uff1a</li> <li>\u7eaf\u63a2\u7d22 (Explore-Only)\uff1a\u7ee7\u7eed\u6267\u884c\u53ea\u8bbf\u95ee\u672a\u77e5\u533a\u57df\u8fb9\u754c\uff08Frontiers\uff09\u7684\u6700\u4f18\u8def\u5f84 T_frt\u3002</li> <li>\u63a2\u7d22\u4e0e\u95ed\u73af\u7ed3\u5408 (Explore-with-Loop-Closure)\uff1a\u5148\u53bb\u4e00\u4e2a\u53ef\u4ee5\u8fdb\u884c\u95ed\u73af\u68c0\u6d4b\u7684\u5730\u65b9\u6821\u51c6\u4f4d\u7f6e\uff0c\u7136\u540e\u518d\u53bb\u63a2\u7d22\u672a\u77e5\u533a\u57df\u3002(\u5c06\u6574\u4e2a\u63a2\u7d22\u6240\u6709 frointers \u770b\u4f5c\u662f ATSP \u95ee\u9898) </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#method","title":"Method","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#goal","title":"Goal","text":"<p>\u5728\u7ed9\u5b9a\u7684\u63a2\u7d22\u9884\u7b97\u5185\u6700\u5927\u9650\u5ea6\u5730\u63d0\u9ad8 3D \u7a7a\u95f4\u4e2d\u7ed9\u5b9a\u533a\u57df\u7684 metric-semantic \u56fe\u7684\u51c6\u786e\u6027\u3002</p> <ul> <li>\u6709\u6548\u5730\u63a2\u7d22\u73af\u5883: \u6211\u4eec\u5c06\u95ee\u9898\u5efa\u6a21\u4e3a COP\uff0c\u5176\u89e3\u51b3\u65b9\u6848\u63d0\u4f9b\u4e86\u4e00\u6761\u957f\u671f\u63a2\u7d22\u8def\u5f84</li> <li>\u79ef\u6781\u51cf\u5c11\u5176\u72b6\u6001\u4f30\u8ba1\u548c metric-semantic \u56fe\u7684\u4e0d\u786e\u5b9a\u6027: \u6211\u4eec\u901a\u8fc7 active SLC\u3001\u6743\u8861 metric-semantic SLAM \u4e2d\u7684\u63a2\u7d22\u548c\u4e0d\u786e\u5b9a\u6027\u51cf\u5c11\u6765\u5b8c\u5584\u8def\u5f84\u3002</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#hardware-platform","title":"Hardware Platform","text":"<p>\u4f7f\u7528\u4e86\u4e00\u4e2a 250 \u8f74\u8ddd\u7684\u65e0\u4eba\u673a\u5e73\u53f0\uff0c\u914d\u5907\u4e86\u4e00\u4e2a Intel Realsense D455 RGB-D \u76f8\u673a\u548c\u4e00\u4e2a VOXL VIO Module\uff0c\u4ee5\u53ca\u4e00\u4e2a NUC(i7 \u5904\u7406\u5668)\u4f5c\u4e3a\u673a\u8f7d\u8ba1\u7b97\u5355\u5143\u3002</p> <p>VIO \u6570\u636e\u4e0e IMU \u6570\u636e\u4e00\u8d77\u88ab\u8f93\u5165\u65e0\u8ff9\u5361\u5c14\u66fc\u6ee4\u6ce2\u5668 (UKF) \u4ee5\u83b7\u5f97 150 Hz \u7684\u59ff\u6001\u4f30\u8ba1</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#system-overview","title":"System Overview","text":"<ol> <li>\u4f7f\u7528\u9884\u5148\u8bad\u7ec3\u7684\u6df1\u5ea6\u795e\u7ecf\u7f51\u7edc\uff08YOLO-V8\uff09\u6a21\u578b\u5bf9 RGB \u56fe\u50cf\u6267\u884c\u5b9e\u4f8b\u5206\u5272\u3002</li> <li>metric-semantic SLAM \u6a21\u5757\u63a5\u6536\u8fd9\u4e9b\u8f93\u5165\u5e76\u4f30\u8ba1    - \u7528\u4e8e\u91c7\u6837\u63a2\u7d22 viewpoint \u7684 global voxel map    - \u7528\u4e8e\u8f68\u8ff9\u89c4\u5212\u7684 local voxel map    - \u4f18\u5316\u7684\u673a\u5668\u4eba\u59ff\u6001\u4f30\u8ba1    - \u5305\u542b object landmark \u7684\u8bed\u4e49\u56fe\u4ee5\u751f\u6210 SLC \u5019\u9009\u3002</li> <li>\u57fa\u4e8e COP \u7684\u63a2\u7d22\u89c4\u5212\u7b97\u6cd5\u63a5\u6536\u63a2\u7d22 viewpoint \u5e76\u89c4\u5212\u4e00\u6761\u7531\u4e00\u7cfb\u5217 viewpoint \u7ec4\u6210\u7684\u957f\u89c6\u91ce\u63a2\u7d22\u8def\u5f84 (a)\uff0c\u5176\u76ee\u7684\u662f\u5728\u7ed9\u5b9a\u65c5\u884c\u9884\u7b97\u7684\u60c5\u51b5\u4e0b\u6700\u5927\u5316\u4fe1\u606f\u589e\u76ca (IG)\u3002</li> <li>\u7136\u540e\u901a\u8fc7\u63d2\u5165 SLC viewpoint \u6765\u5b8c\u5584\u8be5\u63a2\u7d22\u8def\u5f84\uff0c\u4ee5\u4fbf\u673a\u5668\u4eba\u53ef\u4ee5\u5728\u63a2\u7d22\u4e0e\u51cf\u5c11\u4e0d\u786e\u5b9a\u6027\u4e4b\u95f4\u8fdb\u884c\u6743\u8861\u3002\u7ec6\u5316\u8def\u5f84 (b) \u7528\u4e8e\u751f\u6210\u4f4e\u7ea7\u8f68\u8ff9\u89c4\u5212\u7b97\u6cd5\u7684\u76ee\u6807\uff0c\u8be5\u7b97\u6cd5\u4e0d\u65ad\u5730\u5728\u5c40\u90e8\u4f53\u7d20\u56fe\u4e2d\u91cd\u65b0\u89c4\u5212\u52a8\u6001\u53ef\u884c\u7684 3D \u8f68\u8ff9 \u00a9</li> </ol>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#metric-semantic-slam","title":"Metric-Semantic SLAM","text":"<p>\u57fa\u672c\u6d41\u7a0b\uff1a</p> <ol> <li> <p>\u5feb\u901f\u4f4d\u59ff\u4f30\u8ba1 (VIO)    \u7cfb\u7edf\u5c06\u6df1\u5ea6\u56fe\u50cf\u548c IMU \u6570\u636e\u8f93\u5165\u5230\u89c6\u89c9\u60ef\u6027\u91cc\u7a0b\u8ba1 (VIO) \u7b97\u6cd5\u4e2d\u3002VIO \u4f1a\u5feb\u901f\u4f30\u7b97\u51fa\u673a\u5668\u4eba\u5f53\u524d\u65f6\u523b\u7684\u4f4d\u59ff\uff08\u4f4d\u7f6e\u548c\u59ff\u6001\uff09\u3002\u8fd9\u4e2a\u4f30\u8ba1\u901f\u5ea6\u5feb\uff0c\u4f46\u5728\u957f\u65f6\u95f4\u8fd0\u884c\u65f6\u4f1a\u4ea7\u751f\u7d2f\u79ef\u8bef\u5dee\uff08\u6f02\u79fb\uff09\u3002</p> </li> <li> <p>\u66f4\u65b0\u9ad8\u5206\u8fa8\u7387\u5c40\u90e8\u5730\u56fe    \u4f7f\u7528 VIO \u63d0\u4f9b\u7684\u5b9e\u65f6\u4f4d\u59ff\uff0c\u7cfb\u7edf\u901a\u8fc7\u5c04\u7ebf\u6295\u5c04 (Ray-casting) \u7684\u65b9\u5f0f\uff0c\u5c06\u6df1\u5ea6\u76f8\u673a\u7684\u6700\u65b0\u8bfb\u6570\u66f4\u65b0\u5230\u4ee5\u673a\u5668\u4eba\u4e3a\u4e2d\u5fc3\u7684\u9ad8\u5206\u8fa8\u7387\u5c40\u90e8\u5730\u56fe\u4e2d\u3002\u8fd9\u5f20\u5730\u56fe\u975e\u5e38\u7cbe\u7ec6\uff0c\u80fd\u6e05\u6670\u5730\u63cf\u7ed8\u51fa\u673a\u5668\u4eba\u8eab\u8fb9\u7684\u969c\u788d\u7269\u3002</p> </li> <li> <p>\u8bed\u4e49\u68c0\u6d4b\u4e0e\u5efa\u6a21</p> </li> </ol> <ul> <li>\u7cfb\u7edf\u4ece\u6df1\u5ea6\u76f8\u673a\u7684\u70b9\u4e91\u6570\u636e\u4e2d\uff0c\u8fd0\u884c\u7269\u4f53\u68c0\u6d4b\u7b97\u6cd5\u3002\u5b83\u8bc6\u522b\u51fa\u9884\u5148\u5b9a\u4e49\u597d\u7684\u7269\u4f53\u7c7b\u522b\uff0c\u6bd4\u5982\u957f\u65b9\u4f53 (Cuboid) \u548c\u5706\u67f1\u4f53 (Cylinder)\u3002</li> <li>\u4e00\u65e6\u8bc6\u522b\u6210\u529f\uff0c\u5b83\u4f1a\u4e3a\u6bcf\u4e2a\u7269\u4f53\u5efa\u7acb\u4e00\u4e2a\u7b80\u5316\u6a21\u578b\uff0c\u4f8b\u5982\u63d0\u53d6\u51fa\u957f\u65b9\u4f53\u7684\u8d28\u5fc3\u3001\u5c3a\u5bf8\uff0c\u6216\u5706\u67f1\u4f53\u7684\u5e95\u9762\u5706\u5fc3\u3001\u4e2d\u8f74\u7ebf\u548c\u534a\u5f84\u3002\u8fd9\u91cc\u662f\u63d0\u53d6\u8d28\u5fc3</li> </ul> <ol> <li>\u6570\u636e\u5173\u8054</li> </ol> <ul> <li>\u5bf9\u4e8e\u65b0\u68c0\u6d4b\u5230\u7684\u6bcf\u4e00\u4e2a\u7269\u4f53\uff0c\u7cfb\u7edf\u9700\u8981\u5224\u65ad\uff1a\u8fd9\u662f\u4e00\u4e2a\u5168\u65b0\u7684\u7269\u4f53\uff0c\u8fd8\u662f\u4e4b\u524d\u5728\u5730\u56fe\u4e0a\u8bb0\u5f55\u8fc7\u7684\u540c\u4e00\u4e2a\u7269\u4f53\uff1f</li> <li>\u5b83\u4f1a\u4f7f\u7528\u5f53\u524d\u6700\u4f73\u7684\u4f4d\u59ff\u4f30\u8ba1\uff0c\u5c06\u89c2\u6d4b\u5230\u7684\u7269\u4f53\u8f6c\u6362\u5230\u5168\u5c40\u5750\u6807\u7cfb\u4e0b\uff0c\u7136\u540e\u4e0e\u5730\u56fe\u4e2d\u5df2\u6709\u7684\u8def\u6807 (Landmarks) \u8fdb\u884c\u6700\u8fd1\u90bb\u5339\u914d\u3002      &gt; \u5339\u914d\u6210\u529f\uff0c\u5219\u52a0\u5f3a\u5bf9\u8be5\u8def\u6807\u4f4d\u7f6e\u7684\u8ba4\u77e5\uff1b\u5339\u914d\u5931\u8d25\uff0c\u5219\u5728\u5730\u56fe\u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u8def\u6807\u3002</li> </ul> <ol> <li>\u6784\u5efa\u5e76\u66f4\u65b0\u56e0\u5b50\u56fe</li> </ol> <ul> <li>\u5f53\u673a\u5668\u4eba\u79fb\u52a8\u5230\u67d0\u4e2a\u201c\u5173\u952e\u4f4d\u7f6e\u201d\uff08Key Pose\uff09\u65f6\uff0c\u7cfb\u7edf\u4f1a\u5728\u56e0\u5b50\u56fe (Factor Graph) \u8fd9\u4e2a\u201c\u8bc1\u636e\u7f51\u7edc\u201d\u4e2d\u52a0\u5165\u65b0\u7684\u4fe1\u606f\uff1a<ul> <li>\u6dfb\u52a0\u4f4d\u59ff\u8282\u70b9: \u5c06\u673a\u5668\u4eba\u5f53\u524d\u7684\u5173\u952e\u4f4d\u59ff\u4f5c\u4e3a\u4e00\u4e2a\u65b0\u53d8\u91cf\u52a0\u5165\u56fe\u4e2d\u3002</li> <li>\u6dfb\u52a0\u91cc\u7a0b\u8ba1\u56e0\u5b50: \u6839\u636e VIO\uff0c\u5728\u65b0\u7684\u4f4d\u59ff\u8282\u70b9\u548c\u4e0a\u4e00\u4e2a\u4f4d\u59ff\u8282\u70b9\u4e4b\u5efa\u7acb\u8fde\u63a5\uff0c\u8868\u793a\u201c\u6211\u4ece A \u70b9\u79fb\u52a8\u5230\u4e86 B \u70b9\u201d\u3002</li> <li>\u6dfb\u52a0\u8bed\u4e49\u56e0\u5b50: \u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u6210\u529f\u5173\u8054\u7684\u7269\u4f53\uff0c\u5728\u4ee3\u8868\u673a\u5668\u4eba\u5f53\u524d\u4f4d\u59ff\u7684\u8282\u70b9\u548c\u4ee3\u8868\u8be5\u7269\u4f53\u7684\u8def\u6807\u8282\u70b9\u4e4b\u95f4\uff0c\u5efa\u7acb\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u5f62\u72b6\u7ea6\u675f\uff08\u957f\u65b9\u4f53\u6216\u5706\u67f1\u4f53\u56e0\u5b50\uff09\u3002\u8fd9\u4e2a\u7ea6\u675f\u8868\u793a\u201c\u6211\u5728 B \u70b9\uff0c\u4ece\u8fd9\u4e2a\u89d2\u5ea6\u770b\u5230\u4e86\u90a3\u4e2a\u7269\u4f53\u201d\u3002</li> </ul> </li> </ul> <ol> <li>\u5168\u5c40\u4f18\u5316    \u5468\u671f\u6027\u5730\uff08\u6216\u5f53\u68c0\u6d4b\u5230\u56de\u73af\u7b49\u91cd\u8981\u4e8b\u4ef6\u65f6\uff09\uff0c\u7cfb\u7edf\u4f1a\u542f\u52a8 GTSAM \u4f18\u5316\u5668\u3002\u4f18\u5316\u5668\u4f1a\u5ba1\u89c6\u6574\u4e2a\u56e0\u5b50\u56fe\u4e2d\u7684\u6240\u6709\u8bc1\u636e\uff08\u5305\u62ec\u673a\u5668\u4eba\u5168\u90e8\u7684\u5386\u53f2\u4f4d\u59ff\u548c\u6240\u6709\u7684\u7269\u4f53\u89c2\u6d4b\uff09\uff0c</li> </ol> <p>\u57fa\u4e8e\u56e0\u5b50\u56fe\u7684\u4f18\u5316\u65b9\u6cd5\uff1a\u4e3b\u8981\u601d\u60f3\u662f\u5b9a\u4e49\u4e00\u4e2a\u4f3c\u7136\u51fd\u6570\u3002\u8fd9\u4e2a\u51fd\u6570\u4ece\u6570\u5b66\u4e0a\u63cf\u8ff0\u4e86\u5728\u5f53\u524d\u5730\u56fe\u3002\u548c\u673a\u5668\u4eba\u59ff\u6001\u4e0b\uff0c\u6211\u4eec\u5bf9\u65b0\u6d4b\u91cf\u7684\u201c\u60ca\u8bb6\u7a0b\u5ea6\u201d\u3002SLAM \u7cfb\u7edf\u7684\u76ee\u6807\u662f\u8c03\u6574\u5730\u56fe\u548c\u59ff\u6001\uff0c\u4ee5\u6700\u5c0f\u5316\u6240\u6709\u6d4b\u91cf\u4e2d\u7684\u8fd9\u79cd\u8bef\u5dee\u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#chanllenges-in-slam","title":"Chanllenges in SLAM","text":"<ul> <li>\u68c0\u6d4b\u56de\u73af: \u5728\u4e8e\u5bf9\u9f50\u4e24\u4e2a\u53ea\u6709\u90e8\u5206\u91cd\u53e0\u7684\u5730\u56fe\u3002\u5982\u679c\u8fd9\u4e24\u5f20\u5730\u56fe\u662f\u4ee5\u7a20\u5bc6\u70b9\u4e91\u7684\u5f62\u5f0f\u7f16\u7801\u7684\uff0c\u90a3\u4e48\u8fd9\u4e2a\u95ee\u9898\u5728\u8ba1\u7b97\u4e0a\u4f1a\u975e\u5e38\u56f0\u96be\u3002</li> <li>\u73b0\u6709\u7684\u6d41\u884c\u65b9\u6cd5\u8981\u4e48\u662f\u5728\u4f30\u8ba1\u6570\u636e\u5173\u8054\u548c\u6267\u884c\u70b9\u4e91\u5bf9\u9f50\u4e4b\u95f4\u8fdb\u884c\u8fed\u4ee3\uff0c\u8981\u4e48\u662f\u6c42\u89e3\u8be5\u95ee\u9898\u7684\u51f8\u677e\u5f1b\u5f62\u5f0f\u3002</li> <li>\u7136\u800c\uff0c\u8fd9\u4e9b\u65b9\u6cd5\u8981\u4e48\u5bb9\u6613\u9677\u5165\u6b21\u4f18\u7684\u5c40\u90e8\u6700\u5c0f\u503c\uff0c\u8981\u4e48\u9700\u8981\u5927\u91cf\u7684\u8ba1\u7b97\u8d44\u6e90\u3002\u6b64\u5916\uff0c\u7531\u4e8e\u89c6\u89d2\u7684\u6539\u53d8\uff0c\u5b83\u4eec\u4e5f\u53ef\u80fd\u65e0\u6cd5\u627e\u5230\u5339\u914d\u3002</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#hierarchical-volumetric-mapping","title":"Hierarchical Volumetric Mapping","text":"<p>Hierarchical Volumetric Mapping \u6a21\u5757\u7ef4\u62a4\u4e24\u4e2a\u5177\u6709\u4e0d\u540c\u5206\u8fa8\u7387\u7684\u5730\u56fe\uff1a\u4f4e\u5206\u8fa8\u7387\uff08\u4ee5 \\(f\\_{gr}\\)\uff09global map \u548c\u9ad8\u5206\u8fa8\u7387\uff08\\(f\\_{lr}\\)\uff09\u81ea\u4e2d\u5fc3\u7684 local map\u3002\u524d\u8005\u7528\u4e8e\u8fb9\u754c\u68c0\u6d4b\u3001\u89c6\u70b9\u91c7\u6837\u548c\u57fa\u4e8e COP \u7684\u63a2\u7d22\u89c4\u5212\uff0c\u5176\u5927\u5c0f\u4e0d\u5c0f\u4e8e\u5b9e\u9a8c\u533a\u57df\u3002\u540e\u8005\u7528\u4e8e\u89c4\u5212\u5b89\u5168\u7684\u5c40\u90e8\u8f68\u8ff9\uff0c\u5e76\u4e14\u5177\u6709\u8f83\u5c0f\u7684\u5c3a\u5bf8\uff08\\(f\\_{lx}\u00d7f\\_{ly}\u00d7f\\_{lz}\\)\uff09\u3002</p> <ul> <li>\u5982\u4f55\u5efa\u56fe\uff1a\u5f53\u673a\u5668\u4eba\u63a5\u6536\u5230\u59ff\u6001\u4fe1\u606f\u548c\u6df1\u5ea6\u56fe\u50cf\u65f6\uff0c\u4f1a\u8fdb\u884c\u5c04\u7ebf\u6295\u5c04\uff0c\u5c06\u6df1\u5ea6\u56fe\u50cf\u7684\u8bfb\u6570\u6295\u5f71\u5230 3D \u7a7a\u95f4\u4e2d\uff0c\u7136\u540e\u5bf9\u6240\u6709\u88ab\u5c04\u7ebf\u7a7f\u8fc7\u7684\u4f53\u7d20\uff08voxels\uff09\u7684\u5360\u636e\u6982\u7387\u8fdb\u884c\u57fa\u4e8e\u5bf9\u6570\u51e0\u7387 (log-odds) \u7684\u66f4\u65b0\u3002 <p>\u5b9e\u9645\u4e0a voxel map \u662f\u4e00\u4e2a\u7a00\u758f\u7684\u4e09\u7ef4\u7f51\u683c\uff0c\u6bcf\u4e2a\u4f53\u7d20\u5b58\u50a8\u4e00\u4e2a\u5360\u636e\u6982\u7387\u503c\uff0c\u8868\u793a\u8be5\u4f53\u7d20\u88ab\u969c\u788d\u7269\u5360\u636e\u7684\u53ef\u80fd\u6027\u3002</p> </li> <li>\u5982\u4f55\u66f4\u65b0\uff1a\u4e24\u5f20\u5730\u56fe\u5f02\u6b65\u66f4\u65b0</li> <li>\u5168\u5c40\u5730\u56fe\u4f7f\u7528\u6765\u81ea metric-semantic SLAM \u6a21\u5757\u7684\u4f18\u5316\u4f4d\u59ff\u8fdb\u884c\u66f4\u65b0</li> <li>\u800c\u5c40\u90e8\u5730\u56fe\u5219\u4f7f\u7528\u6765\u81ea VIO \u7b97\u6cd5\u7684\u4f30\u8ba1\u4f4d\u59ff\u8fdb\u884c\u66f4\u65b0\u3002</li> <li>\u6bcf\u6b21\u5730\u56fe\u66f4\u65b0\u540e\uff0c\u4e00\u4e2a\u5305\u56f4\u5168\u5c40\u5730\u56fe\u4e2d\u5df2\u66f4\u65b0\u533a\u57df\u7684\u8fb9\u754c\u6846 (bounding box) \u4f1a\u88ab\u8bb0\u5f55\u4e0b\u6765\uff0c\u5e76\u7528\u4e8e\u540e\u7eed\u7684\u524d\u6cbf\u68c0\u6d4b\u3002</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#semantic-slam","title":"Semantic SLAM","text":"<ul> <li>\u8bed\u4e49\u5efa\u6a21\uff1a\u5c06\u7269\u4f53\u7b80\u5316\u6210\u8d28\u5fc3</li> <li>\u81ea\u5b9a\u4e49\u56e0\u5b50\uff1a</li> <li>\u4e24\u4e2a\u8fde\u7eed\u5173\u952e\u4f4d\u59ff\u4e4b\u95f4\u7684\u76f8\u5bf9\u53d8\u6362\u4f5c\u4e3a\u91cc\u7a0b\u8ba1\u56e0\u5b50</li> <li>\u68c0\u6d4b\u5230\u7684\u7269\u4f53\u7684\u4f30\u8ba1\u8d28\u5fc3\u4f4d\u7f6e\u4f5c\u4e3a\u8ddd\u79bb\u548c\u65b9\u4f4d\u89d2\u56e0\u5b50</li> <li>\u7531\u4e8e\u8bed\u4e49\u5730\u56fe\u7684\u7a00\u758f\u6027\uff0c\u6211\u4eec\u7684\u56e0\u5b50\u56fe\u4f1a\u5728\u673a\u5668\u4eba\u7684\u6574\u4e2a\u4efb\u52a1\u671f\u95f4\u6301\u7eed\u8ddf\u8e2a\u5386\u53f2\u6d4b\u91cf\u6570\u636e\uff0c\u5e76\u4ee5\u5168\u5c40\u4e00\u81f4\u7684\u65b9\u5f0f\u4f18\u5316\u673a\u5668\u4eba\u4f4d\u59ff\u548c\u7269\u4f53\u8def\u6807\u70b9\u3002</li> </ul> <p>\u6574\u4e2a\u7cfb\u7edf\u5efa\u7acb\u5728 GTSAM \u4e4b\u4e0a\uff0c\u8fd9\u662f\u4e00\u4e2a\u6d41\u884c\u7684 C++\u5e93\uff0c\u7528\u4e8e\u89e3\u51b3\u4f18\u5316\u95ee\u9898</p> <p></p>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#semantic-loop-closure-slc","title":"Semantic Loop Closure (SLC)","text":"<ul> <li>Input: \u5df2\u63a2\u7d22 map \u4ee5\u53ca\u5f53\u524d\u4f4d\u7f6e\u7684 map</li> <li>\u53ea\u5bf9\u9f50\u68c0\u6d4b\u5230\u7684 Object\uff0c\u800c\u4e0d\u662f\u5bf9\u9f50\u7a20\u5bc6\u70b9\u4e91\uff0c\u8fd9\u662f\u4e00\u4e2a\u57fa\u4e8e\u641c\u7d22\u7684\u8fc7\u7a0b\uff0c\u5b83\u901a\u8fc7\u6309\u57fa\u6570\u9012\u51cf\u7684\u987a\u5e8f\u904d\u5386 A(\u5df2\u63a2\u7d22 map \u4e2d\u7684 objects) \u548c B(\"local\" map \u4e2d\u7684 objects) \u53d8\u4f53\u7684\u7b1b\u5361\u5c14\u79ef\uff0c\u5e76\u5b58\u50a8\u5339\u914d\u8d28\u91cf\u5c3d\u53ef\u80fd\u9ad8\u7684\u914d\u5bf9</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#exploration-with-active-slc","title":"Exploration with Active SLC","text":"<p>\u57fa\u672c\u6d41\u7a0b\uff1a</p> <ol> <li>Frontier Detection</li> </ol> <ul> <li>\u4f7f\u7528\u5168\u5c40 voxel map \u6765\u68c0\u6d4b\u524d\u6cbf (Frontiers)\uff0c\u5373\u673a\u5668\u4eba\u5df2\u63a2\u7d22\u533a\u57df\u4e0e\u672a\u77e5\u533a\u57df\u4e4b\u95f4\u7684\u8fb9\u754c\u3002</li> <li>\u901a\u8fc7\u68c0\u67e5\u6bcf\u4e2a\u4f53\u7d20\u7684\u90bb\u5c45\u72b6\u6001\uff0c\u8bc6\u522b\u51fa\u90a3\u4e9b\u4e0e\u672a\u77e5\u533a\u57df\u76f8\u90bb\u7684\u5df2\u77e5\u4f53\u7d20\uff0c\u5e76\u5c06\u5176\u6807\u8bb0\u4e3a\u524d\u6cbf\u3002</li> </ul> <ol> <li>Viewpoint Sampling</li> </ol> <ul> <li>\u5728\u524d\u6cbf\u533a\u57df\uff0c\u7cfb\u7edf\u4f1a\u865a\u62df\u5730\u91c7\u6837\u4e00\u7cfb\u5217\u5019\u9009\u7684\u201c\u6700\u4f73\u89c2\u6d4b\u70b9\u201d\u3002</li> <li>\u7cfb\u7edf\u4f1a\u8bc4\u4f30\u4ece\u6bcf\u4e2a\u5019\u9009\u70b9\u51fa\u53d1\uff0c\u9884\u671f\u80fd\u89c2\u6d4b\u5230\u591a\u5c11\u65b0\u7684\u672a\u77e5\u533a\u57df</li> </ul> <ol> <li>Exploration Path Planning</li> </ol> <ul> <li> <p>\u673a\u5668\u4eba\u4f7f\u7528\u4e00\u4e2a\u9ad8\u7ea7\u89c4\u5212\u7b97\u6cd5\uff08\u6587\u4e2d\u63d0\u5230\u4e86 COP-based planning\uff09\uff0c\u4ece\u6240\u6709\u5019\u9009\u70b9\u4e2d\u9009\u51fa\u6700\u4f18\u7684\u4e0b\u4e00\u4e2a\u76ee\u6807\u70b9\u3002</p> </li> <li> <p>\u51b3\u7b56\u7684\u4f9d\u636e\u901a\u5e38\u5305\u62ec\uff1a\u4fe1\u606f\u589e\u76ca\u6700\u5927\u5316\uff08\u80fd\u770b\u5230\u6700\u591a\u7684\u65b0\u5730\u65b9\uff09\u3001\u79fb\u52a8\u6210\u672c\u6700\u5c0f\u5316\uff08\u8def\u7a0b\u6700\u77ed\u3001\u6700\u5b89\u5168\uff09\u3001\u4efb\u52a1\u76ee\u6807\u7b49\u3002\u3002</p> </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#frontier-detection-and-exploration-viewpoint-sampling","title":"Frontier Detection and Exploration Viewpoint Sampling","text":"<ul> <li> <p>\u4f7f\u7528\u589e\u91cf\u5f0f\u524d\u6cbf\u68c0\u6d4b\u548c\u89c6\u70b9\u91c7\u6837\u6a21\u5757\u3002\u5730\u56fe\u66f4\u65b0\u540e\uff0c\u8fb9\u754c\u6846\uff08bounding box\uff09\u5185\u6240\u6709\u73b0\u5b58\u7684\u201c\u524d\u6cbf\u201d\u90fd\u4f1a\u88ab\u91cd\u65b0\u8bc4\u4f30</p> </li> <li> <p>\u5982\u679c\u5df2\u88ab\u89c2\u6d4b\u5230\u5219\u5c06\u5176\u79fb\u9664\u3002</p> </li> <li> <p>\u65b0\u7684\u524d\u6cbf\u4f1a\u88ab\u68c0\u6d4b\u51fa\u6765\u5e76\u8fdb\u884c\u805a\u7c7b\u3002\u5982\u679c\u4e00\u4e2a\u201c\u524d\u6cbf\u7c07\u201d\u5927\u4e8e\u671f\u671b\u7684\u5c3a\u5bf8\uff0c\u5b83\u4f1a\u88ab\u9012\u5f52\u5730\u5206\u89e3\u6210\u66f4\u5c0f\u7684\u7c07\uff0c\u4ee5\u4fbf\u673a\u5668\u4eba\u80fd\u7528\u5176\u6709\u9650\u7684\u4f20\u611f\u8303\u56f4\u548c\u89c6\u573a\u89d2\u8986\u76d6\u5b83\u3002</p> </li> <li> <p>\u9488\u5bf9\u6bcf\u4e2a\u524d\u6cbf\u7c07\uff0c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u4e00\u4e2a\u4e24\u6b65\u8fc7\u7a0b\u6765\u91c7\u6837\u4e09\u7ef4\u89c6\u70b9\u3002</p> </li> <li> <p>\u5728\u7c07\u7684\u8d28\u5fc3\u5468\u56f4\u5747\u5300\u5730\u91c7\u6837\u5019\u9009\u4f4d\u7f6e</p> </li> <li>\u5728\u6bcf\u4e2a\u5019\u9009\u4f4d\u7f6e\u4e0a\u5747\u5300\u5730\u91c7\u6837\u591a\u4e2a\u504f\u822a\u89d2</li> <li>\u7cfb\u7edf\u4f1a\u4e3a\u6240\u6709\u91c7\u6837\u7684\u504f\u822a\u89d2\u4f30\u8ba1\u57fa\u4e8e \u201c\u5355\u5143\u683c\u8ba1\u6570\u201d\u7684\u4fe1\u606f\u589e\u76ca(IG)\uff0c\u800c\u65e0\u9700\u8fdb\u884c\u4fe1\u606f\u9884\u6d4b\u3002\u5176\u4e2d\uff0c\u5177\u6709\u6700\u5927\u4f30\u8ba1 IG \u7684\u5019\u9009\u504f\u822a\u89d2\u88ab\u9009\u4e3a\u8be5\u4f4d\u7f6e\u7684\u6700\u7ec8\u91c7\u6837\u504f\u822a\u89d2\u3002</li> <li>\u6700\u7ec8\uff0c\u6211\u4eec\u5c06\u6240\u6709\u91c7\u6837\u59ff\u6001\u4e2d\u5177\u6709\u6700\u9ad8\u4f30\u8ba1 IG \u7684\u90a3\u4e2a\u4f5c\u4e3a\u8be5\u524d\u6cbf\u7c07\u7684\u6700\u7ec8 view point\uff0c\u5373\u4e0b\u4e00\u4e2a\u76ee\u6807\u70b9</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#cop-based-exploration-planning","title":"COP-based Exploration Planning","text":"<ul> <li> <p>\u4e0e\u5176\u4ed6\u7ec4\u4ef6\u5f02\u6b65\u6267\u884c\uff0c\u673a\u5668\u4eba\u4f1a\u7ee7\u7eed\u6267\u884c\u5f53\u524d\u7684\u7cbe\u5316\u8def\u5f84\uff0c\u76f4\u5230\u6536\u5230\u4e00\u6761\u65b0\u7684\u7cbe\u5316\u8def\u5f84\u4e3a\u6b62</p> </li> <li> <p>COP \u5728\u4e00\u4e2a\u7ed9\u5b9a\u7684\u5b8c\u5168\u56fe ( G = (V, E) ) \u4e0a\u8fd0\u884c\uff0c\u5176\u4e2d ( V ) \u662f\u9876\u70b9\u96c6\uff0c( E ) \u662f\u8fb9\u96c6\u3002 \u6bcf\u4e2a\u9876\u70b9 ( v \\in V ) \u90fd\u6709\u4e00\u4e2a\u4e0e\u4e4b\u5173\u8054\u7684\u5956\u52b1 ( rv \\ge 0 )\uff0c\u6bcf\u6761\u8fb9 ( (i, j) \\in E ) \u90fd\u6709\u4e00\u4e2a\u65c5\u884c\u6210\u672c ( c )\u3002} \\ge 0 )\u3002 \u8fb9\u7684\u6210\u672c\u662f\u5bf9\u79f0\u7684\uff0c\u5373 ( c*{ij} = c*{ji</p> </li> <li> <p>\u9876\u70b9\u4ee3\u8868\u91c7\u6837\u7684\u89c6\u70b9\uff08viewpoint\uff09\uff1b</p> </li> <li> <p>\u8fb9\u4ee3\u8868\u89c6\u70b9\u4e4b\u95f4\u7684\u6700\u4f18\u8def\u5f84\uff08optimal path\uff09\uff1b</p> </li> <li> <p>\u9876\u70b9 ( v ) \u7684\u5956\u52b1 ( r_v ) \u662f\u5728\u8be5\u89c6\u70b9\u7684\u4fe1\u606f\u589e\u76ca\uff08Information Gain, IG\uff09\uff1b</p> </li> <li> <p>\u8fb9\u7684\u6210\u672c\u901a\u8fc7 A* \u7b97\u6cd5\u8ba1\u7b97\u5f97\u5230\u3002</p> </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#_1","title":"\u76f8\u5173\u51fd\u6570\u5b9a\u4e49","text":"<ul> <li>\u76f8\u5173\u6027\uff1a\u5bf9\u4e8e\u6bcf\u5bf9\u9876\u70b9 ( u, v \\in V )\uff0c\u5b9a\u4e49\u76f8\u5173\u51fd\u6570 ( w(u,v) \\in [0,1] )\uff0c\u8ba1\u7b97\u4e24\u4e2a\u89c6\u70b9\u5728\u65e0\u906e\u6321\u5047\u8bbe\u4e0b\u7684\u89c6\u91ce\u91cd\u53e0\u767e\u5206\u6bd4\u6765\u83b7\u5f97\u76f8\u5173\u6027\u3002\\   \u76f8\u5173\u51fd\u6570\u662f\u5bf9\u79f0\u7684\uff0c\u5373\uff1a   $$   w(u,v) = w(v,u)   $$</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#cop","title":"COP \u4f18\u5316\u76ee\u6807","text":"<ul> <li>COP \u7684\u76ee\u6807\u662f\u5728\u6ee1\u8db3\u603b\u65c5\u884c\u6210\u672c\u9884\u7b97 ( B ) \u7684\u524d\u63d0\u4e0b\uff0c \u627e\u5230\u4e00\u6761\u8bbf\u95ee\u90e8\u5206\u9876\u70b9\u7684\u6e38\u89c8\u8def\u5f84\uff08tour\uff09 ( \\pi )\uff0c \u4f7f\u5f97\u6536\u96c6\u5230\u7684\u603b\u5956\u52b1\u6700\u5927\u5316\u3002</li> </ul> <p>\u8bbe\uff1a</p> <ul> <li>( x_v \\in {0,1} )\uff1a\u9876\u70b9 ( v ) \u662f\u5426\u88ab\u8bbf\u95ee\uff1b</li> <li>( y_{ij} \\in {0,1} )\uff1a\u8fb9 ( (i,j) ) \u662f\u5426\u5728\u6e38\u89c8\u8def\u5f84\u4e2d\u4ece\u9876\u70b9 ( i ) \u8d70\u5411\u9876\u70b9 ( j )\u3002</li> </ul> <p>\u5219\u76ee\u6807\u51fd\u6570\u4e3a\uff1a\u76f4\u63a5\u8bbf\u95ee\u5f97\u5230\u7684\u5956\u52b1\u52a0\u4e0a\u901a\u8fc7\u76f8\u5173\u6027\u95f4\u63a5\u83b7\u5f97\u7684\u5956\u52b1</p> \\[ R(\\\\pi) = \\\\sum\\_{v \\\\in V} r_v (x_v + \\\\omega_v (1 - x_v)) \\\\tag{7} \\]","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#_2","title":"\u7ea6\u675f\u6761\u4ef6","text":"<p>\u76f8\u5173\u6027\u7ea6\u675f\uff1a</p> \\[ \\\\omega\\_{v} - \\\\sum\\_{u \\\\in V \\\\setminus {v}} w(u,v) x_u \\\\le 0 \\\\tag{8} \\] <p>\u5176\u4e2d\uff0c\u53d8\u91cf ( \\omega_v ) \u6a21\u62df\u4e86\u9664\u9876\u70b9 ( v ) \u81ea\u8eab\u5916\uff0c\u7531\u5176\u4ed6\u9876\u70b9\u6536\u96c6\u5230\u7684\u90a3\u90e8\u5206\u5956\u52b1 ( r_v )\u3002\\ \u7531\u4e8e ( \\omega_v ) \u5904\u4e8e\u6700\u5927\u5316\u76ee\u6807\u4e2d\uff0c\u5b83\u7684\u503c\u603b\u662f\u4e3a 1 \u6216\u76f8\u5173\u6027\u603b\u548c\u7684\u8f83\u5c0f\u8005\u3002</p> <p>\u9884\u7b97\u7ea6\u675f\uff1a</p> \\[ \\\\sum\\_{(i,j) \\\\in E} (c\\_{ij} y\\_{ij} + c\\_{ji} y\\_{ji}) \\\\le B \\\\tag{9} \\] <p>\u8be5\u7ea6\u675f\u9650\u5236\u4e86\u6e38\u89c8\u8def\u5f84\u7684\u603b\u65c5\u884c\u6210\u672c\u3002</p> <p>\u5728\u5b9e\u73b0\u4e2d\uff0c\u9884\u7b97 ( B ) \u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u542f\u53d1\u5f0f\u8bbe\u5b9a\uff1a</p> <ul> <li>\u4f30\u7b97\u673a\u5668\u4eba\u5f53\u524d\u4f4d\u7f6e\u5230\u82e5\u5e72\u9644\u8fd1\u524d\u6cbf\uff08frontiers\uff09\u7684\u6210\u672c\uff0c\u5e76\u4e58\u4ee5\u4e00\u4e2a\u5e38\u6570\u56e0\u5b50\uff0c \u4ee5\u9650\u5236\u6e38\u89c8\u8def\u5f84\u957f\u5ea6\u5e76\u964d\u4f4e\u8ba1\u7b97\u590d\u6742\u6027\u3002</li> </ul> <p>\u8def\u5f84\u7ea6\u675f\uff1a</p> <p>$ y_{ij}, y_{ji} \\in {0,1}, \\quad \\forall (i,j) \\in E $ $ \\omega_v \\in [0,1], \\quad x_v \\in {0,1}, \\quad \\forall v \\in V $</p> <ul> <li>\u6e38\u89c8\u8def\u5f84\u7ea6\u675f\u786e\u4fdd\u8def\u5f84\u4e2d\u6ca1\u6709\u4e0d\u76f8\u8fde\u7684\u5b50\u8def\u5f84\uff0c</li> <li>\u81f3\u5c11\u6709\u4e00\u6761\u8fde\u63a5\u5230\u88ab\u8bbf\u95ee\u9876\u70b9\u7684\u8fb9\u88ab\u904d\u5386\u3002</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#_3","title":"\u7b97\u6cd5\u590d\u6742\u5ea6\u4e0e\u5b9e\u73b0","text":"<p>COP \u662f\u4e00\u4e2a NP-hard \u95ee\u9898\uff0c\u5176 MIQP\uff08Mixed Integer Quadratic Programming\uff09 \u5f62\u5f0f\u4e0d\u9002\u7528\u4e8e\u63a2\u7d22\u4efb\u52a1\u4e2d\u7684\u5728\u7ebf\u8ba1\u7b97\u3002\u56e0\u6b64\uff0cthis work \u91c7\u7528\u4e86\u4e2d\u63d0\u51fa\u7684\u8d2a\u5a6a\u6784\u5efa\u542f\u53d1\u5f0f\u7b97\u6cd5\uff08Greedy Construction Heuristic\uff09 \u7684\u7b80\u5316\u7248\u672c\u3002</p> <p>\u7b97\u6cd5\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u4ece\u4e00\u6761\u7a7a\u8def\u5f84\u5f00\u59cb\uff1b</li> <li>\u8d2a\u5a6a\u5730\u9009\u62e9\u8981\u6dfb\u52a0\u7684\u9876\u70b9\uff1b</li> <li>\u57fa\u4e8e\u5df2\u9009\u9876\u70b9\u8ba1\u7b97\u9ad8\u6548\u7684\u6e38\u89c8\u8def\u5f84\uff1b</li> <li>\u91cd\u590d\u4e0a\u8ff0\u6b65\u9aa4\uff0c\u76f4\u5230\u8fdd\u53cd\u9884\u7b97\u7ea6\u675f\u3002</li> </ol> <p>\u9876\u70b9\u9009\u62e9\u7684\u8d2a\u5a6a\u6807\u51c6\u5b9a\u4e49\u4e3a\uff1a</p> \\[ \\\\text{value}(v) = r_v + \\\\sum\\_{u \\\\in V \\\\setminus S} r_u w(v,u) - \\\\sum\\_{u \\\\in S} r_u w(u,v) \\] <p>\u5176\u4e2d ( S ) \u662f\u5f53\u524d\u5df2\u9009\u62e9\u7684\u9876\u70b9\u96c6\u5408\u3002\u7b97\u6cd5\u590d\u6742\u5ea6\u4e3a ( O(|V|^3) )\u3002</p> <p>(v \u81ea\u8eab\u7684\u4ef7\u503c) + (v \u80fd\u5e26\u6765\u7684\u65b0\u89c6\u91ce\u7684\u9644\u52a0\u4ef7\u503c) - (v \u4e0e\u73b0\u6709\u8def\u5f84\u91cd\u53e0\u9020\u6210\u7684\u5197\u4f59\u6210\u672c)</p> <ul> <li>\u5728\u5b9e\u8df5\u4e2d\uff0c\u901a\u8fc7\u9009\u62e9\u5408\u9002\u7684\u524d\u6cbf\u7c07\u5927\u5c0f \\(f\\_{sz}\\)\uff0c\u53ef\u4ee5\u5c06\u73af\u5883\u4e2d\u7684\u89c6\u70b9\u6570\u91cf\u9650\u5236\u5728 10 \u4e2a\u4ee5\u4e0b</li> <li>\u8fd9\u6837\u5373\u53ef\u5728\u673a\u8f7d\u8bbe\u5907\u4e0a\u4f7f\u7528 Bellman-Held-Karp \u7b97\u6cd5 \u5b9e\u65f6\u8ba1\u7b97\u5df2\u9009\u9876\u70b9\u7684\u6700\u4f18\u6e38\u89c8\u8def\u5f84\u3002</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#_4","title":"\u52a8\u6001\u91cd\u89c4\u5212\u673a\u5236","text":"<p>\u5982\u679c\u6ee1\u8db3\u4ee5\u4e0b\u4efb\u4e00\u6761\u4ef6\uff0c\u63a2\u7d22\u6e38\u89c8\u8def\u5f84\u5c06\u88ab\u91cd\u65b0\u89c4\u5212\uff1a</p> <ol> <li>\u5f53\u524d\u73af\u5883\u4e2d\u4e00\u5c0f\u90e8\u5206 ($f_{r1}) \u7684\u524d\u6cbf\u53d1\u751f\u53d8\u5316\uff1b</li> <li>\u5df2\u6267\u884c\u7684\u7cbe\u5316\u63a2\u7d22\u6e38\u89c8\u8def\u5f84\u7684\u6bd4\u4f8b\u8d85\u8fc7\u7ed9\u5b9a\u9608\u503c ($f_{r2})</li> </ol> <p>\u7b2c\u4e8c\u4e2a\u6761\u4ef6\u4e5f\u79f0\u4e3a \u6eda\u52a8\u65f6\u57df\u89c4\u5212\uff08Receding-Horizon Planning\uff09\u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#active-semantic-loop-closure","title":"Active Semantic Loop Closure","text":"<ul> <li>\u5728\u673a\u5668\u4eba\u6784\u5efa metric-semantic \u5730\u56fe\u7684\u540c\u65f6\uff0c\u5b83\u9700\u8981\u751f\u6210\u5019\u9009\u7684 SLC \u5b50\u56fe\u548c viewpoint \u914d\u5bf9\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u9996\u5148\u901a\u8fc7\u805a\u7c7b\u8bed\u4e49\u8def\u6807\u6765\u627e\u5230\u5b50\u56fe\uff0c\u7136\u540e\u518d\u9009\u62e9\u76f8\u5e94\u7684 viewpoint\u3002</li> </ul> <ol> <li>\u6211\u4eec\u4f7f\u7528 DBSCAN \u7b97\u6cd5\u5728\u6b27\u51e0\u91cc\u5f97\u7a7a\u95f4\u4e2d\u5bf9\u8bed\u4e49\u8def\u6807\u7684\u8d28\u5fc3\u8fdb\u884c\u805a\u7c7b\u3002</li> </ol> <p>\u8bf7\u6ce8\u610f\uff0c\u7531\u4e8e\u6211\u4eec\u4ece\u6bcf\u4e2a\u8def\u6807\u83b7\u5f97\u7684\u6d4b\u91cf\u662f\u8ddd\u79bb\u548c\u65b9\u4f4d\u89d2\uff0c\u5e76\u4e14\u6570\u636e\u5173\u8054\u662f\u5148\u9a8c\u672a\u77e5\u7684\uff0c\u6211\u4eec\u81f3\u5c11\u9700\u8981\u4e09\u4e2a\u8def\u6807\u624d\u80fd\u5728\u56de\u73af\u95ed\u5408\u65f6\u552f\u4e00\u5730\u786e\u5b9a\u673a\u5668\u4eba\u7684\u4f4d\u7f6e\u548c\u504f\u822a\u89d2\uff0c\u8fd9\u5728\u6211\u4eec\u4e4b\u524d\u7684\u5de5\u4f5c\u4e2d\u6709\u8be6\u7ec6\u89e3\u91ca\u3002</p> <ol> <li>\u5bf9\u4e8e\u6bcf\u4e2a\u5b50\u56fe\uff0c\u6211\u4eec\u9700\u8981\u751f\u6210\u4e00\u4e2a\u53ef\u5230\u8fbe\u3001\u53ef\u68c0\u6d4b\u4e14\u4fe1\u606f\u4e30\u5bcc\u7684\u89c6\u70b9\u3002</li> </ol> <ul> <li>\u53ef\u5230\u8fbe (Reachable): \u6211\u4eec\u4ece\u56e0\u5b50\u56fe\u4e2d\u7684\u5173\u952e\u4f4d\u59ff\u96c6\u5408\uff08\u673a\u5668\u4eba\u8fc7\u53bb\u66fe\u5230\u8fbe\u8fc7\u7684\u4f4d\u7f6e\uff09\u4e2d\u9009\u62e9\u89c6\u70b9\u3002</li> <li>\u53ef\u68c0\u6d4b (Detectable): \u6211\u4eec\u8fdb\u4e00\u6b65\u9650\u5236\u5173\u952e\u4f4d\u59ff\u7684\u9009\u62e9\uff0c\u8981\u6c42\u5b50\u56fe\u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u8def\u6807\u90fd\u5728\u4f20\u611f\u8303\u56f4\u4e4b\u5185\u3002</li> <li>\u4fe1\u606f\u4e30\u5bcc (Informative): \u4e3a\u4e86\u6700\u5927\u5316 SLC \u53ef\u80fd\u5e26\u6765\u7684\u4fe1\u606f\u589e\u76ca\uff0c\u7cfb\u7edf\u4f1a\u9009\u62e9\u6240\u6709\u6ee1\u8db3\u4e0a\u8ff0\u6761\u4ef6\u7684\u6700\u65e7\u7684\u5173\u952e\u4f4d\u59ff\uff08\u5373\u6700\u65e9\u88ab\u6dfb\u52a0\u5230\u56e0\u5b50\u56fe\u4e2d\u7684\u4f4d\u59ff\uff09\u4f5c\u4e3a\u89c6\u70b9\u3002<ul> <li>IG \u7684\u8ba1\u7b97\u901a\u8fc7\u63d2\u5165\u865a\u62df\u56e0\u5b50\u6765\u8fdb\u884c\u8ba1\u7b97\uff0c\u540e\u9762\u4f1a\u8c08\u5230</li> </ul> </li> </ul> <ol> <li>\u673a\u5668\u4eba\u901a\u8fc7\u5728\u8fd9\u6837\u4e00\u4e2aSLC \u89c6\u70b9\u8fdb\u884c\u5168\u666f\u626b\u63cf\uff08\u539f\u5730\u504f\u822a\u65cb\u8f6c\uff09\u6765\u5efa\u7acb\u56de\u73af\u3002</li> </ol> <p></p> <p>\u6a59\u8272\u5708\u8d77\u6765\u7684\u662f slc \u5b50\u56fe\uff0c\u7d2b\u8272\u6846\u5708\u8d77\u6765\u7684\u662f slc \u5b50\u56fe-viewpoint \u914d\u5bf9\uff0c\u7ea2\u661f\u662f slc viewpoint\uff0c\u9ed1\u8272\u7ebf\u662f cop \u9884\u6d4b\u7684\u8f68\u8ff9\uff0c\u7ea2\u8272\u7ebf\u662f active slc \u8fdb\u884c refine \u540e\u7684\u8f68\u8ff9</p> <ul> <li>SLAM \u4f1a\u7ef4\u62a4\u4e00\u4e2a\u534f\u65b9\u5dee\u77e9\u9635\uff08Covariance Matrix\uff0c\u03a3\uff09\u3002\u8fd9\u4e2a\u77e9\u9635\u4ece\u6570\u5b66\u4e0a\u8868\u793a\u4e86\u6574\u4e2a\u5730\u56fe\u4e2d\u6bcf\u4e2a\u4f30\u8ba1\u4f4d\u7f6e\u548c\u5730\u6807\u7684\u4e0d\u786e\u5b9a\u6027</li> <li>\u865a\u62df\u56e0\u5b50\u8ba1\u7b97 IG\uff1a\u5728\u8bed\u4e49\u56e0\u5b50\u56fe\u4e2d\u6dfb\u52a0\u4e00\u4e2a \u201c\u865a\u62df\u56e0\u5b50\u201d(virtual factor) \u6765\u5b9e\u73b0\u8ba1\u7b97 IG</li> <li>\u4ece\u6982\u5ff5\u4e0a\u8bb2\uff0c\u5728\u8fd9\u4e00\u6b65\u4e2d\uff0c\u6211\u4eec\u6dfb\u52a0\u4e86\u4e24\u4e2a\u56e0\u5b50\uff1a\u4e00\u4e2a\u671f\u671b\u91cc\u7a0b\u8ba1\u56e0\u5b50\u548c\u4e00\u4e2a\u671f\u671b\u56de\u73af\u56e0\u5b50\u3002\u524d\u8005\u5c06\u673a\u5668\u4eba\u5e26\u5230\u56de\u73af\u89c6\u70b9(\\(x_n\\))\u4ee5\u4fbf\u4e0e\u56fe\u4e2d\u7684\u4e00\u4e2a\u73b0\u6709\u5173\u952e\u4f4d\u59ff(\\(x_lc\\))\u5efa\u7acb SLC</li> <li>\u7531\u4e8e\u6211\u4eec\u7684\u56de\u73af\u89c6\u70b9\u662f\u4ece\u56fe\u4e2d\u7684\u73b0\u6709\u5173\u952e\u4f4d\u59ff\u4e4b\u4e00\u91c7\u6837\u5f97\u5230\u7684\uff0c\u56e0\u6b64\\(x_n\\)\u548c\\(x\\_{lc}\\)\u662f\u540c\u4e00\u4e2a\u8282\u70b9\u3002\u6240\u4ee5\uff0c\u8be5\u8fc7\u7a0b\u7b80\u5316\u4e3a\u5728\u5f53\u524d\u4f4d\u59ff\\(x_t\\)\u548c\u56de\u73af\u89c6\u70b9\\(x\\_{lc}\\)\u4e4b\u95f4\u6dfb\u52a0\u4e00\u4e2a\u671f\u671b\u91cc\u7a0b\u8ba1\u56e0\u5b50\uff0c\u5176\u8fd0\u52a8\u566a\u58f0\u6839\u636e\u9884\u671f\u7684\u65c5\u884c\u8ddd\u79bb\u8fdb\u884c\u7f29\u653e\u3002</li> <li>\u5bf9\u4e8e\u4e00\u4e2a\u957f\u65f6\u7a0b\u7684\u8def\u5f84\uff0c\u6211\u4eec\u53ef\u4ee5\u987a\u5e8f\u6267\u884c\u6b64\u7c7b\u64cd\u4f5c\uff0c\u4ee5\u8bc4\u4f30\u5177\u6709\u591a\u4e2a SLC \u7684\u4e00\u7cfb\u5217\u52a8\u4f5c\u7684 IG\u3002\u8fd9\u6a21\u62df\u4e86\u673a\u5668\u4eba\u76f4\u63a5\u5bfc\u822a\u4ee5\u5176\u5e26\u566a\u58f0\u7684\u91cc\u7a0b\u8ba1\u6d4b\u91cf\u6765\u5efa\u7acb SLC \u7684\u6548\u679c\u3002</li> <li>\u8fd9\u4e2a\u865a\u62df\u56e0\u5b50\u4fdd\u6301\u4e86\uff08\u4f4d\u59ff\u548c\u8def\u6807\u7684\uff09\u4f30\u8ba1\u503c\u4e0d\u53d8\uff0c\u4f46\u6539\u53d8\u4e86\u56e0\u5b50\u56fe\u7684\u534f\u65b9\u5dee\u77e9\u9635\u3002\u6211\u4eec\u901a\u8fc7\u8ba1\u7b97\u6dfb\u52a0\u6b64\u865a\u62df\u56e0\u5b50\u524d\u540e\u534f\u65b9\u5dee\u77e9\u9635\u7684\u8ff9 (trace) \u7684\u51cf\u5c11\u91cf\uff0c\u4f5c\u4e3a IG \u7684\u5ea6\u91cf\uff1a     $$     IG = tr(\u03a3_t) \u2212 tr(\u03a3_{t+1})     $$     \u5176\u4e2d tr \u8868\u793a\u534f\u65b9\u5dee\u77e9\u9635\u7684\u8ff9\u3002\u4e00\u65e6\u6211\u4eec\u8bc4\u4f30\u4e86\u6cbf\u7ed9\u5b9a\u8def\u5f84\u7684 IG\uff0c\u6211\u4eec\u5c31\u4f1a\u4ece\u56e0\u5b50\u56fe\u4e2d\u79fb\u9664\u8fd9\u4e9b\u865a\u62df\u56e0\u5b50\uff0c\u8fd9\u6837\u5b83\u4eec\u5c31\u4e0d\u4f1a\u6539\u53d8\u56e0\u5b50\u56fe\u7684\u4f30\u8ba1\u503c\u3002 </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#active-uncertainty-reduction-planning","title":"Active Uncertainty Reduction Planning","text":"<p>\u8be5\u7b97\u6cd5\u901a\u8fc7\u5e73\u8861\u63a2\u7d22\u7684 IG \u548c SLC \u7684\u4e0d\u786e\u5b9a\u6027\u51cf\u5c11\uff0c\u5c06 COP \u6a21\u5757\u7684\u8ba1\u5212\u63a2\u7d22\u8def\u5f84\u8f6c\u6362\u4e3a\u7ec6\u5316\u8def\u5f84</p> <ul> <li>\u5728\u6bcf\u6b21\u8fed\u4ee3\u4e2d\uff0c\u7cfb\u7edf\u4f1a\u901a\u8fc7\u4ece\u540e\u7eed\u63a2\u7d22\u89c6\u70b9\u7684 IG \u4e2d\u51cf\u53bb\u5df2\u88ab\u7cbe\u5316\u8def\u5f84\u4e2d\u89c6\u70b9\u6240\u6536\u96c6\u5230\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u6765\u8bc4\u4f30\u8be5\u89c6\u70b9\u7684\u5269\u4f59\u4fe1\u606f\u589e\u76ca\u3002</li> <li>\u7136\u540e\uff0c\u901a\u8fc7 A*\u7b97\u6cd5\u8bc4\u4f30\u6bcf\u4e2a SLC \u5019\u9009\u7684\u6210\u672c\uff0c\u5e76\u4f7f\u7528\u4e0a\u9762\u63d0\u5230\u7684\u65b9\u6cd5\u8ba1\u7b97\u5176 IG\u3002\u5982\u679c\u9884\u7b97\u5141\u8bb8\u6dfb\u52a0\u6700\u4f73\u7684 SLC \u5019\u9009\uff0c\u6211\u4eec\u4f1a\u8fdb\u4e00\u6b65\u6bd4\u8f83\u540e\u8005\u7684\u7f29\u653e\u540e IG \u4e0e\u5373\u5c06\u5230\u6765\u7684\u63a2\u7d22\u89c6\u70b9\u7684\u6548\u7528\uff08\u5373\u6027\u4ef7\u6bd4\u6307\u6570\uff09\u3002\u6bd4\u8f83\u7ed3\u679c\u51b3\u5b9a\u4e86\u662f\u5426\u5e94\u5c06\u5019\u9009 SLC \u63d2\u5165\u5230\u7cbe\u5316\u63a2\u7d22\u8def\u5f84\u4e2d\u3002</li> <li>\u6211\u4eec\u53ea\u5141\u8bb8\u5728\u4e24\u4e2a\u8fde\u7eed\u7684\u63a2\u7d22\u89c6\u70b9\u4e4b\u95f4\u63d2\u5165\u4e00\u4e2a SLC \u5019\u9009\uff0c\u8fd9\u4e5f\u9650\u5236\u4e86\u603b\u8fd0\u884c\u65f6\u95f4\u590d\u6742\u5ea6\u3002</li> </ul> <p></p>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#drift-compensation-and-trajectory-planning","title":"Drift Compensation and Trajectory Planning","text":"<ul> <li>\u7531\u4e8e SLC\uff08\u8bed\u4e49\u56de\u73af\u68c0\u6d4b\uff09\u4f1a\u5f15\u53d1\u95f4\u6b47\u6027\u7684\u6f02\u79fb\u4fee\u6b63\uff0c\u5176\u5e73\u6ed1\u6027\u53ef\u80fd\u4f1a\u53d7\u5230\u5f71\u54cd\u3002</li> </ul> <p>\u6734\u7d20\u60f3\u6cd5\uff1a\u8bed\u4e49 SLAM \u4f30\u8ba1\u7684\u65e0\u4eba\u673a\u4f4d\u59ff\u76f4\u63a5\u8f93\u5165\u7ed9\u89c4\u5212\u5668\u548c\u63a7\u5236\u5668\u3002\u7136\u800c\uff0c\u4e0e\u57fa\u4e8e\u6ee4\u6ce2\u7684 VIO \u80fd\u7ed9\u51fa\u5e73\u6ed1\u4f4d\u59ff\u4f30\u8ba1\u4e0d\u540c\uff0c\u8bed\u4e49 SLAM \u4f30\u8ba1\u7684\u4f4d\u59ff\u53ef\u80fd\u5728\u5c40\u90e8\u4e0a\u5e76\u4e0d\u5e73\u6ed1\uff08\u4f8b\u5982\uff0c\u7531\u4e8e\u56de\u73af\u95ed\u5408\uff09\u3002\u8fd9\u4f1a\u5bfc\u81f4\u65e0\u4eba\u673a\u504f\u79bb\u73b0\u6709\u8f68\u8ff9</p> <ul> <li> <p>\u7ef4\u62a4\u5206\u79bb\u7684 SLAM \u548c\u91cc\u7a0b\u8ba1\u53c2\u8003\u7cfb</p> </li> <li> <p>\u91cc\u7a0b\u8ba1\u53c2\u8003\u7cfb\uff1arobot\u2019s controller, local mapper, VIO, and trajectory planner</p> </li> <li> <p>SLAM \u53c2\u8003\u7cfb\uff1aexploration planner, semantic SLAM, and global mapper</p> </li> <li> <p>\u5c40\u90e8\u8f68\u8ff9\u4f18\u5316\uff1a\u5c06\u8f68\u8ff9\u5206\u89e3\u4e3a\u591a\u4e2a\u591a\u9879\u5f0f\uff0c\u76ee\u6807\u662f\u6700\u5c0f\u5316\u4f4d\u7f6e\u7684\u4e8c\u9636\u5bfc\u6570\u7684\u79ef\u5206\u540c\u65f6\u6ee1\u8db3\u51e0\u4f55\u7ea6\u675f\u548c\u8fde\u7eed\u6027\u7ea6\u675f</p> </li> <li> <p>\u9884\u6d4b\u6027\u4fe1\u606f\u611f\u77e5 yaw planning\uff1a\u9884\u6d4b\u7684\u4fe1\u606f\u589e\u76ca\u548c\u671d\u5411\u8bed\u4e49\u611f\u5174\u8da3\u7269\u4f53(SoI)\u7684\u76f8\u5bf9\u89c6\u89d2\u6765\u4f18\u5316\u504f\u822a\u89d2</p> </li> <li> <p>\u641c\u7d22\u504f\u822a\u57fa\u5143 (yaw primitives)\uff0c\u4ee5\u83b7\u5f97\u4e00\u4e2a\u5177\u6709\u9ad8\u4ef7\u503c\u4fe1\u606f\u7684\u53c2\u8003\u504f\u822a\u89d2</p> </li> <li>\u57fa\u4e8e\u641c\u7d22\u7684\u7a0b\u5e8f\u8bc6\u522b\u51fa\u6700\u4f18\u7684\u53c2\u8003\u504f\u822a\u5e8f\u5217\u540e\uff0c\u6211\u4eec\u76f4\u63a5\u6c42\u89e3\u4e00\u4e2a\u6700\u4f18\u7684\u504f\u822a\u8f68\u8ff9</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#experimentsevaluationresults","title":"Experiments/Evaluation/Results","text":"<p>TODO</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#conclusion","title":"Conclusion","text":"<p>\u5f00\u53d1\u4e86\u4e00\u79cd\u4f7f\u7528\u81ea\u4e3b\u65e0\u4eba\u673a\u5bf9 GPS \u65e0\u6cd5\u8bc6\u522b\u7684\u5ba4\u5185\u73af\u5883\u8fdb\u884c 3D \u63a2\u7d22\u548c metric-semantic \u6620\u5c04\u7684\u7cfb\u7edf\u3002</p> <ol> <li>metric-semantic SLAM</li> <li>\u57fa\u4e8e COP \u7684\u63a2\u7d22\u89c4\u5212</li> <li>active SLC</li> <li>\u4e3b\u52a8\u4e0d\u786e\u5b9a\u6027\u51cf\u5c11\u89c4\u5212</li> </ol> <p>\u5b83\u5229\u7528\u73af\u5883\u7684\u62bd\u8c61\uff0c\u5305\u62ec\u4ece\u5ea6\u91cf\u5730\u56fe\u548c\u7a00\u758f\u8bed\u4e49\u5730\u56fe\u4e2d\u63d0\u53d6\u7684\u63a2\u7d22\u89c6\u70b9\uff0c\u663e\u7740\u51cf\u5c11\u5b9e\u65f6\u63a2\u7d22\u548c\u4e3b\u52a8\u5b9a\u4f4d\u7684\u8ba1\u7b97\u8d1f\u8f7d\u3002\u901a\u8fc7\u5e7f\u6cdb\u7684\u73b0\u5b9e\u4e16\u754c\u5b9e\u9a8c\uff0c\u6211\u4eec\u5c55\u793a\u4e86\u6211\u4eec\u63d0\u51fa\u7684\u7cfb\u7edf\u5728\u4f7f\u65e0\u4eba\u673a\u80fd\u591f\u89c4\u5212\u957f\u89c6\u91ce\u8def\u5f84\u3001\u6743\u8861\u63a2\u7d22\u548c\u5229\u7528\u65b9\u9762\u7684\u6709\u6548\u6027\u3002\u5b9a\u6027\u7ed3\u679c\u8868\u660e\uff0c\u6211\u4eec\u7684\u7cfb\u7edf\u4f7f\u65e0\u4eba\u673a\u4e0d\u4ec5\u80fd\u591f\u63a2\u7d22\u591a\u5c42\u73af\u5883\u5e76\u6784\u5efa metric-semantic \u5730\u56fe\uff0c\u800c\u4e14\u8fd8\u80fd\u95f4\u6b47\u6027\u5730\u5efa\u7acb SLC \u4ee5\u63d0\u9ad8\u5730\u56fe\u7684\u8d28\u91cf\u3002\u5b9a\u91cf\u8bc4\u4f30\u8868\u660e\uff0c\u6211\u4eec\u7684 SLC \u6a21\u5757\u53ef\u4ee5\u5e2e\u52a9\u673a\u5668\u4eba\u663e\u7740\u964d\u4f4e\u4f4d\u7f6e\u548c\u59ff\u6001\u4f30\u8ba1\u8bef\u5dee\u548c\u4e0d\u786e\u5b9a\u6027\u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#my-summary","title":"My Summary","text":"<p>\u4e4b\u524d\u5927\u591a\u6570 metric-semantic slam \u5c06\u63a2\u7d22\u95ee\u9898\u62bd\u8c61\u6210 ATSP \u95ee\u9898\uff0c\u5ffd\u7565\u4e86\u89c6\u70b9\u4e4b\u95f4\u7684\u76f8\u5173\u6027\uff0c\u8fd9\u7bc7\u6587\u7ae0\u5c06\u63a2\u7d22\u95ee\u9898\u5efa\u6a21\u6210 COP \u95ee\u9898\uff0c\u8003\u8651\u4e86\u89c6\u70b9\u4e4b\u95f4\u7684\u76f8\u5173\u6027\u548c\u63a2\u7d22\u6210\u672c\u95ee\u9898\uff0c\u5bf9\u65e0\u4eba\u673a\u8fd9\u79cd SWaP \u53d7\u9650\u8bbe\u5907\u6709\u5fc5\u8981</p> <p>\u8bbe\u8ba1\u4e86 SLC \u6a21\u5757\u5e76\u5229\u7528\u4e3b\u52a8 SLC \u5728 COP \u89c4\u5212\u7684\u8def\u5f84\u4e2d\u63d2\u5165 SLC \u89c6\u70b9\uff0c\u6743\u8861\u63a2\u7d22\u548c\u4e0d\u786e\u5b9a\u6027\u51cf\u5c11\uff0c\u51cf\u5c11\u4e86\u65e0\u4eba\u673a\u7d2f\u8ba1\u6f02\u79fb\u3002</p> <p>\u6574\u4f53\u6d41\u7a0b\u518d\u68b3\u7406</p> <ul> <li>Metric-Semantic SLAM \u6a21\u5757\u5728 SLOAM \u4e0a\u4fee\u6539\uff0c\u521d\u59cb\u4f4d\u59ff\u4f30\u8ba1\u7531\u5361\u5c14\u66fc\u6ee4\u6ce2\u6765\u505a\uff0c\u4f7f\u7528 GTSAM \u6765\u505a\u56e0\u5b50\u56fe\u4f18\u5316[^sloam]</li> <li>Frontier detection \u548c viewpoint sampling \u6a21\u5757\uff1a\u501f\u9274\u81ea SEER \u8bba\u6587[^seer]\uff0c\u4f7f\u7528\u589e\u91cf\u5f0f\u524d\u6cbf\u68c0\u6d4b\u548c\u89c6\u70b9\u91c7\u6837\u6a21\u5757\uff0c\u9009\u53d6\u4fe1\u606f\u589e\u76ca\u6700\u5927\u7684\u89c6\u70b9\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u76ee\u6807\u70b9</li> <li>COP-based exploration planning \u6a21\u5757\uff1a\u5c06\u63a2\u7d22\u95ee\u9898\u5efa\u6a21\u4e3a COP \u95ee\u9898\uff0c\u4f7f\u7528\u8d2a\u5a6a\u6784\u5efa\u542f\u53d1\u5f0f\u7b97\u6cd5\u6765\u6c42\u89e3 COP \u95ee\u9898</li> <li>Active SLC \u6a21\u5757\uff1a\u4f7f\u7528 DBSCAN \u5bf9\u8bed\u4e49\u8def\u6807\u8fdb\u884c\u805a\u7c7b\uff0c\u4ece\u56e0\u5b50\u56fe\u4e2d\u7684\u5173\u952e\u4f4d\u59ff\u96c6\u5408\u4e2d\u9009\u62e9 SLC \u89c6\u70b9\uff0c\u4f7f\u7528\u865a\u62df\u56e0\u5b50\u6765\u8ba1\u7b97 IG</li> <li>Active uncertainty reduction planning \u6a21\u5757\uff1a\u5728 COP \u89c4\u5212\u7684\u8def\u5f84\u4e2d\u63d2\u5165 SLC \u89c6\u70b9\uff0c\u6743\u8861\u63a2\u7d22\u548c\u4e0d\u786e\u5b9a\u6027\u51cf\u5c11</li> <li>\u5c40\u90e8\u8f68\u8ff9\u89c4\u5212\u6a21\u5757\uff1a\u501f\u9274\u4e86 Geometrically constrained trajectory optimization for multicopters[^gofei]\uff0c\u4f7f\u7528\u4e86\u591a\u9879\u5f0f\u8f68\u8ff9\u89c4\u5212</li> <li>yaw planning \u6a21\u5757\uff1a\u501f\u9274\u4e86 SEER: Safe Efficient Exploration for Aerial Robots using Learning to Predict Information Gain[^seer]\uff0c\u4f7f\u7528\u4e86\u57fa\u4e8e\u641c\u7d22\u7684 yaw primitives</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/3D%20Active%20Metric-Semantic%20SLAM/#reference","title":"Reference","text":"<p>[^gofei]: Geometrically constrained trajectory optimization for multicopters [^seer]: SEER: Safe Efficient Exploration for Aerial Robots using Learning to Predict Information Gain [^sloam]: Active metric-semantic mapping by multiple aerial robots</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/","title":"Exploration with Global Consistency Using Real-Time Re-integration and Active Loop Closure \u8bba\u6587\u7cbe\u8bfb","text":"2025-10-142025-12-10 <code>#VINS</code>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#exploration-with-global-consistency-using-real-time-re-integration-and-active-loop-closure","title":"Exploration with Global Consistency Using Real-Time Re-integration and Active Loop Closure","text":"<p> \u7ea6 1987 \u4e2a\u5b57  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 10 \u5206\u949f</p> <p>ICRA 2022 \u4f5c\u8005\u4fe1\u606f\uff1aYichen Zhang, \u6e2f\u79d1\u5927 HDJI \u56e2\u961f\uff0c\u81ea\u4e3b\u907f\u969c</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#abstract","title":"Abstract","text":"<p>\u4e3a\u4e86\u89e3\u51b3\u5b9a\u4f4d\u6f02\u79fb\u95ee\u9898\uff0c\u8fd9\u7bc7\u6587\u7ae0\u4e4b\u524d\u7684\u63a2\u7d22\u7b56\u7565\u90fd\u662f\u5047\u8bbe localization \u662f drift-free \u7684\uff0c\u8fd9\u4e2a\u5047\u8bbe\u5728\u73b0\u5b9e\u4e2d\u5f80\u5f80\u4e0d\u6210\u7acb\u3002</p> <p>\u672c\u6587\u63d0\u51fa\u4e86\u4e00\u79cd\u5b9e\u65f6\u91cd\u79ef\u5206\u7684\u5e27\u526a\u679d\u5efa\u56fe\u7b97\u6cd5\u4ee5\u53ca\u4e00\u4e2a\u8003\u8651\u5386\u53f2 viewpoints \u7684\u63a2\u7d22\u89c4\u5212\u7b97\u6cd5\uff0c\u5e76\u7ed3\u5408\u4e8c\u8005\u52a0\u4e0a\u4e3b\u52a8\u95ed\u73af\u68c0\u6d4b\u6784\u5efa\u4e86\u4e00\u4e2a framework</p> <p>\u8be5\u65b9\u6cd5\u4e3b\u8981\u89e3\u51b3\u4e24\u4e2a\u95ee\u9898\uff1a</p> <ul> <li>\u957f\u65f6\u95f4 VIO \u5bfc\u81f4\u7684\u5b9a\u4f4d\u6f02\u79fb\uff0c\u5730\u56fe\u53ef\u80fd\u4e25\u91cd\u626d\u66f2</li> <li>\u88ab\u52a8\u95ed\u73af\u68c0\u6d4b\u96be\u4ee5\u53d1\u73b0\u95ed\u73af\uff0c\u5730\u56fe\u8d28\u91cf\u4e0d\u9ad8</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#introduction","title":"Introduction \u603b\u4f53\u4ecb\u7ecd","text":"<p>\u81ea\u4e3b\u63a2\u7d22\u662f\u5728\u672a\u77e5\u73af\u5883\u4e0b\u5efa\u56fe\u7684\u8fc7\u7a0b\uff0c\u5b83\u662f\u822a\u7a7a\u6444\u5f71\u3001\u5730\u7406\u6d4b\u7ed8\u3001\u707e\u5bb3\u7ba1\u7406\u4ee5\u53ca\u641c\u6551\u7b49\u5404\u79cd\u5e94\u7528\u7684\u57fa\u672c\u95ee\u9898\uff0c\u6240\u4ee5\u9010\u6e10\u6210\u4e3a\u70ed\u95e8\u7814\u7a76\u65b9\u5411\u3002</p> <p>\u73b0\u6709\u65b9\u6cd5\u95ee\u9898\uff1a</p> <ol> <li>\u73b0\u6709\u65b9\u6cd5\u5927\u591a\u5047\u8bbe\u5b9a\u4f4d\u662f\u65e0\u6f02\u79fb\u7684\uff0c\u4f46\u73b0\u5b9e\u4e2d VIO \u4f1a\u968f\u7740\u65f6\u95f4\u79ef\u7d2f\u6f02\u79fb\uff0c\u5bfc\u81f4\u5730\u56fe\u4e25\u91cd\u626d\u66f2\uff0c\u5f71\u54cd\u540e\u7eed\u7684\u63a2\u7d22\u548c\u5bfc\u822a\u3002</li> <li>\u73b0\u6709\u65b9\u6cd5\u5927\u591a\u4f9d\u8d56\u88ab\u52a8\u95ed\u73af\u68c0\u6d4b\uff0c\u96be\u4ee5\u53d1\u73b0\u95ed\u73af\uff0c\u5bfc\u81f4\u5730\u56fe\u8d28\u91cf\u4e0d\u9ad8\u3002</li> </ol> <p>\u672c\u6587\u8d21\u732e\uff1a</p> <ol> <li>\u63d0\u51fa\u57fa\u4e8e TSDF \u7684\u5efa\u56fe\u6846\u67b6\uff0c\u8be5\u6846\u67b6\u5177\u6709\u5b9e\u65f6\u91cd\u79ef\u5206\u529f\u80fd\u548c\u57fa\u4e8e\u96c6\u5408\u8986\u76d6\u516c\u5f0f\u5316\u9009\u62e9\u6807\u51c6\u7684\u5e27\u526a\u679d\u673a\u5236\uff0c\u751f\u6210\u4e00\u4e2a\u5168\u5c40\u4e00\u81f4\u7684\u5730\u56fe\u3002    - \u5bf9\u6240\u6709\u5e27\u8fdb\u884c\u5b9e\u65f6\u91cd\u79ef\u5206\u5bf9\u65e0\u4eba\u673a\u8bbe\u5907\u7b97\u529b\u8981\u6c42\u8fc7\u9ad8\uff0c\u5e94\u7528\u4e86\u4e00\u79cd\u57fa\u4e8e\u96c6\u5408\u8986\u76d6\u516c\u5f0f\u7684\u5173\u952e\u5e27\u9009\u62e9\u65b9\u6cd5\u6765\u526a\u679d\u5197\u4f59\u7684\u5e27\u3002    - \u5229\u7528\u7a7a\u95f4\u5212\u5206\u6765\u589e\u91cf\u5f0f\u5730\u89e3\u51b3\u96c6\u5408\u8986\u76d6\u95ee\u9898\uff0c\u4ece\u800c\u63d0\u5347\u4e86\u5b9e\u65f6\u6027\u80fd\u3002</li> <li>\u5728\u63a2\u7d22\u89c4\u5212\u4e2d\u91c7\u7528\u4e86\u4e00\u79cd\u4e3b\u52a8\u95ed\u73af\u68c0\u6d4b\u7b56\u7565\uff0c\u4ee5\u83b7\u5f97\u66f4\u9ad8\u7684\u56de\u73af\u68c0\u6d4b\u673a\u4f1a\uff0c\u8fd9\u8fdb\u4e00\u6b65\u51cf\u5c11\u4e86\u5b9a\u4f4d\u6f02\u79fb\u5e76\u63d0\u5347\u4e86\u5730\u56fe\u8d28\u91cf\u3002</li> </ol>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#background","title":"Background","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#autonomous-exploration","title":"Autonomous Exploration","text":"<ul> <li> <p>\u57fa\u4e8e\u8fb9\u754c\u70b9 (Frontier-based) \u7684\u65b9\u6cd5</p> </li> <li> <p>\u6982\u5ff5\uff1a\u8fb9\u754c\u70b9 (Frontier) \u662f\u6307\u5df2\u77e5\u533a\u57df\u548c\u672a\u77e5\u533a\u57df\u7684\u4ea4\u754c\u5904\u3002\u8fd9\u79cd\u7b56\u7565\u5c31\u50cf\u4f60\u5728\u6e38\u620f\u4e2d\u201c\u5f00\u56fe\u201d\u4e00\u6837\uff0c\u673a\u5668\u4eba\u4f1a\u4f18\u5148\u79fb\u52a8\u5230\u8fd9\u4e9b\u8fb9\u754c\uff0c\u56e0\u4e3a\u90a3\u91cc\u6700\u6709\u53ef\u80fd\u53d1\u73b0\u65b0\u7684\u672a\u77e5\u7a7a\u95f4\u3002</p> </li> <li> <p>\u6f14\u8fdb\uff1a\u6700\u65e9\u7684\u65b9\u6cd5\u662f\u53bb\u6700\u8fd1\u7684\u8fb9\u754c\u70b9\uff0c\u540e\u6765\u4e3a\u4e86\u9002\u5e94\u9ad8\u901f\u65e0\u4eba\u673a\uff0c\u53d1\u5c55\u4e3a\u53bb\u8f6c\u5411\u6700\u5e73\u7f13\uff08\u901f\u5ea6\u53d8\u5316\u6700\u5c0f\uff09\u7684\u8fb9\u754c\u70b9\u3002</p> </li> <li> <p>\u57fa\u4e8e\u91c7\u6837 (Sampling-based) \u7684\u65b9\u6cd5</p> </li> <li> <p>\u6982\u5ff5\uff1a\u673a\u5668\u4eba\u5728\u5468\u56f4\u968f\u673a\u751f\u6210\u5927\u91cf\u53ef\u80fd\u7684\u201c\u4e0b\u4e00\u6b65\u89c6\u70b9\u201d\uff08\u91c7\u6837\u70b9\uff09\uff0c\u7136\u540e\u8bc4\u4f30\u53bb\u54ea\u4e2a\u89c6\u70b9\u80fd\u83b7\u5f97\u6700\u591a\u7684\u65b0\u4fe1\u606f\uff08\u4f8b\u5982\uff0c\u80fd\u770b\u5230\u6700\u5927\u9762\u79ef\u7684\u672a\u77e5\u533a\u57df\uff09\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e5f\u53eb\u8ba1\u7b97\u201c\u4e0b\u4e00\u6700\u4f73\u89c6\u89d2 (NBV)\u201d\u3002</p> </li> <li> <p>\u6f14\u8fdb\uff1a\u901a\u8fc7\u751f\u957f RRTs\uff08\u5feb\u901f\u63a2\u7d22\u968f\u673a\u6811\uff09 \u8fd9\u79cd\u9ad8\u6548\u7684\u8def\u5f84\u89c4\u5212\u7b97\u6cd5\u6765\u9009\u62e9\u6700\u6709\u4ef7\u503c\u7684\u63a2\u7d22\u65b9\u5411\u3002</p> </li> <li> <p>\u6df7\u5408\u65b9\u6cd5 (Hybrid Approaches)</p> </li> <li> <p>\u7814\u7a76\u8005\u4eec\u53d1\u73b0\uff0c\u4e24\u79cd\u65b9\u6cd5\u5404\u6709\u4f18\u52a3\uff0c\u4e8e\u662f\u5c1d\u8bd5\u5c06\u5b83\u4eec\u7ed3\u5408\u3002\u4f8b\u5982\uff0c\u5728\u5168\u5c40\u5c3a\u5ea6\u4e0a\u7528\u8fb9\u754c\u70b9\u89c4\u5212\u4e00\u4e2a\u5927\u81f4\u65b9\u5411\uff08\u53bb\u54ea\u91cc\u5f00\u56fe\uff09\uff0c\u5728\u5c40\u90e8\u5c3a\u5ea6\u4e0a\u7528\u91c7\u6837\u6cd5\u7cbe\u7ec6\u5730\u89c4\u5212\u5177\u4f53\u8def\u5f84\uff08\u600e\u4e48\u8d70\u8fc7\u53bb\u6700\u597d\uff09\u3002</p> </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#globally-consistent-dense-mapping","title":"Globally Consistent Dense Mapping","text":"<p>\u6838\u5fc3\u95ee\u9898\uff1a\u5730\u56fe\u53d8\u5f62\u4e86\uff0c\u600e\u4e48\u201c\u63b0\u201d\u56de\u6765\uff1f \u5f53\u673a\u5668\u4eba\u53d1\u73b0\u81ea\u5df1\u56de\u5230\u4e86\u539f\u70b9\uff08\u56de\u73af\u95ed\u5408\uff09\uff0c\u5e76\u8ba1\u7b97\u51fa\u7d2f\u79ef\u7684\u8bef\u5dee\u540e\uff0c\u5c31\u9700\u8981\u4fee\u6b63\u6574\u4e2a\u5730\u56fe\u3002\u4e0b\u9762\u662f\u6587\u4e2d\u8ba8\u8bba\u7684\u4e09\u79cd\u201c\u4fee\u6b63\u201d\u6280\u672f\uff1a</p> <ol> <li>\u5f39\u6027\u53d8\u5f62\u6cd5 (Deformable Mesh / Surfels)</li> </ol> <ul> <li>\u6982\u5ff5\uff1a\u628a\u6574\u4e2a\u4e09\u7ef4\u5730\u56fe\u770b\u4f5c\u4e00\u4e2a\u6709\u5f39\u6027\u7684\u7269\u4f53\uff08\u50cf\u4e00\u4e2a\u6a61\u80f6\u6a21\u578b\uff09\u3002\u5f53\u53d1\u73b0\u8f68\u8ff9\u6709\u8bef\u5dee\u65f6\uff0c\u5c31\u901a\u8fc7\u6570\u5b66\u65b9\u6cd5\u5bf9\u8fd9\u4e2a\u201c\u6a61\u80f6\u6a21\u578b\u201d\u8fdb\u884c\u62c9\u4f38\u3001\u626d\u66f2\uff0c\u76f4\u5230\u5b83\u6062\u590d\u6b63\u786e\u7684\u5f62\u72b6\u3002\u9762\u5143 (Surfels) \u662f\u6784\u6210\u8fd9\u79cd\u6a21\u578b\u7684\u5c0f\u8868\u9762\u7247\u3002</li> <li>\u8fd9\u79cd\u65b9\u6cd5\u53ea\u5173\u5fc3\u201c\u54ea\u91cc\u6709\u4e1c\u897f\u201d\uff0c\u4f46\u65e0\u6cd5\u533a\u5206\u201c\u54ea\u91cc\u6ca1\u4e1c\u897f (\u81ea\u7531\u7a7a\u95f4)\u201d\u548c\u201c\u8fd8\u6ca1\u53bb\u770b\u8fc7\u7684\u5730\u65b9 (\u672a\u77e5\u7a7a\u95f4)\u201d\u3002\u5bf9\u4e8e\u9700\u8981\u77e5\u9053\u201c\u4e0b\u4e00\u6b65\u8be5\u53bb\u54ea\u91cc\u63a2\u7d22\u201d\u7684\u673a\u5668\u4eba\u6765\u8bf4\uff0c\u8fd9\u4e2a\u7f3a\u70b9\u662f\u81f4\u547d\u7684\u3002</li> </ul> <ol> <li>\u62fc\u56fe\u6cd5 (Collection of Submaps)</li> </ol> <ul> <li>\u6982\u5ff5\uff1a\u5efa\u56fe\u65f6\u4e0d\u662f\u753b\u4e00\u5f20\u5927\u5730\u56fe\uff0c\u800c\u662f\u753b\u5f88\u591a\u5f20\u5c0f\u5730\u56fe\uff08\u5b50\u56fe\uff09\uff0c\u50cf\u62fc\u56fe\u4e00\u6837\u3002\u5f53\u53d1\u73b0\u8bef\u5dee\u65f6\uff0c\u4e0d\u9700\u8981\u4fee\u6539\u6bcf\u5f20\u5c0f\u5730\u56fe\u5185\u90e8\u7684\u7ec6\u8282\uff0c\u53ea\u9700\u8981\u8c03\u6574\u8fd9\u4e9b\u201c\u62fc\u56fe\u5757\u201d\u4e4b\u95f4\u7684\u76f8\u5bf9\u4f4d\u7f6e\u5373\u53ef\u3002</li> <li>\u590d\u6742\u5ea6\u9ad8\uff1a\u673a\u5668\u4eba\u89c4\u5212\u8def\u5f84\u65f6\uff0c\u5982\u679c\u8def\u7ebf\u8de8\u8d8a\u4e86\u591a\u4e2a\u201c\u62fc\u56fe\u5757\u201d\uff0c\u5c31\u9700\u8981\u5206\u522b\u5411\u5b83\u4eec\u67e5\u8be2\u4fe1\u606f\uff0c\u589e\u52a0\u4e86\u590d\u6742\u6027\u3002</li> <li>\u5185\u90e8\u7578\u53d8\u65e0\u6cd5\u6d88\u9664\uff1a\u5982\u679c\u5355\u4e2a\u201c\u62fc\u56fe\u5757\u201d\u672c\u8eab\u56e0\u4e3a\u6f02\u79fb\u753b\u5f97\u4e0d\u51c6\uff0c\u8fd9\u79cd\u65b9\u6cd5\u662f\u65e0\u6cd5\u4fee\u6b63\u5176\u5185\u90e8\u9519\u8bef\u7684\u3002</li> </ul> <ol> <li>\u91cd\u65b0\u7ed8\u5236\u6cd5 (Re-integration)</li> </ol> <ul> <li>\u6982\u5ff5\uff1a\u8fd9\u662f\u6700\u5f7b\u5e95\u3001\u6700\u7cbe\u786e\u7684\u65b9\u6cd5\u3002\u5b83\u4f1a\u628a\u673a\u5668\u4eba\u4e00\u8def\u8d70\u6765\u6240\u6709\u7684\u539f\u59cb\u4f20\u611f\u5668\u6570\u636e\uff08\u6bd4\u5982\u6df1\u5ea6\u56fe\u50cf\uff09\u90fd\u4fdd\u5b58\u4e0b\u6765\u3002\u5f53\u53d1\u73b0\u8f68\u8ff9\u6709\u8bef\u5dee\u540e\uff0c\u5b83\u4f1a\u7528\u4fee\u6b63\u540e\u7684\u65b0\u8f68\u8ff9\uff0c\u5229\u7528\u6240\u6709\u539f\u59cb\u6570\u636e\u751f\u6210\u4e00\u5f20\u5168\u65b0\u7684\u3001\u5b8c\u5168\u6b63\u786e\u7684\u5730\u56fe\u3002</li> <li>\u80fd\u5f7b\u5e95\u6d88\u9664\u6240\u6709\u7578\u53d8\uff0c\u751f\u6210\u5168\u5c40\u4e00\u81f4\u7684\u7cbe\u786e\u5730\u56fe\u3002\u6700\u7ec8\u5f97\u5230\u7684\u662f\u4e00\u5f20\u5b8c\u6574\u7684\u5730\u56fe\uff0c\u8fd0\u52a8\u89c4\u5212\u5668\u67e5\u8be2\u8d77\u6765\u5f88\u7b80\u5355\uff08\u6052\u5b9a\u7684\u67e5\u8be2\u65f6\u95f4\uff09\u3002</li> <li>\u4f46\u8ba1\u7b97\u91cf\u6781\u5927\uff0c\u901a\u5e38\u96be\u4ee5\u5728\u8d44\u6e90\u6709\u9650\u7684\u673a\u8f7d\u8ba1\u7b97\u673a\u4e0a\u5b9e\u65f6\u8fd0\u884c\u3002</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#this-work","title":"This Work","text":"<p>\u4f7f\u7528\u8fd9\u79cd Re-integration \u65b9\u6cd5\u6765\u786e\u4fdd\u5730\u56fe\u7684\u5168\u5c40\u4e00\u81f4\u6027\uff0c\u540c\u65f6\u901a\u8fc7\u5e27\u526a\u679d\u548c\u589e\u91cf\u5f0f TSDF \u66f4\u65b0\u6765\u63d0\u5347\u5b9e\u65f6\u6027\u80fd\u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#truncated-signed-distance-fieldtsdf","title":"Truncated Signed Distance Field(TSDF)","text":"<ul> <li>Signed Distance Field (SDF) \u662f\u4e00\u79cd\u9690\u5f0f\u7684\u7a7a\u95f4\u8868\u793a\u65b9\u5f0f\u3002\\   \u5b83\u4e3a\u7a7a\u95f4\u4e2d\u7684\u6bcf\u4e00\u4e2a\u70b9 ( \\mathbf{x} = (x, y, z) ) \u5b9a\u4e49\u4e00\u4e2a\u7b26\u53f7\u8ddd\u79bb\u503c\uff1a</li> </ul> \\[ \\\\text{SDF}(\\\\mathbf{x}) = \\\\begin{cases} +d(\\\\mathbf{x}, \\\\text{surface}), &amp; \\\\text{if outside the surface} \\\\ -d(\\\\mathbf{x}, \\\\text{surface}), &amp; \\\\text{if inside the surface} \\\\end{cases} \\] <ul> <li>TSDF: \u5728\u5b9e\u9645\u8ba1\u7b97\u4e2d\uff0c\u6211\u4eec\u4e0d\u9700\u8981\uff08\u4e5f\u5b58\u4e0d\u4e0b\uff09\u5168\u7a7a\u95f4\u7684\u8ddd\u79bb\uff0c\u56e0\u6b64\u5f15\u5165\u622a\u65ad\u534a\u5f84 ( \\mu )\uff1a</li> </ul> \\[ \\\\text{TSDF}(\\\\mathbf{x}) = \\\\text{clip}\\\\left(\\\\frac{d(\\\\mathbf{x})}{\\\\mu}, -1, +1\\\\right) \\] <ul> <li>\u82e5\u8ddd\u79bb\u592a\u8fdc\uff08&gt;|\u03bc|\uff09\uff0c\u76f4\u63a5\u622a\u65ad\u4e3a \u00b11\uff1b</li> <li>\u53ea\u7cbe\u786e\u4fdd\u5b58\u8868\u9762\u9644\u8fd1\u7684\u4e00\u5c42\u4f53\u7d20\uff08\u00b1\u03bc \u8303\u56f4\u5185\uff09\u3002</li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#tsdf","title":"TSDF \u5730\u56fe\u66f4\u65b0","text":"<p>TSDF \u901a\u5e38\u5b58\u50a8\u5728\u4e00\u4e2a 3D \u4f53\u7d20\u7f51\u683c \u4e2d\uff1a</p> \\[ V(x, y, z) \\] <p>\u6bcf\u4e2a\u4f53\u7d20\u5b58\u50a8\u4e24\u9879\u6570\u636e\uff1a</p> <ul> <li>\u8ddd\u79bb\u503c ( f )\uff1a\u8868\u9762\u5230\u8be5\u4f53\u7d20\u4e2d\u5fc3\u7684\u622a\u65ad\u7b26\u53f7\u8ddd\u79bb\uff1b</li> <li>\u6743\u91cd ( w )\uff1a\u878d\u5408\u7f6e\u4fe1\u5ea6\uff08\u7528\u4e8e\u878d\u5408\u591a\u4e2a\u6df1\u5ea6\u5e27\uff09\u3002</li> </ul> <p>\u5f53\u65b0\u7684\u6df1\u5ea6\u56fe\u5230\u6765\u65f6\uff0c\u4f1a\u901a\u8fc7\u76f8\u673a\u6a21\u578b\u6295\u5f71\u66f4\u65b0 TSDF\uff1a</p> <p>[ f' = \\frac{w \\cdot f + w*{new} \\cdot f*{new}}{w + w*{new}} ] [ w' = w + w*{new} ]</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u6bcf\u5e27\u6df1\u5ea6\u90fd\u4f1a\u5bf9 TSDF \u7f51\u683c\u505a\u4e00\u6b21\u52a0\u6743\u5e73\u5747\u66f4\u65b0\uff0c\u6700\u7ec8\u5f62\u6210\u5e73\u6ed1\u7a33\u5b9a\u7684\u4e09\u7ef4\u8868\u9762\u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#method","title":"Method","text":"<p>\u6574\u4f53\u6d41\u7a0b</p> <ol> <li> <p>\u611f\u77e5\u4e0e\u5b9a\u4f4d: \u673a\u5668\u4eba\u542f\u52a8\uff0c\u901a\u8fc7\u6df1\u5ea6\u76f8\u673a\u89c2\u5bdf\u73af\u5883\uff0c\u5e76\u901a\u8fc7\u72b6\u6001\u4f30\u8ba1\u6a21\u5757\u5f97\u51fa\u81ea\u5df1\u7684\u521d\u59cb\u4f4d\u7f6e\u3002</p> </li> <li> <p>\u5efa\u56fe\u4e0e\u8bb0\u5f55: \u673a\u5668\u4eba\u5411\u524d\u79fb\u52a8\uff0c\u4e0d\u65ad\u5c06\u65b0\u7684\u89c2\u6d4b\u6570\u636e\u66f4\u65b0\u5230 TSDF \u5730\u56fe\u4e2d\uff0c\u5e76\u5c06\u6709\u4ee3\u8868\u6027\u7684 viewpoints \u5b58\u4e3a\u5173\u952e\u5e27\u3002</p> </li> <li> <p>loop closure: \u5728\u79fb\u52a8\u8fc7\u7a0b\u4e2d\uff0c\u95ed\u73af\u68c0\u6d4b\u6a21\u5757\u4e00\u76f4\u5728\u5de5\u4f5c\u3002\u5982\u679c\u673a\u5668\u4eba\u78b0\u5de7\u56de\u5230\u4e86\u4e00\u4e2a\u8001\u5730\u65b9\u5e76\u8ba4\u4e86\u51fa\u6765\uff0c\u7cfb\u7edf\u4f1a\u7acb\u523b\u89e6\u53d1\u4e00\u6b21\u5927\u89c4\u6a21\u4fee\u6b63\uff1a\u66f4\u65b0\u5386\u53f2\u8f68\u8ff9\uff0c\u5e76\u91cd\u79ef\u5206\u6574\u4e2a\u5730\u56fe\uff0c\u4f7f\u5176\u6062\u590d\u4e00\u81f4\u6027\u3002</p> </li> <li> <p>exploration planning:</p> </li> </ol> <ul> <li>\u627e\u5230\u5730\u56fe\u4e0a\u7684 frontiers</li> <li>\u627e\u5230\u5386\u53f2 viewpoints \u4e2d\u9002\u5408\u95ed\u73af\u7684\u70b9</li> <li>\u51b3\u7b56\uff1a\u662f\u53bb\u63a2\u7d22\u65b0\u7684 frontier\uff0c\u8fd8\u662f\u56de\u53bb\u505a\u95ed\u73af\u6821\u51c6</li> </ul> <ol> <li>\u5faa\u73af: \u673a\u5668\u4eba\u6cbf\u7740\u89c4\u5212\u597d\u7684\u8def\u5f84\u79fb\u52a8\uff0c\u7136\u540e\u56de\u5230\u7b2c 1 \u6b65\uff0c\u4e0d\u65ad\u5faa\u73af\u8fd9\u4e2a\u201c\u611f\u77e5-\u5efa\u56fe-\u51b3\u7b56\u201d\u7684\u8fc7\u7a0b\uff0c\u76f4\u5230\u6574\u4e2a\u73af\u5883\u88ab\u63a2\u7d22\u5b8c\u6bd5\u3002</li> </ol> <p></p>","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#tsdf-based-mapping","title":"TSDF-based Mapping","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#experimentsevaluationresults","title":"Experiments/Evaluation/Results","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#conclusion","title":"Conclusion","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#my-summary","title":"My Summary","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/Exploration%20with%20Global%20Consistency%20%20Using%20Real-Time%20Re-integration%20and%20Active%20Loop%20Closure/#reference","title":"Reference","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/PL-VINS/","title":"PL-VINS","text":"2025-12-022025-12-10 <p>title: PL-VINS: Real-Time Monocular Visual-Inertial SLAM with Point and Line Features \u8bba\u6587\u9605\u8bfb\u7b14\u8bb0 created: 2025-09-09 update: comments: true description: PL-VINS: Real-Time Monocular Visual-Inertial SLAM with Point and Line Features\uff1a - PL-VINS is the first real-time optimization-based monocular VINS method with point and line features. - A modified LSD algorithm is presented for the pose estimation problem by studying a hidden parameter tuning and length rejection strategy.</p> <p>katex: true tags:</p> <ul> <li>Paper Notes</li> <li>VINS</li> </ul>"},{"location":"paperreadings/activeslam/PL-VINS/#pl-vins-real-time-monocular-visual-inertial-slam-with-point-and-line-features","title":"PL-VINS: Real-Time Monocular Visual-Inertial SLAM with Point and Line Features \u8bba\u6587\u9605\u8bfb\u7b14\u8bb0","text":"<p> \u7ea6 3926 \u4e2a\u5b57  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 20 \u5206\u949f</p>"},{"location":"paperreadings/activeslam/PL-VINS/#abstract","title":"Abstract","text":"<p>\u5728\u4eba\u4e3a\u73af\u5883\u4e2d\uff0c\u5355\u7eaf\u7684\u7279\u5f81\u70b9\u63d0\u53d6\u65b9\u6cd5\u5bf9\u59ff\u52bf\u4f30\u8ba1\u6765\u8bf4\u4e0d\u591f\uff0c\u4e0e\u7ebf\u7279\u5f81\u7ed3\u5408\u53ef\u4ee5\u63d0\u5347\u9c81\u68d2\u6027\u3002\u5f53\u524d\u505a\u6cd5\u51c6\u786e\u5ea6\u641e\u4f46\u662f\u7f3a\u4e4f\u5b9e\u65f6\u6027\u3002</p> <ol> <li>\u901a\u8fc7\u4fee\u6539 LSD \u7b97\u6cd5\u8fc7\u6ee4\u4e0b\u4e00\u5e27\u56fe\u50cf\u4e2d\u53ef\u80fd\u88ab\u7b5b\u9009\u6389\u7684\u77ed\u7ebf\u7279\u5f81\uff0c\u52a0\u901f\u7b97\u6cd5\u3002</li> <li>\u7528\u666e\u5415\u514b\u5750\u6807\u8868\u793a\u7ebf\u7279\u5f81\uff0c\u63d0\u9ad8\u51c6\u786e\u7387 <p>\u666e\u5415\u514b\u5750\u6807\uff08Pl\u00fccker coordinates\uff09 \u662f\u4e00\u79cd\u7528\u516d\u4e2a\u9f50\u6b21\u5750\u6807\u6765\u8868\u793a\u4e09\u7ef4\u7a7a\u95f4\u4e2d\u76f4\u7ebf\u4f4d\u7f6e\u548c\u65b9\u5411\u7684\u65b9\u6cd5\u3002</p> <p>\u4f60\u53ef\u4ee5\u628a\u666e\u5415\u514b\u5750\u6807\u770b\u4f5c\u662f\u4e00\u79cd\u4e3a\u4e09\u7ef4\u7a7a\u95f4\u4e2d\u7684\u76f4\u7ebf\u201c\u5b9a\u5236\u201d\u7684\u7279\u6b8a\u5730\u5740\u3002\u901a\u5e38\uff0c\u6211\u4eec\u7528\u4e00\u4e2a\u70b9\u548c\u4e00\u4e2a\u65b9\u5411\u5411\u91cf\u6765\u5b9a\u4e49\u4e00\u6761\u76f4\u7ebf\uff0c\u800c\u666e\u5415\u514b\u5750\u6807\u5219\u7528\u4e24\u90e8\u5206\u6765\u63cf\u8ff0\u5b83\uff1a</p> <ul> <li> <p>\u65b9\u5411\u5411\u91cf\uff1a\u8fd9\u662f\u4e00\u4e2a\u4e09\u7ef4\u5411\u91cf\uff0c\u4ee3\u8868\u4e86\u76f4\u7ebf\u7684\u65b9\u5411\u548c\u671d\u5411\u3002</p> </li> <li> <p>\u77e9\u5411\u91cf\uff1a\u8fd9\u662f\u4e00\u4e2a\u4e09\u7ef4\u5411\u91cf\uff0c\u63cf\u8ff0\u4e86\u76f4\u7ebf\u76f8\u5bf9\u4e8e\u5750\u6807\u539f\u70b9\u7684\u4f4d\u7f6e\u3002\u5b83\u7684\u8ba1\u7b97\u65b9\u5f0f\u662f\u76f4\u7ebf\u4e0a\u4efb\u610f\u4e00\u70b9\u7684\u4f4d\u7f6e\u5411\u91cf\u4e0e\u65b9\u5411\u5411\u91cf\u7684\u53c9\u79ef\u3002</p> </li> </ul> </li> <li>\u57fa\u4e8e VINS-Mono \u6846\u67b6\u8fdb\u884c\u4f18\u5316    - \u524d\u7aef\uff1a\u7279\u5f81\u63d0\u53d6\u7684\u4f18\u5316\uff0c\u4ece\u5355\u7eaf\u7684\u70b9\u7279\u5f81\u63d0\u53d6\u5230\u70b9\u7ebf\u7ed3\u5408    - \u540e\u7aef\uff1a\u589e\u52a0\u7ebf\u7279\u5f81\u7684\u7ea6\u675f\u6761\u4ef6</li> </ol>"},{"location":"paperreadings/activeslam/PL-VINS/#intro","title":"Intro \u603b\u4f53\u4ecb\u7ecd","text":"<p>\u4e3a\u4e86 cost \u548c\u7cbe\u786e\u5ea6\u7684 trade-off\uff0c\u5927\u91cf\u573a\u666f\u4ec5\u4f7f\u7528\u4e00\u4e2a\u5355\u773c\u76f8\u673a\u548c IMU \u4f20\u611f\u5668\u3002\u73b0\u6709\u7684\u5355\u76ee\u89c6\u89c9\u60ef\u6027 SLAM \u7cfb\u7edf\u5927\u591a\u4f9d\u8d56\u4e8e\u70b9\u7279\u5f81\uff0c\u4f46\u5728\u4f4e\u7eb9\u7406\u73af\u5883\u4e2d\u8868\u73b0\u4e0d\u4f73\u3002\u7ebf\u7279\u5f81\u5728\u8fd9\u4e9b\u73af\u5883\u4e2d\u66f4\u5177\u9c81\u68d2\u6027\uff0c\u56e0\u4e3a\u5b83\u4eec\u80fd\u6355\u6349\u5230\u66f4\u591a\u7684\u7ed3\u6784\u4fe1\u606f\u3002\u7136\u800c\uff0c\u7ed3\u5408\u70b9\u548c\u7ebf\u7279\u5f81\u7684\u7cfb\u7edf\u901a\u5e38\u8ba1\u7b97\u590d\u6742\u5ea6\u8f83\u9ad8\uff0c\u96be\u4ee5\u5b9e\u73b0\u5b9e\u65f6\u6027\u80fd\u3002</p> <ul> <li>\u73b0\u6709\u7684\u89e3\u51b3\u65b9\u6848\u4f7f\u7528 OpenCV \u7684 LSD \u7b97\u6cd5\u8fdb\u884c\u7ebf\u7279\u5f81\u63d0\u53d6\uff0c\u4f46 LSD \u7b97\u6cd5\u672c\u8eab\u5e76\u4e0d\u662f\u4e3a pose estimation \u8bbe\u8ba1\u7684\uff0c\u5b58\u5728\u8ba1\u7b97\u91cf\u5927\u540c\u65f6\u68c0\u6d4b\u51fa\u5927\u91cf\u77ed\u7ebf\u6bb5\u7684\u95ee\u9898\uff0c\u8fd9\u4e9b\u77ed\u7ebf\u6bb5\u5728\u540e\u7eed\u7684\u5339\u914d\u548c\u4f18\u5316\u4e2d\u5f80\u5f80\u88ab\u8fc7\u6ee4\u6389\uff0c\u5bfc\u81f4\u8ba1\u7b97\u8d44\u6e90\u6d6a\u8d39\u3002</li> <li>PL-VINS \u4f18\u5316\u4e86 LSD \u7b97\u6cd5\uff0c\u66f4\u5173\u6ce8\u51b3\u5b9a\u6027\u7684\u7ebf\u6bb5\u5e76\u62d2\u7edd\u77ed\u7ebf\u6bb5\u3002\u540c\u65f6\u4f7f\u7528 Pl\u00fccker \u5750\u6807\u6765\u8868\u793a\u7ebf\u7279\u5f81\uff0c\u76f8\u5bf9\u4e8e\u4e24\u70b9\u8868\u793a\u7ebf\u6bb5\uff0c\u53ef\u4ee5\u66f4\u597d\u5730\u8ddf\u8e2a\u4e24\u5e27\u4e4b\u95f4\u7684\u7279\u5f81\u70b9\u3002\u4f18\u5316\u4e86\u540e\u7aef\u7684\u6ed1\u52a8\u7a97\u53e3\uff0c\u7ed3\u5408\u70b9\u7ebf\u7279\u5f81\u4ee5\u53ca IMU \u8fdb\u884c\u9ad8\u6548\u4f18\u5316\u3002</li> </ul>"},{"location":"paperreadings/activeslam/PL-VINS/#_1","title":"\u80cc\u666f\u77e5\u8bc6\u7684\u76f8\u5173\u5de5\u4f5c","text":""},{"location":"paperreadings/activeslam/PL-VINS/#msckf","title":"MSCKF","text":"<ol> <li>\u6838\u5fc3\u72b6\u6001\u5411\u91cf\uff1a\u7cfb\u7edf\u7684\u72b6\u6001\u5411\u91cf \u53ea\u5305\u542b IMU \u7684\u72b6\u6001\uff0c\u8fd9\u5305\u62ec\u4e86\u673a\u5668\u4eba\u7684\u59ff\u6001\u3001\u901f\u5ea6\u3001\u4f4d\u7f6e\uff0c\u4ee5\u53ca IMU \u7684\u504f\u7f6e\uff08bias\uff09\u3002\u5176\u7ef4\u5ea6\u662f\u56fa\u5b9a\u7684\uff08\u901a\u5e38\u662f 15 \u6216 16 \u7ef4\uff09\uff0c\u4e0d\u4f1a\u968f\u7740\u65f6\u95f4\u589e\u957f\u3002</li> </ol> <p>$$    \\mathbf{x}{IMU} =    \\begin{bmatrix}    q \\    p_{IW} \\    v_{IW} \\    b_g \\    b_a    \\end{bmatrix}    $$</p> <p>\u5176\u4e2d q \u662f\u59ff\u6001\u56db\u5143\u6570, p \u662f\u4f4d\u7f6e, v \u662f\u901f\u5ea6, \\(b_a\\) \u548c\\(b_g\\) \u5206\u522b\u662f\u9640\u87ba\u4eea\u548c\u52a0\u901f\u5ea6\u8ba1\u7684\u504f\u7f6e\u3002</p> <ol> <li> <p>\u72b6\u6001\u6269\u589e (State Augmentation)\uff1a\u5f53\u76f8\u673a\u6355\u83b7\u4e00\u5e27\u65b0\u7684\u56fe\u50cf\u65f6\uff0c\u8be5\u65f6\u523b\u76f8\u673a\u7684\u4f4d\u59ff\uff08\u4ece IMU \u72b6\u6001\u52a0\u4e0a\u5916\u53c2\u53ef\u4ee5\u5f97\u5230\uff09\u4f1a\u88ab**\u4e34\u65f6\u52a0\u5165\uff08\u6269\u589e\uff09**\u5230\u72b6\u6001\u5411\u91cf\u4e2d\u3002\u8fd9\u6837\uff0c\u72b6\u6001\u5411\u91cf\u4e2d\u5c31\u4fdd\u5b58\u4e86\u6700\u8fd1 N \u4e2a\u76f8\u673a\u4f4d\u59ff\u7684\u201c\u514b\u9686\u201d\u3002</p> </li> <li> <p>\u7279\u5f81\u70b9\u8ddf\u8e2a\uff1a\u7cfb\u7edf\u4f1a\u6301\u7eed\u8ddf\u8e2a\u540c\u4e00\u4e2a\u4e09\u7ef4\u7a7a\u95f4\u70b9\u5728\u4e0d\u540c\u56fe\u50cf\u5e27\uff08\u4e5f\u5c31\u662f\u4e0d\u540c\u76f8\u673a\u4f4d\u59ff\uff09\u4e2d\u7684\u6295\u5f71\u4f4d\u7f6e\u3002\u4f8b\u5982\uff0c\u4e00\u4e2a\u7279\u5f81\u70b9 f \u53ef\u80fd\u5728\u7b2c i, j, k \u5e27\u56fe\u50cf\u4e2d\u90fd\u88ab\u89c2\u6d4b\u5230\u3002</p> </li> <li> <p>\u7ea6\u675f\u7684\u6784\u5efa\u4e0e\u5229\u7528\uff1a\u5f53\u4e00\u4e2a\u7279\u5f81\u70b9\u7684\u8ddf\u8e2a\u7ed3\u675f\u65f6\uff08\u6bd4\u5982\u88ab\u906e\u6321\u6216\u79fb\u51fa\u89c6\u91ce\uff09\uff0cMSCKF \u5c31\u5229\u7528\u8fd9\u4e2a\u7279\u5f81\u70b9\u7684\u6574\u6761\u89c2\u6d4b\u8f68\u8ff9\u6765\u6784\u5efa\u4e00\u4e2a\u51e0\u4f55\u7ea6\u675f\u3002</p> </li> </ol> <ul> <li>\u5b83\u9996\u5148\u5bf9\u8fd9\u4e2a\u7279\u5f81\u70b9\u7684\u4e09\u7ef4\u4f4d\u7f6e\u8fdb\u884c\u4e09\u89d2\u5316\uff08Triangulation\uff09\u3002</li> <li>\u7136\u540e\uff0c\u5c06\u8fd9\u4e2a\u4f30\u8ba1\u51fa\u7684\u4e09\u7ef4\u70b9\u53cd\u5411\u6295\u5f71\u56de\u6240\u6709\u89c2\u6d4b\u5230\u5b83\u7684\u90a3\u4e9b\u5386\u53f2\u76f8\u673a\u4f4d\u59ff\u4e0a\uff0c\u5f97\u5230\u7406\u8bba\u4e0a\u7684\u50cf\u7d20\u5750\u6807\u3002</li> <li>\u8fd9\u4e2a\u7406\u8bba\u4e0a\u7684\u6295\u5f71\u5750\u6807\u4e0e\u5f53\u65f6\u5b9e\u9645\u89c2\u6d4b\u5230\u7684\u50cf\u7d20\u5750\u6807\u4e4b\u95f4\u7684\u5dee\u503c\uff0c\u5c31\u6784\u6210\u4e86\u6b8b\u5dee\uff08Residual\uff09\u3002</li> <li>MSCKF \u5c06\u8fd9\u4e2a\u6b8b\u5dee\uff08\u5305\u542b\u4e86\u591a\u4e2a\u5386\u53f2\u76f8\u673a\u4f4d\u59ff\u7684\u8bef\u5dee\uff09\u4f5c\u4e3a\u4e00\u6b21\u201c\u96f6\u6d4b\u91cf\u201d\u66f4\u65b0\uff0c\u65bd\u52a0\u5230\u5361\u5c14\u66fc\u6ee4\u6ce2\u5668\u7684\u66f4\u65b0\u6b65\u9aa4\u4e2d\u3002\u8fd9\u4e2a\u7ea6\u675f\u540c\u65f6\u5173\u8054\u4e86\u591a\u4e2a\u5386\u53f2\u76f8\u673a\u72b6\u6001\uff0c\u56e0\u6b64\u88ab\u79f0\u4e3a\u591a\u72b6\u6001\u7ea6\u675f\u3002</li> </ul> <ol> <li>\u8fb9\u7f18\u5316 (Marginalization)\uff1a\u5728\u5b8c\u6210\u66f4\u65b0\u540e\uff0c\u8fd9\u4e9b\u88ab\u7528\u4f5c\u7ea6\u675f\u7684\u5386\u53f2\u76f8\u673a\u4f4d\u59ff\u5c31\u53ef\u4ee5\u4ece\u72b6\u6001\u5411\u91cf\u4e2d\u79fb\u9664\u4e86\uff08\u8fb9\u7f18\u5316\uff09\uff0c\u4ece\u800c\u4fdd\u6301\u4e86\u72b6\u6001\u5411\u91cf\u7684\u7ef4\u5ea6\u6052\u5b9a\u3002</li> </ol>"},{"location":"paperreadings/activeslam/PL-VINS/#vins","title":"VINS \u5206\u7c7b","text":"<p>VINS \u53ef\u4ee5\u5206\u4e3a filter-based \u548c optimization-based\u3002</p> <ul> <li>\u57fa\u4e8e\u6ee4\u6ce2\u5668 (Filter-based) \u7684\u65b9\u6cd5\uff1a\u5c06 VINS \u770b\u4f5c\u4e00\u4e2a\u5728\u7ebf\u7684\u3001\u9012\u5f52\u7684\u72b6\u6001\u4f30\u8ba1\u95ee\u9898\u3002\u5b83\u50cf\u4e00\u4e2a\u6d41\u6c34\u7ebf\uff0c\u65b0\u7684\u4f20\u611f\u5668\u6570\u636e\uff08\u6d4b\u91cf\u503c\uff09\u6e90\u6e90\u4e0d\u65ad\u5730\u6d41\u5165\uff0c\u6ee4\u6ce2\u5668\u5229\u7528\u8fd9\u4e9b\u65b0\u6570\u636e\u6765\u66f4\u65b0\u5bf9\u5f53\u524d\u65f6\u523b\u72b6\u6001\u7684\u4f30\u8ba1\u3002\u5b83\u4e0d\u56de\u5934\u4fee\u6539\u8fc7\u53bb\u7684\u72b6\u6001\u3002 <p>MSCKF\uff1a\u7b2c\u4e00\u4e2a filter-based VINS \u7cfb\u7edf\uff0c\u4f7f\u7528\u4e86\u591a\u72b6\u6001\u7ea6\u675f\u5361\u5c14\u66fc\u6ee4\u6ce2\u5668\uff08MSCKF\uff09\u6846\u67b6\uff0c\u901a\u8fc7\u8ddf\u8e2a\u7279\u5f81\u70b9\u6765\u4f30\u8ba1\u76f8\u673a\u7684\u8fd0\u52a8\uff0c\u540c\u65f6\u5229\u7528 IMU \u6570\u636e\u8fdb\u884c\u9884\u6d4b\u548c\u6821\u6b63\u3002 OpenVINS\uff1a\u4e00\u4e2a\u5f00\u6e90\u7684 extended KF-based VINS \u7cfb\u7edf\uff0c\u4ee5\u53ca\u57fa\u4e8e OpenVINS \u7684\u7ed3\u5408\u7ebf\u7279\u5f81\u7684 VINS \u7cfb\u7edf</p> </li> <li>\u57fa\u4e8e\u4f18\u5316 (Optimization-based) \u7684\u65b9\u6cd5\uff1a\u5c06 VINS \u770b\u4f5c\u4e00\u4e2a\u6279\u91cf\u5904\u7406\u7684\u975e\u7ebf\u6027\u6700\u5c0f\u4e8c\u4e58\u95ee\u9898\u3002\u5b83\u4f1a\u6536\u96c6\u4e00\u6bb5\u65f6\u95f4\u5185\uff08\u4e00\u4e2a\u201c\u7a97\u53e3\u201d\u6216\u5168\u90e8\u5386\u53f2\uff09\u7684\u6240\u6709\u4f20\u611f\u5668\u6570\u636e\uff0c\u7136\u540e\u5bfb\u627e\u4e00\u6761\u6700\u4f18\u7684\u8f68\u8ff9\uff08\u5305\u542b\u591a\u4e2a\u65f6\u523b\u7684\u59ff\u6001\u3001\u4f4d\u7f6e\u7b49\uff09\uff0c\u4f7f\u5f97\u8fd9\u6761\u8f68\u8ff9\u80fd\u591f\u6700\u597d\u5730\u201c\u89e3\u91ca\u201d\u6240\u6709\u89c2\u6d4b\u5230\u7684\u6570\u636e\u3002</li> <li>Point-based methods\uff1aVINS-Mono\uff0c\u7531\u4e8e\u5bf9\u70b9\u63d0\u53d6\u7684\u4f9d\u8d56\u6027\uff0cT \u53ef\u80fd\u4f1a\u5728\u5145\u6ee1\u6311\u6218\u7684\u573a\u666f\u4e2d\u4ea7\u751f\u4f4e\u4e34\u754c\u6027\u59ff\u52bf\u4f30\u8ba1</li> <li>Point and line-based methods\uff1a\u4f1a\u4e3a\u540e\u9762\u4f18\u5316\u63d0\u4f9b\u989d\u5916\u7684\u7ea6\u675f<ul> <li>\u540c\u65f6\u8ddf\u8e2a\u70b9\u548c\u7ebf\u8def\u7279\u5f81\uff0c\u5e76\u9884\u5148\u6574\u5408 IMU \u6d4b\u91cf\u4fe1\u606f\uff0c\u5305\u62ec\u9640\u87ba\u4eea\u548c\u52a0\u901f\u5ea6\u8ba1</li> <li>\u901a\u8fc7\u8054\u5408\u6700\u5c0f\u5316\u4e0e\u70b9\u7684\u91cd\u6295\u5f71\u3001\u7ebf\u7684\u91cd\u6295\u5f71\u4ee5\u53ca IMU \u6d4b\u91cf\u76f8\u5173\u7684\u4e09\u4e2a\u6b8b\u5dee\u8bef\u5dee\u9879\uff0c\u6765\u5bf9\u76f8\u673a\u7684\u4f4d\u59ff\u8fdb\u884c\u4f30\u8ba1 <ol> <li>\u70b9\u91cd\u6295\u5f71\u8bef\u5dee\uff08Point Reprojection Error\uff09:\uff08\u5b9e\u9645\u89c2\u6d4b\u5230\u7684 vs. \u8ba1\u7b97\u9884\u6d4b\u7684\uff09\u5728\u56fe\u50cf\u4e0a\u7684\u50cf\u7d20\u8ddd\u79bb\uff0c\u5c31\u662f\u70b9\u91cd\u6295\u5f71\u8bef\u5dee\u3002</li> <li>\u7ebf\u91cd\u6295\u5f71\u8bef\u5dee\uff08Line Reprojection Error\uff09: \u5b9e\u9645\u68c0\u6d4b\u5230\u7684\u4e8c\u7ef4\u7ebf\u6bb5\uff0c\u5230\u7406\u8bba\u6295\u5f71\u7684\u4e8c\u7ef4\u76f4\u7ebf\u4e4b\u95f4\u7684\u8ddd\u79bb\uff0c\u5c31\u662f\u7ebf\u91cd\u6295\u5f71\u8bef\u5dee\u3002</li> <li>IMU \u8bef\u5dee (IMU Error)\uff1aIMU \u79ef\u5206\u9884\u6d4b\u7684\u4f4d\u59ff\u53d8\u5316\u91cf\u4e0e\u76f8\u673a\u4f4d\u59ff\u8ba1\u7b97\u51fa\u7684\u53d8\u5316\u91cf\u4e4b\u95f4\u7684\u5dee\u5f02\u3002</li> </ol> </li> <li>\u63d0\u53d6\u7ebf\u7279\u5f81\u6210\u4e3a\u4e86bottleneck</li> </ul> </li> </ul> \u7279\u6027\u7ef4\u5ea6 \u57fa\u4e8e\u6ee4\u6ce2\u5668 (Filter-based) \u57fa\u4e8e\u4f18\u5316 (Optimization-based) \u6570\u636e\u5904\u7406\u65b9\u5f0f \u5e8f\u8d2f/\u9012\u5f52 (Sequential/Recursive)\u5904\u7406\u5b8c\u4e00\u4e2a\u6d4b\u91cf\u6570\u636e\u5c31\u7acb\u5373\u66f4\u65b0\u5f53\u524d\u72b6\u6001\uff0c\u7136\u540e\u4e22\u5f03\u8fd9\u4e2a\u6570\u636e\u3002 \u6279\u91cf/\u6ed1\u52a8\u7a97\u53e3 (Batch/Sliding Window)\u5c06\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6240\u6709\u6d4b\u91cf\u6570\u636e\uff08IMU \u548c\u89c6\u89c9\uff09\u653e\u5728\u4e00\u8d77\uff0c\u8fdb\u884c\u8054\u5408\u4f18\u5316\u3002 \u5bf9\u5386\u53f2\u4fe1\u606f\u7684\u5229\u7528 \u95f4\u63a5\u5229\u7528 / \u4f1a\u9057\u5fd8\u8fc7\u53bb\u7684\u4fe1\u606f\u88ab\u538b\u7f29\u5e76\u4f53\u73b0\u5728\u5f53\u524d\u72b6\u6001\u7684\u5148\u9a8c\u4f30\u8ba1\u548c\u534f\u65b9\u5dee\u77e9\u9635\u4e2d\u3002\u4e00\u65e6\u5904\u7406\u8fc7\uff0c\u65e7\u7684\u6d4b\u91cf\u6570\u636e\u672c\u8eab\u5c31\u88ab\u201c\u8fb9\u7f18\u5316\u201d\u6216\u4e22\u5f03\uff0c\u53ef\u80fd\u5bfc\u81f4\u4fe1\u606f\u635f\u5931\u3002 \u76f4\u63a5\u4e14\u5145\u5206\u5229\u7528\u5728\u4f18\u5316\u7a97\u53e3\u5185\u7684\u6240\u6709\u5386\u53f2\u72b6\u6001\u548c\u6d4b\u91cf\u503c\u90fd\u4f1a\u88ab\u540c\u65f6\u8003\u8651\u3002\u672a\u6765\u7684\u89c2\u6d4b\u53ef\u4ee5\u7528\u6765\u4fee\u6b63\u7a97\u53e3\u5185\u8fc7\u53bb\u7684\u4f4d\u59ff\uff0c\u4fe1\u606f\u5229\u7528\u66f4\u5145\u5206\u3002 \u8ba1\u7b97\u590d\u6742\u5ea6 \u8f83\u4f4e\u4e14\u7a33\u5b9a\u6bcf\u4e2a\u65f6\u95f4\u6b65\u7684\u8ba1\u7b97\u91cf\u76f8\u5bf9\u56fa\u5b9a\uff0c\u901a\u5e38\u4e0e\u72b6\u6001\u5411\u91cf\u7684\u7ef4\u5ea6\u76f8\u5173\u3002\u975e\u5e38\u9002\u5408\u8ba1\u7b97\u8d44\u6e90\u53d7\u9650\u7684\u5d4c\u5165\u5f0f\u8bbe\u5907\u3002 \u8f83\u9ad8\u4e14\u53ef\u53d8\u8ba1\u7b97\u91cf\u4e0e\u4f18\u5316\u7a97\u53e3\u7684\u5927\u5c0f\u76f4\u63a5\u76f8\u5173\uff0c\u7a97\u53e3\u8d8a\u5927\uff0c\u8ba1\u7b97\u8d8a\u590d\u6742\u3002\u901a\u5e38\u91c7\u7528\u201c\u6ed1\u52a8\u7a97\u53e3\u201d\u7b56\u7565\uff0c\u53ea\u4f18\u5316\u6700\u8fd1\u7684\u4e00\u90e8\u5206\u72b6\u6001\u4ee5\u4fdd\u8bc1\u5b9e\u65f6\u6027\u3002 \u7cbe\u5ea6 \u76f8\u5bf9\u8f83\u4f4e\u53d7\u9650\u4e8e\u7ebf\u6027\u5316\u8bef\u5dee\u3002EKF \u53ea\u5728\u5f53\u524d\u72b6\u6001\u70b9\u8fdb\u884c\u4e00\u6b21\u7ebf\u6027\u5316\uff0c\u8bef\u5dee\u4f1a\u968f\u7740\u65f6\u95f4\u7d2f\u79ef\uff0c\u5bfc\u81f4\u6f02\u79fb\u3002 \u76f8\u5bf9\u8f83\u9ad8\u901a\u8fc7\u591a\u6b21\u8fed\u4ee3\u6c42\u89e3\u975e\u7ebf\u6027\u95ee\u9898\uff0c\u53ef\u4ee5\u5728\u65b0\u7684\u4f30\u8ba1\u70b9\u53cd\u590d\u7ebf\u6027\u5316\uff0c\u7cbe\u5ea6\u66f4\u9ad8\u3002 \u5904\u7406\u975e\u7ebf\u6027\u7684\u80fd\u529b \u8f83\u5f31EKF \u7684\u5355\u6b21\u7ebf\u6027\u5316\u5047\u8bbe\u5728\u5f3a\u975e\u7ebf\u6027\u8fd0\u52a8\u4e2d\u53ef\u80fd\u5931\u6548\u3002 \u8f83\u5f3a\u8fed\u4ee3\u4f18\u5316\u80fd\u66f4\u597d\u5730\u5904\u7406\u7cfb\u7edf\u975e\u7ebf\u6027\u3002 \u9c81\u68d2\u6027\u4e0e\u6269\u5c55\u6027 \u76f8\u5bf9\u8f83\u5dee\u6dfb\u52a0\u65b0\u7684\u7ea6\u675f\uff08\u5982 GPS\u3001\u56de\u73af\u68c0\u6d4b\uff09\u76f8\u5bf9\u590d\u6742\u3002 \u76f8\u5bf9\u8f83\u597d\u6846\u67b6\u7075\u6d3b\uff0c\u6dfb\u52a0\u65b0\u7ea6\u675f\u901a\u5e38\u7b49\u540c\u4e8e\u5728\u56fe\u4e2d\u589e\u52a0\u65b0\u7684\u201c\u56e0\u5b50\u201d\uff0c\u5982\u56de\u73af\u7ea6\u675f\u3001GPS \u56e0\u5b50\u7b49\u3002 \u5178\u578b\u4ee3\u8868\u7b97\u6cd5 MSCKF (Multi-State Constraint Kalman Filter), ROVIO, EKF-VINS OKVIS, VINS-Mono, ORB-SLAM3, LVI-SAM <ul> <li>VINS-Mono \u57fa\u672c\u53ef\u4ee5\u5206\u6210\u4e09\u90e8\u5206\uff1aloop closure, pose-graph optimization, and map-merging</li> </ul> <ul> <li>VIO \u63d0\u4f9b\u9ad8\u9891\u7387\u3001\u9ad8\u7cbe\u5ea6\u7684\u5c40\u90e8\u8fd0\u52a8\u4f30\u8ba1\u3002</li> <li>\u56de\u73af\u68c0\u6d4b\u8d1f\u8d23\u8bc6\u522b\u5168\u5c40\u91cd\u590d\u573a\u666f\uff0c\u63d0\u4f9b\u5168\u5c40\u7684\u5f3a\u7ea6\u675f\u3002</li> <li>\u4f4d\u59ff\u56fe\u4f18\u5316\u5229\u7528\u8fd9\u4e9b\u5168\u5c40\u7ea6\u675f\uff0c\u5c06\u5c40\u90e8\u8bef\u5dee\u8fdb\u884c\u5168\u5c40\u5e73\u6ed1\u4f18\u5316\uff0c\u6d88\u9664\u7d2f\u79ef\u6f02\u79fb\u3002</li> <li>\u5730\u56fe\u878d\u5408\u5219\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u5c06\u7cfb\u7edf\u4ece\u5355\u6b21\u5efa\u56fe\u6269\u5c55\u5230\u591a\u4f1a\u8bdd/\u591a\u673a\u5668\u4eba\u573a\u666f\uff0c\u5b9e\u73b0\u771f\u6b63\u5927\u89c4\u6a21\u3001\u53ef\u91cd\u7528\u7684\u5730\u56fe\u6784\u5efa\u3002   \u8fd9\u90e8\u5206\u4f1a\u6839\u636e\u6587\u7ae0\u80cc\u666f\uff0c\u628a\u4e00\u4e9b\u9700\u8981\u4e86\u89e3\u7684\u6982\u5ff5\u7a0d\u5fae\u5c55\u5f00\u8bb2\u4e00\u4e0b\u3002</li> </ul>"},{"location":"paperreadings/activeslam/PL-VINS/#method","title":"Method","text":"<p>PL-VINS \u5206\u4e3a\u4e09\u4e2a\u7ebf\u7a0b\uff1a</p> <ul> <li> <p>Measurement Preprocessing\uff1a\u68c0\u6d4b\u3001\u8ddf\u8e2a\u3001\u63d0\u53d6\u7279\u5f81+IMU \u9884\u79ef\u5206</p> </li> <li> <p>Point Features\uff1a\u4f7f\u7528 shi-tomasi \u68c0\u6d4b KLT \u5149\u6d41\u6cd5\u8fdb\u884c\u8ddf\u8e2a\uff0c\u57fa\u4e8e RANSAC \u7684\u8868\u73b0\u51e0\u4f55\u7ea6\u675f\u8bc6\u522b inliers</p> </li> <li>Line Features\uff1a\u4fee\u6539\u540e\u7684 LSD \u63d0\u53d6\u7ebf\u7279\u5f81\u7136\u540e\u7531 LBD \u63cf\u8ff0\u8be5\u884c\u7279\u5f81\uff0c\u5e76\u901a\u8fc7 KNN \u5339\u914d\u3002</li> <li> <p>IMU Pre-integration\uff1a\u4ecd\u4f7f\u7528 VINS-Mono \u7684\u65b9\u6cd5</p> </li> <li> <p>Local Visual-Inertial Odometry</p> </li> <li> <p>\u9996\u5148\uff0c\u901a\u8fc7\u5c06\u5e27\u4e4b\u95f4\u7684 2D \u70b9\u548c\u884c\u7279\u5f81\u5bf9\u5e94\u5173\u7cfb\u8fdb\u884c\u4e09\u89d2\u6d4b\u91cf\uff0c\u5c06\u91cd\u5efa\u7a7a\u95f4\u70b9\u548c\u7ebf\u3002\u7a7a\u95f4\u70b9\u901a\u8fc7\u53cd\u6df1\u5ea6\u53c2\u6570\u5316\uff0c\u800c\u7a7a\u95f4\u7ebf\u901a\u8fc7 PLU\u0308CKER \u5750\u6807\u8fdb\u884c\u4e86\u53c2\u6570\u5316\u3002</p> </li> <li> <p>\u63a5\u4e0b\u6765\uff0c\u91c7\u7528\u56fa\u5b9a\u5927\u5c0f\u7684\u6ed1\u52a8\u7a97\u53e3\u901a\u8fc7\u6700\u5c0f\u5316\u6b8b\u5dee\u627e\u5230\u6700\u4f73\u72b6\u6001\u77e2\u91cf\uff0c\u5305\u62ec\u59ff\u52bf\uff0c\u901f\u5ea6\uff0c\u7a7a\u95f4\u70b9\u548c\u7ebf\uff0c\u52a0\u901f\u5ea6\u548c\u9640\u87ba\u4eea\u504f\u7f6e\u3002\u5f53\u65b0\u5e27\u5230\u8fbe\u65f6\uff0c\u6211\u4eec\u5c06\u6ed1\u52a8\u7a97\u53e3\u4e2d\u7684\u6700\u540e\u4e00\u4e2a\u5e27\u8fb9\u7f18\u5316\u4ee5\u4fdd\u6301\u7a97\u53e3\u5927\u5c0f\u3002</p> </li> <li> <p>Loop Closure</p> </li> <li> <p>PL-VINS \u5224\u5b9a\u5f53\u524d\u5e27\u662f\u5426\u4e3a\u5bc6\u94a5\u5e27\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u5f53\u524d\u5e27\u548c\u6700\u540e\u4e00\u4e2a\u5173\u952e\u5e27\u4e4b\u95f4\u7684\u89c6\u5dee\u5927\u4e8e\u4e00\u5b9a\u9608\u503c\u6216\u8ddf\u8e2a\u7279\u5f81\u70b9\u7684\u6570\u91cf\u5c0f\u4e8e\u67d0\u4e2a\u9608\u503c\u3002</p> </li> <li>\u4e00\u65e6\u88ab\u8bc6\u522b\u4e3a\u5173\u952e\u5e27\uff0cloop closure \u7ebf\u7a0b\u542f\u52a8\u53bb\u641c\u7d22\u5e76\u51b3\u5b9a\u662f\u5426\u5b58\u5728\u95ed\u73af\u3002</li> </ul> <p></p>"},{"location":"paperreadings/activeslam/PL-VINS/#line-feature-fusion","title":"Line feature fusion","text":"<ul> <li> <p>\u73b0\u6709\u7684 LSD \u662f\u4e3a\u573a\u666f\u5f62\u72b6\u8868\u793a\u8bbe\u8ba1\u7684\uff0c\u4e0d\u80fd\u8f83\u597d\u5730\u9002\u7528\u4e0e\u59ff\u6001\u4f30\u8ba1\u95ee\u9898\uff0cPL-VINS \u9996\u5148\u901a\u8fc7\u7814\u7a76 LSD \u9690\u85cf\u7684\u53c2\u6570\u8c03\u6574\u6765\u7b80\u5316\u7ebf\u8def\u7279\u5f81\u68c0\u6d4b\uff0c\u7136\u540e\u901a\u8fc7\u957f\u5ea6\u62d2\u7edd\u7b56\u7565\u6765\u6ee4\u9664\u77ed\u7ebf\u7279\u5f81\u3002</p> </li> <li> <p>LSD \u7b97\u6cd5</p> </li> <li> <p>\u4f7f\u7528 n-layer Gaussian \u91d1\u5b57\u5854\u6765\u521b\u5efa\u591a\u5c3a\u5ea6\u8868\u793a\uff0c\u5176\u4e2d\u539f\u59cb\u56fe\u50cf\u4ee5\u56fa\u5b9a\u6bd4\u7387 R \u548c\u9ad8\u65af\u6ee4\u6ce2\u5668\u6a21\u7cca\u4e3a n \u6b21\uff0c\u5c06\u539f\u59cb\u56fe\u50cf\u5012\u7f6e\u4e3a n-1 \u6b21\u3002OpenCV \u8bbe\u8ba1\u56fe\u50cf\u6bd4\u4f8b\u53c2\u6570 \\(s =(0,1\\]\\) \u4ee5\u6269\u5c55\u6bcf\u4e00\u5c42\u7684\u56fe\u50cf\u3002</p> </li> <li>\u5c06\u6bcf\u5f20\u56fe\u7247\u5206\u533a\uff0c\u4fdd\u8bc1\u6bcf\u4e2a\u533a\u57df\u5185\u7684\u50cf\u7d20\u68af\u5ea6\u65b9\u5411\u76f8\u4f3c\uff0c\u6bcf\u4e2a\u533a\u57df\u8fd1\u4f3c\u662f\u4e2a\u77e9\u5f62\uff0c\u4ece\u800c LSD \u5c06\u6700\u5c0f\u5bc6\u5ea6\u9608\u503c d \u5b9a\u4e49\u4e3a\u62d2\u7edd\u7ebf\u8def\u7279\u5f81\uff1a\u77e9\u5f62\u4e2d\u5bf9\u9f50\u70b9\u7684\u6570\u91cf\u9700\u8981\u5c0f\u4e8e\u9608\u503c</li> <li> <p>s \u548c d \u53c2\u6570\u5bf9\u51cf\u5c11\u68c0\u6d4b\u65f6\u95f4\u81f3\u5173\u91cd\u8981 </p> </li> <li> <p>\u957f\u5ea6\u62d2\u7edd\u7b56\u7565\uff1a\u4f7f\u7528\u6700\u5c0f\u957f\u5ea6\u9608\u503c \\(L\\_{min}\\) \u62d2\u7edd\u77ed\u7ebf\u7279\u5f81\uff0c\\(W_I\\)\u548c\\(H_I\\)\u5206\u522b\u662f\u8f93\u5165\u56fe\u50cf\u7684\u5bbd\u548c\u9ad8   $$   L_{min} = \\left\\lceil \\eta \\cdot min(W_I, H_I) \\right\\rceil   $$</p> </li> <li> <p>\u5904\u7406 line tracking \u7684\u5f02\u5e38\u503c</p> </li> <li> <p>KNN \u8ba1\u7b97\u7684\u9524\u8ddd\u79bb\u9700\u8981\u8d85\u8fc7 30</p> </li> <li> <p>\u5339\u914d\u7ebf\u4e4b\u95f4\u7684\u89d2\u5ea6\u5fc5\u987b\u5c0f\u4e8e 0.1 rad</p> </li> <li> <p>Space Lines</p> </li> <li> <p>\u4f7f\u7528 Pl\u00fccker \u5750\u6807\u6765\u8868\u793a\u7a7a\u95f4\u7ebf</p> </li> <li> <p>\u4f18\u5316\u65f6\u4f7f\u7528\u6b63\u4ea4\u8868\u793a\u51cf\u5c11\u8ba1\u7b97\u91cf</p> </li> <li> <p>Line Reprojection Residual Model</p> </li> <li> <p>\u9996\u5148\uff0c\u6211\u4eec\u5b9a\u4e49\u7ebf\u7684\u51e0\u4f55\u53d8\u6362\u3002\u7ed9\u5b9a\u4e00\u4e2a\u4ece\u4e16\u754c\u5750\u6807\u7cfb\uff08\u7528\u4e0b\u6807 w \u8868\u793a\uff09\u5230\u76f8\u673a\u5750\u6807\u7cfb\uff08\u7528\u4e0b\u6807 c \u8868\u793a\uff09\u7684\u53d8\u6362\u77e9\u9635 \\(T\\_{cw}\\)\uff0c\u5b83\u7531\u65cb\u8f6c\u77e9\u9635 \\(R\\_{cw}\\) \u548c\u5e73\u79fb\u5411\u91cf \\(t\\_{cw}\\) \u7ec4\u6210\u3002\u5229\u7528\u8fd9\u4e2a\u77e9\u9635\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4e16\u754c\u5750\u6807\u7cfb\u4e2d\u7684 3D \u7a7a\u95f4\u76f4\u7ebf \\(L\\_{w}\\) \u53d8\u6362\u5230\u76f8\u673a\u5750\u6807\u7cfb\u4e2d\u3002</p> </li> <li>\u6295\u5f71\u77e9\u9635: \\(K_L\\)\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u201c\u7ebf\u6295\u5f71\u77e9\u9635\u201d\uff0c\u5b83\u4f9d\u8d56\u4e8e\u76f8\u673a\u7684\u5185\u53c2\uff08\u5982\u7126\u8ddd\u548c\u4e3b\u70b9\uff093D \u76f4\u7ebf\u7684\u6295\u5f71\u53ea\u4f9d\u8d56\u4e8e\u5176\u666e\u5415\u514b\u5750\u6807\u4e2d\u7684\u77e9\u5411\u91cf \\(n_c\\)\uff0c\u5373     $$     l = [l_1,l_2,l_3]^T = K_Ln_c     $$</li> <li> <p>\u6211\u4eec\u6765\u5b9a\u4e49\u7ebf\u7684\u91cd\u6295\u5f71\u8bef\u5dee\u3002\u5047\u8bbe \\(L_w\\)\u662f\u7a7a\u95f4\u4e2d\u7684\u7b2c j \u6761 3D \u76f4\u7ebf\uff0c\u5b83\u5728\u7b2c i \u5e27\u76f8\u673a\u56fe\u50cf\u4e2d\u88ab\u89c2\u6d4b\u5230\u3002</p> </li> <li> <p>\u4f7f\u7528\u70b9\uff0c\u7ebf\u548c IMU \u7684\u6ed1\u52a8\u7a97\u53e3\u4f18\u5316</p> </li> <li> <p>\u4f7f\u7528 \u975e\u7ebf\u6027\u6700\u5c0f\u4e8c\u4e58\u4f18\u5316\uff08\u5982 Ceres Solver\u3001g2o\u3001\u6216 VINS-Mono \u81ea\u5e26\u7684\u4f18\u5316\u5668\uff09\uff0c\u901a\u8fc7\u8fed\u4ee3\u66f4\u65b0\u76f8\u673a\u72b6\u6001 \\(\\\\mathcal{X}\\)\uff08\u4f4d\u59ff\u3001\u901f\u5ea6\u3001IMU bias\u3001\u7279\u5f81\u53c2\u6570\uff09\uff0c\u9010\u6b65\u51cf\u5c0f\u603b\u6b8b\u5dee\u3002</p> <p></p> </li> <li> <p>\u7ebf\u6b8b\u5dee\u8ba1\u7b97</p> <ul> <li>\u6700\u5c0f\u5316\u89c2\u6d4b\u5230\u7684 2D \u76f4\u7ebf\u7279\u5f81 \u548c\u5f53\u524d\u4f30\u8ba1\u7684 \u6295\u5f71\u76f4\u7ebf \u4e4b\u95f4\u7684\u51e0\u4f55\u6b8b\u5dee\u3002</li> <li>\\((i,j)\\\\in \\\\mathcal{L}\\)\uff1a\u8868\u793a\u7b2c j \u6761\u7a7a\u95f4\u76f4\u7ebf \\(L_j\\) \u5728\u7b2c i \u5e27\u76f8\u673a\u56fe\u50cf\u4e2d\u88ab\u89c2\u6d4b\u5230\u3002</li> </ul> \\[ \\\\left{ \\\\begin{aligned} \\\\mathbf{e}_{\\\\text{line}} &amp;= \\\\sum_{(i,j) \\\\in \\\\mathcal{L}} \\\\rho \\\\left( \\\\left| \\\\mathbf{r}_{\\\\mathcal{L}}!\\\\left( \\\\mathbf{z}_{\\\\mathcal{L}_j}^{c_i}, \\\\mathcal{X} \\\\right) \\\\right|^2_ {\\\\Sigma\\_{\\\\mathcal{L}\\_j}^{c_i}} \\\\right) \\\\[8pt] \\\\rho(s) &amp;= \\\\begin{cases} s, &amp; s \\\\leq 1 \\\\ 2\\\\sqrt{s} - 1, &amp; s &gt; 1 \\\\end{cases} \\\\end{aligned} \\\\right. \\] </li> </ul>"},{"location":"paperreadings/activeslam/PL-VINS/#_2","title":"\u5b9e\u9a8c/\u8bc4\u4f30/\u7ed3\u679c","text":"<ul> <li>\u5b9e\u9a8c\u73af\u5883\uff1alow-power Intel Core i7-10710U CPU @1.10 GHz, Ubuntu 18.04, ROS Melodic</li> <li>\u5728\u57fa\u51c6\u6570\u636e\u96c6 EuRoc \u4e0a\u7684\u5b9a\u4f4d\u51c6\u786e\u6027\u548c\u5b9e\u65f6\u6027\u3002</li> </ul>"},{"location":"paperreadings/activeslam/PL-VINS/#accuracy-comparison","title":"Accuracy Comparison","text":"<p>evaluated by the root mean square error (RMSE) of the absolute trajectory error (ATE) and the relative pose error (RPE)</p> <ul> <li>\u591a\u6570\u60c5\u51b5\u4e0b\uff0cPL-VINS \u7684\u8bef\u5dee\u8981\u66f4\u5c0f</li> <li>\u95ed\u73af( loop )\u662f\u6d88\u9664\u7d2f\u79ef\u8bef\u5dee\u7684\u5fc5\u8981\u6b65\u9aa4\u3002</li> </ul>"},{"location":"paperreadings/activeslam/PL-VINS/#_3","title":"\u7ed3\u8bba","text":"<p>\u4e3b\u8981\u4fee\u6539\u4e86 LSD \u7684\u53c2\u6570\u5e76\u901a\u8fc7\u8bbe\u7f6e\u9608\u503c\u7684\u65b9\u5f0f\u8fc7\u6ee4\u6389\u77ed\u7ebf\u6bb5\u52a0\u901f\u8ba1\u7b97\u3002\u5c06\u7ebf\u7279\u5f81\u7528\u666e\u5415\u514b\u5750\u6807\u8868\u793a\uff0c\u5e76\u5c06\u7ebf\u7279\u5f81\u7684\u91cd\u6295\u5f71\u8bef\u5dee\u52a0\u5165\u5230\u6ed1\u52a8\u7a97\u53e3\u4f18\u5316\u4e2d\u3002\u5b9e\u9a8c\u8868\u660e\u5728 EuRoc \u6570\u636e\u96c6\u4e0a\uff0cPL-VINS \u5728\u51c6\u786e\u6027\u548c\u5b9e\u65f6\u6027\u4e0a\u5747\u4f18\u4e8e VINS-Mono\u3002</p> <p>\u4f46\u662f\u7ebf\u7279\u5f81\u7ea6\u675f\u5e76\u6ca1\u6709\u52a0\u5165 loop closure \u4e2d\u3002\u540c\u65f6\u5e27\u4e0e\u5e27\u4e4b\u95f4\u67d0\u4e9b\u7ebf\u7279\u5f81\u4f1a\u88ab\u5ffd\u7565\uff0c\u53ef\u4ee5 VINS \u7cfb\u7edf\u5efa\u7acb\u5e76\u7ef4\u62a4\u4e00\u4e2a\u7531\u7a7a\u95f4\u7ebf\u7ec4\u6210\u7684\u5c40\u90e8\u5730\u56fe\u6a21\u578b\uff0c\u7136\u540e\u5728\u5f53\u524d\u5e27\u548c\u5730\u56fe\u6a21\u578b\u4e4b\u95f4\u5efa\u7acb\u7ebf\u5bf9\u5e94\u5173\u7cfb\uff0c\u4ee5\u5229\u7528\u5ffd\u7565\u7684\u7ebf\u7279\u5f81</p>"},{"location":"paperreadings/activeslam/PL-VINS/#_4","title":"\u603b\u7ed3","text":"<p>\u2b50 \u6211\u4ee5\u4e3a LSD \u7b97\u6cd5\u4fee\u6539\u662f\u4fee\u6539\u4e86\u7b97\u6cd5\u7ec6\u8282\uff0c\u5b9e\u9645\u4e0a\u8fd9\u7bc7\u8bba\u6587\u53ea\u662f\u8c03\u6574\u4e86\u4e24\u4e2a\u53c2\u6570\uff0c\u5e76\u4e14\u589e\u52a0\u4e86\u4e00\u4e2a\u957f\u5ea6\u9608\u503c\u6765\u8fc7\u6ee4\u77ed\u7ebf\u6bb5\u3002LSD \u7b97\u6cd5\u672c\u8eab\u5e76\u6ca1\u6709\u6539\u52a8\u3002\u53ef\u80fd\u7684\u521b\u65b0\u662f\u5c06\u7ebf\u6bb5\u8868\u793a\u4e3a\u666e\u5415\u514b\u5750\u6807\uff0c\u51cf\u5c0f\u8bef\u5dee\u548c\u8ba1\u7b97\u91cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u7ebf\u7279\u5f81\u7684\u7ea6\u675f\u4e5f\u5e76\u672a\u52a0\u5165\u5230 loop closure \u4e2d\u3002</p> <p> \u603b\u4f53\u6765\u8bf4\uff0c\u8fd9\u7bc7\u8bba\u6587\u5e76\u6ca1\u6709\u4ec0\u4e48\u72ec\u7279\u7684\u521b\u65b0\u70b9\uff0c\u53ea\u662f\u5728 VINS-Mono \u7684\u57fa\u7840\u4e0a\u589e\u52a0\u4e86\u7ebf\u7279\u5f81\uff08PL-VIO \u53ef\u80fd\u624d\u662f\u9996\u521b\uff09\u5e76\u636e\u6b64\u8fdb\u884c\u90e8\u5206\u7684\u5b9e\u65f6\u4f18\u5316\u3002</p>"},{"location":"paperreadings/activeslam/active%20slam/","title":"Active SLAM \u6982\u8ff0","text":""},{"location":"paperreadings/activeslam/active%20slam/#active-slam","title":"Active Slam","text":"<p> \u7ea6 958 \u4e2a\u5b57  30 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"paperreadings/activeslam/active%20slam/#overview","title":"Overview","text":"<p>Active Slam \u7684\u5de5\u4f5c\u6d41\u7a0b:</p> <ul> <li>Perception: \u4f20\u611f\u5668\u6570\u636e\u83b7\u53d6\u4e0e\u9884\u5904\u7406</li> <li>SLAM(Localization + Mapping + Loop Closure)</li> <li>Candidate Generation: \u751f\u6210\u5019\u9009\u89c2\u6d4b\u70b9(frontiers/viewpoints)</li> <li>Evaluator: \u5bf9\u6bcf\u4e2a\u5019\u9009\u4f30\u7b97\uff1a\u9884\u671f\u4fe1\u606f\u589e\u76ca\uff08raycast / mutual information / belief propagation\uff09\u3001\u6267\u884c\u4ee3\u4ef7\uff08\u8def\u5f84\u957f\u5ea6\u3001\u80fd\u8017\uff09\u3001\u5b9a\u4f4d\u98ce\u9669\uff08\u534f\u65b9\u5dee\u589e\u957f\uff09\u3001\u78b0\u649e\u98ce\u9669\u3002</li> <li>Planner: \u77ed\u671f\u6267\u884c\u76ee\u6807\u6216\u63a7\u5236\u5e8f\u5217\uff08\u901a\u5e38\u53ea\u6267\u884c\u7b2c\u4e00\u6b65\u6216\u9996\u6bb5\uff0c\u968f\u540e\u91cd\u65b0\u8bc4\u4f30\uff09</li> <li>Controller: \u4f4e\u7ea7\u8fd0\u52a8\u63a7\u5236\u4e0e\u907f\u969c</li> <li>Monitor &amp; Replan: \u76d1\u63a7\u6267\u884c\u72b6\u6001\uff0c\u82e5\u51fa\u73b0\u610f\u5916\uff08\u65b0\u969c\u788d\u3001\u5b9a\u4f4d\u4e0d\u786e\u5b9a\u6027\u8fc7\u5927\u7b49\uff09\u5219\u91cd\u65b0\u89c4\u5212</li> </ul> Python<pre><code>while not exploration_done:  # we have stop standards\n    obs = read_sensors()  # RGB_D, Lidar, IMU, etc.\n    pose, map, cov = SLAM.update(obs)  # state estimation + loop closure + mapping\n    candidates = CandidateGenerator(map, pose)  # viewpoints\n    scores = Evaluator(candidates, map, cov)  # info gain - lambda * cost\n    plan = Planner.select_and_plan(candidates, scores)  # A*(global) + local planner\n    execute_first_phase(plan)  # Controller + obstacle replan + Monitor\n</code></pre> <p> \u4f55\u65f6\u505c\u6b62\u63a2\u7d22\uff1f</p> <ul> <li> <p>\u65e0\u65b0\u524d\u6cbf (No New Frontiers)\uff1a \u6700\u5e38\u89c1\u7684\u7ec8\u6b62\u6761\u4ef6\u662f\u5f53\u63a2\u7d22\u7b97\u6cd5\u518d\u4e5f\u65e0\u6cd5\u5728\u5730\u56fe\u4e2d\u627e\u5230\u4efb\u4f55\u5df2\u77e5\u7a7a\u95f4\u4e0e\u672a\u77e5\u7a7a\u95f4\u7684\u8fb9\u754c\uff08\u5373\u201c\u524d\u6cbf\u201d\uff09\u65f6\uff0c\u7cfb\u7edf\u4f1a\u5224\u5b9a\u63a2\u7d22\u5df2\u5b8c\u6210\u5e76\u505c\u6b62 \u3002</p> </li> <li> <p>\u8986\u76d6\u7387\u9608\u503c (Coverage Threshold)\uff1a \u89c4\u5212\u5668\u53ef\u4ee5\u88ab\u8bbe\u5b9a\u4e00\u4e2a\u76ee\u6807\uff0c\u4f8b\u5982\u5f53\u5df2\u5efa\u56fe\u533a\u57df\u8fbe\u5230\u9884\u5b9a\u73af\u5883\u603b\u4f53\u79ef\u7684 95%\u65f6\uff0c\u4efb\u52a1\u7ec8\u6b62 \u3002</p> </li> <li> <p>\u9884\u7b97\u8017\u5c3d (Budget Depletion)\uff1a \u53ef\u4ee5\u7ed9\u673a\u5668\u4eba\u8bbe\u7f6e\u660e\u786e\u7684\u201c\u9884\u7b97\u201d\uff08\u5982\u8def\u5f84\u957f\u5ea6\u6216\u7eed\u822a\u65f6\u95f4\uff09\u3002\u5f53\u8fd9\u4e2a\u9884\u7b97\u88ab\u5b8c\u5168\u6d88\u8017\u65f6\uff0c\u4efb\u52a1\u81ea\u7136\u7ec8\u6b62 \u3002</p> </li> <li> <p>\u4eba\u5de5\u5e72\u9884 (Manual Intervention)\uff1a \u5728\u5b9e\u9645\u90e8\u7f72\u4e2d\uff0c\u64cd\u4f5c\u5458\u53ef\u4ee5\u968f\u65f6\u901a\u8fc7\u8fdc\u7a0b\u6307\u4ee4\u7ec8\u6b62\u4efb\u52a1\uff0c\u4f8b\u5982\u5f53\u4ed6\u4eec\u5bf9\u5730\u56fe\u7684\u5b8c\u6574\u6027\u548c\u7cbe\u5ea6\u611f\u5230\u6ee1\u610f\u65f6</p> </li> </ul>"},{"location":"paperreadings/activeslam/active%20slam/#active-planning","title":"Active Planning","text":"<p>\u9009\u62e9\u6700\u4f18\u52a8\u4f5c/\u8def\u5f84\uff0c\u5e73\u8861\u4fe1\u606f\u589e\u76ca\u4e0e\u4ee3\u4ef7\u3002</p> <ul> <li>\u57fa\u4e8e\u8fb9\u754c\u7684\u7b56\u7565</li> <li>\u57fa\u4e8e\u91c7\u6837\u6216\u4f18\u5316\u7684\u7b56\u7565</li> <li>\u57fa\u4e8e Reinforcement Learning \u7684\u7b56\u7565</li> </ul>"},{"location":"paperreadings/activeslam/active%20slam/#frontier-based-exploration","title":"Frontier-based Exploration","text":"<ul> <li> <p>\u83b7\u53d6\u5df2\u77e5-\u672a\u77e5\u7684\u4ea4\u754c\u70b9\u4f5c\u4e3a\u5019\u9009\u76ee\u6807</p> </li> <li> <p>raycast:   \u4ece\u5019\u9009\u89c2\u6d4b\u70b9\uff08viewpoint\uff09\u51fa\u53d1\uff0c\u5411\u5404\u4e2a\u65b9\u5411\u53d1\u5c04\u5c04\u7ebf\uff08rays\uff09\uff0c\u6a21\u62df\u4f20\u611f\u5668\u7684\u89c6\u7ebf\uff1b\u5c04\u7ebf\u4f1a\u7a7f\u8fc7\u5360\u636e\u6805\u683c\u5730\u56fe\uff08occupancy grid\uff09\uff0c\u76f4\u5230\uff1a</p> </li> </ul> <ol> <li> <p>\u78b0\u5230\u969c\u788d\u7269\uff08occupied cell\uff09</p> </li> <li> <p>\u8fbe\u5230\u4f20\u611f\u5668\u6700\u5927\u63a2\u6d4b\u8ddd\u79bb\uff08sensor range\uff09</p> </li> </ol> <p>\u5728\u5c04\u7ebf\u7a7f\u8fc7\u7684\u6805\u683c\u4e2d\uff0c\u7edf\u8ba1\u90a3\u4e9b\u5f53\u524d\u5730\u56fe\u4e2d\u6807\u8bb0\u4e3a unknown\uff08\u672a\u63a2\u7d22\uff09 \u7684\u5355\u5143\u683c\u6570\u91cf\uff1b</p> <p>\u8fd9\u4e9b\u672a\u77e5\u683c\u5b50\u7684\u6570\u91cf\u5c31\u4ee3\u8868\uff1a\u4ece\u8be5 viewpoint \u51fa\u53d1\u53ef\u4ee5\u770b\u5230\u591a\u5c11\u672a\u77e5\u533a\u57df</p> Python<pre><code>loop:\n  update_map_with_SLAM() # state estimation + loop closure + mapping\n  frontiers = detect_frontiers(map) # detect frontiers\n  clusters = cluster_frontiers(frontiers) # group nearby frontiers\n  for each cluster:\n    I = estimate_information_gain(cluster)   # raycast / unknown cell count\n    C = travel_cost(robot_pose, cluster.centroid) # cost function\n    score = I - lambda * C # get low cost and high info gain\n  goal = argmax(score)\n  plan_path = global_planner(robot_pose, goal) # A* / Dijkstra / etc.\n  execute_path(plan_path)  # local controller + obstacle replan\n  if new_info or localization_uncertain: continue loop\n</code></pre> <ul> <li> <p>\u4f18\u70b9</p> </li> <li> <p>\u7b80\u5355\u9ad8\u6548\uff1a\u5b9e\u73b0\u7b80\u5355\u3001\u5b9e\u65f6\u6027\u5f3a\uff0c\u5e7f\u6cdb\u5e94\u7528\u4e8e 2D \u5ba4\u5185\u73af\u5883\u3002</p> </li> <li> <p>\u65e0\u9700\u5168\u5c40\u6a21\u578b\uff1a\u76f4\u63a5\u57fa\u4e8e\u5c40\u90e8\u5730\u56fe\u548c\u8fb9\u754c\u4fe1\u606f\uff0c\u8ba1\u7b97\u4ee3\u4ef7\u8f83\u4f4e\u3002</p> </li> <li> <p>\u6e10\u8fdb\u5f0f\u63a2\u7d22\uff1a\u968f\u7740\u5730\u56fe\u6269\u5c55\u81ea\u7136\u8fdb\u884c\uff0c\u9002\u5408\u589e\u91cf\u5f0f SLAM \u6846\u67b6\u3002</p> </li> <li> <p>\u5c40\u9650\u6027</p> </li> <li> <p>\u77ed\u89c6\uff08Myopic\uff09\uff1a\u6bcf\u6b21\u53ea\u5173\u6ce8\u5f53\u524d\u6700\u6709\u4fe1\u606f\u589e\u76ca\u7684\u8fb9\u754c\uff0c\u800c\u4e0d\u8003\u8651\u5168\u5c40\u63a2\u7d22\u6548\u7387\u3002</p> </li> <li> <p>\u5bb9\u6613\u9677\u5165\u5c40\u90e8\u6700\u4f18\uff1a\u53ef\u80fd\u53cd\u590d\u63a2\u7d22\u8fb9\u7f18\u533a\u57df\u6216\u6f0f\u6389\u9690\u853d\u7a7a\u95f4\u3002</p> </li> <li> <p>\u8def\u5f84\u5197\u4f59\uff1a\u9891\u7e41\u7684\u6765\u56de\u79fb\u52a8\uff08\u201c\u4e4b\u201d\u5b57\u5f62\u8def\u5f84\uff09\u589e\u52a0\u80fd\u8017\u4e0e\u65f6\u95f4\u3002</p> </li> <li> <p>\u4fe1\u606f\u589e\u76ca\u4f30\u8ba1\u7c97\u7cd9\uff1a\u4ec5\u57fa\u4e8e\u5730\u56fe\u51e0\u4f55\uff0c\u4e0d\u8003\u8651\u611f\u77e5\u566a\u58f0\u3001\u89c6\u91ce\u906e\u6321\u7b49\u56e0\u7d20\u3002</p> </li> </ul>"},{"location":"paperreadings/activeslam/active%20slam/#sampling-based-exploration","title":"Sampling-based Exploration","text":"<p>\u91c7\u6837\u578b\u65b9\u6cd5\u4e0d\u4f9d\u8d56\u663e\u5f0f frontier\uff0c\u800c\u662f\u5728\u5df2\u77e5\u81ea\u7531\u7a7a\u95f4\u5185\u91c7\u6837\u82e5\u5e72\u89c6\u70b9\uff08pose \u6216 pose+yaw\uff09\uff0c\u8bc4\u4f30\u6bcf\u4e2a\u89c6\u70b9\u7684 \u4fe1\u606f\u589e\u76ca\\(I(v)\\) \u4e0e \u4ee3\u4ef7 \\(C(v)\\)\uff0c\u5e76\u9009\u62e9\u6548\u7528\u51fd\u6570 \\(U(v)=I(v)\u2212\u03bb\u22c5C(v)\\) \u6700\u5927\u7684\u89c6\u70b9\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u76ee\u6807\u3002</p> <ul> <li>\u91c7\u6837\u89c2\u6d4b\u70b9(viewpionts)</li> </ul> Python<pre><code>loop:\n  update_map_with_SLAM() # state estimation + loop closure + mapping\n  candidates = sample_actions_or_goals() # get viewpoints\n  for each candidate:\n    I = estimate_information_gain(cluster)   # raycast / unknown cell count\n    C = travel_cost(robot_pose, cluster.centroid) # cost function\n    score = I - lambda * C # get low cost and high info gain\n  goal = argmax(score)\n  plan_path = global_planner(robot_pose, goal) # A* / Dijkstra / etc.\n  execute_path(plan_path)  # local controller + obstacle replan\n  if new_info or localization_uncertain: continue loop\n</code></pre> <ul> <li> <p>\u4f18\u70b9</p> </li> <li> <p>\u66f4\u7075\u6d3b\uff1a\u80fd\u63a2\u7d22\u590d\u6742\u7a7a\u95f4\uff0c\u4e0d\u4f9d\u8d56\u89c4\u5219\u8fb9\u754c\u3002</p> </li> <li> <p>\u53ef\u6269\u5c55\u6027\u5f3a\uff1a\u80fd\u81ea\u7136\u7ed3\u5408\u6982\u7387\u6a21\u578b\u6216\u5b66\u4e60\u7b56\u7565\u3002</p> </li> <li> <p>\u66f4\u6613\u4e0e\u4fe1\u606f\u7406\u8bba\u6846\u67b6\u7ed3\u5408\uff1a\u652f\u6301\u71b5\u3001\u4e92\u4fe1\u606f\u7b49\u4fe1\u606f\u91cf\u6307\u6807\u3002</p> </li> <li> <p>\u5c40\u9650\u6027</p> </li> <li> <p>\u8ba1\u7b97\u4ee3\u4ef7\u9ad8\uff1a\u6bcf\u8f6e\u90fd\u9700\u5927\u91cf\u91c7\u6837\u4e0e\u4fe1\u606f\u589e\u76ca\u8bc4\u4f30\u3002</p> </li> <li> <p>\u7f3a\u4e4f\u5168\u5c40\u7b56\u7565\uff1a\u4e0e frontier-based \u7c7b\u4f3c\uff0c\u4f9d\u65e7\u662f\u201cgreedy\u201d\u5f0f\u5c40\u90e8\u51b3\u7b56\u3002</p> </li> <li> <p>\u77ed\u89c6\u95ee\u9898\u4f9d\u65e7\uff1a\u4ec5\u4f9d\u636e\u5f53\u524d\u5730\u56fe\u548c\u5373\u65f6\u4fe1\u606f\u589e\u76ca\u9009\u70b9\uff0c\u672a\u8003\u8651\u957f\u8fdc\u8def\u5f84\u6536\u76ca\u3002</p> </li> <li> <p>\u91cd\u590d\u63a2\u7d22\u73b0\u8c61\uff1a\u5bb9\u6613\u7ed5\u8fdc\u8def\u6216\u56de\u5934\u63a2\u7d22\u5df2\u90e8\u5206\u89c2\u6d4b\u533a\u57df\u3002</p> </li> </ul>"},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/","title":"VINS \u57fa\u7840\u77e5\u8bc6","text":"2025-09-262025-12-13 <code>#VINS</code>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#vins","title":"VINS \u57fa\u7840\u77e5\u8bc6","text":"<p> \u7ea6 3814 \u4e2a\u5b57  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 19 \u5206\u949f</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#vins_1","title":"VINS \u5206\u7c7b","text":"<p>VINS \u53ef\u4ee5\u5206\u4e3a filter-based \u548c optimization-based\u3002</p> <ul> <li> <p>\u57fa\u4e8e\u6ee4\u6ce2\u5668 (Filter-based) \u7684\u65b9\u6cd5\uff1a\u5c06 VINS \u770b\u4f5c\u4e00\u4e2a\u5728\u7ebf\u7684\u3001\u9012\u5f52\u7684\u72b6\u6001\u4f30\u8ba1\u95ee\u9898\u3002\u5b83\u50cf\u4e00\u4e2a\u6d41\u6c34\u7ebf\uff0c\u65b0\u7684\u4f20\u611f\u5668\u6570\u636e\uff08\u6d4b\u91cf\u503c\uff09\u6e90\u6e90\u4e0d\u65ad\u5730\u6d41\u5165\uff0c\u6ee4\u6ce2\u5668\u5229\u7528\u8fd9\u4e9b\u65b0\u6570\u636e\u6765\u66f4\u65b0\u5bf9\u5f53\u524d\u65f6\u523b\u72b6\u6001\u7684\u4f30\u8ba1\u3002\u5b83\u4e0d\u56de\u5934\u4fee\u6539\u8fc7\u53bb\u7684\u72b6\u6001</p> </li> <li> <p>\u57fa\u4e8e\u4f18\u5316 (Optimization-based) \u7684\u65b9\u6cd5\uff1a\u5c06 VINS \u770b\u4f5c\u4e00\u4e2a\u6279\u91cf\u5904\u7406\u7684\u975e\u7ebf\u6027\u6700\u5c0f\u4e8c\u4e58\u95ee\u9898\u3002\u5b83\u4f1a\u6536\u96c6\u4e00\u6bb5\u65f6\u95f4\u5185\uff08\u4e00\u4e2a\u201c\u7a97\u53e3\u201d\u6216\u5168\u90e8\u5386\u53f2\uff09\u7684\u6240\u6709\u4f20\u611f\u5668\u6570\u636e\uff0c\u7136\u540e\u5bfb\u627e\u4e00\u6761\u6700\u4f18\u7684\u8f68\u8ff9\uff08\u5305\u542b\u591a\u4e2a\u65f6\u523b\u7684\u59ff\u6001\u3001\u4f4d\u7f6e\u7b49\uff09\uff0c\u4f7f\u5f97\u8fd9\u6761\u8f68\u8ff9\u80fd\u591f\u6700\u597d\u5730\u201c\u89e3\u91ca\u201d\u6240\u6709\u89c2\u6d4b\u5230\u7684\u6570\u636e\u3002</p> </li> <li> <p>Point-based methods\uff1aVINS-Mono\uff0c\u7531\u4e8e\u5bf9\u70b9\u63d0\u53d6\u7684\u4f9d\u8d56\u6027\uff0cT \u53ef\u80fd\u4f1a\u5728\u5145\u6ee1\u6311\u6218\u7684\u573a\u666f\u4e2d\u4ea7\u751f\u4f4e\u4e34\u754c\u6027\u59ff\u52bf\u4f30\u8ba1</p> </li> <li>Point and line-based methods\uff1a\u4f1a\u4e3a\u540e\u9762\u4f18\u5316\u63d0\u4f9b\u989d\u5916\u7684\u7ea6\u675f<ul> <li>\u540c\u65f6\u8ddf\u8e2a\u70b9\u548c\u7ebf\u8def\u7279\u5f81\uff0c\u5e76\u9884\u5148\u6574\u5408 IMU \u6d4b\u91cf\u4fe1\u606f\uff0c\u5305\u62ec\u9640\u87ba\u4eea\u548c\u52a0\u901f\u5ea6\u8ba1</li> <li>\u901a\u8fc7\u8054\u5408\u6700\u5c0f\u5316\u4e0e\u70b9\u7684\u91cd\u6295\u5f71\u3001\u7ebf\u7684\u91cd\u6295\u5f71\u4ee5\u53ca IMU \u6d4b\u91cf\u76f8\u5173\u7684\u4e09\u4e2a\u6b8b\u5dee\u8bef\u5dee\u9879\uff0c\u6765\u5bf9\u76f8\u673a\u7684\u4f4d\u59ff\u8fdb\u884c\u4f30\u8ba1</li> </ul> </li> </ul> \u7279\u6027\u7ef4\u5ea6 \u57fa\u4e8e\u6ee4\u6ce2\u5668 (Filter-based) \u57fa\u4e8e\u4f18\u5316 (Optimization-based) \u6570\u636e\u5904\u7406\u65b9\u5f0f \u5e8f\u8d2f/\u9012\u5f52 (Sequential/Recursive)\u5904\u7406\u5b8c\u4e00\u4e2a\u6d4b\u91cf\u6570\u636e\u5c31\u7acb\u5373\u66f4\u65b0\u5f53\u524d\u72b6\u6001\uff0c\u7136\u540e\u4e22\u5f03\u8fd9\u4e2a\u6570\u636e\u3002 \u6279\u91cf/\u6ed1\u52a8\u7a97\u53e3 (Batch/Sliding Window)\u5c06\u4e00\u6bb5\u65f6\u95f4\u5185\u7684\u6240\u6709\u6d4b\u91cf\u6570\u636e\uff08IMU \u548c\u89c6\u89c9\uff09\u653e\u5728\u4e00\u8d77\uff0c\u8fdb\u884c\u8054\u5408\u4f18\u5316\u3002 \u5bf9\u5386\u53f2\u4fe1\u606f\u7684\u5229\u7528 \u95f4\u63a5\u5229\u7528 / \u4f1a\u9057\u5fd8\u8fc7\u53bb\u7684\u4fe1\u606f\u88ab\u538b\u7f29\u5e76\u4f53\u73b0\u5728\u5f53\u524d\u72b6\u6001\u7684\u5148\u9a8c\u4f30\u8ba1\u548c\u534f\u65b9\u5dee\u77e9\u9635\u4e2d\u3002\u4e00\u65e6\u5904\u7406\u8fc7\uff0c\u65e7\u7684\u6d4b\u91cf\u6570\u636e\u672c\u8eab\u5c31\u88ab\u201c\u8fb9\u7f18\u5316\u201d\u6216\u4e22\u5f03\uff0c\u53ef\u80fd\u5bfc\u81f4\u4fe1\u606f\u635f\u5931\u3002 \u76f4\u63a5\u4e14\u5145\u5206\u5229\u7528\u5728\u4f18\u5316\u7a97\u53e3\u5185\u7684\u6240\u6709\u5386\u53f2\u72b6\u6001\u548c\u6d4b\u91cf\u503c\u90fd\u4f1a\u88ab\u540c\u65f6\u8003\u8651\u3002\u672a\u6765\u7684\u89c2\u6d4b\u53ef\u4ee5\u7528\u6765\u4fee\u6b63\u7a97\u53e3\u5185\u8fc7\u53bb\u7684\u4f4d\u59ff\uff0c\u4fe1\u606f\u5229\u7528\u66f4\u5145\u5206\u3002 \u8ba1\u7b97\u590d\u6742\u5ea6 \u8f83\u4f4e\u4e14\u7a33\u5b9a\u6bcf\u4e2a\u65f6\u95f4\u6b65\u7684\u8ba1\u7b97\u91cf\u76f8\u5bf9\u56fa\u5b9a\uff0c\u901a\u5e38\u4e0e\u72b6\u6001\u5411\u91cf\u7684\u7ef4\u5ea6\u76f8\u5173\u3002\u975e\u5e38\u9002\u5408\u8ba1\u7b97\u8d44\u6e90\u53d7\u9650\u7684\u5d4c\u5165\u5f0f\u8bbe\u5907\u3002 \u8f83\u9ad8\u4e14\u53ef\u53d8\u8ba1\u7b97\u91cf\u4e0e\u4f18\u5316\u7a97\u53e3\u7684\u5927\u5c0f\u76f4\u63a5\u76f8\u5173\uff0c\u7a97\u53e3\u8d8a\u5927\uff0c\u8ba1\u7b97\u8d8a\u590d\u6742\u3002\u901a\u5e38\u91c7\u7528\u201c\u6ed1\u52a8\u7a97\u53e3\u201d\u7b56\u7565\uff0c\u53ea\u4f18\u5316\u6700\u8fd1\u7684\u4e00\u90e8\u5206\u72b6\u6001\u4ee5\u4fdd\u8bc1\u5b9e\u65f6\u6027\u3002 \u7cbe\u5ea6 \u76f8\u5bf9\u8f83\u4f4e\u53d7\u9650\u4e8e\u7ebf\u6027\u5316\u8bef\u5dee\u3002EKF \u53ea\u5728\u5f53\u524d\u72b6\u6001\u70b9\u8fdb\u884c\u4e00\u6b21\u7ebf\u6027\u5316\uff0c\u8bef\u5dee\u4f1a\u968f\u7740\u65f6\u95f4\u7d2f\u79ef\uff0c\u5bfc\u81f4\u6f02\u79fb\u3002 \u76f8\u5bf9\u8f83\u9ad8\u901a\u8fc7\u591a\u6b21\u8fed\u4ee3\u6c42\u89e3\u975e\u7ebf\u6027\u95ee\u9898\uff0c\u53ef\u4ee5\u5728\u65b0\u7684\u4f30\u8ba1\u70b9\u53cd\u590d\u7ebf\u6027\u5316\uff0c\u7cbe\u5ea6\u66f4\u9ad8\u3002 \u5904\u7406\u975e\u7ebf\u6027\u7684\u80fd\u529b \u8f83\u5f31EKF \u7684\u5355\u6b21\u7ebf\u6027\u5316\u5047\u8bbe\u5728\u5f3a\u975e\u7ebf\u6027\u8fd0\u52a8\u4e2d\u53ef\u80fd\u5931\u6548\u3002 \u8f83\u5f3a\u8fed\u4ee3\u4f18\u5316\u80fd\u66f4\u597d\u5730\u5904\u7406\u7cfb\u7edf\u975e\u7ebf\u6027\u3002 \u9c81\u68d2\u6027\u4e0e\u6269\u5c55\u6027 \u76f8\u5bf9\u8f83\u5dee\u6dfb\u52a0\u65b0\u7684\u7ea6\u675f\uff08\u5982 GPS\u3001\u56de\u73af\u68c0\u6d4b\uff09\u76f8\u5bf9\u590d\u6742\u3002 \u76f8\u5bf9\u8f83\u597d\u6846\u67b6\u7075\u6d3b\uff0c\u6dfb\u52a0\u65b0\u7ea6\u675f\u901a\u5e38\u7b49\u540c\u4e8e\u5728\u56fe\u4e2d\u589e\u52a0\u65b0\u7684\u201c\u56e0\u5b50\u201d\uff0c\u5982\u56de\u73af\u7ea6\u675f\u3001GPS \u56e0\u5b50\u7b49\u3002 \u5178\u578b\u4ee3\u8868\u7b97\u6cd5 MSCKF (Multi-State Constraint Kalman Filter), ROVIO, EKF-VINS OKVIS, VINS-Mono, ORB-SLAM3, LVI-SAM","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#vins_2","title":"VINS \u7684\u57fa\u672c\u6846\u67b6","text":"<ul> <li>tracking to estimate pose, mapping to reconstruct the environment, and optimization through bundle adjustment with loop closure detection</li> </ul> <ul> <li> <p>Mapping\uff08\u5730\u56fe\u7ba1\u7406\uff09</p> </li> <li> <p>\u51b3\u5b9a\u662f\u5426 \u63d2\u5165\u5173\u952e\u5e27\uff08keyframe\uff09\u4e0e\u4e09\u89d2\u5316\u65b0\u7684 3D \u5730\u70b9\uff08landmarks\uff09\u3002</p> </li> <li> <p>\u6784\u5efa\u89c2\u6d4b\uff08\u89c2\u6d4b = \u67d0 keyframe \u5bf9\u67d0 3D \u70b9\u7684\u6295\u5f71 \\(z\\_{ij}\\)\uff09\uff0c\u5e76\u628a\u8fd9\u4e9b\u89c2\u6d4b\u52a0\u5165\u56e0\u5b50\u56fe / \u56fe\u7ed3\u6784\uff08nodes = keyframe poses + landmarks\uff0cedges = \u89c2\u6d4b\u7ea6\u675f\uff09\u3002</p> </li> <li> <p>Local Mapping\uff08\u5c40\u90e8\u4f18\u5316\uff09: \u5728\u6ed1\u52a8\u7a97\u53e3/\u5c40\u90e8\u5b50\u56fe\u5185\u83b7\u5f97\u9ad8\u7cbe\u5ea6\u3001\u4e00\u81f4\u7684\u5c40\u90e8\u5730\u56fe\uff1b\u4fdd\u8bc1\u5b9e\u65f6\u6027\uff08\u7a97\u53e3\u5927\u5c0f\u9650\u5236\u8ba1\u7b97\u91cf\uff09</p> </li> <li> <p>Bundle Adjustment\uff08\u5c40\u90e8 BA\uff09\uff1a\u5bf9\u6700\u8fd1\u7684\u82e5\u5e72\u5173\u952e\u5e27\u4e0e\u5b83\u4eec\u89c2\u6d4b\u5230\u7684 3D \u70b9\u540c\u65f6\u505a\u8054\u7acb\u975e\u7ebf\u6027\u6700\u5c0f\u4e8c\u4e58\uff0c\u76ee\u6807\u662f\u6700\u5c0f\u5316\u91cd\u6295\u5f71\u8bef\u5dee(\u8054\u5408\u4f18\u5316\u4f4d\u59ff\u4e0e 3D \u70b9, \u91cd\u6295\u5f71\u8bef\u5dee\u6700\u5c0f\u5316)</p> \\[ \\\\min\\_{{T_i},{X_j}} \\\\sum\\_{i,j} \\\\rho!\\\\left(\\\\left| z\\_{ij} - \\\\pi(T_i, X_j) \\\\right|_{\\\\Sigma_{ij}}^2\\\\right) \\] <ul> <li>\\(T_i\\)\uff1a\u7b2c \\(i\\) \u4e2a\u76f8\u673a\u4f4d\u59ff\uff08\\(SE(3)\\)\uff09</li> <li>\\(X_j\\)\uff1a\u7b2c \\(j\\) \u4e2a 3D \u70b9\u5750\u6807</li> <li>\\(\\\\pi(\\\\cdot)\\)\uff1a\u6295\u5f71\u51fd\u6570\uff08\u628a 3D \u70b9\u6295\u5230\u56fe\u50cf\u5e73\u9762\uff09</li> <li>\\(z\\_{ij}\\): \u5b9e\u9645\u89c2\u6d4b\u5230\u7684\u50cf\u7d20\u5750\u6807</li> <li>\\(\\\\rho\\)\uff1a\u9c81\u68d2\u6838\u51fd\u6570\uff08\u5982 Huber\uff09\uff0c\u5904\u7406\u5916\u70b9</li> </ul> <p>\u4f18\u70b9\uff1a\u7cbe\u5ea6\u9ad8\uff08\u540c\u65f6\u4f18\u5316\u7ed3\u6784\u4e0e\u4f4d\u59ff\uff09\\ \u7f3a\u70b9\uff1a\u8ba1\u7b97\u6602\u8d35\uff08\u5c24\u5176\u5730\u56fe\u70b9\u5f88\u591a\u65f6\uff09</p> </li> <li> <p>Remove Outliers\uff1a\u6839\u636e\u91cd\u6295\u5f71\u8bef\u5dee\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u88ab\u89c2\u6d4b\u6b21\u6570\u7b49\u5254\u9664\u4e0d\u53ef\u9760\u7684\u5730\u56fe\u70b9\u4e0e\u89c2\u6d4b\u3002</p> </li> <li> <p>Loop Closure\uff08\u56de\u73af\u68c0\u6d4b\uff09: \u56de\u73af\u7ea6\u675f\u662f\u5728\u5168\u5c40\u5c3a\u5ea6\u4e0a\u628a\u4e24\u4e2a\u8fdc\u5904\u65f6\u523b\u8fde\u63a5\u8d77\u6765\uff0c\u662f\u7ea0\u6b63\u7d2f\u8ba1\u6f02\u79fb\u7684\u5173\u952e\u8bc1</p> </li> <li> <p>Place Recognition\uff08BoW / NetVLAD / DBoW\uff09\u53d1\u73b0\u201c\u73b0\u5728\u7684\u5173\u952e\u5e27\u4e0e\u8fc7\u53bb\u67d0\u4e00\u5173\u952e\u5e27\u8868\u793a\u76f8\u540c\u5730\u70b9\u201d\u3002</p> </li> <li> <p>Geometric Verification\uff1a\u5bf9\u5019\u9009\u56de\u73af\u505a\u51e0\u4f55\u9a8c\u8bc1\uff08\u5339\u914d + \u4f30\u8ba1\u76f8\u5bf9\u4f4d\u59ff + RANSAC\uff09\u3002\u82e5\u901a\u8fc7\uff0c\u5219\u4ea7\u751f\u4e00\u4e2a\u56de\u73af\u7ea6\u675f\uff08\u4e00\u6761\u65b0\u7684\u8fb9 \\(z\\_{ij}\\)\uff09\u52a0\u5165</p> </li> <li> <p>Global / Pose-Graph Optimization\uff08\u540e\u7aef\u5168\u5c40\u4e00\u81f4\u6027\u4fee\u6b63\uff09</p> </li> <li> <p>\u6536\u5230\u56de\u73af\u540e\uff0c\u7cfb\u7edf\u4f1a\u628a\u65b0\u589e\u7684\u56de\u73af\u8fb9\u52a0\u5165\u56fe\uff0c\u5e76\u8fd0\u884c\u5168\u5c40\u4f18\u5316\uff08pose-graph optimization \u6216\u5168\u5c40 BA\uff09\uff0c\u628a\u5c40\u90e8\u8bef\u5dee\u6cbf\u6574\u5f20\u56fe\u4f20\u64ad\uff0c\u77eb\u6b63\u7d2f\u79ef\u6f02\u79fb\u3002</p> </li> <li> <p>\u5e38\u89c1\u7b56\u7565\uff1a\u5148\u505a\u8f83\u8f7b\u91cf\u7684 pose-graph \u4f18\u5316\uff08\u53ea\u8c03\u6574\u4f4d\u59ff\uff09\uff0c\u968f\u540e\u6839\u636e\u9700\u8981\u505a\u4e00\u6b21\u5168\u5c40 BA\uff08\u540c\u65f6\u8c03\u6574\u4f4d\u59ff\u4e0e\u5730\u56fe\u70b9\uff09\u4ee5\u83b7\u5f97\u6700\u4f18\u89e3\u3002</p> </li> <li> <p>pose graph opimization: \u53ea\u4f18\u5316\u4f4d\u59ff\uff0c\u5229\u7528\u76f8\u673a i \u5230\u76f8\u673a j \u7684\u76f8\u5bf9\u4f4d\u59ff\u7ea6\u675f</p> <ul> <li>\u6b8b\u5dee\u5b9a\u4e49\u4e3a\uff1a</li> </ul> \\[ e\\_{ij} = \\\\mathrm{Log}!\\\\left( z\\_{ij}^{-1} \\\\left( T_i^{-1} T_j \\\\right) \\\\right) \\] <ul> <li>\u4f18\u5316\u76ee\u6807\u4e3a\uff1a</li> </ul> \\[ \\\\min\\_{{T_i}} \\\\sum\\_{(i,j)} \\\\rho!\\\\left( e\\_{ij}^\\\\top \\\\Omega\\_{ij} e\\_{ij} \\\\right) \\] <ul> <li>\\(T_i\\)\uff1a\u7b2c \\(i\\) \u4e2a\u76f8\u673a\u4f4d\u59ff</li> <li>\\(z\\_{ij}\\)\uff1a\u89c2\u6d4b\u5230\u7684\u76f8\u5bf9\u4f4d\u59ff\u7ea6\u675f</li> <li>\\(e\\_{ij}\\)\uff1a\u8be5\u7ea6\u675f\u4e0b\u7684\u8bef\u5dee\u9879</li> <li>\\(\\\\Omega\\_{ij}\\)\uff1a\u4fe1\u606f\u77e9\u9635\uff08\u6d4b\u91cf\u534f\u65b9\u5dee\u7684\u9006\uff09</li> </ul> <p>\u4f18\u70b9\uff1a\u8f7b\u91cf\uff0c\u80fd\u5728\u5927\u89c4\u6a21\u8282\u70b9\u4e0a\u5feb\u901f\u8fd0\u884c\\ \u7f3a\u70b9\uff1a\u53ea\u4f18\u5316\u4f4d\u59ff\uff0c\u4e0d\u76f4\u63a5\u4fee\u6b63\u5730\u56fe\u70b9</p> </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#active-slam","title":"Active SLAM","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#frontier","title":"\u5982\u4f55\u627e\u5230 Frontier(\u201c\u5df2\u77e5\u533a\u57df\u201d\u548c\u201c\u672a\u77e5\u533a\u57df\u201d\u4e4b\u95f4\u7684\u8fb9\u754c)","text":"<p>\u5730\u56fe\u7531\u4f53\u7d20\uff083D\uff09\u6216\u6805\u683c\uff082D\uff09\u7ec4\u6210\uff0c\u6bcf\u4e2a\u683c\u5b50\u6709\u72b6\u6001\uff1a</p> <ul> <li> <p>\u5df2\u77e5\u81ea\u7531 (free)</p> </li> <li> <p>\u5df2\u77e5\u5360\u636e (occupied)</p> </li> <li> <p>\u672a\u77e5 (unknown)</p> </li> </ul> <p>\u4e00\u4e2a\u683c\u5b50\u662f frontier \u7684\u6761\u4ef6\uff1a</p> <ul> <li>\u8be5\u683c\u5b50\u662f free\uff08\u673a\u5668\u4eba\u80fd\u5230\u8fbe\uff09\u3002</li> <li>\u81f3\u5c11\u6709\u4e00\u4e2a\u76f8\u90bb\u683c\u5b50\u662f unknown\u3002</li> </ul> <p>frontiers \u4f1a\u88ab\u805a\u7c7b\uff08clustered\uff09\uff0c\u5f62\u6210\u66f4\u5927\u7684\u201c\u524d\u6cbf\u533a\u57df\u201d\u3002 \u805a\u7c7b\u540e\u7684 frontiers \u7528\u6765\u5f15\u5bfc\u5bfc\u822a\uff0c\u56e0\u4e3a\u53bb\u63a2\u7d22\u8fd9\u4e9b\u4f4d\u7f6e\u5c31\u80fd\u8ba9\u673a\u5668\u4eba\u9010\u6b65\u628a\u672a\u77e5\u533a\u57df\u53d8\u4e3a\u5df2\u77e5\u533a\u57df\u3002</p> <p>\u5bf9\u6bcf\u4e2a cluster \u8ba1\u7b97\u4e00\u4e2a\u4ee3\u8868\u70b9\uff08\u901a\u5e38\u662f\u8d28\u5fc3\u6216\u79bb\u673a\u5668\u4eba\u6700\u8fd1\u7684\u70b9\uff09\u3002\u7ed3\u5408\u4fe1\u606f\u589e\u76ca\uff08information gain\uff09 \u548c\u8fd0\u52a8\u4ee3\u4ef7\uff08travel cost\uff09 \u9009\u53d6\u6700\u4f18 frontier\uff0c\u4f5c\u4e3a\u4e0b\u4e00\u6b65\u63a2\u7d22\u76ee\u6807</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#active-planner","title":"Active Planner","text":"<p>\u4e3b\u52a8\u89c4\u5212\u5668\u7684\u76ee\u6807\u662f\u901a\u8fc7\u667a\u80fd\u5730\u9009\u62e9\u673a\u5668\u4eba\u4e0b\u4e00\u6b65\u7684\u884c\u52a8\uff0c\u6765\u6700\u5927\u5316\u5176\u5bf9\u73af\u5883\u7684\u8ba4\u77e5\u548c\u7406\u89e3\u3002\u5b83\u9700\u8981\u5728\u201c\u63a2\u7d22\u201d\uff08Exploration\uff09\u548c\u201c\u5229\u7528\u201d\uff08Exploitation\uff09\u4e4b\u95f4\u8fdb\u884c\u6743\u8861\uff0c\u5728\u6bcf\u4e2a\u51b3\u7b56\u5468\u671f\uff0c\u89c4\u5212\u5668\u90fd\u4f1a\u540c\u65f6\u8bc4\u4f30\u4e24\u4e2a\u9009\u9879\uff1a</p> <ul> <li> <p>\u7ee7\u7eed\u6267\u884c\u57fa\u4e8e COP(Correlated Orienteering Problem)\u7684\u63a2\u7d22\u8def\u5f84\uff0c\u4ee5\u83b7\u53d6\u65b0\u77e5\u8bc6\u3002</p> </li> <li> <p>\u4e2d\u65ad\u63a2\u7d22\uff0c\u6267\u884c\u4e00\u6b21\u57fa\u4e8e SLC(Active Semantic Loop Closure)\u7684\u5229\u7528\u4efb\u52a1\uff0c\u4ee5\u5de9\u56fa\u548c\u4fee\u6b63\u73b0\u6709\u77e5\u8bc6\u3002</p> </li> <li> <p>\u4e3b\u52a8\u89c4\u5212\u5668\u901a\u8fc7\u5c06\u4e0a\u8ff0\u4e24\u4e2a\u76ee\u6807\u5206\u522b\u5efa\u6a21\u5e76\u6301\u7eed\u8bc4\u4f30\uff0c\u6765\u5236\u5b9a\u5177\u4f53\u7684\u884c\u52a8\u8ba1\u5212\u3002</p> </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#correlated-orienteering-problem-cop","title":"\u63a2\u7d22\u89c4\u5212\uff1a\u57fa\u4e8e\u201c\u76f8\u5173\u6027\u5bfb\u8def\u95ee\u9898\u201d\uff08Correlated Orienteering Problem, COP\uff09","text":"<p>\u5f53\u89c4\u5212\u5668\u7684\u76ee\u6807\u662f\u201c\u63a2\u7d22\u201d\u65f6\uff0c\u5b83\u5c06\u8def\u5f84\u89c4\u5212\u95ee\u9898\u5f62\u5f0f\u5316\u4e3a\u4e00\u4e2a\u76f8\u5173\u6027\u5bfb\u8def\u95ee\u9898 (COP) \u3002\u8fd9\u4e2a\u6570\u5b66\u6a21\u578b\u975e\u5e38\u9002\u5408\u8d44\u6e90\u53d7\u9650\u7684\u673a\u5668\u4eba\u63a2\u7d22\u4efb\u52a1\uff0c\u5176\u6838\u5fc3\u8981\u7d20\u5982\u4e0b \uff1a</p> <ul> <li> <p>\u9876\u70b9\u5956\u52b1 (Rewards)\uff1a \u73af\u5883\u4e2d\u7684\u6f5c\u5728\u76ee\u6807\u70b9\uff08\u4f8b\u5982\uff0c\u672a\u77e5\u533a\u57df\u7684\u8fb9\u754c\uff0c\u5373\u201c\u524d\u6cbf\u201d\uff09\u88ab\u89c6\u4e3a\u56fe\u4e2d\u7684\u9876\u70b9\uff0c\u6bcf\u4e2a\u9876\u70b9\u90fd\u88ab\u8d4b\u4e88\u4e00\u4e2a\u201c\u5956\u52b1\u503c\u201d\uff0c\u4ee3\u8868\u8bbf\u95ee\u8be5\u70b9\u80fd\u83b7\u5f97\u7684\u4fe1\u606f\u589e\u76ca\u3002</p> </li> <li> <p>\u9884\u7b97\u7ea6\u675f (Budget Constraint)\uff1a \u673a\u5668\u4eba\u6267\u884c\u4efb\u52a1\u7684\u8d44\u6e90\u662f\u6709\u9650\u7684\uff0c\u8fd9\u88ab\u5efa\u6a21\u4e3a\u4e00\u4e2a\u201c\u9884\u7b97\u201d\uff0c\u4f8b\u5982\u603b\u8def\u5f84\u957f\u5ea6\u3001\u53ef\u7528\u65f6\u95f4\u6216\u7535\u6c60\u7535\u91cf\u3002\u673a\u5668\u4eba\u89c4\u5212\u7684\u8def\u5f84\u603b\u6210\u672c\u4e0d\u80fd\u8d85\u8fc7\u8fd9\u4e2a\u9884\u7b97\u3002</p> </li> <li> <p>\u5956\u52b1\u76f8\u5173\u6027 (Correlation)\uff1a \u8fd9\u662f COP \u6a21\u578b\u7684\u4e00\u4e2a\u5173\u952e\u7279\u6027\u3002\u5b83\u5047\u5b9a\u8bbf\u95ee\u4e00\u4e2a\u9876\u70b9\uff08\u4f4d\u7f6e\uff09\u53ef\u80fd\u4f1a\u540c\u65f6\u63d0\u4f9b\u5173\u4e8e\u5176\u90bb\u8fd1\u9876\u70b9\u7684\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u4ece\u4e00\u4e2a\u6709\u5229\u4f4d\u7f6e\u73af\u987e\u56db\u5468\uff0c\u53ef\u80fd\u4f1a\u4e00\u6b21\u6027\u63a2\u7d22\u5230\u597d\u51e0\u4e2a\u201c\u524d\u6cbf\u201d\u533a\u57df\u3002</p> </li> </ul> <p>\u901a\u8fc7\u6c42\u89e3\u8fd9\u4e2a COP \u6a21\u578b\uff0c\u89c4\u5212\u5668\u80fd\u591f\u751f\u6210\u4e00\u6761\u5728\u9884\u7b97\u8303\u56f4\u5185\uff0c\u6700\u5927\u5316\u603b\u4fe1\u606f\u5956\u52b1\u7684\u63a2\u7d22\u8def\u5f84\u3002\u8fd9\u786e\u4fdd\u4e86\u63a2\u7d22\u884c\u4e3a\u672c\u8eab\u662f\u9ad8\u6548\u4e14\u6709\u76ee\u7684\u6027\u7684 \u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#active-semantic-loop-closure-slc","title":"\u5229\u7528\u89c4\u5212\uff1a\u57fa\u4e8e\u201c\u4e3b\u52a8\u8bed\u4e49\u95ed\u73af\u68c0\u6d4b\u201d\uff08Active Semantic Loop Closure, SLC\uff09","text":"<p>\u5f53\u89c4\u5212\u5668\u7684\u76ee\u6807\u662f\u201c\u5229\u7528\u201d\u6216\u524a\u51cf\u4e0d\u786e\u5b9a\u6027\u65f6\uff0c\u5b83\u4f1a\u542f\u52a8\u4e3b\u52a8\u8bed\u4e49\u95ed\u73af\u68c0\u6d4b (SLC) \u6a21\u5757 \u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e0e\u4f20\u7edf\u7684\u88ab\u52a8\u95ed\u73af\u5b8c\u5168\u4e0d\u540c\uff0c\u5176\u89c4\u5212\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ul> <li> <p>\u5019\u9009\u751f\u6210\u4e0e\u8bc4\u4f30\uff1a \u89c4\u5212\u5668\u4f1a\u6301\u7eed\u56de\u987e\u5df2\u7ecf\u6784\u5efa\u7684\u7a00\u758f\u8bed\u4e49\u5730\u56fe\u3002\u5b83\u4f1a\u4e3b\u52a8\u8bc6\u522b\u51fa\u90a3\u4e9b\u66fe\u7ecf\u89c2\u6d4b\u5230\u7684\u3001\u7531\u591a\u4e2a\u9c81\u68d2\u8bed\u4e49\u5730\u6807\uff08\u5982\u201c\u6905\u5b50\u201d\u3001\u201c\u663e\u793a\u5668\u201d\u7ec4\u5408\uff09\u6784\u6210\u7684\u533a\u57df\uff0c\u5e76\u5c06\u8fd9\u4e9b\u533a\u57df\u4f5c\u4e3a\u6f5c\u5728\u7684\u201c\u95ed\u73af\u5019\u9009\u70b9\u201d \u3002</p> </li> <li> <p>\u6210\u672c\u6548\u76ca\u5206\u6790\uff1a \u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u5019\u9009\u70b9\uff0c\u89c4\u5212\u5668\u4f1a\u8fdb\u884c\u4e00\u6b21\u865a\u62df\u7684\u6210\u672c\u6548\u76ca\u5206\u6790\u3002\u5b83\u4f1a\u8ba1\u7b97\uff1a</p> </li> <li> <p>\u6536\u76ca (Utility)\uff1a \u201c\u5982\u679c\u6211\u73b0\u5728\u89c4\u5212\u4e00\u6761\u8def\u5f84\u56de\u5230\u8fd9\u4e2a\u70b9\uff0c\u5e76\u6210\u529f\u91cd\u65b0\u89c2\u6d4b\u5230\u8fd9\u7ec4\u7269\u4f53\uff0c\u6211\u7684\u6574\u4f53\u5b9a\u4f4d\u4e0d\u786e\u5b9a\u6027\u4f1a\u964d\u4f4e\u591a\u5c11\uff1f\u201d</p> </li> <li> <p>\u6210\u672c (Cost)\uff1a \u201c\u89c4\u5212\u5e76\u6267\u884c\u8fd9\u6761\u8def\u5f84\u9700\u8981\u6d88\u8017\u591a\u5c11\u9884\u7b97\uff08\u65f6\u95f4\u3001\u80fd\u91cf\uff09\uff1f\u201d \u3002</p> </li> <li> <p>\u76ee\u6807\u5bfc\u5411\u7684\u8def\u5f84\u751f\u6210\uff1a \u5982\u679c\u89c4\u5212\u5668\u53d1\u73b0\u67d0\u4e2a SLC \u5019\u9009\u70b9\u7684\u201c\u6536\u76ca/\u6210\u672c\u201d\u6bd4\u975e\u5e38\u9ad8\uff0c\u5b83\u5c31\u4f1a\u4e3b\u52a8\u5730\u3001\u610f\u56fe\u660e\u786e\u5730\u89c4\u5212\u4e00\u6761\u4e13\u95e8\u7684\u8def\u5f84\uff0c\u5f15\u5bfc\u673a\u5668\u4eba\u91cd\u8fd4\u8be5\u5730\u70b9 \u3002\u8fd9\u4e2a\u884c\u52a8\u7684\u552f\u4e00\u76ee\u7684\u5c31\u662f\u89e6\u53d1\u4e00\u6b21\u9ad8\u8d28\u91cf\u7684\u95ed\u73af\uff0c\u4ece\u800c\u6821\u6b63\u7d2f\u79ef\u7684\u8bef\u5dee\u3002</p> </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#_1","title":"\u7efc\u5408\u51b3\u7b56\u673a\u5236","text":"<p>\u5728\u6bcf\u4e2a\u51b3\u7b56\u5468\u671f\uff0c\u4e3b\u52a8\u89c4\u5212\u5668\u90fd\u4f1a\u540c\u65f6\u8bc4\u4f30\u201c\u63a2\u7d22\u201d\u548c\u201c\u5229\u7528\u3002\u6700\u7ec8\u7684\u51b3\u7b56\u53d6\u51b3\u4e8e\u54ea\u4e2a\u9009\u9879\u80fd\u5728\u5f53\u524d\u72b6\u6001\u4e0b\u63d0\u4f9b\u6700\u5927\u7684\u8fb9\u9645\u6548\u7528</p> <p>\u4f8b\u5982\uff0c\u5f53\u673a\u5668\u4eba\u521a\u5f00\u59cb\u63a2\u7d22\u3001\u4e0d\u786e\u5b9a\u6027\u8f83\u4f4e\u65f6\uff0c\u89c4\u5212\u5668\u4f1a\u4f18\u5148\u9009\u62e9\u63a2\u7d22\u3002\u4f46\u968f\u7740\u63a2\u7d22\u8ddd\u79bb\u53d8\u957f\u3001\u7d2f\u79ef\u8bef\u5dee\u589e\u5927\uff0cSLC \u4efb\u52a1\u7684\u6f5c\u5728\u6536\u76ca\u4f1a\u6025\u5267\u4e0a\u5347\uff0c\u6b64\u65f6\u89c4\u5212\u5668\u5c31\u53ef\u80fd\u4f1a\u5224\u65ad\u6267\u884c\u4e00\u6b21\u95ed\u73af\u4efb\u52a1\u662f\u66f4\u660e\u667a\u7684\u9009\u62e9\u3002</p> <p>\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\uff0c\u4e3b\u52a8\u89c4\u5212\u5668\u5c06\u673a\u5668\u4eba\u4ece\u4e00\u4e2a\u7b80\u5355\u7684\u5730\u56fe\u7ed8\u5236\u5de5\u5177\uff0c\u63d0\u5347\u4e3a\u4e00\u4e2a\u80fd\u591f\u8fdb\u884c\u6df1\u601d\u719f\u8651\u3001\u4e3b\u52a8\u7ba1\u7406\u81ea\u8eab\u8ba4\u77e5\u4e0d\u786e\u5b9a\u6027\u7684\u667a\u80fd\u4ee3\u7406\u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#_2","title":"\u4f55\u65f6\u505c\u6b62","text":"<ul> <li> <p>\u65e0\u65b0\u524d\u6cbf (No New Frontiers)\uff1a \u6700\u5e38\u89c1\u7684\u7ec8\u6b62\u6761\u4ef6\u662f\u5f53\u63a2\u7d22\u7b97\u6cd5\u518d\u4e5f\u65e0\u6cd5\u5728\u5730\u56fe\u4e2d\u627e\u5230\u4efb\u4f55\u5df2\u77e5\u7a7a\u95f4\u4e0e\u672a\u77e5\u7a7a\u95f4\u7684\u8fb9\u754c\uff08\u5373\u201c\u524d\u6cbf\u201d\uff09\u65f6\uff0c\u7cfb\u7edf\u4f1a\u5224\u5b9a\u63a2\u7d22\u5df2\u5b8c\u6210\u5e76\u505c\u6b62 \u3002</p> </li> <li> <p>\u8986\u76d6\u7387\u9608\u503c (Coverage Threshold)\uff1a \u89c4\u5212\u5668\u53ef\u4ee5\u88ab\u8bbe\u5b9a\u4e00\u4e2a\u76ee\u6807\uff0c\u4f8b\u5982\u5f53\u5df2\u5efa\u56fe\u533a\u57df\u8fbe\u5230\u9884\u5b9a\u73af\u5883\u603b\u4f53\u79ef\u7684 95%\u65f6\uff0c\u4efb\u52a1\u7ec8\u6b62 \u3002</p> </li> <li> <p>\u9884\u7b97\u8017\u5c3d (Budget Depletion)\uff1a \u5728\u201c\u76f8\u5173\u6027\u5bfb\u8def\u95ee\u9898\u201d\uff08COP\uff09\u7684\u6846\u67b6\u4e0b\uff0c\u673a\u5668\u4eba\u6709\u4e00\u4e2a\u660e\u786e\u7684\u201c\u9884\u7b97\u201d\uff08\u5982\u8def\u5f84\u957f\u5ea6\u6216\u7eed\u822a\u65f6\u95f4\uff09\u3002\u5f53\u8fd9\u4e2a\u9884\u7b97\u88ab\u5b8c\u5168\u6d88\u8017\u65f6\uff0c\u4efb\u52a1\u81ea\u7136\u7ec8\u6b62 \u3002</p> </li> <li> <p>\u4eba\u5de5\u5e72\u9884 (Manual Intervention)\uff1a \u5728\u5b9e\u9645\u90e8\u7f72\u4e2d\uff0c\u64cd\u4f5c\u5458\u53ef\u4ee5\u968f\u65f6\u901a\u8fc7\u8fdc\u7a0b\u6307\u4ee4\u7ec8\u6b62\u4efb\u52a1\uff0c\u4f8b\u5982\u5f53\u4ed6\u4eec\u5bf9\u5730\u56fe\u7684\u5b8c\u6574\u6027\u548c\u7cbe\u5ea6\u611f\u5230\u6ee1\u610f\u65f6</p> </li> </ul>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#_3","title":"\u6548\u7528\u51fd\u6570\u7684\u4f5c\u7528","text":"","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#utility-of-exploration","title":"\u63a2\u7d22\u7684\u6548\u7528 (Utility of Exploration)\uff1a","text":"<p>\u5f53\u89c4\u5212\u5668\u8bc4\u4f30\u201c\u63a2\u7d22\u201d\u8fd9\u4e00\u9009\u9879\u65f6\uff0c\u5b83\u901a\u8fc7\u76f8\u5173\u6027\u5bfb\u8def\u95ee\u9898 (COP) \u6a21\u578b\u6765\u8ba1\u7b97\u6548\u7528\u3002\u5728\u8fd9\u4e2a\u6a21\u578b\u4e2d\uff0c\u73af\u5883\u4e2d\u7684\u6bcf\u4e00\u4e2a\u6f5c\u5728\u63a2\u7d22\u76ee\u6807\u70b9\uff08\u5373\u524d\u6cbf\uff09\u90fd\u88ab\u8d4b\u4e88\u4e00\u4e2areward \u3002\u8fd9\u4e2a\u5956\u52b1\u503c\u5c31\u662f\u63a2\u7d22\u8be5\u70b9\u7684\u76f4\u63a5\u201c\u6548\u7528\u201d\uff0c\u4ee3\u8868\u4e86\u8bbf\u95ee\u8be5\u70b9\u9884\u671f\u80fd\u83b7\u5f97\u7684\u65b0\u4fe1\u606f\u91cf\uff08Information Gain\uff09\u3002</p> <p>\u89c4\u5212\u5668\u4f1a\u6c42\u89e3\u8fd9\u4e2a COP \u95ee\u9898\uff0c\u5bfb\u627e\u4e00\u6761\u80fd\u5728\u9884\u7b97\u7ea6\u675f\u5185\u603b\u6548\u7528\u7684\u8def\u5f84\u3002\u56e0\u6b64\uff0c\u6548\u7528\u51fd\u6570\u76f4\u63a5\u5f15\u5bfc\u89c4\u5212\u5668\u9009\u62e9\u4fe1\u606f\u91cf\u6700\u4e30\u5bcc\u7684\u63a2\u7d22\u65b9\u5411\uff0c\u907f\u514d\u4f4e\u6548\u7684\u5f98\u5f8a\u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#utility-of-exploitation-uncertainty-reduction","title":"\u5229\u7528\u7684\u6548\u7528 (Utility of Exploitation / Uncertainty Reduction)\uff1a","text":"<p>\u5f53\u89c4\u5212\u5668\u8bc4\u4f30\u201c\u5229\u7528\u201d\uff08\u5373\u4e3b\u52a8\u95ed\u73af\uff09\u8fd9\u4e00\u9009\u9879\u65f6\uff0c\u5b83\u4f1a\u542f\u52a8\u4e3b\u52a8\u8bed\u4e49\u95ed\u73af (Active SLC) \u6a21\u5757\u3002\u8be5\u6a21\u5757\u4f1a\u8bc6\u522b\u51fa\u5386\u53f2\u5730\u56fe\u4e2d\u6f5c\u5728\u7684\u95ed\u73af\u5019\u9009\u70b9\u3002\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u5019\u9009\u70b9\uff0c\u6548\u7528\u51fd\u6570\u4f1a\u8fdb\u884c\u4e00\u6b21\u6210\u672c\u6548\u76ca\u5206\u6790\uff0c\u5176\u6838\u5fc3\u662f\u8ba1\u7b97\u6267\u884c\u8fd9\u6b21\u95ed\u73af\u7684\u201c\u6548\u7528\u201d\u2014\u2014\u5373\u9884\u671f\u80fd\u591f\u5e26\u6765\u7684\u4e0d\u786e\u5b9a\u6027\u524a\u51cf\u91cf\u3002\u8fd9\u4e2a\u6548\u7528\u503c\u8d8a\u9ad8\uff0c\u610f\u5473\u7740\u8fd9\u6b21\u95ed\u73af\u5bf9\u63d0\u5347\u5b9a\u4f4d\u548c\u5730\u56fe\u7cbe\u5ea6\u7684\u4ef7\u503c\u8d8a\u5927\u3002</p> <p>\u5982\u89c4\u5212\u5668\u4f1a\u6bd4\u8f83\u4e0d\u540c\u95ed\u73af\u5019\u9009\u70b9\u7684\u6548\u7528\u503c\u3002\u5982\u679c\u53d1\u73b0\u67d0\u4e2a\u95ed\u73af\u4efb\u52a1\u7684\u6548\u7528\uff08\u5373\u4e0d\u786e\u5b9a\u6027\u524a\u51cf\u91cf\uff09\u975e\u5e38\u9ad8\uff0c\u8db3\u4ee5\u8d85\u8fc7\u7ee7\u7eed\u63a2\u7d22\u5e26\u6765\u7684\u4fe1\u606f\u589e\u76ca\u6548\u7528\uff0c\u89c4\u5212\u5668\u5c31\u4f1a\u4e2d\u65ad\u5f53\u524d\u7684\u63a2\u7d22\u4efb\u52a1\uff0c\u8f6c\u800c\u751f\u6210\u4e00\u6761\u4e13\u95e8\u7528\u4e8e\u6267\u884c\u8fd9\u6b21\u9ad8\u4ef7\u503c\u95ed\u73af\u4efb\u52a1\u7684\u8def\u5f84 \u3002</p>","tags":["VINS"]},{"location":"paperreadings/activeslam/vins%E5%9F%BA%E7%A1%80/#_4","title":"\u540e\u7aef\u4f18\u5316","text":"<ul> <li> <p>\u91cc\u7a0b\u8ba1\u7ea6\u675f (Odometry Factors): \u8fde\u63a5\u8fde\u7eed\u4e24\u4e2a\u673a\u5668\u4eba\u4f4d\u59ff\u8282\u70b9\uff08\u4f8b\u5982\uff0c\\(Pose_t\\) \u548c \\(Pose\\_{t+1}\\)\uff09\u3002\u8fd9\u79cd\u7ea6\u675f\u6765\u6e90\u4e8e\u524d\u7aef\u7684\u8fd0\u52a8\u4f30\u8ba1\uff08\u5982\u89c6\u89c9-\u60ef\u6027\u91cc\u7a0b\u8ba1\uff09\uff0c\u5b83\u63cf\u8ff0\u4e86\u673a\u5668\u4eba\u4ece\u4e00\u4e2a\u65f6\u523b\u5230\u4e0b\u4e00\u4e2a\u65f6\u523b\u7684\u76f8\u5bf9\u8fd0\u52a8 \u3002</p> </li> <li> <p>\u7269\u4f53-\u673a\u5668\u4eba\u89c2\u6d4b\u7ea6\u675f (Object-Robot Observation Factors): \u8fd9\u662f\u7cfb\u7edf\u7684\u6838\u5fc3\u7ea6\u675f\u3002\u5f53\u673a\u5668\u4eba\u5728\u67d0\u4e2a\u4f4d\u59ff\uff08\\(Pose_t\\)\uff09\u89c2\u6d4b\u5230\u4e00\u4e2a\u8bed\u4e49\u5730\u6807\uff08\\(Object_j\\)\uff09\u65f6\uff0c\u5c31\u4f1a\u5728\\(Pose_t\\)\u8282\u70b9\u548c\\(Object_j\\)\u8282\u70b9\u4e4b\u95f4\u6dfb\u52a0\u4e00\u4e2a\u56e0\u5b50\u3002\u8fd9\u4e2a\u56e0\u5b50\u7f16\u7801\u4e86\u673a\u5668\u4eba\u4e0e\u7269\u4f53\u4e4b\u95f4\u7684\u76f8\u5bf9\u4f4d\u59ff\u5173\u7cfb \u3002\u8bba\u6587\u4e2d\u660e\u786e\u63d0\u5230\uff0c\u7cfb\u7edf\u901a\u8fc7\u5b9a\u5236\u5316\u7684\u56e0\u5b50 customized factors\u6765\u7f16\u7801\u8fd9\u79cd\u7269\u4f53-\u673a\u5668\u4eba\u7ea6\u675f\uff0c\u4ece\u800c\u6700\u5c0f\u5316\u5b9a\u4f4d\u6f02\u79fb \u3002</p> </li> <li> <p>\u8bed\u4e49\u95ed\u73af\u7ea6\u675f (Semantic Loop Closure Factors): \u8fd9\u662f\u4e00\u79cd\u7279\u6b8a\u4f46\u6781\u5176\u5f3a\u5927\u7684\u89c2\u6d4b\u7ea6\u675f\u3002\u5f53\u673a\u5668\u4eba\u901a\u8fc7\u5176\u4e3b\u52a8\u89c4\u5212\uff0c\u91cd\u65b0\u89c2\u6d4b\u5230\u4e00\u4e2a\u5f88\u4e45\u4ee5\u524d\u5c31\u5df2\u7ecf\u52a0\u5165\u5730\u56fe\u7684\u8bed\u4e49\u5730\u6807\u65f6\uff08\u4f8b\u5982\uff0c\u5728\\(Pose_t\\)\u65f6\u523b\u91cd\u65b0\u770b\u5230\u4e86\u5728\\(Pose\\_{t-k}\\)\u65f6\u523b\u9996\u6b21\u53d1\u73b0\u7684\\(Object_j\\)\uff09\uff0c\u7cfb\u7edf\u5c31\u4f1a\u5728\\(Pose_t\\)\u548c\\(Object_j\\)\u4e4b\u95f4\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u89c2\u6d4b\u7ea6\u675f\u3002\u7531\u4e8e\\(Object_j\\)\u5df2\u7ecf\u4e0e\\(Pose\\_{t-k}\\)\u7b49\u5386\u53f2\u4f4d\u59ff\u76f8\u5173\u8054\uff0c\u8fd9\u4e2a\u65b0\u7684\u7ea6\u675f\u5c31\u6709\u6548\u5730\u5728\u5f53\u524d\u4f4d\u59ff\u548c\u9065\u8fdc\u7684\u5386\u53f2\u4f4d\u59ff\u4e4b\u95f4\u5efa\u7acb\u4e86\u4e00\u5ea7\u201c\u6865\u6881\u201d\uff0c\u4ece\u800c\u5728\u5168\u5c40\u4f18\u5316\u65f6\u6821\u6b63\u6574\u4e2a\u8f68\u8ff9\u7684\u7d2f\u79ef\u8bef\u5dee</p> </li> </ul>","tags":["VINS"]},{"location":"paperreadings/db/storage/NoMMAP/","title":"Are You Sure You Want to Use MMAP in Your Database Management System","text":"2025-09-112025-12-10 <code>#Paper Notes</code> <code>#DB</code>","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#are-you-sure-you-want-to-use-mmap-in-your-database-management-system","title":"Are You Sure You Want to Use MMAP in Your Database Management System \u8bba\u6587\u9605\u8bfb\u7b14\u8bb0","text":"<p> \u7ea6 1646 \u4e2a\u5b57  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 8 \u5206\u949f</p>","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#abstract","title":"Abstract","text":"<p>mmap =  \u6c38\u8fdc\u4e0d\u8981\u5728 DBMS \u4e2d\u5e94\u7528 mmap </p>","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#intro","title":"Intro \u603b\u4f53\u4ecb\u7ecd","text":"","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#mmap-work-flow","title":"mmap work flow","text":"<ol> <li> <p>\u7528\u6237\u7528 mmap \u8bf7\u6c42\u8bfb\u5199 cidr.db \u6587\u4ef6</p> </li> <li> <p>mmap \u7cfb\u7edf\u8c03\u7528\u5c06\u5176\u6620\u5c04\u5230\u8fdb\u7a0b\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\u4e2d\u4e0e\u6587\u4ef6\u5173\u8054\uff0c\u6ce8\u610f\u6b64\u65f6\u5e76\u6ca1\u6709\u5c06\u6587\u4ef6\u52a0\u8f7d\u5230\u771f\u5b9e\u7269\u7406\u5185\u5b58</p> </li> <li> <p>\u76f4\u5230\u7528\u6237\u5f00\u59cb\u8bbf\u95ee\u8be5\u6587\u4ef6\u6570\u636e\uff0cOS \u53d1\u73b0\u865a\u62df\u5185\u5b58\u6ca1\u6709\u5bf9\u5e94\u7684\u7269\u7406\u5185\u5b58\uff0c\u89e6\u53d1 page fault\uff0c\u6b64\u65f6 OS \u5c06\u6587\u4ef6\u7684\u76f8\u5e94\u90e8\u5206\u52a0\u8f7d\u5230\u7269\u7406\u5185\u5b58\u4e2d</p> </li> <li> <p>\u540c\u65f6\u5411\u7ef4\u62a4\u7684\u9875\u8868\u4ee5\u53ca TLB \u4e2d\u52a0\u5165\u5bf9\u5e94\u7684\u6620\u5c04\u5173\u7cfb</p> </li> </ol> <p></p>","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#posix-api","title":"POSIX API","text":"<ul> <li>mmap: \u8fd9\u79cd\u8c03\u7528\u4f7f\u5f97\u64cd\u4f5c\u7cfb\u7edf\u5c06\u4e00\u4e2a\u6587\u4ef6\u6620\u5c04\u5230 DBMS \u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u3002\u7136\u540e\uff0cDBMS \u53ef\u4ee5\u4f7f\u7528\u666e\u901a\u7684\u5185\u5b58\u64cd\u4f5c\u8bfb\u53d6\u6216\u5199\u5165\u6587\u4ef6\u5185\u5bb9\u3002\u64cd\u4f5c\u7cfb\u7edf\u5c06\u9875\u9762\u7f13\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u5f53\u4f7f\u7528 MAP_SHARED \u6807\u5fd7\u4f4d\u65f6\uff0c\u5c06(\u6700\u7ec8)\u5199\u56de\u5e95\u5c42\u6587\u4ef6\u7684\u4efb\u4f55\u66f4\u6539\u3002\u6216\u8005\uff0cMAP_PRIVATE \u6807\u5fd7\u4f1a\u521b\u5efa\u4e00\u4e2a\u53ea\u5bf9\u8c03\u7528\u8005(\u4e5f\u5c31\u662f\u8bf4,\u66f4\u6539\u4e0d\u4f1a\u6301\u7eed\u5230\u5907\u4efd\u6587\u4ef6)\u53ef\u8bbf\u95ee\u7684\u5199\u65f6\u62f7\u8d1d\u6620\u5c04\u3002</li> <li>madvise: MADV_NORMAL \u4f1aprefetch next 16 pages and previos 15 pages\uff0c\u5373\u4f7f\u8c03\u7528\u8005\u53ea\u8bf7\u6c42\u4e00\u4e2a\u9875\u9762\uff0c\u4e5f\u4f1a\u5bfc\u81f4 OS \u4ece\u4e8c\u7ea7\u5b58\u50a8\u4e2d\u8bfb\u53d6 128 KB\u3002\u6839\u636e\u5de5\u4f5c\u8d1f\u8f7d\u7684\u4e0d\u540c\uff0c\u8fd9\u79cd\u9884\u53d6\u53ef\u80fd\u4f1a\u5e2e\u52a9\u6216\u635f\u5bb3 DBMS \u7684\u6027\u80fd\u3002</li> <li>\u4f8b\u5982\uff0c\u53ea\u8bfb\u53d6\u5fc5\u8981\u9875\u9762\u7684 MADV_RANDOM \u6a21\u5f0f\u5bf9\u4e8e\u5927\u4e8e\u5185\u5b58\u7684 OLTP \u5de5\u4f5c\u8d1f\u8f7d\u662f\u66f4\u597d\u7684\u9009\u62e9\uff0c\u800c MADV_SEQUENTIAL \u6a21\u5f0f\u5bf9\u4e8e\u987a\u5e8f\u626b\u63cf\u7684 OLAP \u5de5\u4f5c\u8d1f\u8f7d\u662f\u66f4\u597d\u7684\u9009\u62e9\u3002</li> <li>mlock: \u8fd9\u79cd\u8c03\u7528\u5141\u8bb8 DBMS \u5728\u5185\u5b58\u4e2d Pin \u9875\u9762\uff0c\u786e\u4fdd\u64cd\u4f5c\u7cfb\u7edf\u6c38\u8fdc\u4e0d\u4f1a\u9a71\u9010\u5b83\u4eec\u3002\u7136\u800c\uff0c\u6839\u636e POSIX \u6807\u51c6(\u4ee5\u53ca Linux \u7684\u5b9e\u73b0)\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5141\u8bb8\u5728\u4efb\u4f55\u65f6\u5019\u5c06\u810f\u9875\u5237\u65b0\u5230\u5907\u4efd\u6587\u4ef6\u4e2d\uff0c\u5373\u4f7f\u9875\u9762\u88ab\u6302\u8d77\u3002\u56e0\u6b64\uff0cDBMS \u4e0d\u80fd\u4f7f\u7528 mlock \u6765\u786e\u4fdd\u810f\u9875\u6c38\u8fdc\u4e0d\u4f1a\u88ab\u5199\u5165\u5230\u4e8c\u7ea7\u5b58\u50a8\u4e2d\uff0c\u8fd9\u5bf9\u4e8b\u52a1\u5b89\u5168\u6709\u4e25\u91cd\u7684\u5f71\u54cd\u3002</li> <li>msync: \u8be5\u8c03\u7528\u663e\u5f0f\u5730\u5c06\u6307\u5b9a\u7684\u5185\u5b58\u8303\u56f4\u5237\u65b0\u5230\u4e8c\u7ea7\u5b58\u50a8\u4e2d\u3002\u5982\u679c\u6ca1\u6709 msync\uff0cDBMS \u5c31\u6ca1\u6709\u5176\u4ed6\u65b9\u6cd5\u6765\u4fdd\u8bc1\u66f4\u65b0\u88ab\u6301\u4e45\u5316\u5230\u5907\u4efd\u6587\u4ef6\u4e2d\u3002</li> </ul>","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#why-do-not-use-mmap","title":"Why do not use mmap?","text":"","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#transactional-safety","title":"Transactional Safety","text":"<p>OS \u4f1a at any time \u5237\u5199\u810f\u9875\u5230\u78c1\u76d8(\u5373\u4f7f\u5f53\u524d\u4e8b\u52a1\u672a commit)\uff0c\u6211\u4eec\u65e0\u6cd5\u963b\u6b62</p> <ul> <li>solution\uff1a</li> </ul> <ol> <li> <p>OS CoW(MongoDB)</p> <p>\u7528 mmap \u521b\u5efa\u6570\u636e\u5e93\u6587\u4ef6\u7684\u4e24\u4e2a\u526f\u672c\uff0c\u8fd9\u4e24\u4e2a\u526f\u672c\u6700\u521d\u5c06\u6307\u5411\u76f8\u540c\u7684\u7269\u7406\u9875\u3002\u7b2c\u4e00\u79cd\u4f5c\u4e3a\u4e3b\u526f\u672c\uff0c\u7b2c\u4e8c\u79cd\u4f5c\u4e3a\u79c1\u6709\u5de5\u4f5c\u533a\uff0c\u4e8b\u52a1\u53ef\u4ee5\u5728\u5176\u4e2d\u8fdb\u884c\u9636\u6bb5\u66f4\u65b0\u3002</p> <p>\u66f4\u65b0\u6570\u636e\u65f6\uff0c\u53ea\u5728\u79c1\u6709\u5de5\u4f5c\u533a\u4e0a\u8fdb\u884c\uff0c\u4f1a remap \u5230\u65b0\u7684\u7269\u7406\u7a7a\u95f4\u9875\uff0c\u4f46\u662f\u66f4\u6539\u4e0d\u4f1a\u5199\u5165 db \u6587\u4ef6</p> <p>\u56e0\u6b64\uff0c\u4e3a\u4e86\u63d0\u4f9b\u6301\u4e45\u6027\uff0cDBMS \u5fc5\u987b\u4f7f\u7528\u9884\u5199\u65e5\u5fd7( WAL )\u6765\u8bb0\u5f55\u66f4\u6539\u3002\u5f53\u4e8b\u52a1\u63d0\u4ea4\u65f6\uff0cDBMS \u5c06\u76f8\u5e94\u7684 WAL \u8bb0\u5f55\u5237\u65b0\u5230\u4e8c\u7ea7\u5b58\u50a8\u4e2d\uff0c\u5e76\u4f7f\u7528\u4e00\u4e2a\u5355\u72ec\u7684\u540e\u53f0\u7ebf\u7a0b\u5c06\u63d0\u4ea4\u7684\u4fee\u6539\u5e94\u7528\u5230\u4e3b\u526f\u672c\u4e2d\u3002</p> <ul> <li>Two Main Problems:    1. DBMS \u5fc5\u987b\u786e\u4fdd\u63d0\u4ea4\u4e8b\u52a1\u7684\u6700\u65b0\u66f4\u65b0\u5df2\u7ecf\u4f20\u64ad\u5230\u4e3b\u526f\u672c\uff0c\u624d\u80fd\u5141\u8bb8\u76f8\u4e92\u51b2\u7a81\u7684\u4e8b\u52a1\u8fd0\u884c\uff0c\u8fd9\u5c31\u9700\u8981\u989d\u5916\u7684\u7c3f\u8bb0\u6765\u8ddf\u8e2a\u6709\u5f85\u66f4\u65b0\u7684\u9875\u9762\u3002    1. \u968f\u7740\u66f4\u591a\u66f4\u65b0\u7684\u53d1\u751f\uff0c\u79c1\u6709\u5de5\u4f5c\u7a7a\u95f4\u5c06\u7ee7\u7eed\u589e\u957f\uff0cDBMS \u6700\u7ec8\u53ef\u80fd\u4f1a\u5728\u5185\u5b58\u4e2d\u83b7\u5f97\u6570\u636e\u5e93\u7684\u4e24\u4e2a\u5b8c\u6574\u526f\u672c\u3002    1. \u4e3a\u4e86\u89e3\u51b3\u7b2c\u4e8c\u4e2a\u95ee\u9898\uff0cDBMS \u53ef\u4ee5\u901a\u8fc7 mremap \u7cfb\u7edf\u8c03\u7528\u5468\u671f\u6027\u5730\u6536\u7f29\u79c1\u6709\u5de5\u4f5c\u7a7a\u95f4\u3002\u4f46\u662f\uff0cDBMS \u5fc5\u987b\u518d\u6b21\u786e\u4fdd\u6240\u6709\u6302\u8d77\u7684\u66f4\u65b0\u5728\u7834\u574f\u79c1\u6709\u5de5\u4f5c\u533a\u4e4b\u524d\u5df2\u7ecf\u4f20\u64ad\u5230\u4e3b\u526f\u672c\u3002 \u6b64\u5916\uff0c\u4e3a\u4e86\u907f\u514d\u5728 mremap \u8fc7\u7a0b\u4e2d\u4e22\u5931\u66f4\u65b0\uff0cDBMS \u9700\u8981\u963b\u585e\u6302\u8d77\u7684\u66f4\u6539\uff0c\u76f4\u5230\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u79c1\u6709\u5de5\u4f5c\u7a7a\u95f4\u7684\u538b\u7f29\u3002</li> </ul> </li> <li> <p>User CoW(SQLite, MonetDB)</p> <p>\u5c06\u53d7\u5f71\u54cd\u7684\u9875\u9762\u4ece mmap-backed \u5185\u5b58\u4e2d\u624b\u52a8\u590d\u5236\u5230\u7528\u6237\u7a7a\u95f4\u4e2d\u5355\u72ec\u7ef4\u62a4\u7684\u7f13\u51b2\u533a\u4e2d\u3002</p> <p>\u4e3a\u4e86\u6267\u884c\u66f4\u65b0\uff0cDBMS \u53ea\u5bf9\u526f\u672c\u8fdb\u884c\u66f4\u6539\uff0c\u5e76\u521b\u5efa\u76f8\u5e94\u7684 WAL \u8bb0\u5f55\u3002DBMS \u53ef\u4ee5\u901a\u8fc7\u5c06 WAL \u5199\u5165\u4e8c\u7ea7\u5b58\u50a8\u6765\u6267\u884c\u8fd9\u4e9b\u4fee\u6539\uff0c\u6b64\u65f6\u5b83\u53ef\u4ee5\u5b89\u5168\u5730\u5c06\u4fee\u6539\u540e\u7684\u9875\u9762\u590d\u5236\u5230 mmap - backed \u5185\u5b58\u4e2d\u3002\u7531\u4e8e\u590d\u5236\u6574\u4e2a\u9875\u9762\u5bf9\u4e8e\u5c0f\u7684\u53d8\u5316\u662f\u6d6a\u8d39\u7684\uff0c\u56e0\u6b64\u4e00\u4e9b DBMS \u652f\u6301\u5c06 WAL \u8bb0\u5f55\u76f4\u63a5\u5e94\u7528\u5230 mmap \u652f\u6301\u7684\u5185\u5b58\u4e2d\u3002</p> </li> <li> <p>Shadow Paging(LMDB)</p> <p>\u901a\u8fc7\u5f71\u5b50\u5206\u9875\uff0cDBMS \u5206\u522b\u7ef4\u62a4\u6570\u636e\u5e93\u7684\u4e3b\u526f\u672c\u548c\u5f71\u5b50\u526f\u672c\uff0c\u4e3b\u526f\u672c\u548c\u5f71\u5b50\u526f\u672c\u5747\u7531 mmap \u652f\u6301\u3002</p> <p>\u4e3a\u4e86\u6267\u884c\u66f4\u65b0\uff0cDBMS \u9996\u5148\u5c06\u53d7\u5f71\u54cd\u7684\u9875\u9762\u4ece\u4e3b\u526f\u672c\u590d\u5236\u5230\u5f71\u5b50\u526f\u672c\uff0c\u7136\u540e\u5728\u5f71\u5b50\u526f\u672c\u4e2d\u5e94\u7528\u5fc5\u8981\u7684\u66f4\u6539\u3002</p> <p>\u63d0\u4ea4\u66f4\u6539\u9700\u8981\u7528 msync \u5c06\u4fee\u6539\u540e\u7684\u5f71\u5b50\u9875\u5237\u65b0\u5230\u4e8c\u7ea7\u5b58\u50a8\uff0c\u7136\u540e\u66f4\u65b0\u6307\u9488\u4ee5\u5b89\u88c5\u5f71\u5b50\u526f\u672c\u4f5c\u4e3a\u65b0\u7684\u4e3b\u526f\u672c\u3002\u539f\u59cb\u7684\u521d\u7ea7\u5219\u4f5c\u4e3a\u65b0\u7684\u5f71\u5b50\u62f7\u8d1d\u3002</p> </li> </ol>","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#io-stalls","title":"I/O Stalls","text":"<p>\u6211\u4eec\u65e0\u6cd5\u77e5\u9053\u54ea\u4e9b page \u5728\u5185\u5b58\u4e2d\uff0c\u8bfb\u53d6\u4efb\u4f55\u9875\u90fd\u53ef\u80fd\u9020\u6210 I/O \u505c\u987f</p> <ul> <li>Solution:   1. OS hints   1. Build own prefetcher</li> </ul>","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#error-handling","title":"Error Handling","text":"<p>\u9a8c\u8bc1 page \u5408\u6cd5\u6027(checksum)\u4f1a\u66f4\u52a0\u7e41\u7410\uff0c\u6211\u4eec\u9700\u8981\u5728\u4ece\u78c1\u76d8\u52a0\u8f7d\u5230\u5185\u5b58\u65f6\u9a8c\u8bc1\u4ee5\u53ca\u5728\u5199\u56de\u78c1\u76d8\u524d\u9a8c\u8bc1\uff0c\u4f46\u662f\u6211\u4eec\u4e0d\u77e5\u9053 OS \u4f55\u65f6\u4f1a\u505a\u8fd9\u4e9b\u4e8b\u3002</p> <p>\u4efb\u4f55\u8bbf\u95ee\u53ef\u80fd\u4f1a\u9020\u6210 SIGBUS \u4fe1\u53f7\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 signal hanlder \u6765\u5904\u7406\uff0cneed to code everywhere</p>","tags":["Paper Notes","DB"]},{"location":"paperreadings/db/storage/NoMMAP/#performance-issues","title":"Performance Issues","text":"<p>\u4f20\u7edf\u89c2\u70b9\u8ba4\u4e3a\u5728\u66f4\u597d\u7684\u786c\u4ef6\u4e0a\u5982 PCIe5.0 NVMe \u4e0a\uff0cmmap \u6027\u80fd\u6bd4\u4f20\u7edf\u7684\u6587\u4ef6 IO \u66f4\u597d\uff0c\u56e0\u4e3a\u5b83\u907f\u514d\u4e86\u4e24\u4e2a\u4e3b\u8981\u7684\u5f00\u9500\u6765\u6e90\u3002</p> <ul> <li>\u9996\u5148\uff0cmmap \u89c4\u907f\u4e86\u663e\u5f0f\u8bfb\u5199\u65b9\u6cd5\u7cfb\u7edf\u8c03\u7528\u7684\u6210\u672c\uff0c\u56e0\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u5728\u540e\u53f0\u5904\u7406\u6587\u4ef6\u6620\u5c04\u548c\u9875\u9762\u9519\u8bef\u3002</li> <li>\u5176\u6b21\uff0cmmap \u53ef\u4ee5\u5c06\u6307\u9488\u8fd4\u56de\u5230\u5b58\u50a8\u5728\u64cd\u4f5c\u7cfb\u7edf\u9875\u9762\u7f13\u5b58\u4e2d\u7684\u9875\u9762\uff0c\u4ece\u800c\u907f\u514d\u989d\u5916\u5728\u7528\u6237\u7a7a\u95f4\u7684 copy\u3002</li> <li>\u57fa\u4e8e mmap \u7684\u8bfb\u5199\u6587\u4ef6\u8fd8\u5bfc\u81f4\u4e86\u8f83\u4f4e\u7684\u603b\u5185\u5b58\u6d88\u8017\uff0c\u56e0\u4e3a\u6570\u636e\u5728\u7528\u6237\u7a7a\u95f4\u4e2d\u6ca1\u6709\u4e0d\u5fc5\u8981\u7684\u91cd\u590d</li> </ul> <ol> <li>Random Reads </li> </ol> <ul> <li>OS \u53ea\u4f7f\u7528\u5355\u4e2a\u7ebf\u7a0b\u5904\u7406 page eviction (kswapd)</li> <li>Page table contention/synchronization</li> <li>TLB shootdowns\uff0cflush \u672c\u5730 TLB \u6210\u672c\u4e0d\u9ad8\uff0c\u4f46\u662f\u540c\u6b65\u8fdc\u7a0b TLB \u9700\u8981\u6570\u5343\u4e2a\u65f6\u949f\u5468\u671f</li> </ul> <ol> <li>Sequential Scan </li> </ol> <ul> <li>page cache \u6ee1\u4e86\u4e4b\u540e\uff0c\u6027\u80fd\u9aa4\u964d</li> <li>mmap \u4e0d\u80fd\u9971\u548c SSD \u7684\u5e26\u5bbd</li> </ul>","tags":["Paper Notes","DB"]},{"location":"paperreadings/llm/A%20Survey%20on%20Efficient%20Inference%20for%20Large%20%20Language%20Models/","title":"A Survey on Efficient Inference for Large  Language Models","text":"<p> \u7ea6 188 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"paperreadings/llm/A%20Survey%20on%20Efficient%20Inference%20for%20Large%20%20Language%20Models/#llm","title":"\u5f71\u54cd LLM \u63a8\u7406\u56e0\u7d20","text":"<ul> <li>computational cost</li> <li>memory access cost</li> <li>memory usage   \u5f71\u54cd\u8fd9\u4e09\u4e2a cost \u7684\u56e0\u7d20\u4e00\u822c\u53ef\u5206\u4e3a\u4e0b\u9762\u4e09\u4e2a\uff1a</li> <li>Model Size: \u9700\u8981 load \u6a21\u578b\u6743\u91cd\u5230 GPU\uff0c\u63a8\u7406\u9700\u8981\u6a21\u578b\u53c2\u4e0e</li> <li>Attention Operator: \u5b83\u7684 FLOPs \u662f\u4e0e\u8f93\u5165\u5e8f\u5217\u5e73\u65b9\u6210\u6b63\u6bd4\u7684</li> <li>Decoding Approach: \u5728\u6bcf\u4e2a\u89e3\u7801\u6b65\u9aa4\u4e2d\uff0c\u6240\u6709\u6a21\u578b\u6743\u91cd\u90fd\u4ece HBM \u52a0\u8f7d\u5230 GPU chip\uff0c\u5bfc\u81f4 memory access cost \u8f83\u5927\u3002\u6b64\u5916\uff0cKV\u7f13\u5b58\u7684\u5927\u5c0f\u968f\u7740\u8f93\u5165\u957f\u5ea6\u7684\u589e\u957f\u800c\u589e\u52a0\uff0c\u53ef\u80fd\u5bfc\u81f4\u5185\u5b58\u788e\u7247\u548c\u4e0d\u89c4\u5219\u7684\u5185\u5b58\u8bbf\u95ee\u6a21\u5f0f</li> </ul>"},{"location":"paperreadings/llm/A%20Survey%20on%20Efficient%20Inference%20for%20Large%20%20Language%20Models/#_1","title":"\u4f18\u5316\u624b\u6bb5","text":""},{"location":"paperreadings/llm/A%20Survey%20on%20Efficient%20Inference%20for%20Large%20%20Language%20Models/#data-level-optimization","title":"Data-level Optimization","text":""},{"location":"paperreadings/llm/A%20Survey%20on%20Efficient%20Inference%20for%20Large%20%20Language%20Models/#motivation","title":"Motivation","text":"<p>ICL \u4ee5\u53ca CoT \u6280\u672f\u5bfc\u81f4\u73b0\u5728\u7684 prompt \u975e\u5e38\u957f\uff0c\u8fdb\u800c\u5bfc\u81f4\u8ba1\u7b97\u4ee3\u4ef7\u548c\u5185\u5b58\u4f7f\u7528\u6309 seq_len \u5e73\u65b9\u7ea7\u522b\u589e\u52a0</p>"},{"location":"paperreadings/llm/A%20Survey%20on%20Efficient%20Inference%20for%20Large%20%20Language%20Models/#model-level-optimization","title":"Model-level Optimization","text":""},{"location":"paperreadings/llm/A%20Survey%20on%20Efficient%20Inference%20for%20Large%20%20Language%20Models/#system-level-optimization","title":"System-level Optimization","text":""},{"location":"paperreadings/llm/Prepacking/","title":"Prepacking: A Simple Method for Fast Prefilling and Increased Throughput in Large Language Models \u9605\u8bfb\u7b14\u8bb0","text":""},{"location":"paperreadings/llm/Prepacking/#prepacking-a-simple-method-for-fast-prefilling-and-increased-throughput-in-large-language-models","title":"Prepacking: A Simple Method for Fast Prefilling and Increased Throughput in Large Language Models \u9605\u8bfb\u7b14\u8bb0","text":"<p> \u7ea6 20 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"paperreadings/vector%20search/Acceleratin%20Graph%20Indexing%20for%20ANNs%20on%20Modern%20CPUs/","title":"Acceleratin Graph Indexing for ANNs on Modern CPUs","text":"2025-12-022025-12-10 <p>title: Acceleratin Graph Indexing for ANNs on Modern CPUs \u8bba\u6587\u9605\u8bfb\u7b14\u8bb0 created: 2025-06-10 update: comments: true description: Acceleratin Graph Indexing for ANNs on Modern CPUs\uff1a</p> <ul> <li>Write optimized LSM-Tree for Graph Index, just the bottom layer stored in disk, other layers in memory</li> <li>Locality-Aware graph reordering in disk</li> <li>Sampling-Guided traversal by probabilistic routing</li> </ul> <p>katex: true tags:</p> <ul> <li>Paper Notes</li> <li>Vector Search</li> </ul>"},{"location":"paperreadings/vector%20search/Acceleratin%20Graph%20Indexing%20for%20ANNs%20on%20Modern%20CPUs/#highlights","title":"Highlights","text":"<p> \u7ea6 94 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p>"},{"location":"paperreadings/vector%20search/Acceleratin%20Graph%20Indexing%20for%20ANNs%20on%20Modern%20CPUs/#potential-problems","title":"Potential Problems","text":"<ol> <li>Terrible Experiment Settings: iQAN use 64 cores and Parlay use 128 cores, but this paper only use 24 cores, so the performance may not be optimal.</li> </ol>"},{"location":"paperreadings/vector%20search/IQAN/","title":"IQAN","text":"2025-12-022025-12-10 <p>title: iQAN: Fast and Accurate Vector Search with Efficient Intra-Query Parallelism on Multi-Core Architectures \u8bba\u6587\u9605\u8bfb\u7b14\u8bb0 created: 2025-07-03 update: comments: true description: iQAN: Fast and Accurate Vector Search with Efficient Intra-Query Parallelism on Multi-Core Architectures\uff1a - Performing in-depth studies to reveal the root causes of the poor scalability of state-of-the-art vector search algorithms on multi-core architectures - Introducing intra-query parallelism optimizations, i.e., path-wise parallelism, staged expansion, and redundancy-aware synchronization to accelerate the search.</p> <p>katex: true tags:</p> <ul> <li>Paper Notes</li> <li>Vector Search</li> </ul>"},{"location":"paperreadings/vector%20search/IQAN/#highlights","title":"Highlights","text":"<p> \u7ea6 774 \u4e2a\u5b57  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <ul> <li>Performing in-depth studies to reveal the root causes of the poor scalability of state-of-the-art vector search algorithms on multi-core architectures</li> <li>Introducing intra-query parallelism optimizations, i.e., path-wise parallelism, staged expansion, and redundancy-aware synchronization to accelerate the search.</li> <li>Achieving low latency and high accuracy for graph-based algorithms on multi-core architectures.</li> </ul>"},{"location":"paperreadings/vector%20search/IQAN/#solved-problem","title":"Solved Problem","text":"<ul> <li>ANNs Challenges Analysis: This paper discusses a straightforward parallelism implementation and analyze its cost on multi-core CPUs.</li> <li>Proposed Algorithm: The paper presents a new parallel search algorithm that minimizes the search latency to reach a given recall target.</li> <li>Present parallel graph algorithms disadvantages: were designed without considering vector-based similarity search and achieving high recall under a stringent latency constraint.</li> <li>Present Parallel Graph Framework: Existing frameworks are based on vertex-centric model or its variants (e.g., edge-centric), which cannot provide enough performance benefits, because vector-based similarity search need special data formats for vector index and well-designed parallelism and synchronization mechanisms.</li> </ul>"},{"location":"paperreadings/vector%20search/IQAN/#iqan-algorithm","title":"iQAN Algorithm","text":""},{"location":"paperreadings/vector%20search/IQAN/#overview","title":"Overview","text":"<p>iQAN employs a hybrid parallelism strategy:</p> <ol> <li> <p>Global Step (Rough Synchronization): The search progresses in global \"steps.\" At the beginning of each global step, the current set of candidate nodes (in the global priority queue S) is divided among the available T workers.</p> </li> <li> <p>Local Best-First Search (Fine-Grained Parallelism): Each worker then independently performs a best-first search on its assigned subset of candidates, using its own local priority queue LS[t]. This local search continues until a condition is met (e.g., the checker indicates a sync, or the worker runs out of local candidates).</p> </li> <li> <p>Merging: After local searches, all local priority queues are merged back into the global priority queue.</p> </li> </ol>"},{"location":"paperreadings/vector%20search/IQAN/#details","title":"Details","text":"<p>This algorithm uses multi entry points, by this way, it can achieve intra-query parallelism. The algorithm is designed to efficiently utilize multiple cores by allowing each core to work on different parts of the search space simultaneously.</p> <p></p> <ol> <li> <p>Divide all unchecked vertices from S into LS: This is the global synchronization step. The candidates currently in the global queue S that haven't been \"checked\" (expanded) yet are distributed among the T local queues LS[t]. The \"unchecked\" status is important to avoid redundant work.</p> </li> <li> <p>Parallel workers search their local queues LS[t]: Each worker independently performs a best-first search on its local queue LS[t]. This is the local best-first search phase, where each worker explores its assigned candidates without needing to synchronize with others.</p> </li> <li> <p>Decide whether to continue or synchronize: The checker(also a worker) computes some average of the workers' update positions \\(\\\\overline{u}\\).</p> </li> </ol> <p>If the average progress \\(\\\\overline{u} \\\\ge L \\\\cdot R\\), it means enough work has been done locally, and a global merge should occur. doMerge is set to true to signal this.</p> <p>The checker role rotates among workers to distribute the overhead (Round-Robin way).</p> <ol> <li> <p>Merge local queues into global queue S: If the checker indicates that a merge is needed, all local queues LS[t] are merged back into the global queue S. This is the global merge step.</p> </li> <li> <p>Stop: Once the while true loop breaks (meaning no more unchecked candidates globally), the algorithm returns the top K nearest neighbors from the final global priority queue S.</p> </li> </ol>"},{"location":"paperreadings/vector%20search/IQAN/#comparison-with-delta-stepping","title":"Comparison with \\(\\\\Delta-stepping\\)","text":"<p>The idea of reducing synchronization overhead is from GraphIt, the algorithm is below:</p> <p></p> <p>The synchronization of GraphIt is updating buckets, whose element type is <code>int64_t</code> and size is 8 bytes, while iQAN's synchronization is updating bit vector, whose element type size is 1 bit. So \\(\\\\Delta-stepping\\)'s synchronization overhead is much larger than iQAN's.</p>"},{"location":"paperreadings/vector%20search/IQAN/#my-thoughts","title":"My Thoughts","text":"<ol> <li>Path-Wise Parallelism: Searching through just one entry point is wasting the potential of multi-core CPUs. iQAN's path-wise parallelism allows multiple workers to explore different paths simultaneously, significantly improving search efficiency. <p>This idea is from parallel expansion for DFS/BFS.</p> </li> <li>Staged Expansion: PP parallelism will increase addtional distance computation overhead, so iQAN increases the number of searching paths every t steps. <p>I think this idea is like TCP Congestion Control, from 1 to 2, 4, 8, ..., until a threshold, it is a exponential growth.</p> </li> <li>The AUP(Average Update Position) is crucial, it is a trade-off between the synchronization overhead and the search latency. This idea is similiar to the size of local bucket in \\(\\\\Delta-stepping\\).</li> </ol>"},{"location":"paperreadings/vector%20search/LSM-VEC/","title":"LSM-VEC","text":"2025-12-022025-12-10 <p>title: A Large-Scale Disk-Based System for Dynamic Vector Search \u8bba\u6587\u9605\u8bfb\u7b14\u8bb0 created: 2025-07-01 update: comments: true description: LSM-VEC\uff1a</p> <ul> <li>Write optimized LSM-Tree for Graph Index, just the bottom layer stored in disk, other layers in memory</li> <li>Locality-Aware graph reordering in disk</li> <li>Sampling-Guided traversal by probabilistic routing</li> </ul> <p>katex: true tags:</p> <ul> <li>Paper Notes</li> <li>Vector Search</li> </ul>"},{"location":"paperreadings/vector%20search/LSM-VEC/#highlights","title":"Highlights","text":"<p> \u7ea6 1389 \u4e2a\u5b57  8 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> <ol> <li>LSM-VEC System: This paper proposes LSM-VEC, a disk-based vector search system that integrates hierarchical graph indexing with LSM-tree storage. LSM-VEC can efficiently handle insertions, deletions, and high-recall Approximate Nearest Neighbor (ANN) queries on billion-scale datasets.</li> </ol> <p>Based on AsterDB, a previous paper that proposes a disk-based graph index system.</p> <ol> <li>Integrates LSM-tree for Efficient Dynamic Updates: LSM-VEC is the first system to incorporate LSM-trees, an index structure optimized for writes, into vector indexing, thereby effectively supporting vector insertion and deletion operations.</li> </ol> <p>Scalable</p> <ol> <li>Sampling-based Probabilistic Search Strategy: LSM-VEC improves search efficiency and reduces I/O overhead while maintaining high recall by employing a sampling-based probabilistic search strategy combined with adaptive neighbor selection.</li> </ol> <p>Maybe can not get high recall, but can get high QPS.</p> <ol> <li>Connectivity-Aware Graph Reordering: Introduces connectivity-aware graph reordering technology to further reduce I/O without the need for global graph reconstruction, optimizing vector data layout on disk and improving disk locality.</li> </ol> <p>Graph ordering is a NP-hard problem, and this paper uses GO algorithm from a previous paper</p>"},{"location":"paperreadings/vector%20search/LSM-VEC/#problems-solved","title":"Problems Solved","text":"<ol> <li> <p>Memory Limitations of Traditional ANN Indices: Addresses the problem of traditional ANN search indices (e.g., HNSW) being limited by memory constraints at large data scales, preventing them from handling billion-scale data.</p> </li> <li> <p>Inefficient Updates in DiskANN: Solves the issue where disk-based indices like DiskANN rely on offline graph construction, leading to high I/O cost and inefficient vector updates. These systems are primarily designed for static datasets and provide poor support for continuous updates.    In dynamic environments, DiskANN has two questions</p> </li> </ol> <ul> <li>requires expensive global reconstruction</li> <li>suffers from degraded search performance due to poorly connected new nodes.</li> </ul> <ol> <li>Recall and Layout Optimization in SPFresh: Addresses the problem that while existing clustering-based methods like SPFresh offer better scalability, they suffer from reduced recall due to coarse-grained partitioning, it updates by assigning new vectors to the nearest cluster. It will lead to some problems:</li> </ol> <ul> <li>Poor recall: Similar vectors may fall into different clusters, breaking neighborhood locality and leading to lower recall</li> <li>Inefficient disk layout: The in-place update design restricts the flexibility of data layout optimization, making it difficult to improve disk locality.</li> </ul>"},{"location":"paperreadings/vector%20search/LSM-VEC/#design","title":"Design","text":"<p>This system consists of three main components:</p> <ul> <li>LSM-based Hierarchical Graph Indexing Module.</li> <li>Probabilistic Sampling Query Engine.</li> <li>Connectivity-Aware Reordering Module.</li> </ul> <p></p>"},{"location":"paperreadings/vector%20search/LSM-VEC/#lsm-based-hierarchical-graph-indexing","title":"LSM-Based Hierarchical Graph Indexing","text":"<p>LSM-VEC has scalability by seperate HNSW graph into multiple levels, where each level is stored in a separate LSM-tree. The bottom level is stored on disk, while the upper levels are kept in memory. This design allows for efficient updates and queries.</p>"},{"location":"paperreadings/vector%20search/LSM-VEC/#probabilistic-sampling-query-engine","title":"Probabilistic Sampling Query Engine","text":"<p>The probabilistic filtering strategy is based on projection-based similarity scores. This way consists of several steps:</p> <p></p> <ol> <li> <p>Orthogonal Decomposition: We decompose e as $e = e_{reg} + e_{res} $ such that \\(e\\_{reg} \u22a5 e\\_{res}\\) and the direction of \\(e\\_{reg}\\) is determined as follows:     And we also have two weights \\(w\\_{reg}\\) and \\(w\\_{res}\\), \\(w\\_{reg} = \\\\Vert e\\_{reg}\\\\Vert / \\\\Vert e\\\\Vert\\), \\(w\\_{res} = \\\\Vert e\\_{res}\\\\Vert / \\\\Vert e\\\\Vert\\)</p> </li> <li> <p>Generating Projected Vectors: We generate projected vectors for decomposed sub-vector and generate projectetd vectors for original vectors.</p> </li> <li> <p>Collection of Extreme Values: In each \\(M_i\\), we collect L + 1 extreme values that yield the greatest inner products with the projected vectors.</p> </li> <li> <p>Adjust the routing algorithm:The projection vector is adjusted according to the statistical vector distribution and extreme values, and the influence of norm imbalance caused by subspace division is solved.</p> </li> </ol> <p>This step is balance subspace division and norm imbalance, which is a key step in the probabilistic routing algorithm.</p> <ol> <li> <p>Query Projection: Given query q, we normalize it to q and calculate the inner products with the projected vectors to obtain two values \\(H_1(e)\\) and \\(H_2(e)\\).</p> </li> <li> <p>Routing Test: With \\(H_1(e)\\) and \\(H_2(e)\\), we calculate \\(A_r(e)\\) as follows for l2 distance, With \\(A_r(e)\\), we design a routing test for u: If \\(A_r(e)\\) \u2265 1, it returns false. If \\(A_r(e)\\) \u2264 0, it returns true. In case 0 &lt; \\(A_r(e)\\) &lt; 1, we calculate H(e) and \\(T_r(e)\\): </p> </li> </ol>"},{"location":"paperreadings/vector%20search/LSM-VEC/#connectivity-aware-reordering","title":"Connectivity-Aware Reordering","text":"<p>Dynamically collect runtime statistics from sampling query engine, nodes frequently traversed together will be reordered together when LSM compaction occurs.</p>"},{"location":"paperreadings/vector%20search/LSM-VEC/#score-definition","title":"Score definition","text":"<p>The score function \\(S(u,v)\\) aims to quantify the \"affinity\" or \"co-access likelihood\" between two nodes (vectors) u and v. A higher score indicates that u and v are frequently accessed together or are important for each other in the search process:</p> \\[ S(u,v) = S_s(u,v) + S_n(u,v) \\\\cdot (1+\\\\lambda \\\\cdot Hamming(Hash(q), Hash(u))) \\] <ul> <li>\\(S_s (u, v) = |N_I (u) \\\\cap N_I (v)|\\) measures the number of common in-neighbors of u and v. <p>in-neighbors represent nodes from which edges point to u or v</p> </li> <li>\\(S_n (u, v)\\) counts the existence of direct edges between u and v.</li> </ul> <p>This sampling-driven score directly captures the runtime importance of each edge based on its frequency in sampled search paths, enabling the layout optimization to reflect actual query behavior.</p>"},{"location":"paperreadings/vector%20search/LSM-VEC/#goal-of-score","title":"Goal of Score","text":"<p>LSM-VEC aims to find a node permutation \\(\\\\phi(\\\\cdot)\\) that maximizes the total edge scores within a physical prefetch window of size w, following the formulation as:</p> \\[ F(\\\\phi) = \\\\sum\\_{0 &lt; \\\\phi(v) - \\\\phi(u) &lt; w} S(u, v) \\] <ul> <li>Node Permutation \\(\\\\phi(\\\\cdot)\\): This refers to the mapping of each logical node ID to a physical position on the disk. The goal is to rearrange the nodes in storage.</li> <li>Physical Prefetch Window w: This is a critical concept for disk I/O. When a disk performs an I/O operation (e.g., reading data), it typically reads data in fixed-size blocks or pages. A \"prefetch window\" of size w means that if a disk block at position i is read, all data within the range [i,i+w\u22121] (or some similar concept) can be efficiently read in a single I/O operation or a few sequential I/Os.</li> </ul> <p>Intuitively, this objective encourages frequently co-accessed nodes to be placed closely together. If two nodes u and v have a high score \\(S(u,v)\\) (meaning they are likely to be accessed together), the objective function heavily rewards placing them within the same prefetch window w.</p>"},{"location":"paperreadings/vector%20search/LSM-VEC/#graph-ordering-problemgo-algorithm","title":"Graph Ordering Problem(GO Algorithm)","text":"<p>Maximizing \\(F(\\\\phi)\\) to obtain an optimal permutation \\(\\\\phi(\\\\cdot)\\) for a directed graph G is NP-hard.</p> <p>GO algorithm prioritizes placing nodes with high \\(S(u,v)\\) scores close together. The greedy approach ensures that at each step, the node chosen to be placed next is the one that has the strongest \"ties\" (highest sum of scores) with the nodes that have just been placed within the prefetch window size.</p> <p></p> <p>LSM-VEC periodically applies a global reordering pass over the disk-resident bottom-layer graph.</p>"},{"location":"paperreadings/vector%20search/LSM-VEC/#operation-in-lsm-vec","title":"Operation in LSM-VEC","text":""},{"location":"paperreadings/vector%20search/LSM-VEC/#insertion-in-lsm-vec","title":"Insertion in LSM-VEC","text":"<ol> <li>The vector is assigned to a random level L sampled from an exponentially decaying distribution\uff1a    - At each level l (except the bottom layer), the system identifies approximate neighbors and connects the vector to the top-M closest nodes using in-memory search.    - At the bottom layer, neighbor search is conducted on the disk-resident graph stored in the LSM-tree. The vector is connected to the top-M nearest disk-resident nodes, and the resulting edges are written to the LSM-tree for durable storage. </li> </ol>"},{"location":"paperreadings/vector%20search/LSM-VEC/#deletion-in-lsm-vec","title":"Deletion in LSM-VEC","text":"<ol> <li>In memory, its immediate neighbors are reconnected using approximate neighbor search to preserve local graph connectivity.</li> <li>In the disk layer, LSM-VEC identifies affected nodes and inserts new edges into AsterDB, avoiding full reindexing.</li> <li>After relinking neighbors, the system removes all edges involving the deleted node from AsterDB and deletes the corresponding vector data.</li> </ol>"},{"location":"paperreadings/vector%20search/LSM-VEC/#search-in-lsm-vec","title":"Search in LSM-VEC","text":"<ol> <li>Search the memory-resident layers of the LSM-tree to find the top-k nearest neighbors.</li> <li>If the top-k neighbors are not sufficient, the system will traverse the disk-resident layers of the LSM-tree. We should use the probabilistic sampling query engine to efficiently filter out irrelevant nodes and reduce the number of disk accesses.</li> </ol>"},{"location":"paperreadings/vector%20search/LSM-VEC/#results","title":"Results","text":"<p>Probabilistic sampling can substantially improve efficiency with minimal impact on accuracy. It is a key component of LSM-VEC, enabling scalable and latency-aware vector search under dynamic workloads.</p> <p>As sample ratio increases, QPS improves significantly, while recall remains stable.</p> <p></p>"},{"location":"paperreadings/vector%20search/LSM-VEC/#potential-questions","title":"Potential Questions","text":"<ol> <li>Write Amplification: This is a original problem of LSM-tree, and it is not mentioned in this paper. How does LSM-VEC handle write amplification when updating data?</li> <li>Graph Ordering Frequency: The paper mentions that the graph ordering is performed periodically. How often does this reordering occur, and how does it impact the performance of the system?</li> <li>High Recall(over 0.95): The paper does not mention whether the system can achieve high recall (over 0.95) in all scenarios. What are the conditions or limitations for achieving such high recall?</li> </ol>"},{"location":"paperreadings/vector%20search/LSM-VEC/#references","title":"References","text":"<ol> <li>A Large-Scale Disk-Based System for Dynamic Vector Search</li> <li>Speedup graph processing by graph ordering</li> <li>Probabilistic Routing for Graph-Based Approximate Nearest Neighbor Search</li> </ol>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/","title":"MIRAGE-ANNS","text":"2025-12-022025-12-10 <p>title: MIRAGE-ANNS: Mixed Approach Graph-based Indexing for Approximate Nearest Neighbor Searcha Layout for Vector Similarity Search created: 2025-06-10 update: comments: true description: MIRAGE-ANNS: Mixed Approach Graph-based Indexing for Approximate Nearest Neighbor Searcha Layout for Vector Similarity Search</p> <ul> <li>Constructs the index as fast as refinement-based approaches while retaining search performance comparable or better than increment-based ones</li> </ul> <p>katex: true tags:</p> <ul> <li>Paper Notes</li> <li>Vector Search</li> </ul>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#findings","title":"Findings","text":"<p> \u7ea6 709 \u4e2a\u5b57  6 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <ol> <li>Refinement-based approaches such as NSG and NN-Descent use the most memory to build the index, because they first build an approximate KNN graph</li> <li>Reverse edge addition to the Layer 0 of MIRAGE for optimal search performance.</li> <li>When the out-degree is the same, the hierarchical solution is able to achieve better search performance due to providing better entry points to the bottom layer than randomly choosing a start point. <p>having longer edges that can traverse the whole graph quickly and provide good entry points for the lower layer</p> </li> <li>The reason for the fewer computations is because MIRAGE has a lower average out-degree than HNSW at Layer 0.</li> <li>HNSW does not benefit from hierarchy due to a small subset of well-connected nodes (hubs)\uff0cwhile Layer 0 and upper layers of MIRAGE are constructed using different approaches.</li> </ol>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#highlights","title":"Highlights","text":"<ol> <li>We propose MIRAGE, a new approach to constructing graph-based indexes using refinementbased construction to create the bottom layer of the graph, and then building layers above in an increment-based manner, with upper layers containing fewer points and longer links, and lower layers containing more points and shorter links.</li> <li>The search uses a greedy algorithm starting from the highest layer and continuing down to the lowest layer.</li> </ol>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#background","title":"BackGround","text":""},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#refinement-based-graph-construction","title":"Refinement-based Graph Construction","text":"<p>Index construction is fast primarily because the randomly-connected graph is available at the start and is refined iteratively to improve its quality, rather than building the graph incrementally. Now most algorithms construct a approximate k\u2212nearest neighbor graph (kNNG) not a K-Graph, because K-Graph has a loss of navigability caused by too high of an out-link density.</p> <p>the neighbor of my neighbor is likely to be my neighbor</p> <p>NSG first builds a graph using NN-Descent and then prunes using an edge selection strategy based on the RNG rule.</p> <p></p>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#increment-based-graph-construction","title":"Increment-based Graph Construction","text":"<p>This kind of graph starts with an empty graph and treats every point being added as a query, performing ANNS on the current graph to find the k nearest neighbors of the newly inserted point.</p> <p></p>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#motivation","title":"Motivation","text":"<ul> <li>Efficient construction</li> <li>Global navigability</li> <li>Local precision</li> </ul>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#overview","title":"Overview","text":"<p>MIRAGE indexes all points starting with a randomly connected graph and progressively refines it while pruning at the same time.</p> <p>MIRAGE addresses global navigability and local precision by incrementally building upper layers with a subset of points that contain long-range links that enable rapid traversal across the graph.</p> <p>MIRAGE builds a hierarchical structure, where the bottom layer (Layer 0) of the graph is constructed using a refinement-based approach, and then creates layers on top (Layers 1 to N ) following an increment-based approach. </p>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#graph-construction","title":"Graph Construction","text":"<ol> <li>Layer 0: The bottom layer is constructed using a refinement-based approach, where the graph is built from a randomly connected graph and refined iteratively to improve its quality.    MIRAGE finds neighbors using a traditional NN-Descent algorithm and prunes edges at the same time using the RNG rule.</li> </ol> <ul> <li>use insights from RNNDescent to first check whether the RNG rule is satisfied before adding the edge</li> <li>maintain a flag for each vertex indicating whether it is \"new\" or \"old\" to help eliminate duplicate distance comparisons of the same vertices</li> <li>adds reverse edges to complete the bottom layer of the graph</li> <li>limit the maximum out-degree of the constructed graph, pruning every vertex in Layer 0 down to M neighbors using the RNG rule</li> </ul> <ol> <li>Layer 1 to N: The upper layers are constructed incrementally, where each layer contains a subset of points that are selected based on their distance to the points in the lower layer.</li> </ol> <ul> <li>Each point in the dataset is assigned a layer by the distribution and then first inserted at the corresponding layer</li> <li>it finds its M nearest neighbors using Algorithm 1, moves down a layer and repeats the same process stopping after being inserted at layer 1</li> <li>selecting neighbors at each layer, if the value of M is exceeded for any vertex, we use the RNG rule to prune edges.</li> </ul>"},{"location":"paperreadings/vector%20search/MIRAGE-ANNS/#search-algorithm","title":"Search Algorithm","text":""},{"location":"paperreadings/vector%20search/PANNS/","title":"PANNS","text":"2025-12-022025-12-10 <p>title: PANNS: Enhancing Graph-based Approximate Nearest Neighbor Search through Recency-aware Construction and Parameterized Search created: 2025-07-09 update: comments: true description: PANNS: Enhancing Graph-based Approximate Nearest Neighbor Search through Recency-aware Construction and Parameterized Search</p> <ul> <li>Providing an in-depth analysis of the graph-based ANNS workload, highlighting its optimization space.</li> <li>Offering a more detailed parameterized search strategy that allows for flexible trade-offs between search speed and accuracy.</li> <li>To incorporate hidden dimensions not embedded into vectors (e.g., temporal information), we propose a new proximity graph construction algorithm and a graph memory layout optimization.</li> </ul> <p>katex: true tags:</p> <ul> <li>Paper Notes</li> <li>Vector Search</li> </ul>"},{"location":"paperreadings/vector%20search/PANNS/#perspectives","title":"Perspectives","text":"<p> \u7ea6 252 \u4e2a\u5b57  5 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> <ol> <li>This paper reveals that it is not worthwhile to exploit intra-iteration and intra-query parallelism.</li> <li>Not every iteration in searching contributes equally to the final result, so it is not necessary to wait for all iterations to finish. </li> <li>The paper reveals that the input queries and their ANNS results exhibit a notable temporal correlation in many real-world datasets.</li> </ol>"},{"location":"paperreadings/vector%20search/PANNS/#core-ideas","title":"Core Ideas","text":""},{"location":"paperreadings/vector%20search/PANNS/#parameterized-beam-search","title":"Parameterized Beam Search","text":""},{"location":"paperreadings/vector%20search/PANNS/#recency-aware-graph-construction","title":"Recency-aware Graph Construction","text":""},{"location":"paperreadings/vector%20search/PANNS/#graph-layout-optimization","title":"Graph Layout Optimization","text":""},{"location":"paperreadings/vector%20search/PANNS/#selective-neighbor-scan","title":"Selective Neighbor Scan","text":"<p>This early termination of neighbor scanning has two advantages:</p> <ol> <li>it avoids fetching unpromising vector data from the memory;</li> <li>unpromising distance computations are also circumvented.</li> </ol> <p></p>"},{"location":"paperreadings/vector%20search/PANNS/#vertex-reordering","title":"Vertex reordering","text":"<p>To avoid random access and simplify the selection logic, we propose a graph layout optimization. The idea is that, after the graph is constructed, we sort each vertex\u2019s out-neighbor list based on the timestamp.</p> <p>Then, at each iteration of the beam search, only a fraction of the vertex\u2019s out-neighbors is fetched and evaluated.</p>"},{"location":"paperreadings/vector%20search/PANNS/#potential-problems","title":"Potential Problems","text":""},{"location":"paperreadings/vector%20search/PDX/","title":"PDX","text":"2025-12-022025-12-10 <p>title: PDX: A Data Layout for Vector Similarity Search created: 2025-07-09 update: comments: true description: PDX: A Data Layout for Vector Similarity Search</p> <ul> <li>The design of PDX, a new data layout for vectors alongside PDXearch: a framework to perform pruned VSS dimension-by-dimension.</li> <li>The design and evaluation of PDX-BOND: A VSS algorithm that leverages the PDX layout to visit first the most relevant dimensions relative to the incoming query.</li> <li>To incorporate hidden dimensions not embedded into vectors (e.g., temporal information), we propose a new proximity graph construction algorithm and a graph memory layout optimization.</li> </ul> <p>katex: true tags:</p> <ul> <li>Paper Notes</li> <li>Vector Search</li> </ul>"},{"location":"paperreadings/vector%20search/PDX/#perspectives","title":"Perspectives","text":"<p> \u7ea6 138 \u4e2a\u5b57  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p>"},{"location":"paperreadings/vector%20search/PDX/#core-ideas","title":"Core Ideas","text":""},{"location":"paperreadings/vector%20search/PDX/#pdx-data-layout","title":"PDX Data Layout","text":"<p>PDX stores dimensions in a vertical layout, allowing efficient dimension-by-dimension distance calculation, more opportunities for SIMD execution, and better memory locality for search algorithms that prune dimensions.</p> <p></p>"},{"location":"paperreadings/vector%20search/PDX/#distance-kernels-auto-vectorization","title":"Distance kernels auto-vectorization","text":""},{"location":"paperreadings/vector%20search/idea/vector_search/","title":"My Idea of Vector Search","text":""},{"location":"paperreadings/vector%20search/idea/vector_search/#my-idea-of-vector-search","title":"My Idea of Vector Search","text":"<p> \u7ea6 917 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> 2025-12-022025-12-10 <ol> <li>\u5206\u5c42\uff1a\u5e95\u90e8\u662f\u4e00\u4e2a\u7c7b\u4f3c NSG \u7684\u56fe\uff0c\u4e0a\u9762\u53ea\u6709\u4e00\u5c42\u901a\u8fc7\u805a\u7c7b\u7b49\u65b9\u5f0f\u6784\u5efa\u7684\u56fe\u3002 <p>\u7c7b\u4f3c\u7c97\u7c92\u5ea6\u7d22\u5f15\u5148\u83b7\u53d6\u5019\u9009\u5b50\u96c6\uff0c\u7136\u540e\u7528\u8fd9\u4e9b\u5b50\u96c6\u4f5c\u4e3a\u5165\u53e3\u70b9\u5230\u5e95\u90e8\u56fe\u4e2d\u8fdb\u884c\u7cbe\u786e\u641c\u7d22\u3002</p> </li> <li>\u5e76\u884c\u641c\u7d22\uff1a\u7c7b\u4f3c iQAN \u7684\u601d\u60f3\uff0c\u4f7f\u7528\u591a\u5165\u53e3\u70b9\u8fdb\u884c\u5e76\u884c\u641c\u7d22\u3002    - \u8003\u8651\u4f18\u5316 iQAN:Efficient Graph-Based Approximate Nearest Neighbor Search Achieving: Low Latency Without Throughput Loss</li> <li>\u90bb\u5c45\u9009\u62e9\uff1a\u901a\u8fc7\u65b0\u7684\u65b9\u5f0f\uff0c\u6bd4\u5982\u89d2\u5ea6\u8ddd\u79bb\u7b49\u65b0\u53d1\u8868\u7684\u6587\u7ae0\u6765\u9009\u62e9\u90bb\u5c45\uff0c\u800c\u4e0d\u662f\u7b80\u5355\u7684\u6b27\u6c0f\u8ddd\u79bb\u3002</li> <li>\u4f7f\u7528\u91cf\u5316\uff1a1-bit \u91cf\u5316</li> <li>\u51cf\u5c11\u8ba1\u7b97\u91cf\uff1a\u6bd4\u5982\u901a\u8fc7\u6982\u7387\u8def\u7531\u6216\u5176\u4ed6\u4e0d\u7b49\u5f0f\u526a\u679d\u65b9\u5f0f\u6765\u5b9e\u73b0</li> </ol>"},{"location":"paperreadings/vector%20search/idea/vector_search/#vertical-layout-for-hnsw-from-pdx-a-data-layout-for-vector-similarity-search","title":"Vertical layout for HNSW from PDX: A Data Layout for Vector Similarity Search","text":"<ul> <li>dimension-by-dimension search strategy that operates on multiple-vectors-at-a-time in tight loops.</li> </ul>"},{"location":"paperreadings/vector%20search/idea/vector_search/#hubs-idea-from-down-with-the-hierarchy-the-h-in-hnsw-stands-for-hubs","title":"Hubs idea from Down with the Hierarchy: The \u2018H\u2019 in HNSW Stands for \u201cHubs\u201d","text":"<p>\u52a8\u6001\u7684\u67a2\u7ebd\u8bc6\u522b\u548c\u8fb9\u7ba1\u7406\u7b56\u7565\u3002</p> <ol> <li>\u52a8\u6001\u67a2\u7ebd\u5224\u65ad: \u8981\u5224\u65ad\u4e00\u4e2a\u8282\u70b9\u662f\u5426\u662f\u67a2\u7ebd\uff0c\u4f60\u9700\u8981\u77e5\u9053\u5b83\u7684 k-occurrence\uff0c\u5373\u6709\u591a\u5c11\u4e2a\u5176\u4ed6\u8282\u70b9\u5c06\u5176\u4f5c\u4e3a K \u8fd1\u90bb\u4e4b\u4e00\u3002\u5728\u589e\u91cf\u6784\u5efa\u4e2d\uff0c\u8fd9\u9700\u8981\u52a8\u6001\u66f4\u65b0\u3002</li> </ol> <ul> <li>\u7ef4\u62a4\u53cd\u5411\u90bb\u5c45\u5217\u8868 (Reverse Neighbor List)\uff1a \u5bf9\u4e8e\u6bcf\u4e2a\u8282\u70b9 P\uff0c\u4e0d\u4ec5\u5b58\u50a8\u5b83\u7684 K \u8fd1\u90bb N(P)\uff0c\u8fd8\u8981\u7ef4\u62a4\u4e00\u4e2a\u5217\u8868 R(P)\uff0c\u8bb0\u5f55\u6240\u6709\u5c06 P \u4f5c\u4e3a\u5176 K \u8fd1\u90bb\u7684\u8282\u70b9\u3002</li> </ul> <p>\u5f53\u4e00\u4e2a\u65b0\u8282\u70b9 Q \u52a0\u5165\u5e76\u8ba1\u7b97\u5176 K \u8fd1\u90bb\u65f6\uff0c\u5bf9\u4e8e Q \u7684\u6bcf\u4e2a\u8fd1\u90bb \\(P_j\\)\uff0c\u5c06 Q \u6dfb\u52a0\u5230 \\(P_j\\) \u7684 \\(R(P_j)\\) \u5217\u8868\u4e2d\u3002</p> <p>\u4e00\u4e2a\u8282\u70b9\u7684 k-occurrence \u503c\u5c31\u662f\u5176 R(P) \u5217\u8868\u7684\u5927\u5c0f\u3002</p> <ul> <li>Top-N \u67a2\u7ebd\uff1a \u4e5f\u53ef\u4ee5\u7ef4\u62a4\u4e00\u4e2a\u5f53\u524d\u56fe\u4e2d\u6700\u6d3b\u8dc3\u7684 Top-N \u4e2a\u67a2\u7ebd\u5217\u8868\u3002</li> </ul> <p>\u9891\u7387\u66f4\u65b0\uff1a \u968f\u7740\u65b0\u8282\u70b9\u7684\u52a0\u5165\uff0c\u5b9a\u671f\uff08\u4f8b\u5982\u6bcf\u52a0\u5165 M \u4e2a\u8282\u70b9\u540e\uff09\u91cd\u65b0\u8bc4\u4f30\u6240\u6709\u8282\u70b9\u7684 k-occurrence \u503c\uff0c\u5e76\u66f4\u65b0\u67a2\u7ebd\u5217\u8868\u3002</p> <ol> <li>\u67a2\u7ebd\u4f18\u5148\u4fdd\u7559\u7b56\u7565</li> </ol> <ul> <li>\u5f53\u4e00\u4e2a\u65b0\u8282\u70b9 Q \u52a0\u5165\u65f6\uff0c\u5b83\u4f1a\u8fde\u63a5\u5230\u73b0\u6709\u56fe\u4e2d\u7684\u4e00\u4e9b\u8282\u70b9\u3002\u5728\u51b3\u5b9a\u4fdd\u7559\u54ea\u4e9b\u8fb9\u65f6\uff0c\u53ef\u4ee5\u5e94\u7528\u67a2\u7ebd\u4f18\u5148\u7b56\u7565\uff1a</li> </ul> <ol> <li>\u521d\u59cb\u8fb9\u8fde\u63a5\uff1a \u5f53 Q \u52a0\u5165\u65f6\uff0c\u9996\u5148\u4e3a\u5176\u627e\u5230 L \u4e2a\u521d\u59cb\u8fd1\u90bb\uff08L \u901a\u5e38\u5927\u4e8e\u6700\u7ec8\u9700\u8981\u7684 R\uff09\u3002</li> <li>\u67a2\u7ebd\u8fde\u63a5\u504f\u597d\uff1a \u5728\u526a\u679d\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u4f60\u6709\u591a\u4e2a\u5019\u9009\u8fb9\u53ef\u4ee5\u9009\u62e9\u4fdd\u7559\uff0c\u800c\u5176\u4e2d\u4e00\u4e9b\u8fb9\u8fde\u63a5\u5230\u5df2\u8bc6\u522b\u7684\u67a2\u7ebd\uff0c<ul> <li>\u63d0\u9ad8\u6743\u91cd\uff1a \u8d4b\u4e88\u8fde\u63a5\u5230\u67a2\u7ebd\u7684\u8fb9\u66f4\u9ad8\u7684\u201c\u4f18\u5148\u7ea7\u201d\u6216\u201c\u6743\u91cd\u201d\uff0c\u4f7f\u5176\u5728\u6700\u7ec8\u7684 R \u4e2a\u51fa\u5ea6\u9650\u5236\u4e2d\u66f4\u5bb9\u6613\u88ab\u4fdd\u7559\u3002</li> <li>\u989d\u5916\u8fde\u63a5\u9884\u7b97\uff1a \u53ef\u4ee5\u4e3a\u67a2\u7ebd\u5206\u914d\u4e00\u4e2a\u989d\u5916\u7684\u8fde\u63a5\u9884\u7b97\uff0c\u5141\u8bb8\u5b83\u4eec\u8fde\u63a5\u66f4\u591a\u7684\u8fb9\uff0c\u6216\u8005\u786e\u4fdd\u5b83\u4eec\u81f3\u5c11\u6709\u4e00\u5b9a\u6570\u91cf\u7684\u5165\u8fb9\uff08\u4ece\u975e\u67a2\u7ebd\u8fde\u63a5\u5230\u5b83\u4eec\u7684\u8fb9\uff09\u3002</li> </ul> </li> <li>\u53cc\u5411\u9a8c\u8bc1\uff1a \u5982\u679c Q \u7684\u4e00\u4e2a\u8fd1\u90bb P \u662f\u67a2\u7ebd\uff0c\u5e76\u4e14 P \u4e5f\u5c06 Q \u8bc6\u522b\u4e3a\u5176\u8fd1\u90bb\uff0c\u5219\u8fd9\u6761\u8fb9\u88ab\u8ba4\u4e3a\u66f4\u91cd\u8981\uff0c\u66f4\u503e\u5411\u4e8e\u4fdd\u7559\u3002</li> </ol> <ul> <li>\u4f18\u5316\u526a\u679d\u7b97\u6cd5\uff1a</li> </ul> <p>\u5728\u526a\u679d\u9636\u6bb5\uff0c\u5f53\u51b3\u5b9a\u4ece\u4e00\u4e2a\u8282\u70b9\u7684\u90bb\u5c45\u5217\u8868\u4e2d\u79fb\u9664\u54ea\u4e9b\u8fb9\u65f6\uff0c\u67a2\u7ebd\u4f18\u5148\u7b56\u7565\u53ef\u4ee5\u4ecb\u5165\u3002\u4f8b\u5982\uff0c\u5728\u79fb\u9664\u8fb9\u4e4b\u524d\uff0c\u68c0\u67e5\u8fd9\u4e9b\u8fb9\u662f\u5426\u8fde\u63a5\u5230\u67a2\u7ebd\u3002\u5982\u679c\u4e00\u6761\u8fb9\u8fde\u63a5\u5230\u4e00\u4e2a\u9ad8 k-occurrence \u7684\u67a2\u7ebd\uff0c\u5373\u4f7f\u5b83\u7684\u8ddd\u79bb\u7565\u8fdc\uff0c\u4e5f\u53ef\u80fd\u88ab\u4f18\u5148\u4fdd\u7559\uff0c\u800c\u4e0d\u662f\u88ab\u90a3\u4e9b\u8ddd\u79bb\u66f4\u8fd1\u4f46\u8fde\u63a5\u5230\u201c\u666e\u901a\u201d\u8282\u70b9\u7684\u8fb9\u66ff\u4ee3\u3002</p> <p>\u89d2\u5ea6\u4e0e\u67a2\u7ebd\u7ed3\u5408\uff1a \u53ef\u4ee5\u5c06\u89d2\u5ea6\u526a\u679d\uff08\u786e\u4fdd\u90bb\u5c45\u5728\u7a7a\u95f4\u4e2d\u5747\u5300\u6269\u6563\uff09\u4e0e\u67a2\u7ebd\u504f\u597d\u7ed3\u5408\u3002\u4f8b\u5982\uff0c\u5373\u4f7f\u4e00\u6761\u8fb9\u5bfc\u81f4\u89d2\u5ea6\u8f83\u5c0f\uff0c\u5982\u679c\u5b83\u8fde\u63a5\u5230\u4e00\u4e2a\u5173\u952e\u67a2\u7ebd\uff0c\u4e5f\u53ef\u80fd\u88ab\u4f8b\u5916\u4fdd\u7559\u3002</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/","title":"KR 3D Active SLAM \u7cfb\u7edf\u67b6\u6784\u8be6\u89e3","text":""},{"location":"projects/active%20slam/kr%203d%20active%20slam/#kr-3d-active-slam","title":"KR 3D Active SLAM \u7cfb\u7edf\u67b6\u6784\u8be6\u89e3","text":"<p> \u7ea6 3075 \u4e2a\u5b57  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 15 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#_1","title":"\u5206\u5c42","text":""},{"location":"projects/active%20slam/kr%203d%20active%20slam/#_2","title":"\u4f20\u611f\u5668\u4e0e\u8f93\u5165\u5c42","text":"<p>\u5b9e\u9645\u7cfb\u7edf\u4f7f\u7528\u4ee5\u4e0b\u8f93\u5165\u6e90\uff1a</p> <ul> <li>VIO \u91cc\u7a0b\u8ba1\uff1a/quadrotor/vio/odom</li> <li>\u8bed\u4e49\u5206\u5272\u70b9\u4e91\uff08\u540c\u6b65\u7684\uff09\uff1a/sem_detection/sync_pc_odom</li> <li>\u539f\u59cb\u63a7\u5236\u91cc\u7a0b\u8ba1\uff1a/dragonfly67/quadrotor_ukf/control_odom</li> </ul>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#sloam","title":"\u611f\u77e5\u4e0e\u5efa\u56fe\u5c42\uff08SLOAM \u6838\u5fc3\uff09","text":""},{"location":"projects/active%20slam/kr%203d%20active%20slam/#process_cloud_node-python","title":"process_cloud_node (Python \u8282\u70b9)","text":"<p>\u4e3b\u8981\u804c\u8d23\uff1a</p> <ul> <li>\u63a5\u6536\u8bed\u4e49\u5206\u5272\u70b9\u4e91\uff0c\u63d0\u53d6\u6811\u6728\u3001\u8f66\u8f86\u3001\u5730\u9762\u7b49\u8bed\u4e49\u76ee\u6807   = \u8fdb\u884c DBSCAN \u805a\u7c7b\u8bc6\u522b\u8f66\u8f86\u5b9e\u4f8b   = \u62df\u5408 3D cuboid \u5305\u56f4\u76d2</li> <li>\u76ee\u6807\u8ddf\u8e2a\u4e0e\u6570\u636e\u5173\u8054</li> <li>\u53d1\u5e03\u8bed\u4e49\u6d4b\u91cf\uff08range-bearing measurements\uff09</li> </ul> <p>\u5173\u952e Topic\uff1a</p> <p>\u8ba2\u9605\uff1a/sem_detection/sync_pc_odom (\u8bed\u4e49\u5206\u5272\u70b9\u4e91+\u91cc\u7a0b\u8ba1) \u53d1\u5e03\uff1a</p> <ul> <li>/semantic_range_bearing_measurements (ROSRangeBearing \u6d88\u606f)</li> <li>/tree_cloud (\u6811\u6728\u70b9\u4e91)</li> <li>/ground_cloud (\u5730\u9762\u70b9\u4e91)</li> <li>/car_cuboids (\u8f66\u8f86\u5305\u56f4\u76d2 MarkerArray)</li> <li>/quadrotor/lidar_odom (\u91cc\u7a0b\u8ba1)</li> </ul>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#activeslaminputnode-c-slam","title":"ActiveSlamInputNode (C++\u6838\u5fc3 SLAM \u8282\u70b9)","text":"<p>\u4e3b\u8981\u804c\u8d23\uff1a</p> <ul> <li>\u63a5\u6536 VIO \u91cc\u7a0b\u8ba1\u548c\u8bed\u4e49\u6d4b\u91cf</li> <li>\u7ef4\u62a4\u53cc\u56e0\u5b50\u56fe\uff08\u4e3b\u56fe isam + \u4fe1\u606f\u589e\u76ca\u8bc4\u4f30\u56fe isam_loop\uff09</li> <li>\u589e\u91cf\u5f0f SLAM \u4f18\u5316\uff08GTSAM/ISAM2\uff09</li> <li>\u4e3b\u52a8\u56de\u73af\u95ed\u5408\u7ba1\u7406</li> <li>\u53d1\u5e03\u9ad8\u9891 SLOAM \u91cc\u7a0b\u8ba1</li> </ul> <p>\u5173\u952e Topic\uff1a</p> <p>\u8ba2\u9605\uff1a</p> <ul> <li> <p>/quadrotor/vio/odom (VIO \u91cc\u7a0b\u8ba1)</p> </li> <li> <p>/semantic_range_bearing_measurements (\u8bed\u4e49\u6d4b\u91cf)</p> </li> <li> <p>/loop_closure/odom (\u56de\u73af\u68c0\u6d4b\u7ed3\u679c)   \u53d1\u5e03\uff1a</p> </li> <li> <p>/quadrotor/high_freq_pose (\u9ad8\u9891\u4f4d\u59ff)</p> </li> <li> <p>/quadrotor/high_freq_odom (\u9ad8\u9891\u91cc\u7a0b\u8ba1)</p> </li> <li> <p>/optimized_trajectory (\u4f18\u5316\u540e\u8f68\u8ff9 MarkerArray)</p> </li> <li> <p>/optimized_point_landmarks (\u4f18\u5316\u540e\u5730\u6807 MarkerArray)</p> </li> <li> <p>/quadrotor/sloam_to_vio_odom (\u6f02\u79fb\u8865\u507f\u53d8\u6362) Action Server\uff1a</p> </li> <li> <p>/loop_closure/active_loop_closure_server (\u4e3b\u52a8\u56de\u73af\u95ed\u5408) activeSlamInputNode.cpp:123-124   Service Server\uff1a</p> </li> <li> <p>/estimate_info_gain_server (\u4fe1\u606f\u589e\u76ca\u4f30\u8ba1) activeSlamInputNode.cpp:145-147</p> </li> </ul>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#_3","title":"\u63a2\u7d22\u89c4\u5212\u4e0e\u63a7\u5236\u5c42","text":""},{"location":"projects/active%20slam/kr%203d%20active%20slam/#msexplorationfsm","title":"msExplorationFSM (\u63a2\u7d22\u6709\u9650\u72b6\u6001\u673a)","text":"<p>\u4e3b\u8981\u804c\u8d23\uff1a</p> <ul> <li>\u7ba1\u7406\u63a2\u7d22\u72b6\u6001\uff0c\u534f\u8c03\u63a2\u7d22\u89c4\u5212\u5668\u548c\u8f68\u8ff9\u6267\u884c</li> <li>\u89e6\u53d1\u4e3b\u52a8\u56de\u73af\u95ed\u5408</li> <li>\u7cfb\u7edf\u72b6\u6001\u5305\u62ec\uff1aINIT, WAIT_TRIGGER, INIT_ROTATE, PLAN_BEHAVIOR, REPLAN_TRAJ, EXEC_TRAJ, FINISH, EMERGENCY_STOP, CLOSURE_PANO ms_exploration_fsm.cpp:38</li> </ul> <p>\u5173\u952e Topic\uff1a</p> <p>\u8ba2\u9605\uff1a</p> <ul> <li>/odom_slam (SLAM \u91cc\u7a0b\u8ba1) ms_exploration_fsm.cpp:49</li> <li>/odom_vio (VIO \u91cc\u7a0b\u8ba1) ms_exploration_fsm.cpp:50-51</li> <li>/waypoints (\u89e6\u53d1\u5668) ms_exploration_fsm.cpp:48   \u53d1\u5e03\uff1a</li> <li>/tracker_cmd (\u8f68\u8ff9\u8ddf\u8e2a\u6307\u4ee4) ms_exploration_fsm.cpp:52</li> </ul> <p>Action Client\uff1a</p> <p>\u8fde\u63a5\u5230 /loop_closure/active_loop_closure_server</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#_4","title":"\u6570\u636e\u6d41","text":""},{"location":"projects/active%20slam/kr%203d%20active%20slam/#topic","title":"Topic \u603b\u7ed3","text":""},{"location":"projects/active%20slam/kr%203d%20active%20slam/#ground-truth-and-odometry-topics","title":"Ground Truth and Odometry Topics","text":"<p>/ddk/ground_truth/odom \u53d1\u5e03\u8005 \uff1a\u6a21\u62df\u6a21\u5f0f\u4e0b\u7684 Gazebo \u6a21\u62df\u5668 \u8ba2\u9605\u8005 \uff1a\u63a7\u5236\u5668\u548c\u4f20\u611f\u5668\u6a21\u62df\u8282\u70b9 \u529f\u80fd \uff1a\u63d0\u4f9b\u6765\u81ea\u7269\u7406\u6a21\u62df\u5668\u7684\u5730\u9762\u771f\u5b9e\u91cc\u7a0b\u8868\uff0c\u7528\u4e8e\u6a21\u62df\u6d4b\u8bd5\u3002gazebo_sim.launch :26</p> <p>/gt_odom and /gt_odom_perturbed \u529f\u80fd \uff1a\u8be5\u811a\u672c\u5c06\u9ad8\u65af\u566a\u58f0\uff08\u4f4d\u7f6e\u548c\u65b9\u5411\u6270\u52a8\uff09\u6dfb\u52a0\u5230\u5730\u9762\u771f\u5b9e\u91cc\u7a0b\u8ba1\u4e2d\uff0c\u4ee5\u6a21\u62df VIO \u6f02\u79fb\u5e76\u6d4b\u8bd5 SLAM \u9c81\u68d2\u6027\u3002\u6270\u52a8\u4f1a\u968f\u7740\u884c\u9a76\u8ddd\u79bb\u7684\u589e\u52a0\u800c\u7d2f\u79ef\u3002add_noise_to_ground_truth_odom.py \uff1a35-36</p> <p>/quadrotor/high_freq_odom and /quadrotor/high_freq_pose \u53d1\u5e03\u8005 \uff1a activeSlamInputNode.cpp \u4e2d\u7684 ActiveSlamInputNode \u529f\u80fd \uff1a\u901a\u8fc7\u5c06\u6700\u65b0\u4f18\u5316\u7684 SLAM \u5173\u952e\u59ff\u6001\u4e0e\u76f8\u5bf9 VIO \u8fd0\u52a8\u76f8\u7ed3\u5408\uff0c\u53d1\u5e03\u9ad8\u9891 (20 Hz) SLAM \u6821\u6b63\u91cc\u7a0b/\u59ff\u6001\u3002\u8fd9\u53ef\u5728 SLAM \u4f18\u5316\u66f4\u65b0\u4e4b\u95f4\u63d0\u4f9b\u5e73\u6ed1\u7684\u3001\u6f02\u79fb\u6821\u6b63\u7684\u72b6\u6001\u4f30\u8ba1\u3002activeSlamInputNode.cpp :53-67</p> <p>/quadrotor/lidar_odom \u53d1\u5e03\u8005 \uff1a process_cloud_node.py \u529f\u80fd \uff1a\u53d1\u5e03\u57fa\u4e8e\u6fc0\u5149\u96f7\u8fbe\u7684\u91cc\u7a0b\u8ba1\u4ee5\u8fdb\u884c SLOAM \u5904\u7406\u3002process_cloud_node.py \uff1a231-232</p> <p>/quadrotor/vio/odom \u529f\u80fd \uff1a\u539f\u59cb\u89c6\u89c9\u60ef\u6027\u91cc\u7a0b\u8ba1\u7684\u8f93\u5165\u4e3b\u9898\uff0c\u5728\u5e94\u7528 SLAM \u6821\u6b63\u4e4b\u524d\u7531 SLOAM \u8282\u70b9\u8ba2\u9605\u3002</p> <p>/quadrotor/sloam_to_vio_odom \u53d1\u5e03\u8005 \uff1a ActiveSlamInputNode \u529f\u80fd \uff1a\u53d1\u5e03\u4ece SLOAM \u6846\u67b6\u5230 VIO \u6846\u67b6\u7684\u8f6c\u6362\uff0c\u8ba1\u7b97\u7ed3\u679c\u4e3a vio_odom * sloam_odom.inverse() \u3002\u63a2\u7d22\u89c4\u5212\u5668\u4f7f\u7528\u5b83\u6765\u8865\u507f\u5750\u6807\u7cfb\u4e4b\u95f4\u7684\u6f02\u79fb\u3002</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#sensor-simulation-topics-pcl_render_node","title":"Sensor Simulation Topics (pcl_render_node)","text":"<p>/pcl_render_node/depth, /pcl_render_node/colordepth, /pcl_render_node/sensor_pose \u53d1\u5e03\u8005 : pcl_render_node \u8ba2\u9605\u8005 \uff1a\u52d8\u63a2\u7ba1\u7406\u5668\u548c\u6d4b\u7ed8\u8282\u70b9</p> <p>/depth \uff1a\u4f7f\u7528 GPU \u52a0\u901f CUDA \u4ece\u70b9\u4e91\u6e32\u67d3\u7684\u539f\u59cb\u6df1\u5ea6\u56fe\u50cf\uff08CV_32FC1\uff09 /colordepth: Colorized depth visualization with rainbow colormap (BGR8) /sensor_pose: Camera pose in world frame pcl_render_node.cpp:392-396 /pcl_render_node/rendered_pcl and /pcl_render_node/cloud Publisher: pcl_render_node \u53d1\u5e03\u8005 : pcl_render_node \u529f\u80fd \uff1a\u901a\u8fc7\u5c06\u6df1\u5ea6\u50cf\u7d20\u53cd\u5411\u6295\u5f71\u5230\u611f\u77e5\u8303\u56f4\u5185\u7684 3D \u4e16\u754c\u5750\u6807\u6765\u53d1\u5e03\u6e32\u67d3\u7684\u70b9\u4e91\u3002</p> <p>/pcl_render_node/camera_info \u53d1\u5e03\u8005 : pcl_render_node \u529f\u80fd \uff1a\u5c06\u76f8\u673a\u56fa\u6709\u53c2\u6570\uff08fx\u3001fy\u3001cx\u3001cy\uff09\u53d1\u5e03\u4e3a CameraInfo \u6d88\u606f\uff0c\u7528\u4e8e\u6df1\u5ea6\u56fe\u50cf\u5904\u7406\u3002</p> <p>/ddk/rgbd/depth/image_raw Function: In Gazebo simulation, this is the camera depth topic parameter used by the exploration manager for occupancy mapping. gazebo_sim.launch:64 \u529f\u80fd \uff1a\u5728 Gazebo \u6a21\u62df\u4e2d\uff0c\u8fd9\u662f\u63a2\u7d22\u7ba1\u7406\u5668\u7528\u4e8e\u5360\u7528\u6620\u5c04\u7684\u76f8\u673a\u6df1\u5ea6\u4e3b\u9898\u53c2\u6570\u3002gazebo_sim.launch :64</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#semantic-detection-topics","title":"Semantic Detection Topics","text":"<p>/sem_detection/sync_pc_odom and /sem_detection/point_cloud \u53d1\u5e03\u8005 \uff1a detect.py \uff08\u4f7f\u7528 YOLOv8 \u7684\u8bed\u4e49\u68c0\u6d4b\u8282\u70b9\uff09 \u8ba2\u9605\u8005 \uff1a process_cloud_node.py \u529f\u80fd \uff1a /sync_pc_odom \u5728 RGB-D \u56fe\u50cf\u4e0a\u8fdb\u884c YOLOv8 \u5b9e\u4f8b\u5206\u5272\u540e\uff0c\u53d1\u5e03\u5e26\u6709\u91cc\u7a0b\u8ba1\u7684\u540c\u6b65\u8bed\u4e49\u70b9\u4e91 /point_cloud \u5355\u72ec\u53d1\u5e03\u5e26\u8bed\u4e49\u6807\u8bb0\u7684\u70b9\u4e91\u3002</p> <p>/semantic_range_bearing_measurements \u53d1\u5e03\u8005 \uff1a process_cloud_node.py \u8ba2\u9605\u8005 \uff1a activeSlamInputNode.cpp \u529f\u80fd \uff1a\u5c06\u68c0\u6d4b\u5230\u7684\u8bed\u4e49\u5bf9\u8c61\uff08\u6905\u5b50\u3001\u684c\u5b50\u3001\u7535\u89c6\uff09\u7684\u65b9\u4f4d\u89d2\u6d4b\u91cf\u7ed3\u679c\u4ee5 ROSRangeBearing \u6d88\u606f\u7684\u5f62\u5f0f\u53d1\u5e03\u3002\u8fd9\u4e9b\u6d4b\u91cf\u7ed3\u679c\u5305\u62ec\u65b9\u4f4d\u89d2\u77e2\u91cf\u3001\u8303\u56f4\u3001\u6d4b\u91cf ID \u4ee5\u53ca\u8eab\u4f53\u6846\u67b6\u4e2d\u7684\u5730\u6807\u4f4d\u7f6e\uff0c\u5e76\u4f5c\u4e3a\u7ea6\u675f\u6dfb\u52a0\u5230 GTSAM \u56e0\u5b50\u56fe\u4e2d\u3002</p> <p>/process_cloud_node/filtered_semantic_segmentation \u53d1\u5e03\u8005 \uff1a process_cloud_node.py \u529f\u80fd \uff1a\u5904\u7406\u540e\u53d1\u5e03\u8fc7\u6ee4\u540e\u7684\u8bed\u4e49\u5206\u5272\u70b9\u4e91\u3002process_cloud_node.py : 202</p> <p>/tree_cloud, /ground_cloud, /car_cuboids, /car_cuboids_body \u53d1\u5e03\u8005 \uff1a process_cloud_node.py \u8ba2\u9605\u8005 \uff1a inputNode.cpp \uff08SLOAM \u8f93\u5165\u7ba1\u7406\u5668\uff09 \u529f\u80fd \uff1a\u8fd9\u4e9b\u4e3b\u9898\u6309\u7c7b\u522b\u5206\u79bb\u8bed\u4e49\u70b9\u4e91\uff1a</p> <p>/tree_cloud \uff1a\u6811\u5e72\u548c\u6746\u70b9 /ground_cloud \uff1a\u5730\u5e73\u9762\u70b9 /car_cuboids: Fitted cuboid markers for cars in world frame /car_cuboids_body: Car cuboids in body frame</p> <p>\u8f93\u5165\u7ba1\u7406\u5668\u4f7f\u7528\u6811\u6728\u7684\u7f51\u683c\u56fe\u5206\u5272\u548c\u5730\u9762\u7684\u5e73\u9762\u62df\u5408\u6765\u540c\u6b65\u8fd9\u4e9b\u4e3b\u9898\u4ee5\u8fdb\u884c SLOAM \u5904\u7406\u3002</p> <p>/cuboid_centers and /car_instance_segmentation_accumulated \u53d1\u5e03\u8005 \uff1a process_cloud_node.py</p> <p>/cuboid_centers: Publishes MarkerArray of cuboid center positions /car_instance_segmentation_accumulated \uff1a\u53d1\u5e03\u6c7d\u8f66\u5b9e\u4f8b\u7684\u7d2f\u79ef\u70b9\u4e91\u4ee5\u5b9e\u73b0\u53ef\u89c6\u5316</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#slamfactor-graph-topics","title":"SLAM/Factor Graph Topics","text":"<p>/optimized_trajectory \u53d1\u5e03\u8005 \uff1a activeSlamInputNode.cpp \u529f\u80fd \uff1a\u5c06\u7ecf\u8fc7 ISAM2 \u56e0\u5b50\u56fe\u4f18\u5316\u540e\u7684\u673a\u5668\u4eba\u8f68\u8ff9\u53d1\u5e03\u4e3a MarkerArray\u3002\u5305\u542b\u70b9\u6807\u8bb0\uff08\u7eff\u8272\u7403\u4f53\uff09\u548c\u7ebf\u5e26\uff08\u84dd\u8272\u7ebf\u6761\uff09\uff0c\u7528\u4e8e\u663e\u793a\u673a\u5668\u4eba\u7684\u8def\u5f84\u3002activeSlamInputNode.cpp :59-60</p> <p>/factor_graph_atl/optimized_trajectory_with_pose_inds \u53d1\u5e03\u8005 \uff1a activeSlamInputNode.cpp \u8ba2\u9605\u8005 \uff1a loop_closure_submap_node.py \u529f\u80fd \uff1a\u53d1\u5e03\u4f18\u5316\u540e\u7684\u8f68\u8ff9\uff0c\u6bcf\u4e2a\u6807\u8bb0\u70b9\u7684 ID \u4e0e\u56e0\u5b50\u56fe\u4e2d\u7684\u5173\u952e\u59ff\u52bf\u7d22\u5f15\u76f8\u5bf9\u5e94\u3002\u7528\u4e8e\u751f\u6210\u56de\u73af\u5b50\u56fe\u3002activeSlamInputNode.cpp :61-62 loop_closure_submap_node.py:68-69</p> <p>/factor_graph_atl/optimized_point_landmarks \u53d1\u5e03\u8005 \uff1a activeSlamInputNode.cpp \u8ba2\u9605\u8005 \uff1a loop_closure_submap_node.py \u529f\u80fd \uff1a\u5c06\u6240\u6709\u4f18\u5316\u7684\u8bed\u4e49\u5730\u6807\u4f4d\u7f6e\uff08\u6811\u6728\u3001\u6c7d\u8f66\u7b49\uff09\u4ece\u56e0\u5b50\u56fe\u53d1\u5e03\u4e3a MarkerArray\u3002</p> <p>/factor_graph_atl/loop_closure_submap \u53d1\u5e03\u8005 \uff1a loop_closure_submap_node.py \u529f\u80fd \uff1a\u53d1\u5e03\u73af\u8def\u95ed\u5408\u5b50\u56fe\u53ef\u89c6\u5316\uff0c\u663e\u793a\u68c0\u6d4b\u5230\u7684\u73af\u8def\u95ed\u5408\uff0c\u5e76\u6839\u636e\u91cd\u65b0\u8bbf\u95ee\u7684\u5386\u53f2\u8f68\u8ff9\u6bb5\u4f7f\u7528\u989c\u8272\u6807\u8bb0\u3002</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#map-topics","title":"Map Topics","text":"<p>/map_ros/depth, /map_ros/cloud, /map_ros/pose /map_ros/depth \u3001 /map_ros/cloud \u3001 /map_ros/pose Subscribers: MapROS class in map_ros.cpp \u8ba2\u9605\u8005 \uff1a map_ros.cpp \u4e2d\u7684 MapROS \u7c7b Function: These are the input topics for the mapping pipeline. They are remapped from sensor-specific topics (like /pcl_render_node/depth) and synchronized using message_filters for occupancy map updates. map_ros.cpp:241-245 algorithm.xml:37-39 \u529f\u80fd \uff1a\u8fd9\u4e9b\u662f\u6620\u5c04\u7ba1\u9053\u7684\u8f93\u5165\u4e3b\u9898\u3002\u5b83\u4eec\u4ece\u7279\u5b9a\u4e8e\u4f20\u611f\u5668\u7684\u4e3b\u9898\uff08\u4f8b\u5982 /pcl_render_node/depth \uff09\u91cd\u65b0\u6620\u5c04\uff0c\u5e76\u4f7f\u7528 message_filters \u8fdb\u884c\u540c\u6b65\uff0c\u4ee5\u66f4\u65b0\u5360\u7528\u56fe\u3002map_ros.cpp :241-245 algorithm.xml:37-39</p> <p>/sdf_map/occupancy_global and /sdf_map/occupancy_inflate_local /sdf_map/occupancy_global \u548c /sdf_map/occupancy_inflate_local Publisher: MapROS class \u53d1\u5e03\u8005 \uff1a MapROS \u7c7b Function: Publishes occupancy grid maps as PointCloud2 messages. The global map covers the entire explored space, while the inflated local map includes obstacle inflation for collision checking during path planning. map_ros.cpp:227-234 \u529f\u80fd \uff1a\u5c06\u5360\u7528\u7f51\u683c\u5730\u56fe\u53d1\u5e03\u4e3a PointCloud2 \u6d88\u606f\u3002\u5168\u5c40\u5730\u56fe\u8986\u76d6\u6574\u4e2a\u63a2\u7d22\u7a7a\u95f4\uff0c\u800c\u81a8\u80c0\u7684\u5c40\u90e8\u5730\u56fe\u5219\u5305\u542b\u969c\u788d\u7269\u81a8\u80c0\uff0c\u4ee5\u4fbf\u5728\u8def\u5f84\u89c4\u5212\u8fc7\u7a0b\u4e2d\u8fdb\u884c\u78b0\u649e\u68c0\u67e5\u3002map_ros.cpp :227-234</p> <p>/sdf_map/esdf Publisher: MapROS class \u53d1\u5e03\u8005 \uff1a MapROS \u7c7b Function: Publishes the Euclidean Signed Distance Field computed via distance transform from the occupancy buffer. Used by the trajectory optimizer for smooth collision-free planning. map_ros.cpp:237 \u529f\u80fd \uff1a\u53d1\u5e03\u901a\u8fc7\u8ddd\u79bb\u53d8\u6362\u4ece\u5360\u7528\u7f13\u51b2\u533a\u8ba1\u7b97\u51fa\u7684\u6b27\u6c0f\u6709\u5411\u8ddd\u79bb\u573a\u3002\u8f68\u8ff9\u4f18\u5316\u5668\u4f7f\u7528\u5b83\u6765\u5b9e\u73b0\u5e73\u6ed1\u7684\u65e0\u78b0\u649e\u89c4\u5212\u3002map_ros.cpp :237</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#navigationplanning-topics","title":"Navigation/Planning Topics","text":"<p>/move_base_simple/goal \u8ba2\u9605\u8005 \uff1a waypoint_generator \u8282\u70b9 \u529f\u80fd \uff1a\u6807\u51c6 RViz \u4e8c\u7ef4\u5bfc\u822a\u76ee\u6807\u4e3b\u9898\u3002\u5f53\u7528\u6237\u5728 RViz \u4e2d\u70b9\u51fb\u8bbe\u7f6e\u76ee\u6807\u65f6\uff0cwaypoint_generator \u4f1a\u63a5\u6536\u8be5\u76ee\u6807\uff0c\u5e76\u6839\u636e\u914d\u7f6e\u7684\u822a\u70b9\u7c7b\u578b\uff08\u70b9\u3001\u5706\u3001\u516b\u3001\u7cfb\u5217\uff09\u8fdb\u884c\u5904\u7406\u3002w</p> <p>/ddk/waypoint_generator/waypoints \u53d1\u5e03\u8005 \uff1a waypoint_generator \u8282\u70b9 \u529f\u80fd \uff1a\u5c06\u7528\u6237\u76ee\u6807\u4e2d\u5df2\u5904\u7406\u7684\u822a\u70b9\u5e8f\u5217\u53d1\u5e03\u4e3a nav_msgs::Path \u6d88\u606f\u3002waypoint_generator.cpp :86-95</p> <p>/ddk/trackers_manager/line_tracker_min_jerk/LineTracker \u529f\u80fd \uff1a\u7ebf\u8def\u8ddf\u8e2a\u5668\u7684\u52a8\u4f5c\u670d\u52a1\u5668\u7aef\u70b9\u3002\u89c4\u5212\u7ba1\u7406\u5668\u5411\u6b64\u52a8\u4f5c\u670d\u52a1\u5668\u53d1\u9001 LineTrackerGoal \u6d88\u606f\uff0c\u4ee5\u6267\u884c\u6700\u5c0f\u52a0\u52a0\u901f\u5ea6\u8f68\u8ff9\u6765\u8ddf\u8e2a\u822a\u70b9\u3002</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#_5","title":"\u7cfb\u7edf\u6a21\u5757\u8be6\u89e3","text":""},{"location":"projects/active%20slam/kr%203d%20active%20slam/#metric-semantic-slam","title":"Metric-Semantic SLAM \u6a21\u5757","text":""},{"location":"projects/active%20slam/kr%203d%20active%20slam/#_6","title":"\u8bed\u4e49\u68c0\u6d4b\u6a21\u5757","text":"<p>\u8bed\u4e49\u68c0\u6d4b\u6a21\u5757\u4f7f\u7528 YOLOv8 \u5bf9 RGB-D \u56fe\u50cf\u8fdb\u884c\u5b9e\u4f8b\u5206\u5272</p> <ol> <li>\u7cfb\u7edf\u8ba2\u9605\u540c\u6b65 RGB \u56fe\u50cf\u3001\u5bf9\u9f50\u6df1\u5ea6\u56fe\u50cf\u548c\u91cc\u7a0b\u8ba1\u6d88\u606f</li> <li>YOLOv8 \u5bf9 RGB \u56fe\u50cf\u8fdb\u884c\u5b9e\u4f8b\u5206\u5272\uff0c\u68c0\u6d4b\u6905\u5b50\u3001\u9910\u684c\u3001\u7535\u89c6\u7b49\u7269\u4f53</li> <li>\u4f7f\u7528\u5bf9\u9f50\u7684\u6df1\u5ea6\u56fe\u548c\u76f8\u673a\u5185\u90e8\u51fd\u6570\u5c06\u6bcf\u4e2a\u68c0\u6d4b\u5230\u7684\u5b9e\u4f8b\u6295\u5f71\u5230 3D \u4e2d\uff0c\u4ece\u800c\u521b\u5efa\u5177\u6709\u7c7b\u6807\u7b7e\u3001\u5b9e\u4f8b ID \u548c\u7f6e\u4fe1\u5ea6\u5206\u6570\u7684\u8bed\u4e49\u70b9\u4e91</li> <li>\u8f93\u51fa\u4ee5 syncPcOdom \u6d88\u606f\u7684\u5f62\u5f0f\u53d1\u5e03\uff0c\u5176\u4e2d\u5305\u542b\u4e0e\u91cc\u7a0b\u8ba1\u68c0\u6d4b\u540c\u6b65\u7684\u8bed\u4e49\u70b9\u4e91</li> </ol>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#_7","title":"\u8bed\u4e49\u5904\u7406\u6a21\u5757","text":"<p>\u5904\u7406\u6a21\u5757\u63a5\u6536\u8bed\u4e49\u70b9\u4e91\u5e76\u63d0\u53d6\u957f\u65b9\u4f53\u5730\u6807</p> <ol> <li>\u70b9\u4e91\u8fc7\u6ee4 \uff1a\u8be5\u6a21\u5757\u901a\u8fc7\u8303\u56f4\u3001\u7f6e\u4fe1\u5ea6\u9608\u503c\u548c\u6df1\u5ea6\u767e\u5206\u4f4d\u6570\u8fc7\u6ee4\u8bed\u4e49\u70b9</li> <li>\u521d\u59cb\u957f\u65b9\u4f53\u62df\u5408 \uff1a\u5bf9\u4e8e\u6bcf\u4e2a\u5b9e\u4f8b\uff0c\u7cfb\u7edf\u6267\u884c\u521d\u59cb\u8fb9\u754c\u6846\u62df\u5408</li> <li>\u5bf9\u8c61\u8ddf\u8e2a \uff1a\u4f7f\u7528\u5308\u7259\u5229\u5206\u914d\u6cd5\u8de8\u5e27\u8ddf\u8e2a\u5bf9\u8c61\uff0c\u4ee5\u4fdd\u6301\u4e00\u81f4\u7684 ID</li> <li>\u70b9\u4e91\u7d2f\u79ef \uff1a\u6bcf\u4e2a\u8ddf\u8e2a\u5b9e\u4f8b\u7684\u70b9\u4e91\u88ab\u7d2f\u79ef\u5e76\u4e0b\u91c7\u6837</li> <li>\u6700\u7ec8\u957f\u65b9\u4f53\u68c0\u6d4b \uff1aPCA \u7528\u4e8e\u5c06\u5b9a\u5411 3D \u8fb9\u754c\u6846\uff08\u957f\u65b9\u4f53\uff09\u62df\u5408\u5230\u7d2f\u79ef\u70b9\u4e91</li> <li>\u6d4b\u8ddd\u6d4b\u91cf\u751f\u6210 \uff1a\u957f\u65b9\u4f53\u5728\u673a\u5668\u4eba\u8eab\u4f53\u6846\u67b6\u4e2d\u8f6c\u6362\u4e3a\u6d4b\u8ddd\u6d4b\u91cf \u200b</li> <li>\u8f93\u51fa\u5305\u62ec\u65b9\u4f4d\u77e2\u91cf\uff08\u5355\u4f4d\u65b9\u5411\uff09\u3001\u8303\u56f4\uff08\u8ddd\u79bb\uff09\u3001\u8eab\u4f53\u6846\u67b6\u4e2d\u7684\u5730\u6807\u4f4d\u7f6e\u4ee5\u53ca\u4f5c\u4e3a ROSRangeBearing \u6d88\u606f\u53d1\u5e03\u7684\u6d4b\u91cf ID</li> </ol>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#slam","title":"SLAM \u4f18\u5316\u6a21\u5757","text":"<p>SLAM \u6a21\u5757\u5c06\u8bed\u4e49\u89c2\u5bdf\u6574\u5408\u5230\u56e0\u5b50\u56fe\u4e2d\u4ee5\u8fdb\u884c\u59ff\u52bf\u4f18\u5316\uff1a\u5bf9\u4e8e\u901a\u7528 SLOAM\uff08\u5305\u542b\u5706\u67f1\u4f53\u548c\u957f\u65b9\u4f53\uff09\uff1arunSLOAMNode \u51fd\u6570\u8d1f\u8d23\u534f\u8c03 SLAM \u8fc7\u7a0b</p> <ol> <li>\u4f7f\u7528\u7f51\u683c\u56fe\u68c0\u6d4b\u5bf9\u5706\u67f1\u4f53\uff08\u6811\uff09\u8fdb\u884c\u6a21\u578b\u4f30\u8ba1</li> <li>\u5f53\u524d\u89c2\u6d4b\u7ed3\u679c\u4e0e\u5730\u56fe\u5730\u6807\u4e4b\u95f4\u7684\u6570\u636e\u5173\u8054</li> <li>\u5f53\u524d\u626b\u63cf\u548c\u5b50\u56fe\u4e4b\u95f4\u7684\u957f\u65b9\u4f53\u6a21\u578b\u5339\u914d</li> <li>\u957f\u65b9\u4f53\u5339\u914d\u4f7f\u7528\u57fa\u4e8e\u8ddd\u79bb\u7684\u5173\u8054</li> <li>addSLOAMObservation \u51fd\u6570\u5c06\u5706\u67f1\u4f53\u548c\u7acb\u65b9\u4f53\u56e0\u5b50\u6dfb\u52a0\u5230 GTSAM \u56e0\u5b50\u56fe\u4e2d</li> </ol>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#alc-range-bearing-mode","title":"ALC (Range-Bearing Mode):","text":"<ol> <li>\u4e3b\u52a8 SLAM \u8f93\u5165\u8282\u70b9\u63a5\u6536\u6d4b\u8ddd\u6d4b\u91cf</li> <li>\u8fd9\u4e9b\u6d4b\u91cf\u503c\u5728\u56e0\u5b50\u56fe\u66f4\u65b0\u4e2d\u8fdb\u884c\u5904\u7406</li> <li>addOdomBearingObservation \u51fd\u6570\u4f7f\u7528\u6700\u8fd1\u90bb\u641c\u7d22\u6267\u884c\u6570\u636e\u5173\u8054\uff0c\u5e76\u5c06\u65b9\u4f4d\u548c\u8303\u56f4\u56e0\u5b50\u6dfb\u52a0\u5230\u56fe\u4e2d</li> </ol>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#active-loop-closure-metric-semantic-slam","title":"Active Loop Closure \u4e0e Metric-Semantic SLAM \u7ed3\u5408","text":"<p>\u8fd9\u4e24\u4e2a\u8fdb\u7a0b\u901a\u8fc7 ROS \u64cd\u4f5c\u548c\u670d\u52a1\u8fdb\u884c\u901a\u4fe1\uff1a</p> <p>Active Loop Closure Action Server/Client: The Semantic SLAM system (ActiveSlamInputNode) runs an action server, while the exploration planner runs an action client to request loop closures.</p> <p>\u4fe1\u606f\u589e\u76ca\u4f30\u8ba1\u670d\u52a1 \uff1a\u8bed\u4e49 SLAM \u7cfb\u7edf\u63d0\u4f9b\u4e00\u9879\u670d\u52a1\uff0c\u63a2\u7d22\u89c4\u5212\u5668\u5728\u6267\u884c\u5047\u8bbe\u7684\u5faa\u73af\u95ed\u5305\u4e4b\u524d\u4f1a\u8fdb\u884c\u67e5\u8be2\u4ee5\u5bf9\u5176\u8fdb\u884c\u8bc4\u4f30\u3002</p> <p>\u8bed\u4e49 SLAM \u8fc7\u7a0b\u7ef4\u62a4\u4e00\u4e2a\u5305\u542b\u8bed\u4e49\u5730\u6807\uff08\u6811\u6728\u7684\u5706\u67f1\u4f53\u3001\u6c7d\u8f66/\u7bb1\u5b50\u7684\u7acb\u65b9\u4f53\uff09\u548c\u673a\u5668\u4eba\u59ff\u52bf\u7684\u56e0\u5b50\u56fe \uff0c\u4f7f\u7528 GTSAM \u7684 ISAM2 \u6267\u884c\u589e\u91cf\u4f18\u5316</p> <p>\u7cfb\u7edf\u5904\u7406 VIO \u91cc\u7a0b\u8ba1\u548c\u8bed\u4e49\u6d4b\u91cf\uff0c\u5e76\u4ee5\u53ef\u914d\u7f6e\u7684\u901f\u7387\uff08\u9ed8\u8ba4 5 Hz\uff09\u5c06\u5b83\u4eec\u6dfb\u52a0\u5230\u56e0\u5b50\u56fe\u4e2d</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#slam_1","title":"\u4e3b\u52a8 SLAM \u51b3\u7b56","text":"<p>\u63a2\u7d22\u89c4\u5212\u5668 ( msExplorationManager ) \u4f7f\u7528\u4e3b\u52a8\u611f\u77e5\u6765\u51b3\u5b9a\u662f\u63a2\u7d22\u65b0\u8fb9\u754c\u8fd8\u662f\u91cd\u65b0\u8bbf\u95ee\u5df2\u77e5\u4f4d\u7f6e\u4ee5\u8fdb\u884c\u56de\u73af\u95ed\u5408\u3002\u5b83\u4f1a\u67e5\u8be2\u4fe1\u606f\u589e\u76ca\u670d\u52a1\u6765\u8bc4\u4f30\u5019\u9009\u56de\u73af\u95ed\u5408</p> <p>\u89c4\u5212\u5668\u6bd4\u8f83\u4e86\u8bbf\u95ee\u8fb9\u754c\u4e0e\u6267\u884c\u56de\u73af\u7684\u6548\u7528\uff0c\u5f53\u56de\u73af\u76ee\u6807\u76f8\u5bf9\u4e8e\u5176\u6210\u672c\u63d0\u4f9b\u66f4\u597d\u7684\u4fe1\u606f\u589e\u76ca\u65f6\uff0c\u63d2\u5165\u56de\u73af\u76ee\u6807</p>"},{"location":"projects/active%20slam/kr%203d%20active%20slam/#loop-closure-request-flow","title":"Loop Closure Request Flow","text":"<p>\u5f53\u63a2\u7d22\u89c4\u5212\u5668\u51b3\u5b9a\u6267\u884c\u5faa\u73af\u95ed\u5408\u65f6\uff0c\u5b83\u4f1a\uff1a</p> <p>\u5c06\u76ee\u6807\u4e0e\u76ee\u6807\u5173\u952e\u59ff\u52bf\u7d22\u5f15\u548c\u5b50\u56fe\uff08\u5730\u6807\u4f4d\u7f6e\uff09\u4e00\u8d77\u53d1\u9001\u5230\u4e3b\u52a8\u5faa\u73af\u95ed\u5408\u52a8\u4f5c\u670d\u52a1\u5668</p> <p>Semantic SLAM \u63a5\u6536\u8fd9\u4e2a\u76ee\u6807\u5e76\u63a5\u53d7\uff0c\u5b58\u50a8\u5173\u95ed\u8bf7\u6c42\u53c2\u6570</p> <p>\u5f53\u673a\u5668\u4eba\u8db3\u591f\u63a5\u8fd1\u76ee\u6807\u59ff\u52bf\u65f6\uff0c\u8bed\u4e49 SLAM \u7cfb\u7edf\u4f1a\u89e6\u53d1\u81ea\u5df1\u7684\u56de\u73af\u68c0\u6d4b\u5ba2\u6237\u7aef</p> <p>\u5f53\u68c0\u6d4b\u5230\u56de\u73af\u65f6\uff0c\u8bed\u4e49 SLAM \u8fc7\u7a0b\u901a\u8fc7\u8c03\u7528 addLoopClosureObservation \u800c\u4e0d\u662f\u5e38\u89c4\u7684 addOdomBearingObservation \u6765\u66f4\u65b0\u56e0\u5b50\u56fe</p> <p>\u7cfb\u7edf\u5728\u5904\u7406\u73af\u8def\u95ed\u5408\u65f6\u6682\u65f6\u7981\u7528\u6dfb\u52a0\u5176\u4ed6\u56e0\u7d20</p>"},{"location":"projects/nebula-vsearch/summary/","title":"\u9879\u76ee\u62a5\u544a","text":""},{"location":"projects/nebula-vsearch/summary/#_1","title":"\u9879\u76ee\u62a5\u544a\u9879\u76ee\u540d\u79f0\uff1a\u4e3a NebulaGraph \u652f\u6301\u5411\u91cf\u8fd1\u4f3c\u90bb\u68c0\u7d22","text":"<p> \u7ea6 3401 \u4e2a\u5b57  75 \u884c\u4ee3\u7801  17 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 18 \u5206\u949f</p> 2025-12-022025-12-10 \u9879\u76ee\u5bfc\u5e08\uff1a\u66f9\u5fd7\u9e4f \u7533\u8bf7\u4eba\uff1a\u5218\u82b7\u6ea2 \u65e5\u671f\uff1a2025.09.25 \u90ae\u7bb1\uff1alzy_CS_LN@163.com"},{"location":"projects/nebula-vsearch/summary/#_2","title":"\u9879\u76ee\u4fe1\u606f","text":""},{"location":"projects/nebula-vsearch/summary/#_3","title":"\u9879\u76ee\u540d\u79f0","text":"<p>\u4e3a NebulaGraph \u652f\u6301\u5411\u91cf\u8fd1\u4f3c\u90bb\u68c0\u7d22</p>"},{"location":"projects/nebula-vsearch/summary/#_4","title":"\u65b9\u6848\u63cf\u8ff0","text":"<p>\u5728 NebulaGraph \u5206\u5e03\u5f0f\u56fe\u6570\u636e\u5e93\u4e2d\u539f\u751f\u96c6\u6210\u5411\u91cf\u6570\u636e\u5b58\u50a8\u4e0e\u8fd1\u4f3c\u6700\u8fd1\u90bb\uff08Approximate Nearest Neighbor, ANN\uff09\u68c0\u7d22\u80fd\u529b\u3002\u786e\u4fdd\u8bbe\u8ba1\u7684\u8bed\u6cd5\u517c\u5bb9 NebulaGraph \u73b0\u6709\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u67e5\u8be2\u8bed\u53e5\u517c\u5bb9 OpenCypher \u8bed\u6cd5\u89c4\u8303\u3002</p> <ol> <li>\u5b9e\u73b0\u5411\u91cf\u6570\u636e\u7c7b\u578b\u5e76\u652f\u6301\u5176\u6301\u4e45\u5316\u3002    - \u5b9e\u73b0\u65b0\u7684\u6570\u636e\u7c7b\u578b VECTOR    - \u5b9e\u73b0\u5411\u91cf\u7c7b\u578b\u7684\u5b58\u50a8\uff0c\u4e3a RocksDB \u589e\u52a0\u591a column family \u652f\u6301    - \u5b9e\u73b0\u5411\u91cf\u7684 Key \u7ed3\u6784\u548c\u5b58\u50a8\u683c\u5f0f(\u52a0\u5de5\u540e\u7684\u5b57\u7b26\u4e32)</li> <li>\u5b9e\u73b0\u5411\u91cf\u76f8\u5173\u7684 DDL \u8bed\u53e5\uff0c\u5305\u62ec create tag\u3001create index \u7b49\u8bed\u53e5\u3002    - \u8bed\u6cd5\u517c\u5bb9 NebulaGraph \u73b0\u6709\u7684\u67e5\u8be2\u8bed\u8a00    - \u5728\u539f\u6709 Schema Provider \u57fa\u7840\u4e0a\u589e\u52a0\u5bf9\u5411\u91cf\u5217\u7684\u652f\u6301    - \u5b9e\u73b0\u7684 create ann index \u8ba1\u5212\u6267\u884c\u7c7b\u4f3c rebuild index</li> <li>\u5b9e\u73b0\u5411\u91cf\u76f8\u5173\u7684 DML \u8bed\u53e5\uff0c\u5305\u62ec insert\u3001update\u3001delete \u7b49\u8bed\u53e5\u3002    - \u8bed\u6cd5\u517c\u5bb9 NebulaGraph \u73b0\u6709\u7684\u67e5\u8be2\u8bed\u8a00    - \u5b9e\u73b0\u5411\u91cf\u5c5e\u6027\u7684\u63d2\u5165\u3001\u66f4\u65b0\u3001\u5220\u9664\u7b49\u529f\u80fd\uff0c\u4e0d\u5f71\u54cd\u5206\u5e03\u5f0f\u4e00\u81f4\u6027\u548c\u53ef\u7528\u6027</li> <li>\u8bbe\u8ba1\u5e76\u5b9e\u73b0 ANN Search \u8bed\u53e5\u3002    - \u8bed\u6cd5\u517c\u5bb9 NebulaGraph \u73b0\u6709\u7684 match \u8bed\u53e5    - \u96c6\u6210 Faiss \u548c HNSWLib \u5b9e\u73b0 ANN Search \u529f\u80fd    - \u5b9e\u73b0 ANN Search \u8bed\u53e5\u7684\u5355\u673a\u529f\u80fd\uff0c\u7c7b\u4f3c Index Scan</li> <li>\u6ee1\u8db3\u5206\u5e03\u5f0f\u4e00\u81f4\u6027\u548c\u53ef\u7528\u6027\u8981\u6c42\uff0c\u4fdd\u8bc1\u5411\u91cf\u6570\u636e\u526f\u672c\u4e00\u81f4\u6027\u53ca\u5185\u5b58\u78c1\u76d8\u6570\u636e\u4e00\u81f4\u6027\u3002    - \u8bbe\u8ba1\u5411\u91cf\u7d22\u5f15\u7684 WAL \u673a\u5236\uff0c\u4fdd\u8bc1\u5185\u5b58\u548c\u78c1\u76d8\u6570\u636e\u4e00\u81f4\u6027    - \u8bbe\u8ba1\u5411\u91cf\u6570\u636e\u7684 Raft \u65e5\u5fd7\u673a\u5236\uff0c\u4fdd\u8bc1\u5411\u91cf\u6570\u636e\u526f\u672c\u4e00\u81f4\u6027</li> <li>\u5bf9 ANN Search \u6027\u80fd\u8fdb\u884c\u4f18\u5316\u4ee5\u6ee1\u8db3\u4e1a\u52a1\u9700\u6c42\u3002    - \u4f7f\u7528 profiler \u5de5\u5177\u5bf9 ANN Search \u8fdb\u884c\u6027\u80fd\u5206\u6790    - \u7ed3\u5408\u5206\u6790\u7ed3\u679c\u5bf9 ANN Search \u8fdb\u884c\u6027\u80fd\u4f18\u5316</li> </ol>"},{"location":"projects/nebula-vsearch/summary/#_5","title":"\u529f\u80fd\u5f00\u53d1\u65f6\u95f4\u8868 \ud83d\ude80","text":"\u65f6\u95f4 \u4efb\u52a1\u5185\u5bb9 \u72b6\u6001 6.20 - 7.5 \u5b9e\u73b0\u5411\u91cf\u6570\u636e\u7c7b\u578b\u548c\u5c5e\u6027\u7c7b\u578b \ud83d\udfe2 \u5b8c\u6210 7.6 - 7.16 \u5b9e\u73b0\u5411\u91cf\u7c7b\u578b\u7684\u5b58\u50a8\uff0c\u4e3a RocksDB \u589e\u52a0\u591a column family \u652f\u6301 \ud83d\udfe2 \u5b8c\u6210 7.16 - 7.28 \u5b9e\u73b0\u5411\u91cf\u5c5e\u6027\u76f8\u5173\u7684 DDL \u8bed\u53e5 \ud83d\udfe2 \u5b8c\u6210 7.28 - 8.4 \u5b9e\u73b0\u5411\u91cf\u5c5e\u6027\u76f8\u5173\u7684 DML \u8bed\u53e5 \ud83d\udfe2 \u5b8c\u6210 8.4 - 8.14 \u5c06 Faiss \u548c HNSWLib \u96c6\u6210\u5230 Nebula \u4e2d\uff0c\u5b9e\u73b0\u5411\u91cf\u68c0\u7d22\u529f\u80fd\u5e76\u8fdb\u884c ANN Benchmark \u6d4b\u8bd5 \ud83d\udfe2 \u5b8c\u6210 8.14 - 8.30 \u8bbe\u8ba1\u5e76\u5b9e\u73b0\u5411\u91cf\u7d22\u5f15(ANN Index)\u7684\u521b\u5efa\u548c\u5220\u9664\u8bed\u53e5 \ud83d\udfe2 \u5b8c\u6210 8.30 - 9.25 \u5b9e\u73b0 ANN Search \u8bed\u53e5(\u5355\u673a\u529f\u80fd\u5b9e\u73b0) \ud83d\udfe2 \u5b8c\u6210 9.26 - 10.26 \u5b9e\u73b0\u5206\u5e03\u5f0f\u4e00\u81f4\u6027\u548c\u53ef\u7528\u6027\u8981\u6c42\uff0c\u4fdd\u8bc1\u5411\u91cf\u6570\u636e\u526f\u672c\u4e00\u81f4\u6027\u53ca\u5185\u5b58\u78c1\u76d8\u6570\u636e\u4e00\u81f4\u6027 \ud83d\udfe1 \u8fdb\u884c\u4e2d \u672a\u6765 \u5bf9 ANN Search \u6027\u80fd\u8fdb\u884c\u4f18\u5316\u4ee5\u6ee1\u8db3\u4e1a\u52a1\u9700\u6c42 \u23f3 \u8ba1\u5212\u4e2d"},{"location":"projects/nebula-vsearch/summary/#_6","title":"\u9879\u76ee\u8fdb\u5ea6","text":""},{"location":"projects/nebula-vsearch/summary/#finished","title":"\u5177\u4f53\u65b9\u6848(Finished)","text":""},{"location":"projects/nebula-vsearch/summary/#_7","title":"\u5411\u91cf\u6570\u636e\u7c7b\u578b","text":"<ul> <li>\u5411\u91cf\u6570\u636e\u7c7b\u578b\u4e0e List \u7c7b\u578b\u4e0d\u540c\uff0c\u9664\u4e86\u6bd4\u8f83\u8fd0\u7b97\u7b26\u5916\uff0c\u5b83\u4e0d\u5e94\u8be5\u652f\u6301\u5176\u4ed6\u7684\u8fd0\u7b97\u7b26\uff0c\u5982\u52a0\u51cf\u4e58\u9664\u7b49\u3002</li> <li>\u5b9e\u9645\u5411\u91cf\u7c7b\u578b\u662f\u4e00\u4e2a<code>std::vector&lt;float&gt;</code>\uff0c\u5728\u5b58\u50a8\u65f6\u4f1a\u5c06\u5176\u5e8f\u5217\u5316\u4e3a\u4e8c\u8fdb\u5236\u5b57\u7b26\u4e32\u5b58\u50a8\u5728 RocksDB \u4e2d\u3002 </li> </ul>"},{"location":"projects/nebula-vsearch/summary/#rocksdb-multi-column-family","title":"\u5411\u91cf\u5b58\u50a8\u652f\u6301(RocksDB Multi Column Family)","text":"<ul> <li>\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u5411\u91cf\u5b58\u50a8\u4e0e\u5176\u4ed6\u56fe\u5c5e\u6027\u5206\u79bb\u7684\u65b9\u5f0f\uff0c\u65b9\u4fbf\u540e\u7eed\u8fdb\u884c ANN \u7d22\u5f15\u6784\u5efa\u3002</li> <li>\u4e3a\u4e86\u5b9e\u73b0\u4e0e\u5176\u4ed6\u6570\u636e\u7684\u9694\u79bb\uff0c\u6211\u4eec\u9700\u8981\u5c06\u5411\u91cf\u6570\u636e\u5b58\u50a8\u5728\u5411\u91cf\u5217\u65cf\u4e2d\uff0c\u5176\u4ed6\u6570\u636e\u5b58\u50a8\u5728\u9ed8\u8ba4\u5217\u65cf\u4e2d\u3002 <p>\u8fd9\u91cc\u7684 ID-VID \u5217\u65cf\u662f\u4e3a\u4e86\u540e\u7eed\u5b9e\u73b0 ANN \u7d22\u5f15\u521b\u5efa\u4f7f\u7528\u7684</p> </li> </ul> <p></p>"},{"location":"projects/nebula-vsearch/summary/#key","title":"\u5411\u91cf\u7c7b\u578b\u7684 Key \u7ed3\u6784","text":"<ul> <li> <p>\u7ecf\u8fc7\u6211\u4eec\u5bf9 RocksDB \u7684\u591a column family \u7684\u6539\u9020\uff0c\u73b0\u5728\u9700\u8981\u5c06\u5411\u91cf\u5c5e\u6027\u5b58\u5165\u5411\u91cf\u5217\u65cf\u4e2d\u3002\u8fd9\u9700\u8981\u6211\u4eec\u91cd\u65b0\u8bbe\u8ba1\u5411\u91cf\u5c5e\u6027\u7684 Key \u7ed3\u6784\u3002</p> </li> <li> <p>\u7ecf\u8fc7\u8bbe\u8ba1\uff0c\u5411\u91cf\u5c5e\u6027\u7684 Key \u7ed3\u6784\u5982\u4e0b\uff1a</p> </li> </ul> Bash<pre><code>VectorTagKeyUtils:\ntype(1) + partId(3) + vertexId(*) + tagId(4) + propId(4)\n\nVectroEdgeKeyUtils:\ntype(1) + partId(3) + srcId(*) + edgeType(4) + edgeRank(8) + dstId(*) + propId(4) +placeHolder(1)\n</code></pre>"},{"location":"projects/nebula-vsearch/summary/#ddl-create-tagedge","title":"\u5411\u91cf\u5c5e\u6027\u7684 DDL \u8bed\u53e5(Create Tag/Edge)","text":"<p>\u4e3a\u4e86\u540c\u65f6\u652f\u6301\u539f\u59cb\u5217\u548c\u5411\u91cf\u5217\uff0c\u6211\u4eec\u9700\u8981\u5bf9 Schema Provider \u8fdb\u884c\u5982\u4e0b\u8c03\u6574\uff1a</p> <ul> <li>\u539f\u59cb\u5217\uff1a\u7528\u4e8e\u9664 VECTOR \u7c7b\u578b\u4e4b\u5916\u7684\u5176\u4ed6\u6570\u636e\u7c7b\u578b</li> <li>\u5411\u91cf\u5217\uff1a\u4e13\u95e8\u7528\u4e8e VECTOR \u7c7b\u578b</li> <li>Schema \u5c5e\u6027\u9009\u9879\uff1a\u5982 TTL\u3001TTL_COL \u7b49</li> </ul> <p></p> <p>\u6b64\u5916\uff0c\u8fd8\u9700\u4fee\u6539 RowWriter \u548c RowReader \u4ee5\u652f\u6301\u5411\u91cf\u5217\u64cd\u4f5c\uff1a</p> <ul> <li>RowWriter \u5c06\u5411\u91cf\u6570\u636e\u5199\u5165 RocksDB \u7684 vector \u5217\u65cf</li> <li>RowReader \u4ece RocksDB \u7684 vector \u5217\u65cf\u8bfb\u53d6\u5411\u91cf\u6570\u636e</li> </ul> <p></p>"},{"location":"projects/nebula-vsearch/summary/#dml-insertupdatedeleteupsert","title":"\u5411\u91cf\u5c5e\u6027\u7684 DML \u8bed\u53e5(Insert/Update/Delete/Upsert)","text":"<p>\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u5148\u68b3\u7406\u4e00\u4e0b\u6570\u636e\u4ece\u5ba2\u6237\u7aef\u5230\u5b58\u50a8\u5f15\u64ce\u7684\u6d41\u7a0b\uff1a</p> <ul> <li>Client \u7aef\u5c06\u6570\u636e\u6253\u5305\u6210 Request \u53d1\u9001\u5230 Graphd \u8282\u70b9\u3002</li> <li>Graghd \u8282\u70b9\u8fdb\u884c validate\uff0cplanner\uff0coptimizer \u4e4b\u540e\u751f\u6210\u5b9e\u9645\u6267\u884c\u7684\u7269\u7406\u8ba1\u5212\uff0c\u5411 Storage \u8282\u70b9\u53d1\u9001\u771f\u6b63\u7684\u6570\u636e\u5199\u5165\u8bf7\u6c42</li> <li>Storage \u8282\u70b9\u63a5\u6536\u5230 Request \u540e\uff0c\u4f1a\u751f\u6210 Storage \u8282\u70b9\u7684\u8ba1\u5212\uff0c\u6700\u540e\u8c03\u7528\u5b58\u50a8\u5f15\u64ce\u63a5\u53e3\u5c06\u6570\u636e\u5199\u5165 RocksDB</li> <li>\u8fd4\u56de\u7ed3\u679c\u7ed9 Client \u7aef</li> </ul> <p></p> <p>\u8fd9\u91cc\u9762\u6709\u4e00\u4e9b\u7ec6\u8282\u9700\u8981\u6ce8\u610f:</p> <ul> <li>Storage Cache: storaged \u4f1a\u5b9a\u671f\u4f7f\u7528\u5fc3\u8df3\u62c9\u53d6 metad \u6700\u65b0\u7684 Schema \u4fe1\u606f\uff0c\u66f4\u65b0\u672c\u5730\u7684 Schema \u7f13\u5b58\uff0c\u4ece\u800c\u83b7\u53d6\u6700\u65b0\u7684 Schema \u4fe1\u606f\u3002\u6211\u4eec\u9700\u8981\u786e\u4fdd\u5411\u91cf\u5217\u7684\u4fe1\u606f\u4e5f\u80fd\u6b63\u786e\u5730\u88ab\u7f13\u5b58\u548c\u66f4\u65b0(\u540e\u7eed\u8fd8\u6709\u5411\u91cf\u7d22\u5f15\u7684\u66f4\u65b0)\u3002 </li> <li>\u4e3a\u4e86\u786e\u4fdd DML \u64cd\u4f5c\u7684\u4e00\u81f4\u6027\uff0c\u6211\u4eec\u5728 DML \u6d41\u7a0b\u4e2d\u8fdb\u884c\u4e86\u4fee\u6539\uff0c\u8981\u6c42\u6bcf\u4e2a\u8bf7\u6c42\u4ec5\u4f7f\u7528\u4e00\u6b21\u5f02\u6b65\u64cd\u4f5c\u5c06\u6570\u636e\u5199\u5165\u3002\u5177\u4f53\u5b9e\u73b0\u662f\u5728\u6570\u636e\u771f\u6b63\u5199\u5165\u7684 <code>Raft::commitLog()</code> \u51fd\u6570\u4e2d\uff0c\u901a\u8fc7\u68c0\u67e5\u952e\uff08Key\uff09\u7684\u7b2c\u4e00\u4e2a\u5b57\u8282\uff08Type\uff09\uff0c\u6765\u5224\u65ad\u9700\u8981\u5199\u5165\u5230\u54ea\u4e2a\u5217\u65cf\u4e2d\u3002 </li> <li>\u9664\u4e86 Graghd \u4f1a\u751f\u6210\u7269\u7406\u8ba1\u5212\uff0c\u5b9e\u9645\u4e0a Storaged \u4e5f\u4f1a\u751f\u6210\u81ea\u5df1\u7684\u6267\u884c\u8ba1\u5212\uff0c\u8fd9\u4e2a\u8ba1\u5212\u4f1a\u8c03\u7528\u5b58\u50a8\u5f15\u64ce\u7684\u63a5\u53e3\u5c06\u6570\u636e\u5199\u5165 RocksDB \u4e2d\u3002\u6211\u4eec\u9700\u8981\u4e3a\u83b7\u53d6\u5411\u91cf\u5c5e\u6027\u4fee\u6539\u76f8\u5173\u8ba1\u5212\u8282\u70b9(TagNode/EdgeNode)\u3002</li> <li>\u4e3a\u4e86\u652f\u6301 TagNode/EdgeNode \u591a\u5411\u91cf\u5c5e\u6027\u7684\u652f\u6301\uff0c\u5728 TagNode/EdgeNode \u4e2d\u589e\u52a0\u4e86<code>std::vector&lt;RowReader&gt; vecReaders_</code>\u6210\u5458\u53d8\u91cf\uff0c\u7528\u4e8e\u8bfb\u53d6\u591a\u4e2a\u5411\u91cf\u5c5e\u6027\u7684\u503c\u3002 </li> </ul>"},{"location":"projects/nebula-vsearch/summary/#ann-index-in-common","title":"\u5411\u91cf\u7d22\u5f15\u529f\u80fd(Ann Index in Common)","text":"<p>\u6211\u4eec\u4f1a\u5c06\u5411\u91cf\u7d22\u5f15\u5bf9\u8c61\u4ea4\u7531\u5b58\u50a8\u670d\u52a1\uff08Storage Server\uff09\u7ba1\u7406\uff0c\u91c7\u7528 <code>&lt;TagID, IndexID&gt;</code> \u4f5c\u4e3a key\uff0c<code>shared_ptr&lt;AnnIndex&gt;</code>\u4f5c\u4e3a value\u3002</p> <ul> <li> <p>\u5411\u91cf\u7d22\u5f15\u751f\u547d\u5468\u671f: \u5411\u91cf\u7d22\u5f15\u7684\u751f\u547d\u5468\u671f\u7531\u5b58\u50a8\u670d\u52a1\u7ba1\u7406\u3002\u6267\u884c Create Index \u547d\u4ee4\u540e\uff0c\u4f1a\u63d2\u5165\u5bf9\u5e94\u7684\u5411\u91cf\u7d22\u5f15\uff1b\u6267\u884c Drop Index \u547d\u4ee4\u540e\uff0c\u8be5\u7d22\u5f15\u4f1a\u88ab\u79fb\u9664\u3002\u5728\u5176\u4ed6\u60c5\u51b5\u4e0b\uff0c\u5b58\u50a8\u670d\u52a1\u4f1a\u6301\u7eed\u7ef4\u62a4\u8be5\u7d22\u5f15\u3002</p> </li> <li> <p>\u6301\u4e45\u5316\uff1a\u5f53\u5b58\u50a8\u670d\u52a1\u5173\u95ed\u6216\u5d29\u6e83\u524d\uff0c\u5c06\u7d22\u5f15\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u6bcf\u6b21\u91cd\u542f\u65f6\u52a0\u8f7d\u3002</p> </li> <li> <p>\u5185\u5b58\u8ffd\u8e2a: \u6682\u65f6\u5229\u7528 Nebula \u5185\u7f6e\u7684 MemoryTracker \u5b9a\u671f\u67e5\u8be2\u5185\u5b58\u7d22\u5f15\u7684\u5927\u5c0f\u3002\u5982\u679c\u8d85\u8fc7\u9650\u5236\uff0c\u5c31\u7981\u6b62\u63d2\u5165\u65b0\u7684\u5411\u91cf</p> </li> <li> <p>\u4f7f\u7528<code>MemoryTracker::getCurrentUsage()</code>\u83b7\u53d6\u5f53\u524d\u5185\u5b58\u4f7f\u7528\u91cf</p> </li> <li> <p>Faiss &amp; HNSW \u5e76\u53d1: \u901a\u8fc7\u5b9e\u73b0 ANNIndex \u63a5\u53e3\uff0c\u6211\u4eec\u5b9e\u73b0\u4e86\u4e24\u79cd\u5411\u91cf\u7d22\u5f15\uff0c\u4e00\u79cd\u57fa\u4e8e Faiss IVF \u7d22\u5f15\uff0c\u53e6\u4e00\u79cd\u57fa\u4e8e HNSWlib HNSW \u7d22\u5f15\u3002\u4e3a\u4e86\u5b9e\u73b0\u5e76\u53d1\u63a7\u5236\uff0c\u6211\u4eec\u5728\u5411\u91cf\u7d22\u5f15\u4e2d\u5f15\u5165\u4e86\u8bfb\u5199\u9501\uff1a\u5141\u8bb8\u591a\u4e2a\u67e5\u8be2\u540c\u65f6\u6267\u884c ANN \u641c\u7d22\uff08ANN Search\uff09\uff0c\u4f46\u53ea\u5141\u8bb8\u4e00\u4e2a DML \u64cd\u4f5c\uff08Add \u6216 Remove\uff09\u8fdb\u884c\u3002</p> </li> <li> <p>ANN \u7d22\u5f15\u63a5\u53e3: \u76ee\u524d\u6211\u4eec\u4ec5\u5b8c\u6210\u4e86 ANN \u7d22\u5f15\u6a21\u5757\u7684\u5355\u673a\u6d4b\u8bd5\uff0cWAL \u548c Raft \u76f8\u5173\u65b9\u6cd5\u5c1a\u672a\u5b9e\u73b0\u3002</p> </li> </ul> C++<pre><code>class AnnIndex {\npublic:\n  AnnIndex() = default;\n\n  AnnIndex(GraphSpaceID graphID,\n          PartitionID partitionID,\n          IndexID indexID,\n          const std::string &amp;indexName,\n          bool propFromNode,\n          size_t dim,\n          const std::string &amp;rootPath,\n          MetricType metricType,\n          size_t minTrainDataSize = 3);\n\n  virtual ~AnnIndex() = default;\n  AnnIndex(const AnnIndex &amp;) = delete;\n  AnnIndex &amp;operator=(const AnnIndex &amp;) = delete;\n\n  [[nodiscard]] virtual Status init(const BuildParams *params) = 0;\n  // add data to index incrementally\n  [[nodiscard]] virtual Status add(const VecData *data) = 0;\n  // upsert data to index\n  [[nodiscard]] virtual Status upsert(const VecData *data) = 0;\n  // soft delete data from index, return number of deleted vectors\n  [[nodiscard]] virtual StatusOr&lt;size_t&gt; remove(const IDSelector &amp;sel) = 0;\n\n  // ann search\n  [[nodiscard]] virtual Status search(const SearchParams *params, SearchResult *res) = 0;\n  // reconstruct vector by id\n  [[nodiscard]] virtual StatusOr&lt;Vector&gt; reconstruct(VectorID id) = 0;\n\n  // load index file from disk\n  // flush index to disk\n  [[nodiscard]] virtual Status read(const std::string &amp;file) = 0;\n  [[nodiscard]] virtual Status write(const std::string &amp;dir, const std::string &amp;file) = 0;\n\n  // apply raft log, disable index dump and roll the WAL when taking snapshot\n  [[nodiscard]] virtual Status applyRaftLog(const AnnRaftLog &amp;log, bool takingSnapshot) = 0;\n  // load raft log to memory index\n  [[nodiscard]] virtual Status loadRaftLog(const AnnRaftLog &amp;log) = 0;\n\n  // create wal file or open existing wal file via file name(not absolute path)\n  [[nodiscard]] virtual Status openWal(const std::string &amp;walName) = 0;\n  // close wal file and release write/read stream\n  [[nodiscard]] virtual Status closeWal() = 0;\n  // remove wal file\n  [[nodiscard]] virtual Status removeWal() = 0;\n  // remove idx file\n  [[nodiscard]] virtual Status removeIdxFile() = 0;\n  // load index file and wal file from disk\n  [[nodiscard]] virtual Status load() = 0;\n  // create checkpoint for snapshot\n  [[nodiscard]] virtual Status createCheckpoint(const std::string &amp;snapshotPath) = 0;\n  virtual AnnIndexType indexType() const = 0;\n  virtual std::string toString() const = 0;\n};\n</code></pre>"},{"location":"projects/nebula-vsearch/summary/#ddl-createdrop-index","title":"\u5411\u91cf\u7d22\u5f15\u7684 DDL \u8bed\u53e5(Create/Drop Index)","text":""},{"location":"projects/nebula-vsearch/summary/#_8","title":"\u8bed\u6cd5\u8bbe\u8ba1","text":"<ul> <li>Tag Ann Index:</li> </ul> Bash<pre><code>CREATE TAG ANNINDEX &lt;index_name&gt; ON &lt;tag_name_list&gt;::(&lt;field_name&gt;) [IF NOT EXISTS] ann_index_params}[COMMENT '&lt;comment&gt;']\n</code></pre> <ul> <li>Edge Ann Index:</li> </ul> Bash<pre><code>CREATE EDGE ANNINDEX &lt;index_name&gt; ON &lt;tag_name_list&gt;::(&lt;field_name&gt;) [IF NOT EXISTS] ann_index_params}[COMMENT '&lt;comment&gt;']\n</code></pre> <ul> <li>Ann Index Params</li> </ul> Bash<pre><code>{ANNINDEX_TYPE: \"IVF\", DIM:128, METRIC_TYPE:\"L2\", NLIST:3, TRAINSIZE:3}\n{ANNINDEX_TYPE: \"HNSW\", DIM:128, METRIC_TYPE:\"L2\", MAXDEGREE:15, EFCONSTRUCTION:200}\n</code></pre>"},{"location":"projects/nebula-vsearch/summary/#_9","title":"\u6267\u884c\u6d41\u7a0b\u8bbe\u8ba1","text":"<ul> <li> <p>Graphd \u751f\u6210\u7684\u6267\u884c\u8ba1\u5212\u4e3a\uff1a<code>Start -&gt; CreateTagAnnIndex -&gt; SubmitJob</code>\u3002<code>SubmitJob</code> \u4f1a\u5c06\u4efb\u52a1\u53d1\u9001\u5230 Metad\u3002</p> </li> <li> <p>Metad \u9996\u5148\u5728\u5185\u90e8\u521b\u5efa Ann \u7d22\u5f15\u6761\u76ee\u3002\u521b\u5efa\u6210\u529f\u540e\uff0c\u4f1a\u63d0\u4ea4\u4e00\u4e2a <code>AdminJob</code>\u3002 Metad \u4f1a\u5c06\u4f5c\u4e1a\u53c2\u6570\u6253\u5305\u5e76\u53d1\u9001\u7ed9 Storaged \u7684 <code>AdminTask</code>\u3002Storaged \u901a\u8fc7\u5176\u5185\u90e8\u7684 <code>AdminTaskManager</code> \u6765\u5904\u7406\u8fd9\u4e9b\u4efb\u52a1\uff0c\u4ece\u800c\u5b8c\u6210\u4f5c\u4e1a\u3002  \u8fd9\u91cc\u6d89\u53ca\u4e00\u4e2a\u5206\u5e03\u5f0f\u7684\u65f6\u5e8f\u95ee\u9898\uff1a</p> </li> <li> <p>MetaClient \u7f13\u5b58\u66f4\u65b0\u673a\u5236\uff1aStorage \u8282\u70b9\u7684 IndexManager \u901a\u8fc7 MetaClient \u83b7\u53d6\u7d22\u5f15\u4fe1\u606f\uff0c\u4f46 MetaClient \u7684\u7f13\u5b58\u662f\u901a\u8fc7\u5fc3\u8df3\u5468\u671f\u6765\u66f4\u65b0\u7684\u3002</p> </li> <li>\u65f6\u5e8f\u95ee\u9898\uff1a\u5728 Meta \u670d\u52a1\u521b\u5efa\u7d22\u5f15\u4e4b\u540e\uff0cStorage \u8282\u70b9\u9700\u8981\u7b49\u5230\u4e0b\u4e00\u6b21\u5fc3\u8df3\u5468\u671f\u624d\u80fd\u770b\u5230\u65b0\u7d22\u5f15\u3002</li> <li>\u540c\u6b65\u95ee\u9898\uff1agetTagAnnIndex \u662f\u76f4\u63a5\u4ece\u7f13\u5b58\u4e2d\u8bfb\u53d6\u3002\u5982\u679c\u7f13\u5b58\u8fd8\u6ca1\u66f4\u65b0\uff0c\u5c31\u4f1a\u8fd4\u56de IndexNotFound\u3002</li> </ul> <p>\u56e0\u6b64\uff0c\u5728 Storaged \u4e2d\u6211\u4eec\u91c7\u7528\u4e86\u91cd\u8bd5\u673a\u5236\u3002\u5982\u679c\u591a\u6b21\u91cd\u8bd5\u4ecd\u7136\u5931\u8d25\uff0c\u5c31\u4f1a\u76f4\u63a5\u5411 Meta \u670d\u52a1\u8bf7\u6c42\u6570\u636e\uff0c\u4ee5\u5f3a\u5236\u5237\u65b0\u7f13\u5b58\u3002</p> <ul> <li> <p>Storaged \u4f1a\u904d\u5386\u5f53\u524d\u6240\u6709\u7684 partition\uff0c\u5bf9\u4e8e\u6bcf\u4e2a Partition\uff0c\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> </li> <li> <p>\u626b\u63cf KVStore\uff08RocksDB\uff09\u4e2d\u6240\u6709\u5339\u914d\u8be5\u5c5e\u6027\u540d\u7684\u5411\u91cf\u5c5e\u6027\u6570\u636e\u3002</p> </li> <li>\u5c06 Vertex ID \u4e0e VectorID \u4e4b\u95f4\u7684\u6620\u5c04\u5173\u7cfb\u5b58\u50a8\u5230 KVStore \u7684 id-vid \u5217\u65cf\u4e2d\u3002</li> <li>\u5176\u4e2d\uff0cVertex ID \u7c7b\u578b\u4e3a <code>std::string</code>\u3002\u800c VectorID \u662f\u901a\u8fc7\u54c8\u5e0c\u8ba1\u7b97\u5f97\u5230\u7684\uff0c\u56e0\u6b64\u9700\u8981\u5b58\u50a8\u4e24\u79cd\u6620\u5c04\uff1a<ul> <li><code>VectorID \u2192 VertexID</code></li> <li><code>VertexID \u2192 VectorID</code></li> </ul> </li> <li>\u6700\u540e\u6784\u5efa\u5411\u91cf\u7d22\u5f15\uff0c\u5e76\u5c06\u5176\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u3002</li> </ul> <p></p> <p> Storaged \u4e2d\u5b9e\u9645\u4e0a\u4e5f\u4f1a\u6709\u4e00\u4e2a\u8ba1\u5212\uff0c\u8fdb\u884c\u771f\u6b63\u7684\u7d22\u5f15\u521b\u5efa\u5de5\u4f5c\uff1a</p> <ol> <li>\u4ece RocksDB \u4e2d\u626b\u63cf\u6240\u6709\u7684\u5411\u91cf\u6570\u636e</li> <li>\u5c06 Vertex ID \u4e0e Vector ID \u7684\u6620\u5c04\u5173\u7cfb\u5b58\u50a8\u5230 id-vid \u5217\u65cf\u4e2d(\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u9700\u8981\u4e09\u4e2a\u5217\u65cf)</li> <li>\u6784\u5efa\u5411\u91cf\u7d22\u5f15\u5e76\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d</li> </ol> <p></p>"},{"location":"projects/nebula-vsearch/summary/#ann-search","title":"ANN Search","text":"<p>\u4e3a\u4e86\u5b9e\u73b0 ANN Search \u529f\u80fd\uff0c\u6211\u4eec\u5bf9\u73b0\u6709\u7684 Match \u8bed\u53e5\u8fdb\u884c\u4e86\u6269\u5c55\uff0c\u5728<code>Return \u8bed\u53e5</code>\u65b0\u589e\u4e86 <code>Approximate limit</code> \u8bed\u6cd5\u548c <code>euclidean</code> \u7b49\u51fd\u6570\u3002</p> <p>\u5177\u4f53\u6765\u8bf4\uff0c\u5982\u679c\u5f53\u524d\u7684 Tag/Edge \u4e0a\u6709 ANN \u7d22\u5f15\uff0c\u6267\u884c\u8ba1\u5212\u4f1a\u9996\u5148\u626b\u63cf ANN \u7d22\u5f15\u4ee5\u83b7\u53d6 limit \u00d7 K \u6761\u6570\u636e\uff0c\u7136\u540e\u518d\u4e0e\u5176\u4ed6\u6570\u636e\u4e00\u8d77\u505a\u8fc7\u6ee4\u83b7\u5f97 limit \u6761\u6570\u636e\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u5fc5\u987b\u4fee\u6539\u4f18\u5316\u89c4\u5219\u4ee5\u6267\u884c<code>AnnIndexScan</code>\u548c graphd \u7684\u7269\u7406\u6267\u884c\u8ba1\u5212\uff0c\u5e76\u4e14\u5728 storaged \u4e2d\u65b0\u589e\u4e00\u4e2a <code>AnnIndexScan</code> \u8282\u70b9\u3002</p>"},{"location":"projects/nebula-vsearch/summary/#_10","title":"\u8bed\u6cd5\u8bbe\u8ba1","text":"<ul> <li>\u4e0d\u8fd4\u56de vector distance</li> </ul> Bash<pre><code>match (v:tag5:tag6) return v order by euclidean(vector(1.0,2.0,3.0), v.vec)  approximate limit 3 options {ANNINDEX_TYPE:'IVF', METRIC_TYPE:L2, NPROBE:3}\n</code></pre> <ul> <li>\u8fd4\u56de vector distance</li> </ul> Bash<pre><code> match (v:tag5:tag6) return v, euclidean(vector(1.0,2.0,3.0), v.vec) order by euclidean(vector(1.0,2.0,3.0), v.vec)  approximate limit 1 options {ANNINDEX_TYPE:'IVF', METRIC_TYPE:L2, NPROBE:3}\n</code></pre>"},{"location":"projects/nebula-vsearch/summary/#overview","title":"Overview","text":"<p>\u6574\u4f53\u7684\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u7ecf\u8fc7\u4f18\u5316\u89c4\u5219\u5904\u7406\u540e\u7684\u7269\u7406\u6267\u884c\u8ba1\u5212\u4f1a\u6267\u884c <code>TagAnnIndexScan</code>\uff0c\u5728 storaged \u6536\u5230\u8bf7\u6c42\u540e\uff0c\u4f1a\u751f\u6210\u4e00\u4e2a\u5185\u90e8\u6267\u884c\u8ba1\u5212\uff0c\u5728 IVF \u7d22\u5f15\u4e0a\u8fdb\u884c\u641c\u7d22\uff0c\u5e76\u5c06\u7ed3\u679c\u8fd4\u56de\u7ed9 graphd</li> <li>Graphd \u8c03\u7528 storaged \u7684 <code>getProp</code> \u7b97\u5b50\u751f\u6210\u6267\u884c\u8ba1\u5212\uff0c\u4ee5\u83b7\u53d6\u8282\u70b9\u7684\u975e\u5411\u91cf\u5c5e\u6027\uff0c\u6700\u540e\u6267\u884c Limit \u548c Project\uff0c\u5f97\u5230\u6700\u7ec8\u7ed3\u679c</li> </ol> <p></p>"},{"location":"projects/nebula-vsearch/summary/#_11","title":"\u4f18\u5316\u89c4\u5219","text":"<ul> <li>\u5bf9\u4e0d\u8fd4\u56de\u5411\u91cf\u8ddd\u79bb\u7684\u8bed\u53e5\uff0c\u4f18\u5316\u5668\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a:</li> </ul> <ul> <li>\u5bf9\u8fd4\u56de\u5411\u91cf\u8ddd\u79bb\u7684\u8bed\u53e5\uff0c\u4f18\u5316\u5668\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a:</li> </ul>"},{"location":"projects/nebula-vsearch/summary/#_12","title":"\u6267\u884c\u6d41\u7a0b","text":"<p>\u7ecf\u8fc7\u4f18\u5316\u5668\u4f18\u5316\u540e\u7aef Graphd \u7aef\u7684\u7269\u7406\u6267\u884c\u8ba1\u5212\u4e3a<code>TagAnnIndexScan -&gt; GetProp -&gt; Limit -&gt; Project</code>\uff0cgraphd \u548c storaged \u751f\u6210\u7684\u8ba1\u5212\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p>\u5bf9\u6bcf\u4e2a\u8ba1\u5212\u8282\u70b9 Graphd \u4f1a\u751f\u6210\u5bf9\u5e94\u7684\u6267\u884c\u5668\uff0c\u6bcf\u4e2a\u6267\u884c\u5668\u90fd\u4f1a\u901a\u8fc7 RPC \u5411 storaged \u4e0a\u7684\u670d\u52a1\u53d1\u8d77\u8fdc\u7a0b\u8c03\u7528\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0cstoraged \u63a5\u6536\u5230 graphd \u7684\u8bf7\u6c42\u540e\u4f1a\u542f\u52a8\u5b83\u81ea\u5df1\u7684\u6267\u884c\u5668\uff0c\u5e76\u5728\u5176\u4e2d\u751f\u6210 storaged \u7684\u6267\u884c\u8ba1\u5212\uff0c\u8ba1\u5212\u6267\u884c\u4f1a\u4ece Ann Index \u4e2d\u83b7\u53d6\u6570\u636e\uff0c\u6700\u540e\u8fd4\u56de\u7ed3\u679c\u7ed9 graphd\u3002</p> <p></p> <p>\u5b9e\u9645\u4e0a\uff0c\u5728 storaged \u4e2d\uff0c<code>AnnIndexScan</code> \u7684\u5904\u7406\u8fc7\u7a0b\u4e0e <code>IndexScan</code> \u975e\u5e38\u76f8\u4f3c\u3002</p> <ul> <li>\u9700\u8981\u5148\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u7136\u540e\u6267\u884c <code>doExecute</code>\u3002\u5b9e\u9645\u7684\u6570\u636e\u83b7\u53d6\u662f\u901a\u8fc7\u8c03\u7528 <code>resetIter</code> \u5b8c\u6210\u7684\u3002 <p>\u6b64\u65f6\u662f\u901a\u8fc7 ANN \u7d22\u5f15\u83b7\u53d6\u7ed3\u679c\uff08\u8fd9\u91cc\u5f97\u5230\u7684\u53ea\u662f\u5411\u91cf ID\uff0c\u800c\u4e0d\u662f\u5b9e\u9645\u7684\u9876\u70b9 ID\uff09</p> </li> <li>\u968f\u540e <code>doNext</code> \u53ea\u662f\u7b80\u5355\u5730\u904d\u5386\u8fd9\u4e9b\u7ed3\u679c\uff0c\u518d\u8c03\u7528 <code>AnnIndexVertexScan::getVidByVectorid()</code>\u4ece RocksDB \u4e2d\u83b7\u53d6\u5b9e\u9645\u7684 VID \u6570\u636e\uff0c\u5e76\u5c06 VID \u4e0e\u5411\u91cf\u8ddd\u79bb\u6570\u636e\u4e00\u5e76\u8fd4\u56de\u7ed9 graphd\u3002</li> </ul> <p></p>"},{"location":"projects/nebula-vsearch/summary/#_13","title":"\u529f\u80fd\u6d4b\u8bd5","text":""},{"location":"projects/nebula-vsearch/summary/#tck","title":"tck \u6d4b\u8bd5","text":"<ul> <li> <p>\u4f7f\u7528 tck \u56de\u5f52\u6d4b\u8bd5\u5de5\u5177\uff0c\u901a\u8fc7\u5bf9\u65b0\u589e\u529f\u80fd\u7f16\u5199\u65b0\u7684\u6d4b\u8bd5\u7528\u4f8b\u6d4b\u8bd5\uff0c\u786e\u4fdd\u65b0\u589e\u529f\u80fd\u6ca1\u6709\u5f71\u54cd\u5230\u539f\u6709\u529f\u80fd\u3002</p> </li> <li> <p>\u65b0\u589e\u7684\u6d4b\u8bd5\u7528\u4f8b\u89c1<code>tests/tck/features/vector</code>\u76ee\u5f55\u4e0b</p> <ul> <li><code>Create Tag/Edge with VECTOR property</code></li> <li><code>Insert/Update/Delete/Upsert VECTOR property</code></li> <li><code>Create Ann Index</code></li> </ul> </li> <li> <p>\u8be6\u7ec6\u7684\u6d4b\u8bd5\u7ed3\u679c\u89c1\u4e0b\u8868\u7684 github PR \u94fe\u63a5\u3002</p> \u529f\u80fd PR \u94fe\u63a5 \u5411\u91cf\u6570\u636e\u7c7b\u578b Implement vector value type \u5411\u91cf\u5b58\u50a8\u652f\u6301 Implement the multiple column family RocksDB \u5411\u91cf\u7c7b\u578b\u7684 Key \u7ed3\u6784 Implement the key for vector type \u5411\u91cf\u5c5e\u6027\u7684 DDL \u8bed\u53e5 Implement CREATE TAG statement for vector type \u5411\u91cf\u5c5e\u6027\u7684 DML \u8bed\u53e5(Insert/Update/Delete/Upsert) Implement DML statement and process for vector type \u5411\u91cf\u7d22\u5f15\u529f\u80fd Vector index Interface \u5411\u91cf\u7d22\u5f15\u7684 DDL \u8bed\u53e5(Create/Drop Index) Create Ann Index ANN Search Ann Search </li> <li> <p>tck \u6d4b\u8bd5\u7528\u4f8b\u7ed3\u679c\uff1a </p> </li> </ul>"},{"location":"projects/nebula-vsearch/summary/#_14","title":"\u5355\u5143\u6d4b\u8bd5","text":"<ul> <li>VECTOR \u6570\u636e\u7c7b\u578b\u6d4b\u8bd5</li> </ul> C++<pre><code>nebula::Vector shortVec1({1.11, 2.22, 3.33});\nnebula::Vector emptyVec;\n// we will test dimension in ValueTest.cpp\n// so here we assume the dimensions of two vectors are equal\n\nEXPECT_EQ(shortVec1.dim(), 3);\nEXPECT_EQ(emptyVec.dim(), 0);\nEXPECT_EQ(shortVec1, nebula::Vector({1.11, 2.22, 3.33}));\n</code></pre> <ul> <li> <p>RocksDB \u652f\u6301\u591a\u5217\u65cf\u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/kvstore/test/RocksEngineMultiCFTest.cpp</code></p> </li> <li> <p>MultiCFSimpleOptionTest</p> </li> <li> <p>MultiCFCompressionConfigTest</p> </li> <li> <p>\u5bf9\u65b0\u589e\u8bed\u6cd5\u7684\u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/parser/test/ParserTest.cpp</code></p> </li> <li> <p>\u5bf9 VECTOR \u7c7b\u578b\u7684 Key \u7ed3\u6784\u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/common/test/NebulaKeyUtilsTest.cpp</code></p> </li> <li> <p>VectorSimpleTest</p> </li> <li> <p>VectorNegativeEdgeTypeTest</p> </li> <li> <p>\u5411\u91cf\u5c5e\u6027\u7684 DDL \u8bed\u53e5\u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/meta/test/ProcessorTest.cpp</code></p> </li> <li> <p>CreateVectorTagTest</p> </li> <li> <p>CreateVectorEdgeTest</p> </li> <li> <p>RowWriter \u548c RowReader \u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/codec/test/RowWriterV2Test.cpp</code></p> </li> <li> <p>VectorTest</p> </li> <li>VectorWithDefaultValue</li> <li>DoubleSetVector</li> <li> <p>UpdateVector</p> </li> <li> <p>\u5411\u91cf\u7d22\u5f15\u529f\u80fd\u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/common/vectorIndex/test/AnnIndexTest.cpp</code></p> </li> <li> <p>IVFIndexTest</p> </li> <li> <p>HNSWIndexTest</p> </li> <li> <p>Ann Benchmark \u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/common/vectorIndex/test/ANNBenchmark.cpp</code></p> </li> <li> <p>IVFBenchmarkTest</p> </li> <li>HNSWBenchmarkTest</li> </ul>"},{"location":"projects/nebula-vsearch/summary/#mock","title":"Mock \u6d4b\u8bd5","text":"<ul> <li>DML \u529f\u80fd\u5b9e\u73b0\u4e86 Mock \u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/storage/test/AddVerticesTest.cpp</code> \u548c <code>src/storage/test/AddEdgesTest.cpp</code></li> <li>SimpleVectorTest</li> <li>BasicHNSWAnnSearchTest</li> <li>MultiVersionVectorTest</li> <li>Create Ann Index \u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/storage/test/BuildTagVectorIndexTest.cpp</code> \u548c <code>src/storage/test/BuildEdgeVectorIndexTest.cpp</code></li> <li>Get Vector Prop \u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/storage/test/GetPropTest.cpp</code></li> <li>VectorPropertyTest</li> <li>Ann Search \u6d4b\u8bd5\uff0c\u8be6\u60c5\u89c1<code>src/storage/test/LookupAnnProcessorTest.cpp</code></li> <li>BasicAnnSearchTest</li> <li>BasicHNSWAnnSearchTest</li> </ul>"},{"location":"projects/nebula-vsearch/summary/#_15","title":"\u540e\u7eed\u5de5\u4f5c\u8ba1\u5212","text":"<ul> <li>\u7ed3\u5408\u4fee\u6539\u540e\u7684 Search \u8bed\u53e5\u5bf9 DML \u8fdb\u884c\u66f4\u8be6\u7ec6\u7684\u6d4b\u8bd5</li> <li>\u5b8c\u6210\u5206\u5e03\u5f0f\u4e00\u81f4\u6027\u548c\u53ef\u7528\u6027\u8981\u6c42\uff0c\u4fdd\u8bc1\u5411\u91cf\u6570\u636e\u526f\u672c\u4e00\u81f4\u6027\u53ca\u5185\u5b58\u78c1\u76d8\u6570\u636e\u4e00\u81f4\u6027</li> <li>\u4fee\u6539 DML \u64cd\u4f5c\uff0c\u5728 Raft \u63d0\u4ea4\u65e5\u5fd7\u8fc7\u7a0b\u540e\u5c06\u6570\u636e\u5199\u5165\u5185\u5b58\u7d22\u5f15</li> <li>\u5b9e\u73b0\u5411\u91cf\u7d22\u5f15\u7684 WAL \u673a\u5236\uff0c\u4fdd\u8bc1\u5185\u5b58\u548c\u78c1\u76d8\u6570\u636e\u4e00\u81f4\u6027</li> <li>\u5904\u7406\u8282\u70b9\u91cd\u542f\uff08\u4ece RocksDB \u91cd\u5efa\u7d22\u5f15\u5e76\u56de\u653e\u65e5\u5fd7\uff09\u548c leader \u5207\u6362\u3002     &gt; snapshot: \u5f53\u4e00\u4e2a\u65b0 follower \u52a0\u5165\u96c6\u7fa4\u65f6\uff0c\u5b83\u9700\u8981\u63a5\u6536\u4e00\u4efd\u5feb\u7167\u3002\u8fd9\u4efd\u5feb\u7167\u73b0\u5728\u5fc5\u987b\u5305\u542b ANN \u7d22\u5f15\u7684\u5e8f\u5217\u5316\u8868\u793a\uff0c\u4ee5\u907f\u514d\u4ece\u5934\u5f00\u59cb\u8fdb\u884c\u4ee3\u4ef7\u9ad8\u6602\u7684\u5b8c\u5168\u91cd\u5efa</li> <li>\u5b8c\u6210\u6240\u6709\u529f\u80fd\u540e\u8fdb\u884c\u4ee3\u7801\u7684\u91cd\u6784\u548c\u4f18\u5316</li> <li>\u5bf9 ANN Search \u6027\u80fd\u8fdb\u884c\u4f18\u5316\u4ee5\u6ee1\u8db3\u4e1a\u52a1\u9700\u6c42</li> </ul>"},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/","title":"\u4e0a\u7bc7\uff1a\u521d\u8bc6 Nebula Graph \u2014\u2014 \u5411\u91cf\u7c7b\u578b\u652f\u6301","text":"2025-10-282025-12-13 <code>#Database</code>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#nebula-graph","title":"\u4e0a\u7bc7\uff1a\u521d\u8bc6 Nebula Graph \u2014\u2014 \u5411\u91cf\u7c7b\u578b\u652f\u6301","text":"<p> \u7ea6 2614 \u4e2a\u5b57  204 \u884c\u4ee3\u7801  7 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 16 \u5206\u949f</p> <p>\ud83d\udcda \u672c\u7cfb\u5217\u6587\u7ae0\u5206\u4e3a\u4e0a\u4e2d\u4e0b\u4e09\u7bc7\uff0c\u8bb0\u5f55\u4e86\u6211\u5728\u5f00\u6e90\u4e4b\u590f\u9879\u76ee\u4e2d\uff0c\u5f00\u53d1 Nebula Graph \u5411\u91cf\u641c\u7d22\u529f\u80fd\u7684\u4e00\u4e9b\u590d\u76d8\u548c\u601d\u8003\uff0c\u5e0c\u671b\u53ef\u4ee5\u7ed9\u5927\u5bb6\u5b66\u4e60\u548c\u5f00\u53d1\u7c7b\u4f3c\u7cfb\u7edf\u65f6\u6709\u4e00\u5b9a\u7684\u6837\u672c\u53c2\u8003\u3002\u5e0c\u671b\u5927\u5bb6\u591a\u591a\u5173\u6ce8\u548c\u4ea4\u6d41\uff0c\u5927\u5bb6\u4e00\u8d77\u8fdb\u6b65 \ud83d\ude0a \u6b22\u8fce\u8ba2\u9605\u6211\u7684\u4e2a\u4eba\u7f51\u7ad9 tom-jerr.github.io</p> <p>\u4e0a\u7bc7\u4e3b\u8981\u4ecb\u7ecd Nebula Graph \u7684\u6574\u4f53\u6267\u884c\u6d41\u7a0b\uff0c\u91cd\u70b9\u8bb2\u89e3\u5411\u91cf\u7c7b\u578b\u7684\u8bbe\u8ba1\u548c\u5411\u91cf\u5b58\u50a8\u7684\u8bbe\u8ba1\u601d\u8def\u3002</p> <p>\u4e2d\u7bc7\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u652f\u6301\u5411\u91cf\u5c5e\u6027\u7684 DDL \u548c DML \u8bed\u53e5( \u8d70\u4e86\u5f88\u591a\u8bbe\u8ba1\u7684\u5f2f\u8def)\u3002</p> <p>\u4e0b\u7bc7\u4e3b\u8981\u4ecb\u7ecd\u5982\u4f55\u5b9e\u73b0\u5411\u91cf\u7d22\u5f15\u548c\u5411\u91cf\u641c\u7d22\u529f\u80fd\u3002</p> <p>\u5728\u771f\u6b63\u5f00\u59cb\u5bf9 Nebula Graph \u8fdb\u884c\u5927\u5200\u9614\u65a7\u7684\u6539\u52a8\u4e4b\u524d\uff0c\u6211\u4eec\u5fc5\u987b\u5148\u4e86\u89e3\uff0c\u4e00\u6761 Cypher \u8bed\u53e5\u662f\u5982\u4f55\u5728\u7cfb\u7edf\u4e2d\u6267\u884c\u7684\u3002\u5f53\u6709\u4e86\u5bf9\u8bed\u53e5\u6267\u884c\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u6211\u4eec\u53ef\u4ee5\u5f00\u59cb\u6df1\u5165\u6bcf\u4e2a\u6a21\u5757\u8fdb\u884c\u4fee\u6539\u6765\u652f\u6301\u5411\u91cf\u529f\u80fd\u3002</p> <p>\u8fd9\u7bc7\u6587\u7ae0\u4e3b\u8981\u4ece\u5bf9 Nebula Graph \u7684\u6574\u4f53\u6267\u884c\u6d41\u7a0b\u51fa\u53d1\uff0c\u805a\u7126\u5982\u4f55\u5b9e\u73b0 Vector \u6570\u636e\u7c7b\u578b\u4ee5\u53ca Vector \u5b58\u50a8\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#cypher","title":"\u4e00\u6761 Cypher \u8bed\u53e5\u7684\u524d\u4e16\u4eca\u751f","text":"<p>\u26a0 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6574\u4e2a Nebula Graph \u7cfb\u7edf\u7684\u6267\u884c\u8def\u5f84\u90fd\u662f\u5f02\u6b65\u7684\uff0c\u8c03\u7528\u8005\u7acb\u5373\u62ff\u5230 Future\uff0c\u800c\u6267\u884c\u8005\u5728\u5de5\u4f5c\u5b8c\u6210\u540e\u901a\u8fc7 Promise \u586b\u5145\u7ed3\u679c\uff0c\u7136\u540e\u81ea\u52a8\u89e6\u53d1 Future \u4e0a\u7684\u56de\u8c03\u6267\u884c\u540e\u7eed\u903b\u8f91\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#overview","title":"Overview","text":"<ol> <li>\u7528\u6237\u5728 <code>console</code> \u6216\u8005\u901a\u8fc7 <code>sdk</code> \u8f93\u5165 Cypher \u8bed\u53e5\u5230 Graph Service\uff0c\u7acb\u5373\u8fd4\u56de\u7ed9\u7528\u6237 Future\uff0c\u7ebf\u7a0b\u6c60\u7684\u5de5\u4f5c\u7ebf\u7a0b\u5f00\u59cb\u6267\u884c\u4e0b\u9762\u7684\u771f\u5b9e\u5de5\u4f5c\u6d41\u7a0b\u3002</li> <li>Graph Service \u5c06 Query\u3001Session\u3001Storage \u7b49\u6253\u5305\u6210 Request Context\uff0c\u968f\u540e\u5c06 Request Context \u6253\u5305\u6210 Query Context\uff0c\u521b\u5efa Query Instance \u968f\u540e\u5f00\u59cb\u6267\u884c parse\u3001validate\u3001optimize\u3001execute \u6574\u4e2a\u6d41\u7a0b\uff0c\u8fd9\u91cc\u751f\u6210\u4e86 Graphd \u7684\u7269\u7406\u8ba1\u5212\u3002    - Query Context \u7684\u751f\u547d\u5468\u671f\u4ece\u8bed\u53e5\u4f20\u5165 Graphd \u5f00\u59cb\uff0c\u5230\u5411 client \u8fd4\u56de\u7ed3\u679c</li> <li>\u7136\u540e\u5c06 Request Context \u4f20\u5165 Scheduler\uff0c\u6309\u7167\u7b97\u5b50\u6811\u4f9d\u6b21\u6267\u884c\u6bcf\u4e2a\u7269\u7406\u8282\u70b9\u8ba1\u5212\u3002</li> <li>\u6bcf\u4e2a\u7269\u7406\u8282\u70b9\u8ba1\u5212\u5728 Graphd \u4e2d\u5b58\u5728\u4e00\u4e2a executor\uff0c\u5b9e\u9645\u4e0a\u91cc\u9762\u8c03\u7528\u4e86 storaged \u7684 processor\u3002</li> <li>Storaged \u7684\u6bcf\u4e2a processor \u5185\u90e8\u4e5f\u4f1a\u751f\u6210\u81ea\u5df1\u7684\u6267\u884c\u8ba1\u5212\u3002    - \u771f\u6b63\u5bf9\u6570\u636e\u7684\u64cd\u4f5c\u8ba1\u5212\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a(node)\uff1a\u4ece RocksDB \u4e2d\u83b7\u53d6\u6216\u8005\u5b58\u50a8 KV \u5bf9\uff0c\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 raft-wal \u8fdb\u884c\u96c6\u7fa4\u95f4\u7684\u6570\u636e\u540c\u6b65\uff08\u786e\u4fdd\u539f\u5b50\u6027\u548c\u4e00\u81f4\u6027\uff09\uff0c\u7136\u540e\u7528\u7ed3\u679c\u53bb\u8bbe\u7f6e Promise\uff0c\u89e6\u53d1 Future \u56de\u8c03\u8fd4\u56de\u7ed9 client \u7ed3\u679c\u3002</li> </ol>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#details","title":"Details","text":"<p>\u5b9e\u9645\u4e0a\u6bd4\u8f83\u91cd\u8981\u7684\u5c31\u662f\u4e09\u4e2a\u5b88\u62a4\u8fdb\u7a0b\uff1a\u8ba1\u7b97\u8282\u70b9 Graphd\u3001\u5143\u6570\u636e\u8282\u70b9 Metad \u548c\u5b58\u50a8\u8282\u70b9 Storaged\uff0c\u4e0b\u9762\u4ee5 Insert \u8bed\u53e5\u6267\u884c\u4e3a\u4f8b\uff0c\u8be6\u7ec6\u89e3\u91ca\u4e0b\u6574\u4e2a\u8bed\u53e5\u6267\u884c\u6d41\u7a0b\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#graphd","title":"Graphd","text":"<p>Graphd \u5927\u4f53\u4e0a\u5206\u4e3a parse\uff0cvalidate\uff0cplanner\uff0coptimize\uff0cexecute \u8fd9\u51e0\u4e2a\u9636\u6bb5\u3002\u6240\u6709\u7684 statement\u3001execplan \u4ee5\u53ca\u6700\u540e\u7684 resultset \u5305\u62ec\u539f\u59cb\u7684 Query \u8bed\u53e5\uff0c\u90fd\u5b58\u50a8\u5728 RequestContext \u4e2d\u3002</p> <ul> <li> <p>\u6784\u5efa RequestContext \u5e76\u628a Query \u8bed\u53e5\u4f20\u5165\uff0c\u6839\u636e RequestContext \u6784\u5efa Query Instance\u3002\u5f00\u542f\u6240\u6709\u7684\u5f02\u6b65\u6d41\u7a0b\u540e\uff0c\u8fd4\u56de\u7528\u6237\u4e00\u4e2a Future\u3002</p> </li> <li> <p>\u5728 Query Instance \u4e2d\u6267\u884c parse\uff0c\u5c06\u8bed\u53e5\u89e3\u6790\u6210 sentence(statement)\u3002</p> </li> <li> <p>\u5728 validate \u4e2d\u901a\u8fc7<code>validateimpl</code>\u65b9\u6cd5\u8fdb\u884c check\uff0c\u6821\u9a8c\u662f\u5426\u6ee1\u8db3 schema \u4ee5\u53ca\u662f\u5426\u6570\u636e\u672a\u8d85\u8303\u56f4\u3002</p> </li> </ul> C++<pre><code>  Status InsertVerticesValidator::validateImpl() {\n    spaceId_ = vctx_-&gt;whichSpace().id;\n    NG_RETURN_IF_ERROR(check());\n    NG_RETURN_IF_ERROR(prepareVertices());\n    return Status::OK();\n  }\n</code></pre> <ul> <li>\u901a\u8fc7 validator \u7684<code>toplan</code>\u65b9\u6cd5\u5c06 sentence \u53d8\u6210 execution plan tree\u3002</li> </ul> C++<pre><code>  Status InsertVerticesValidator::toPlan() {\n    auto doNode = InsertVertices::make(qctx_,\n                                      nullptr,\n                                      spaceId_,\n                                      std::move(vertices_),\n                                      std::move(tagPropNames_),\n                                      ifNotExists_,\n                                      ignoreExistedIndex_);\n    root_ = doNode;\n    tail_ = root_;\n    return Status::OK();\n  }\n</code></pre> <ul> <li> <p>\u5c06\u903b\u8f91\u6267\u884c\u8ba1\u5212\u6811\u4ea4\u7ed9 Optimizer \u8fdb\u884c\u4f18\u5316\uff0cnebula \u73b0\u5728\u7684\u4f18\u5316\u662f Rule-based optimization\uff0c\u6bcf\u4e2a\u6267\u884c\u8ba1\u5212\u9700\u8981\u904d\u5386\u6240\u6709\u7684 rules\uff0c\u5f97\u5230\u6700\u4f18\u7684\u7269\u7406\u6267\u884c\u8ba1\u5212\u3002</p> </li> <li> <p>\u7136\u540e\u5c06\u6574\u4e2a\u7269\u7406\u8ba1\u5212\u4ea4\u7ed9 Scheduler \u8fdb\u884c\u6267\u884c\uff0c\u5728 Scheduler \u4e2d\u6309\u7167\u8ba1\u5212\u6811\u7684\u7236\u5b50\u5173\u7cfb\uff0c\u4ece\u4e0b\u4e4b\u4e0a\u4f9d\u6b64\u6267\u884c\u8ba1\u5212\uff0c\u6240\u6709\u7684\u8ba1\u5212\u90fd\u662f\u7528 Future \u5f02\u6b65\u6267\u884c\u3002</p> </li> <li> <p>\u9996\u5148\u5148\u6839\u636e Logical Plan \u6784\u9020\u51fa Physical Plan(Execution Plan)</p> C++<pre><code>Executor *Executor::makeExecutor(const PlanNode *node,\n                             QueryContext *qctx,\n                             std::unordered_map&lt;int64_t, Executor *&gt; *visited)\n</code></pre> </li> <li> <p>\u5bf9 Executor \u8fdb\u884c\u8c03\u5ea6\uff0cparent plan \u8282\u70b9\u9700\u8981\u6240\u6709\u7684 children plan \u8282\u70b9\u90fd\u6267\u884c\u5b8c\u540e\u624d\u5f00\u59cb\u6267\u884c\u3002</p> </li> </ul> C++<pre><code>  folly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::scheduleExecutor(\n  std::vector&lt;folly::Future&lt;Status&gt;&gt;&amp;&amp; futures, Executor* exe, folly::Executor* runner) const {\n  switch (exe-&gt;node()-&gt;kind()) {\n    // ...\n    case PlanNode::Kind::kArgument: {\n      return runExecutor(std::move(futures), exe, runner);\n    }\n    default: {\n      if (exe-&gt;depends().empty()) {\n        return runLeafExecutor(exe, runner);\n      } else {\n        return runExecutor(std::move(futures), exe, runner);\n      }\n    }\n  }\n  }\n  folly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::runExecutor(\n    std::vector&lt;folly::Future&lt;Status&gt;&gt;&amp;&amp; futures, Executor* exe, folly::Executor* runner) const {\n  return folly::collect(futures).via(runner).thenValue(\n      [exe, this](auto&amp;&amp; t) mutable -&gt; folly::Future&lt;Status&gt; {\n        NG_RETURN_IF_ERROR(checkStatus(std::move(t)));\n        // Execute in current thread.\n        return execute(exe);\n      });\n  }\n\n  folly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::runLeafExecutor(Executor* exe,\n                                                                    folly::Executor* runner) const {\n    return std::move(execute(exe)).via(runner);\n  }\n</code></pre> <ul> <li>\u5728 runExecutor \u65b9\u6cd5\u4e2d\u4f1a\u8c03\u7528 graphd \u4e2d\u7684 executor\uff0c\u8fdb\u884c\u7269\u7406\u8ba1\u5212\u7684\u6267\u884c\u3002\u91cc\u9762\u6d89\u53ca\u5230\u5b58\u50a8\u5c42\u7684\u5185\u5bb9\u65f6\u4f1a\u901a\u8fc7 RPC \u5411 Storaged \u8bf7\u6c42\u670d\u52a1\u3002</li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#storaged","title":"Storaged","text":"<p>Storaged \u63a5\u6536\u5230 graphd \u53d1\u9001\u7684 executor \u8bf7\u6c42\uff0c\u542f\u52a8\u5bf9\u5e94\u7684 Processor\uff0c\u6267\u884c<code>process</code>\u65b9\u6cd5\uff0c\u5b9e\u9645\u4e0a\u6267\u884c<code>doProcess</code>\u65b9\u6cd5\u3002</p> <p></p> <ul> <li> <p>\u5bf9\u4e8e\u67e5\u8be2\u8bed\u53e5\u6765\u8bf4\uff0c\u5b9e\u9645\u4e0a <code>doProcess</code> \u65b9\u6cd5\u4e5f\u4f1a\u751f\u6210 Storage \u7684\u6267\u884c\u8ba1\u5212\uff0c\u5bf9 RocksDB \u8fdb\u884c\u64cd\u4f5c\uff0c\u8fd9\u91cc\u5bf9\u4e8e Insert \u8bed\u53e5\u6765\u8bf4\u5c31\u662f\u7b80\u5355\u7684\u6267\u884c <code>doPut</code> \u64cd\u4f5c\uff0c\u901a\u8fc7 raft-wal \u5411 RockDB \u4e2d\u5199\u5165\u6570\u636e</p> </li> <li> <p>\u5728\u6267\u884c\u5b8c\u903b\u8f91\u540e\uff0c\u5c06\u6240\u6709\u7684\u66f4\u6539\u5199\u5165\u96c6\u7fa4\uff0c\u6700\u540e\u5728\u56de\u8c03\u4e2d\u6267\u884c<code>handleAsync</code>\u65b9\u6cd5\uff0c\u5b9e\u9645\u4e0a\u662f\u6267\u884c<code>onFinished</code>\u65b9\u6cd5\uff0c<code>onFinished</code>\u65b9\u6cd5\u4e2d\u8bbe\u7f6e promise \u7684 value \u4e3a RESP\uff0cRESP \u4e2d\u5305\u542b\u67e5\u8be2\u7684\u7ed3\u679c\uff0c\u4e00\u5c42\u5c42\u8fd4\u56de\u76f4\u5230\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</p> </li> </ul> C++<pre><code>template &lt;typename RESP&gt;\nvoid BaseProcessor&lt;RESP&gt;::doPut(GraphSpaceID spaceId,\n                                PartitionID partId,\n                                std::vector&lt;kvstore::KV&gt;&amp;&amp; data) {\n  this-&gt;env_-&gt;kvstore_-&gt;asyncMultiPut(\n      spaceId, partId, std::move(data), [spaceId, partId, this](nebula::cpp2::ErrorCode code) {\n        handleAsync(spaceId, partId, code);\n      });\n}\n\ntemplate &lt;typename RESP&gt;\nvoid BaseProcessor&lt;RESP&gt;::handleAsync(GraphSpaceID spaceId,\n                                    PartitionID partId,\n                                    nebula::cpp2::ErrorCode code) {\n  bool finished = false;\n  {\n    std::lock_guard&lt;std::mutex&gt; lg(this-&gt;lock_);\n    handleErrorCode(code, spaceId, partId);\n    this-&gt;callingNum_--;\n    if (this-&gt;callingNum_ == 0) {\n      finished = true;\n    }\n  }\n  if (finished) {\n    this-&gt;onFinished();\n  }\n}\n\nvirtual void onFinished() {\n  memory::MemoryCheckOffGuard guard;\n  this-&gt;result_.failed_parts_ref() = this-&gt;codes_;\n  this-&gt;resp_.result_ref() = std::move(this-&gt;result_);\n  this-&gt;promise_.setValue(std::move(this-&gt;resp_));\n  delete this;\n}\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#doput","title":"doPut","text":"<ul> <li>\u5199\u5165\u66f4\u6539\u662f doPut \u64cd\u4f5c\uff0c\u8be5\u64cd\u4f5c\u5b9e\u9645\u4e0a\u662f\u5bf9 raft \u63d0\u4ea4\u65e5\u5fd7\uff0c\u9a71\u52a8 raft \u72b6\u6001\u673a\u5c06\u8be5\u64cd\u4f5c\u540c\u6b65\u5230\u96c6\u7fa4\u4e2d\u3002</li> </ul> <ul> <li>Raft \u7684\u65e5\u5fd7\u590d\u5236\u8fc7\u7a0b\u5927\u81f4\u5206\u4e3a\u4e09\u4e2a\u6b65\u9aa4\uff1a</li> </ul> <ol> <li>Leader\uff1a\u9996\u5148\u68c0\u67e5\u81ea\u8eab\u72b6\u6001\uff0c\u7136\u540e\u5148\u5199\u5165\u672c\u5730 WAL\uff0c\u7136\u540e\u5c06\u6240\u6709 log \u590d\u5236\u5230\u6240\u6709 follower</li> <li>Follower\uff1aFollowers \u4e5f\u4f1a\u5c06\u65b0\u65e5\u5fd7\u5199\u5165\u81ea\u5df1\u7684 WAL\uff0c\u5e76\u5411 Leader \u56de\u590d \u201c\u6210\u529f\u201d\u3002</li> <li>Leader\uff1a\u5305\u62ec\u81ea\u5df1\u5728\u5185\u7684\u5927\u591a\u6570\uff08Majority\uff09 \u8282\u70b9\u90fd\u5df2\u6210\u529f\u5c06\u8be5\u65e5\u5fd7\u5199\u5165\u5176 WAL\uff0cLeader \u5c31\u4f1a\u8ba4\u4e3a\u8fd9\u6761\u65e5\u5fd7\u662f \u201c\u5df2\u63d0\u4ea4\u201d (Committed) \u7684\u3002Leader \u5c31\u53ef\u4ee5\u5b89\u5168\u5730\u5c06\u8be5\u65e5\u5fd7\uff08\u5373 KV \u64cd\u4f5c\uff09\u5e94\u7528\u5230\u5176\u72b6\u6001\u673a\uff08\u5373\u771f\u6b63\u6267\u884c multiPut\uff09</li> </ol> C++<pre><code>void RaftPart::appendLogsInternal(AppendLogsIterator iter, TermID termId) {\n  do {\n    // Process 1\n  // Step 1: Write Local WAL\n    {\n      SCOPED_TIMER(\n      if (!wal_-&gt;appendLogs(iter)) {\n        break;\n      }\n    }\n  } while (false);\n\n\n  // Step 2: Replicate to followers\n  auto* eb = ioThreadPool_-&gt;getEventBase();\n  replicateLogs(eb, std::move(iter), currTerm, lastId, committed, prevLogTerm, prevLogId);\n  return;\n}\n\n// process 2 &amp; 3\nvoid RaftPart::replicateLogs(folly::EventBase* eb,\n                             AppendLogsIterator iter,\n                             TermID currTerm,\n                             LogID lastLogId,\n                             LogID committedId,\n                             TermID prevLogTerm,\n                             LogID prevLogId) {\n  collectNSucceeded(gen::from(hosts) |\n                        gen::map([self = shared_from_this(),\n                                  eb,\n                                  currTerm,\n                                  lastLogId,\n                                  prevLogId,\n                                  prevLogTerm,\n                                  committedId](std::shared_ptr&lt;Host&gt; hostPtr) {\n                          return via(eb, [=]() -&gt; Future&lt;cpp2::AppendLogResponse&gt; {\n                            // \u5411\u6240\u6709 follower \u53d1\u9001 AppendLogs \u8bf7\u6c42\n                            return hostPtr-&gt;appendLogs(\n                                eb, currTerm, lastLogId, committedId, prevLogTerm, prevLogId);\n                          });\n                        }) |\n                        gen::as&lt;std::vector&gt;(),\n                    quorum_,\n                    [hosts](size_t index, cpp2::AppendLogResponse&amp; resp) {\n      // Process 2: \u6536\u96c6\u5230\u4e86\u534a\u6570\u8282\u70b9\u901a\u8fc7\n                      return resp.get_error_code() == nebula::cpp2::ErrorCode::SUCCEEDED &amp;&amp;\n                             !hosts[index]-&gt;isLearner();\n                    })\n      .via(executor_.get())\n      .then([self = shared_from_this(),\n             eb,\n             it = std::move(iter),\n             currTerm,\n             lastLogId,\n             committedId,\n             prevLogId,\n             prevLogTerm,\n             pHosts = std::move(hosts),\n             beforeAppendLogUs](folly::Try&lt;AppendLogResponses&gt;&amp;&amp; result) mutable {\n        // Process 3: followers \u771f\u6b63\u5f00\u59cb\u8fdb\u884c\u5199\u5165\n        self-&gt;processAppendLogResponses(*result,\n                                        eb,\n                                        std::move(it),\n                                        currTerm,\n                                        lastLogId,\n                                        committedId,\n                                        prevLogTerm,\n                                        prevLogId,\n                                        std::move(pHosts));\n        return *result;\n      });\n}\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#metad","title":"Metad","text":"<p>\u4e00\u822c Metad \u4e3b\u8981\u53c2\u4e0e DDL \u7684\u8bed\u53e5\u6267\u884c\u6d41\u7a0b\uff0c\u8d1f\u8d23\u5b58\u50a8 Tag/Edge \u7684 Schema \u4ee5\u53ca\u4e00\u4e9b\u7d22\u5f15\u7684\u5143\u6570\u636e\u4fe1\u606f\u3002\u7ba1\u7406 ReBuild Index \u7b49\u9700\u8981\u4e0e Storaged \u540c\u6b65\u7684 Job</p> <p></p>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#our-work","title":"Our Work","text":"<p>\u6211\u4eec\u5df2\u7ecf\u68b3\u7406\u4e86\u4e00\u6761 Cypher \u8bed\u53e5\u4ece\u8f93\u5165\u5230\u6267\u884c\u7684\u5b8c\u6574\u6d41\u7a0b\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u5f00\u59cb\u5bf9 Nebula Graph \u8fdb\u884c\u6539\u52a8\uff0c\u652f\u6301\u5411\u91cf\u7c7b\u578b\u4ee5\u53ca\u5411\u91cf\u5b58\u50a8\u3002</p> <p>Nebula Graph \u7684\u5b9e\u9645\u7c7b\u578b\u5b58\u50a8\u662f\u4ee5 KV \u5bf9\u7684\u5f62\u5f0f\u5b58\u50a8\u5728 RocksDB \u4e2d\u7684\uff0cKey \u6709\u81ea\u5df1\u7279\u6b8a\u7684\u7ed3\u6784\uff0cValue \u5219\u662f\u5c5e\u6027\u503c\u7684\u4e8c\u8fdb\u5236\u5e8f\u5217\u5316\u7ed3\u679c\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u505a\u4e24\u65b9\u9762\u7684\u5de5\u4f5c\uff1a</p> <ol> <li>\u8bbe\u8ba1\u5411\u91cf\u7c7b\u578b (Vector Data Type)\uff1a\u5b9e\u73b0\u5411\u91cf\u6570\u636e\u7c7b\u578b\u548c\u5c5e\u6027\u3001\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316</li> <li>\u8bbe\u8ba1\u5411\u91cf\u5b58\u50a8 (Vector Storage)\uff1a\u4fee\u6539\u5b58\u50a8\u5f15\u64ce\uff0c\u652f\u6301\u5411\u91cf\u5c5e\u6027\u7684\u5355\u72ec\u5b58\u50a8\u548c\u8bfb\u53d6\uff0c\u8bbe\u8ba1\u5411\u91cf\u5c5e\u6027\u7684 Key \u548c Value \u683c\u5f0f <p>\u4e3a\u4e86\u65b9\u4fbf\u540e\u9762\u7684\u5411\u91cf\u7d22\u5f15\u8bbe\u8ba1\uff0c\u6211\u4eec\u5c06\u5411\u91cf\u5c5e\u6027\u5355\u72ec\u5b58\u50a8\u5728\u4e00\u4e2a Column Family \u4e2d\uff0c\u5176\u4ed6\u5c5e\u6027\u5b58\u50a8\u5728\u9ed8\u8ba4\u7684 Column Family \u4e2d\u3002</p> </li> </ol>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#_1","title":"\u5411\u91cf\u7c7b\u578b\u8bbe\u8ba1","text":"<p>Nebula Graph \u4e2d\u5df2\u7ecf\u6709\u4e86\u652f\u6301\u591a Value \u7684\u6570\u636e\u7c7b\u578b List\uff0c\u4f46\u662f\u6211\u4eec\u4ecd\u7136\u9700\u8981\u8bbe\u8ba1\u65b0\u7684 Vector \u7c7b\u578b\u3002 Why?</p> <p>\u5411\u91cf\u4e0e\u6807\u51c6\u4e2d\u5df2\u652f\u6301\u7684\u6570\u7ec4\u5728\u4ee5\u4e0b\u65b9\u9762\u6709\u6240\u4e0d\u540c\uff1a</p> <ul> <li>\u6570\u7ec4\u7c7b\u578b\u662f\u4e00\u79cd\u96c6\u5408\u7c7b\u578b\u3002\u6570\u7ec4\u662f\u503c\u7684\u96c6\u5408\u3002\u8fd9\u4e9b\u503c\u5728\u6570\u7ec4\u4e4b\u5916\u53ef\u80fd\u5177\u6709\u610f\u4e49\u3002\u4f8b\u5982\uff0c\u5728\u4e00\u4e2a\u7535\u8bdd\u53f7\u7801\u6570\u7ec4\u4e2d\uff0c\u6bcf\u4e2a\u7535\u8bdd\u53f7\u7801\u5728\u6570\u7ec4\u4e4b\u5916\u90fd\u6709\u5176\u610f\u4e49\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u5411\u91cf\u7684\u5355\u4e2a\u5750\u6807\u672c\u8eab\u5728\u5411\u91cf\u4e4b\u5916\u6ca1\u6709\u592a\u591a\u610f\u4e49\u3002</li> <li>\u4e00\u4e2a\u5411\u91cf\u7c7b\u578b\u4e2d\u7684\u6240\u6709\u5411\u91cf\u90fd\u5177\u6709\u76f8\u540c\u7684\u7ef4\u5ea6 \\(n\\)\u3002\\(1\\) \u548c \\(n\\) \u4e4b\u95f4\u7684\u6bcf\u4e2a\u5750\u6807\u90fd\u662f\u975e\u7a7a\u503c\u3002\u8fd9\u4e0e\u6570\u7ec4\u7c7b\u578b\u5f62\u6210\u5bf9\u6bd4\uff0c\u6570\u7ec4\u7c7b\u578b\u901a\u8fc7\u58f0\u660e\u7684\u6700\u5927\u57fa\u6570 \\(n\\) \u6765\u652f\u6301\u53ef\u53d8\u7684\u57fa\u6570\uff0c\u5e76\u4e14\u5141\u8bb8\u6bcf\u4e2a\u5143\u7d20\u4e3a\u7a7a\u503c\u3002</li> <li>\u5411\u91cf\u7c7b\u578b\u9664\u4e86<code>==</code>\u548c<code>!=</code>\uff0c\u5176\u4ed6\u7684\u7b97\u6570\u64cd\u4f5c\u5747\u4e0d\u5e94\u8be5\u652f\u6301</li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#vector-value-type","title":"Vector Value Type","text":"<p>Vector \u7c7b\u578b\u4e3b\u8981\u7531\u4e00\u4e2a <code>std::vector&lt;float&gt;</code> \u7ec4\u6210</p> <p></p>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#vector-property-type","title":"Vector Property Type","text":"<ul> <li>\u65b0\u589e\u5c5e\u6027\u7c7b\u578b\uff0c\u5176\u503c\u7c7b\u578b\u4e3a VECTOR (\u5411\u91cf)\u3002</li> <li>\u5728 common.thrift \u4e2d\u4e3a\u5411\u91cf (VECTOR) \u503c\u7c7b\u578b\u6dfb\u52a0\u65b0\u6a21\u5f0f\u3002</li> </ul> Thrift<pre><code>// Vector type\nstruct Vector {\n    1: list&lt;double&gt; values;\n} (cpp.type = \"nebula::Vector\")\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#_2","title":"\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316","text":"<p>\u4e3a Vector \u7c7b\u578b\u5b9e\u73b0\u4e0b\u9762\u7684\u63a5\u53e3\u5373\u53ef</p> C++<pre><code>template &lt;class Protocol&gt;\nuint32_t Cpp2Ops&lt;nebula::Vector&gt;::write(Protocol* proto, nebula::Vector const* obj;\n\ntemplate &lt;class Protocol&gt;\nvoid Cpp2Ops&lt;nebula::Vector&gt;::read(Protocol* proto, nebula::Vector* obj);\n\ntemplate &lt;class Protocol&gt;\nuint32_t Cpp2Ops&lt;nebula::Vector&gt;::serializedSize(Protocol const* proto, nebula::Vector const* obj);\n\ntemplate &lt;class Protocol&gt;\nuint32_t Cpp2Ops&lt;nebula::Vector&gt;::serializedSizeZC(Protocol const* proto,\n                                                   nebula::Vector const* obj);\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#_3","title":"\u5411\u91cf\u5b58\u50a8\u8bbe\u8ba1","text":"<p>\u6211\u4eec\u7684\u76ee\u6807\u662f\u5c06\u5411\u91cf\u5c5e\u6027\u5b58\u50a8\u5728 Nebula Graph \u7684\u5b58\u50a8\u5f15\u64ce\u4e2d\uff0cNebula Graph \u9ed8\u8ba4\u7684\u5b58\u50a8\u5f15\u64ce\u662f RocksDB\uff0c\u540c\u65f6\u9700\u8981\u652f\u6301\u4e00\u4e2a Tag/Edge \u4e0a\u540c\u65f6\u5b58\u5728\u591a\u4e2a\u5411\u91cf\u5c5e\u6027\u3002</p> <p>\u6211\u4eec\u7684\u8bbe\u8ba1\u662f\u5c06\u5411\u91cf\u5c5e\u6027\u548c\u5176\u4ed6\u5c5e\u6027\u5206\u5f00\u5b58\u50a8\uff0c\u65b9\u4fbf\u540e\u7eed\u521b\u5efa\u5411\u91cf\u7d22\u5f15\u3002\u90a3\u4e48\u6211\u4eec\u7684\u5de5\u4f5c\u5c31\u53d8\u6210\u4e86\uff1a</p> <ul> <li>\u4fee\u6539\u5b58\u50a8\u5f15\u64ce\uff0c\u652f\u6301\u5411\u91cf\u5c5e\u6027\u7684\u5355\u72ec\u5b58\u50a8\u548c\u8bfb\u53d6(\u5f53\u524d Nebula Graph \u53ea\u652f\u6301 RocksDB \u7684\u9ed8\u8ba4 Column Family)</li> <li>\u8bbe\u8ba1\u5411\u91cf\u5c5e\u6027\u7684 Key \u548c Value \u683c\u5f0f</li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#why","title":"Why?","text":"<p>\u5728 Nebula Graph \u9ed8\u8ba4\u8bbe\u8ba1\u4e2d\uff0c\u6240\u6709\u5c5e\u6027\uff08\u5305\u62ec\u6807\u91cf\u5c5e\u6027\u3001\u6587\u672c\u5c5e\u6027\u3001\u5411\u91cf\u5c5e\u6027\uff09\u90fd\u5b58\u653e\u5728 Default Column Family \u91cc\uff0c\u5373\uff1a</p> C++<pre><code>Key = {tag_id, vertex_id, property_name}\nValue = {encoded property value}\n</code></pre> <p>\u4f46\u8fd9\u5bf9\u5411\u91cf\u5c5e\u6027\u6765\u8bf4\u6709\u51e0\u4e2a\u95ee\u9898\uff1a</p> <ul> <li> <p>\u6570\u636e\u81a8\u80c0\uff1a\u5411\u91cf\u6570\u636e\u901a\u5e38\u662f\u9ad8\u7ef4\uff08\u5982 512D \u6216 1024D\uff09\uff0c\u5355\u6761\u8bb0\u5f55\u4f53\u79ef\u5927\uff0c\u5bb9\u6613\u9020\u6210 LSM-tree \u5199\u653e\u5927\u548c Compaction \u538b\u529b\uff1b</p> </li> <li> <p>\u8bbf\u95ee\u6a21\u5f0f\u4e0d\u540c\uff1a\u666e\u901a\u5c5e\u6027\u591a\u4e3a\u70b9\u67e5\u6216\u6761\u4ef6\u8fc7\u6ee4\uff0c\u800c\u5411\u91cf\u5c5e\u6027\u8bfb\u53d6\u901a\u5e38\u662f\u6279\u91cf\u8bfb\u53d6\u6216\u626b\u63cf\u5f0f\uff08\u6784\u5efa\u7d22\u5f15\u65f6\u9700\u8981\u8bfb\u6240\u6709\u5411\u91cf\uff09\uff1b</p> </li> <li> <p>Scan \u6548\u7387\u4f4e\uff1a\u5411\u91cf\u7d22\u5f15\u6784\u5efa\u65f6\u9700\u8981\u626b\u63cf\u6240\u6709\u5411\u91cf\u6570\u636e\uff0c\u82e5\u4e0e\u666e\u901a\u5c5e\u6027\u6df7\u5b58\uff0c\u8bfb\u53d6\u65f6\u4f1a\u5e26\u6765\u5927\u91cf\u65e0\u7528\u6570\u636e\u7684 IO \u5f00\u9500\u548c\u89e3\u6790\u5f00\u9500</p> </li> </ul> <p>\u6240\u4ee5\u6211\u4eec\u51b3\u5b9a\u5c06\u5411\u91cf\u5c5e\u6027\u5355\u72ec\u5b58\u50a8\u5728\u4e00\u4e2a Column Family \u91cc\uff0c\u5176\u4ed6\u5c5e\u6027\u7ee7\u7eed\u5b58\u50a8\u5728 Default Column Family \u91cc\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#_4","title":"\u5b58\u50a8\u5f15\u64ce\u4fee\u6539","text":"<p>\u6240\u6709\u7684\u5c5e\u6027\u90fd\u662f\u5b58\u5728 RocksDB \u4e2d\u7684 KV \u5bf9\u4e2d\uff0c\u4e00\u822c\u5c5e\u6027\u7684 Key \u7531 <code>partId + tagId/edgeId + vertexId + propId</code> \u7ec4\u6210\uff0cValue \u5219\u662f\u5c5e\u6027\u503c\u7684\u4e8c\u8fdb\u5236\u5e8f\u5217\u5316\u7ed3\u679c\u3002</p> <p>\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 RocksDB \u7684 Column Family \u529f\u80fd\uff0c\u5c06\u5411\u91cf\u5c5e\u6027\u5355\u72ec\u5b58\u50a8\u5728\u4e00\u4e2a Column Family \u4e2d\uff0c\u5176\u4ed6\u5c5e\u6027\u5b58\u50a8\u5728\u9ed8\u8ba4\u7684 Column Family \u4e2d\u3002</p> <p>\u8fd9\u91cc\u7684 ID-VID Column Family \u662f\u540e\u7eed\u521b\u5efa\u5411\u91cf\u7d22\u5f15\u65f6\u9700\u8981\u7684\uff0c\u8fd9\u91cc\u5148\u4e0d\u8be6\u7ec6\u4ecb\u7ecd\u3002</p> <p></p> <p> \u6709\u8da3\u7684\u662f\uff0cRockDB \u652f\u6301\u591a Column Family \u9700\u8981\u5148\u4f7f\u7528\u9ed8\u8ba4\u5217\u65cf\u6253\u5f00 RocksDB\uff0c\u7136\u540e\u521b\u5efa\u5176\u4ed6\u5217\u65cf\u5e76\u83b7\u53d6\u8fd9\u4e9b\u5217\u65cf\u7684\u53e5\u67c4\uff08CF handles\uff09\u3002\u63a5\u7740\u5173\u95ed\u6570\u636e\u5e93\uff0c\u518d\u4f7f\u7528\u591a\u4e2a\u5217\u65cf\u53e5\u67c4\u91cd\u65b0\u6253\u5f00\u8be5\u6570\u636e\u5e93\u3002</p> C++<pre><code>// We need first open the db with default column family, then create the other column families.\n// Last we reopen the db with all column families.\nrocksdb::Options singleCFOptions(dbOptions, cfDescriptors[0].options);\ninitRocksdbOptions(singleCFOptions, spaceId, vIdLen);\nstatus = rocksdb::DB::Open(singleCFOptions, path, &amp;db);\n\nsize_t cfCount = cfDescriptors.size();\nfor (size_t i = 0; i &lt; cfCount; ++i) {\n  if (cfDescriptors[i].name == NebulaKeyUtils::kDefaultColumnFamilyName) {\n    continue;\n  }\n  rocksdb::ColumnFamilyHandle* handle = nullptr;\n  status = db-&gt;CreateColumnFamily(cfDescriptors[i].options, cfDescriptors[i].name, &amp;handle);\n  if (!status.ok()) {\n    LOG(FATAL) &lt;&lt; \"Failed to create column family \" &lt;&lt; cfDescriptors[i].name &lt;&lt; \": \"\n                &lt;&lt; status.ToString();\n  }\n}\ndelete db;\ndb = nullptr;\ncfHandles_.clear();\nstatus = rocksdb::DB::Open(dbOptions, path, cfDescriptors, &amp;cfHandles_, &amp;db);\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/%E4%B8%8A%E7%AF%87%EF%BC%9A%E5%88%9D%E8%AF%86%20Nebula%20Graph%20%E2%80%94%E2%80%94%20%E5%90%91%E9%87%8F%E7%B1%BB%E5%9E%8B%E6%94%AF%E6%8C%81/#key-value","title":"\u5411\u91cf Key \u548c Value \u683c\u5f0f","text":"<p>\u6211\u4eec\u8bbe\u8ba1\u5411\u91cf\u5c5e\u6027\u7684 Key \u683c\u5f0f\u4e3a <code>type + partId + tagId + vertexId + propId</code>\uff0c\u53ef\u4ee5\u533a\u5206\u5355\u4e2a Tag \u4e2d\u7684\u5411\u91cf\u5c5e\u6027\u3002Value \u5219\u662f vector data type \u7684\u4e8c\u8fdb\u5236\u5e8f\u5217\u5316\u7ed3\u679c\u3002</p> <p>\u8fd9\u6837\u7684\u8bbe\u8ba1\u53ef\u4ee5\u652f\u6301\u4e00\u4e2a Tag \u4e2d\u6709\u591a\u4e2a vector \u5c5e\u6027 \u4e0d\u540c\u7684 tag \u6216\u5c5e\u6027\u53ef\u4ee5\u7528\u4e0d\u540c\u7684 propId \u533a\u5206\uff0c\u4e0d\u4f1a\u76f8\u4e92\u5f71\u54cd</p> Bash<pre><code>VectorTagKey: () \u91cc\u9762\u662f\u5b57\u8282\u6570\ntype(1) + partId(3) + vertexId(*) + tagId(4) + propId(4)\n\nVectroEdgeKey:\ntype(1) + partId(3) + srcId(*) + edgeType(4) + edgeRank(8) + dstId(*) + propId(4) +placeHolder(1)\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/","title":"Create Ann Index","text":""},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#create-ann-index","title":"Create Ann Index","text":"<p> \u7ea6 752 \u4e2a\u5b57  106 \u884c\u4ee3\u7801  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#ann-index-manager","title":"Ann Index Manager","text":"<ul> <li>\u5728 Storage Daemon \u4e2d\u8bbe\u8ba1\u4e00\u4e2a<code>VectorIndexManager</code>\u5355\u4f8b\u5bf9\u6574\u4e2a Storaged \u4e2d\u7684 Ann Index \u8fdb\u884c\u7ba1\u7406\u3002</li> <li>Ann Index \u7684\u751f\u547d\u5468\u671f\uff1a</li> <li>\u521b\u5efa\uff1a\u901a\u8fc7 <code>CreateTagAnnIndex</code> \u8bf7\u6c42\u521b\u5efa Ann Index\u3002     &gt; \u9664\u975e\u5220\u9664\uff0c\u5426\u5219\u4f1a\u4e00\u76f4\u5728\u5185\u5b58\u4e2d\u7ef4\u62a4\uff0c\u5728\u9000\u51fa\u65f6\u9700\u8981\u6301\u4e45\u5316\u5230\u78c1\u76d8\uff0c\u540c\u65f6\u91cd\u542f\u7cfb\u7edf\u540e\u9700\u8981\u4ece\u78c1\u76d8\u4e2d\u52a0\u8f7d\u5df2\u7ecf\u5b58\u5728\u7684 Ann Index\u3002</li> <li>\u4f7f\u7528\uff1a\u5728\u67e5\u8be2\u65f6\u4f7f\u7528 Ann Index \u8fdb\u884c\u52a0\u901f\u3002</li> <li>\u5220\u9664\uff1a\u901a\u8fc7 <code>DropTagAnnIndex</code> \u8bf7\u6c42\u5220\u9664 Ann Index\u3002</li> <li>\u66f4\u65b0\uff1a\u901a\u8fc7 <code>UpdateTagAnnIndex</code> \u8bf7\u6c42\u66f4\u65b0 Ann Index\u3002</li> </ul> C++<pre><code>class VectorIndexManager final {\n public:\n  static VectorIndexManager&amp; getInstance();\n  // Initialize the manager with necessary dependencies\n  Status init(meta::IndexManager* indexManager, std::string annIndexPath);\n  // Start the manager (background tasks, cleanup threads, etc.)\n  Status start();\n  // Stop the manager gracefully\n  Status stop();\n  // Wait until the manager stops (similar to StorageServer::waitUntilStop)\n  void waitUntilStop();\n  // Notify the manager to stop (used for signal handling)\n  void notifyStop();\n  // Create a vector index for a specific partition and index ID\n  Status createOrUpdateIndex(GraphSpaceID spaceId,\n                             PartitionID partitionId,\n                             IndexID indexId,\n                             const std::shared_ptr&lt;meta::cpp2::AnnIndexItem&gt;&amp; indexItem);\n  // Get an existing vector index\n  StatusOr&lt;std::shared_ptr&lt;AnnIndex&gt;&gt; getIndex(GraphSpaceID spaceId,\n                                               PartitionID partitionId,\n                                               IndexID indexId);\n  // Remove a vector index\n  Status removeIndex(GraphSpaceID spaceId, PartitionID partitionId, IndexID indexId);\n  // Get all managed indexes for a partition\n  std::vector&lt;std::shared_ptr&lt;AnnIndex&gt;&gt; getIndexesByPartition(GraphSpaceID spaceId,\n                                                               PartitionID partitionId);\n  // Check if an index exists\n  bool hasIndex(GraphSpaceID spaceId, PartitionID partitionId, IndexID indexId) const;\n  // Rebuild an index (called during BuildVectorIndexTask)\n  Status rebuildIndex(GraphSpaceID spaceId,\n                      PartitionID partitionId,\n                      IndexID indexId,\n                      const std::shared_ptr&lt;meta::cpp2::AnnIndexItem&gt;&amp; indexItem);\n};\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#storage-vectorindexmanager","title":"Storage \u4e2d VectorIndexManager \u7684\u4f20\u9012","text":"<ol> <li>\u5728 <code>StorageServer::start()</code> \u65b9\u6cd5\u521b\u5efa\u4e86 StorageEnv \u5b9e\u4f8b\u5e76\u5c06 env \u4f20\u9012\u7ed9 AdminTaskManager</li> <li>\u521d\u59cb\u5316 Ann Index Manager \u5b9e\u4f8b</li> <li>\u7136\u540e\u5c06 Ann Index Manager \u5b9e\u4f8b\u4e0e StorageEnv \u5173\u8054</li> <li>StorageEnv \u7ed3\u6784\u5b9a\u4e49    - \u6211\u4eec\u589e\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684\u6210\u5458\u53d8\u91cf <code>annIndexMan_</code>\uff0c\u7528\u4e8e\u7ba1\u7406 ANN \u7d22\u5f15\u3002    - \u9700\u8981\u5728 Storaged \u542f\u52a8\u65f6\u521d\u59cb\u5316</li> </ol> C++<pre><code>// StorageServer \u542f\u52a8\nvoid StorageServer::start(){\n  // \u521d\u59cb\u5316\u5404\u4e2a\u7ec4\u4ef6\n  schemaMan_ = meta::ServerBasedSchemaManager::create(metaClient_.get());\n  indexMan_ = meta::ServerBasedIndexManager::create(metaClient_.get());\n  kvstore_ = getStoreInstance();\n\n  // \u521b\u5efa StorageEnv \u5e76\u8bbe\u7f6e\u5404\u4e2a\u7ec4\u4ef6\n  env_ = std::make_unique&lt;storage::StorageEnv&gt;();\n  env_-&gt;kvstore_ = kvstore_.get();\n  env_-&gt;indexMan_ = indexMan_.get();\n  env_-&gt;schemaMan_ = schemaMan_.get();\n  env_-&gt;rebuildIndexGuard_ = std::make_unique&lt;IndexGuard&gt;();\n  env_-&gt;metaClient_ = metaClient_.get();\n  env_-&gt;verticesML_ = std::make_unique&lt;VerticesMemLock&gt;();\n  env_-&gt;edgesML_ = std::make_unique&lt;EdgesMemLock&gt;();\n  env_-&gt;adminStore_ = getAdminStoreInstance();\n  env_-&gt;adminSeqId_ = getAdminStoreSeqId();\n}\n\n// VectorIndexManager \u542f\u52a8\nvectorIndexMgr = std::make_unique&lt;VectorIndexManager&gt;();\nvectorIndexMgr-&gt;init(storageServer-&gt;getIndexMgr());\n\n// StorageServer \u8bbe\u7f6e ANN \u7d22\u5f15\u7ba1\u7406\u5668\nstorageServer-&gt;setEnvAnnIndexMgr(vectorIndexMgr.get());\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#ann-index-interface","title":"Ann Index Interface","text":""},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#ann-index-item","title":"Ann Index Item","text":"<ul> <li> <p>\u901a\u7528\u7684 Index Item \u662f\u5bf9\u5355\u4e2a Schema \u7684\u591a\u4e2a field \u7684\u7d22\u5f15\u5b9a\u4e49\uff0c\u540c\u65f6\u7d22\u5f15\u53c2\u6570\u53ea\u6709<code>s2_max_level</code>\u548c<code>s2_max_cells</code>\uff0c\u4e0d\u80fd\u6ee1\u8db3 Ann Index \u5bf9\u591a\u4e2a Schema \u540c\u540d\u5c5e\u6027\u8fdb\u884c\u7d22\u5f15\u521b\u5efa\u7684\u8981\u6c42\uff0c\u6240\u4ee5\u6211\u4eec\u8bbe\u8ba1\u4e86\u65b0\u7684 Ann Index Item\u3002</p> </li> <li> <p>Ann Index Item \u662f\u5bf9\u591a\u4e2a Schema \u7684\u540c\u540d\u5c5e\u6027\u8fdb\u884c\u7d22\u5f15\u521b\u5efa\u7684\u5b9a\u4e49\uff0c\u5305\u542b\u4e86\u6240\u6709\u9700\u8981\u7d22\u5f15\u7684 Schema \u7684\u4fe1\u606f\u3002\u540c\u65f6\u901a\u8fc7\u4e00\u4e2a<code>list&lt;binary&gt;</code>\u6765\u5b58\u50a8 ann index \u521b\u5efa\u7684\u53c2\u6570\u3002</p> </li> </ul> C++<pre><code>ann index params:\n[IVF/*ann type*/, 128 /*dim*/, L2/*metric type*/, 3/*nlist*/, 3/*train size*/]\n[HNSW/*ann type*/, 128 /*dim*/, L2/*metric type*/, 16/*max degree*/, 200/*ef construction*/, 100000/*max elements*/]\n</code></pre> C++<pre><code>struct IndexItem {\n    1: common.IndexID       index_id,\n    2: binary               index_name,\n    3: common.SchemaID      schema_id\n    4: binary               schema_name,\n    5: list&lt;ColumnDef&gt;      fields,\n    6: optional binary      comment,\n    7: optional IndexParams index_params,\n}\n\nstruct AnnIndexItem {\n    1: common.IndexID           index_id,\n    2: binary                   index_name,\n    3: binary                   prop_name,\n    4: list&lt;common.SchemaID&gt;    schema_ids,\n    5: list&lt;binary&gt;             schema_names,\n    6: list&lt;ColumnDef&gt;          fields,\n    7: optional binary          comment,\n    8: optional list&lt;binary&gt;    ann_params,         // ANN specific parameters\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#ann-index-request-response","title":"Ann Index Request &amp; Response","text":"<ul> <li>\u4e4b\u524d\u7684 <code>CreateTagIndexReq</code> \u53ea\u652f\u6301\u5355\u4e2a Schema \u7684\u7d22\u5f15\u521b\u5efa\uff0c\u800c Ann Index \u9700\u8981\u652f\u6301\u591a\u4e2a Schema \u7684\u540c\u540d\u5c5e\u6027\u8fdb\u884c\u7d22\u5f15\u521b\u5efa\uff0c\u6240\u4ee5\u6211\u4eec\u8bbe\u8ba1\u4e86\u65b0\u7684 <code>CreateTagAnnIndexReq</code>\u3002</li> </ul> C++<pre><code>struct CreateTagAnnIndexReq {\n    1: common.GraphSpaceID      space_id,\n    2: binary                   index_name,\n    3: list&lt;binary&gt;             tag_names,\n    4: IndexFieldDef            field,\n    5: bool                     if_not_exists,\n    6: optional binary          comment,\n    7: optional list&lt;binary&gt;    ann_params,\n}\n</code></pre> <ul> <li>Storaged \u9700\u8981\u901a\u8fc7 meta client \u6267\u884c<code>listTagAnnIndexes</code>\u548c<code>listEdgeAnnIndexes</code>\u83b7\u53d6 Ann \u7d22\u5f15\u4fe1\u606f\uff0cAnn Index \u7684\u6761\u76ee\u7531 Ann Index Item \u5b58\u50a8\u4e0e\u4e4b\u524d\u7684 Index Item \u7ed3\u6784\u4e0d\u540c\uff0c\u6240\u4ee5\u8bbe\u8ba1\u65b0\u7684 Resp\u3002</li> </ul> C++<pre><code>struct ListTagAnnIndexesResp {\n    1: common.ErrorCode         code,\n    2: common.HostAddr          leader,\n    3: list&lt;AnnIndexItem&gt;   items,\n}\nstruct ListEdgeAnnIndexesResp {\n    1: common.ErrorCode         code,\n    2: common.HostAddr          leader,\n    3: list&lt;AnnIndexItem&gt;       items,\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#create-ann-index-syntax-design","title":"Create Ann Index Syntax Design","text":"<p><code>CREATE TAG ANNINDEX &lt;index_name&gt; ON &lt;tag_name_list&gt;::(&lt;field_name&gt;) [IF NOT EXISTS] ann_index_params}[COMMENT '&lt;comment&gt;']</code></p> C++<pre><code>ann_index_params:\n{ANNINDEX_TYPE: \"IVF\", DIM:128, METRIC_TYPE:\"L2\", NLIST:3, TRAINSIZE:3}\n{ANNINDEX_TYPE: \"HNSW\", DIM:128, METRIC_TYPE:\"L2\", MAXDEGREE:15, EFCONSTRUCTION:200, MAXELEMENTS:10000}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#create-ann-index-plan","title":"Create Ann Index Plan","text":"<ol> <li>Graphd \u751f\u6210 <code>Start-&gt;CreateTagAnnIndex-&gt;SubmitJob</code> \u7684\u8ba1\u5212</li> <li>\u6267\u884c\u65f6\uff0cmetad \u5148\u5728\u5185\u90e8\u521b\u5efa Ann \u7d22\u5f15\u6761\u76ee\uff0c\u521b\u5efa\u6210\u529f\u540e\uff0c\u4f1a\u8fdb\u884c AdminJob \u7684\u63d0\u4ea4</li> <li>Metad \u5c06 Job \u7684\u53c2\u6570\u6253\u5305\u4f20\u7ed9 Storaged \u7684 AdminTask\uff0cStoraged \u901a\u8fc7\u5185\u90e8\u7684 AdminTaskManager \u5904\u7406\u8fd9\u4e9b\u4efb\u52a1\uff0c\u5b8c\u6210\u4efb\u52a1\u3002\u8fd9\u91cc\u6d89\u53ca\u5230\u5206\u5e03\u5f0f\u7684\u65f6\u5e8f\u95ee\u9898\uff1a <p>Meta Client \u7f13\u5b58\u66f4\u65b0\u673a\u5236\uff1aStorage \u8282\u70b9\u7684 IndexManager \u901a\u8fc7 MetaClient \u83b7\u53d6\u7d22\u5f15\u4fe1\u606f\uff0c\u4f46 MetaClient \u7684\u7f13\u5b58\u662f\u901a\u8fc7\u5fc3\u8df3\u5468\u671f\u66f4\u65b0\u7684:</p> <ul> <li>\u65f6\u5e8f\u95ee\u9898\uff1aMeta \u670d\u52a1\u521b\u5efa\u7d22\u5f15\u540e\uff0cStorage \u8282\u70b9\u9700\u8981\u7b49\u5f85\u4e0b\u4e00\u4e2a\u5fc3\u8df3\u5468\u671f\u624d\u80fd\u770b\u5230\u65b0\u7d22\u5f15</li> <li>\u540c\u6b65\u95ee\u9898\uff1agetTagAnnIndex \u76f4\u63a5\u4ece\u7f13\u5b58\u8bfb\u53d6\uff0c\u5982\u679c\u7f13\u5b58\u8fd8\u6ca1\u66f4\u65b0\u5c31\u4f1a\u8fd4\u56de IndexNotFound</li> </ul> </li> </ol> <ul> <li>\u6240\u4ee5\u6211\u4eec\u5728 Storaged \u4e2d\u4f7f\u7528\u91cd\u8bd5\u673a\u5236\uff0c\u5982\u679c\u591a\u6b21\u91cd\u8bd5\u5931\u8d25\u76f4\u63a5\u5411 meta server \u8bf7\u6c42\u6570\u636e\u5f3a\u5236\u5237\u65b0\u7f13\u5b58</li> </ul> <p></p>"},{"location":"projects/nebula-vsearch/implements/Create%20Ann%20Index/#storaged-buildtagvectorindextask-plan","title":"Storaged BuildTagVectorIndexTask Plan","text":"<p>\u5bf9\u6bcf\u4e2a Partition \u505a\u76f8\u540c\u7684\u64cd\u4f5c\uff1a</p> <ol> <li>\u626b\u63cf KVStore(RocksDB)\u4e2d\u7684\u6240\u6709\u7b26\u5408 property name \u7684 vector \u5c5e\u6027\u7684\u6570\u636e</li> <li>\u5c06 Vertex ID/Edge Type \u4e0e VectorID \u5b58\u5165 KVStore \u7684 id-vid column family <p>Vertex ID \u662f std::string \u7c7b\u578b\uff0c\u8fd9\u91cc\u901a\u8fc7 hash \u8ba1\u7b97 VectorID\uff0c\u6240\u4ee5\u9700\u8981\u5b58\u5165\u4e24\u4efd\u6620\u5c04<code>VectorID-&gt;VertexID</code>\u548c<code>VertexID-&gt;VectorID</code></p> </li> <li>\u901a\u8fc7\u8fd9\u4e9b\u6570\u636e\u6784\u5efa\u5185\u5b58\u4e2d\u7684 Ann Index</li> </ol> <p></p>"},{"location":"projects/nebula-vsearch/implements/DDL%20for%20vector%20type/","title":"Implement DDL for Vector Type","text":""},{"location":"projects/nebula-vsearch/implements/DDL%20for%20vector%20type/#implement-ddl-for-vector-type","title":"Implement DDL for Vector Type","text":"<p> \u7ea6 55 \u4e2a\u5b57  7 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p> 2025-12-022025-12-02"},{"location":"projects/nebula-vsearch/implements/DDL%20for%20vector%20type/#implement-create-tag-for-vector-type","title":"Implement CREATE TAG for Vector Type","text":""},{"location":"projects/nebula-vsearch/implements/DDL%20for%20vector%20type/#thrift-modify-columntypedef","title":"Thrift: Modify ColumnTypeDef","text":"<ul> <li>Use <code>type_lenght</code> to indicate the dimension of the vector type.</li> </ul> C++<pre><code>struct ColumnTypeDef {\n    1: required common.PropertyType    type,\n    // type_length is valid for fixed_string type and vector type for dimension\n    2: optional i16                    type_length = 0,\n    // geo_shape is valid for geography type\n    3: optional GeoShape               geo_shape,\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/DDL%20for%20vector%20type/#graphd-create-tag-validator","title":"Graphd: Create Tag Validator","text":"<p>We should distinguish the vector columns and other columns from parser.</p>"},{"location":"projects/nebula-vsearch/implements/DDL%20for%20vector%20type/#metad-modify-processor","title":"Metad: Modify Processor","text":"<p>Add the solution to handle the vector columns from <code>CreateTagReq.schema</code>.</p>"},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/","title":"The Process of DML for Vector Type(Insert for example)","text":""},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#the-process-of-dml-for-vector-typeinsert-for-example","title":"The Process of DML for Vector Type(Insert for example)","text":"<p> \u7ea6 537 \u4e2a\u5b57  7 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#overview","title":"Overview","text":""},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#graphd-process","title":"Graphd Process","text":"<ol> <li>Insert \u8bed\u53e5\u9996\u5148\u7531 Graphd \u4ece client \u63a5\u6536\uff0cGraph Service \u5c06 Query\u3001Session\u3001Storage \u7b49\u6253\u5305\u6210 Request Context\uff0c\u968f\u540e\u5c06 Request Context \u6253\u5305\u6210 Query Context\uff0c\u521b\u5efa Query Instance \u968f\u540e\u5f00\u59cb\u6267\u884c parse\u3001validate\u3001optimize\u3001execute \u6574\u4e2a\u6d41\u7a0b\u3002</li> <li>\u7ecf\u8fc7 Graphd \u7684 validate\uff0c\u8fdb\u5165 Planner \u9636\u6bb5\u5bf9\u5e94\u7684\u65f6 InsertVertices\uff0c\u6b64\u65f6\u5df2\u7ecf\u6784\u5efa\u4e86\u4e00\u4e2a\u903b\u8f91\u6267\u884c\u8ba1\u5212\u3002</li> <li>\u901a\u8fc7 Optimizer \u4f18\u5316\u903b\u8f91\u6267\u884c\u8ba1\u5212\uff0c\u751f\u6210\u7269\u7406\u6267\u884c\u8ba1\u5212\u3002</li> <li>\u7269\u7406\u6267\u884c\u8ba1\u5212\u8fd9\u91cc\u53ea\u6d89\u53ca\u5230\u4e00\u4e2a Executor\uff0cInsertVerticesExecutor\u3002InsertVerticesExecutor \u5b9e\u9645\u4e0a\u4f1a\u8c03\u7528 StorageClient \u7684 insertVertices \u65b9\u6cd5\uff0c\u5411 Storaged \u53d1\u9001 Insert \u8bf7\u6c42\u3002</li> </ol>"},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#storaged-process","title":"Storaged Process","text":"<ul> <li>Storaged \u4e0e Metad \u5b9a\u671f\u4f7f\u7528\u5fc3\u8df3\u53bb\u66f4\u65b0\u672c\u5730 Schema \u7f13\u5b58\uff0c\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u83b7\u53d6\u6bd4\u8f83\u65b0\u7684 Schema \u4fe1\u606f\u3002</li> <li>Storaged \u6267\u884c AddVerticesProcessor \u7684 process \u65b9\u6cd5\uff0c\u5f00\u59cb\u5904\u7406 Insert \u8bf7\u6c42\uff0c\u8fd9\u91cc\u6d89\u53ca\u5230 BaseProcessor \u7684 doPut()\u65b9\u6cd5\uff0c\u5b9e\u9645\u4e0a\u6d89\u53ca\u7684\u662f Raft-wal \u7684\u5199\u5165\u3002</li> </ul>"},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#storaged-schema-cache-update","title":"Storaged Schema Cache Update","text":"<ol> <li>Storaged has the meta client, when metad is ready, storaged will get the schema from metad. </li> <li>So if we want to insert vertices in a cluster, we need to add vector columns for the schema in the metaClient not only the metad.</li> </ol>"},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#write-data-by-raft-wal","title":"Write data by Raft-wal","text":"<p>\u5728 Nebula Graph \u4e2d\uff0cVertex \u7684\u521b\u5efa\u901a\u5e38\u901a\u8fc7 <code>AddVerticesProcessor</code> executor \u6765\u5b8c\u6210\u3002\u5b83\u4f1a\u5c06 Vertex \u8981\u63d2\u5165\u7684\u6570\u636e\u5df2\u7ecf\u5143\u6570\u636e\u6253\u5305\u6210 raft-wal log\uff0c\u63d0\u4ea4\u5230 Raft Part \u4e2d\uff0c<code>\u6700\u540e\u5728 Part::commitLogs()</code>\u4e2d\u5c06\u6570\u636e\u5199\u5165\u5230 RocksDB\u3002</p> <p><code>handleAsync()</code> \u4f5c\u4e3a\u5199\u5165\u6210\u529f/\u5931\u8d25\u7684\u56de\u8c03\u51fd\u6570\u6267\u884c\uff0c\u5b9e\u9645\u4e0a\u4f1a\u5c06 Processor \u7684 <code>callingNum_</code> \u51cf 1\uff0c\u76f4\u5230\u6240\u6709 Part \u90fd\u5b8c\u6210\u5199\u5165\u3002\u6267\u884c BaseProcessor \u7684<code>onFinished()</code>\u65b9\u6cd5\uff0c\u5c06<code>result_</code>\u8bbe\u7f6e\u4e4b\u524d\u8fd4\u56de Graphd \u7684 Future \u5bf9\u5e94\u7684 Promise \u4e2d\u3002</p> <p></p>"},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#modifying-the-insert-process","title":"Modifying the Insert Process","text":""},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#attemption-1","title":"Attemption 1","text":"<p>\u5bf9\u4e8e VECTOR \u7c7b\u578b\u7684\u5c5e\u6027\uff0c\u6211\u4eec\u4e0e\u5176\u4ed6\u5c5e\u6027\u5206\u5f00\u5b58\u50a8\uff0c\u6240\u4ee5\u6211\u4eec\u5bf9 Storaged \u7684 AddVerticesProcessor \u8fdb\u884c\u4fee\u6539\uff0c\u53ea\u662f\u7b80\u5355\u7684\u589e\u52a0\u4e00\u6b21\u5bf9 VECTOR \u7c7b\u578b\u7684\u5c5e\u6027\u7684<code>doPut()</code>\u3002</p> <p></p> <ul> <li>\u8fd9\u6837\u4f1a\u7834\u574f\u5bf9\u540c\u4e00 vertex \u4f46\u63d2\u5165\u4e0d\u540c\u5c5e\u6027\u7684\u539f\u5b50\u6027</li> </ul>"},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#attemption-2","title":"Attemption 2","text":"<p>\u4fee\u6539 Raft-wal \u7684 Log \u5f62\u5f0f\uff0c\u589e\u52a0\u6bcf\u4e2a KV \u5bf9\u7684 column family \u4fe1\u606f\uff0c\u5b9e\u73b0\u5728 commitLogs()\u4e2d\u5bf9\u4e0d\u540c\u7684 column family \u8fdb\u884c\u5199\u5165\u3002\u4fdd\u8bc1\u539f\u5b50\u6027\u3002</p> <p></p>"},{"location":"projects/nebula-vsearch/implements/DML%20for%20vector%20type/#final-solution","title":"Final Solution","text":"<ul> <li>\u6211\u4eec\u4fee\u6539 Raft \u4e2d\u5904\u7406 Log \u7684\u8fc7\u7a0b\uff0c\u901a\u8fc7\u5904\u7406\u7684 key \u7684\u7b2c\u4e00\u5b57\u8282(Type)\u5224\u65ad\u662f\u5426\u9700\u8981\u5199\u5165\u5411\u91cf column family </li> </ul>"},{"location":"projects/nebula-vsearch/implements/Match%20for%20vector%20property/","title":"Match for Vector Property","text":""},{"location":"projects/nebula-vsearch/implements/Match%20for%20vector%20property/#match-for-vector-property","title":"Match for Vector Property","text":"<p> \u7ea6 333 \u4e2a\u5b57  76 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 3 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"projects/nebula-vsearch/implements/Match%20for%20vector%20property/#simplest-match-case","title":"Simplest match case","text":"Cypher<pre><code>MATCH (v)\nRETURN v\nLIMIT 3;\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/Match%20for%20vector%20property/#process","title":"Process","text":"<ol> <li>MatchValidator \u9a8c\u8bc1\u9636\u6bb5    \u5728\u9a8c\u8bc1\u9636\u6bb5\uff0c\u8282\u70b9 (v) \u88ab\u8bc6\u522b\u4e3a\uff1a</li> </ol> <ul> <li>\u6ca1\u6709\u6307\u5b9a\u6807\u7b7e\u7684\u8282\u70b9\u6a21\u5f0f</li> <li>\u6ca1\u6709\u5c5e\u6027\u8fc7\u6ee4\u6761\u4ef6</li> <li>\u522b\u540d\u4e3a v\uff0c\u7c7b\u578b\u4e3a AliasType::kNode</li> </ul> <ol> <li>MatchPathPlanner \u8def\u5f84\u89c4\u5212\u9636\u6bb5    StartVidFinder \u5bfb\u627e\u8d77\u59cb\u70b9    \u5728 MatchPathPlanner::findStarts() \u4e2d</li> </ol> C++<pre><code>// \u904d\u5386\u6240\u6709\u7684 StartVidFinder\nfor (auto&amp; finder : startVidFinders) {\n    for (size_t i = 0; i &lt; nodeInfos.size() &amp;&amp; !foundStart; ++i) {\n        NodeContext nodeCtx(qctx, bindWhereClause, spaceId, &amp;nodeInfos[i]);\n        nodeCtx.aliasesAvailable = &amp;nodeAliasesSeen;\n        auto nodeFinder = finder();\n        if (nodeFinder-&gt;match(&amp;nodeCtx)) {\n            // \u627e\u5230\u5339\u914d\u7684 finder\uff0c\u751f\u6210\u521d\u59cb\u8ba1\u5212\n        }\n    }\n}\n</code></pre> <p>\u5bf9\u4e8e MATCH (v) \u6a21\u5f0f\uff0c\u4f1a\u4f7f\u7528 ScanSeek\uff1a</p> <p>ScanSeek::matchNode() \u5339\u914d</p> C++<pre><code>bool ScanSeek::matchNode(NodeContext *nodeCtx) {\n    auto &amp;node = *nodeCtx-&gt;info;\n    // \u6ca1\u6709\u6307\u5b9a\u6807\u7b7e\uff0c\u83b7\u53d6\u6240\u6709\u6807\u7b7e\n    if (node.tids.empty()) {\n        // empty labels means all labels\n        auto allLabels = qctx-&gt;schemaMng()-&gt;getAllTags(nodeCtx-&gt;spaceId);\n        for (const auto &amp;label : allLabels.value()) {\n            nodeCtx-&gt;scanInfo.schemaIds.emplace_back(label.first);\n            nodeCtx-&gt;scanInfo.schemaNames.emplace_back(label.second);\n        }\n        nodeCtx-&gt;scanInfo.anyLabel = true;\n    }\n    return true;\n}\n</code></pre> <p>ScanSeek::transformNode() \u751f\u6210 ScanVertices</p> C++<pre><code>StatusOr&lt;SubPlan&gt; ScanSeek::transformNode(NodeContext *nodeCtx) {\n    SubPlan plan;\n\n    // \u521b\u5efa ScanVertices \u8282\u70b9\n    auto *scanVertices = ScanVertices::make(qctx, nullptr, nodeCtx-&gt;spaceId, std::move(vProps));\n    plan.root = scanVertices;\n    plan.tail = scanVertices;\n\n    // \u5982\u679c\u9700\u8981\uff0c\u6dfb\u52a0\u6807\u7b7e\u8fc7\u6ee4\u5668\n    if (prev != nullptr) {\n        auto *filter = Filter::make(qctx, scanVertices, prev);\n        plan.root = filter;\n    }\n\n    nodeCtx-&gt;initialExpr = InputPropertyExpression::make(pool, kVid);\n    return plan;\n}\n</code></pre> <ol> <li>\u8def\u5f84\u6269\u5c55\u9636\u6bb5    \u7531\u4e8e MATCH (v) \u53ea\u6709\u4e00\u4e2a\u8282\u70b9\uff0c\u6ca1\u6709\u8fb9\uff0c\u5728 MatchPathPlanner::expandFromNode() \u4e2d:</li> </ol> C++<pre><code>Status MatchPathPlanner::expandFromNode(size_t startIndex, SubPlan&amp; subplan) {\n    const auto&amp; nodeInfos = path_.nodeInfos;\n    DCHECK_LT(startIndex, nodeInfos.size());\n    // \u53ea\u6709\u4e00\u4e2a\u8282\u70b9\u7684\u60c5\u51b5\uff0cstartIndex = 0 \u4e14 nodeInfos.size() = 1\n    nodeAliasesSeenInPattern_.emplace(nodeInfos[startIndex].alias);\n\n    if (startIndex == 0) {\n        // Pattern: (start) - \u6ca1\u6709\u540e\u7eed\u8fb9\n        return rightExpandFromNode(startIndex, subplan);\n    }\n}\n</code></pre> <p>\u5728 rightExpandFromNode() \u4e2d\uff0c\u7531\u4e8e\u6ca1\u6709\u8fb9\u4fe1\u606f\uff08edgeInfos.size() = 0\uff09\uff0c\u4f1a\u76f4\u63a5\u8df3\u8fc7\u5faa\u73af\uff0c\u6267\u884c\u6700\u540e\u7684 AppendVertices\uff1a</p> C++<pre><code>Status MatchPathPlanner::rightExpandFromNode(size_t startIndex, SubPlan&amp; subplan) {\n    const auto&amp; nodeInfos = path_.nodeInfos;\n    const auto&amp; edgeInfos = path_.edgeInfos;\n    // edgeInfos.size() = 0\uff0c\u6240\u4ee5 for \u5faa\u73af\u4e0d\u6267\u884c\n\n    auto&amp; lastNode = nodeInfos.back(); // \u5373\u8282\u70b9 v\n\n    // \u521b\u5efa AppendVertices \u8282\u70b9\n    auto appendV = AppendVertices::make(qctx, subplan.root, spaceId);\n    auto vertexProps = SchemaUtil::getAllVertexProp(qctx, spaceId, true);\n    appendV-&gt;setVertexProps(std::move(vertexProps).value());\n    appendV-&gt;setSrc(nextTraverseStart); // \u6765\u81ea ScanVertices \u7684\u8f93\u51fa\n    appendV-&gt;setVertexFilter(genVertexFilter(lastNode));\n    appendV-&gt;setDedup();\n    appendV-&gt;setTrackPrevPath(!edgeInfos.empty()); // false\uff0c\u56e0\u4e3a\u6ca1\u6709\u8fb9\n    appendV-&gt;setColNames(genAppendVColNames(subplan.root-&gt;colNames(), lastNode, !edgeInfos.empty()));\n    subplan.root = appendV;\n\n    return Status::OK();\n}\n</code></pre> <ol> <li>RETURN \u548c LIMIT \u5904\u7406    YieldClausePlanner \u5904\u7406 RETURN v    \u5904\u7406 RETURN v \u90e8\u5206\uff0c\u751f\u6210 Project \u8282\u70b9\u6765\u6295\u5f71\u5217 v\u3002</li> </ol> <p>PaginationPlanner \u5904\u7406 LIMIT 3 5. \u6700\u7ec8\u6267\u884c\u8ba1\u5212\u7ed3\u6784</p> <p>\u751f\u6210 Limit -&gt; AppendVertices -&gt; ScanVertices \u8fd9\u6837\u7684\u4e09\u5c42\u6267\u884c\u8ba1\u5212\u3002</p> <ul> <li>ScanVertices \u53ea\u626b\u63cf\u9876\u70b9 ID \u548c\u6807\u7b7e\u4fe1\u606f\uff0c\u4e0d\u5305\u542b\u9876\u70b9\u7684\u5b8c\u6574\u5c5e\u6027</li> <li>AppendVertices \u6839\u636e ScanVertices \u8f93\u51fa\u7684\u9876\u70b9 ID\uff0c\u53bb\u83b7\u53d6\u5b8c\u6574\u7684\u9876\u70b9\u5c5e\u6027\u6570\u636e</li> </ul> <p>\u8fd9\u79cd\u6267\u884c\u8ba1\u5212\u8bbe\u8ba1\u5141\u8bb8\uff1a</p> <ul> <li>\u5ef6\u8fdf\u52a0\u8f7d\uff1a\u53ea\u6709\u771f\u6b63\u9700\u8981\u7684\u9876\u70b9\u624d\u4f1a\u83b7\u53d6\u5b8c\u6574\u5c5e\u6027</li> <li>\u5185\u5b58\u6548\u7387\uff1a\u626b\u63cf\u9636\u6bb5\u53ea\u5904\u7406 ID \u548c\u57fa\u672c\u8fc7\u6ee4\uff0c\u51cf\u5c11\u5185\u5b58\u4f7f\u7528</li> <li>\u53ef\u6269\u5c55\u6027\uff1a\u652f\u6301\u590d\u6742\u7684\u56fe\u904d\u5386\u6a21\u5f0f</li> </ul>"},{"location":"projects/nebula-vsearch/implements/Match%20for%20vector%20property/#vector-property-support","title":"Vector Property Support","text":"<ul> <li>AppendVertices \u652f\u6301\u5411\u91cf\u5c5e\u6027\u7684\u5904\u7406</li> <li>\u5728 SchemaUtil::getAllVertexProp()\u4e2d\u83b7\u53d6\u6240\u6709 tag \u7684 schema \u4fe1\u606f\uff0c\u9700\u8981\u83b7\u53d6 vector property \u7684\u4fe1\u606f\u3002</li> </ul>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/","title":"WAL for Vector Type","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#wal-for-vector-type","title":"WAL for Vector Type","text":"<p> \u7ea6 1680 \u4e2a\u5b57  800 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 18 \u5206\u949f</p> 2025-12-022025-12-10"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#wal-scenarios","title":"WAL Scenarios","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#1","title":"\u573a\u666f 1: \u65b0\u8282\u70b9\u52a0\u5165\u96c6\u7fa4","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_1","title":"\u521d\u59cb\u72b6\u6001","text":"Text Only<pre><code>\u96c6\u7fa4\u72b6\u6001\uff1a\n- Leader: Node1 (term=5, lastLogId=100)\n- Follower: Node2 (term=5, lastLogId=100)\n- Follower: Node3 (term=5, lastLogId=100)\n- \u65b0\u8282\u70b9: Node4 (term=0, lastLogId=0)\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_2","title":"\u91cd\u653e\u6d41\u7a0b","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#1_1","title":"\u6b65\u9aa4 1: \u65b0\u8282\u70b9\u542f\u52a8","text":"C++<pre><code>// Node4 \u542f\u52a8\nvoid RaftPart::start(std::vector&lt;HostAddr&gt;&amp;&amp; peers, bool asLearner) {\n  // Node4 \u8bbe\u7f6e\uff1a\n  // - role_ = Role::FOLLOWER\n  // - term_ = 0\n  // - lastLogId_ = 0\n  // - committedLogId_ = 0\n\n  VLOG(1) &lt;&lt; \"Node4 started as follower with \" &lt;&lt; peers.size() &lt;&lt; \" peers\";\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#2-leader","title":"\u6b65\u9aa4 2: Leader \u53d1\u73b0\u65b0\u8282\u70b9\u843d\u540e\u592a\u591a","text":"C++<pre><code>// Node1 (Leader) \u68c0\u6d4b\u5230 Node4 \u9700\u8981 snapshot\nvoid RaftPart::sendHeartbeat() {\n  // \u53d1\u73b0 Node4 \u7684 lastLogId=0\uff0c\u800c Leader \u7684 firstLogId=10\n  // \u5dee\u8ddd\u8fc7\u5927\uff0c\u9700\u8981\u53d1\u9001 snapshot\n\n  if (node4_lastLogId &lt; wal_-&gt;firstLogId()) {\n    // \u89e6\u53d1 snapshot \u53d1\u9001\n    snapshot_-&gt;sendSnapshot(shared_from_this(), node4_addr);\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#3-snapshot","title":"\u6b65\u9aa4 3: Snapshot \u53d1\u9001\u8fc7\u7a0b","text":"C++<pre><code>// SnapshotManager::sendSnapshot()\nfolly::Future&lt;StatusOr&lt;std::pair&lt;LogID, TermID&gt;&gt;&gt; SnapshotManager::sendSnapshot(\n    std::shared_ptr&lt;RaftPart&gt; part, const HostAddr&amp; dst) {\n\n  // \u626b\u63cf\u6240\u6709\u6570\u636e\n  accessAllRowsInSnapshot(spaceId, partId,\n    [&amp;](LogID commitLogId, TermID commitLogTerm,\n        const std::vector&lt;std::string&gt;&amp; data,\n        int64_t totalCount, int64_t totalSize,\n        SnapshotStatus status) -&gt; bool {\n\n      // \u5206\u6279\u53d1\u9001\u6570\u636e\n      auto resp = send(spaceId, partId, termId, commitLogId, commitLogTerm,\n                      localhost, data, totalSize, totalCount, dst,\n                      status == SnapshotStatus::DONE);\n\n      return resp.get().get_error_code() == nebula::cpp2::ErrorCode::SUCCEEDED;\n    });\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#4-node4-snapshot","title":"\u6b65\u9aa4 4: Node4 \u63a5\u6536 Snapshot","text":"C++<pre><code>// Node4 \u63a5\u6536 snapshot\nvoid RaftPart::processSendSnapshotRequest(const cpp2::SendSnapshotRequest&amp; req,\n                                          cpp2::SendSnapshotResponse&amp; resp) {\n  // \u9a8c\u8bc1 Leader \u8eab\u4efd\n  auto err = verifyLeader(req);\n  if (err != nebula::cpp2::ErrorCode::SUCCEEDED) {\n    resp.error_code_ref() = err;\n    return;\n  }\n\n  // \u91cd\u7f6e\u72b6\u6001\uff0c\u51c6\u5907\u63a5\u6536 snapshot\n  reset();\n  status_ = Status::WAITING_SNAPSHOT;\n\n  // \u63d0\u4ea4\u6570\u636e\u5230\u72b6\u6001\u673a\n  auto ret = commitSnapshot(req.get_rows(),\n                           req.get_committed_log_id(),\n                           req.get_committed_log_term(),\n                           req.get_done());\n\n  if (req.get_done()) {\n    // Snapshot \u63a5\u6536\u5b8c\u6210\n    committedLogId_ = req.get_committed_log_id();  // = 100\n    committedLogTerm_ = req.get_committed_log_term();  // = 5\n    lastLogId_ = committedLogId_;\n    lastLogTerm_ = committedLogTerm_;\n    status_ = Status::RUNNING;\n\n    VLOG(1) &lt;&lt; \"Node4 snapshot completed, now at logId=\" &lt;&lt; lastLogId_;\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#5","title":"\u6b65\u9aa4 5: \u6b63\u5e38\u65e5\u5fd7\u590d\u5236","text":"C++<pre><code>// Node4 \u73b0\u5728\u53ef\u4ee5\u63a5\u6536\u6b63\u5e38\u7684\u65e5\u5fd7\u590d\u5236\nvoid RaftPart::processAppendLogRequest(const cpp2::AppendLogRequest&amp; req,\n                                       cpp2::AppendLogResponse&amp; resp) {\n  // Node4 \u72b6\u6001: lastLogId=100, term=5\n  // Leader \u53d1\u9001: prevLogId=100, prevLogTerm=5, logs=[101, 102, 103...]\n\n  // \u9a8c\u8bc1\u65e5\u5fd7\u8fde\u7eed\u6027\n  if (req.get_last_log_id_sent() == lastLogId_ &amp;&amp;\n      req.get_last_log_term_sent() == lastLogTerm_) {\n    // \u8fde\u7eed\uff0c\u53ef\u4ee5\u8ffd\u52a0\n    for (auto&amp; log : req.get_log_str_list()) {\n      wal_-&gt;appendLog(++lastLogId_, req.get_current_term(), clusterId_, log);\n    }\n\n    // \u63d0\u4ea4\u53ef\u63d0\u4ea4\u7684\u65e5\u5fd7\n    if (req.get_committed_log_id() &gt; committedLogId_) {\n      auto walIt = wal_-&gt;iterator(committedLogId_ + 1, req.get_committed_log_id());\n      commitLogs(std::move(walIt), false, true);\n    }\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#2","title":"\u573a\u666f 2: \u6545\u969c\u8282\u70b9\u91cd\u65b0\u52a0\u5165","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_3","title":"\u521d\u59cb\u72b6\u6001","text":"Text Only<pre><code>Node2 \u5728 logId=80 \u65f6\u6545\u969c\uff0c\u73b0\u5728\u91cd\u65b0\u542f\u52a8\n\u96c6\u7fa4\u5f53\u524d\u72b6\u6001\uff1a\n- Leader: Node1 (term=5, lastLogId=120)\n- Follower: Node3 (term=5, lastLogId=120)\n- \u91cd\u542f\u8282\u70b9: Node2 (term=3, lastLogId=80, committedLogId=75)\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_4","title":"\u91cd\u653e\u6d41\u7a0b","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#1-node2","title":"\u6b65\u9aa4 1: Node2 \u542f\u52a8\u6062\u590d","text":"C++<pre><code>void RaftPart::start(std::vector&lt;HostAddr&gt;&amp;&amp; peers, bool asLearner) {\n  // \u4ece\u672c\u5730\u5b58\u50a8\u6062\u590d\u72b6\u6001\n  auto logIdAndTerm = lastCommittedLogId();\n  committedLogId_ = logIdAndTerm.first;    // = 75\n  committedLogTerm_ = logIdAndTerm.second; // = 3\n\n  lastLogId_ = wal_-&gt;lastLogId();     // = 80\n  lastLogTerm_ = wal_-&gt;lastLogTerm(); // = 3\n  term_ = lastLogTerm_;               // = 3\n\n  // \u68c0\u67e5\u4e00\u81f4\u6027\n  if (lastLogId_ &lt; committedLogId_) {\n    // \u5f02\u5e38\u60c5\u51b5\uff0c\u91cd\u7f6e WAL\n    lastLogId_ = committedLogId_;\n    lastLogTerm_ = committedLogTerm_;\n    wal_-&gt;reset();\n  }\n\n  // \u5148\u91cd\u653e\u672c\u5730\u672a\u63d0\u4ea4\u7684\u65e5\u5fd7\n  if (lastLogId_ &gt; committedLogId_) {\n    auto walIt = wal_-&gt;iterator(committedLogId_ + 1, lastLogId_);\n    commitLogs(std::move(walIt), true, false);\n    committedLogId_ = lastLogId_;\n    committedLogTerm_ = lastLogTerm_;\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#2-leader_1","title":"\u6b65\u9aa4 2: \u63a5\u6536 Leader \u7684\u65e5\u5fd7","text":"C++<pre><code>void RaftPart::processAppendLogRequest(const cpp2::AppendLogRequest&amp; req,\n                                       cpp2::AppendLogResponse&amp; resp) {\n  // Node2 \u6536\u5230: term=5, prevLogId=120, \u4f46\u672c\u5730\u53ea\u6709\u5230 80\n\n  // \u9a8c\u8bc1 Leader \u8eab\u4efd\n  if (req.get_current_term() &gt; term_) {\n    // \u66f4\u65b0 term\uff0c\u8f6c\u4e3a follower\n    term_ = req.get_current_term();\n    role_ = Role::FOLLOWER;\n    leader_ = HostAddr(req.get_leader_addr(), req.get_leader_port());\n  }\n\n  // \u68c0\u67e5\u65e5\u5fd7\u8fde\u7eed\u6027\n  if (req.get_last_log_id_sent() &gt; lastLogId_) {\n    // \u6709 gap\uff0c\u8bf7\u6c42\u4ece lastLogId_ \u5f00\u59cb\u53d1\u9001\n    resp.last_matched_log_id_ref() = lastLogId_;        // = 80\n    resp.last_matched_log_term_ref() = lastLogTerm_;    // = 3\n    return;\n  }\n\n  // \u627e\u5230 prevLogId \u5728\u672c\u5730\u7684\u4f4d\u7f6e\n  auto termInWal = wal_-&gt;getLogTerm(req.get_last_log_id_sent());\n  if (termInWal != req.get_last_log_term_sent()) {\n    // term \u4e0d\u5339\u914d\uff0c\u9700\u8981\u56de\u6eda\n    wal_-&gt;rollbackToLog(req.get_last_log_id_sent() - 1);\n    resp.last_matched_log_id_ref() = req.get_last_log_id_sent() - 1;\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#3-leader","title":"\u6b65\u9aa4 3: Leader \u91cd\u65b0\u53d1\u9001\u6b63\u786e\u7684\u65e5\u5fd7","text":"C++<pre><code>// Leader \u6536\u5230 Node2 \u7684\u54cd\u5e94\uff0c\u77e5\u9053\u9700\u8981\u4ece logId=80 \u5f00\u59cb\u53d1\u9001\nvoid RaftPart::replicateLogs() {\n  // \u4e3a Node2 \u51c6\u5907\u4ece logId=81 \u5f00\u59cb\u7684\u65e5\u5fd7\n  auto walIt = wal_-&gt;iterator(81, 120);\n\n  // \u53d1\u9001\u65e5\u5fd7 [81, 82, ..., 120]\n  while (walIt-&gt;valid()) {\n    // \u6784\u9020 AppendLogRequest\n    // prevLogId = 80, prevLogTerm = 3\n    // logs = [81, 82, ..., 90] (\u5206\u6279\u53d1\u9001)\n    ++(*walIt);\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#4-node2","title":"\u6b65\u9aa4 4: Node2 \u91cd\u653e\u8ffd\u8d76\u65e5\u5fd7","text":"C++<pre><code>void RaftPart::processAppendLogRequest(const cpp2::AppendLogRequest&amp; req,\n                                       cpp2::AppendLogResponse&amp; resp) {\n  // Node2 \u6536\u5230\u4ece 81 \u5f00\u59cb\u7684\u65e5\u5fd7\n  // prevLogId=80, prevLogTerm=3 \u2713 \u5339\u914d\n\n  // \u8ffd\u52a0\u65e5\u5fd7\u5230 WAL\n  for (size_t i = 0; i &lt; req.get_log_str_list().size(); ++i) {\n    LogID logId = req.get_last_log_id_sent() + 1 + i;\n    wal_-&gt;appendLog(logId, req.get_current_term(), clusterId_,\n                   req.get_log_str_list()[i]);\n  }\n\n  lastLogId_ = req.get_last_log_id_sent() + req.get_log_str_list().size();\n  lastLogTerm_ = req.get_current_term();\n\n  // \u63d0\u4ea4\u53ef\u4ee5\u63d0\u4ea4\u7684\u65e5\u5fd7\n  LogID canCommit = std::min(lastLogId_, req.get_committed_log_id());\n  if (canCommit &gt; committedLogId_) {\n    auto walIt = wal_-&gt;iterator(committedLogId_ + 1, canCommit);\n    auto result = commitLogs(std::move(walIt), false, true);\n\n    if (std::get&lt;0&gt;(result) == nebula::cpp2::ErrorCode::SUCCEEDED) {\n      committedLogId_ = std::get&lt;1&gt;(result);\n      committedLogTerm_ = std::get&lt;2&gt;(result);\n    }\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#3-vector","title":"\u573a\u666f 3: Vector \u6570\u636e\u7684\u91cd\u653e","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#vector-wal","title":"Vector \u64cd\u4f5c\u7684 WAL \u8bb0\u5f55","text":"C++<pre><code>// \u539f\u59cb\u64cd\u4f5c\uff1a\u63d2\u5165 vector \u6570\u636e\nauto vectorKey = NebulaKeyUtils::vectorTagKey(8, 1, \"vertex1\", 1, 1);\nauto vectorValue = encodeVector({1.0, 2.0, 3.0, 4.0});\n\n// WAL \u4e2d\u8bb0\u5f55\u4e3a OP_PUT\nstd::string logEntry;\nlogEntry.append(reinterpret_cast&lt;const char*&gt;(&amp;timestamp), sizeof(timestamp));\nlogEntry.append(1, OP_PUT);  // \u64cd\u4f5c\u7c7b\u578b\nlogEntry.append(encodeKeyValue(vectorKey, vectorValue));\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#vector","title":"Vector \u6570\u636e\u7684\u91cd\u653e\u8fc7\u7a0b","text":"C++<pre><code>std::tuple&lt;nebula::cpp2::ErrorCode, LogID, TermID&gt; Part::commitLogs(\n    std::unique_ptr&lt;LogIterator&gt; iter, bool wait, bool needLock) {\n\n  while (iter-&gt;valid()) {\n    auto log = iter-&gt;logMsg();\n\n    switch (log[sizeof(int64_t)]) {\n      case OP_PUT: {\n        auto pieces = decodeMultiValues(log);\n\n        if (NebulaKeyUtils::isVector(pieces[0].str())) {\n          // Vector \u6570\u636e\u7684\u7279\u6b8a\u5904\u7406\n          VLOG(3) &lt;&lt; \"Replaying vector data: \" &lt;&lt; folly::hexlify(pieces[0]);\n\n          // 1. \u5148\u5199\u5165 VectorIndexWal\n          if (vectorIndexWal_) {\n            auto vectorId = static_cast&lt;VectorID&gt;(\n                std::hash&lt;std::string&gt;{}(pieces[0].str()));\n\n            auto appendResult = vectorIndexWal_-&gt;appendEntry(\n                vector::VectorWalOp::INSERT, vectorId, pieces[1]);\n\n            if (!appendResult.ok()) {\n              LOG(ERROR) &lt;&lt; \"Failed to append to VectorIndexWal during replay: \"\n                         &lt;&lt; appendResult.status();\n              return {nebula::cpp2::ErrorCode::E_UNKNOWN, kNoCommitLogId, kNoCommitLogTerm};\n            }\n\n            VLOG(3) &lt;&lt; \"Vector entry replayed to VectorIndexWal with LogID: \"\n                    &lt;&lt; appendResult.value();\n          }\n\n          // 2. \u7136\u540e\u5199\u5165 RocksDB vector column family\n          code = batch-&gt;put(NebulaKeyUtils::kVectorColumnFamilyName, pieces[0], pieces[1]);\n        } else {\n          // \u666e\u901a\u6570\u636e\u76f4\u63a5\u5199\u5165\u9ed8\u8ba4 column family\n          code = batch-&gt;put(pieces[0], pieces[1]);\n        }\n        break;\n      }\n\n      case OP_REMOVE: {\n        auto key = decodeSingleValue(log);\n\n        if (NebulaKeyUtils::isVector(key.str())) {\n          // Vector \u5220\u9664\u64cd\u4f5c\n          if (vectorIndexWal_) {\n            auto vectorId = static_cast&lt;VectorID&gt;(\n                std::hash&lt;std::string&gt;{}(key.str()));\n\n            auto appendResult = vectorIndexWal_-&gt;appendEntry(\n                vector::VectorWalOp::DELETE, vectorId, folly::StringPiece{});\n\n            if (!appendResult.ok()) {\n              LOG(ERROR) &lt;&lt; \"Failed to append delete to VectorIndexWal: \"\n                         &lt;&lt; appendResult.status();\n              return {nebula::cpp2::ErrorCode::E_UNKNOWN, kNoCommitLogId, kNoCommitLogTerm};\n            }\n          }\n\n          code = batch-&gt;remove(NebulaKeyUtils::kVectorColumnFamilyName, key);\n        } else {\n          code = batch-&gt;remove(key);\n        }\n        break;\n      }\n    }\n\n    ++(*iter);\n  }\n\n  // \u6279\u91cf\u63d0\u4ea4\u6240\u6709\u64cd\u4f5c\n  auto commitCode = engine_-&gt;commitBatchWrite(std::move(batch));\n  return {commitCode, lastId, lastTerm};\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#vector-index","title":"Vector Index \u91cd\u5efa","text":"C++<pre><code>// \u8282\u70b9\u91cd\u542f\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7 VectorIndexWal \u91cd\u5efa vector index\nvoid rebuildVectorIndexFromWal() {\n  if (!vectorIndexWal_) return;\n\n  auto iterator = vectorIndexWal_-&gt;iterator(0, -1);  // \u6240\u6709\u65e5\u5fd7\n\n  while (iterator-&gt;valid()) {\n    auto entryResult = iterator-&gt;entry();\n    if (entryResult.ok()) {\n      const auto&amp; entry = entryResult.value();\n\n      switch (entry.op) {\n        case vector::VectorWalOp::INSERT:\n          // \u91cd\u5efa\u5411\u91cf\u7d22\u5f15\u9879\n          rebuildVectorIndexEntry(entry.vectorId, entry.vectorData);\n          break;\n\n        case vector::VectorWalOp::DELETE:\n          // \u4ece\u7d22\u5f15\u4e2d\u5220\u9664\n          removeFromVectorIndex(entry.vectorId);\n          break;\n\n        case vector::VectorWalOp::UPDATE:\n          // \u66f4\u65b0\u7d22\u5f15\u9879\n          updateVectorIndexEntry(entry.vectorId, entry.vectorData);\n          break;\n      }\n    }\n\n    iterator-&gt;next();\n  }\n\n  VLOG(1) &lt;&lt; \"Vector index rebuilt from VectorIndexWal\";\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_5","title":"\u76d1\u63a7\u548c\u8c03\u8bd5","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_6","title":"\u91cd\u8981\u7684\u65e5\u5fd7\u8f93\u51fa","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_7","title":"\u542f\u52a8\u65f6\u7684\u72b6\u6001\u6062\u590d","text":"Text Only<pre><code>I0809 10:30:15.123456 RaftPart.cpp:425] [Space 1, Part 1]: There are 2 peer hosts, and total 3 hosts. The quorum is 2, lastLogId 100, lastLogTerm 5, committedLogId 95, committedLogTerm 5\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_8","title":"\u65e5\u5fd7\u91cd\u653e\u8fdb\u5ea6","text":"Text Only<pre><code>I0809 10:30:16.789012 Part.cpp:234] [Space 1, Part 1]: Committing logs from 96 to 100\nI0809 10:30:16.789123 Part.cpp:245] [Space 1, Part 1]: Vector entry written to VectorIndexWal with LogID: 1001\nI0809 10:30:16.789234 Part.cpp:278] [Space 1, Part 1]: Successfully committed logs up to 100\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#snapshot","title":"Snapshot \u4f20\u8f93","text":"Text Only<pre><code>I0809 10:30:20.456789 SnapshotManager.cpp:85] [Space 1, Part 1]: Finished snapshot, totalCount 10000, totalSize 104857600\nI0809 10:30:20.567890 RaftPart.cpp:2031] [Space 1, Part 1]: Receive all snapshot, committedLogId 100, committedLogTerm 5\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_9","title":"\u6027\u80fd\u6307\u6807\u76d1\u63a7","text":"C++<pre><code>// \u91cd\u653e\u5ef6\u8fdf\u7edf\u8ba1\nstats::StatsManager::addValue(kCommitLogLatencyUs, elapsedTime);\n\n// \u590d\u5236\u5ef6\u8fdf\u7edf\u8ba1\nstats::StatsManager::addValue(kReplicateLogLatencyUs, replicationTime);\n\n// Vector WAL \u7edf\u8ba1\nauto stats = vectorIndexWal_-&gt;getStats();\nVLOG(1) &lt;&lt; \"VectorWal stats: entries=\" &lt;&lt; stats.totalEntries\n        &lt;&lt; \", files=\" &lt;&lt; stats.totalFiles\n        &lt;&lt; \", size=\" &lt;&lt; stats.totalSize;\n</code></pre> <p>\u8fd9\u4e9b\u793a\u4f8b\u5c55\u793a\u4e86 Nebula \u5728\u4e0d\u540c\u573a\u666f\u4e0b\u5982\u4f55\u901a\u8fc7 WAL \u91cd\u653e\u673a\u5236\u786e\u4fdd\u6570\u636e\u4e00\u81f4\u6027\uff0c\u7279\u522b\u662f\u6211\u4eec\u65b0\u589e\u7684 Vector Index WAL \u5982\u4f55\u4e0e\u4f20\u7edf\u7684\u91cd\u653e\u6d41\u7a0b\u96c6\u6210\u3002</p>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#snapshot_1","title":"Snapshot \u4f20\u8f93\u6570\u636e\u8fc7\u7a0b","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_10","title":"\u6982\u8ff0","text":"<p>\u5f53\u65b0\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\u6216\u8282\u70b9\u91cd\u542f\u540e\u9700\u8981\u5927\u91cf\u6570\u636e\u540c\u6b65\u65f6\uff0cNebula \u4f7f\u7528 Snapshot \u673a\u5236\u8fdb\u884c\u5168\u91cf\u6570\u636e\u4f20\u8f93\u3002\u5bf9\u4e8e vector \u6570\u636e\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u786e\u4fdd\u4e86\u6570\u636e\u7684\u6b63\u786e\u4f20\u8f93\u548c\u540e\u7eed VectorIndexWal \u7684\u4e00\u81f4\u6027\u7ef4\u62a4\u3002</p>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_11","title":"\u5b8c\u6574\u6d41\u7a0b\u56fe","text":"Text Only<pre><code>Leader \u8282\u70b9                                \u65b0\u8282\u70b9 (Follower)\n     |                                         |\n     |-- \u68c0\u6d4b\u5230\u65b0\u8282\u70b9\u843d\u540e\u592a\u591a ------------------&gt;|\n     |                                         |-- \u8282\u70b9\u542f\u52a8\uff0cWAL \u4e3a\u7a7a\n     |                                         |\n     |==== Snapshot \u53d1\u9001\u9636\u6bb5 ====              |==== Snapshot \u63a5\u6536\u9636\u6bb5 ====\n     |                                         |\n     |-- accessAllRowsInSnapshot() -----------&gt;|\n     |    \u626b\u63cf\u6240\u6709\u6570\u636e\uff08\u5305\u62ec vector\uff09            |\n     |                                         |-- processSendSnapshotRequest()\n     |-- \u5206\u6279\u53d1\u9001\u6570\u636e -----------------------&gt;|-- \u9a8c\u8bc1 Leader \u8eab\u4efd\n     |    (SendSnapshotRequest)                |-- reset() \u6e05\u7406\u72b6\u6001\n     |                                         |-- status_ = WAITING_SNAPSHOT\n     |                                         |\n     |-- \u53d1\u9001 vector \u6570\u636e\u6279\u6b21 -----------------&gt;|-- commitSnapshot() \u63a5\u6536\u6570\u636e\n     |    key: vector key                     |    \u76f4\u63a5\u5199\u5165 vector column family\n     |    value: vector \u5411\u91cf\u6570\u636e               |    \u26a0\ufe0f \u4e0d\u89e6\u53d1 VectorIndexWal\n     |                                         |\n     |-- \u53d1\u9001\u5b8c\u6210\u6807\u8bb0 -----------------------&gt;|-- finished=true \u5b8c\u6210 snapshot\n     |    (finished=true)                     |-- \u66f4\u65b0 committedLogId/Term\n     |                                         |-- status_ = RUNNING\n     |                                         |\n     |==== \u589e\u91cf\u65e5\u5fd7\u590d\u5236\u9636\u6bb5 ====               |==== \u589e\u91cf\u65e5\u5fd7\u63a5\u6536\u9636\u6bb5 ====\n     |                                         |\n     |-- appendLogs() \u53d1\u9001\u65b0\u65e5\u5fd7 --------------&gt;|-- processAppendLogRequest()\n     |    \u5305\u542b\u65b0\u7684 vector \u64cd\u4f5c                 |-- \u63a5\u6536\u65b0 vector \u64cd\u4f5c\u65e5\u5fd7\n     |                                         |\n     |                                         |-- commitLogs() \u91cd\u653e\u65e5\u5fd7\n     |                                         |    \u2705 \u89e6\u53d1 VectorIndexWal \u5199\u5165\n     |                                         |    \u2705 \u5199\u5165 vector column family\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_12","title":"\u4ee3\u7801\u5b9e\u73b0\u8be6\u89e3","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#1-leader","title":"1. Leader \u7aef\uff1a\u6570\u636e\u626b\u63cf\u548c\u53d1\u9001","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#11-snapshot","title":"1.1 \u89e6\u53d1 Snapshot \u53d1\u9001","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/Host.cpp:349</code></p> C++<pre><code>nebula::cpp2::ErrorCode Host::startSendSnapshot() {\n  CHECK(!lock_.try_lock());\n  if (!sendingSnapshot_) {\n    VLOG(1) &lt;&lt; idStr_ &lt;&lt; \"Can't find log \" &lt;&lt; lastLogIdSent_ + 1 &lt;&lt; \" in wal, send the snapshot\"\n            &lt;&lt; \", logIdToSend = \" &lt;&lt; logIdToSend_\n            &lt;&lt; \", firstLogId in wal = \" &lt;&lt; part_-&gt;wal()-&gt;firstLogId()\n            &lt;&lt; \", lastLogId in wal = \" &lt;&lt; part_-&gt;wal()-&gt;lastLogId();\n\n    sendingSnapshot_ = true;\n    stats::StatsManager::addValue(kNumSendSnapshot);\n\n    // \u8c03\u7528 SnapshotManager \u53d1\u9001 snapshot\n    part_-&gt;snapshot_-&gt;sendSnapshot(part_, addr_)\n        .thenValue([self = shared_from_this()](auto&amp;&amp; status) {\n          // \u5904\u7406\u53d1\u9001\u7ed3\u679c\n        });\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#12-vector","title":"1.2 \u626b\u63cf\u6240\u6709\u6570\u636e\uff08\u5305\u62ec vector \u6570\u636e\uff09","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/NebulaSnapshotManager.cpp:32</code></p> C++<pre><code>void NebulaSnapshotManager::accessAllRowsInSnapshot(GraphSpaceID spaceId,\n                                                    PartitionID partId,\n                                                    raftex::SnapshotCallback cb) {\n  // \u83b7\u53d6\u5206\u533a\u548c RocksDB snapshot\n  auto partRet = store_-&gt;part(spaceId, partId);\n  auto snapshot = store_-&gt;GetSnapshot(spaceId, partId);\n\n  // \u83b7\u53d6 committed log \u4fe1\u606f\n  std::string val;\n  auto commitRet = part-&gt;engine()-&gt;get(NebulaKeyUtils::systemCommitKey(partId), &amp;val, snapshot);\n  LogID commitLogId;\n  TermID commitLogTerm;\n  memcpy(&amp;commitLogId, val.data(), sizeof(LogID));\n  memcpy(&amp;commitLogTerm, val.data() + sizeof(LogID), sizeof(TermID));\n\n  // \u626b\u63cf\u6240\u6709\u524d\u7f00\u7684\u6570\u636e\uff0c\u5305\u62ec vector \u6570\u636e\n  std::vector&lt;std::string&gt; prefixes{\n    NebulaKeyUtils::systemPrefix(),       // \u7cfb\u7edf\u6570\u636e\n    NebulaKeyUtils::tagPrefix(partId),    // Tag \u6570\u636e\n    NebulaKeyUtils::edgePrefix(partId),   // Edge \u6570\u636e\n    NebulaKeyUtils::vectorTagPrefix(partId),  // \u2b50 Vector Tag \u6570\u636e\n    NebulaKeyUtils::vectorEdgePrefix(partId), // \u2b50 Vector Edge \u6570\u636e\n    NebulaKeyUtils::indexPrefix(partId),  // \u7d22\u5f15\u6570\u636e\n    // ... \u5176\u4ed6\u524d\u7f00\n  };\n\n  for (const auto&amp; prefix : prefixes) {\n    bool hasData = accessTable(spaceId, partId, snapshot, prefix, cb,\n                              commitLogId, commitLogTerm, data, totalCount, totalSize, rateLimiter);\n    if (!hasData) break;\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#13","title":"1.3 \u5206\u6279\u53d1\u9001\u6570\u636e","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/SnapshotManager.cpp:121</code></p> C++<pre><code>folly::Future&lt;raftex::cpp2::SendSnapshotResponse&gt; SnapshotManager::send(\n    GraphSpaceID spaceId, PartitionID partId, TermID termId,\n    LogID committedLogId, TermID committedLogTerm,\n    const HostAddr&amp; localhost, const std::vector&lt;std::string&gt;&amp; data,\n    int64_t totalSize, int64_t totalCount,\n    const HostAddr&amp; addr, bool finished) {\n\n  // \u6784\u9020\u53d1\u9001\u8bf7\u6c42\n  raftex::cpp2::SendSnapshotRequest req;\n  req.space_ref() = spaceId;\n  req.part_ref() = partId;\n  req.current_term_ref() = termId;\n  req.committed_log_id_ref() = committedLogId;\n  req.committed_log_term_ref() = committedLogTerm;\n  req.leader_addr_ref() = localhost.host;\n  req.leader_port_ref() = localhost.port;\n  req.rows_ref() = data;  // \u2b50 \u5305\u542b vector \u6570\u636e\u7684\u884c\n  req.total_size_ref() = totalSize;\n  req.total_count_ref() = totalCount;\n  req.done_ref() = finished;\n\n  // \u53d1\u9001\u5230\u76ee\u6807\u8282\u70b9\n  return client-&gt;future_sendSnapshot(req);\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#2-follower-snapshot","title":"2. Follower \u7aef\uff1a\u63a5\u6536\u548c\u5b89\u88c5 Snapshot","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#21-snapshot","title":"2.1 \u63a5\u6536 Snapshot \u8bf7\u6c42","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/RaftPart.cpp:1956</code></p> C++<pre><code>void RaftPart::processSendSnapshotRequest(const cpp2::SendSnapshotRequest&amp; req,\n                                          cpp2::SendSnapshotResponse&amp; resp) {\n  std::lock_guard&lt;std::mutex&gt; g(raftLock_);\n\n  // \u68c0\u67e5\u72b6\u6001\u548c\u9a8c\u8bc1 Leader \u8eab\u4efd\n  if (status_ != Status::WAITING_SNAPSHOT) {\n    VLOG(2) &lt;&lt; idStr_ &lt;&lt; \"Begin to receive the snapshot\";\n\n    // \u9a8c\u8bc1 Leader \u8eab\u4efd\n    auto err = verifyLeader&lt;cpp2::SendSnapshotRequest&gt;(req);\n    if (err != nebula::cpp2::ErrorCode::SUCCEEDED) {\n      resp.error_code_ref() = err;\n      return;\n    }\n\n    // \u2b50 \u91cd\u7f6e\u72b6\u6001\uff0c\u51c6\u5907\u63a5\u6536 snapshot\n    reset();  // \u6e05\u7406\u6240\u6709\u672c\u5730\u72b6\u6001\uff0c\u5305\u62ec WAL\n    status_ = Status::WAITING_SNAPSHOT;\n    lastSnapshotCommitId_ = req.get_committed_log_id();\n    lastSnapshotCommitTerm_ = req.get_committed_log_term();\n  }\n\n  // \u2b50 \u63d0\u4ea4 snapshot \u6570\u636e\u5230\u72b6\u6001\u673a\n  auto ret = commitSnapshot(req.get_rows(),\n                           req.get_committed_log_id(),\n                           req.get_committed_log_term(),\n                           req.get_done());\n\n  if (req.get_done()) {\n    // Snapshot \u63a5\u6536\u5b8c\u6210\n    committedLogId_ = req.get_committed_log_id();\n    committedLogTerm_ = req.get_committed_log_term();\n    lastLogId_ = committedLogId_;\n    lastLogTerm_ = committedLogTerm_;\n    status_ = Status::RUNNING;  // \u2b50 \u6062\u590d\u8fd0\u884c\u72b6\u6001\n\n    VLOG(1) &lt;&lt; idStr_ &lt;&lt; \"Receive all snapshot, committedLogId \" &lt;&lt; committedLogId_\n            &lt;&lt; \", committedLogTerm \" &lt;&lt; committedLogTerm_;\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#22-snapshot","title":"2.2 \u63d0\u4ea4 Snapshot \u6570\u636e\uff08\u5173\u952e\u90e8\u5206\uff09","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/Part.cpp:519</code></p> C++<pre><code>std::tuple&lt;nebula::cpp2::ErrorCode, int64_t, int64_t&gt; Part::commitSnapshot(\n    const std::vector&lt;std::string&gt;&amp; rows,\n    LogID committedLogId,\n    TermID committedLogTerm,\n    bool finished) {\n\n  auto batch = engine_-&gt;startBatchWrite();\n  int64_t count = 0;\n  int64_t size = 0;\n\n  for (auto&amp; row : rows) {\n    count++;\n    size += row.size();\n\n    // \u2b50 \u89e3\u7801 key-value \u5bf9\n    auto kv = decodeKV(row);\n\n    // \u26a0\ufe0f \u91cd\u8981\uff1a\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528 batch-&gt;put()\uff0c\u4e0d\u4f1a\u89e6\u53d1 VectorIndexWal \u5199\u5165\n    // \u56e0\u4e3a\u8fd9\u662f snapshot \u5b89\u88c5\u8fc7\u7a0b\uff0c\u4e0d\u662f\u65e5\u5fd7\u91cd\u653e\u8fc7\u7a0b\n    auto code = batch-&gt;put(kv.first, kv.second);\n    if (code != nebula::cpp2::ErrorCode::SUCCEEDED) {\n      VLOG(3) &lt;&lt; idStr_ &lt;&lt; \"Failed to call WriteBatch::put()\";\n      return {code, kNoSnapshotCount, kNoSnapshotSize};\n    }\n  }\n\n  if (finished) {\n    // \u8bb0\u5f55 committed log \u4fe1\u606f\n    auto code = putCommitMsg(batch.get(), committedLogId, committedLogTerm);\n    if (code != nebula::cpp2::ErrorCode::SUCCEEDED) {\n      return {code, kNoSnapshotCount, kNoSnapshotSize};\n    }\n  }\n\n  // \u2b50 \u63d0\u4ea4\u5230 RocksDB\uff08\u5305\u62ec vector column family\uff09\n  auto code = engine_-&gt;commitBatchWrite(std::move(batch),\n                                       FLAGS_rocksdb_disable_wal,\n                                       FLAGS_rocksdb_wal_sync,\n                                       true);\n  return {code, count, size};\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#3-snapshot_1","title":"3. Snapshot \u5b8c\u6210\u540e\u7684\u589e\u91cf\u65e5\u5fd7\u590d\u5236","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#31-leader","title":"3.1 Leader \u53d1\u9001\u589e\u91cf\u65e5\u5fd7","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/RaftPart.cpp:925</code></p> C++<pre><code>void RaftPart::replicateLogs(folly::EventBase* eb, AppendLogsIterator iter, /* ... */) {\n  // \u5411\u6240\u6709 Follower \u53d1\u9001\u65e5\u5fd7\n  collectNSucceeded(\n    gen::from(hosts) |\n    gen::map([=](std::shared_ptr&lt;Host&gt; hostPtr) {\n      return hostPtr-&gt;appendLogs(eb, currTerm, lastLogId, committedId, prevLogTerm, prevLogId);\n    }),\n    quorum_,  // \u9700\u8981\u591a\u6570\u6d3e\u786e\u8ba4\n    [](auto&amp; resp) { return resp.get_error_code() == nebula::cpp2::ErrorCode::SUCCEEDED; }\n  );\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#32-follower","title":"3.2 Follower \u63a5\u6536\u589e\u91cf\u65e5\u5fd7\u5e76\u91cd\u653e","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/RaftPart.cpp:1787</code></p> C++<pre><code>void RaftPart::processAppendLogRequest(const cpp2::AppendLogRequest&amp; req,\n                                       cpp2::AppendLogResponse&amp; resp) {\n  // \u8ffd\u52a0\u65e5\u5fd7\u5230 WAL\n  for (size_t i = 0; i &lt; req.get_log_str_list().size(); ++i) {\n    LogID logId = req.get_last_log_id_sent() + 1 + i;\n    wal_-&gt;appendLog(logId, req.get_current_term(), clusterId_, req.get_log_str_list()[i]);\n  }\n\n  // \u2b50 \u63d0\u4ea4\u53ef\u4ee5\u63d0\u4ea4\u7684\u65e5\u5fd7\uff08\u8fd9\u91cc\u4f1a\u89e6\u53d1 VectorIndexWal \u5199\u5165\uff09\n  LogID canCommit = std::min(lastLogId_, req.get_committed_log_id());\n  if (canCommit &gt; committedLogId_) {\n    auto walIt = wal_-&gt;iterator(committedLogId_ + 1, canCommit);\n    auto result = commitLogs(std::move(walIt), false, true);  // \u2b50 \u8c03\u7528\u6211\u4eec\u4fee\u6539\u7684 commitLogs\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#33-commitlogs-vector","title":"3.3 commitLogs \u5904\u7406 Vector \u6570\u636e\uff08\u6211\u4eec\u7684\u4fee\u6539\uff09","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/Part.cpp:234</code></p> C++<pre><code>std::tuple&lt;nebula::cpp2::ErrorCode, LogID, TermID&gt; Part::commitLogs(\n    std::unique_ptr&lt;LogIterator&gt; iter, bool wait, bool needLock) {\n\n  auto batch = engine_-&gt;startBatchWrite();\n\n  while (iter-&gt;valid()) {\n    auto log = iter-&gt;logMsg();\n\n    switch (log[sizeof(int64_t)]) {\n      case OP_PUT: {\n        auto pieces = decodeMultiValues(log);\n\n        if (NebulaKeyUtils::isVector(pieces[0].str())) {\n          // \u2b50 Vector \u6570\u636e\u7684\u7279\u6b8a\u5904\u7406\uff1a\u5148\u5199 VectorIndexWal\uff0c\u518d\u5199 RocksDB\n          if (vectorIndexWal_) {\n            auto vectorId = static_cast&lt;VectorID&gt;(std::hash&lt;std::string&gt;{}(pieces[0].str()));\n            auto appendResult = vectorIndexWal_-&gt;appendEntry(\n                vector::VectorWalOp::INSERT, vectorId, pieces[1]);\n\n            if (!appendResult.ok()) {\n              LOG(ERROR) &lt;&lt; idStr_ &lt;&lt; \"Failed to append vector entry to VectorIndexWal: \"\n                         &lt;&lt; appendResult.status().toString();\n              return {nebula::cpp2::ErrorCode::E_UNKNOWN, kNoCommitLogId, kNoCommitLogTerm};\n            }\n\n            VLOG(3) &lt;&lt; idStr_ &lt;&lt; \"Vector entry written to VectorIndexWal with LogID: \"\n                    &lt;&lt; appendResult.value();\n          }\n\n          // \u7136\u540e\u5199\u5165 vector column family\n          code = batch-&gt;put(NebulaKeyUtils::kVectorColumnFamilyName, pieces[0], pieces[1]);\n        } else {\n          code = batch-&gt;put(pieces[0], pieces[1]);\n        }\n        break;\n      }\n      // ... \u5176\u4ed6\u64cd\u4f5c\u7c7b\u578b\u7684\u5904\u7406\n    }\n    ++(*iter);\n  }\n\n  // \u6279\u91cf\u63d0\u4ea4\u5230 RocksDB\n  auto code = engine_-&gt;commitBatchWrite(std::move(batch));\n  return {code, lastId, lastTerm};\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_13","title":"\u5173\u952e\u5dee\u5f02\u5bf9\u6bd4","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#snapshot-vs","title":"Snapshot \u9636\u6bb5 vs \u589e\u91cf\u65e5\u5fd7\u9636\u6bb5","text":"\u9636\u6bb5 Vector \u6570\u636e\u5904\u7406\u65b9\u5f0f VectorIndexWal \u5199\u5165 \u4ee3\u7801\u4f4d\u7f6e Snapshot \u4f20\u8f93 \u76f4\u63a5\u5199\u5165 vector column family \u274c \u4e0d\u5199\u5165 <code>Part::commitSnapshot()</code> \u589e\u91cf\u65e5\u5fd7\u590d\u5236 \u5148\u5199 VectorIndexWal\uff0c\u518d\u5199 column family \u2705 \u5199\u5165 <code>Part::commitLogs()</code>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#snapshot-vectorindexwal","title":"\u4e3a\u4ec0\u4e48 Snapshot \u9636\u6bb5\u4e0d\u5199\u5165 VectorIndexWal\uff1f","text":"<ol> <li>\u6027\u80fd\u8003\u8651: Snapshot \u662f\u5168\u91cf\u6570\u636e\u4f20\u8f93\uff0c\u5982\u679c\u6bcf\u4e2a vector \u90fd\u5199 VectorIndexWal\uff0c\u4f1a\u4ea7\u751f\u5927\u91cf\u989d\u5916 I/O</li> <li>\u4e00\u81f4\u6027\u4fdd\u8bc1: Snapshot \u4ee3\u8868\u7684\u662f\u4e00\u4e2a\u4e00\u81f4\u6027\u72b6\u6001\u70b9\uff0c\u4e0d\u9700\u8981\u989d\u5916\u7684 WAL \u8bb0\u5f55</li> <li>\u91cd\u5efa\u673a\u5236: \u540e\u7eed\u7684\u589e\u91cf\u65e5\u5fd7\u4f1a\u786e\u4fdd VectorIndexWal \u7684\u5b8c\u6574\u6027</li> </ol>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#vector_1","title":"Vector \u7d22\u5f15\u72b6\u6001\u7684\u6700\u7ec8\u4e00\u81f4\u6027","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#1-snapshot","title":"1. Snapshot \u5b8c\u6210\u540e\u7684\u72b6\u6001","text":"Text Only<pre><code>\u65b0\u8282\u70b9\u72b6\u6001\uff1a\n- RocksDB vector column family: \u2705 \u5305\u542b\u6240\u6709 vector \u6570\u636e\n- VectorIndexWal: \u274c \u4e3a\u7a7a\uff08\u6ca1\u6709\u5386\u53f2\u8bb0\u5f55\uff09\n- Vector Index: \u274c \u9700\u8981\u91cd\u5efa\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#2_1","title":"2. \u589e\u91cf\u65e5\u5fd7\u590d\u5236\u540e\u7684\u72b6\u6001","text":"Text Only<pre><code>\u65b0\u8282\u70b9\u72b6\u6001\uff1a\n- RocksDB vector column family: \u2705 \u5305\u542b\u6700\u65b0 vector \u6570\u636e\n- VectorIndexWal: \u2705 \u5305\u542b snapshot \u540e\u7684\u6240\u6709 vector \u64cd\u4f5c\n- Vector Index: \u2705 \u53ef\u4ee5\u4ece VectorIndexWal \u91cd\u5efa + \u589e\u91cf\u66f4\u65b0\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#3-vector-index","title":"3. Vector Index \u91cd\u5efa\u7b56\u7565","text":"C++<pre><code>// \u5efa\u8bae\u7684\u91cd\u5efa\u903b\u8f91\nvoid rebuildVectorIndexAfterSnapshot() {\n  // \u65b9\u6848 1: \u4ece RocksDB \u91cd\u5efa\u6574\u4e2a\u7d22\u5f15\n  rebuildVectorIndexFromRocksDB();\n\n  // \u65b9\u6848 2: \u4ece VectorIndexWal \u91cd\u5efa\u589e\u91cf\u90e8\u5206\n  rebuildVectorIndexFromWal();\n\n  // \u65b9\u6848 3: \u6df7\u5408\u65b9\u6848\n  if (vectorIndexWal_-&gt;getStats().totalEntries &lt; threshold) {\n    // WAL \u8bb0\u5f55\u8f83\u5c11\uff0c\u4ece RocksDB \u5168\u91cf\u91cd\u5efa\n    rebuildVectorIndexFromRocksDB();\n  } else {\n    // WAL \u8bb0\u5f55\u8f83\u591a\uff0c\u589e\u91cf\u91cd\u5efa\n    rebuildVectorIndexFromWal();\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#vector-wal_1","title":"Vector WAL \u7684\u8bbe\u8ba1","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_14","title":"\u6982\u8ff0","text":"<p>\u5f53\u65b0\u8282\u70b9\u52a0\u5165\u96c6\u7fa4\u6216\u8282\u70b9\u91cd\u542f\u540e\u9700\u8981\u5927\u91cf\u6570\u636e\u540c\u6b65\u65f6\uff0cNebula \u4f7f\u7528 Snapshot \u673a\u5236\u8fdb\u884c\u5168\u91cf\u6570\u636e\u4f20\u8f93\u3002\u5bf9\u4e8e vector \u6570\u636e\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u786e\u4fdd\u4e86\u6570\u636e\u7684\u6b63\u786e\u4f20\u8f93\u548c\u540e\u7eed VectorIndexWal \u7684\u4e00\u81f4\u6027\u7ef4\u62a4\u3002</p>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_15","title":"\u5b8c\u6574\u6d41\u7a0b\u56fe","text":"Text Only<pre><code>Leader \u8282\u70b9                                \u65b0\u8282\u70b9 (Follower)\n     |                                         |\n     |-- \u68c0\u6d4b\u5230\u65b0\u8282\u70b9\u843d\u540e\u592a\u591a ------------------&gt;|\n     |                                         |-- \u8282\u70b9\u542f\u52a8\uff0cWAL \u4e3a\u7a7a\n     |                                         |\n     |==== Snapshot \u53d1\u9001\u9636\u6bb5 ====              |==== Snapshot \u63a5\u6536\u9636\u6bb5 ====\n     |                                         |\n     |-- accessAllRowsInSnapshot() -----------&gt;|\n     |    \u626b\u63cf\u6240\u6709\u6570\u636e\uff08\u5305\u62ec vector\uff09            |\n     |                                         |-- processSendSnapshotRequest()\n     |-- \u5206\u6279\u53d1\u9001\u6570\u636e -----------------------&gt;|-- \u9a8c\u8bc1 Leader \u8eab\u4efd\n     |    (SendSnapshotRequest)                |-- reset() \u6e05\u7406\u72b6\u6001\n     |                                         |-- status_ = WAITING_SNAPSHOT\n     |                                         |\n     |-- \u53d1\u9001 vector \u6570\u636e\u6279\u6b21 -----------------&gt;|-- commitSnapshot() \u63a5\u6536\u6570\u636e\n     |    key: vector key                     |    \u76f4\u63a5\u5199\u5165 vector column family\n     |    value: vector \u5411\u91cf\u6570\u636e               |    \u26a0\ufe0f \u4e0d\u89e6\u53d1 VectorIndexWal\n     |                                         |\n     |-- \u53d1\u9001\u5b8c\u6210\u6807\u8bb0 -----------------------&gt;|-- finished=true \u5b8c\u6210 snapshot\n     |    (finished=true)                     |-- \u66f4\u65b0 committedLogId/Term\n     |                                         |-- status_ = RUNNING\n     |                                         |\n     |==== \u589e\u91cf\u65e5\u5fd7\u590d\u5236\u9636\u6bb5 ====               |==== \u589e\u91cf\u65e5\u5fd7\u63a5\u6536\u9636\u6bb5 ====\n     |                                         |\n     |-- appendLogs() \u53d1\u9001\u65b0\u65e5\u5fd7 --------------&gt;|-- processAppendLogRequest()\n     |    \u5305\u542b\u65b0\u7684 vector \u64cd\u4f5c                 |-- \u63a5\u6536\u65b0 vector \u64cd\u4f5c\u65e5\u5fd7\n     |                                         |\n     |                                         |-- commitLogs() \u91cd\u653e\u65e5\u5fd7\n     |                                         |    \u2705 \u89e6\u53d1 VectorIndexWal \u5199\u5165\n     |                                         |    \u2705 \u5199\u5165 vector column family\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_16","title":"\u4ee3\u7801\u5b9e\u73b0\u8be6\u89e3","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#1-leader_1","title":"1. Leader \u7aef\uff1a\u6570\u636e\u626b\u63cf\u548c\u53d1\u9001","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#11-snapshot_1","title":"1.1 \u89e6\u53d1 Snapshot \u53d1\u9001","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/Host.cpp:349</code></p> C++<pre><code>nebula::cpp2::ErrorCode Host::startSendSnapshot() {\n  CHECK(!lock_.try_lock());\n  if (!sendingSnapshot_) {\n    VLOG(1) &lt;&lt; idStr_ &lt;&lt; \"Can't find log \" &lt;&lt; lastLogIdSent_ + 1 &lt;&lt; \" in wal, send the snapshot\"\n            &lt;&lt; \", logIdToSend = \" &lt;&lt; logIdToSend_\n            &lt;&lt; \", firstLogId in wal = \" &lt;&lt; part_-&gt;wal()-&gt;firstLogId()\n            &lt;&lt; \", lastLogId in wal = \" &lt;&lt; part_-&gt;wal()-&gt;lastLogId();\n\n    sendingSnapshot_ = true;\n    stats::StatsManager::addValue(kNumSendSnapshot);\n\n    // \u8c03\u7528 SnapshotManager \u53d1\u9001 snapshot\n    part_-&gt;snapshot_-&gt;sendSnapshot(part_, addr_)\n        .thenValue([self = shared_from_this()](auto&amp;&amp; status) {\n          // \u5904\u7406\u53d1\u9001\u7ed3\u679c\n        });\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#12-vector_1","title":"1.2 \u626b\u63cf\u6240\u6709\u6570\u636e\uff08\u5305\u62ec vector \u6570\u636e\uff09","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/NebulaSnapshotManager.cpp:32</code></p> C++<pre><code>void NebulaSnapshotManager::accessAllRowsInSnapshot(GraphSpaceID spaceId,\n                                                    PartitionID partId,\n                                                    raftex::SnapshotCallback cb) {\n  // \u83b7\u53d6\u5206\u533a\u548c RocksDB snapshot\n  auto partRet = store_-&gt;part(spaceId, partId);\n  auto snapshot = store_-&gt;GetSnapshot(spaceId, partId);\n\n  // \u83b7\u53d6 committed log \u4fe1\u606f\n  std::string val;\n  auto commitRet = part-&gt;engine()-&gt;get(NebulaKeyUtils::systemCommitKey(partId), &amp;val, snapshot);\n  LogID commitLogId;\n  TermID commitLogTerm;\n  memcpy(&amp;commitLogId, val.data(), sizeof(LogID));\n  memcpy(&amp;commitLogTerm, val.data() + sizeof(LogID), sizeof(TermID));\n\n  // \u626b\u63cf\u6240\u6709\u524d\u7f00\u7684\u6570\u636e\uff0c\u5305\u62ec vector \u6570\u636e\n  std::vector&lt;std::string&gt; prefixes{\n    NebulaKeyUtils::systemPrefix(),       // \u7cfb\u7edf\u6570\u636e\n    NebulaKeyUtils::tagPrefix(partId),    // Tag \u6570\u636e\n    NebulaKeyUtils::edgePrefix(partId),   // Edge \u6570\u636e\n    NebulaKeyUtils::vectorTagPrefix(partId),  // \u2b50 Vector Tag \u6570\u636e\n    NebulaKeyUtils::vectorEdgePrefix(partId), // \u2b50 Vector Edge \u6570\u636e\n    NebulaKeyUtils::indexPrefix(partId),  // \u7d22\u5f15\u6570\u636e\n    // ... \u5176\u4ed6\u524d\u7f00\n  };\n\n  for (const auto&amp; prefix : prefixes) {\n    bool hasData = accessTable(spaceId, partId, snapshot, prefix, cb,\n                              commitLogId, commitLogTerm, data, totalCount, totalSize, rateLimiter);\n    if (!hasData) break;\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#13_1","title":"1.3 \u5206\u6279\u53d1\u9001\u6570\u636e","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/SnapshotManager.cpp:121</code></p> C++<pre><code>folly::Future&lt;raftex::cpp2::SendSnapshotResponse&gt; SnapshotManager::send(\n    GraphSpaceID spaceId, PartitionID partId, TermID termId,\n    LogID committedLogId, TermID committedLogTerm,\n    const HostAddr&amp; localhost, const std::vector&lt;std::string&gt;&amp; data,\n    int64_t totalSize, int64_t totalCount,\n    const HostAddr&amp; addr, bool finished) {\n\n  // \u6784\u9020\u53d1\u9001\u8bf7\u6c42\n  raftex::cpp2::SendSnapshotRequest req;\n  req.space_ref() = spaceId;\n  req.part_ref() = partId;\n  req.current_term_ref() = termId;\n  req.committed_log_id_ref() = committedLogId;\n  req.committed_log_term_ref() = committedLogTerm;\n  req.leader_addr_ref() = localhost.host;\n  req.leader_port_ref() = localhost.port;\n  req.rows_ref() = data;  // \u2b50 \u5305\u542b vector \u6570\u636e\u7684\u884c\n  req.total_size_ref() = totalSize;\n  req.total_count_ref() = totalCount;\n  req.done_ref() = finished;\n\n  // \u53d1\u9001\u5230\u76ee\u6807\u8282\u70b9\n  return client-&gt;future_sendSnapshot(req);\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#2-follower-snapshot_1","title":"2. Follower \u7aef\uff1a\u63a5\u6536\u548c\u5b89\u88c5 Snapshot","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#21-snapshot_1","title":"2.1 \u63a5\u6536 Snapshot \u8bf7\u6c42","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/RaftPart.cpp:1956</code></p> C++<pre><code>void RaftPart::processSendSnapshotRequest(const cpp2::SendSnapshotRequest&amp; req,\n                                          cpp2::SendSnapshotResponse&amp; resp) {\n  std::lock_guard&lt;std::mutex&gt; g(raftLock_);\n\n  // \u68c0\u67e5\u72b6\u6001\u548c\u9a8c\u8bc1 Leader \u8eab\u4efd\n  if (status_ != Status::WAITING_SNAPSHOT) {\n    VLOG(2) &lt;&lt; idStr_ &lt;&lt; \"Begin to receive the snapshot\";\n\n    // \u9a8c\u8bc1 Leader \u8eab\u4efd\n    auto err = verifyLeader&lt;cpp2::SendSnapshotRequest&gt;(req);\n    if (err != nebula::cpp2::ErrorCode::SUCCEEDED) {\n      resp.error_code_ref() = err;\n      return;\n    }\n\n    // \u2b50 \u91cd\u7f6e\u72b6\u6001\uff0c\u51c6\u5907\u63a5\u6536 snapshot\n    reset();  // \u6e05\u7406\u6240\u6709\u672c\u5730\u72b6\u6001\uff0c\u5305\u62ec WAL\n    status_ = Status::WAITING_SNAPSHOT;\n    lastSnapshotCommitId_ = req.get_committed_log_id();\n    lastSnapshotCommitTerm_ = req.get_committed_log_term();\n  }\n\n  // \u2b50 \u63d0\u4ea4 snapshot \u6570\u636e\u5230\u72b6\u6001\u673a\n  auto ret = commitSnapshot(req.get_rows(),\n                           req.get_committed_log_id(),\n                           req.get_committed_log_term(),\n                           req.get_done());\n\n  if (req.get_done()) {\n    // Snapshot \u63a5\u6536\u5b8c\u6210\n    committedLogId_ = req.get_committed_log_id();\n    committedLogTerm_ = req.get_committed_log_term();\n    lastLogId_ = committedLogId_;\n    lastLogTerm_ = committedLogTerm_;\n    status_ = Status::RUNNING;  // \u2b50 \u6062\u590d\u8fd0\u884c\u72b6\u6001\n\n    VLOG(1) &lt;&lt; idStr_ &lt;&lt; \"Receive all snapshot, committedLogId \" &lt;&lt; committedLogId_\n            &lt;&lt; \", committedLogTerm \" &lt;&lt; committedLogTerm_;\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#22-snapshot_1","title":"2.2 \u63d0\u4ea4 Snapshot \u6570\u636e\uff08\u5173\u952e\u90e8\u5206\uff09","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/Part.cpp:519</code></p> C++<pre><code>std::tuple&lt;nebula::cpp2::ErrorCode, int64_t, int64_t&gt; Part::commitSnapshot(\n    const std::vector&lt;std::string&gt;&amp; rows,\n    LogID committedLogId,\n    TermID committedLogTerm,\n    bool finished) {\n\n  auto batch = engine_-&gt;startBatchWrite();\n  int64_t count = 0;\n  int64_t size = 0;\n\n  for (auto&amp; row : rows) {\n    count++;\n    size += row.size();\n\n    // \u2b50 \u89e3\u7801 key-value \u5bf9\n    auto kv = decodeKV(row);\n\n    // \u26a0\ufe0f \u91cd\u8981\uff1a\u8fd9\u91cc\u76f4\u63a5\u8c03\u7528 batch-&gt;put()\uff0c\u4e0d\u4f1a\u89e6\u53d1 VectorIndexWal \u5199\u5165\n    // \u56e0\u4e3a\u8fd9\u662f snapshot \u5b89\u88c5\u8fc7\u7a0b\uff0c\u4e0d\u662f\u65e5\u5fd7\u91cd\u653e\u8fc7\u7a0b\n    auto code = batch-&gt;put(kv.first, kv.second);\n    if (code != nebula::cpp2::ErrorCode::SUCCEEDED) {\n      VLOG(3) &lt;&lt; idStr_ &lt;&lt; \"Failed to call WriteBatch::put()\";\n      return {code, kNoSnapshotCount, kNoSnapshotSize};\n    }\n  }\n\n  if (finished) {\n    // \u8bb0\u5f55 committed log \u4fe1\u606f\n    auto code = putCommitMsg(batch.get(), committedLogId, committedLogTerm);\n    if (code != nebula::cpp2::ErrorCode::SUCCEEDED) {\n      return {code, kNoSnapshotCount, kNoSnapshotSize};\n    }\n  }\n\n  // \u2b50 \u63d0\u4ea4\u5230 RocksDB\uff08\u5305\u62ec vector column family\uff09\n  auto code = engine_-&gt;commitBatchWrite(std::move(batch),\n                                       FLAGS_rocksdb_disable_wal,\n                                       FLAGS_rocksdb_wal_sync,\n                                       true);\n  return {code, count, size};\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#3-snapshot_2","title":"3. Snapshot \u5b8c\u6210\u540e\u7684\u589e\u91cf\u65e5\u5fd7\u590d\u5236","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#31-leader_1","title":"3.1 Leader \u53d1\u9001\u589e\u91cf\u65e5\u5fd7","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/RaftPart.cpp:925</code></p> C++<pre><code>void RaftPart::replicateLogs(folly::EventBase* eb, AppendLogsIterator iter, /* ... */) {\n  // \u5411\u6240\u6709 Follower \u53d1\u9001\u65e5\u5fd7\n  collectNSucceeded(\n    gen::from(hosts) |\n    gen::map([=](std::shared_ptr&lt;Host&gt; hostPtr) {\n      return hostPtr-&gt;appendLogs(eb, currTerm, lastLogId, committedId, prevLogTerm, prevLogId);\n    }),\n    quorum_,  // \u9700\u8981\u591a\u6570\u6d3e\u786e\u8ba4\n    [](auto&amp; resp) { return resp.get_error_code() == nebula::cpp2::ErrorCode::SUCCEEDED; }\n  );\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#32-follower_1","title":"3.2 Follower \u63a5\u6536\u589e\u91cf\u65e5\u5fd7\u5e76\u91cd\u653e","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/raftex/RaftPart.cpp:1787</code></p> C++<pre><code>void RaftPart::processAppendLogRequest(const cpp2::AppendLogRequest&amp; req,\n                                       cpp2::AppendLogResponse&amp; resp) {\n  // \u8ffd\u52a0\u65e5\u5fd7\u5230 WAL\n  for (size_t i = 0; i &lt; req.get_log_str_list().size(); ++i) {\n    LogID logId = req.get_last_log_id_sent() + 1 + i;\n    wal_-&gt;appendLog(logId, req.get_current_term(), clusterId_, req.get_log_str_list()[i]);\n  }\n\n  // \u2b50 \u63d0\u4ea4\u53ef\u4ee5\u63d0\u4ea4\u7684\u65e5\u5fd7\uff08\u8fd9\u91cc\u4f1a\u89e6\u53d1 VectorIndexWal \u5199\u5165\uff09\n  LogID canCommit = std::min(lastLogId_, req.get_committed_log_id());\n  if (canCommit &gt; committedLogId_) {\n    auto walIt = wal_-&gt;iterator(committedLogId_ + 1, canCommit);\n    auto result = commitLogs(std::move(walIt), false, true);  // \u2b50 \u8c03\u7528\u6211\u4eec\u4fee\u6539\u7684 commitLogs\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#33-commitlogs-vector_1","title":"3.3 commitLogs \u5904\u7406 Vector \u6570\u636e\uff08\u6211\u4eec\u7684\u4fee\u6539\uff09","text":"<p>\u6587\u4ef6\u4f4d\u7f6e: <code>/home/lzy/my-nebula/src/kvstore/Part.cpp:234</code></p> C++<pre><code>std::tuple&lt;nebula::cpp2::ErrorCode, LogID, TermID&gt; Part::commitLogs(\n    std::unique_ptr&lt;LogIterator&gt; iter, bool wait, bool needLock) {\n\n  auto batch = engine_-&gt;startBatchWrite();\n\n  while (iter-&gt;valid()) {\n    auto log = iter-&gt;logMsg();\n\n    switch (log[sizeof(int64_t)]) {\n      case OP_PUT: {\n        auto pieces = decodeMultiValues(log);\n\n        if (NebulaKeyUtils::isVector(pieces[0].str())) {\n          // \u2b50 Vector \u6570\u636e\u7684\u7279\u6b8a\u5904\u7406\uff1a\u5148\u5199 VectorIndexWal\uff0c\u518d\u5199 RocksDB\n          if (vectorIndexWal_) {\n            auto vectorId = static_cast&lt;VectorID&gt;(std::hash&lt;std::string&gt;{}(pieces[0].str()));\n            auto appendResult = vectorIndexWal_-&gt;appendEntry(\n                vector::VectorWalOp::INSERT, vectorId, pieces[1]);\n\n            if (!appendResult.ok()) {\n              LOG(ERROR) &lt;&lt; idStr_ &lt;&lt; \"Failed to append vector entry to VectorIndexWal: \"\n                         &lt;&lt; appendResult.status().toString();\n              return {nebula::cpp2::ErrorCode::E_UNKNOWN, kNoCommitLogId, kNoCommitLogTerm};\n            }\n\n            VLOG(3) &lt;&lt; idStr_ &lt;&lt; \"Vector entry written to VectorIndexWal with LogID: \"\n                    &lt;&lt; appendResult.value();\n          }\n\n          // \u7136\u540e\u5199\u5165 vector column family\n          code = batch-&gt;put(NebulaKeyUtils::kVectorColumnFamilyName, pieces[0], pieces[1]);\n        } else {\n          code = batch-&gt;put(pieces[0], pieces[1]);\n        }\n        break;\n      }\n      // ... \u5176\u4ed6\u64cd\u4f5c\u7c7b\u578b\u7684\u5904\u7406\n    }\n    ++(*iter);\n  }\n\n  // \u6279\u91cf\u63d0\u4ea4\u5230 RocksDB\n  auto code = engine_-&gt;commitBatchWrite(std::move(batch));\n  return {code, lastId, lastTerm};\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#_17","title":"\u5173\u952e\u5dee\u5f02\u5bf9\u6bd4","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#snapshot-vs_1","title":"Snapshot \u9636\u6bb5 vs \u589e\u91cf\u65e5\u5fd7\u9636\u6bb5","text":"\u9636\u6bb5 Vector \u6570\u636e\u5904\u7406\u65b9\u5f0f VectorIndexWal \u5199\u5165 \u4ee3\u7801\u4f4d\u7f6e Snapshot \u4f20\u8f93 \u76f4\u63a5\u5199\u5165 vector column family \u274c \u4e0d\u5199\u5165 <code>Part::commitSnapshot()</code> \u589e\u91cf\u65e5\u5fd7\u590d\u5236 \u5148\u5199 VectorIndexWal\uff0c\u518d\u5199 column family \u2705 \u5199\u5165 <code>Part::commitLogs()</code>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#snapshot-vectorindexwal_1","title":"\u4e3a\u4ec0\u4e48 Snapshot \u9636\u6bb5\u4e0d\u5199\u5165 VectorIndexWal\uff1f","text":"<ol> <li>\u6027\u80fd\u8003\u8651: Snapshot \u662f\u5168\u91cf\u6570\u636e\u4f20\u8f93\uff0c\u5982\u679c\u6bcf\u4e2a vector \u90fd\u5199 VectorIndexWal\uff0c\u4f1a\u4ea7\u751f\u5927\u91cf\u989d\u5916 I/O</li> <li>\u4e00\u81f4\u6027\u4fdd\u8bc1: Snapshot \u4ee3\u8868\u7684\u662f\u4e00\u4e2a\u4e00\u81f4\u6027\u72b6\u6001\u70b9\uff0c\u4e0d\u9700\u8981\u989d\u5916\u7684 WAL \u8bb0\u5f55</li> <li>\u91cd\u5efa\u673a\u5236: \u540e\u7eed\u7684\u589e\u91cf\u65e5\u5fd7\u4f1a\u786e\u4fdd VectorIndexWal \u7684\u5b8c\u6574\u6027</li> </ol>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#vector_2","title":"Vector \u7d22\u5f15\u72b6\u6001\u7684\u6700\u7ec8\u4e00\u81f4\u6027","text":""},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#1-snapshot_1","title":"1. Snapshot \u5b8c\u6210\u540e\u7684\u72b6\u6001","text":"Text Only<pre><code>\u65b0\u8282\u70b9\u72b6\u6001\uff1a\n- RocksDB vector column family: \u2705 \u5305\u542b\u6240\u6709 vector \u6570\u636e\n- VectorIndexWal: \u274c \u4e3a\u7a7a\uff08\u6ca1\u6709\u5386\u53f2\u8bb0\u5f55\uff09\n- Vector Index: \u274c \u9700\u8981\u91cd\u5efa\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#2_2","title":"2. \u589e\u91cf\u65e5\u5fd7\u590d\u5236\u540e\u7684\u72b6\u6001","text":"Text Only<pre><code>\u65b0\u8282\u70b9\u72b6\u6001\uff1a\n- RocksDB vector column family: \u2705 \u5305\u542b\u6700\u65b0 vector \u6570\u636e\n- VectorIndexWal: \u2705 \u5305\u542b snapshot \u540e\u7684\u6240\u6709 vector \u64cd\u4f5c\n- Vector Index: \u2705 \u53ef\u4ee5\u4ece VectorIndexWal \u91cd\u5efa + \u589e\u91cf\u66f4\u65b0\n</code></pre>"},{"location":"projects/nebula-vsearch/implements/wal%20for%20vector%20type/#3-vector-index_1","title":"3. Vector Index \u91cd\u5efa\u7b56\u7565","text":"C++<pre><code>// \u5efa\u8bae\u7684\u91cd\u5efa\u903b\u8f91\nvoid rebuildVectorIndexAfterSnapshot() {\n  // \u65b9\u6848 1: \u4ece RocksDB \u91cd\u5efa\u6574\u4e2a\u7d22\u5f15\n  rebuildVectorIndexFromRocksDB();\n\n  // \u65b9\u6848 2: \u4ece VectorIndexWal \u91cd\u5efa\u589e\u91cf\u90e8\u5206\n  rebuildVectorIndexFromWal();\n\n  // \u65b9\u6848 3: \u6df7\u5408\u65b9\u6848\n  if (vectorIndexWal_-&gt;getStats().totalEntries &lt; threshold) {\n    // WAL \u8bb0\u5f55\u8f83\u5c11\uff0c\u4ece RocksDB \u5168\u91cf\u91cd\u5efa\n    rebuildVectorIndexFromRocksDB();\n  } else {\n    // WAL \u8bb0\u5f55\u8f83\u591a\uff0c\u589e\u91cf\u91cd\u5efa\n    rebuildVectorIndexFromWal();\n  }\n}\n</code></pre>"},{"location":"projects/nebula-vsearch/understanding/1.visitor%20pattern/","title":"Visitor Pattern","text":"2025-06-052025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/1.visitor%20pattern/#_1","title":"\u89c2\u5bdf\u8005\u8bbe\u8ba1\u6a21\u5f0f","text":"<p> \u7ea6 589 \u4e2a\u5b57  102 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> <p>\u8fd9\u79cd\u8bbe\u8ba1\u6a21\u5f0f\u5141\u8bb8\u4f60\u5728\u4e0d\u4fee\u6539\u73b0\u6709\u5bf9\u8c61\u7ed3\u6784\uff08\u7c7b\uff09\u7684\u524d\u63d0\u4e0b\uff0c\u5411\u8fd9\u4e9b\u7c7b\u6dfb\u52a0\u65b0\u7684\u64cd\u4f5c\u3002\u5b83\u901a\u8fc7\u5b9a\u4e49\u4e00\u4e2a\u65b0\u7684\u201c\u8bbf\u95ee\u8005\u201d\u7c7b\u6765\u5c01\u88c5\u8fd9\u4e9b\u65b0\u64cd\u4f5c\uff0c\u7136\u540e\u8ba9\u5bf9\u8c61\u7ed3\u6784\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\u201c\u63a5\u53d7\u201d\uff08accept\uff09\u8fd9\u4e2a\u8bbf\u95ee\u8005\uff0c\u4ece\u800c\u6267\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/1.visitor%20pattern/#_2","title":"\u4e3b\u8981\u7ec4\u6210\u90e8\u5206","text":"<ul> <li>\u8bbf\u95ee\u8005 (Visitor) \u63a5\u53e3/\u62bd\u8c61\u7c7b\uff1a\u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217 visit \u65b9\u6cd5\uff0c\u6bcf\u4e2a\u65b9\u6cd5\u5bf9\u5e94\u4e00\u4e2a\u5177\u4f53\u5143\u7d20\uff08ConcreteElement\uff09\u7c7b\u578b\u3002 <p>\u4f8b\u5982\uff1avisitConcreteElementA(elementA: ConcreteElementA)\uff0cvisitConcreteElementB(elementB: ConcreteElementB)\u3002\u8fd9\u4e2a\u63a5\u53e3\u7684\u5b9e\u73b0\u8005\uff08\u5177\u4f53\u8bbf\u95ee\u8005\uff09\u5c06\u5305\u542b\u5bf9\u4e0d\u540c\u7c7b\u578b\u5143\u7d20\u7684\u5177\u4f53\u64cd\u4f5c\u903b\u8f91\u3002</p> </li> <li>\u5177\u4f53\u8bbf\u95ee\u8005 (ConcreteVisitor)\uff1a\u5b9e\u73b0 Visitor \u63a5\u53e3\u3002\u6bcf\u4e00\u4e2a visit \u65b9\u6cd5\u90fd\u5b9e\u73b0\u4e86\u5bf9\u76f8\u5e94\u5177\u4f53\u5143\u7d20\u7c7b\u578b\u7684\u7279\u5b9a\u64cd\u4f5c\u3002\u4e00\u4e2a\u5177\u4f53\u8bbf\u95ee\u8005\u901a\u5e38\u4ee3\u8868\u4e00\u4e2a\u7279\u5b9a\u7684\u7b97\u6cd5\u6216\u4e00\u7ec4\u76f8\u5173\u7684\u64cd\u4f5c\u3002</li> <li>\u5143\u7d20 (Element) \u63a5\u53e3/\u62bd\u8c61\u7c7b\uff1a\u5b9a\u4e49\u4e86\u4e00\u4e2a accept(visitor: Visitor) \u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u4ee5\u4e00\u4e2a\u8bbf\u95ee\u8005\u5bf9\u8c61\u4f5c\u4e3a\u53c2\u6570\u3002\u8fd9\u4e2a\u65b9\u6cd5\u662f\u8fde\u63a5\u5143\u7d20\u548c\u8bbf\u95ee\u8005\u7684\u6865\u6881\u3002</li> <li>\u5177\u4f53\u5143\u7d20 (ConcreteElement)\uff1a\u5b9e\u73b0 Element \u63a5\u53e3\u3002\u5728\u5176 accept \u65b9\u6cd5\u4e2d\uff0c\u901a\u5e38\u4f1a\u8c03\u7528\u8bbf\u95ee\u8005\uff08visitor\uff09\u7684\u76f8\u5e94 visit \u65b9\u6cd5\uff0c\u5e76\u5c06\u81ea\u8eab\uff08this\uff09\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u8fc7\u53bb\u3002\u4f8b\u5982\uff1avisitor.visitConcreteElementA(this)\u3002\u5b83\u4eec\u901a\u5e38\u5305\u542b\u4e00\u4e9b\u6570\u636e\uff0c\u8bbf\u95ee\u8005\u4f1a\u4f7f\u7528\u8fd9\u4e9b\u6570\u636e\u8fdb\u884c\u64cd\u4f5c\u3002</li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/1.visitor%20pattern/#double-dispatch","title":"\u5de5\u4f5c\u6d41\u7a0b (Double Dispatch)","text":"<ol> <li>\u5ba2\u6237\u7aef\u521b\u5efa\u4e00\u4e2a\u5177\u4f53\u8bbf\u95ee\u8005\u5bf9\u8c61\uff0c\u5e76\u5c06\u5176\u4f20\u9012\u7ed9\u5bf9\u8c61\u7ed3\u6784\u4e2d\u7684\u67d0\u4e2a\u5143\u7d20\uff08\u6216\u6574\u4e2a\u5bf9\u8c61\u7ed3\u6784\uff09\u3002</li> <li>\u5143\u7d20\u8c03\u7528\u5176 accept(visitor) \u65b9\u6cd5\uff0c\u5c06\u81ea\u8eab\u4f20\u9012\u7ed9\u8bbf\u95ee\u8005\u3002</li> <li>\u5728 accept \u65b9\u6cd5\u5185\u90e8\uff0c\u5143\u7d20\u4f1a\u56de\u8c03\u8bbf\u95ee\u8005\u7684 visitConcreteElementX(this) \u65b9\u6cd5\u3002</li> <li>\u7b2c\u4e00\u6b21\u5206\u6d3e\uff1a\u8c03\u7528 element.accept(visitor)\u3002\u8fd9\u4e2a\u8c03\u7528\u4f1a\u6839\u636e element \u7684\u5b9e\u9645\u7c7b\u578b\uff08ConcreteElementA, ConcreteElementB \u7b49\uff09\u6765\u786e\u5b9a\u6267\u884c\u54ea\u4e2a accept \u65b9\u6cd5\u3002</li> <li>\u7b2c\u4e8c\u6b21\u5206\u6d3e\uff1a\u5728\u5177\u4f53\u5143\u7d20\u7684 accept \u65b9\u6cd5\u5185\u90e8\uff0c\u8c03\u7528 visitor.visitConcreteElementX(this)\u3002\u8fd9\u4e2a\u8c03\u7528\u4f1a\u6839\u636e visitor \u7684\u5b9e\u9645\u7c7b\u578b\uff08ConcreteVisitor1, ConcreteVisitor2 \u7b49\uff09\u4ee5\u53ca this \uff08\u5373\u5177\u4f53\u5143\u7d20\uff09\u7684\u7c7b\u578b\u6765\u786e\u5b9a\u6267\u884c\u54ea\u4e2a visit \u65b9\u6cd5\u3002</li> </ol>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/1.visitor%20pattern/#_3","title":"\u793a\u4f8b","text":"C++<pre><code>// \u5143\u7d20\u63a5\u53e3\ninterface Shape {\n    accept(visitor: visitor);\n}\n\n// \u5177\u4f53\u5143\u7d20\nclass Circle implements Shape {\n    radius: number;\n    constructor(radius: number) { this.radius = radius; }\n    accept(visitor: visitor) {\n        visitor.visitCircle(this);\n    }\n}\n\nclass Square implements Shape {\n    side: number;\n    constructor(side: number) { this.side = side; }\n    accept(visitor: visitor) {\n        visitor.visitSquare(this);\n    }\n}\n\n// \u8bbf\u95ee\u8005\u63a5\u53e3\ninterface visitor {\n    visitCircle(circle: Circle);\n    visitSquare(square: Square);\n}\n\n// \u5177\u4f53\u8bbf\u95ee\u8005\uff1a\u8ba1\u7b97\u9762\u79ef\nclass AreaCalculatorVisitor implements visitor {\n    visitCircle(circle: Circle) {\n        const area = Math.PI * circle.radius * circle.radius;\n        console.log(`Area of Circle: ${area}`);\n    }\n    visitSquare(square: Square) {\n        const area = square.side * square.side;\n        console.log(`Area of Square: ${area}`);\n    }\n}\n\n// \u5177\u4f53\u8bbf\u95ee\u8005\uff1a\u5bfc\u51fa\u4e3aXML\nclass XMLExportVisitor implements visitor {\n    visitCircle(circle: Circle) {\n        console.log(`&lt;circle radius=\"${circle.radius}\"/&gt;`);\n    }\n    visitSquare(square: Square) {\n        console.log(`&lt;square side=\"${square.side}\"/&gt;`);\n    }\n}\n\n// \u5bf9\u8c61\u7ed3\u6784 (\u7b80\u5355\u5217\u8868)\nconst shapes: Shape[] = [\n    new Circle(5),\n    new Square(4)\n];\n\n// \u4f7f\u7528\nconst areaCalculator = new AreaCalculatorVisitor();\nconst xmlExporter = new XMLExportVisitor();\n\nconsole.log(\"Calculating areas:\");\nfor (const shape of shapes) {\n    shape.accept(areaCalculator);\n}\n\nconsole.log(\"\\nExporting to XML:\");\nfor (const shape of shapes) {\n    shape.accept(xmlExporter);\n}\n\n// \u8f93\u51fa:\n// Calculating areas:\n// Area of Circle: 78.53981633974483\n// Area of Square: 16\n//\n// Exporting to XML:\n// &lt;circle radius=\"5\"/&gt;\n// &lt;square side=\"4\"/&gt;\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/1.visitor%20pattern/#nebula-visitor-pattern","title":"nebula \u4e2d\u7684 visitor pattern","text":"<ul> <li>nebula \u5c06 Expression \u7c7b\u4f5c\u4e3a element\uff0c\u5c06 find\uff0cevaluate \u7b49\u529f\u80fd\u53d8\u6210 visitor \u63a5\u53e3\u7684\u5b9e\u73b0\u7c7b\uff0c\u5b9e\u73b0\u4e86 visitor pattern\u3002</li> </ul> C++<pre><code>// interface\nclass ExprVisitorImpl : public ExprVisitor {\n public:\n  // leaf expression nodes\n  void visit(ConstantExpression *) override {}\n};\n\n// implement interface\nclass EvaluableExprVisitor : public ExprVisitorImpl {\n  using ExprVisitorImpl::visit;\n\n  void visit(ConstantExpression *) override;\n\n  bool isEvaluable_{true};\n  const QueryContext *qctx_{nullptr};\n};\n\n// element\nclass ConstantExpression : public Expression {\n  friend class Expression;\n  void accept(ExprVisitor* visitor) override;\n private:\n  Value val_;\n};\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/2.memory%20management/","title":"Memory Management in nebula","text":"2025-06-052025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/2.memory%20management/#_1","title":"\u603b\u4f53\u6846\u67b6","text":"<p> \u7ea6 190 \u4e2a\u5b57  7 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> <p>nebula \u5185\u90e8\u7684\u5185\u5b58\u7ba1\u7406\u7531 ObjectPool \u8d1f\u8d23\uff0c\u4f7f\u7528\u6a21\u677f\u5316\u7f16\u7a0b\u65b9\u5f0f\u3002ObjectPool \u4e2d\u5b9e\u9645\u8d1f\u8d23\u5185\u5b58\u5206\u914d\u7684\u662f Arena \u7c7b\uff0c\u53e6\u5916\u8fd8\u4fdd\u5b58\u6240\u6709\u5c0f\u5bf9\u8c61\u7684\u8d77\u59cb\u5730\u5740\u3002</p> <p></p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/2.memory%20management/#arena","title":"Arena","text":"<p>Arena \u662f\u5b9e\u9645\u4e0a\u662f\u5185\u5b58\u6c60\u5206\u914d\u5668\uff0c\u8be5\u5206\u914d\u5668\u7684\u6700\u5c0f\u5355\u5143\u662f chunk\uff0c\u7cfb\u7edf\u5185\u53ea\u4f1a\u5b58\u5728\u4e00\u4e2a current chunk\uff0c\u5f85\u5206\u914d\u6ee1\u6216\u8005\u4e0d\u591f\u5206\u914d\u65f6\u5c31\u4f1a\u7533\u8bf7\u65b0\u7684 chunk\uff0c\u7136\u540e\u5c06\u524d\u9762\u7684 chunk \u548c\u65b0\u7684 chunk \u901a\u8fc7\u94fe\u8868\u8fde\u63a5\u8d77\u6765\uff0c\u65b9\u4fbf\u540e\u7eed\u56de\u6536\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/2.memory%20management/#chunk","title":"Chunk","text":"<p>\u5185\u5b58\u6c60\u5206\u914d\u7684\u6700\u5c0f\u5355\u5143\uff0c\u5206\u914d\u4f7f\u7528 new \u6765\u5206\u914d\u56fa\u5b9a\u5b57\u8282\u7684\u5185\u5b58\u3002</p> C++<pre><code>void newChunk(std::size_t size) {\n  DCHECK_NE(size, 0);\n  std::byte *ptr = new std::byte[size + sizeof(Chunk)];\n  currentChunk_ = new (ptr) Chunk(currentChunk_);\n  availableSize_ = size;\n  currentPtr_ = (ptr + sizeof(Chunk));\n}\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/3.concurrent%20lru%20cache/","title":"Concurrent LRU Cache","text":"2025-06-052025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/3.concurrent%20lru%20cache/#concurrent-lru-cache","title":"Concurrent LRU Cache","text":"<p> \u7ea6 202 \u4e2a\u5b57  3 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> <p>\u5b9e\u9645\u4e0a\u5e76\u53d1 LRU Cache \u662f\u7531\u591a\u4e2a LRU Cache \u7ec4\u6210\u7684\uff0c\u6bcf\u4e2a LRU Cache \u548c\u4e00\u628a lock \u7ec4\u6210\u4e00\u4e2a Bucket\uff0cConcurrent LRU Cache \u5b9e\u9645\u4e0a\u5c31\u662f Bucket \u6570\u7ec4\u3002\u6bcf\u4e2a LRU Cache \u7531\u81ea\u5df1\u7684\u9501\u4fdd\u62a4\uff0c\u4f7f\u7528 hash \u6765\u5b9e\u73b0 bucket \u5e76\u53d1\uff0c\u9501\u53ea\u5728 bucket \u8fd9\u4e2a\u7c92\u5ea6\u4e0a\u3002</p> <p></p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/3.concurrent%20lru%20cache/#lru-cache","title":"LRU Cache","text":"<p>\u76f8\u8f83\u4e8e\u6807\u51c6\u7684 map + \u94fe\u8868\u5b9e\u73b0\uff0cnebula \u7528 <code>std::unordered_map&lt;K, std::pair&lt;V, typename std::list&lt;K&gt;::iterator&gt;&gt;</code> \u66ff\u4ee3<code>std::map</code>\uff0c\u901a\u8fc7\u4e00\u4e2a\u6307\u5411\u5728\u94fe\u8868\u4e2d\u5bf9\u5e94\u952e\u7684\u8fed\u4ee3\u5668\u5b9e\u73b0 O(1)\u65f6\u95f4\u590d\u6742\u5ea6\u66f4\u65b0\u3002std::unordered_map \u66ff\u6362\u4e86 std::map\uff0c\u610f\u5473\u7740\u67e5\u627e\u3001\u63d2\u5165\u3001\u5220\u9664\u7684\u5e73\u5747\u65f6\u95f4\u590d\u6742\u5ea6\u4ece O(log N)\u63d0\u5347\u5230\u4e86 O(1)\uff0c\u4f46\u727a\u7272\u4e86\u952e\u7684\u6709\u5e8f\u6027\uff08LRU \u7f13\u5b58\u901a\u5e38\u4e0d\u9700\u8981\uff09\u3002</p> <p></p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/4.folly%20future%20promise/","title":"Folly \u5f02\u6b65\u7f16\u7a0b\u6846\u67b6","text":"2025-06-062025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/4.folly%20future%20promise/#folly","title":"Folly \u5f02\u6b65\u7f16\u7a0b\u6846\u67b6","text":"<p> \u7ea6 1030 \u4e2a\u5b57  27 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> <p>Folly \u7684\u5f02\u6b65\u7f16\u7a0b\u6a21\u578b\u56f4\u7ed5 Futures\u3001Promises \u548c EventBase \u5c55\u5f00\u3002\u8be5\u7cfb\u7edf\u63d0\u4f9b\u4e86\u4e00\u79cd\u5f3a\u5927\u7684\u65b9\u5f0f\u6765\u7f16\u5199\u975e\u963b\u585e\u4ee3\u7801\uff0c\u9ad8\u6548\u5904\u7406\u5e76\u53d1\u3002</p> <p></p> <ol> <li>\u975e\u963b\u585e\u8c03\u7528\uff1astorageClient-&gt;getProps() \u662f\u975e\u963b\u585e\u7684\u3002\u5b83\u542f\u52a8\u5f02\u6b65\u64cd\u4f5c\u5e76\u7acb\u5373\u8fd4\u56de\u4e00\u4e2a Future\u3002\u8c03\u7528 getProps \u7684\u7ebf\u7a0b\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\u5176\u4ed6\u4efb\u52a1\uff0c\u800c\u4e0d\u7528\u7b49\u5f85\u7f51\u7edc I/O \u548c\u5b58\u50a8\u5c42\u5904\u7406\u5b8c\u6210\u3002</li> <li>Future \u4f5c\u4e3a\u5360\u4f4d\u7b26\uff1afolly::Future \u662f\u4e00\u4e2a\u5360\u4f4d\u7b26\uff0c\u4ee3\u8868\u7c7b\u578b\u4e3a T \u7684\u64cd\u4f5c\u6700\u7ec8\u7684\u7ed3\u679c\u3002</li> <li>Promise (\u9690\u85cf\u7684)\uff1a\u5728 StorageClient::getProps \u5185\u90e8\uff0c\u5f53\u5f02\u6b65\u64cd\u4f5c\uff08\u5982\u7f51\u7edc\u8bf7\u6c42\u53d1\u9001\uff09\u88ab\u53d1\u8d77\u540e\uff0c\u5b83\u4f1a\u4e0e\u4e00\u4e2a folly::Promise \u76f8\u5173\u8054\u3002\u5f53\u5b58\u50a8\u5c42\u7684\u54cd\u5e94\u5230\u8fbe\u65f6\uff0c\u67d0\u4e2a\u7ec4\u4ef6\u4f1a\u8d1f\u8d23\u8c03\u7528\u8fd9\u4e2a Promise \u7684 setValue(response) \u6216 setException(error) \u65b9\u6cd5\u3002\u8fd9\u4f1a\u4f7f\u5bf9\u5e94\u7684 Future \u5b8c\u6210\u3002</li> <li>\u94fe\u5f0f\u56de\u8c03 (.via().thenValue())\uff1a    - .via(executor) \u63a7\u5236\u56de\u8c03\u5728\u54ea\u4e2a\u7ebf\u7a0b\u6267\u884c\u3002    - .thenValue(callback) \u6ce8\u518c\u4e00\u4e2a\u5f53 Future \u6210\u529f\u5b8c\u6210\u65f6\u8981\u6267\u884c\u7684\u51fd\u6570\u3002\u5982\u679c Future \u5931\u8d25\uff08\u5373 Promise \u88ab setException\uff09\uff0c.thenValue \u7684\u56de\u8c03\u5c06\u88ab\u8df3\u8fc7\uff0cFolly \u4f1a\u5bfb\u627e\u94fe\u4e2d\u7684\u9519\u8bef\u5904\u7406\u5668\uff08\u5982 .thenError()\uff09\u3002    - \u56de\u8c03\u53ef\u4ee5\u8fd4\u56de\u4e00\u4e2a\u666e\u901a\u503c\uff08\u4f1a\u88ab\u5305\u88c5\u6210\u65b0\u7684 Future\uff09\u6216\u53e6\u4e00\u4e2a Future\uff08Folly \u4f1a\u81ea\u52a8\u201c\u6241\u5e73\u5316\u201d\u5b83\uff0c\u5373 Future\\&gt; \u53d8\u6210 Future\uff09\u3002</li> <li>\u6570\u636e\u6d41\u548c\u63a7\u5236\u6d41\u5206\u79bb\uff1a\u4ee3\u7801\u7684\u7ed3\u6784\u6e05\u6670\u5730\u5206\u79bb\u4e86\u201c\u53d1\u8d77\u8bf7\u6c42\u201d\u548c\u201c\u5904\u7406\u7ed3\u679c\u201d\u3002\u5904\u7406\u7ed3\u679c\u7684\u903b\u8f91\uff08handlePropResp\uff09\u88ab\u5c01\u88c5\u5728\u56de\u8c03\u4e2d\uff0c\u53ea\u6709\u5f53\u6570\u636e\u5b9e\u9645\u53ef\u7528\u65f6\u624d\u6267\u884c\u3002</li> <li>\u9519\u8bef\u5904\u7406 (\u9690\u5f0f)\uff1a\u5982\u679c storageClient-&gt;getProps() \u5185\u90e8\u53d1\u751f\u9519\u8bef\uff0c\u6216\u8005 Promise \u88ab setException\uff0c\u90a3\u4e48 getProps \u8fd4\u56de\u7684 Future \u5c06\u4f1a\u5931\u8d25\u3002.thenValue \u7684\u56de\u8c03\u4e0d\u4f1a\u6267\u884c\u3002\u5982\u679c\u8c03\u7528\u8005\u5728 getProps \u8fd4\u56de\u7684 Future \u4e0a\u94fe\u63a5\u4e86 .thenError()\uff0c\u90a3\u4e48\u9519\u8bef\u5904\u7406\u56de\u8c03\u4f1a\u88ab\u89e6\u53d1\u3002\u5982\u679c handlePropResp \u5185\u90e8\u629b\u51fa\u5f02\u5e38\uff0c\u90a3\u4e48\u7531 .thenValue \u8fd4\u56de\u7684 Future\\&gt; \u5c06\u4f1a\u5931\u8d25\uff0c\u5e76\u643a\u5e26\u8fd9\u4e2a\u5f02\u5e38\u3002</li> </ol>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/4.folly%20future%20promise/#nebula","title":"nebula \u4e2d\u7684\u793a\u4f8b","text":"<p>graphd \u8282\u70b9\u901a\u8fc7 rpc \u5411 stroaged \u8282\u70b9\u8bf7\u6c42\u670d\u52a1\uff0c\u6574\u4e2a\u8fc7\u7a0b\u4e3a\u4e86\u4e0d\u963b\u788d\u5176\u4ed6\u670d\u52a1\u8fc7\u7a0b\uff0c\u90fd\u662f\u5f02\u6b65\u5316\u7684\u3002 stroaged \u8282\u70b9\u4e2d\u7684 executor \u4e2d\u5b58\u5728\u5982\u4e0b\u65b9\u6cd5:</p> <ul> <li>getFuture: \u8fd4\u56de promise \u5bf9\u5e94\u7684 Future</li> <li>onFinished: \u4e3b\u8981\u662f\u5bf9 promise \u8fdb\u884c setvalue \u64cd\u4f5c</li> </ul> C++<pre><code>folly::Future&lt;RESP&gt; getFuture() {\n  return promise_.getFuture();\n}\n\nthis-&gt;promise_.setValue(std::move(this-&gt;resp_));\n</code></pre> <p>graphd \u5bf9\u5e94\u7aef\u5b58\u5728\u76f8\u5e94\u7684 executor\uff0c\u8d1f\u8d23\u5411 storaged \u8282\u70b9\u53d1\u9001\u8bf7\u6c42\u5e76\u8fd4\u56de Future\uff0c\u5b9e\u73b0\u5f02\u6b65\u6267\u884c\u3002\u3001 Future \u7684\u6267\u884c\u5668\u662f\u5728 request context \u4e2d\u8bbe\u7f6e\u7684\u3002</p> C++<pre><code>folly::Future&lt;std::vector&lt;Value&gt;&gt; StorageAccessExecutor::getProps(\n    const std::vector&lt;Value&gt; &amp;vids, const std::vector&lt;VertexProp&gt; *vertexPropPtr) {\n  nebula::DataSet vertices({kVid});\n  vertices.rows.reserve(vids.size());\n  for (auto &amp;vid : vids) {\n    vertices.emplace_back(Row({vid}));\n  }\n  StorageClient *storageClient = qctx_-&gt;getStorageClient();\n  StorageClient::CommonRequestParam param(qctx_-&gt;rctx()-&gt;session()-&gt;space().id,\n                                          qctx_-&gt;rctx()-&gt;session()-&gt;id(),\n                                          qctx_-&gt;plan()-&gt;id(),\n                                          qctx_-&gt;plan()-&gt;isProfileEnabled());\n  return DCHECK_NOTNULL(storageClient)\n      -&gt;getProps(\n          param, std::move(vertices), vertexPropPtr, nullptr, nullptr, false, {}, -1, nullptr)\n      .via(runner())\n      .thenValue([this](PropRpcResponse &amp;&amp;resp) {\n        memory::MemoryCheckGuard guard;\n        addStats(resp);\n        return handlePropResp(std::move(resp));\n      });\n}\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/4.folly%20future%20promise/#_1","title":"\u8be6\u7ec6\u6d41\u7a0b","text":"<ol> <li>storageClient-&gt;getProps(...): \u8fd9\u662f\u5173\u952e\u7684\u5f02\u6b65\u8c03\u7528\u3002</li> </ol> <ul> <li>\u8fd9\u4e2a\u65b9\u6cd5\u5e76\u4e0d\u76f4\u63a5\u8fd4\u56de\u5c5e\u6027\u6570\u636e\u3002\u76f8\u53cd\uff0c\u5b83\u7acb\u5373\u8fd4\u56de\u4e00\u4e2a folly::Future\u3002</li> <li>\u8fd9\u4e2a Future \u4ee3\u8868\u4e00\u4e2a\u201c\u627f\u8bfa\u201d\u2014\u2014\u5728\u672a\u6765\u7684\u67d0\u4e2a\u65f6\u523b\uff0c\u5f53\u5b58\u50a8\u5c42\u5904\u7406\u5b8c\u8bf7\u6c42\u5e76\u8fd4\u56de\u54cd\u5e94\u540e\uff0c\u8fd9\u4e2a Future \u5c06\u4f1a\u5305\u542b PropRpcResponse \u7c7b\u578b\u7684\u7ed3\u679c\uff08\u6216\u8005\u4e00\u4e2a\u5f02\u5e38\uff0c\u5982\u679c\u51fa\u9519\u4e86\uff09\u3002</li> </ul> <ol> <li>.via(runner()): \u8fd9\u662f Folly Future \u7684\u4e00\u4e2a\u94fe\u5f0f\u64cd\u4f5c\u3002</li> </ol> <ul> <li>runner() \u5e94\u8be5\u8fd4\u56de\u4e00\u4e2a folly::Executor* \u5b9e\u4f8b\u3002Executor \u5b9a\u4e49\u4e86\u540e\u7eed\u7684\u56de\u8c03\uff08\u5373 .thenValue \u4e2d\u7684 lambda\uff09\u5c06\u5728\u54ea\u4e2a\u7ebf\u7a0b\u6216\u7ebf\u7a0b\u6c60\u4e0a\u6267\u884c\u3002</li> <li>\u7ebf\u7a0b\u5207\u6362\uff1aRPC \u54cd\u5e94\u53ef\u80fd\u5728\u4e00\u4e2a I/O \u7ebf\u7a0b\uff08\u4f8b\u5982\u7f51\u7edc\u5e93\u7684\u7ebf\u7a0b\uff09\u4e0a\u5230\u8fbe\u3002.via(runner()) \u53ef\u4ee5\u5c06\u540e\u7eed\u7684\u5904\u7406\u903b\u8f91\u5207\u6362\u5230\u4e00\u4e2a\u4e13\u95e8\u7684\u5de5\u4f5c\u7ebf\u7a0b\u6c60\uff08\u7531 runner() \u63d0\u4f9b\uff09\uff0c\u907f\u514d\u963b\u585e I/O \u7ebf\u7a0b\u3002</li> <li>\u4e0a\u4e0b\u6587\u7ba1\u7406\uff1a\u786e\u4fdd\u56de\u8c03\u5728\u5177\u6709\u6b63\u786e\u4e0a\u4e0b\u6587\uff08\u5982\u7279\u5b9a\u7684 EventBase \u6216\u4e0e\u5f53\u524d\u8bf7\u6c42\u5173\u8054\u7684\u6267\u884c\u73af\u5883\uff09\u7684\u7ebf\u7a0b\u4e0a\u6267\u884c\u3002</li> </ul> <ol> <li>.thenValue([this](PropRpcResponse &amp;&amp;resp) { ... }): \u8fd9\u662f\u53e6\u4e00\u4e2a\u94fe\u5f0f\u64cd\u4f5c\uff0c\u7528\u4e8e\u6ce8\u518c\u4e00\u4e2a\u6210\u529f\u56de\u8c03\u3002</li> </ol> <ul> <li>\u5f53 storageClient-&gt;getProps(...) \u8fd4\u56de\u7684 Future \u6210\u529f\u5b8c\u6210\u65f6\uff08\u5373\u5b58\u50a8\u5c42\u6210\u529f\u8fd4\u56de\u4e86 PropRpcResponse\uff09\uff0c\u8fd9\u4e2a lambda \u51fd\u6570\u5c06\u88ab\u6267\u884c\u3002</li> <li>\u56de\u8c03\u7684\u8fd4\u56de\u503c\uff1a<ul> <li>handlePropResp(std::move(resp)) \u88ab\u8c03\u7528\u3002\u8fd9\u4e2a\u51fd\u6570\u672c\u8eab\u8fd4\u56de std::vector\u3002</li> <li>\u7531\u4e8e .thenValue \u7684\u56de\u8c03\u8fd4\u56de\u4e86\u4e00\u4e2a std::vector\uff0c\u6240\u4ee5\u6574\u4e2a storageClient-&gt;getProps(...).via(...).thenValue(...) \u8868\u8fbe\u5f0f\u7684\u7ed3\u679c\u662f\u4e00\u4e2a\u65b0\u7684 folly::Future\\&gt;\u3002</li> <li>Folly \u6846\u67b6\u4f1a\u81ea\u52a8\u5c06 handlePropResp \u7684\u8fd4\u56de\u503c\u5305\u88c5\u8fdb\u4e00\u4e2a\u65b0\u7684 Future\u3002</li> </ul> </li> </ul> <ol> <li>\u51fd\u6570\u8fd4\u56de\u503c: getProps \u51fd\u6570\u6700\u7ec8\u8fd4\u56de\u7684\u5c31\u662f\u7531 .thenValue \u4ea7\u751f\u7684 folly::Future\\&gt;\u3002\u8c03\u7528\u8005\u5c06\u5f97\u5230\u8fd9\u4e2a Future\uff0c\u5e76\u53ef\u4ee5\u8fdb\u4e00\u6b65\u94fe\u63a5\u5176\u4ed6\u56de\u8c03\u6216\u7b49\u5f85\u5176\u5b8c\u6210\u3002</li> </ol>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/","title":"\u4e00\u6761nGQL\u8bed\u53e5\u7684\u524d\u4e16\u4eca\u751f","text":"2025-06-062025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/#ngql","title":"\u4e00\u6761 nGQL \u8bed\u53e5\u7684\u524d\u4e16\u4eca\u751f","text":"<p> \u7ea6 932 \u4e2a\u5b57  216 \u884c\u4ee3\u7801  4 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> <ol> <li>\u7528\u6237\u5728 console \u6216\u8005\u901a\u8fc7 sdk \u8f93\u5165 Query \u8bed\u53e5\u5230 Graph Service\uff0c\u8fd4\u56de\u7ed9\u7528\u6237 Future\uff0c\u7136\u540e\u5f00\u59cb\u6267\u884c\u56de\u8c03\uff0c\u5373\u4e0b\u9762\u7684\u6574\u4e2a\u6d41\u7a0b\u3002</li> <li>Graph Service \u5c06 Query\u3001Session\u3001Storage \u7b49\u6253\u5305\u6210 Request Context\uff0c\u968f\u540e\u5c06 Request Context \u6253\u5305\u6210 Query Context\uff0c\u521b\u5efa Query Instance \u968f\u540e\u5f00\u59cb\u6267\u884c parse\u3001validate\u3001optimize\u3001execute \u6574\u4e2a\u6d41\u7a0b\u3002    - \u5728 validate \u7ed3\u675f\u540e\uff0c\u9996\u5148\u5148\u83b7\u53d6 statement \u5bf9\u5e94\u7684 ast context\uff0c\u7136\u540e\u518d\u8f6c\u6362\u6210 plan node tree\u3002    - \u5728 Graph Service \u83b7\u53d6\u5230 query \u5e76\u542f\u52a8\u6574\u4e2a\u5f02\u6b65\u6267\u884c\u6d41\u7a0b\u540e\uff0c\u8fd4\u56de Future \u7ed9 client\u3002</li> <li>\u7136\u540e\u5c06 Request Context \u4f20\u5165 Scheduler\uff0c\u7528 Scheduler \u7684\u5185\u5b58\u6c60\u6309\u7167\u7b97\u5b50\u6811\u4f9d\u6b21\u6267\u884c\u6bcf\u4e2a\u7269\u7406\u8282\u70b9\u8ba1\u5212\u3002</li> <li>\u6bcf\u4e2a\u7269\u7406\u8282\u70b9\u8ba1\u5212\u5728 graphd \u4e2d\u5b58\u5728\u4e00\u4e2a executor\uff0c\u5b9e\u9645\u4e0a\u91cc\u9762\u8c03\u7528\u4e86 storaged \u7684 processor\u3002</li> <li>\u6bcf\u4e2a processor \u5185\u90e8\u4ece RocksDB \u4e2d\u83b7\u53d6\u6216\u8005\u5b58\u50a8 KV \u5bf9\uff0c\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 raft-wal \u8fdb\u884c\u96c6\u7fa4\u95f4\u7684\u540c\u6b65\uff0c\u7136\u540e\u7528\u7ed3\u679c\u53bb\u8bbe\u7f6e promise\uff0cgraphd \u7684 future \u63a5\u6536\u5230\u540e\u7ee7\u7eed\u5411\u4e0a\u4f20\u9012\u7ed3\u679c\uff0c\u76f4\u5230\u8fd4\u56de\u7ed9 client \u7684\u7ed3\u679c\u3002</li> </ol> <p></p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/#contexts","title":"Contexts","text":"","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/#query-context","title":"Query Context","text":"<p>Query\u3001Session\u3001Storage \u7b49\u6253\u5305\u6210 Request Context\uff0c\u968f\u540e\u5c06 Request Context \u6253\u5305\u6210 Query Context</p> <p>Query Context \u7684\u751f\u547d\u5468\u671f\u4ece\u8bed\u53e5\u4f20\u5165 graphd \u5f00\u59cb\uff0c\u5230\u5411 client \u8fd4\u56de\u7ed3\u679c</p> C++<pre><code>RequestContextPtr rctx_;                    // Session \u4f20\u5165\nstd::unique_ptr&lt;ValidateContext&gt; vctx_;     // validate \u4fee\u6539\nstd::unique_ptr&lt;ExecutionContext&gt; ectx_;    // Execution \u4fee\u6539\nstd::unique_ptr&lt;ExecutionPlan&gt; ep_;         // planner \u4fee\u6539\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/#createschemacontext","title":"CreateSchemaContext","text":"<p>CreateTagValidator \u81ea\u5df1\u62e5\u6709\u7684\u4e0a\u4e0b\u6587\uff0c\u7528\u4e8e\u5c06 Sentence \u8f6c\u53d8\u4e3a Plan\uff0c\u91cc\u9762\u662f\u9700\u8981\u4f20\u9012\u7ed9 CreateTagNode \u7684\u53c2\u6570\u3002</p> <p>Validator \u81ea\u5df1\u72ec\u6709\u7684 Context\uff0c\u751f\u547d\u5468\u671f\u53ea\u5728 Validator \u751f\u6210\u5230\u8f6c\u6362\u4e3a Logical Plan</p> C++<pre><code>struct CreateSchemaContext final : public AstContext {\nbool ifNotExist{false};\nstd::string name;\nmeta::cpp2::Schema schema;\n};\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/#client","title":"Client","text":"<p>client \u901a\u8fc7 tcp \u6765\u8fde\u63a5\u5230 graphd\uff0c\u901a\u8fc7 libevent \u6765\u4e0e graphd \u8fdb\u884c SQL \u8bed\u53e5\u548c\u67e5\u8be2\u7ed3\u679c\u7684\u4f20\u8f93\u3002</p> <ul> <li>\u5148\u6784\u9020 host address(ip address, port)</li> <li>\u901a\u8fc7\u914d\u7f6e\u53c2\u6570\u521d\u59cb\u5316\u8fde\u63a5\u6c60</li> <li>\u901a\u8fc7\u8fde\u63a5\u6c60\u4e0e graphd \u5efa\u7acb Session\uff0c\u6700\u540e\u901a\u8fc7 Session \u6765\u8fdb\u884c query \u7684\u6267\u884c\u4ee5\u53ca\u8fd4\u56de\u7ed3\u679c\u3002</li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/#basic-example","title":"basic example","text":"Go<pre><code>const (\n    address = \"127.0.0.1\"\n    // The default port of NebulaGraph 2.x is 9669.\n    // 3699 is only for testing.\n    port     = 3699\n    username = \"root\"\n    password = \"nebula\"\n    useHTTP2 = false\n)\n\n\nfunc main() {\n    hostAddress := nebula.HostAddress{Host: address, Port: port}\n    hostList := []nebula.HostAddress{hostAddress}\n    // Create configs for connection pool using default values\n    testPoolConfig := nebula.GetDefaultConf()\n    testPoolConfig.UseHTTP2 = useHTTP2\n    testPoolConfig.HandshakeKey = \"3.0.0\"\n\n    // Initialize connection pool\n    pool, err := nebula.NewConnectionPool(hostList, testPoolConfig, log)\n    if err != nil {\n        log.Fatal(fmt.Sprintf(\"Fail to initialize the connection pool, host: %s, port: %d, %s\", address, port, err.Error()))\n    }\n    // Close all connections in the pool\n    defer pool.Close()\n\n    // Create session\n    session, err := pool.GetSession(username, password)\n\n    // Release session and return connection back to connection pool\n    defer session.Release()\n\n    {\n        // Prepare the query\n        createSchema := \"CREATE SPACE IF NOT EXISTS basic_example_space(vid_type=FIXED_STRING(20)); \" +\n            \"USE basic_example_space;\" +\n            \"CREATE TAG IF NOT EXISTS person(name string, age int);\" +\n            \"CREATE EDGE IF NOT EXISTS like(likeness double)\"\n\n        // Execute a query\n        resultSet, err := session.Execute(createSchema)\n\n    }\n    // Drop space\n    {\n        query := \"DROP SPACE IF EXISTS basic_example_space\"\n        // Send query\n        resultSet, err := session.Execute(query)\n    }\n}\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/#graphd","title":"Graphd","text":"<p>graphd \u5927\u4f53\u4e0a\u5206\u4e3a parse\uff0cvalidate\uff0cplanner\uff0coptimize\uff0cexecute \u8fd9\u51e0\u4e2a\u9636\u6bb5\u3002\u6240\u6709\u7684 statement\u3001execplan \u4ee5\u53ca\u6700\u540e\u7684 resultset \u5305\u62ec\u539f\u59cb\u7684 Query \u8bed\u53e5\uff0c\u90fd\u5b58\u50a8\u5728 RequestContext \u4e2d\u3002</p> <ul> <li> <p>\u6784\u5efa RequestContext \u5e76\u628a Query \u8bed\u53e5\u4f20\u5165\uff0c\u6839\u636e RequestContext \u6784\u5efa Query Instance\u3002\u5f00\u542f\u6240\u6709\u7684\u5f02\u6b65\u6d41\u7a0b\u540e\uff0c\u8fd4\u56de\u7528\u6237\u4e00\u4e2a Future\u3002</p> </li> <li> <p>\u5728 Query Instance \u4e2d\u6267\u884c parse\uff0c\u5c06\u8bed\u53e5\u89e3\u6790\u6210 sentence(statement)\u3002</p> </li> <li> <p>\u5728 validate \u4e2d\u901a\u8fc7<code>validateimpl</code>\u65b9\u6cd5\u8fdb\u884c check\uff0c\u6821\u9a8c\u662f\u5426\u6ee1\u8db3 schema \u4ee5\u53ca\u662f\u5426\u6570\u636e\u672a\u8d85\u8303\u56f4\u3002</p> </li> </ul> C++<pre><code>Status InsertVerticesValidator::validateImpl() {\n  spaceId_ = vctx_-&gt;whichSpace().id;\n  NG_RETURN_IF_ERROR(check());\n  NG_RETURN_IF_ERROR(prepareVertices());\n  return Status::OK();\n}\n</code></pre> <ul> <li>\u901a\u8fc7 validator \u7684<code>toplan</code>\u65b9\u6cd5\u5c06 sentence \u53d8\u6210 execution plan tree\u3002</li> </ul> C++<pre><code>Status InsertVerticesValidator::toPlan() {\n  auto doNode = InsertVertices::make(qctx_,\n                                    nullptr,\n                                    spaceId_,\n                                    std::move(vertices_),\n                                    std::move(tagPropNames_),\n                                    ifNotExists_,\n                                    ignoreExistedIndex_);\n  root_ = doNode;\n  tail_ = root_;\n  return Status::OK();\n}\n</code></pre> <ul> <li> <p>\u5c06\u6267\u884c\u8ba1\u5212\u6811\u4ea4\u7ed9 Optimizer \u8fdb\u884c\u4f18\u5316\uff0cnebula \u73b0\u5728\u7684\u4f18\u5316\u662f Rule-based optimization\uff0c\u6bcf\u4e2a\u6267\u884c\u8ba1\u5212\u9700\u8981\u904d\u5386\u6240\u6709\u7684 rules\uff0c\u5f97\u5230\u6700\u4f18\u7684\u6267\u884c\u8ba1\u5212\u3002</p> </li> <li> <p>\u7136\u540e\u5c06\u6574\u4e2a\u8ba1\u5212\u4ea4\u7ed9 Scheduler \u8fdb\u884c\u6267\u884c\uff0c\u5728 Scheduler \u4e2d\u6309\u7167\u8ba1\u5212\u6811\u7684\u7236\u5b50\u5173\u7cfb\uff0c\u4ece\u4e0b\u4e4b\u4e0a\u4f9d\u6b64\u6267\u884c\u8ba1\u5212\uff0c\u6240\u6709\u7684\u8ba1\u5212\u90fd\u662f\u7528 Future \u5f02\u6b65\u6267\u884c\u3002</p> </li> <li> <p>\u9996\u5148\u5148\u6839\u636e Logical Plan \u6784\u9020\u51fa Physical Plan(Execution Plan) </p>C++<pre><code>Executor *Executor::makeExecutor(const PlanNode *node,\n                             QueryContext *qctx,\n                             std::unordered_map&lt;int64_t, Executor *&gt; *visited)\n</code></pre><p></p> </li> <li>\u5bf9 Executor \u8fdb\u884c\u8c03\u5ea6\uff0cparent plan \u8282\u70b9\u9700\u8981\u6240\u6709\u7684 children plan \u8282\u70b9\u90fd\u6267\u884c\u5b8c\u540e\u624d\u5f00\u59cb\u6267\u884c\u3002</li> </ul> C++<pre><code>folly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::scheduleExecutor(\nstd::vector&lt;folly::Future&lt;Status&gt;&gt;&amp;&amp; futures, Executor* exe, folly::Executor* runner) const {\nswitch (exe-&gt;node()-&gt;kind()) {\n  // ...\n  case PlanNode::Kind::kArgument: {\n    return runExecutor(std::move(futures), exe, runner);\n  }\n  default: {\n    if (exe-&gt;depends().empty()) {\n      return runLeafExecutor(exe, runner);\n    } else {\n      return runExecutor(std::move(futures), exe, runner);\n    }\n  }\n}\n}\nfolly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::runExecutor(\n  std::vector&lt;folly::Future&lt;Status&gt;&gt;&amp;&amp; futures, Executor* exe, folly::Executor* runner) const {\nreturn folly::collect(futures).via(runner).thenValue(\n    [exe, this](auto&amp;&amp; t) mutable -&gt; folly::Future&lt;Status&gt; {\n      NG_RETURN_IF_ERROR(checkStatus(std::move(t)));\n      // Execute in current thread.\n      return execute(exe);\n    });\n}\n\nfolly::Future&lt;Status&gt; AsyncMsgNotifyBasedScheduler::runLeafExecutor(Executor* exe,\n                                                                  folly::Executor* runner) const {\n  return std::move(execute(exe)).via(runner);\n}\n</code></pre> <ul> <li>\u5728 runExecutor \u65b9\u6cd5\u4e2d\u4f1a\u8c03\u7528 graphd \u4e2d\u7684 executor\uff0c\u8fdb\u884c\u7269\u7406\u8ba1\u5212\u7684\u6267\u884c\u3002\u91cc\u9762\u6d89\u53ca\u5230\u5b58\u50a8\u5c42\u7684\u5185\u5bb9\u65f6\u4f1a\u901a\u8fc7 RPC \u5411 Storaged \u8bf7\u6c42\u670d\u52a1\u3002</li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/5.nGQL%20life/#storaged","title":"Storaged","text":"<p>Storaged \u63a5\u6536\u5230 graphd \u53d1\u9001\u7684 executor \u8bf7\u6c42\uff0c\u542f\u52a8\u5bf9\u5e94\u7684 Processor\uff0c\u6267\u884c<code>process</code>\u65b9\u6cd5\uff0c\u5b9e\u9645\u4e0a\u6267\u884c<code>doProcess</code>\u65b9\u6cd5\u3002</p> <p></p> <ul> <li>\u5728\u6267\u884c\u5b8c\u903b\u8f91\u540e\uff0c\u5c06\u6240\u6709\u7684\u66f4\u6539\u5199\u5165\u96c6\u7fa4\uff0c\u6700\u540e\u5728\u56de\u8c03\u4e2d\u6267\u884c<code>handleAsync</code>\u65b9\u6cd5\uff0c\u5b9e\u9645\u4e0a\u662f\u6267\u884c<code>onFinished</code>\u65b9\u6cd5\uff0c<code>onFinished</code>\u65b9\u6cd5\u4e2d\u8bbe\u7f6e promise \u7684 value \u4e3a RESP\uff0cRESP \u4e2d\u5305\u542b\u67e5\u8be2\u7684\u7ed3\u679c\uff0c\u4e00\u5c42\u5c42\u8fd4\u56de\u76f4\u5230\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ul> C++<pre><code>template &lt;typename RESP&gt;\nvoid BaseProcessor&lt;RESP&gt;::doPut(GraphSpaceID spaceId,\n                                PartitionID partId,\n                                std::vector&lt;kvstore::KV&gt;&amp;&amp; data) {\n  this-&gt;env_-&gt;kvstore_-&gt;asyncMultiPut(\n      spaceId, partId, std::move(data), [spaceId, partId, this](nebula::cpp2::ErrorCode code) {\n        handleAsync(spaceId, partId, code);\n      });\n}\n\ntemplate &lt;typename RESP&gt;\nvoid BaseProcessor&lt;RESP&gt;::handleAsync(GraphSpaceID spaceId,\n                                    PartitionID partId,\n                                    nebula::cpp2::ErrorCode code) {\n  VLOG(3) &lt;&lt; \"partId:\" &lt;&lt; partId &lt;&lt; \", code: \" &lt;&lt; static_cast&lt;int32_t&gt;(code);\n\n  bool finished = false;\n  {\n    std::lock_guard&lt;std::mutex&gt; lg(this-&gt;lock_);\n    handleErrorCode(code, spaceId, partId);\n    this-&gt;callingNum_--;\n    if (this-&gt;callingNum_ == 0) {\n      finished = true;\n    }\n  }\n\n  if (finished) {\n    this-&gt;onFinished();\n  }\n}\n\nvirtual void onFinished() {\n  memory::MemoryCheckOffGuard guard;\n  if (counters_) {\n    stats::StatsManager::addValue(counters_-&gt;numCalls_);\n    if (!this-&gt;codes_.empty()) {\n      stats::StatsManager::addValue(counters_-&gt;numErrors_);\n    }\n  }\n\n  this-&gt;result_.latency_in_us_ref() = this-&gt;duration_.elapsedInUSec();\n  if (!profileDetail_.empty()) {\n    this-&gt;result_.latency_detail_us_ref() = std::move(profileDetail_);\n  }\n  this-&gt;result_.failed_parts_ref() = this-&gt;codes_;\n  this-&gt;resp_.result_ref() = std::move(this-&gt;result_);\n  this-&gt;promise_.setValue(std::move(this-&gt;resp_));\n\n  if (counters_) {\n    stats::StatsManager::addValue(counters_-&gt;latency_, this-&gt;duration_.elapsedInUSec());\n  }\n\n  delete this;\n}\n</code></pre> <ul> <li>\u5199\u5165\u66f4\u6539\u662f doPut \u64cd\u4f5c\uff0c\u8be5\u64cd\u4f5c\u5b9e\u9645\u4e0a\u662f\u5bf9 raft \u63d0\u4ea4\u65e5\u5fd7\uff0c\u9a71\u52a8 raft \u72b6\u6001\u673a\u5c06\u8be5\u64cd\u4f5c\u540c\u6b65\u5230\u96c6\u7fa4\u4e2d\u3002</li> </ul> <p></p> <ol> <li>\u6240\u6709\u64cd\u4f5c\u90fd\u662f write wal first\u3002</li> <li>sync logs to followers</li> </ol> C++<pre><code>void Part::asyncMultiPut(const std::vector&lt;KV&gt;&amp; keyValues, KVCallback cb) {\n  std::string log = encodeMultiValues(OP_MULTI_PUT, keyValues);\n\n  appendAsync(FLAGS_cluster_id, std::move(log))\n      .thenValue(\n          [callback = std::move(cb)](nebula::cpp2::ErrorCode code) mutable { callback(code); });\n}\n// \u7ecf\u8fc7 Part::appendAsync -&gt; RaftPart::appendLogAsync -&gt; RaftPart::appendLogsInternal\nvoid RaftPart::appendLogsInternal(AppendLogsIterator iter, TermID termId) {\n  TermID currTerm = 0;\n  LogID prevLogId = 0;\n  TermID prevLogTerm = 0;\n  LogID committed = 0;\n  LogID lastId = 0;\n  nebula::cpp2::ErrorCode res = nebula::cpp2::ErrorCode::SUCCEEDED;\n  do {\n    std::lock_guard&lt;std::mutex&gt; g(raftLock_);\n    res = canAppendLogs(termId);\n    if (res != nebula::cpp2::ErrorCode::SUCCEEDED) {\n      break;\n    }\n    currTerm = term_;\n    prevLogId = lastLogId_;\n    prevLogTerm = lastLogTerm_;\n    committed = committedLogId_;\n    // Step 1: Write WAL\n    {\n      SCOPED_TIMER(\n          [](uint64_t execTime) { stats::StatsManager::addValue(kAppendWalLatencyUs, execTime); });\n      if (!wal_-&gt;appendLogs(iter)) {\n        VLOG_EVERY_N(2, 1000) &lt;&lt; idStr_ &lt;&lt; \"Failed to write into WAL\";\n        res = nebula::cpp2::ErrorCode::E_RAFT_WAL_FAIL;\n        lastLogId_ = wal_-&gt;lastLogId();\n        lastLogTerm_ = wal_-&gt;lastLogTerm();\n        break;\n      }\n    }\n    lastId = wal_-&gt;lastLogId();\n    VLOG(4) &lt;&lt; idStr_ &lt;&lt; \"Succeeded writing logs [\" &lt;&lt; iter.firstLogId() &lt;&lt; \", \" &lt;&lt; lastId\n            &lt;&lt; \"] to WAL\";\n  } while (false);\n\n  if (!checkAppendLogResult(res)) {\n    iter.commit(res);\n    return;\n  }\n  // Step 2: Replicate to followers\n  auto* eb = ioThreadPool_-&gt;getEventBase();\n  replicateLogs(eb, std::move(iter), currTerm, lastId, committed, prevLogTerm, prevLogId);\n  return;\n}\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/","title":"Raft Wal","text":"2025-06-062025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/#raft-wal-in-nebula","title":"Raft &amp; Wal in nebula","text":"<p> \u7ea6 1360 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/#raft-in-nebula","title":"Raft in nebula","text":"","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/#multi-raft-group","title":"Multi Raft Group","text":"<p>\u7531\u4e8e Raft \u7684\u65e5\u5fd7\u4e0d\u5141\u8bb8\u7a7a\u6d1e\uff0c\u51e0\u4e4e\u6240\u6709\u7684\u5b9e\u73b0\u90fd\u4f1a\u91c7\u7528 Multi Raft Group \u6765\u7f13\u89e3\u8fd9\u4e2a\u95ee\u9898\uff0c\u56e0\u6b64 partition \u7684\u6570\u76ee\u51e0\u4e4e\u51b3\u5b9a\u4e86\u6574\u4e2a Raft Group \u7684\u6027\u80fd\u3002\u4f46\u8fd9\u4e5f\u5e76\u4e0d\u662f\u8bf4 Partition \u7684\u6570\u76ee\u8d8a\u591a\u8d8a\u597d\uff1a\u6bcf\u4e00\u4e2a Raft Group \u5185\u90e8\u90fd\u8981\u5b58\u50a8\u4e00\u7cfb\u5217\u7684\u72b6\u6001\u4fe1\u606f\uff0c\u5e76\u4e14\u6bcf\u4e00\u4e2a Raft Group \u6709\u81ea\u5df1\u7684 WAL \u6587\u4ef6\uff0c\u56e0\u6b64 Partition \u6570\u76ee\u592a\u591a\u4f1a\u589e\u52a0\u5f00\u9500\u3002\u6b64\u5916\uff0c\u5f53 Partition \u592a\u591a\u65f6\uff0c \u5982\u679c\u8d1f\u8f7d\u6ca1\u6709\u8db3\u591f\u9ad8\uff0cbatch \u64cd\u4f5c\u662f\u6ca1\u6709\u610f\u4e49\u7684\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a\u6709 1w tps \u7684\u7ebf\u4e0a\u7cfb\u7edf\u5355\u673a\uff0c\u5b83\u7684\u5355\u673a partition \u7684\u6570\u76ee\u8d85\u8fc7 1w\uff0c\u53ef\u80fd\u6bcf\u4e2a Partition \u6bcf\u79d2\u7684 tps \u53ea\u6709 1\uff0c\u8fd9\u6837 batch \u64cd\u4f5c\u5c31\u5931\u53bb\u4e86\u610f\u4e49\uff0c\u8fd8\u589e\u52a0\u4e86 CPU \u5f00\u9500\u3002 \u5b9e\u73b0 Multi Raft Group \u7684\u6700\u5173\u952e\u4e4b\u5904\u6709\u4e24\u70b9\uff0c\u7b2c\u4e00\u662f\u5171\u4eab Transport \u5c42\uff0c\u56e0\u4e3a\u6bcf\u4e00\u4e2a Raft Group \u5185\u90e8\u90fd\u9700\u8981\u5411\u5bf9\u5e94\u7684 peer \u53d1\u9001\u6d88\u606f\uff0c\u5982\u679c\u4e0d\u80fd\u5171\u4eab Transport \u5c42\uff0c\u8fde\u63a5\u7684\u5f00\u9500\u5de8\u5927\uff1b\u7b2c\u4e8c\u662f\u7ebf\u7a0b\u6a21\u578b\uff0cMutli Raft Group \u4e00\u5b9a\u8981\u5171\u4eab\u4e00\u7ec4\u7ebf\u7a0b\u6c60\uff0c\u5426\u5219\u4f1a\u9020\u6210\u7cfb\u7edf\u7684\u7ebf\u7a0b\u6570\u76ee\u8fc7\u591a\uff0c\u5bfc\u81f4\u5927\u91cf\u7684 context switch \u5f00\u9500\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/#batch","title":"Batch","text":"<p>\u5bf9\u4e8e\u6bcf\u4e2a Partition \u6765\u8bf4\uff0c\u7531\u4e8e\u4e32\u884c\u5199 WAL\uff0c\u4e3a\u4e86\u63d0\u9ad8\u541e\u5410\uff0c\u505a batch \u662f\u5341\u5206\u5fc5\u8981\u7684\u3002\u4e00\u822c\u6765\u8bb2\uff0cbatch \u5e76\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u7684\u5730\u65b9\uff0c\u4f46\u662f Nebula \u5229\u7528\u6bcf\u4e2a part \u4e32\u884c\u7684\u7279\u70b9\uff0c\u505a\u4e86\u4e00\u4e9b\u7279\u6b8a\u7c7b\u578b\u7684 WAL\uff0c\u5e26\u6765\u4e86\u4e00\u4e9b\u5de5\u7a0b\u4e0a\u7684\u6311\u6218\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50\uff0cNebula \u5229\u7528 WAL \u5b9e\u73b0\u4e86\u65e0\u9501\u7684 CAS \u64cd\u4f5c\uff0c\u800c\u6bcf\u4e2a CAS \u64cd\u4f5c\u9700\u8981\u4e4b\u524d\u7684 WAL \u5168\u90e8 commit \u4e4b\u540e\u624d\u80fd\u6267\u884c\uff0c\u6240\u4ee5\u5bf9\u4e8e\u4e00\u4e2a batch\uff0c\u5982\u679c\u4e2d\u95f4\u5939\u6742\u4e86\u51e0\u6761 CAS \u7c7b\u578b\u7684 WAL, \u6211\u4eec\u8fd8\u9700\u8981\u628a\u8fd9\u4e2a batch \u5206\u6210\u7c92\u5ea6\u66f4\u5c0f\u7684\u51e0\u4e2a group\uff0cgroup \u4e4b\u95f4\u4fdd\u8bc1\u4e32\u884c\u3002\u8fd8\u6709\uff0ccommand \u7c7b\u578b\u7684 WAL \u9700\u8981\u5b83\u540e\u9762\u7684 WAL \u5728\u5176 commit \u4e4b\u540e\u624d\u80fd\u6267\u884c\uff0c\u6240\u4ee5\u6574\u4e2a batch \u5212\u5206 group \u7684\u64cd\u4f5c\u5de5\u7a0b\u5b9e\u73b0\u4e0a\u6bd4\u8f83\u6709\u7279\u8272\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/#learner","title":"Learner","text":"<p>Learner \u8fd9\u4e2a\u89d2\u8272\u7684\u5b58\u5728\u4e3b\u8981\u662f\u4e3a\u4e86\u5e94\u5bf9\u6269\u5bb9\u65f6\uff0c\u65b0\u673a\u5668\u9700\u8981\"\u8ffd\"\u76f8\u5f53\u957f\u4e00\u6bb5\u65f6\u95f4\u7684\u6570\u636e\uff0c\u800c\u8fd9\u6bb5\u65f6\u95f4\u6709\u53ef\u80fd\u4f1a\u53d1\u751f\u610f\u5916\u3002\u5982\u679c\u76f4\u63a5\u4ee5 follower \u7684\u8eab\u4efd\u5f00\u59cb\u8ffd\u6570\u636e\uff0c\u5c31\u4f1a\u4f7f\u5f97\u6574\u4e2a\u96c6\u7fa4\u7684 HA \u80fd\u529b\u4e0b\u964d\u3002 Nebula \u91cc\u9762 learner \u7684\u5b9e\u73b0\u5c31\u662f\u91c7\u7528\u4e86\u4e0a\u9762\u63d0\u5230\u7684 command wal\uff0cleader \u5728\u5199 wal \u65f6\u5982\u679c\u78b0\u5230 add learner \u7684 command\uff0c \u5c31\u4f1a\u5c06 learner \u52a0\u5165\u81ea\u5df1\u7684 peers\uff0c\u5e76\u628a\u5b83\u6807\u8bb0\u4e3a learner\uff0c\u8fd9\u6837\u5728\u7edf\u8ba1\u591a\u6570\u6d3e\u7684\u65f6\u5019\uff0c\u5c31\u4e0d\u4f1a\u7b97\u4e0a learner\uff0c\u4f46\u662f\u65e5\u5fd7\u8fd8\u662f\u4f1a\u7167\u5e38\u53d1\u9001\u7ed9\u5b83\u4eec\u3002\u5f53\u7136 learner \u4e5f\u4e0d\u4f1a\u4e3b\u52a8\u53d1\u8d77\u9009\u4e3e\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/#transfer-leadership","title":"Transfer Leadership","text":"<p>Transfer leadership \u8fd9\u4e2a\u64cd\u4f5c\u5bf9\u4e8e balance \u6765\u8bb2\u81f3\u5173\u91cd\u8981\uff0c\u5f53\u6211\u4eec\u628a\u67d0\u4e2a Paritition \u4ece\u4e00\u53f0\u673a\u5668\u632a\u5230\u53e6\u4e00\u53f0\u673a\u5668\u65f6\uff0c\u9996\u5148\u4fbf\u4f1a\u68c0\u67e5 source \u662f\u4e0d\u662f leader\uff0c\u5982\u679c\u662f\u7684\u8bdd\uff0c\u9700\u8981\u5148\u628a\u4ed6\u632a\u5230\u53e6\u5916\u7684 peer \u4e0a\u9762\uff1b\u5728\u642c\u8fc1\u6570\u636e\u5b8c\u6bd5\u4e4b\u540e\uff0c\u901a\u5e38\u8fd8\u8981\u628a leader \u8fdb\u884c\u4e00\u6b21 balance\uff0c\u8fd9\u6837\u6bcf\u53f0\u673a\u5668\u627f\u62c5\u7684\u8d1f\u8f7d\u4e5f\u80fd\u4fdd\u8bc1\u5747\u8861\u3002</p> <p>\u5b9e\u73b0 transfer leadership\uff0c \u9700\u8981\u6ce8\u610f\u7684\u662f leader \u653e\u5f03\u81ea\u5df1\u7684 leadership\uff0c\u548c follower \u5f00\u59cb\u8fdb\u884c leader election \u7684\u65f6\u673a\u3002\u5bf9\u4e8e leader \u6765\u8bb2\uff0c\u5f53 transfer leadership command \u5728 commit \u7684\u65f6\u5019\uff0c\u5b83\u653e\u5f03 leadership\uff1b\u800c\u5bf9\u4e8e follower \u6765\u8bb2\uff0c\u5f53\u6536\u5230\u6b64 command \u7684\u65f6\u5019\u5c31\u8981\u5f00\u59cb\u8fdb\u884c leader election\uff0c\u8fd9\u5957\u5b9e\u73b0\u8981\u548c Raft \u672c\u8eab\u7684 leader election \u8d70\u4e00\u5957\u8def\u5f84\uff0c\u5426\u5219\u5f88\u5bb9\u6613\u51fa\u73b0\u4e00\u4e9b\u96be\u4ee5\u5904\u7406\u7684 corner case\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/#membership-change","title":"Membership change","text":"<p>\u4e3a\u4e86\u907f\u514d\u8111\u88c2\uff0c\u5f53\u4e00\u4e2a Raft Group \u7684\u6210\u5458\u53d1\u751f\u53d8\u5316\u65f6\uff0c\u9700\u8981\u6709\u4e00\u4e2a\u4e2d\u95f4\u72b6\u6001\uff0c \u8fd9\u4e2a\u72b6\u6001\u4e0b old group \u7684\u591a\u6570\u6d3e\u4e0e new group \u7684\u591a\u6570\u6d3e\u603b\u662f\u6709 overlap\uff0c\u8fd9\u6837\u5c31\u9632\u6b62\u4e86 old group \u6216\u8005\u65b0 group \u5355\u65b9\u9762\u505a\u51fa\u51b3\u5b9a\uff0c\u8fd9\u5c31\u662f\u8bba\u6587\u4e2d\u63d0\u5230\u7684 joint consensus \u3002\u4e3a\u4e86\u66f4\u52a0\u7b80\u5316\uff0cDiego Ongaro \u5728\u81ea\u5df1\u7684\u535a\u58eb\u8bba\u6587\u4e2d\u63d0\u51fa\u6bcf\u6b21\u589e\u51cf\u4e00\u4e2a peer \u7684\u65b9\u5f0f\uff0c\u4ee5\u4fdd\u8bc1 old group \u7684\u591a\u6570\u6d3e\u603b\u662f\u4e0e new group \u7684\u591a\u6570\u6d3e\u6709 overlap\u3002Nebula \u7684\u5b9e\u73b0\u4e5f\u91c7\u7528\u4e86\u8fd9\u4e2a\u65b9\u5f0f\uff0c\u53ea\u4e0d\u8fc7 add member \u4e0e remove member \u7684\u5b9e\u73b0\u6709\u6240\u533a\u522b\uff0c\u5177\u4f53\u5b9e\u73b0\u65b9\u5f0f\u672c\u6587\u4e0d\u4f5c\u8ba8\u8bba\uff0c\u6709\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u53c2\u8003 Raft Part class \u91cc\u9762 addPeer / removePeer \u7684\u5b9e\u73b0\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/6.raft-wal/#snapshot","title":"Snapshot","text":"<p>Snapshot \u5982\u4f55\u4e0e Raft \u6d41\u7a0b\u7ed3\u5408\u8d77\u6765\uff0c\u8bba\u6587\u4e2d\u5e76\u6ca1\u6709\u7ec6\u8bb2\uff0c\u4f46\u662f\u8fd9\u4e00\u90e8\u5206\u6211\u8ba4\u4e3a\u662f\u4e00\u4e2a Raft \u5b9e\u73b0\u91cc\u6700\u5bb9\u6613\u51fa\u9519\u7684\u5730\u65b9\uff0c\u56e0\u4e3a\u8fd9\u91cc\u4f1a\u4ea7\u751f\u5927\u91cf\u7684 corner case\u3002</p> <p>\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff0c\u5f53 leader \u53d1\u9001 snapshot \u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c leader \u53d1\u751f\u4e86\u53d8\u5316\uff0c\u8be5\u600e\u4e48\u529e\uff1f \u8fd9\u4e2a\u65f6\u5019\uff0c\u6709\u53ef\u80fd follower \u53ea\u63a5\u5230\u4e86\u4e00\u534a\u7684 snapshot \u6570\u636e\u3002 \u6240\u4ee5\u9700\u8981\u6709\u4e00\u4e2a Partition \u6570\u636e\u6e05\u7406\u8fc7\u7a0b\uff0c\u7531\u4e8e\u591a\u4e2a Partition \u5171\u4eab\u4e00\u4efd\u5b58\u50a8\uff0c\u56e0\u6b64\u5982\u4f55\u6e05\u7406\u6570\u636e\u53c8\u662f\u4e00\u4e2a\u5f88\u9ebb\u70e6\u7684\u95ee\u9898\u3002\u53e6\u5916\uff0csnapshot \u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u4ea7\u751f\u5927\u91cf\u7684 IO\uff0c\u4e3a\u4e86\u6027\u80fd\u8003\u8651\uff0c\u6211\u4eec\u4e0d\u5e0c\u671b\u8fd9\u4e2a\u8fc7\u7a0b\u4e0e\u6b63\u5e38\u7684 Raft \u5171\u7528\u4e00\u4e2a IO threadPool\uff0c\u5e76\u4e14\u6574\u4e2a\u8fc7\u7a0b\u4e2d\uff0c\u8fd8\u9700\u8981\u4f7f\u7528\u5927\u91cf\u7684\u5185\u5b58\uff0c\u5982\u4f55\u4f18\u5316\u5185\u5b58\u7684\u4f7f\u7528\uff0c\u5bf9\u4e8e\u6027\u80fd\u5341\u5206\u5173\u952e\u3002</p> <ul> <li>\u7528\u4e86\u4e24\u4e2a IO threadpool\uff0c\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e\u5904\u7406 snapshot \u7684 IO\uff0c\u4e00\u4e2a\u7528\u4e8e\u5904\u7406 event IO\u3002</li> <li>\u4ee3\u7801\u4e2d\u662f\u4e00\u4e2a\u4e00\u4e2a peer \u53bb send snapshot\uff0c\u907f\u514d\u5360\u7528\u5927\u91cf\u5185\u5b58\u3002</li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/","title":"From parser to executor, modifing nGQL statement","text":"2025-06-242025-12-10 <code>#Database</code>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/#from-parser-to-executor-modifing-ngql-statement","title":"From parser to executor, modifing nGQL statement","text":"<p> \u7ea6 672 \u4e2a\u5b57  107 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> <p>\u8fd9\u91cc\u4ee5\u4e3a<code>Create TAG</code>\u8bed\u53e5\u589e\u52a0 VECTOR \u5c5e\u6027\u4e3a\u4f8b\u8fdb\u884c\u53d9\u8ff0\uff0c\u65e2\u662f\u7ed9\u8bfb\u8005\u4e00\u4efd\u66f4\u6539\u6e90\u7801\u7684\u53c2\u8003\uff0c\u4e5f\u662f\u5bf9\u81ea\u5df1\u66f4\u6539\u4ee3\u7801\u903b\u8f91\u7684\u68b3\u7406\u3002</p> <p>\u6211\u4eec\u6700\u540e\u671f\u671b\u7684\u8bed\u53e5\u5f62\u5f0f\u5982\u4e0b\uff1a</p> <ul> <li>\u6709 Default value C++<pre><code>CREATE TAG person(name STRING, embedding VECTOR(2) DEFAULT [0.01, 0.01],\n    embedding2 VECTOR(3) DEFAULT [0.02, 0.02, 0.02])\n</code></pre></li> <li>\u6709 TTL \u9009\u9879 C++<pre><code>CREATE TAG person(name STRING, embedding VECTOR(128) NOT NULL,\n    embedding2 VECTOR(256) NOT NULL)\n    ttl_duration = 100, ttl_col = \"create_time\"\n</code></pre></li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/#00-context-plan","title":"0.0 Context &amp; Plan","text":"<ul> <li>Query\u3001Session\u3001Storage \u7b49\u6253\u5305\u6210 Request Context\uff0c\u968f\u540e\u5c06 Request Context \u6253\u5305\u6210 Query Context C++<pre><code>RequestContextPtr rctx_;                    // Session \u4f20\u5165\nstd::unique_ptr&lt;ValidateContext&gt; vctx_;     // validate \u4fee\u6539\nstd::unique_ptr&lt;ExecutionContext&gt; ectx_;    // Execution \u4fee\u6539\nstd::unique_ptr&lt;ExecutionPlan&gt; ep_;         // planner \u4fee\u6539\n</code></pre></li> <li>CreateSchemaContext CreateTagValidator \u81ea\u5df1\u62e5\u6709\u7684\u4e0a\u4e0b\u6587\uff0c\u7528\u4e8e\u5c06 Sentence \u8f6c\u53d8\u4e3a Plan\uff0c\u91cc\u9762\u662f\u9700\u8981\u4f20\u9012\u7ed9 CreateTagNode \u7684\u53c2\u6570\u3002 C++<pre><code>struct CreateSchemaContext final : public AstContext {\nbool ifNotExist{false};\nstd::string name;\nmeta::cpp2::Schema schema;\n};\n</code></pre></li> <li>\u6267\u884c\u8ba1\u5212\u4e2d\u7684\u6bcf\u4e2a Node \u5b9e\u9645\u4e0a\u9700\u8981\u7684\u662f QueryContext\uff0c\u4ee5\u53ca\u5176\u4ed6 Validator \u81ea\u5df1\u751f\u6210\u7684 Schema \u6216 Name \u7b49\u53d8\u91cf <p>CreateTag \u9700\u8981<code>QueryContext* qctx</code>, <code>std::string name</code>, <code>meta::cpp2::Schema schema</code>, \u53ea\u6709 qctx \u662f\u6574\u4e2a nGQL \u90fd\u9700\u8981\u7ef4\u62a4\u7684</p> </li> <li>\u5728 Scheduler \u4e2d\u5c06 Logical Plan \u53d8\u6210 Physical Plan\uff0c\u8fd9\u91cc\u662f CreateTag \u53d8\u6210 CreateTagExecutor\uff0c\u8fd9\u91cc\u8c03\u7528\u4e86 Meta \u670d\u52a1\u4e2d\u7684 createTagSchema \u65b9\u6cd5</li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/#01-processing","title":"0.1 Processing","text":"<ol> <li>Parser: From string to sentences    - \u6700\u5916\u5c42\u662f CreateTagSentence\uff0c\u91cc\u9762\u6bcf\u4e2a\u5c5e\u6027\u662f ColumnSpecification</li> <li>Validater:    - \u9a8c\u8bc1 column\uff0c\u5c06\u9a8c\u8bc1\u540e\u7684 column \u52a0\u5165 schema\uff0c\u5e76\u5c06\u8fd9\u4e2a\u65b0\u6784\u5efa\u7684 schema \u4f20\u5165 CreateTagContext    - CreateTagPlanner \u901a\u8fc7 transform \u751f\u6210 Logical Plan</li> <li>Optimizer: \u8fd9\u91cc\u6682\u65f6\u6ca1\u6709\u4f18\u5316\uff0c\u5148\u8df3\u8fc7</li> <li>Executor: \u5728 Scheduler \u4e2d\u5c06\u751f\u6210\u7684 Logical Plan \u53d8\u6210 Physical Plan\uff0c\u5728 graphd \u7684 executor \u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u5411 metad \u8bf7\u6c42\u670d\u52a1</li> </ol>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/#1-parser-modifing","title":"1. Parser modifing","text":"<p>\u6211\u4eec\u9700\u8981\u5bf9 scanner.lex \u548c parser.yy \u8fdb\u884c\u4fee\u6539\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u80fd\u9700\u8981\u5bf9 bison \u4e2d\u7684\u8bed\u6cd5\u8fdb\u884c\u68c0\u67e5\uff0c\u51fa\u73b0\u590d\u6742\u95ee\u9898\u6211\u4eec\u53ef\u80fd\u8fd8\u8981\u8fdb\u884c debug\uff0c\u6211\u7684\u53e6\u4e00\u7bc7\u6587\u7ae0\u4e2d\u6709\u8be6\u7ec6\u53d9\u8ff0\u8be5\u8fc7\u7a0b\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002</p>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/#scannerlex","title":"scanner.lex \u4fee\u6539","text":"<p>\u4e3b\u8981\u5c31\u662f\u589e\u52a0 VECTOR \u5173\u952e\u5b57\u7684\u89e3\u6790</p> C++<pre><code>\"VECTOR\"  { return TokenType::KW_VECTOR; }\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/#parseryy","title":"parser.yy \u4fee\u6539","text":"<p>\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u5bf9 VECTOR \u7684\u8bed\u6cd5\u8fdb\u884c\u89e3\u6790\uff0c\u9996\u5148\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff0c\u5bf9<code>[0.01, 0.02, 0.03]</code>\u7684\u89e3\u6790\u4f1a\u6709\u4e24\u79cd\u89e3\u6790\u65b9\u5f0f\u6210\u7acb\uff1a</p> <ul> <li>\u4e00\u79cd\u662f\u89e3\u6790\u6210 List</li> <li>\u4e00\u79cd\u662f\u6211\u4eec\u5e0c\u671b\u7684\u89e3\u6790\u6210 Vector</li> </ul> C++<pre><code>  Example: L_BRACKET DOUBLE \u2022 R_BRACKET\n  First reduce derivation\n    container_expression\n    \u21b3 list_expression\n      \u21b3 L_BRACKET opt_expression_list       R_BRACKET\n                  \u21b3 expression_list\n                    \u21b3 expression_internal\n                      \u21b3 constant_expression\n                        \u21b3 DOUBLE \u2022\n  Second reduce derivation\n    container_expression\n    \u21b3 vector_expression\n      \u21b3 L_BRACKET vector_item_list            R_BRACKET\n                  \u21b3 vector_element_expression\n                    \u21b3 DOUBLE \u2022\n</code></pre> <p>\u6682\u65f6\u6211\u4eec\u7684\u5904\u7406\u662f\u89e3\u6790\u6210 Vector \u7684\u89c4\u5219\u653e\u5728\u9996\u4f4d\uff0c\u56e0\u4e3a bison \u662f\u9ed8\u8ba4\u4ece\u5934\u5230\u5c3e\u5339\u914d\u89c4\u5219\u3002</p> <p>\u6211\u4eec\u540c\u6837\u9700\u8981\u5904\u7406 Column Spec \u652f\u6301 VECTOR \u7c7b\u578b\uff0c\u800c VECTOR \u7c7b\u578b\u9700\u8981\u6709 dimension \u53c2\u6570\uff0c\u6211\u4eec\u5728<code>ColumnSpecification</code>\u4e2d\u589e\u52a0\u4e00\u4e2a\u6210\u5458\u53d8\u91cf</p> C++<pre><code>column_spec\n    : name_label type_spec {\n        $$ = new ColumnSpecification($1, $2-&gt;type, new ColumnProperties(), $2-&gt;type_length_ref().value_or(0), $2-&gt;geo_shape_ref().value_or(meta::cpp2::GeoShape::ANY), $2-&gt;dimension_ref().value_or(0));\n        delete $2;\n    }\n    | name_label type_spec column_properties {\n        $$ = new ColumnSpecification($1, $2-&gt;type, $3, $2-&gt;type_length_ref().value_or(0), $2-&gt;geo_shape_ref().value_or(meta::cpp2::GeoShape::ANY), $2-&gt;dimension_ref().value_or(0));\n        delete $2;\n    }\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/#transfer-statement","title":"Transfer Statement","text":"<ul> <li>\u9700\u8981\u4fee\u6539 ColumnSpecification \u652f\u6301 VECTOR \u7c7b\u578b\uff0c\u7531\u4e8e VECTOR \u7c7b\u578b\u4e2d\u6709 dimension \u53c2\u6570\uff0c\u6211\u4eec\u9700\u8981\u589e\u52a0 dimension \u53c2\u6570 C++<pre><code>ColumnSpecification(std::string *name,\n                    nebula::cpp2::PropertyType type,\n                    ColumnProperties *properties = nullptr,\n                    int16_t typeLen = 0,\n                    meta::cpp2::GeoShape geoShape = meta::cpp2::GeoShape::ANY,\n                    int16_t dimension = 0)\n    : name_(name),\n      type_(type),\n      properties_(DCHECK_NOTNULL(properties)),\n      typeLen_(typeLen),\n      geoShape_(geoShape),\n      dimension_(dimension) {}\n</code></pre></li> <li>\u9700\u8981\u4fee\u6539<code>ColumnTypeDef</code>\u652f\u6301 VECTOR \u7c7b\u578b\uff0c\u7531\u4e8e VECTOR \u7c7b\u578b\u4e2d\u6709 dimension \u53c2\u6570\uff0c\u6211\u4eec\u9700\u8981\u5728 meta.thrift \u4e2d\u6dfb\u52a0\u8be5\u53c2\u6570</li> </ul> C++<pre><code>struct ColumnTypeDef {\n    1: required common.PropertyType    type,\n    // type_length is valid for fixed_string type\n    2: optional i16                    type_length = 0,\n    // geo_shape is valid for geography type\n    3: optional GeoShape               geo_shape,\n    // dim is valid for vector type\n    4: optional i16                    dimension,\n}\n</code></pre>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/7.how%20to%20modify%20sql/#2-validater-modifing","title":"2. Validater Modifing","text":"<p>\u4fee\u6539 validate columns \u6765\u5b9e\u73b0\u5bf9 VECTOR \u7c7b\u578b column \u7684\u9a8c\u8bc1</p> C++<pre><code>static Status validateColumns(const std::vector&lt;ColumnSpecification *&gt; &amp;columnSpecs,\n                              meta::cpp2::Schema &amp;schema,\n                              bool isAlter = false) {\n  for (auto &amp;spec : columnSpecs) {\n    meta::cpp2::ColumnDef column;\n    auto type = spec-&gt;type();\n    column.name_ref() = *spec-&gt;name();\n    column.type.type_ref() = type;\n    if (nebula::cpp2::PropertyType::FIXED_STRING == type) {\n      column.type.type_length_ref() = spec-&gt;typeLen();\n    } else if (nebula::cpp2::PropertyType::GEOGRAPHY == type) {\n      column.type.geo_shape_ref() = spec-&gt;geoShape();\n    } else if (nebula::cpp2::PropertyType::VECTOR == type) {\n      column.type.dimension_ref() = spec-&gt;dimension();\n    }\n    // ...\n    schema.columns_ref().value().emplace_back(std::move(column));\n  }\n  return Status::OK();\n}\n</code></pre> <p>\u4fee\u6539 Schema \u6765\u5b9e\u73b0\u5bf9 VECTOR \u7c7b\u578b\u7684\u5904\u7406</p> <ul> <li>\u9996\u5148\u662f\u589e\u52a0 SchemaField \u5bf9 VECTOR \u7684\u5904\u7406 C++<pre><code>SchemaField(const std::string&amp; name,\n            nebula::cpp2::PropertyType type,\n            bool nullable,\n            bool hasDefault,\n            std::string defaultValue,\n            size_t size,\n            size_t offset,\n            size_t nullFlagPos,\n            cpp2::GeoShape geoShape,\n            int32_t dimension)\n    : name_(name),\n      type_(type),\n      nullable_(nullable),\n      hasDefault_(hasDefault),\n      defaultValue_(defaultValue),\n      size_(size),\n      offset_(offset),\n      nullFlagPos_(nullFlagPos),\n      geoShape_(geoShape),\n      dimension_(dimension) {}\n</code></pre></li> <li>\u589e\u52a0 NebulaSchemaProvider \u6dfb\u52a0 VECTOR \u5c5e\u6027 column \u7684\u65b9\u6cd5 C++<pre><code>void addField(const std::string&amp; name,\n              nebula::cpp2::PropertyType type,\n              size_t fixedStrLen = 0,\n              bool nullable = false,\n              std::string defaultValue = \"\",\n              cpp2::GeoShape geoShape = cpp2::GeoShape::ANY,\n              int32_t dimension = 0);\n</code></pre></li> </ul>","tags":["Database"]},{"location":"projects/nebula-vsearch/understanding/8.a%20kv%20life/","title":"A Vertex Life in Nebula Graph Storaged","text":""},{"location":"projects/nebula-vsearch/understanding/8.a%20kv%20life/#a-vertex-life-in-nebula-graph-storaged","title":"A Vertex Life in Nebula Graph Storaged","text":"<p> \u7ea6 230 \u4e2a\u5b57  73 \u884c\u4ee3\u7801  2 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p> 2025-12-022025-12-10 <p>\u5728 Nebula Graph \u4e2d\uff0c\u4e00\u4e2a Vertex \u7684\u751f\u547d\u5468\u671f\u4ece\u521b\u5efa\u5230\u5220\u9664\uff0c\u6d89\u53ca\u5230\u591a\u4e2a\u7ec4\u4ef6\u548c\u6d41\u7a0b\u3002\u672c\u6587\u5c06\u8be6\u7ec6\u4ecb\u7ecd\u4e00\u4e2a Vertex \u7684\u751f\u547d\u5468\u671f\uff0c\u7531\u6b64\u6765\u501f\u9274\u5b9e\u73b0 VECTOR \u7c7b\u578b\u5c5e\u6027\u7684\u5b58\u50a8\u548c\u5904\u7406\u6d41\u7a0b\u3002</p>"},{"location":"projects/nebula-vsearch/understanding/8.a%20kv%20life/#vertex-creation","title":"Vertex Creation","text":"<p>\u5728 Nebula Graph \u4e2d\uff0cVertex \u7684\u521b\u5efa\u901a\u5e38\u901a\u8fc7 <code>AddVerticesProcessor</code> executor \u6765\u5b8c\u6210\u3002\u5b83\u4f1a\u5c06 Vertex \u8981\u63d2\u5165\u7684\u6570\u636e\u5df2\u7ecf\u5143\u6570\u636e\u6253\u5305\u6210 raft-wal log\uff0c\u63d0\u4ea4\u5230 Raft Part \u4e2d\uff0c\u6700\u540e\u5728 Part::commitLogs()\u4e2d\u5c06\u6570\u636e\u5199\u5165\u5230 RocksDB\u3002</p> <p></p>"},{"location":"projects/nebula-vsearch/understanding/8.a%20kv%20life/#vertex-search","title":"Vertex Search","text":"<p>Vertex \u7684\u67e5\u8be2\u53ef\u4ee5\u901a\u8fc7 Match\uff0cGO \u4ee5\u53ca Fetch \u8fdb\u884c\u67e5\u8be2\uff0c\u8fd9\u91cc\u6211\u4eec\u5148\u8ba8\u8bba\u6700\u7b80\u5355\u7684 Fetch \u67e5\u8be2\u3002</p>"},{"location":"projects/nebula-vsearch/understanding/8.a%20kv%20life/#fetch","title":"Fetch \u67e5\u8be2","text":"<p><code>FETCH PROP ON test1 \"t1\" YIELD properties(vertex);</code>\u8bed\u53e5\u6267\u884c\u8ba1\u5212\u5982\u4e0b\uff1a</p> C++<pre><code>-----+-------------+--------------+----------------+------------------------------\n| id | name        | dependencies | profiling data | operator info               |\n-----+-------------+--------------+----------------+------------------------------\n|  2 | Project     | 1            |                | outputVar: {                |\n|    |             |              |                |   \"colNames\": [             |\n|    |             |              |                |     \"properties(VERTEX)\"    |\n|    |             |              |                |   ],                        |\n|    |             |              |                |   \"name\": \"__Project_2\",    |\n|    |             |              |                |   \"type\": \"DATASET\"         |\n|    |             |              |                | }                           |\n|    |             |              |                | inputVar: __GetVertices_1   |\n|    |             |              |                | columns: [                  |\n|    |             |              |                |   \"properties(VERTEX)\"      |\n|    |             |              |                | ]                           |\n-----+-------------+--------------+----------------+------------------------------\n|  1 | GetVertices | 0            |                | outputVar: {                |\n|    |             |              |                |   \"colNames\": [],           |\n|    |             |              |                |   \"type\": \"DATASET\",        |\n|    |             |              |                |   \"name\": \"__GetVertices_1\" |\n|    |             |              |                | }                           |\n|    |             |              |                | inputVar: __VAR_0           |\n|    |             |              |                | space: 2                    |\n|    |             |              |                | dedup: 0                    |\n|    |             |              |                | limit: -1                   |\n|    |             |              |                | filter:                     |\n|    |             |              |                | orderBy: []                 |\n|    |             |              |                | src: COLUMN[0]              |\n|    |             |              |                | props: [                    |\n|    |             |              |                |   {                         |\n|    |             |              |                |     \"props\": [              |\n|    |             |              |                |       \"_tag\",               |\n|    |             |              |                |       \"embedding\",          |\n|    |             |              |                |       \"name\"                |\n|    |             |              |                |     ],                      |\n|    |             |              |                |     \"tagId\": 3              |\n|    |             |              |                |   }                         |\n|    |             |              |                | ]                           |\n|    |             |              |                | exprs:                      |\n-----+-------------+--------------+----------------+------------------------------\n|  0 | Start       |              |                | outputVar: {                |\n|    |             |              |                |   \"colNames\": [],           |\n|    |             |              |                |   \"type\": \"DATASET\",        |\n|    |             |              |                |   \"name\": \"__Start_0\"       |\n|    |             |              |                | }                           |\n-----+-------------+--------------+----------------+------------------------------\n</code></pre> <p>Fetch \u67e5\u8be2\u4f1a\u6700\u7ec8\u8c03\u7528<code>GetVerticesProcessor</code> executor\u3002\u8fd9\u4e2a executor \u4f1a\u751f\u6210 Node \u7684\u6267\u884c\u8ba1\u5212\uff0c\u6267\u884c GetTagPropNode \u7684\u8ba1\u5212\uff0c\u6211\u4eec\u9700\u8981\u5728<code>GetTagPropNode::doExecute</code>\u65b9\u6cd5\u4e2d\u89e3\u6790\u5728<code>TagNode::doExecute</code>\u4e2d\u4ece kvstore \u4e2d\u83b7\u53d6\u7684 value\u3002</p> C++<pre><code>List row;\nfor (auto* tagNode : tagNodes_) {\n  ret = tagNode-&gt;collectTagPropsIfValid(\n      [&amp;row, tagNode, this](const std::vector&lt;PropContext&gt;* props) -&gt; nebula::cpp2::ErrorCode {\n        for (const auto&amp; prop : *props) {\n          if (prop.returned_) {\n            row.emplace_back(Value());\n          }\n          if (prop.filtered_ &amp;&amp; expCtx_ != nullptr) {\n            expCtx_-&gt;setTagProp(tagNode-&gt;getTagName(), prop.name_, Value());\n          }\n        }\n        return nebula::cpp2::ErrorCode::SUCCEEDED;\n      },\n      [&amp;row, vIdLen, isIntId, tagNode, this](\n          folly::StringPiece key,\n          RowReaderWrapper* reader,\n          RowReaderWrapper* vectorReader,\n          const std::vector&lt;PropContext&gt;* props) -&gt; nebula::cpp2::ErrorCode {\n          // \u5411row\u4e2d\u6dfb\u52a0\u89e3\u6790\u540evertex\u7684\u5c5e\u6027\u5bf9\u5e94\u7684value\n        auto status = QueryUtils::collectVertexProps(\n            key, vIdLen, isIntId, reader, vecReader, props, row, expCtx_.get(), tagNode-&gt;getTagName());\n        if (!status.ok()) {\n          return nebula::cpp2::ErrorCode::E_TAG_PROP_NOT_FOUND;\n        }\n        return nebula::cpp2::ErrorCode::SUCCEEDED;\n      });\n}\n</code></pre>"},{"location":"summary/","title":"index","text":""},{"location":"summary/#summaries","title":"Summaries \ud83d\uddd3\ufe0f","text":"2025-12-022025-12-10 <p>\u300e \u0915\u093f\u0928\u094d\u0928\u0930\u093f\u092f \u092e\u092e \u0924\u0923\u094d\u0939\u093e \u300f </p> <p></p>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/","title":"\u5b66\u4e60\u8ba1\u5212","text":"<p> \u7ea6 1043 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u5e95\u5c42\u7b97\u5b50\u548c\u6027\u80fd\u5206\u6790\u662f\u901a\u7528\u7684\u57fa\u77f3\uff0c\u5f80\u4e0a\u5219\u5206\u5316\u4e3a\u201c\u663e\u5b58\u654f\u611f\u578b\uff08LLM\uff09\u201d\u548c\u201c\u8ba1\u7b97\u5bc6\u96c6\u578b\uff08DiT\uff09\u201d\u4e24\u4e2a\u65b9\u5411</p>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#1-2","title":"\u7b2c\u4e00\u9636\u6bb5\uff1a\u901a\u7528\u57fa\u77f3\uff08\u5fc5\u4fee\uff0c\u7ea6 1-2 \u4e2a\u6708\uff09","text":"<p>\u76ee\u6807\uff1a \u4e0d\u7ba1\u505a LLM \u8fd8\u662f DiT\uff0c\u5982\u679c\u4e0d\u4e86\u89e3 GPU \u600e\u4e48\u5de5\u4f5c\uff0c\u5c31\u65e0\u6cd5\u505a\u6781\u81f4\u4f18\u5316\u3002\u8fd9\u4e00\u6b65\u5bf9\u5e94\u539f\u6587\u7684 \u201c\u6027\u80fd\u5206\u6790\u201d \u548c \u201c\u9ad8\u6027\u80fd\u8ba1\u7b97\u201d\u3002</p> <ol> <li> <p>\u6027\u80fd\u5206\u6790\u5de5\u5177 (Profiling):</p> <ul> <li> <p>\u91cd\u70b9\u5b66\u4e60\uff1a \u719f\u7ec3\u4f7f\u7528 Nsight Systems (<code>nsys</code>) \u548c Nsight Compute (<code>ncu</code>)\uff0c\u4ee5\u53ca PyTorch \u81ea\u5e26\u7684 Profiler\u3002</p> </li> <li> <p>\u5b9e\u6218\uff1a \u968f\u4fbf\u8dd1\u4e00\u4e2a PyTorch \u7684 Transformer Demo\uff0c\u7528 <code>nsys</code> \u6293\u53d6 timeline\uff0c\u770b\u61c2 CPU/GPU \u7684\u6d41\u6c34\u7ebf\uff0c\u8bc6\u522b\u4ec0\u4e48\u662f Kernel Launch \u74f6\u9888\uff0c\u4ec0\u4e48\u662f HBM\uff08\u663e\u5b58\u5e26\u5bbd\uff09\u74f6\u9888\u3002</p> </li> </ul> </li> <li> <p>\u7b97\u5b50\u7f16\u7a0b (Kernel):</p> <ul> <li> <p>CUDA &amp; Triton\uff1a \u5b66\u4e60 CUDA \u7f16\u7a0b\u6a21\u578b\uff08Grid/Block/Thread\uff09\uff0c\u7406\u89e3\u663e\u5b58\u5c42\u7ea7\uff08Global/Shared/Register\uff09\u3002Triton \u662f\u76ee\u524d\u7684\u8d8b\u52bf\uff0c\u5165\u624b\u95e8\u69db\u6bd4 CUDA \u4f4e\uff0c\u9002\u5408\u7f16\u5199\u878d\u5408\u7b97\u5b50\u3002</p> </li> <li> <p>FlashAttention (FA)\uff1a \u8fd9\u662f\u91cd\u4e2d\u4e4b\u91cd\u3002 \u539f\u6587\u660e\u786e\u63d0\u5230\u201c\u5403\u900f\u7b97\u6cd5\u539f\u7406\u548c\u4ee3\u7801\u5b9e\u73b0\u201d\u3002FA \u662f LLM \u548c DiT \u7684\u5171\u540c\u52a0\u901f\u6838\u5fc3\u3002</p> <ul> <li>\u4efb\u52a1\uff1a \u9605\u8bfb FlashAttention V1/V2 \u8bba\u6587\uff0c\u7406\u89e3\u5b83\u5982\u4f55\u5229\u7528 Tiling \u6280\u672f\u51cf\u5c11 HBM \u8bbf\u95ee\u3002</li> </ul> </li> </ul> </li> </ol>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#llm-memory-wall","title":"\u7b2c\u4e8c\u9636\u6bb5\uff1aLLM \u63a8\u7406\u8def\u7ebf (Memory Wall \u653b\u575a\u6218)","text":"<p>\u6838\u5fc3\u903b\u8f91\uff1a LLM \u63a8\u7406\u7684\u6838\u5fc3\u74f6\u9888\u5728\u4e8e KV Cache \u5e26\u6765\u7684\u663e\u5b58\u538b\u529b\u548c IO \u74f6\u9888\u3002\u5bf9\u5e94\u539f\u6587 \u201c\u590d\u6742\u7cfb\u7edf\u201d \u4e2d\u7684 LLM \u5173\u952e\u8bcd\u3002</p>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#1-pagedattention","title":"1. \u663e\u5b58\u7ba1\u7406\u4e0e PagedAttention","text":"<ul> <li> <p>\u75db\u70b9\uff1a \u4f20\u7edf\u7684 KV Cache \u663e\u5b58\u5206\u914d\u662f\u9759\u6001\u7684\uff0c\u6d6a\u8d39\u4e25\u91cd\u3002</p> </li> <li> <p>\u5b66\u4e60\u91cd\u70b9\uff1a</p> <ul> <li> <p>KV Cache \u673a\u5236\uff1a \u7406\u89e3 Autoregressive \u751f\u6210\u8fc7\u7a0b\u4e2d KV \u77e9\u9635\u662f\u5982\u4f55\u589e\u957f\u7684\u3002</p> </li> <li> <p>PagedAttention\uff1a \u6df1\u5165\u9605\u8bfb vLLM \u6e90\u7801\u3002\u7406\u89e3\u5b83\u5982\u4f55\u50cf\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u5185\u5b58\u9875\u4e00\u6837\u7ba1\u7406\u663e\u5b58\uff0c\u5b9e\u73b0 KV Cache \u7684\u975e\u8fde\u7eed\u5b58\u50a8\uff0c\u4ece\u800c\u6781\u9ad8\u5730\u63d0\u5347 Batch Size\u3002</p> </li> </ul> </li> </ul>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#2","title":"2. \u63a8\u7406\u8c03\u5ea6\u7b56\u7565","text":"<ul> <li> <p>Continuous Batching (Orca)\uff1a \u5b66\u4e60\u5982\u4f55\u5728\u8fd9\u4e2a Batch \u4e2d\u52a8\u6001\u63d2\u5165\u65b0\u8bf7\u6c42\uff0c\u800c\u4e0d\u662f\u7b49\u6240\u6709\u8bf7\u6c42\u90fd\u8dd1\u5b8c\u3002</p> </li> <li> <p>PD \u5206\u79bb (Prefill-Decode Separation)\uff1a \u539f\u6587\u63d0\u5230\u7684\u201cPD\u5206\u79bb\u201d\u3002Prefill \u9636\u6bb5\u662f\u8ba1\u7b97\u5bc6\u96c6\u578b\uff0cDecode \u9636\u6bb5\u662f\u8bbf\u5b58\u5bc6\u96c6\u578b\u3002\u5b66\u4e60\u5982\u4f55\u5c06\u8fd9\u4e24\u4e2a\u9636\u6bb5\u62c6\u5206\u5230\u4e0d\u540c\u7684 GPU \u751a\u81f3\u96c6\u7fa4\u4e0a\u5904\u7406\uff08\u5982 Splitwise \u67b6\u6784\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#3","title":"3. \u6846\u67b6\u4e0e\u6a21\u578b\u5e76\u884c","text":"<ul> <li> <p>\u6846\u67b6\u5b66\u4e60\uff1a \u6df1\u5165 vLLM (\u4e1a\u754c\u6807\u6746) \u548c SGLang (\u66f4\u9ad8\u6548\u7684\u8c03\u5ea6\u524d\u7aef)\u3002</p> </li> <li> <p>\u5e76\u884c\u7b56\u7565\uff1a \u91cd\u70b9\u638c\u63e1 TP (Tensor Parallelism)\u3002\u56e0\u4e3a\u5355\u4e2a GPU \u663e\u5b58\u653e\u4e0d\u4e0b\u5927\u6a21\u578b\uff0c\u63a8\u7406\u65f6\u4e3b\u8981\u9760 TP \u5207\u5206\u53c2\u6570\u77e9\u9635\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#4-quantization","title":"4. \u91cf\u5316 (Quantization)","text":"<ul> <li> <p>\u76ee\u6807\uff1a \u964d\u4f4e\u663e\u5b58\u5360\u7528\uff0c\u63d0\u5347\u541e\u5410\u3002</p> </li> <li> <p>\u6280\u672f\u70b9\uff1a W4A16 (\u6743\u91cd4bit\uff0c\u6fc0\u6d3b16bit) \u662f\u4e3b\u6d41\u3002\u5b66\u4e60 AWQ, GPTQ \u7b97\u6cd5\u539f\u7406\u53ca\u5728 TensorRT-LLM \u6216 vLLM \u4e2d\u7684\u5b9e\u73b0\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#dit-compute-bound","title":"\u7b2c\u4e09\u9636\u6bb5\uff1aDiT \u63a8\u7406\u8def\u7ebf (Compute Bound \u653b\u575a\u6218)","text":"<p>\u6838\u5fc3\u903b\u8f91\uff1a \u89c6\u89c9\u751f\u6210\uff08DiT\uff09\u4e0e LLM \u4e0d\u540c\uff0c\u5b83\u901a\u5e38\u4e0d\u662f Autoregressive \u7684\uff08Sora \u7c7b\u89c6\u9891\u751f\u6210\u9664\u5916\uff09\uff0c\u800c\u662f\u57fa\u4e8e Diffusion \u7684\u8fed\u4ee3\u53bb\u566a\u3002\u5b83\u5bf9 \u5e8f\u5217\u5e76\u884c \u548c \u8ba1\u7b97 \u7684\u8981\u6c42\u66f4\u9ad8\u3002\u5bf9\u5e94\u539f\u6587 \u201c\u89c6\u89c9\u751f\u6210\u201d \u548c \u201cxdit\u201d\u3002</p>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#1","title":"1. \u67b6\u6784\u8ba4\u77e5","text":"<ul> <li> <p>DiT \u539f\u7406\uff1a \u9605\u8bfb Scalable Diffusion Models with Transformers (DiT) \u8bba\u6587\u3002\u7406\u89e3\u5b83\u5982\u4f55\u628a\u56fe\u50cf Patch \u5316\u540e\u5582\u7ed9 Transformer\u3002</p> </li> <li> <p>\u533a\u522b\uff1a \u76f8\u6bd4 LLM\uff0cDiT \u7684 Sequence Length\uff08\u5e8f\u5217\u957f\u5ea6\uff09\u53ef\u80fd\u975e\u5e38\u957f\uff08\u7279\u522b\u662f\u89c6\u9891\u751f\u6210\uff09\uff0c\u4e14\u6ca1\u6709 KV Cache \u7684\u5386\u53f2\u4f9d\u8d56\uff08\u6bcf\u4e00\u6b65\u53bb\u566a\u90fd\u662f\u5168\u65b0\u7684\u8f93\u5165\uff09\uff0c\u56e0\u6b64\u8ba1\u7b97\u538b\u529b\u6781\u5927\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#2_1","title":"2. \u5e76\u884c\u52a0\u901f\u7b56\u7565","text":"<ul> <li> <p>DistriFusion / xDiT\uff1a \u539f\u6587\u4e13\u95e8\u63d0\u5230\u4e86 xdit\u3002\u8fd9\u662f DiT \u63a8\u7406\u7684\u5173\u952e\u3002</p> <ul> <li> <p>\u6838\u5fc3\uff1a \u65e2\u7136\u6ca1\u6709\u524d\u540e token \u7684\u5f3a\u56e0\u679c\u4f9d\u8d56\uff08\u9488\u5bf9\u5355\u5e27\u751f\u6210\uff09\uff0c\u5982\u4f55\u628a\u4e00\u5f20\u56fe\u5207\u6210\u591a\u5757\uff08Patch\uff09\u5206\u7ed9\u4e0d\u540c\u7684 GPU \u7b97\uff1f</p> </li> <li> <p>\u6280\u672f\u70b9\uff1a SP (Sequence Parallelism) \u548c Ulysses Attention\u3002\u5b66\u4e60\u5982\u4f55\u5728\u591a\u5361\u4e4b\u95f4\u5207\u5206 Attention \u8ba1\u7b97\uff0c\u51cf\u5c11\u901a\u4fe1\u5f00\u9500\u3002</p> </li> </ul> </li> </ul>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#3_1","title":"3. \u7f16\u8bd1\u4f18\u5316","text":"<ul> <li> <p>Torch.compile / TensorRT\uff1a DiT \u7684\u6a21\u578b\u7ed3\u6784\u76f8\u5bf9\u9759\u6001\uff08\u8f93\u5165 shape \u5f80\u5f80\u56fa\u5b9a\uff09\uff0c\u975e\u5e38\u9002\u5408\u505a\u56fe\u5c42\u7ea7\u7684\u7f16\u8bd1\u4f18\u5316\uff08Graph Compilation\uff09\u3002</p> </li> <li> <p>\u4efb\u52a1\uff1a \u5b66\u4e60\u5982\u4f55\u4f7f\u7528 <code>torch.compile</code> \u5bf9 DiT \u7ba1\u9053\u8fdb\u884c\u52a0\u901f\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/#infra","title":"\u7b2c\u56db\u9636\u6bb5\uff1a\u878d\u4f1a\u8d2f\u901a\u4e0e\u5de5\u7a0b\u5b9e\u8df5 (Infra \u8fdb\u9636)","text":"<p>\u76ee\u6807\uff1a \u5bf9\u5e94\u539f\u6587 \u201c\u9886\u57df\u8ba4\u77e5\u201d \u548c \u201c\u96c6\u7fa4\u8c03\u5ea6\u201d\u3002</p> <ol> <li> <p>\u9605\u8bfb\u6e90\u7801\uff1a</p> <ul> <li> <p>LLM\uff1a \u5fc5\u987b\u8bfb vLLM \u7684 <code>core</code> (\u8c03\u5ea6\u903b\u8f91) \u548c <code>layers</code> (Attention \u5b9e\u73b0) \u76ee\u5f55\u3002</p> </li> <li> <p>DiT\uff1a \u9605\u8bfb xDiT \u6216 Diffusers \u5e93\u4e2d\u5173\u4e8e Pipeline \u7684\u5b9e\u73b0\u3002</p> </li> </ul> </li> <li> <p>\u4e1a\u754c\u52a8\u6001\uff1a \u5173\u6ce8 DeepSpeed-MII, TensorRT-LLM \u7684\u66f4\u65b0\u65e5\u5fd7\u3002</p> </li> <li> <p>\u90e8\u7f72\uff1a \u5b66\u4e60\u4f7f\u7528 Ray Serve \u6216 K8s \u5c06\u4f60\u7684\u63a8\u7406\u5f15\u64ce\u5305\u88c5\u6210 API \u670d\u52a1\u3002</p> </li> </ol>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/","title":"\ud83d\ude80 SGLang \u5f00\u6e90\u8d21\u732e\u4e0e Triton \u8fdb\u9636\u8def\u7ebf\u56fe","text":""},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#sglang-triton","title":"\ud83d\ude80 SGLang \u5f00\u6e90\u8d21\u732e\u4e0e Triton \u8fdb\u9636\u8def\u7ebf\u56fe","text":"<p> \u7ea6 1110 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u542f\u52a8\u65f6\u95f4\uff1a 2025\u5e7412\u6708\u4e2d\u65ec \u6838\u5fc3\u6218\u7565\uff1a \u7528 MiniInfer \u7ec3\u624b Triton\uff0c\u7528 SGLang \u5237\u7b80\u5386\uff0c\u7528 PMPP \u56fa\u672c\u57f9\u5143\u3002</p>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#triton","title":"\ud83d\udcc5 \u7b2c\u4e00\u9636\u6bb5\uff1aTriton \u901f\u6210\u4e0e\u6295\u673a\u91c7\u6837\u539f\u578b","text":"<p>\u65f6\u95f4\u8de8\u5ea6\uff1a 12\u670815\u65e5 - 12\u670831\u65e5 \u6838\u5fc3\u76ee\u6807\uff1a \u5728 MiniInfer \u4e2d\u8dd1\u901a\u6700\u7b80\u964b\u7684 Speculative Decoding (Python + Triton)\uff0c\u7406\u89e3 GPU \u7ebf\u7a0b\u6a21\u578b\u3002</p>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#a-pr-miniinfer-triton","title":"\ud83e\uddf5 \u7ebf\u7a0b A: PR \u5b9e\u6218 (MiniInfer &amp; Triton)","text":"<ul> <li> <p> MiniInfer \u903b\u8f91\u6784\u5efa:</p> </li> <li> <p> \u7528\u7eaf PyTorch \u5b9e\u73b0 <code>Draft Model -&gt; Verify -&gt; Accept/Reject</code> \u5faa\u73af\u3002</p> </li> <li> <p> \u5173\u952e\u70b9: \u7406\u89e3 KV Cache \u7684\u201c\u56de\u6eda\u201d\u673a\u5236\uff08\u5f53 Draft \u9519\u8bef\u65f6\uff0cKV Cache \u600e\u4e48\u622a\u65ad\uff1f\uff09\u3002</p> </li> <li> <p> Triton \u5b98\u65b9\u901a\u5173:</p> </li> <li> <p> \u9605\u8bfb\u5e76\u8fd0\u884c Triton Tutorials: <code>01-Vector-Add</code>, <code>02-Fused-Softmax</code>.</p> </li> <li> <p> \u7406\u89e3 <code>@triton.jit</code> \u548c <code>tl.load/store</code> \u7684\u57fa\u672c\u8bed\u6cd5\u3002</p> </li> <li> <p> Triton \u5b9e\u6218 (Verification Kernel):</p> </li> <li> <p> \u5c06 Speculative Decoding \u4e2d\u7684 \"Verification\" \u6b65\u9aa4\uff08\u6bd4\u8f83 Draft Token \u548c Target Token\uff09\u5199\u6210\u4e00\u4e2a\u7b80\u5355\u7684 Triton Kernel\u3002</p> </li> <li> <p> KPI: \u66ff\u6362\u6389 PyTorch \u7684\u6bd4\u8f83\u64cd\u4f5c\uff0c\u8dd1\u901a\u6d41\u7a0b\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#b-cuda-c-pmpp","title":"\ud83d\udcd8 \u7ebf\u7a0b B: \u9762\u8bd5\u5185\u529f (CUDA C++ / PMPP)","text":"<ul> <li> <p> PMPP Ch 1-3 (\u57fa\u7840):</p> </li> <li> <p> \u6df1\u523b\u7406\u89e3 Grid, Block, Thread \u7684\u4e09\u7ef4\u7d22\u5f15\u8ba1\u7b97\u3002</p> </li> <li> <p> \u9762\u8bd5\u9898: \"\u89e3\u91ca\u4e00\u4e0b CUDA \u7684\u7ebf\u7a0b\u5c42\u7ea7\uff1fBlock \u548c Grid \u6709\u4ec0\u4e48\u7269\u7406\u5bf9\u5e94\u5173\u7cfb\uff1f\"</p> </li> <li> <p> \u624b\u5199 Kernel 1 (CUDA C++):</p> </li> <li> <p> \u5373\u4f7f\u5b66 Triton\uff0c\u4e5f\u8981\u5199\u4e00\u4e2a CUDA C++ \u7684 <code>VectorAdd</code>\u3002</p> </li> <li> <p> \u5b66\u4f1a <code>nvcc</code> \u7f16\u8bd1\u6d41\u7a0b\uff0c\u5b66\u4f1a\u600e\u4e48\u628a C++ Kernel \u4e5f\u5c31\u662f <code>.cu</code> \u6587\u4ef6\u901a\u8fc7 PyBind \u6216\u8005\u662f ctypes \u6302\u7ed9 Python \u8c03\u7528\uff08\u8fd9\u4e00\u6b65\u662f\u4e3a\u4e86\u7406\u89e3 Triton \u5e2e\u4f60\u7701\u4e86\u4ec0\u4e48\uff09\u3002</p> </li> <li> <p> \u6982\u5ff5\u653b\u575a:</p> </li> <li> <p> Warp Divergence: \u4e3a\u4ec0\u4e48 <code>if (threadIdx.x &lt; 16)</code> \u8fd9\u79cd\u5199\u6cd5\u5728\u8001\u67b6\u6784\u4e0a\u6548\u7387\u4f4e\uff1f(\u867d\u7136 Volta \u4e4b\u540e\u6709\u72ec\u7acb\u8c03\u5ea6\uff0c\u4f46\u4ecd\u9700\u7406\u89e3)\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#sglang","title":"\ud83d\udcc5 \u7b2c\u4e8c\u9636\u6bb5\uff1aSGLang \u6e90\u7801\u72d9\u51fb\u4e0e\u5185\u5b58\u4f18\u5316","text":"<p>\u65f6\u95f4\u8de8\u5ea6\uff1a 1\u67081\u65e5 - 1\u670820\u65e5 \u6838\u5fc3\u76ee\u6807\uff1a \u9501\u5b9a SGLang \u7684 Issue\uff0c\u628a Triton Kernel \u79fb\u690d\u8fc7\u53bb\uff0c\u653b\u514b\u9762\u8bd5\u6700\u96be\u7684\u201c\u5185\u5b58\u4f18\u5316\u201d\u3002</p>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#a-pr-sglang","title":"\ud83e\uddf5 \u7ebf\u7a0b A: PR \u5b9e\u6218 (SGLang \u79fb\u690d)","text":"<ul> <li> <p> \u9501\u5b9a Issue:</p> </li> <li> <p> \u5728 SGLang GitHub Issues \u4e2d\u641c\u7d22\u5173\u952e\u8bcd\uff1a<code>Eagle</code>, <code>Medusa</code>, <code>Speculative</code>, \u6216 <code>Kernel Optimization</code>\u3002</p> </li> <li> <p> \u5bfb\u627e <code>Good First Issue</code> \u6216\u8005\u5373\u4f7f\u6ca1\u6709 Issue\uff0c\u53bb\u8bfb <code>sglang/srt/model/eagle</code> \u76ee\u5f55\u4e0b\u7684\u4ee3\u7801\u3002</p> </li> <li> <p> \u4ee3\u7801\u79fb\u690d:</p> </li> <li> <p> \u5c06\u4f60\u5728 MiniInfer \u7ec3\u624b\u7684 Triton \u9a8c\u8bc1\u7b97\u5b50\uff0c\u6216\u8005 Tree Attention \u7684 Mask \u751f\u6210\u903b\u8f91\uff0c\u5c1d\u8bd5\u6309\u7167 SGLang \u7684\u4ee3\u7801\u98ce\u683c\u91cd\u5199\u3002</p> </li> <li> <p> Benchmark \u5bf9\u6bd4:</p> </li> <li> <p> \u4f7f\u7528 <code>sglang/benchmarks</code> \u4e0b\u7684\u811a\u672c\u3002</p> </li> <li> <p> KPI: \u4f60\u7684 Triton Kernel \u5fc5\u987b\u6bd4\u7eaf PyTorch \u5b9e\u73b0\u5feb\uff0c\u6216\u8005\u663e\u5b58\u5360\u7528\u66f4\u4f4e\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#b-pmpp","title":"\ud83d\udcd8 \u7ebf\u7a0b B: \u9762\u8bd5\u5185\u529f (PMPP \u6838\u5fc3)","text":"<ul> <li> <p> PMPP Ch 4 (Global Memory):</p> </li> <li> <p> \u6838\u5fc3\u5fc5\u6740\u6280: Coalesced Access (\u5408\u5e76\u8bbf\u95ee)\u3002</p> </li> <li> <p> NCU \u5b9e\u6218: \u5728\u4f60\u7684 Triton Kernel \u4e0a\u7528 NCU \u6b64\u65f6\u53ef\u80fd\u770b\u4e0d\u592a\u61c2 PTX\uff0c\u4f46\u8981\u7406\u89e3 Triton \u7f16\u8bd1\u5668\u662f\u5982\u4f55\u81ea\u52a8\u5e2e\u4f60\u505a Coalescing \u7684\uff08\u901a\u8fc7 Block \u6307\u9488\uff09\u3002</p> </li> <li> <p> PMPP Ch 5 (Shared Memory):</p> </li> <li> <p> \u624b\u5199 Kernel 2: Tiled GEMM (Shared Memory \u7248\u672c)\u3002</p> </li> <li> <p> \u753b\u56fe: \u5fc5\u987b\u80fd\u624b\u753b\u51fa Tiling \u7684\u6570\u636e\u642c\u8fd0\u56fe\u3002</p> </li> <li> <p> \u9762\u8bd5\u9898: \"\u4ec0\u4e48\u662f Bank Conflict\uff1fTriton \u91cc\u600e\u4e48\u89e3\u51b3 Bank Conflict\uff1f\" (\u63d0\u793a\uff1aTriton \u7f16\u8bd1\u5668\u901a\u5e38\u81ea\u52a8\u5904\u7406\uff0c\u4f46\u4f60\u8981\u61c2\u539f\u7406)\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#pr","title":"\ud83d\udcc5 \u7b2c\u4e09\u9636\u6bb5\uff1a\u53d1\u8d77 PR \u4e0e\u9ad8\u9636\u9762\u8bd5\u9898","text":"<p>\u65f6\u95f4\u8de8\u5ea6\uff1a 1\u670821\u65e5 - 2\u670810\u65e5 \u6838\u5fc3\u76ee\u6807\uff1a \u63d0\u4ea4 PR\uff0c\u5229\u7528 Code Review \u671f\u95f4\u7a81\u51fb H100 \u65b0\u7279\u6027\u3002</p>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#a-pr","title":"\ud83e\uddf5 \u7ebf\u7a0b A: PR \u5b9e\u6218 (\u63d0\u4ea4\u4e0e\u4ea4\u4e92)","text":"<ul> <li> <p> \u63d0\u4ea4 PR:</p> </li> <li> <p> \u5199\u4e00\u4efd\u9ad8\u8d28\u91cf\u7684 PR Description\u3002</p> </li> <li> <p> \u5173\u952e: \u9644\u4e0a Benchmark \u622a\u56fe\uff08\"Latancy reduced by X% on A100/H100\"\uff09\u3002</p> </li> <li> <p> Code Review \u54cd\u5e94:</p> </li> <li> <p> \u7ef4\u62a4\u8005 (Maintainer) \u53ef\u80fd\u4f1a\u6311\u6218\u4f60\u7684\u8fb9\u754c\u6761\u4ef6 (Edge Cases) \u6216\u4ee3\u7801\u98ce\u683c\u3002</p> </li> <li> <p> \u5fc3\u6001: \u4e0d\u8981\u6015\u88ab\u603c\uff0c\u8fd9\u662f\u5b66\u4e60\u6700\u5feb\u7684\u65f6\u5019\u3002</p> </li> <li> <p> \u5355\u5143\u6d4b\u8bd5:</p> </li> <li> <p> \u4e3a\u4f60\u7684 Kernel \u8865\u5145 PyTest \u6d4b\u8bd5\u7528\u4f8b (<code>tests/</code> \u76ee\u5f55\u4e0b)\uff0c\u786e\u4fdd\u6570\u503c\u6b63\u786e\u6027\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#b-h100","title":"\ud83d\udcd8 \u7ebf\u7a0b B: \u9762\u8bd5\u5185\u529f (\u9ad8\u9636/H100)","text":"<ul> <li> <p> PMPP Ch 10 (Reduction):</p> </li> <li> <p> \u5b66\u4e60 Warp Shuffle (<code>__shfl_down_sync</code>)\u3002\u8fd9\u662f\u73b0\u4ee3 CUDA Reduction \u7684\u6807\u51c6\u5199\u6cd5\u3002</p> </li> <li> <p> \u624b\u5199 Kernel 3 (Softmax):</p> </li> <li> <p> \u7ed3\u5408 Reduction \u548c Shuffle\uff0c\u624b\u5199\u4e00\u4e2a Online Softmax \u7684 CUDA C++ \u4f2a\u4ee3\u7801\u3002</p> </li> <li> <p> H100 \u67b6\u6784 (Hopper):</p> </li> <li> <p> \u9605\u8bfb Hopper Whitepaper\u3002</p> </li> <li> <p> \u6982\u5ff5: \u4ec0\u4e48\u662f TMA (Tensor Memory Accelerator)\uff1f\u4ec0\u4e48\u662f FP8\uff1f</p> </li> <li> <p> \u9762\u8bd5\u9898: \"H100 \u76f8\u6bd4 A100\uff0c\u9664\u4e86\u7b97\u529b\u63d0\u5347\uff0c\u67b6\u6784\u4e0a\u6700\u5927\u7684\u6539\u52a8\u662f\u4ec0\u4e48\uff1f\" (\u7b54\u6848\u5e94\u5305\u542b TMA \u548c Transformer Engine)\u3002</p> </li> </ul>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#mock-interview","title":"\ud83d\udcc5 \u7b2c\u56db\u9636\u6bb5\uff1a\u7b80\u5386\u5b8c\u5584\u4e0e Mock Interview","text":"<p>\u65f6\u95f4\u8de8\u5ea6\uff1a 2\u670811\u65e5 - 2\u6708\u5e95 \u6838\u5fc3\u76ee\u6807\uff1a \u5c06 PR \u7ecf\u5386\u8f6c\u5316\u4e3a\u201c\u9762\u8bd5\u6545\u4e8b\u201d\u3002</p>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#resume-polish","title":"\ud83d\udcdd \u7b80\u5386\u5305\u88c5 (Resume Polish)","text":"<ul> <li> <p> \u4f18\u5316\u63cf\u8ff0:</p> </li> <li> <p>Before: \"Learned CUDA and optimized SGLang.\"</p> </li> <li> <p>After: \"Designed and implemented a high-performance Triton-based Verification Kernel for Speculative Decoding in SGLang; achieved 30% latency reduction in verification stage on H100 GPUs by optimizing memory access patterns.\"</p> </li> <li> <p> \u6dfb\u52a0\u6280\u80fd\u70b9: Triton, CUDA C++, PyTorch, Nsight Compute, LLM Inference (Speculative Decoding).</p> </li> </ul>"},{"location":"summary/2025/December/%F0%9F%9A%80%20SGLang%20%E5%BC%80%E6%BA%90%E8%B4%A1%E7%8C%AE%E4%B8%8E%20Triton%20%E8%BF%9B%E9%98%B6%E8%B7%AF%E7%BA%BF%E5%9B%BE/#mock-interview_1","title":"\ud83d\udde3\ufe0f \u6a21\u62df\u9762\u8bd5 (Mock Interview)","text":"<ul> <li> <p> \u6280\u672f\u5bf9\u7b54:</p> </li> <li> <p>\"\u4f60\u7684 Kernel \u662f Memory Bound \u8fd8\u662f Compute Bound\uff1f\u4f60\u662f\u600e\u4e48\u5224\u65ad\u7684\uff1f\"</p> </li> <li> <p>\"\u5982\u679c\u4e0d\u7528 Triton\uff0c\u7528 CUDA C++ \u5199\u8fd9\u4e2a\u7b97\u5b50\uff0c\u4f60\u4f1a\u600e\u4e48\u4f18\u5316 Shared Memory \u7684\u4f7f\u7528\uff1f\"</p> </li> <li> <p> \u573a\u666f\u9898:</p> </li> <li> <p>\"\u5728 Speculative Decoding \u4e2d\uff0c\u5982\u679c Draft Model \u7684\u547d\u4e2d\u7387\u5f88\u4f4e\uff0c\u4f60\u7684\u4f18\u5316\u8fd8\u6709\u610f\u4e49\u5417\uff1f\" (\u8003\u5bdf\u5bf9\u7cfb\u7edf\u6574\u4f53\u7684\u7406\u89e3)\u3002</p> </li> </ul>"},{"location":"summary/2025/November/2025-11-01/","title":"2025 11 01","text":"<p> \u7ea6 54 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4\u4e0d\u5230 1 \u5206\u949f</p> 2025-12-022025-12-10 <ul> <li>\u4eca\u5929\u7761\u4e86\u5927\u534a\u5929\u5f88\u723d</li> <li>\u665a\u4e0a\u5f00\u59cb\u7ed9\u5b9e\u9a8c\u5ba4\u505a\u8c03\u7814\uff0c\u641e\u4e00\u4e0b\u7ea2\u5916\u6444\u50cf\u5934\u7684\u8c03\u7814</li> <li>\u7eaf\u7eafzz\u5de5\u4f5c\uff0c\u6444\u50cf\u5934\u5382\u5546\u90fd\u505a\u5b8c\u4e86\uff0c\u6211\u4eec\u8fd8\u505a\u4e2a\u7403\u554a</li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/","title":"\ud83d\ude80CUDA & LLM Inference Optimization Roadmap","text":"<p> \u7ea6 860 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 4 \u5206\u949f</p> 2025-12-132025-12-13 <p>From 11-23 to 12-23</p>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#1-roofline","title":"\ud83d\udcc5 \u7b2c 1 \u5468\uff1a\u5efa\u7acb\u201cRoofline\u201d\u601d\u7ef4\u4e0e\u5185\u5b58\u8fd9\u4e00\u751f\u4e4b\u654c","text":"<p>\u6838\u5fc3\u76ee\u6807\uff1a \u5b66\u4f1a Roofline Model\uff0c\u5b66\u4f1a\u7528 NCU \u770b\u5e26\u5bbd\u5229\u7528\u7387\u3002</p>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#theory","title":"\ud83d\udcda \u7406\u8bba\u5b66\u4e60 (Theory)","text":"<ul> <li> <p> \u9605\u8bfb PMPP/\u5b98\u65b9\u6587\u6863\uff1a \u6df1\u5165\u7406\u89e3 Memory Hierarchy (Global -&gt; L2 Cache -&gt; Shared Memory)\u3002</p> </li> <li> <p> \u7406\u89e3 KV Cache\uff1a \u641e\u6e05\u695a L2 Cache \u5728 LLM \u63a8\u7406\u4e2d\u5bf9 KV Cache \u7684\u4f5c\u7528\u3002</p> </li> <li> <p> \u6b7b\u78d5 Coalesced Access\uff1a \u5f7b\u5e95\u7406\u89e3\u5408\u5e76\u8bbf\u95ee\u673a\u5236\u3002</p> </li> <li> <p> \u638c\u63e1 Roofline Model\uff1a \u5b66\u4f1a\u8ba1\u7b97\u516c\u5f0f <code>\u7406\u8bba\u5e26\u5bbd * \u5b9e\u6d4b\u7b97\u529b / \u7406\u8bba\u7b97\u529b</code>\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#coding-profiling","title":"\ud83d\udcbb \u5b9e\u6218\u7f16\u7801 (Coding &amp; Profiling)","text":""},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#1-vector-add","title":"1. Vector Add (\u5e26\u5bbd\u6d4b\u8bd5\u7248)","text":"<ul> <li> <p> \u7f16\u5199\u57fa\u7840 Kernel\u3002</p> </li> <li> <p> NCU \u5206\u6790\uff1a \u8fd0\u884c Nsight Compute\uff0c\u67e5\u770b \"Memory Throughput\"\u3002</p> </li> <li> <p> KPI \u68c0\u67e5\uff1a \u786e\u8ba4 Kernel \u662f\u5426\u8fbe\u5230 GPU \u7406\u8bba\u5e26\u5bbd\u7684 80% \u4ee5\u4e0a (\u4f8b\u5982 RTX 3090 &gt; 750GB/s)\u3002</p> </li> <li> <p> \u5982\u679c\u662f\uff0c\u901a\u8fc7\u3002</p> </li> <li> <p> \u5982\u679c\u5426\uff0c\u5206\u6790\u539f\u56e0\u5e76\u4f18\u5316\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#2-naive-sgemm","title":"2. Naive SGEMM (\u6700\u7b80\u7248)","text":"<ul> <li> <p> \u7f16\u5199\u4e00\u4e2a\u6ca1\u6709\u4efb\u4f55\u4f18\u5316\u7684\u77e9\u9635\u4e58\u6cd5 Kernel\u3002</p> </li> <li> <p> NCU \u6e90\u7801\u5206\u6790\uff1a \u6253\u5f00 NCU \u7684 Source View\u3002</p> </li> <li> <p> \u5b9a\u4f4d\u74f6\u9888\uff1a \u627e\u51fa\u5177\u4f53\u54ea\u4e00\u884c\u4ee3\u7801\u5bfc\u81f4\u4e86 Memory Stall (\u5185\u5b58\u505c\u987f)\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#interview-prep","title":"\ud83d\udde3\ufe0f \u9762\u8bd5\u51c6\u5907 (Interview Prep)","text":"<ul> <li> <p> \u7ed8\u56fe\u7ec3\u4e60\uff1a \u80fd\u624b\u7ed8 SM \u7b80\u56fe (\u5305\u542b Tensor Core, L1/Shared Mem)\u3002</p> </li> <li> <p> \u53e3\u8ff0\u7ec3\u4e60\uff1a \u89e3\u91ca\u201c\u4e3a\u4ec0\u4e48 Uncoalesced Memory Access \u4f1a\u5bfc\u81f4\u5e26\u5bbd\u6d6a\u8d39\uff1f\u201d (\u5fc5\u987b\u63d0\u5230 Transaction \u7684 32B/128B \u7c92\u5ea6)\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#2-tensor-core-wmma-async-copy","title":"\ud83d\udcc5 \u7b2c 2 \u5468\uff1a\u8de8\u8d8a\u5230 Tensor Core (WMMA &amp; Async Copy)","text":"<p>\u6838\u5fc3\u76ee\u6807\uff1a \u653e\u5f03\u7eaf CUDA Core \u6267\u5ff5\uff0c\u638c\u63e1\u73b0\u4ee3 GPU \u52a0\u901f\u6838\u5fc3 (\u5b9e\u4e60\u9762\u8bd5\u5206\u6c34\u5cad)\u3002</p>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#theory_1","title":"\ud83d\udcda \u7406\u8bba\u5b66\u4e60 (Theory)","text":"<ul> <li> <p> \u5b66\u4e60 WMMA API\uff1a \u9605\u8bfb <code>nvcuda::wmma</code> \u6587\u6863\uff0c\u7406\u89e3 Fragment (\u7247\u6bb5) \u6982\u5ff5\u3002</p> </li> <li> <p> \u5b66\u4e60 Async Copy\uff1a \u7406\u89e3 <code>cp.async</code> \u5982\u4f55\u7ed5\u8fc7\u5bc4\u5b58\u5668\u76f4\u63a5\u4ece Global \u642c\u8fd0\u5230 Shared Memory\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#coding-profiling_1","title":"\ud83d\udcbb \u5b9e\u6218\u7f16\u7801 (Coding &amp; Profiling)","text":""},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#sgemm","title":"SGEMM \u8fdb\u5316\u4e4b\u8def","text":"<ul> <li> <p> V1: Shared Memory Tiling (FP32)</p> </li> <li> <p> \u5b9e\u73b0\u5206\u5757\u7b97\u6cd5\uff0c\u89e3\u51b3 Bank Conflicts\u3002</p> </li> <li> <p> V2: Tensor Core GEMM (FP16) [\u6838\u5fc3]</p> </li> <li> <p> \u5c06\u6570\u636e\u7c7b\u578b\u8f6c\u6362\u4e3a <code>half</code> (FP16)\u3002</p> </li> <li> <p> \u4f7f\u7528 <code>wmma::load</code>, <code>wmma::mma</code>, <code>wmma::store</code> \u91cd\u5199 Kernel\u3002</p> </li> <li> <p> KPI \u68c0\u67e5\uff1a \u6027\u80fd\u5fc5\u987b\u5927\u5e45\u78be\u538b V1 \u7248\u672c\u3002</p> </li> <li> <p> V3: Double Buffering + Async Copy [\u9ad8\u9636\u9009\u505a]</p> </li> <li> <p> \u5728 V2 \u57fa\u7840\u4e0a\u5f15\u5165 <code>cp.async</code>\u3002</p> </li> <li> <p> \u5b9e\u73b0\u8ba1\u7b97\u4e0e\u6570\u636e\u642c\u8fd0\u7684\u6d41\u6c34\u7ebf\u91cd\u53e0 (Overlapping)\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#interview-prep_1","title":"\ud83d\udde3\ufe0f \u9762\u8bd5\u51c6\u5907 (Interview Prep)","text":"<ul> <li> \u53e3\u8ff0\u7ec3\u4e60\uff1a \u56de\u7b54\u201cTensor Core \u8ba1\u7b97\u65f6\uff0cSM \u5176\u4ed6\u5355\u5143\u5728\u5e72\u4ec0\u4e48\uff1f\u201d (\u5173\u952e\u8bcd\uff1aINT32 \u5355\u5143\u5e76\u884c\u8ba1\u7b97\u5730\u5740/\u6307\u9488)\u3002</li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#3-memory-bound-warp","title":"\ud83d\udcc5 \u7b2c 3 \u5468\uff1aMemory-Bound \u7b97\u5b50\u4e0e Warp \u9b54\u6cd5","text":"<p>\u6838\u5fc3\u76ee\u6807\uff1a \u9488\u5bf9 LLM \u6838\u5fc3\u7ec4\u4ef6 (Softmax/RMSNorm) \u8fdb\u884c\u4e13\u9879\u8bad\u7ec3\u3002</p>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#theory_2","title":"\ud83d\udcda \u7406\u8bba\u5b66\u4e60 (Theory)","text":"<ul> <li> <p> \u638c\u63e1 Warp Primitives\uff1a \u5f7b\u5e95\u641e\u61c2 <code>__shfl_down_sync</code> (\u5f52\u7ea6) \u548c <code>__shfl_xor_sync</code> (\u8774\u8776\u4ea4\u6362)\u3002</p> </li> <li> <p> \u5b66\u4e60 Online Softmax\uff1a \u7406\u89e3 FlashAttention \u7684\u6570\u5b66\u57fa\u7840 (\u5982\u4f55\u5728\u672a\u77e5\u5168\u5c40 Max \u7684\u60c5\u51b5\u4e0b\u8ba1\u7b97)\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#coding-profiling_2","title":"\ud83d\udcbb \u5b9e\u6218\u7f16\u7801 (Coding &amp; Profiling)","text":""},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#1-warp-reduction","title":"1. Warp Reduction","text":"<ul> <li> <p> \u7f16\u5199 Kernel\uff1a\u4e00\u4e2a Warp \u5185 32 \u4e2a\u7ebf\u7a0b\u6c42\u548c\u3002</p> </li> <li> <p> \u9650\u5236\u6761\u4ef6\uff1a \u4e0d\u4f7f\u7528 Shared Memory\uff0c\u4ec5\u4f7f\u7528 Shuffle \u6307\u4ee4\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#2-rmsnorm-llama","title":"2. RMSNorm (Llama \u540c\u6b3e)","text":"<ul> <li> <p> \u5b9e\u73b0\u516c\u5f0f\uff1a\\(x / \\\\sqrt{\\\\text{mean}(x^2) + \\\\epsilon} * \\\\gamma\\)\u3002</p> </li> <li> <p> \u4f18\u5316\u6280\u5de7\uff1a \u4f7f\u7528 <code>float4</code> \u5411\u91cf\u5316\u52a0\u8f7d\u6570\u636e\u3002</p> </li> <li> <p> \u6d41\u7a0b\u5b9e\u73b0\uff1a \u5e73\u65b9\u548c -&gt; Warp Reduce -&gt; \u5e7f\u64ad\u7ed3\u679c -&gt; \u8ba1\u7b97\u8f93\u51fa\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#3-online-softmax","title":"3. Online Softmax","text":"<ul> <li> <p> \u5b9e\u73b0\u5355 Pass \u8ba1\u7b97 Softmax\u3002</p> </li> <li> <p> \u6570\u503c\u7a33\u5b9a\u6027\uff1a \u786e\u4fdd\u5904\u7406\u4e86\u51cf\u53bb Max \u503c\u7684\u903b\u8f91\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#4-llm","title":"\ud83d\udcc5 \u7b2c 4 \u5468\uff1aLLM \u7efc\u5408\u5b9e\u6218\u4e0e\u7b80\u5386\u5305\u88c5","text":"<p>\u6838\u5fc3\u76ee\u6807\uff1a \u7406\u8bba\u7ed3\u5408\u5b9e\u8df5\uff0c\u6784\u5efa\u201c\u5fae\u578b\u63a8\u7406\u5f15\u64ce\u201d\u6982\u5ff5\u3002</p>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#theory-deep-dive","title":"\ud83d\udcda \u7406\u8bba\u6df1\u5ea6 (Theory Deep Dive)","text":"<ul> <li> <p> FlashAttention V1\uff1a \u9605\u8bfb\u8bba\u6587\u6216\u6280\u672f\u535a\u5ba2\u3002</p> </li> <li> <p> \u91cd\u70b9\uff1a \u624b\u5199/\u9ed8\u5199\u4f2a\u4ee3\u7801\uff0c\u7406\u6e05 Tiling \u5faa\u73af\u987a\u5e8f (Outer Loop: K, V; Inner Loop: Q)\u3002</p> </li> <li> <p> Quantization (\u91cf\u5316)\uff1a</p> </li> <li> <p> \u7406\u89e3 W8A16 (\u6743\u91cd INT8\uff0c\u6fc0\u6d3b FP16) \u6a21\u5f0f\u3002</p> </li> <li> <p> \u7406\u89e3 De-quantization (\u53cd\u91cf\u5316) \u5728 Kernel \u4e2d\u7684\u8ba1\u7b97\u6d41\u3002</p> </li> </ul>"},{"location":"summary/2025/November/%F0%9F%9A%80CUDA%20%26%20LLM%20Inference%20Optimization%20Roadmap/#review","title":"\ud83d\udcdd \u603b\u7ed3\u4e0e\u590d\u76d8 (Review)","text":"<ul> <li> <p> \u6574\u7406\u6240\u6709\u4ee3\u7801\u5230 GitHub \u4ed3\u5e93\u3002</p> </li> <li> <p> \u7f16\u5199 README\uff0c\u8d34\u4e0a NCU \u5206\u6790\u622a\u56fe\u548c Roofline \u6027\u80fd\u5bf9\u6bd4\u56fe\u3002</p> </li> <li> <p> \u6a21\u62df\u9762\u8bd5\uff1a\u4e32\u8054 4 \u5468\u7684\u77e5\u8bc6\u70b9\uff0c\u51c6\u5907\u8bb2\u8ff0\u4e00\u4e2a\u201c\u4ece Naive \u5230 Tensor Core \u4f18\u5316\u201d\u7684\u6545\u4e8b\u3002</p> </li> </ul>"},{"location":"summary/2025/Octorber/2025-10-31/","title":"2025 10 31","text":"<p> \u7ea6 178 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-022025-12-10 <ul> <li>\u8fdb\u884c\u4e86 vllm \u548c sglang scheduler \u7684\u5206\u6790</li> <li>vllm \u4e0d\u518d\u533a\u5206Req \u7684 prefill \u548c decode \u9636\u6bb5\uff0c\u53ea\u662f\u4fdd\u5b58\u9700\u8981\u751f\u6210\u7684 token \u6570\uff1bbatcdh \u4e2d\u6df7\u5408 prefill \u548c decode\uff0c\u901a\u8fc7\u540e\u7aef\u6765\u8fdb\u884c\u533a\u5206\u5904\u7406</li> <li>sglang \u4ecd\u7136\u533a\u5206 prefill \u548c decode \u9636\u6bb5\uff0cprefill \u8bf7\u6c42\u4f18\u5148\u8c03\u5ea6\uff0c\u4e00\u4e2a batch \u4e2d\u53ea\u6709 prefill \u6216\u8005 decode</li> <li>\u67e5\u770b\u4e86\u4e0b sglang \u7684 pr\uff0c\u53d1\u73b0 speculative coding \u73b0\u5728\u5f88\u70ed\u95e8\uff0c\u63a5\u4e0b\u6765\u6211\u7684\u4e3b\u8981\u65b9\u5411\u662f\u5411\u8fd9\u4e2a\u9886\u57df\u5c3d\u53ef\u80fd\u9488\u5bf9 Issue \u5408\u5165 PR</li> <li>\u665a\u4e0a\u56de\u6765\u548c\u5e08\u5144\u548c\u540c\u95e8\u804a\u5230 llm inference \u7684\u76f8\u5173\u57fa\u7840\u77e5\u8bc6\uff0cCUDA \u548c GPU \u786c\u4ef6\u7684\u5bf9\u5e94\u8fd8\u662f\u4e0d\u6e05\u6670\uff0c\u9700\u8981\u7ee7\u7eed\u5b66\u4e60</li> <li>nvidia \u5e02\u503c\u7a81\u7834 5 \u4e07\u4ebf\uff0c\u5de5\u4f5c\u540e\u4e00\u5b9a\u4e70\u5b83\u7684\u80a1\u7968</li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20Graph%20%E7%AF%87/","title":"CUDA Graph \u7bc7","text":"<p> \u7ea6 1154 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u4ee5\u4e0b\u662f\u5177\u4f53\u7684\u638c\u63e1\u6807\u51c6\u62c6\u89e3\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20Graph%20%E7%AF%87/#level-1-api","title":"Level 1: API \u4e0e\u751f\u547d\u5468\u671f (\u5fc5\u987b\u719f\u7ec3\u4f7f\u7528)","text":"<p>\u8fd9\u662f\u57fa\u7840\uff0c\u4f60\u7684 MiniInfer \u548c SGLang \u4efb\u52a1\u90fd\u5fc5\u987b\u7528\u5230\u3002</p> <ol> <li>\u6838\u5fc3\u6d41\u7a0b (The Workflow)\uff1a</li> </ol> <ul> <li> <p>Capture (\u6355\u83b7): <code>cudaStreamBeginCapture</code> / <code>cudaStreamEndCapture</code>\u3002\u77e5\u9053\u8fd9\u4e00\u6b65\u662f\u5728\u201c\u5f55\u50cf\u201d\uff0cGPU \u4e0d\u4f1a\u7acb\u523b\u6267\u884c\u3002</p> </li> <li> <p>Instantiate (\u5b9e\u4f8b\u5316): <code>cudaGraphInstantiate</code>\u3002\u8fd9\u662f\u6700\u8017\u65f6\u7684\u4e00\u6b65\uff08Validation + Optimization\uff09\uff0c\u5b83\u628a Graph \u53d8\u6210\u4e86\u53ef\u6267\u884c\u7684 <code>GraphExec</code> \u5bf9\u8c61\u3002\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u4f60\u9700\u8981 Warm-up \u7684\u6838\u5fc3\u539f\u56e0\u2014\u2014\u4e3a\u4e86\u63d0\u524d\u628a\u8fd9\u4e00\u6b65\u505a\u5b8c\u3002</p> </li> <li> <p>Launch (\u53d1\u5c04): <code>cudaGraphLaunch</code>\u3002\u6781\u5feb\uff0c\u51e0\u4e4e\u6ca1\u6709 CPU \u5f00\u9500\u3002</p> </li> </ul> <ol> <li>Stream \u7684\u5173\u7cfb\uff1a</li> </ol> <ul> <li> <p>\u77e5\u9053 Capture \u662f\u9488\u5bf9\u7279\u5b9a Stream \u7684\u3002\u5728 Capture \u671f\u95f4\uff0c\u5411\u8be5 Stream \u63d0\u4ea4\u7684\u6240\u6709 Kernel \u90fd\u4f1a\u88ab\u5f55\u5165 Graph\u3002</p> </li> <li> <p>\u77e5\u9053\u5411 \u5176\u4ed6 Stream \u63d0\u4ea4\u4efb\u52a1\u4f1a\u53d1\u751f\u4ec0\u4e48\uff08\u901a\u5e38\u4f1a\u5bfc\u81f4 Capture \u5931\u8d25\u6216\u53d8\u6210\u4f9d\u8d56\u5173\u7cfb\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20Graph%20%E7%AF%87/#level-2","title":"Level 2: \u9650\u5236\u4e0e\u9677\u9631 (\u9762\u8bd5\u6838\u5fc3\u8003\u70b9)","text":"<p>\u8fd9\u662f\u5b57\u8282\u9762\u8bd5\u5b98\u6700\u559c\u6b22\u95ee\u7684\uff0c\u56e0\u4e3a\u8fd9\u4f53\u73b0\u4e86\u4f60\u662f\u5426\u6709\u5b9e\u9645\u5de5\u7a0b\u7ecf\u9a8c\u3002</p> <ol> <li>\u9759\u6001\u56fe vs. \u52a8\u6001\u903b\u8f91 (The Static Nature)\uff1a</li> </ol> <ul> <li> <p>CPU \u903b\u8f91\u5931\u6548\uff1a \u5728 Capture \u671f\u95f4\uff0c\u4efb\u4f55 CPU \u7aef\u7684 <code>if-else</code> \u6216 <code>for</code> \u5faa\u73af\u53ea\u6709\u5728\u201c\u5f55\u5236\u201d\u90a3\u4e00\u523b\u751f\u6548\u3002Graph \u5f55\u5236\u4e0b\u6765\u7684\u662f\u4e00\u6761\u56fa\u5b9a\u7684\u6267\u884c\u8def\u5f84\u3002</p> </li> <li> <p>\u9762\u8bd5\u9898\uff1a \u201c\u5982\u679c\u5728 Capture \u671f\u95f4\u6709\u4e00\u4e2a <code>if (random() &gt; 0.5)</code>\uff0cGraph \u8fd0\u884c\u7684\u65f6\u5019\u4f1a\u4fdd\u7559\u8fd9\u4e2a\u968f\u673a\u6027\u5417\uff1f\u201d</p> </li> <li> <p>\u7b54\u6848\uff1a \u4e0d\u4f1a\u3002\u5b83\u4f1a\u6c38\u8fdc\u6267\u884c\u5f55\u5236\u65f6\u8d70\u7684\u90a3\u6761\u8def\u3002</p> </li> </ul> <ol> <li>\u6307\u9488\u5730\u5740\u56fa\u5b9a (Pointer Baking)\uff1a</li> </ol> <ul> <li> <p>\u8fd9\u662f\u6700\u5927\u7684\u5751\uff1a Graph \u5f55\u5236\u65f6\uff0cKernel \u53c2\u6570\u91cc\u7684**\u663e\u5b58\u6307\u9488\u5730\u5740\uff08Pointer Address\uff09**\u662f\u88ab\u201c\u5199\u6b7b\u201d\u5728 Graph \u91cc\u7684\u3002</p> </li> <li> <p>\u540e\u679c\uff1a \u5982\u679c\u4f60\u4e0b\u4e00\u8f6e\u63a8\u7406\uff0cKV Cache \u6362\u4e86\u4e2a\u5730\u65b9\u5b58\uff08SGLang \u7684 Memory Pool \u91cd\u65b0\u5206\u914d\u4e86\u5730\u5740\uff09\uff0c\u4f46\u4f60\u8fd8\u5728\u7528\u65e7 Graph\uff0c\u7a0b\u5e8f\u4f1a\u5d29\u6e83\u6216\u7b97\u9519\u3002</p> </li> <li> <p>SGLang \u7684\u89e3\u6cd5\uff1a SGLang \u4f7f\u7528 Mempool (\u5185\u5b58\u6c60) \u6216 Private Buffer\u3002Warm-up \u65f6\u786e\u5b9a\u7684\u5730\u5740\uff0c\u5728\u540e\u7eed\u63a8\u7406\u65f6\u5fc5\u987b\u4fdd\u8bc1\u4e0d\u53d8\uff08\u6216\u8005\u4fdd\u8bc1\u590d\u7528\u540c\u4e00\u5757 Buffer\uff09\u3002\u4f60\u5728\u4fee Issue \u65f6\u5fc5\u987b\u786e\u8ba4\u8fd9\u4e00\u70b9\uff1aWarm-up \u7528\u7684 Buffer \u548c\u5b9e\u9645\u63a8\u7406\u7528\u7684 Buffer \u5fc5\u987b\u5728\u7269\u7406\u5730\u5740\u4e0a\u517c\u5bb9\u3002</p> </li> </ul> <ol> <li>\u52a8\u6001 Shape \u95ee\u9898\uff1a</li> </ol> <ul> <li> <p>Graph \u5bf9 Input Tensor \u7684 Shape \u4e5f\u662f\u654f\u611f\u7684\uff08\u901a\u5e38\uff09\u3002</p> </li> <li> <p>\u89e3\u6cd5\uff1a \u9488\u5bf9\u5e38\u89c1\u7684 Batch Size (1, 2, 4, 8...) \u5206\u522b\u5f55\u5236\u4e0d\u540c\u7684 Graph \u5e76\u7f13\u5b58\u8d77\u6765\uff08Graph Caching\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20Graph%20%E7%AF%87/#level-3-data-amlseed","title":"Level 3: \u9ad8\u7ea7\u4f18\u5316\u4e0e\u8c03\u8bd5 (Data-AML/Seed \u8fdb\u9636\u8981\u6c42)","text":"<ol> <li>Graph Update (\u56fe\u66f4\u65b0)\uff1a</li> </ol> <ul> <li> <p>\u5982\u679c\u53ea\u662f input tensor \u7684\u5185\u5bb9\u53d8\u4e86\uff08\u5730\u5740\u6ca1\u53d8\uff09\uff0c\u4e0d\u9700\u8981\u66f4\u65b0 Graph\u3002</p> </li> <li> <p>\u5982\u679c input tensor \u7684\u5730\u5740\u53d8\u4e86\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>cudaGraphExecUpdate</code> \u6765\u66f4\u65b0\u53c2\u6570\uff0c\u800c\u4e0d\u9700\u8981\u91cd\u65b0 Capture \u548c Instantiate\uff08\u524d\u8005\u592a\u6162\uff09\u3002</p> </li> <li> <p>\u5b9e\u6218\uff1a \u4e86\u89e3 SGLang \u662f\u5426\u4f7f\u7528\u4e86 <code>ExecUpdate</code>\uff0c\u8fd8\u662f\u7b80\u5355\u7c97\u66b4\u5730\u7ef4\u62a4\u4e86\u591a\u4e2a Graph \u5b9e\u4f8b\uff1f\uff08\u901a\u5e38\u4e3a\u4e86\u7a33\u5b9a\u6027\uff0c\u7ef4\u62a4\u591a\u5b9e\u4f8b\u66f4\u5e38\u89c1\uff09\u3002</p> </li> </ul> <ol> <li>Mempool \u7ba1\u7406\uff1a</li> </ol> <ul> <li> <p>CUDA Graph \u80fd\u591f\u6355\u83b7 <code>cudaMalloc</code> \u5417\uff1f</p> </li> <li> <p>\u7b54\u6848\uff1a \u73b0\u4ee3 CUDA (11.x+) \u652f\u6301 <code>cudaGraphAddMemAllocNode</code>\uff0c\u652f\u6301\u5728 Graph \u5185\u90e8\u505a\u5185\u5b58\u5206\u914d\u3002\u4f46\u8fd9\u901a\u5e38\u5f88\u96be\u7528\u3002</p> </li> <li> <p>\u5de5\u4e1a\u754c\u505a\u6cd5\uff1a Static Allocation\u3002\u5728 Capture \u4e4b\u524d\u5c31\u628a\u6700\u5927\u663e\u5b58\u7533\u8bf7\u597d\uff0cGraph \u5185\u90e8\u53ea\u505a\u8ba1\u7b97\uff0c\u4e0d\u78b0\u5185\u5b58\u5206\u914d\u3002SGLang \u5c31\u662f\u8fd9\u4e48\u505a\u7684\uff0c\u5b83\u9884\u5148\u5206\u914d\u4e86\u5de8\u5927\u7684 KV Cache \u6c60\u3002</p> </li> </ul> <ol> <li>\u8c03\u8bd5 (Debugging)\uff1a</li> </ol> <ul> <li> <p>\u5f53\u4f7f\u7528\u4e86 CUDA Graph \u540e\uff0c<code>nsys</code> (Nsight Systems) \u770b\u5230\u7684\u4e0d\u518d\u662f\u4e00\u4e2a\u4e2a\u788e\u7684 Kernel\uff0c\u800c\u662f\u4e00\u4e2a\u5de8\u5927\u7684\u5757\uff08Graph Launch\uff09\u3002</p> </li> <li> <p>\u6280\u5de7\uff1a \u77e5\u9053\u5982\u4f55\u5728 <code>nsys</code> \u4e2d\u5c55\u5f00 Graph \u5185\u90e8\u7684 Kernel \u8be6\u60c5\uff08\u901a\u5e38\u5de5\u5177\u4f1a\u81ea\u52a8\u652f\u6301\uff0c\u4f46\u6709\u65f6\u9700\u8981\u7279\u5b9a\u7248\u672c\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20Graph%20%E7%AF%87/#sglang-diffusion-warm-up","title":"\u9488\u5bf9\u4f60\u7684 SGLang Diffusion Warm-up \u4efb\u52a1","text":"<p>\u4f60\u73b0\u5728\u624b\u5934\u7684\u8fd9\u4e2a Issue\uff0c\u5b8c\u7f8e\u5bf9\u5e94\u4e86\u4e0a\u8ff0\u77e5\u8bc6\u70b9\u3002\u4f60\u9700\u8981\u641e\u6e05\u695a\uff1a</p> <ol> <li>Warm-up \u5230\u5e95\u5728 Warm-up \u4ec0\u4e48\uff1f</li> </ol> <ul> <li>\u5b83\u5728\u8dd1\u4e00\u904d\u6a21\u578b\uff0c\u89e6\u53d1 PyTorch \u7684 Lazy Initialization\uff0c\u5206\u914d\u663e\u5b58\uff0c\u5e76\u4e14\uff08\u5173\u952e\u70b9\uff09\u5f55\u5236 CUDA Graph\u3002</li> </ul> <ol> <li>Diffusion \u7684\u7279\u6b8a\u6027\uff1a</li> </ol> <ul> <li> <p>Diffusion \u662f\u4e00\u4e2a UNet \u5faa\u73af\u8fd0\u884c\u51e0\u5341\u6b21\u3002</p> </li> <li> <p>\u5982\u679c\u6ca1\u6709 Graph\uff0c\u6bcf\u4e00\u6b21\u5faa\u73af\u90fd\u8981 CPU \u53d1\u5c04\u51e0\u767e\u4e2a Kernel\uff0c\u5f00\u9500\u5de8\u5927\u3002</p> </li> <li> <p>\u4f60\u7684\u76ee\u6807\uff1a \u628a\u8fd9\u51e0\u5341\u6b21\u5faa\u73af\uff08\u6216\u8005\u5355\u6b21\u53bb\u566a\u6b65\uff09\u5f55\u5236\u6210 Graph\u3002</p> </li> </ul> <ol> <li>\u4f60\u9700\u8981\u89e3\u51b3\u7684\u51b2\u7a81\uff1a</li> </ol> <ul> <li> <p>Warm-up \u65f6\u7528\u7684 Input Tensor \u662f\u5047\u7684\uff08Dummy Input\uff09\u3002</p> </li> <li> <p>\u5b9e\u9645\u63a8\u7406\u65f6\u7528\u7684\u662f\u771f\u7684\u3002</p> </li> <li> <p>\u95ee\u9898\uff1a \u600e\u4e48\u4fdd\u8bc1 Graph \u5f55\u5236\u7684 Dummy Input \u5730\u5740\u548c\u5b9e\u9645 Input \u5730\u5740\u7684\u517c\u5bb9\u6027\uff1f\uff08\u901a\u8fc7 <code>torch.cuda.make_graphed_callables</code> \u6216\u8005 SGLang \u81ea\u5df1\u7684 Graph Runner \u5c01\u88c5\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20Graph%20%E7%AF%87/#_1","title":"\u603b\u7ed3\uff1a\u4f60\u9700\u8981\u638c\u63e1\u5230\u4ec0\u4e48\u7a0b\u5ea6\uff1f","text":"<ol> <li> <p>API\uff1a \u719f\u7ec3\u3002</p> </li> <li> <p>\u539f\u7406\uff1a \u6df1\u523b\u7406\u89e3 \u201c\u6307\u9488\u56fa\u5316\u201d \u548c \u201cCPU \u903b\u8f91\u6d88\u5931\u201d \u8fd9\u4e24\u4e2a\u7279\u6027\u3002</p> </li> <li> <p>\u5de5\u7a0b\uff1a \u77e5\u9053\u5982\u4f55\u7ed3\u5408 Mempool \u6765\u89c4\u907f\u5730\u5740\u53d8\u5316\u7684\u95ee\u9898\u3002</p> </li> </ol> <p>\u9762\u8bd5\u5fc5\u95ee\u6a21\u62df\u9898\uff1a \u201c\u6211\u4eec\u5728 SGLang \u4e2d\u4f7f\u7528\u4e86 CUDA Graph\uff0c\u4f46\u662f\u53d1\u73b0\u663e\u5b58\u6c60\uff08Mempool\uff09\u788e\u7247\u5316\u6574\u7406\u540e\uff0c\u63a8\u7406\u7ed3\u679c\u5168\u9519\u4e86\uff0c\u53ef\u80fd\u662f\u4ec0\u4e48\u539f\u56e0\uff1f\u201d (\u7b54\u6848\uff1a\u788e\u7247\u6574\u7406\u79fb\u52a8\u4e86\u7269\u7406\u5185\u5b58\u5730\u5740\uff0c\u4f46 Graph \u5185\u90e8\u8fd8\u6301\u6709\u65e7\u7684\u6307\u9488\u5730\u5740\u3002\u5fc5\u987b Re-capture \u6216 Update Graph\u3002)</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/","title":"CUDA \u7bc7","text":"<p> \u7ea6 2325 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 12 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u4ee5\u4e0b\u6211\u4e3a\u4f60\u5212\u5206\u4e86\u4e09\u4e2a\u5c42\u7ea7\uff08Level 1-3\uff09\uff0c\u4ee5\u53ca\u9488\u5bf9 LLM Infra \u5c97\u4f4d\u7684\u5fc5\u77e5\u5fc5\u4f1a\u6280\u672f\u70b9\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#level-1","title":"Level 1: \u57fa\u7840\u624e\u5b9e\uff08\u5fc5\u987b\u70c2\u719f\u4e8e\u5fc3\uff09","text":"<p>\u8fd9\u662f\u95e8\u69db\u3002\u4f60\u9700\u8981\u80fd\u6d41\u5229\u5730\u89e3\u91ca\u8fd9\u4e9b\u6982\u5ff5\uff0c\u5e76\u5728 MiniInfer \u4e2d\u6709\u5bf9\u5e94\u7684\u4ee3\u7801\u4f53\u73b0\u3002</p> <ol> <li>\u7ebf\u7a0b\u6a21\u578b (Thread Hierarchy)\uff1a</li> </ol> <ul> <li> <p>\u6e05\u695a Grid, Block, Warp, Thread \u7684\u6620\u5c04\u5173\u7cfb\u3002</p> </li> <li> <p>Warp (32 threads): \u5fc5\u987b\u7406\u89e3 Warp \u662f GPU \u8c03\u5ea6\u7684\u6700\u5c0f\u5355\u4f4d\u3002\u7406\u89e3 Warp Divergence (\u5206\u652f\u53d1\u6563) \u7684\u4ee3\u4ef7\uff08\u5373 <code>if-else</code> \u5bfc\u81f4\u540c\u4e00 Warp \u5185\u7ebf\u7a0b\u7a7a\u8f6c\uff09\u3002</p> </li> <li> <p>Occupancy (\u5360\u7528\u7387)\uff1a \u7406\u89e3\u5bc4\u5b58\u5668\u4f7f\u7528\u91cf\uff08Register Pressure\uff09\u548c Shared Memory \u5927\u5c0f\u662f\u5982\u4f55\u9650\u5236\u6bcf\u4e2a SM \u4e0a\u80fd\u8dd1\u591a\u5c11\u4e2a Block \u7684\u3002</p> </li> </ul> <ol> <li>\u5185\u5b58\u5c42\u6b21 (Memory Hierarchy) \u2014\u2014 \u91cd\u4e2d\u4e4b\u91cd\uff1a</li> </ol> <ul> <li> <p>Global Memory: \u5fc5\u987b\u61c2 Coalesced Access (\u5408\u5e76\u8bbf\u95ee)\u3002\u4e3a\u4ec0\u4e48\u8bfb\u53d6 float16 \u65f6\uff0c\u6309\u7167 128-bit\uff08float4\uff09\u5bf9\u9f50\u8bfb\u53d6\u6bd4\u9010\u4e2a\u8bfb\u53d6\u5feb\u5f97\u591a\uff1f\uff08MiniInfer \u7684 RoPE \u7b97\u5b50\u4e00\u5b9a\u8981\u4f53\u73b0\u8fd9\u4e00\u70b9\uff09\u3002</p> </li> <li> <p>Shared Memory: \u5b83\u662f\u7528\u6237\u53ef\u63a7\u7684 L1 Cache\u3002\u4f60\u9700\u8981\u61c2\u5982\u4f55\u7528\u5b83\u6765\u505a Tiling\uff08\u5206\u5757\uff09\uff0c\u51cf\u5c11 Global Memory \u7684\u5e26\u5bbd\u538b\u529b\u3002</p> </li> <li> <p>Bank Conflict: \u77e5\u9053 Shared Memory \u88ab\u5212\u5206\u4e3a 32 \u4e2a Bank\u3002\u5f53\u540c\u4e00\u4e2a Warp \u5185\u7684\u591a\u4e2a\u7ebf\u7a0b\u8bbf\u95ee\u540c\u4e00\u4e2a Bank \u7684\u4e0d\u540c\u5730\u5740\u65f6\u4f1a\u53d1\u751f\u51b2\u7a81\uff0c\u5bfc\u81f4\u4e32\u884c\u5316\u3002</p> </li> </ul> <ol> <li>\u57fa\u672c\u540c\u6b65\u673a\u5236\uff1a</li> </ol> <ul> <li> <p><code>__syncthreads()</code> \u7684\u4f5c\u7528\u8303\u56f4\uff08Block \u5185\uff09\u3002</p> </li> <li> <p>\u77e5\u9053\u4e3a\u4ec0\u4e48 Grid \u95f4\u540c\u6b65\u5f88\u96be\uff08\u901a\u5e38\u9700\u8981\u7ed3\u675f Kernel \u6216\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#level-2-ob","title":"Level 2: \u8fdb\u9636\u4f18\u5316\uff08\u5b57\u8282/OB \u9762\u8bd5\u7684\u6838\u5fc3\u8003\u70b9\uff09","text":"<p>\u8fd9\u90e8\u5206\u51b3\u5b9a\u4e86\u4f60\u662f\u5426\u80fd\u8fc7\u4e8c\u9762/\u4e09\u9762\u3002\u4f60\u9700\u8981\u7ed3\u5408 MiniInfer \u6216 SGLang \u7684\u573a\u666f\u6765\u8c08\u3002</p> <ol> <li>Warp-Level Primitives (Warp \u539f\u8bed)\uff1a</li> </ol> <ul> <li> <p>Shuffle Instruction (<code>__shfl_sync</code>, <code>__shfl_down_sync</code>):</p> <ul> <li>\u9762\u8bd5\u5fc5\u6740\u6280\uff1a \u5728\u5199 Softmax \u6216 Reduce Sum \u7b97\u5b50\u65f6\uff0c\u4e0d\u8981\u53ea\u7528 Shared Memory \u505a\u5f52\u7ea6\u3002\u8981\u80fd\u8bf4\u51fa\uff1a\u201c\u4e3a\u4e86\u6781\u81f4\u6027\u80fd\uff0c\u6211\u5728 Warp \u5185\u90e8\u4f7f\u7528\u4e86 Shuffle \u6307\u4ee4\u8fdb\u884c\u5bc4\u5b58\u5668\u7ea7\u522b\u7684\u6570\u636e\u4ea4\u6362\uff0c\u4e0d\u9700\u8981\u7ecf\u8fc7 Shared Memory\uff0c\u901f\u5ea6\u66f4\u5feb\u3002\u201d</li> </ul> </li> <li> <p>\u8fd9\u662f\u9ad8\u6027\u80fd\u7b97\u5b50\uff08\u5982 FlashAttention\uff09\u7684\u57fa\u7840\u3002</p> </li> </ul> <ol> <li>\u5f02\u6b65\u5e76\u53d1\u4e0e\u63a9\u76d6\u5ef6\u8fdf (Latency Hiding)\uff1a</li> </ol> <ul> <li> <p>CUDA Streams: \u7406\u89e3 Default Stream \u548c Non-default Stream \u7684\u533a\u522b\u3002</p> </li> <li> <p>Overlap (\u91cd\u53e0): \u5982\u4f55\u8ba9\u6570\u636e\u62f7\u8d1d\uff08H2D/D2H\uff09\u548c Kernel \u8ba1\u7b97\u540c\u65f6\u8fdb\u884c\uff1f</p> </li> <li> <p>SGLang \u5173\u8054\uff1a \u4f60\u6b63\u5728\u4fee\u7684 Warm-up Issue\uff0c\u672c\u8d28\u4e0a\u5c31\u662f\u5728\u89e3\u51b3 Kernel Launch \u7684 CPU \u5f00\u9500\u5bfc\u81f4 GPU \u51fa\u73b0\u7a7a\u95f2\uff08Gap\uff09\u7684\u95ee\u9898\u3002CUDA Graphs \u662f\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u7ec8\u6781\u65b9\u6848\uff08\u4e00\u6b21 Launch\uff0cGPU \u81ea\u5df1\u8c03\u5ea6\u4f9d\u8d56\uff09\u3002</p> </li> </ul> <ol> <li>\u5411\u91cf\u5316\u5185\u5b58\u8bbf\u95ee (Vectorized Load/Store)\uff1a</li> </ol> <ul> <li> <p>\u5728\u5199 Kernel \u65f6\uff0c\u5c3d\u91cf\u4f7f\u7528 <code>float4</code> (\u6216\u8005 <code>int4</code> for quant) \u7c7b\u578b\u8fdb\u884c\u8bfb\u5199\u3002\u8fd9\u80fd\u628a\u6307\u4ee4\u541e\u5410\u91cf\u63d0\u5347 4 \u500d\uff08\u76f8\u6bd4 float1\uff09\u3002</p> </li> <li> <p>MiniInfer \u5b9e\u6218\uff1a \u68c0\u67e5\u4f60\u7684 RoPE \u6216 Elemwise \u7b97\u5b50\uff0c\u662f\u5426\u7528\u4e86 <code>reinterpret_cast&lt;float4*&gt;</code>\uff1f\u5982\u679c\u6ca1\u6709\uff0c\u52a0\u4e0a\u53bb\uff0c\u8fd9\u5c31\u662f\u4f18\u5316\u70b9\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#level-3-llmtransformer","title":"Level 3: \u9886\u57df\u4e13\u5bb6\uff08\u9488\u5bf9 LLM/Transformer \u573a\u666f\uff09","text":"<p>\u8fd9\u90e8\u5206\u662f\u9488\u5bf9 Seed/Data-AML \u7684\u52a0\u5206\u9879\uff0c\u8bc1\u660e\u4f60\u61c2 Transformer \u7684\u786c\u4ef6\u7279\u6027\u3002</p> <ol> <li>Tensor Core (\u6df7\u5408\u7cbe\u5ea6\u7f16\u7a0b)\uff1a</li> </ol> <ul> <li> <p>\u4e0d\u9700\u8981\u624b\u5199\u590d\u6742\u7684 GEMM\uff0c\u4f46\u8981\u61c2 WMMA (Warp Matrix Multiply Accumulate) API\u3002</p> </li> <li> <p>\u6982\u5ff5\uff1a \u77e5\u9053 <code>fragment</code>\uff0c\u77e5\u9053 <code>load_matrix_sync</code> -&gt; <code>mma_sync</code> -&gt; <code>store_matrix_sync</code> \u7684\u6d41\u7a0b\u3002</p> </li> <li> <p>Layout\uff1a \u7406\u89e3\u77e9\u9635\u5728\u5185\u5b58\u4e2d\u7684\u5e03\u5c40\uff08Row-major vs Col-major\uff09\u5bf9 Tensor Core \u6027\u80fd\u7684\u5de8\u5927\u5f71\u54cd\u3002</p> </li> </ul> <ol> <li>FlashAttention \u7684\u6838\u5fc3\u601d\u60f3 (Tiling + Recomputation)\uff1a</li> </ol> <ul> <li>\u4e0d\u9700\u8981\u9ed8\u5199\u4ee3\u7801\uff0c\u4f46\u8981\u80fd\u753b\u56fe\u89e3\u91ca\uff1a\u4e3a\u4ec0\u4e48\u4f20\u7edf Attention \u9700\u8981 \\(O(N^2)\\) \u7684 HBM \u8bfb\u5199\uff0c\u800c FlashAttention \u901a\u8fc7\u5206\u5757\uff08Tiling\uff09\u628a\u8ba1\u7b97\u9650\u5236\u5728 SRAM\uff08Shared Memory\uff09\u91cc\uff0c\u4ece\u800c\u5c06 HBM \u8bfb\u5199\u964d\u5230\u4e86 \\(O(N)\\)\u3002</li> </ul> <ol> <li>\u91cf\u5316\u76f8\u5173\u7684\u4f4d\u64cd\u4f5c\uff1a</li> </ol> <ul> <li> <p>\u5982\u4f55\u9ad8\u6548\u5904\u7406 int4 \u6570\u636e\uff1f</p> </li> <li> <p>\u4f60\u9700\u8981\u61c2\u4f4d\u79fb\u64cd\u4f5c\uff1a<code>(val &gt;&gt; 4) &amp; 0xF</code>\u3002\u4e86\u89e3\u5982\u4f55\u5229\u7528 <code>BFE</code> (Bit Field Extract) \u7b49\u6307\u4ee4\u52a0\u901f\u89e3\u5305\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#_1","title":"\u603b\u7ed3\uff1a\u4f60\u9700\u8981\u51c6\u5907\u7684\u201c\u5fc5\u80cc\u201d\u4ee3\u7801\u7247\u6bb5/\u6982\u5ff5","text":"<p>\u4e3a\u4e86\u901a\u8fc7\u5b57\u8282\u548c OB \u7684\u9762\u8bd5\uff0c\u8bf7\u786e\u4fdd\u4f60\u80fd\u591f\u624b\u5199\u6216\u8be6\u7ec6\u63cf\u8ff0\u4ee5\u4e0b 3 \u4e2a Kernel \u7684\u5b9e\u73b0\u903b\u8f91\uff1a</p> <ol> <li>\u9ad8\u6548\u7684 Softmax Kernel\uff1a</li> </ol> <ul> <li>\u4e0d\u8981\u5199 Naive \u7248\u672c\u3002</li> <li>\u601d\u8def\uff1a Load Global -&gt; Block Reduce (\u6c42 Max) -&gt; Block Reduce (\u6c42 Sum) -&gt; Update -&gt; Store\u3002</li> <li>\u5173\u952e\u70b9\uff1a \u663e\u5f0f\u4f7f\u7528 Warp Shuffle \u4f18\u5316 Reduce \u8fc7\u7a0b\u3002</li> </ul> <ol> <li>LayerNorm / RMSNorm Kernel\uff1a</li> </ol> <ul> <li>\u601d\u8def\uff1a \u5178\u578b\u7684\u4e24\u8d9f\u626b\u63cf\uff08Two-pass\uff09\u7b97\u6cd5\uff08\u6c42\u5747\u503c/\u65b9\u5dee -&gt; \u5f52\u4e00\u5316\uff09\u3002\u6216\u8005\u4e00\u8d9f\u626b\u63cf\uff08Welford \u7b97\u6cd5\uff0c\u867d\u7136\u9762\u8bd5\u4e0d\u4e00\u5b9a\u8003\u8fd9\u4e48\u6df1\uff09\u3002</li> <li>\u5173\u952e\u70b9\uff1a \u5411\u91cf\u5316\u8bfb\u53d6 (<code>float4</code>)\u3002</li> </ul> <ol> <li>\u77e9\u9635\u8f6c\u7f6e (Matrix Transpose)\uff1a</li> </ol> <ul> <li>\u8fd9\u662f\u8003\u5bdf Coalesced Access \u548c Shared Memory Bank Conflict \u7684\u7ecf\u5178\u9898\u76ee\u3002</li> <li>\u601d\u8def\uff1a Global (Coalesced) -&gt; Shared Memory (\u89e3\u51b3\u8f6c\u7f6e\u540e\u7684\u975e\u5408\u5e76\u5199\u5165) -&gt; Global (Coalesced)\u3002</li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#sglang-issue-cuda","title":"\u9488\u5bf9\u4f60\u5f53\u524d SGLang Issue \u7684 CUDA \u77e5\u8bc6","text":"<p>\u7531\u4e8e\u4f60\u5728\u505a SGLang \u7684 Warm-up\uff0c\u4f60\u5fc5\u987b\u638c\u63e1\uff1a</p> <ol> <li> <p>CUDA Graphs API: <code>cudaStreamBeginCapture</code>, <code>cudaStreamEndCapture</code>, <code>cudaGraphInstantiate</code>, <code>cudaGraphLaunch</code>.</p> </li> <li> <p>Mempool (\u5185\u5b58\u6c60): \u4e3a\u4ec0\u4e48 Graph Capture \u8981\u6c42\u663e\u5b58\u5730\u5740\u662f\u56fa\u5b9a\u7684\uff1f\uff08\u56e0\u4e3a Graph \u8bb0\u5f55\u4e86\u6307\u9488\u5730\u5740\uff0c\u5982\u679c\u4e0b\u4e00\u6b21\u8fd0\u884c\u5730\u5740\u53d8\u4e86\uff0cGraph \u5c31\u5931\u6548\u4e86\uff09\u3002</p> </li> </ol>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#_2","title":"\u7b97\u5b50","text":"<p>\u9762\u8bd5\u8003\u5bdf\u7684\u662f\u539f\u7406\u638c\u63e1\u7a0b\u5ea6\u548c\u624b\u5199\u4ee3\u7801\u7684\u80fd\u529b\uff0c\u800c\u4e0d\u662f\u8ba9\u4f60\u73b0\u573a\u5199\u4e00\u4e2a\u5e93\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#1-softmax-rmsnorm-layernorm","title":"1. Softmax / RMSNorm / LayerNorm","text":"<ul> <li> <p>\u4f60\u638c\u63e1\u7684\u6280\u5de7\uff1a <code>float4</code> \u5411\u91cf\u5316\u8bfb\u5199 + Warp Shuffle Reduce + Shared Memory \u7f13\u5b58\u3002</p> </li> <li> <p>\u7ed3\u679c\uff1a \u8fd9\u4e00\u5957\u7ec4\u5408\u62f3\u6253\u4e0b\u53bb\uff0c\u4f60\u7684 Kernel \u6027\u80fd\u901a\u5e38\u80fd\u8fbe\u5230 PyTorch \u539f\u751f\u7b97\u5b50\u7684 80%-120%\uff08\u53d6\u51b3\u4e8e\u5177\u4f53 Shape\uff09\u3002</p> </li> <li> <p>\u9762\u8bd5\u8bc4\u4ef7\uff1a \u8fd9\u8bc1\u660e\u4f60\u61c2\u663e\u5b58\u5e26\u5bbd\u74f6\u9888\uff08Memory Bound\uff09\uff0c\u61c2\u5982\u4f55\u5229\u7528\u5bc4\u5b58\u5668\u901a\u4fe1\u907f\u514d Shared Memory \u5f00\u9500\u3002\u8fd9\u662f\u6ee1\u5206\u7b54\u6848\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#2-gemm","title":"2. GEMM (\u77e9\u9635\u4e58\u6cd5)","text":"<ul> <li> <p>\u4f60\u638c\u63e1\u7684\u6280\u5de7\uff1a Tiling (\u5206\u5757) + Shared Memory \u907f\u514d\u91cd\u590d\u8bfb\u53d6 + Tensor Core (WMMA)\u3002</p> </li> <li> <p>\u73b0\u72b6\uff1a \u5373\u4f7f\u4f60\u7528\u4e86\u8fd9\u4e9b\u6280\u5de7\uff0c\u624b\u5199 GEMM \u4e5f\u5f88\u96be\u8dd1\u8fc7 cuBLAS \u6216 CUTLASS\u3002\u56e0\u4e3a\u6781\u81f4\u7684 GEMM \u9700\u8981\u6c47\u7f16\u7ea7\u7684\u6d41\u6c34\u7ebf\u4f18\u5316\u3002</p> </li> <li> <p>\u9762\u8bd5\u7b56\u7565\uff1a \u4e0d\u8981\u8bd5\u56fe\u624b\u5199\u4e00\u4e2a\u901a\u7528\u7684 GEMM\u3002</p> </li> <li> <p>\u9762\u8bd5\u5b98\u66f4\u770b\u91cd\u4f60\u662f\u5426\u61c2 Tiling \u7684\u903b\u8f91 \u548c Tensor Core \u7684 API (WMMA)\u3002</p> </li> <li> <p>\u5982\u679c\u4f60\u80fd\u5199\u51fa\u4e00\u4e2a\u7b80\u5355\u7684 Block Tiling + WMMA \u7684 Demo\uff0c\u8bc1\u660e\u4f60\u61c2\u6df7\u5408\u7cbe\u5ea6\u8ba1\u7b97\u7684\u6d41\u7a0b\uff0c\u8fd9\u5c31\u8db3\u591f\u4e86\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#3-flashattention","title":"3. FlashAttention","text":"<ul> <li> <p>\u4f60\u638c\u63e1\u7684\u6280\u5de7\uff1a Tiling + Recomputation (\u91cd\u8ba1\u7b97) + Softmax \u7684\u6570\u5b66\u6280\u5de7\u3002</p> </li> <li> <p>\u7ed3\u679c\uff1a \u8fd9\u662f\u4e00\u4e2a\u6781\u5176\u590d\u6742\u7684\u7b97\u5b50\u3002\u5982\u679c\u4f60\u80fd\u7528 CUDA C++ \u628a FlashAttention V1 \u7684\u903b\u8f91\u8dd1\u901a\uff08\u54ea\u6015\u6027\u80fd\u53ea\u6709\u5b98\u65b9\u7684 50%\uff09\uff0c\u5728\u6821\u62db\u6216\u793e\u62db\u521d\u4e2d\u7ea7\u5c97\u4f4d\u4e2d\u5df2\u7ecf\u662fTop 5% \u7684\u6c34\u5e73\u3002</p> </li> <li> <p>\u5173\u952e\u70b9\uff1a FlashAttention \u7684\u96be\u70b9\u4e0d\u4ec5\u4ec5\u662f CUDA \u6280\u5de7\uff0c\u66f4\u662f\u7b97\u6cd5\u903b\u8f91\uff08Online Softmax \u7684\u6570\u503c\u7a33\u5b9a\u6027\u516c\u5f0f\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#miniinfer-level-4","title":"\u4e8c\u3001 \u5982\u679c\u8981\u5728 MiniInfer \u5b9e\u6218\u4e2d\u8dd1\u5f97\u66f4\u5feb\uff0c\u4f60\u8fd8\u7f3a\u4ec0\u4e48\uff1f (Level 4: \u9690\u85cf\u5173\u5361)","text":"<p>\u5982\u679c\u4f60\u60f3\u8ba9\u4f60\u7684 FlashAttention \u6216 GEMM \u771f\u6b63\u63a5\u8fd1 SGLang/vLLM \u7684\u6027\u80fd\uff0c\u4e0a\u8ff0 Level 1-3 \u7684\u6280\u5de7\u662f\u57fa\u7840\uff0c\u4f60\u8fd8\u9700\u8981\u5f15\u5165\u4ee5\u4e0b 3 \u4e2a\u9ad8\u7ea7\u673a\u5236\u3002\u8fd9\u5728\u9762\u8bd5\u4e2d\u5c5e\u4e8e\u201c\u52a0\u5206\u9879\u201d\uff0c\u4f46\u5728\u9ad8\u6027\u80fd\u5e93\u5f00\u53d1\u4e2d\u662f\u201c\u5fc5\u9009\u9879\u201d\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#1-async-copy-cpasync","title":"1. \u5f02\u6b65\u6570\u636e\u62f7\u8d1d (Async Copy / <code>cp.async</code>)","text":"<ul> <li> <p>\u95ee\u9898\uff1a \u4f60\u7684\u4ee3\u7801\u903b\u8f91\u53ef\u80fd\u662f\uff1a<code>Load Global -&gt; Wait -&gt; Compute -&gt; Store</code>\u3002GPU \u8ba1\u7b97\u5355\u5143\u5728\u7b49\u5f85\u6570\u636e\u52a0\u8f7d\u65f6\u662f\u7a7a\u95f2\u7684\u3002</p> </li> <li> <p>Level 4 \u6280\u5de7\uff1a Ampere (A100) \u67b6\u6784\u5f15\u5165\u4e86 <code>cp.async</code> \u6307\u4ee4\u3002\u5b83\u5141\u8bb8\u8ba1\u7b97\u5355\u5143\u53d1\u51fa\u201c\u642c\u8fd0\u6570\u636e\u201d\u7684\u6307\u4ee4\u540e\uff0c\u7acb\u523b\u53bb\u5e72\u522b\u7684\u4e8b\uff08\u6bd4\u5982\u8ba1\u7b97\u4e0a\u4e00\u6b65\u7684\u6570\u636e\uff09\uff0c\u4e0d\u9700\u8981\u7ebf\u7a0b\u963b\u585e\u7b49\u5f85\u3002</p> </li> <li> <p>\u5e94\u7528\u573a\u666f\uff1a FlashAttention \u7684 Q\u3001K\u3001V \u52a0\u8f7d\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#2-double-buffering-pipelining","title":"2. \u53cc\u7f13\u51b2 (Double Buffering / Pipelining)","text":"<ul> <li> <p>\u95ee\u9898\uff1a \u5373\u4f7f\u6709\u4e86\u5f02\u6b65\u62f7\u8d1d\uff0c\u5982\u679c\u53ea\u6709\u4e00\u4e2a\u7f13\u51b2\u533a\uff0c\u4f60\u8fd8\u5f97\u7b49\u3002</p> </li> <li> <p>Level 4 \u6280\u5de7\uff1a \u5728 Shared Memory \u4e2d\u5f00\u8f9f\u4e24\u5757\u7a7a\u95f4\uff08Buffer A \u548c Buffer B\uff09\u3002</p> </li> <li> <p>\u5f53 Tensor Core \u5728\u8ba1\u7b97 Buffer A \u65f6\u3002</p> </li> <li> <p>Load Unit \u5229\u7528 <code>cp.async</code> \u628a\u4e0b\u4e00\u6279\u6570\u636e\u9884\u53d6\u5230 Buffer B\u3002</p> </li> <li> <p>\u8fd9\u5c31\u662f\u6240\u8c13\u7684 \u63a9\u76d6\u5ef6\u8fdf (Latency Hiding) \u7684\u7ec8\u6781\u5f62\u6001\u3002</p> </li> <li> <p>\u9762\u8bd5\u8bdd\u672f\uff1a \u201c\u5728\u4f18\u5316 FlashAttention \u65f6\uff0c\u4e3a\u4e86\u63a9\u76d6 HBM \u7684\u8bbf\u95ee\u5ef6\u8fdf\uff0c\u6211\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u4e3b\u5faa\u73af\u6d41\u6c34\u7ebf\uff0c\u5229\u7528 Shared Memory \u505a Double Buffering\uff0c\u5e76\u914d\u5408 <code>cp.async</code> \u6307\u4ee4\u5b9e\u73b0\u8ba1\u7b97\u4e0e\u8bbf\u5b58\u7684\u5b8c\u7f8e\u91cd\u53e0\u3002\u201d</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#3-shared-memory-swizzling-bank-conflict","title":"3. Shared Memory Swizzling (\u89e3\u51b3 Bank Conflict \u7684\u7ec8\u6781\u65b9\u6848)","text":"<ul> <li> <p>\u95ee\u9898\uff1a \u5728\u77e9\u9635\u4e58\u6cd5\u6216 FlashAttention \u4e2d\uff0c\u5f53 Thread Block \u628a\u6570\u636e\u4ece Shared Memory \u52a0\u8f7d\u5230\u5bc4\u5b58\u5668\u5582\u7ed9 Tensor Core \u65f6\uff0c\u975e\u5e38\u5bb9\u6613\u53d1\u751f Bank Conflict\u3002</p> </li> <li> <p>Level 4 \u6280\u5de7\uff1a \u7b80\u5355\u7684 Padding\uff08\u586b\u5145\uff09\u53ef\u80fd\u4e0d\u591f\u3002\u4f60\u9700\u8981\u7528 XOR Swizzling\uff08\u5f02\u6216\u91cd\u6392\uff09\u8fd9\u79cd\u5730\u5740\u6620\u5c04\u6280\u5de7\uff0c\u8ba9\u8fde\u7eed\u7684\u5185\u5b58\u5730\u5740\u6620\u5c04\u5230\u4e0d\u540c\u7684 Bank \u4e0a\u3002</p> </li> <li> <p>CUTLASS/SGLang \u73b0\u72b6\uff1a \u5b83\u4eec\u5185\u90e8\u5927\u91cf\u4f7f\u7528\u4e86\u8fd9\u79cd\u6280\u5de7\u6765\u4fdd\u8bc1 Tensor Core \u5403\u6570\u636e\u7684\u901f\u5ea6\u4e0d\u88ab Shared Memory \u5361\u4f4f\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#miniinfer","title":"\u4e09\u3001 \u9488\u5bf9\u4f60 MiniInfer \u9879\u76ee\u7684\u5efa\u8bae\u8def\u5f84","text":"<p>\u65e2\u7136\u4f60\u8981\u505a MiniInfer\uff0c\u6211\u5efa\u8bae\u4f60\u91c7\u53d6\u4ee5\u4e0b\u5206\u6cbb\u7b56\u7565\uff0c\u65e2\u80fd\u5b66\u5230\u4e1c\u897f\uff0c\u53c8\u4e0d\u4f1a\u9677\u5165\u9020\u8f6e\u5b50\u7684\u6ce5\u6f6d\uff1a</p> <ol> <li>Elemwise &amp; Reduction (RoPE, Softmax, RMSNorm, Silu):</li> </ol> <ul> <li> <p>\u5168\u90e8\u624b\u5199\uff01</p> </li> <li> <p>\u4f7f\u7528 Level 1 &amp; 2 \u7684\u6280\u5de7\uff08<code>float4</code>, <code>shfl</code>, <code>grid stride loop</code>\uff09\u3002</p> </li> <li> <p>\u8fd9\u662f\u4f60\u7ec3\u4e60 CUDA \u57fa\u672c\u529f\u6700\u597d\u7684\u5730\u65b9\uff0c\u800c\u4e14\u8fd9\u90e8\u5206\u5f88\u5bb9\u6613\u505a\u5230\u6bd4 PyTorch \u5feb\u3002</p> </li> </ul> <ol> <li>Attention (FlashAttention):</li> </ol> <ul> <li> <p>\u6838\u5fc3\u6311\u6218\u9879\u76ee\u3002</p> </li> <li> <p>\u5148\u5c1d\u8bd5\u5199\u4e00\u4e2a Naive \u7248\u672c\uff08\u4e0d\u5e26 Double Buffering\uff09\uff0c\u8dd1\u901a Online Softmax \u7684\u903b\u8f91\u3002</p> </li> <li> <p>\u91cd\u70b9\u5c55\u793a\u4f60\u5bf9 SRAM \u7ba1\u7406 \u7684\u7406\u89e3\u3002</p> </li> </ul> <ol> <li>Linear / GEMM:</li> </ol> <ul> <li> <p>\u4e0d\u8981\u624b\u5199 Kernel\u3002</p> </li> <li> <p>\u76f4\u63a5\u8c03\u7528 cuBLAS \u6216\u8005\u96c6\u6210 CUTLASS\u3002</p> </li> <li> <p>\u539f\u56e0\uff1a \u9664\u975e\u4f60\u662f\u53bb NVIDIA \u5199\u5e93\uff0c\u5426\u5219\u624b\u5199 GEMM \u6295\u5165\u4ea7\u51fa\u6bd4\u592a\u4f4e\u3002\u4f60\u5e94\u8be5\u628a\u7cbe\u529b\u82b1\u5728\u201c\u5982\u4f55\u628a GEMM \u548c\u540e\u9762\u7684 Activation \u878d\u5408 (Fusion)\u201d\u4e0a\uff0c\u800c\u4e0d\u662f\u5199 GEMM \u672c\u8eab\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CUDA%20%E7%AF%87/#_3","title":"\u603b\u7ed3","text":"<p>\u4f60\u5217\u51fa\u7684\u6280\u5de7\u662f\u201c\u4e5d\u9633\u795e\u529f\u201d\u7684\u5185\u529f\u5fc3\u6cd5\uff0c\u5b8c\u5168\u8db3\u591f\u652f\u6491\u4f60\u901a\u8fc7\u9762\u8bd5\u3002</p> <p>\u53ea\u8981\u4f60\u5728\u5199\u4ee3\u7801\u65f6\uff0c\u8111\u5b50\u91cc\u6709\uff1a</p> <ol> <li> <p>Coalesced Access (Global Mem \u4e0d\u6d6a\u8d39\u5e26\u5bbd)</p> </li> <li> <p>Shared Memory (\u4f5c\u4e3a\u663e\u5f0f\u7f13\u5b58)</p> </li> <li> <p>Vectorized Access (<code>float4</code> \u63d0\u5347\u541e\u5410)</p> </li> <li> <p>Warp Primitive (\u5bc4\u5b58\u5668\u7ea7\u901a\u4fe1)</p> </li> </ol> <p>\u4f60\u5c31\u5df2\u7ecf\u8d85\u8d8a\u4e86\u7edd\u5927\u591a\u6570\u7ade\u4e89\u8005\u3002\u81f3\u4e8e Double Buffering \u548c Swizzling\uff0c\u90a3\u662f\u7b49\u4f60\u5148\u628a\u57fa\u7840\u7248\u8dd1\u901a\u540e\uff0c\u7528\u6765\u5237\u699c\uff08SOTA\uff09\u7528\u7684\u3002</p> <p>\u4e0b\u4e00\u6b65\u5efa\u8bae\uff1a \u4e0d\u7528\u518d\u72b9\u8c6b\u662f\u5426\u201c\u8db3\u591f\u201d\uff0c\u7acb\u523b\u5f00\u59cb\u5199\u4e00\u4e2a Vectorized RMSNorm\u3002\u5199\u5b8c\u4e86\u53d1\u7ed9\u6211\uff0c\u6211\u5e2e\u4f60 Code Review\uff0c\u770b\u770b\u6709\u6ca1\u6709\u8fbe\u5230 Level 2 \u7684\u6807\u51c6\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CheckList/","title":"CheckList","text":"<p> \u7ea6 1056 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u9664\u4e86\u6211\u4eec\u4e4b\u524d\u6df1\u5165\u63a2\u8ba8\u7684 CUDA\u3001SGLang \u67b6\u6784\u3001\u5e76\u884c\u5316\u7b56\u7565\u3001Triton/\u7f16\u8bd1\u5668\u4ee5\u53ca\u91cf\u5316\u6280\u672f\u4e4b\u5916\uff0c\u8981\u771f\u6b63\u4ece\u201c\u4f18\u79c0\u5b66\u751f\u201d\u8715\u53d8\u4e3a\u201c\u5373\u6218\u529b\u6781\u5f3a\u7684\u5b9e\u4e60\u751f\u201d\uff0c\u4f60\u8fd8\u9700\u8981\u8865\u9f50\u4ee5\u4e0b3\u5757\u201c\u9690\u85cf\u201d\u62fc\u56fe\u3002</p> <p>\u8fd9\u4e09\u70b9\u5f80\u5f80\u662f\u9762\u8bd5\u4e2d\u7684**\u201c\u533a\u5206\u5ea6\u201d\u6240\u5728**\uff0c\u7279\u522b\u662f\u9488\u5bf9\u5b57\u8282 Data-AML \u548c Seed \u8fd9\u79cd\u5bf9\u5de5\u7a0b\u7d20\u517b\u8981\u6c42\u6781\u9ad8\u7684\u56e2\u961f\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CheckList/#1-profiling-debugging","title":"1. \u6027\u80fd\u5206\u6790\u4e0e\u8c03\u8bd5 (Profiling &amp; Debugging) \u2014\u2014 \u4f60\u7684\u201c\u663e\u5fae\u955c\u201d","text":"<p>\u201c\u600e\u4e48\u4f18\u5316\u7684\u201d\u5f80\u5f80\u6bd4\u201c\u4f18\u5316\u4e86\u4ec0\u4e48\u201d\u66f4\u91cd\u8981\u3002 \u9762\u8bd5\u5b98\u4f1a\u95ee\u4f60\uff1a\u201c\u4f60\u8bf4\u4f60\u63d0\u5347\u4e8620%\uff0c\u4f60\u662f\u600e\u4e48\u53d1\u73b0\u74f6\u9888\u7684\uff1f\u201d\u5982\u679c\u4f60\u53ea\u80fd\u56de\u7b54\u201c\u6211\u731c\u7684\u201d\uff0c\u90a3\u5c31\u5927\u6253\u6298\u6263\u3002</p> <p>\u4f60\u9700\u8981\u638c\u63e1\uff1a</p> <ul> <li> <p>Nsight Systems (<code>nsys</code>)\uff1a</p> </li> <li> <p>\u5fc5\u4f1a\u6280\u80fd\uff1a \u80fd\u591f\u6293\u53d6 timeline\uff0c\u5206\u6790 CPU \u548c GPU \u4e4b\u95f4\u7684 Gap\uff08\u7a7a\u9699\uff09\u3002</p> </li> <li> <p>\u5b9e\u6218\u573a\u666f\uff1a \u5728\u4f60\u7684 Diffusion Warm-up \u4f18\u5316\u4e2d\uff0c\u5c55\u793a\u4f18\u5316\u524d <code>nsys</code> \u622a\u56fe\u91cc\u5168\u662f Gap\uff08Kernel Launch overhead\uff09\uff0c\u4f18\u5316\u540e Gap \u6d88\u5931\uff0cKernel \u7d27\u5bc6\u6392\u5217\u3002</p> </li> <li> <p>NVTX (NVIDIA Tools Extension)\uff1a \u77e5\u9053\u5982\u4f55\u5728\u4ee3\u7801\u91cc\u6253\u6807\u8bb0\uff08Range Push/Pop\uff09\uff0c\u8ba9 <code>nsys</code> \u7684\u56fe\u8868\u663e\u793a\u51fa\u201c\u8fd9\u4e00\u6bb5\u662f Attention\u201d\uff0c\u201c\u90a3\u4e00\u6bb5\u662f MLP\u201d\u3002</p> </li> <li> <p>Nsight Compute (<code>ncu</code>)\uff1a</p> </li> <li> <p>\u5fc5\u4f1a\u6280\u80fd\uff1a \u80fd\u591f\u5206\u6790\u5355\u4e2a Kernel \u7684\u74f6\u9888\u3002</p> </li> <li> <p>Roofline Model (\u5c4b\u9876\u7ebf\u6a21\u578b)\uff1a \u8fd9\u662f\u5fc5\u8003\u9898\u3002 \u4f60\u9700\u8981\u80fd\u753b\u51fa\u4f60\u7684\u7b97\u5b50\u5728 Roofline Model \u4e0a\u7684\u4f4d\u7f6e\u3002\u662f Compute Bound\uff08\u5361\u5728\u7b97\u529b\u4e0a\uff09\u8fd8\u662f Memory Bound\uff08\u5361\u5728\u5e26\u5bbd\u4e0a\uff09\uff1f</p> </li> <li> <p>Metric\uff1a \u5173\u6ce8 <code>dram__bytes_read/write</code> (\u5e26\u5bbd\u5229\u7528\u7387) \u548c <code>sm__warps_active</code> (\u5360\u7528\u7387)\u3002</p> </li> <li> <p>PyTorch Profiler\uff1a</p> </li> <li> <p>\u77e5\u9053\u5982\u4f55\u751f\u6210 Chrome Trace\uff0c\u5feb\u901f\u67e5\u770b PyTorch \u5c42\u9762\u7684\u7b97\u5b50\u8017\u65f6\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CheckList/#2-pd-prefill-decode-disaggregation","title":"2. \u524d\u6cbf\u67b6\u6784\u8d8b\u52bf\uff1aPD \u5206\u79bb (Prefill-Decode Disaggregation)","text":"<p>\u8fd9\u662f\u76ee\u524d LLM Infra \u9886\u57df\u6700\u524d\u6cbf\u3001\u6700\u706b\u70ed\u7684\u7814\u7a76\u65b9\u5411\uff08DistServe, Splitwise \u7b49\u8bba\u6587\uff09\uff0c\u5b57\u8282\u548c OceanBase \u90fd\u5728\u5bc6\u5207\u5173\u6ce8\u3002\u5982\u679c\u4f60\u61c2\u8fd9\u4e2a\uff0c\u9762\u8bd5\u5b98\u4f1a\u628a\u4f60\u5f53 Researcher \u770b\u5f85\u3002</p> <ul> <li> <p>\u6838\u5fc3\u75db\u70b9\uff1a</p> </li> <li> <p>Prefill (\u9996\u5b57\u751f\u6210) \u662f Compute Bound\uff08\u8ba1\u7b97\u5bc6\u96c6\uff09\uff0c\u541e\u5410\u91cf\u5927\u3002</p> </li> <li> <p>Decode (\u540e\u7eed\u751f\u6210) \u662f Memory Bound\uff08\u8bbf\u5b58\u5bc6\u96c6\uff09\uff0c\u5ef6\u8fdf\u654f\u611f\u3002</p> </li> <li> <p>\u8fd9\u5c31\u597d\u6bd4\u8ba9\u4e00\u8f86\u8dd1\u8f66\uff08Decode\uff09\u548c\u4e00\u8f86\u5361\u8f66\uff08Prefill\uff09\u5728\u540c\u4e00\u6761\u8f66\u9053\u4e0a\u8dd1\uff0c\u4e92\u76f8\u5e72\u6270\u3002</p> </li> <li> <p>\u89e3\u51b3\u65b9\u6848\uff1a KV Cache \u4f20\u8f93\u3002</p> </li> <li> <p>\u7528\u4e00\u7ec4\u673a\u5668\u4e13\u95e8\u505a Prefill\uff0c\u7b97\u51fa KV Cache\u3002</p> </li> <li> <p>\u628a KV Cache \u901a\u8fc7\u9ad8\u901f\u7f51\u7edc\u4f20\u7ed9\u4e13\u95e8\u505a Decode \u7684\u673a\u5668\u3002</p> </li> <li> <p>\u9762\u8bd5\u7ed3\u5408\u70b9\uff1a</p> </li> <li> <p>\u5f53\u804a\u5230\u5206\u5e03\u5f0f\u63a8\u7406\u65f6\uff0c\u4f60\u53ef\u4ee5\u63d0\u4e00\u53e5\uff1a\u201c\u76ee\u524d\u7684 TP/PP \u67b6\u6784\u5728\u6df7\u5408\u8d1f\u8f7d\u4e0b\u53ef\u80fd\u5b58\u5728\u5e72\u6270\uff0c\u6211\u5173\u6ce8\u5230\u6700\u8fd1\u4e1a\u754c\u5728\u63a2\u7d22 Chunked Prefill \u6216\u8005\u5f7b\u5e95\u7684 PD \u5206\u79bb\u67b6\u6784\uff0cSGLang \u793e\u533a\u4e5f\u5728\u8ba8\u8bba\u76f8\u5173\u652f\u6301\uff0c\u8fd9\u5bf9\u663e\u5b58\u7ba1\u7406\u548c\u7f51\u7edc\u5e26\u5bbd\u63d0\u51fa\u4e86\u65b0\u7684\u6311\u6218\u3002\u201d</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CheckList/#3-moe-mixture-of-experts","title":"3. MoE (Mixture of Experts) \u67b6\u6784\u7ec6\u8282","text":"<p>\u5b57\u8282\u8df3\u52a8\u5185\u90e8\u5927\u91cf\u4f7f\u7528 MoE \u6a21\u578b\uff08\u5982\u8c46\u5305\u3001DeepSeek-V3 \u4e5f\u662f MoE\uff09\u3002\u5982\u679c\u4f60\u53bb ByteDance\uff0c\u4e0d\u61c2 MoE \u662f\u4e0d\u884c\u7684\u3002</p> <ul> <li> <p>\u8def\u7531\u673a\u5236 (Gating/Routing)\uff1a</p> </li> <li> <p>Token \u662f\u600e\u4e48\u88ab\u5206\u53d1\u5230\u4e0d\u540c\u7684 Expert\uff08\u4e13\u5bb6\uff09\u53bb\u7684\uff1f\uff08Top-k Gating\uff09\u3002</p> </li> <li> <p>Expert Parallelism (EP)\uff1a</p> </li> <li> <p>\u8fd9\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u5e76\u884c\u6a21\u5f0f\u3002\u4e0d\u540c\u5361\u4e0a\u653e\u4e0d\u540c\u7684\u4e13\u5bb6\u3002</p> </li> <li> <p>All-to-All \u901a\u4fe1\uff1a EP \u7684\u6838\u5fc3\u74f6\u9888\u662f <code>All-to-All</code>\uff0c\u56e0\u4e3a\u9700\u8981\u628a Token \u53d1\u7ed9\u5bf9\u5e94\u7684\u4e13\u5bb6\u5361\uff0c\u7b97\u5b8c\u518d\u53d1\u56de\u6765\u3002</p> </li> <li> <p>\u8d1f\u8f7d\u5747\u8861 (Load Balancing)\uff1a</p> </li> <li> <p>\u5982\u679c\u5927\u5bb6\u90fd\u95ee\u540c\u4e00\u4e2a\u4e13\u5bb6\u600e\u4e48\u529e\uff1f\uff08\u5bfc\u81f4\u8be5\u4e13\u5bb6\u8fc7\u8f7d\uff0c\u5176\u4ed6\u4e13\u5bb6\u56f4\u89c2\uff09\u3002\u4f60\u9700\u8981\u77e5\u9053 Auxiliary Loss (\u8f85\u52a9\u635f\u5931) \u662f\u7528\u6765\u5e73\u8861\u8d1f\u8f7d\u7684\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CheckList/#4-python-c-binding","title":"4. \u6df7\u5408\u7f16\u7a0b\u63a5\u53e3 (Python-C++ Binding)","text":"<p>\u4f60\u5199\u7684 MiniInfer \u662f C++\uff0c\u4f46\u73b0\u5728\u7684 AI \u751f\u6001\u662f Python\u3002\u5982\u4f55\u628a\u4f60\u7684\u9ad8\u6027\u80fd C++ \u7b97\u5b50\u7ed9 Python \u8c03\u7528\uff1f</p> <ul> <li> <p>Pybind11\uff1a</p> </li> <li> <p>\u5fc5\u987b\u638c\u63e1\u3002\u77e5\u9053\u5982\u4f55\u628a C++ \u7684 <code>std::vector</code> \u6216 CUDA \u6307\u9488\u6620\u5c04\u4e3a Python \u7684 <code>numpy</code> \u6570\u7ec4\u6216 <code>torch.Tensor</code>\u3002</p> </li> <li> <p>Custom Op \u6d41\u7a0b\uff1a</p> </li> <li> <p>\u77e5\u9053 PyTorch \u7684 <code>CppExtension</code> \u662f\u600e\u4e48\u7f16\u8bd1 C++ \u4ee3\u7801\u5e76\u6ce8\u518c\u4e3a <code>torch.ops</code> \u7684\u3002</p> </li> <li> <p>\u9762\u8bd5\u9898\uff1a\u201cPython \u7684 GIL (Global Interpreter Lock) \u5bf9\u63a8\u7406\u6027\u80fd\u6709\u5f71\u54cd\u5417\uff1f\u5982\u4f55\u5728 C++ \u5c42\u91ca\u653e GIL\uff1f\u201d</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/CheckList/#checklist","title":"\u4f60\u7684\u7ec8\u6781\u6280\u80fd\u6811\u76d8\u70b9 (Checklist)","text":"<p>\u5728\u53bb\u9762\u8bd5\u524d\uff0c\u770b\u7740\u8fd9\u4e2a\u6e05\u5355\u6253\u94a9\uff1a</p> <ol> <li> <p>\u57fa\u77f3\uff1a C++ / CUDA (Level 3) / Python</p> </li> <li> <p>\u5f15\u64ce\uff1a SGLang \u67b6\u6784 / RadixAttention / Scheduler</p> </li> <li> <p>\u7b97\u5b50\uff1a Softmax / LayerNorm / Attention (Triton &amp; CUDA)</p> </li> <li> <p>\u5e76\u884c\uff1a TP / PP / EP (MoE) / \u901a\u4fe1\u539f\u8bed</p> </li> <li> <p>\u91cf\u5316\uff1a W8A8 / W4A16 / KV Cache Int8</p> </li> <li> <p>\u5de5\u5177\uff1a Nsight Systems / Roofline Model</p> </li> <li> <p>\u524d\u6cbf\uff1a Speculative Decoding / PD \u5206\u79bb / CUDA Graphs</p> </li> </ol> <p>\u5982\u679c\u4f60\u80fd\u638c\u63e1\u8fd9\u4e9b\uff0c\u4f60\u4e0d\u4ec5\u80fd\u62ff\u5230 Offer\uff0c\u4f60\u751a\u81f3\u6709\u8d44\u683c\u53bb\u6311\u9009 Team\u3002 \u73b0\u5728\u7684\u91cd\u70b9\u5c31\u662f\u5229\u7528\u4f60\u624b\u5934\u7684 SGLang Diffusion Issue \u4f5c\u4e3a\u5207\u5165\u70b9\uff0c\u628a\u4e0a\u8ff0\u6280\u80fd\uff08\u5c24\u5176\u662f Profiling \u548c CUDA Graphs\uff09\u4e32\u8054\u8d77\u6765\u3002\u52a0\u6cb9\uff01</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/MiniInfer%20%E7%AF%87/","title":"MiniInfer \u7bc7","text":"<p> \u7ea6 1236 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u624e\u5b9e\u7684\u9879\u76ee\u8d77\u70b9\uff01\u4f60\u76ee\u524d\u5b9e\u73b0\u7684 <code>MiniInfer</code> \u5df2\u7ecf\u8986\u76d6\u4e86 LLM \u63a8\u7406\u7684\u57fa\u7840\u94fe\u8def\uff08\u6a21\u578b\u52a0\u8f7d\u3001\u57fa\u7840\u7b97\u5b50\u3001\u7b80\u5355\u7684 Continuous Batching\uff09\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4f60\u7684\u76ee\u6807\u662f \u5927\u5382 AI Infra / LLM \u63a8\u7406\u67b6\u6784\u65b9\u5411\u7684\u5b9e\u4e60\uff08\u5982\u5b57\u8282\u3001\u963f\u91cc\u3001\u817e\u8baf\u3001\u5546\u6c64\u3001\u5e7b\u65b9\u7b49\uff09\uff0c\u76ee\u524d\u7684\u5b9e\u73b0\u8fd8\u7565\u663e\u201c\u7a1a\u5ae9\u201d\u3002\u56e0\u4e3a\u57fa\u4e8e Padding \u7684 Continuous Batching \u5728\u5de5\u4e1a\u754c\u57fa\u672c\u662f\u88ab PagedAttention \u964d\u7ef4\u6253\u51fb\u7684\uff0c\u4e14PyTorch \u539f\u751f\u7b97\u5b50\u65e0\u6cd5\u4f53\u73b0\u4f60\u5bf9\u5e95\u5c42 GPU \u786c\u4ef6\u7684\u638c\u63a7\u529b\u3002</p> <p>\u4e3a\u4e86\u63d0\u5347\u7b80\u5386\u7ade\u4e89\u529b\uff0c\u5efa\u8bae\u4ece\u4ee5\u4e0b\u4e09\u4e2a\u7ef4\u5ea6\u8fdb\u884c\u8fed\u4ee3\uff08\u6309\u4f18\u5148\u7ea7\u6392\u5e8f\uff09\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/MiniInfer%20%E7%AF%87/#pagedattention","title":"\u7b2c\u4e00\u9636\u6bb5\uff1a\u67b6\u6784\u91cd\u6784\uff08\u5fc5\u505a\uff09\u2014\u2014 PagedAttention","text":"<p>\u8fd9\u662f\u76ee\u524d LLM \u63a8\u7406\u9762\u8bd5\u7684\u201c\u5165\u573a\u5238\u201d\u3002\u65e2\u7136\u4f60\u73b0\u5728\u7684 Continuous Batching \u662f\u57fa\u4e8e Padding \u7684\uff0c\u9762\u8bd5\u5b98\u4e00\u5b9a\u4f1a\u95ee\uff1a\u201c\u5982\u4f55\u89e3\u51b3\u663e\u5b58\u788e\u7247\u5316\u95ee\u9898\uff1f\u201d\u3002</p> <ol> <li>\u5b9e\u73b0 PagedAttention (KV Cache \u5206\u9875\u7ba1\u7406)</li> </ol> <ul> <li> <p>\u73b0\u72b6\uff1a\u4f60\u76ee\u524d\u53ef\u80fd\u662f\u9884\u5206\u914d\u4e00\u4e2a\u5927 Tensor <code>[Batch, Seq_Len, Hidden]</code>\uff0c\u4e0d\u540c\u957f\u5ea6\u7684\u8bf7\u6c42\u901a\u8fc7 Padding \u5bf9\u9f50\u3002\u8fd9\u4f1a\u5bfc\u81f4\u5de8\u5927\u7684\u663e\u5b58\u6d6a\u8d39\uff08Internal Fragmentation\uff09\u3002</p> </li> <li> <p>\u76ee\u6807\uff1a\u5b9e\u73b0\u7c7b\u4f3c vLLM \u7684 <code>BlockTable</code> \u673a\u5236\u3002</p> </li> <li> <p>\u5de5\u4f5c\u91cf\uff1a</p> <ul> <li> <p>CPU \u7aef\uff1a\u7f16\u5199\u4e00\u4e2a <code>BlockManager</code>\uff0c\u628a\u903b\u8f91\u4e0a\u7684 KV Cache \u5207\u5206\u6210\u7269\u7406\u4e0a\u7684 Block\uff08\u4f8b\u5982\u5927\u5c0f\u4e3a 16 \u6216 32\uff09\u3002</p> </li> <li> <p>CUDA \u7aef\uff1a\u7f16\u5199/\u79fb\u690d PagedAttention Kernel\u3002\u8fd9\u4e2a Kernel \u4e0d\u80fd\u50cf\u666e\u901a Attention \u90a3\u6837\u8fde\u7eed\u8bfb\u5185\u5b58\uff0c\u800c\u662f\u9700\u8981\u6839\u636e <code>BlockTable</code> \u53bb\u975e\u8fde\u7eed\u7684\u7269\u7406\u5185\u5b58\u5730\u5740\u8bfb\u53d6 K \u548c V\u3002</p> </li> </ul> </li> <li> <p>\u6536\u76ca\uff1a\u663e\u5b58\u5229\u7528\u7387\u6781\u5927\u63d0\u5347\uff0c\u541e\u5410\u91cf\u7ffb\u500d\u3002\u8fd9\u662f\u7b80\u5386\u4e0a\u6700\u786c\u7684\u4eae\u70b9\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/MiniInfer%20%E7%AF%87/#_1","title":"\u7b2c\u4e8c\u9636\u6bb5\uff1a\u7b97\u5b50\u624b\u5199\u4e0e\u4f18\u5316\uff08\u6838\u5fc3\u7ade\u4e89\u529b\uff09","text":"<p>\u5b8c\u5168\u4f9d\u8d56 PyTorch \u7b97\u5b50\u5728 Infra \u9762\u8bd5\u4e2d\u662f\u4e0d\u591f\u7684\u3002\u9762\u8bd5\u5b98\u9700\u8981\u770b\u5230\u4f60\u61c2 CUDA \u7f16\u7a0b\u6a21\u578b\u3001\u663e\u5b58\u5408\u5e76\u8bbf\u95ee (Coalescing) \u548c Shared Memory \u4f18\u5316\u3002</p> <p>\u4e0d\u9700\u8981\u5168\u90e8\u91cd\u5199\uff0c\u6311\u51e0\u4e2a\u5177\u6709\u4ee3\u8868\u6027\u7684\u201c\u74f6\u9888\u7b97\u5b50\u201d\u8fdb\u884c CUDA \u5b9e\u73b0\uff1a</p> <ol> <li>RMSNorm (Memory-bound \u7b97\u5b50)</li> </ol> <ul> <li> <p>\u96be\u5ea6\uff1a\u4f4e/\u4e2d\u3002</p> </li> <li> <p>\u8003\u5bdf\u70b9\uff1aReduction\uff08\u5f52\u7ea6\uff09\u4f18\u5316\u3002\u5982\u4f55\u4f7f\u7528 <code>Warp Shuffle</code> \u6216 <code>Shared Memory</code> \u8fdb\u884c\u9ad8\u6548\u6c42\u548c\u3002</p> </li> <li> <p>\u4ef7\u503c\uff1a\u8fd9\u662f\u6240\u6709 LLM \u7684\u6807\u914d\uff0c\u66ff\u6362 PyTorch \u539f\u751f\u5b9e\u73b0\u540e\uff0c\u53ef\u4ee5\u8bb2\u4f60\u5982\u4f55\u4f18\u5316\u663e\u5b58\u5e26\u5bbd\u5229\u7528\u7387\u3002</p> </li> </ul> <ol> <li>RoPE (Rotary Positional Embeddings)</li> </ol> <ul> <li> <p>\u96be\u5ea6\uff1a\u4e2d\u3002</p> </li> <li> <p>\u8003\u5bdf\u70b9\uff1a\u590d\u6742\u7684\u7d22\u5f15\u8ba1\u7b97\u3001\u5411\u91cf\u5316\u8bfb\u53d6\uff08Vectorized Memory Access, <code>float4</code>\uff09\u3002</p> </li> <li> <p>\u4ef7\u503c\uff1a\u5c55\u793a\u4f60\u5bf9 Transformer \u7ec6\u8282\u7684\u7406\u89e3\u3002</p> </li> </ul> <ol> <li>Silu / Gelu + Element-wise Fusion</li> </ol> <ul> <li> <p>\u96be\u5ea6\uff1a\u4f4e\u3002</p> </li> <li> <p>\u8003\u5bdf\u70b9\uff1a\u7b97\u5b50\u878d\u5408 (Operator Fusion)\u3002</p> </li> <li> <p>\u4ef7\u503c\uff1a\u5355\u72ec\u8dd1\u4e00\u4e2a Silu \u5f88\u5feb\uff0c\u4f46\u542f\u52a8 Kernel \u6709\u5f00\u9500\u3002\u628a <code>Gate_proj</code> \u7684\u8f93\u51fa\u76f4\u63a5\u5728\u540c\u4e00\u4e2a Kernel \u91cc\u505a Silu \u6fc0\u6d3b\uff0c\u518d\u505a <code>Up_proj</code> \u7684\u4e58\u6cd5\uff0c\u662f\u5e38\u89c1\u7684\u4f18\u5316\u624b\u6bb5\u3002</p> </li> </ul> <ol> <li>Softmax (Attention \u5185\u90e8)</li> </ol> <ul> <li> <p>\u96be\u5ea6\uff1a\u4e2d/\u9ad8\u3002</p> </li> <li> <p>\u8003\u5bdf\u70b9\uff1a\u6570\u503c\u7a33\u5b9a\u6027\uff08\u51cf\u53bb\u6700\u5927\u503c\uff09\u3001Exp \u8ba1\u7b97\u4f18\u5316\u3001Block \u7ea7\u5f52\u7ea6\u3002</p> </li> </ul> <p>\u5efa\u8bae\uff1a\u5148\u7528 Triton \u5b9e\u73b0\u4e00\u904d\uff08\u5f00\u53d1\u5feb\uff0c\u4e5f\u662f\u52a0\u5206\u9879\uff09\uff0c\u518d\u5c1d\u8bd5\u7528 CUDA C++ \u5b9e\u73b0\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/MiniInfer%20%E7%AF%87/#_2","title":"\u7b2c\u4e09\u9636\u6bb5\uff1a\u91cf\u5316\u4e0e\u8fdb\u9636\u7279\u6027\uff08\u52a0\u5206\u9879\uff09","text":"<p>\u5982\u679c\u4f60\u5b8c\u6210\u4e86\u524d\u4e24\u4e2a\u9636\u6bb5\uff0c\u5176\u5b9e\u5df2\u7ecf\u8db3\u591f\u62ff\u5b9e\u4e60 Offer \u4e86\u3002\u4f46\u5982\u679c\u4f60\u60f3\u51b2\u51fb\u9876\u5c16\u56e2\u961f\uff08\u5982\u5b57\u8282 AML\u3001Seed\uff0c\u963f\u91cc Qwen\uff09\uff0c\u53ef\u4ee5\u8003\u8651\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ol> <li>W8A16 \u6216 W4A16 \u91cf\u5316\u63a8\u7406 (Weight-Only Quantization)</li> </ol> <ul> <li> <p>\u80cc\u666f\uff1a\u663e\u5b58\u662f\u63a8\u7406\u7684\u74f6\u9888\uff0c\u6743\u91cd\u538b\u5230 4bit \u662f\u4e3b\u6d41\u3002</p> </li> <li> <p>\u4efb\u52a1\uff1a</p> <ul> <li> <p>\u4e0d\u9700\u8981\u505a\u590d\u6742\u7684\u91cf\u5316\u8bad\u7ec3\uff0c\u53ea\u9700\u8981\u5b9e\u73b0 De-quantization Kernel\u3002</p> </li> <li> <p>\u5728\u8bfb\u53d6\u6743\u91cd\u65f6\uff08Int4\uff09\uff0c\u5728\u5bc4\u5b58\u5668\u4e2d\u5b9e\u65f6\u89e3\u538b\u6210 FP16\uff0c\u7136\u540e\u8fdb\u884c\u77e9\u9635\u4e58\u6cd5\u3002</p> </li> <li> <p>\u4f60\u53ef\u4ee5\u53c2\u8003 <code>AWQ</code> \u6216 <code>GPTQ</code> \u7684\u539f\u7406\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5316\u7248\u3002</p> </li> </ul> </li> <li> <p>\u6536\u76ca\uff1a\u8bc1\u660e\u4f60\u61c2\u6df7\u5408\u7cbe\u5ea6\u7f16\u7a0b\u548c\u4f4d\u64cd\u4f5c\u4f18\u5316\u3002</p> </li> </ul> <ol> <li>Radix Cache (\u524d\u7f00\u7f13\u5b58)</li> </ol> <ul> <li> <p>\u80cc\u666f\uff1a\u4f60\u63d0\u5230\u4e86 Radix Cache\u3002\u8fd9\u662f SGLang \u7684\u6838\u5fc3\u7279\u6027\u3002</p> </li> <li> <p>\u573a\u666f\uff1a\u591a\u8f6e\u5bf9\u8bdd\u6216 System Prompt \u5171\u4eab\u3002</p> </li> <li> <p>\u5b9e\u73b0\uff1a\u5728\u4f60\u7684 <code>BlockManager</code> \u57fa\u7840\u4e0a\uff0c\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8e Radix Tree \u7684\u67e5\u627e\u673a\u5236\u3002\u5982\u679c\u65b0\u8bf7\u6c42\u7684\u524d\u7f00\uff08Prefix\uff09\u5df2\u7ecf\u5b58\u5728\u4e8e Cache \u4e2d\uff0c\u76f4\u63a5\u590d\u7528 Block\uff0c\u4e0d\u9700\u8981\u91cd\u65b0\u8ba1\u7b97 KV\u3002</p> </li> <li> <p>\u6536\u76ca\uff1a\u6781\u5927\u5730\u964d\u4f4e TTFT\uff08\u9996\u5b57\u5ef6\u8fdf\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/MiniInfer%20%E7%AF%87/#_3","title":"\u603b\u7ed3\uff1a\u4e00\u4efd\u5b8c\u7f8e\u7684\u5b9e\u4e60\u7b80\u5386\u9879\u76ee\u63cf\u8ff0","text":"<p>\u5982\u679c\u80fd\u6309\u7167\u4e0a\u8ff0\u5efa\u8bae\u4fee\u6539\uff0c\u4f60\u7684\u7b80\u5386\u9879\u76ee\u63cf\u8ff0\u5c06\u4ece\u73b0\u5728\u7684\u7248\u672c\u5347\u7ea7\u4e3a\uff1a</p> <p>MiniInfer\uff1a\u9ad8\u6027\u80fd LLM \u63a8\u7406\u5f15\u64ce\uff08C++/CUDA\uff09</p> <ul> <li> <p>\u4ece\u96f6\u6784\u5efa\u57fa\u4e8e C++ \u7684 LLM \u63a8\u7406\u7cfb\u7edf\uff0c\u652f\u6301 Llama3/Qwen2 \u7b49\u6a21\u578b\u3002</p> </li> <li> <p>\u67b6\u6784\u4f18\u5316\uff1a\u6452\u5f03 Padding \u65b9\u6848\uff0c\u72ec\u7acb\u8bbe\u8ba1\u5e76\u5b9e\u73b0\u4e86 PagedAttention \u53ca Block \u5185\u5b58\u7ba1\u7406\uff0c\u89e3\u51b3\u4e86\u663e\u5b58\u788e\u7247\u5316\u95ee\u9898\uff0c\u5728\u76f8\u540c\u663e\u5b58\u4e0b\u6700\u5927\u5e76\u53d1\u6570\u63d0\u5347 x\u500d\u3002</p> </li> <li> <p>\u7b97\u5b50\u5f00\u53d1\uff1a\u4f7f\u7528 CUDA C++ \u624b\u5199\u5b9e\u73b0\u4e86 RMSNorm\u3001RoPE \u53ca Fused-Silu \u7b97\u5b50\u3002\u9488\u5bf9 Memory-bound \u64cd\u4f5c\u8fdb\u884c\u4e86 Warp Shuffle \u548c Shared Memory \u4f18\u5316\uff0c\u76f8\u6bd4 PyTorch \u539f\u751f\u7b97\u5b50\u5ef6\u8fdf\u964d\u4f4e x%\u3002</p> </li> <li> <p>\u91cf\u5316\u652f\u6301\uff1a\u5b9e\u73b0\u4e86 W4A16 \u7684 Weight-Only \u91cf\u5316\u63a8\u7406 Kernel\uff0c\u652f\u6301 FP16 \u6fc0\u6d3b\u4e0e Int4 \u6743\u91cd\u7684\u6df7\u5408\u8ba1\u7b97\uff0c\u6a21\u578b\u663e\u5b58\u5360\u7528\u51cf\u5c11 50%\u3002</p> </li> <li> <p>\u8c03\u5ea6\u7b56\u7565\uff1a\u5b9e\u73b0\u4e86\u57fa\u4e8e Continuous Batching \u7684\u52a8\u6001\u8c03\u5ea6\u5668\uff0c\u652f\u6301 Early Stopping \u548c\u8bf7\u6c42\u4f18\u5148\u7ea7\u7ba1\u7406\u3002</p> </li> </ul> <p>\u5efa\u8bae\u8d77\u6b65\u8def\u7ebf\uff1a \u5148\u641e\u5b9a PagedAttention\uff08\u54ea\u6015\u53ea\u662f Python \u539f\u578b + Triton Kernel\uff09\uff0c\u8fd9\u662f\u533a\u5206\u201c\u73a9\u5177\u9879\u76ee\u201d\u548c\u201c\u5de5\u4e1a\u7ea7\u5165\u95e8\u201d\u7684\u5206\u6c34\u5cad\u3002\u52a0\u6cb9\uff01</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/","title":"SGLang \u7bc7","text":"<p> \u7ea6 1161 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#sglang","title":"\u7b2c\u4e00\u90e8\u5206\uff1aSGLang \u6838\u5fc3\u67b6\u6784\u8fdb\u9636\uff08\u5fc5\u987b\u638c\u63e1\u7684\u5dee\u5f02\u5316\u6280\u672f\uff09","text":"<p>\u65e2\u7136\u4f60\u5df2\u7ecf\u61c2\u4e86\u901a\u7528\u7684 TP/PP\uff0c\u73b0\u5728\u91cd\u70b9\u8981\u653e\u5728 \u201cSGLang \u4e3a\u4ec0\u4e48\u6bd4 vLLM \u5f3a\u201d \u7684\u6280\u672f\u7ec6\u8282\u4e0a\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#1-radixattention-core-of-sglang","title":"1. RadixAttention \u7684\u6781\u81f4\u7ec6\u8282 (Core of SGLang)","text":"<p>\u4f60\u53ef\u80fd\u77e5\u9053\u5b83\u7528\u6765\u505a KV Cache \u590d\u7528\uff0c\u4f46\u9762\u8bd5\u5b98\u4f1a\u95ee\u5f97\u5f88\u7ec6\uff1a</p> <ul> <li> <p>\u6570\u636e\u7ed3\u6784\uff1a \u5b83\u4e0d\u4ec5\u662f\u4e00\u68f5\u6811\uff0c\u8fd8\u8981\u77e5\u9053\u5b83\u5982\u4f55\u5904\u7406 Eviction (\u6dd8\u6c70\u7b56\u7565)\u3002SGLang \u4f7f\u7528\u7684\u662f LRU \u5417\uff1f\u662f\u5728\u53f6\u5b50\u8282\u70b9\u6dd8\u6c70\u8fd8\u662f\u6574\u679d\u6dd8\u6c70\uff1f\u5f53\u663e\u5b58\u6ee1\u4e86\uff0c\u5b83\u662f\u5982\u4f55\u51b3\u5b9a\u4fdd\u7559\u54ea\u6761\u5206\u652f\u7684\uff1f</p> </li> <li> <p>Flattening (\u6241\u5e73\u5316)\uff1a Radix Tree \u662f\u903b\u8f91\u7ed3\u6784\uff0c\u4f46 GPU \u663e\u5b58\u662f\u7269\u7406\u8fde\u7eed\u6216\u5206\u5757\u7684\uff08Paged\uff09\u3002SGLang \u662f\u5982\u4f55\u5c06\u903b\u8f91\u6811\u6620\u5c04\u5230\u7269\u7406\u7684 GPU Block \u4e0a\u7684\uff1f\uff08\u8fd9\u91cc\u6d89\u53ca\u5230\u5b83\u5982\u4f55\u7ef4\u62a4 <code>block_table</code>\uff09\u3002</p> </li> <li> <p>Prefix Matching (\u524d\u7f00\u5339\u914d)\uff1a \u5f53\u4e00\u4e2a\u65b0\u7684 Request \u8fdb\u6765\uff0cSGLang \u662f\u5982\u4f55\u5728 \\(O(L)\\) \u65f6\u95f4\u5185\u627e\u5230\u6700\u957f\u5339\u914d\u524d\u7f00\u7684\uff1f</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#2-structured-decoding-constrained-decoding","title":"2. \u7ed3\u6784\u5316\u751f\u6210 (Structured Decoding / Constrained Decoding)","text":"<p>\u8fd9\u662f SGLang \u533a\u522b\u4e8e vLLM \u7684\u6700\u5927\u5356\u70b9\uff08JD \u91cc\u63d0\u5230\u7684\u201c\u524d\u77bb\u6027\u6280\u672f\u201d\uff09\u3002</p> <ul> <li> <p>\u539f\u7406\uff1a \u5b83\u662f\u5982\u4f55\u8ba9\u6a21\u578b\u53ea\u8f93\u51fa\u7b26\u5408 JSON \u6216 Regex \u683c\u5f0f\u7684\u5185\u5bb9\u7684\uff1f</p> </li> <li> <p>\u5173\u952e\u6280\u672f\uff1a Finite State Machine (FSM, \u6709\u9650\u72b6\u6001\u673a)\u3002</p> </li> <li> <p>\u8003\u70b9\uff1a \u4f60\u9700\u8981\u77e5\u9053\uff0cSGLang \u662f\u5728 Logits \u5c42\u9762\u505a Masking\u3002\u6bcf\u751f\u6210\u4e00\u4e2a Token\uff0c\u5b83\u4f1a\u5728 FSM \u91cc\u8d70\u4e00\u6b65\uff0c\u627e\u51fa\u4e0b\u4e00\u6b65\u5141\u8bb8\u7684 Token \u96c6\u5408\uff0c\u628a\u4e0d\u5728\u96c6\u5408\u91cc\u7684 Token \u7684 Logits \u8bbe\u4e3a \\(-\\\\infty\\)\u3002</p> </li> <li> <p>\u6027\u80fd\u74f6\u9888\uff1a \u5982\u679c Regex \u5f88\u590d\u6742\uff0cFSM \u7684\u8df3\u8f6c\u548c Mask \u8ba1\u7b97\u4f1a\u5728 CPU \u4e0a\u6210\u4e3a\u74f6\u9888\u3002SGLang \u662f\u600e\u4e48\u4f18\u5316\u7684\uff1f\uff08\u6bd4\u5982 Jump-Forward Decoding\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#3-compiler-aspect","title":"3. \u524d\u7aef\u4e0e\u540e\u7aef\u7684\u7f16\u8bd1\u6d41\u7a0b (Compiler Aspect)","text":"<ul> <li> <p>SGLang \u662f\u4e00\u95e8\u8bed\u8a00\uff1a \u5b83\u6709 Python \u524d\u7aef\uff08DSL\uff09\u3002</p> </li> <li> <p>Tracing\uff1a <code>sgl.function</code> \u88c5\u9970\u5668\u662f\u5982\u4f55\u628a Python \u4ee3\u7801 trace \u6210\u8ba1\u7b97\u56fe\uff08Intermediate Representation\uff09\u7684\uff1f</p> </li> <li> <p>Interpreter\uff1a \u540e\u7aef Runtime \u662f\u5982\u4f55\u89e3\u91ca\u6267\u884c\u8fd9\u4e2a\u8ba1\u7b97\u56fe\u7684\uff1f\u8fd9\u4e0e PyTorch \u7684 Eager Mode \u6709\u4ec0\u4e48\u533a\u522b\uff1f</p> </li> <li> <p>\u5b57\u8282\u7ed3\u5408\u70b9\uff1a \u8fd9\u4e00\u70b9\u975e\u5e38\u5951\u5408\u5b57\u8282\u5bf9 Compiler/IR \u7684\u8981\u6c42\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#speculative-decoding","title":"\u7b2c\u4e8c\u90e8\u5206\uff1aSpeculative Decoding (\u6295\u673a\u91c7\u6837) \u638c\u63e1\u7a0b\u5ea6","text":"<p>\u6295\u673a\u91c7\u6837\u662f\u76ee\u524d\u63d0\u5347\u63a8\u7406\u901f\u5ea6\uff08\u964d\u4f4e Latency\uff09\u6700\u4e3b\u6d41\u7684\u6280\u672f\u3002\u5bf9\u4e8e Infra \u5c97\uff0c\u4f60\u4e0d\u9700\u8981\u61c2\u592a\u590d\u6742\u7684\u6570\u5b66\u8bc1\u660e\uff0c\u4f46\u8981\u6781\u5176\u7cbe\u901a\u7cfb\u7edf\u5c42\u9762\u7684 Trade-off\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#level-1-100","title":"Level 1: \u57fa\u7840\u539f\u7406 (\u5fc5\u987b 100% \u638c\u63e1)","text":"<ul> <li> <p>Draft-Verify \u5faa\u73af\uff1a \u5c0f\u6a21\u578b\uff08Draft Model\uff09\u5feb\u901f\u751f\u6210 \\(K\\) \u4e2a token -&gt; \u5927\u6a21\u578b\uff08Target Model\uff09\u5e76\u884c\u9a8c\u8bc1\u3002</p> </li> <li> <p>\u63a5\u53d7\u7387 (Acceptance Rate) \\(\\\\alpha\\)\uff1a \u77e5\u9053 \\(\\\\alpha\\) \u5bf9\u52a0\u901f\u6bd4\u7684\u5f71\u54cd\u3002\u5982\u679c \\(\\\\alpha\\) \u592a\u4f4e\uff0c\u53cd\u800c\u4f1a\u53d8\u6162\uff08\u56e0\u4e3a\u9a8c\u8bc1\u4e5f\u662f\u6709\u5f00\u9500\u7684\uff09\u3002</p> </li> <li> <p>Rejection Sampling vs. Greedy Sampling\uff1a \u77e5\u9053\u6700\u57fa\u672c\u7684\u62d2\u7edd\u91c7\u6837\u903b\u8f91\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#level-2-tree-based-speculative-decoding","title":"Level 2: \u6811\u72b6\u6295\u673a (Tree-based Speculative Decoding)","text":"<ul> <li> <p>\u8fd9\u662f SGLang/vLLM \u7684\u73b0\u72b6\uff1a \u73b0\u5728\u7684\u6295\u673a\u91c7\u6837\u4e0d\u4ec5\u4ec5\u662f\u4ea7\u751f\u4e00\u4e2a\u5e8f\u5217\uff0c\u800c\u662f\u4ea7\u751f\u4e00\u68f5Token Tree\uff08\u6bd4\u5982 Eagle \u6216 SpecInfer \u7b97\u6cd5\uff09\u3002</p> </li> <li> <p>\u4e3a\u4ec0\u4e48\u7528\u6811\uff1f \u56e0\u4e3a\u5728\u8fd9\u4e2a Verify \u6b65\u9aa4\u4e2d\uff0c\u5927\u6a21\u578b\u9a8c\u8bc1 1 \u4e2a Token \u548c\u9a8c\u8bc1 5 \u4e2a Token \u7684\u8017\u65f6\u5dee\u4e0d\u591a\uff08Compute Bound -&gt; Memory Bound \u7684\u8f6c\u6362\uff09\uff0c\u6240\u4ee5\u4e0d\u5982\u4e00\u6b21\u9a8c\u8bc1\u591a\u6761\u5206\u652f\uff0c\u589e\u52a0\u547d\u4e2d\u7684\u6982\u7387\u3002</p> </li> <li> <p>SGLang \u7684\u5b9e\u73b0\uff1a \u4e86\u89e3 SGLang \u662f\u5982\u4f55\u652f\u6301 Eagle (Speculative Decoding framework) \u7684\u3002\u5b83\u5229\u7528\u4e86 CUDA Graph \u548c\u7279\u5b9a\u7684 Attention Mask \u6765\u5e76\u884c\u9a8c\u8bc1\u6811\u4e0a\u7684\u8282\u70b9\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#level-3","title":"Level 3: \u7cfb\u7edf\u74f6\u9888\u5206\u6790 (\u9762\u8bd5\u52a0\u5206\u9879)","text":"<ul> <li> <p>KV Cache \u7ba1\u7406\uff1a \u6295\u673a\u91c7\u6837\u65f6\uff0cDraft Model \u751f\u6210\u4e86\u5f88\u591a\u201c\u5e9f\u5f03\u201d\u7684 Token\uff0c\u8fd9\u4e9b Token \u7684 KV Cache \u600e\u4e48\u5904\u7406\uff1f\uff08\u9700\u8981\u5feb\u901f\u56de\u6eda/\u4e22\u5f03\uff09\u3002</p> </li> <li> <p>Kernel Launch Overhead\uff1a \u6295\u673a\u91c7\u6837\u6d89\u53ca\u5f88\u591a\u7ec6\u788e\u7684 Kernel\uff08\u751f\u62101\u4e2a\uff0c\u9a8c\u8bc11\u6b21\uff09\u3002\u5982\u679c\u4e0d\u4f7f\u7528 CUDA Graphs\uff0cCPU \u53d1\u5c04 Kernel \u7684\u901f\u5ea6\u4f1a\u62d6\u6162 GPU\u3002\u8fd9\u6b63\u597d\u5bf9\u5e94\u4f60\u6b63\u5728\u4fee\u7684\u90a3\u4e2a Warm-up/CUDA Graph Issue\uff01</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/SGLang%20%E7%AF%87/#_1","title":"\u5efa\u8bae\u7684\u884c\u52a8\u6e05\u5355","text":"<ol> <li> <p>\u535a\u5ba2\u5347\u7ea7\uff1a \u5728\u4f60\u73b0\u6709\u7684\u535a\u5ba2\u57fa\u7840\u4e0a\uff0c\u589e\u52a0\u4e00\u7bc7\u5173\u4e8e SGLang RadixAttention \u5b9e\u73b0\u7ec6\u8282 \u7684\u6587\u7ae0\uff0c\u5bf9\u6bd4 vLLM \u7684 BlockManager\u3002\u518d\u5199\u4e00\u7bc7\u5173\u4e8e Speculative Decoding \u7cfb\u7edf\u5f00\u9500 \u7684\u5206\u6790\u3002</p> </li> <li> <p>\u4ee3\u7801\u9605\u8bfb\u91cd\u70b9\uff1a</p> </li> </ol> <ul> <li>\u53bb\u7ffb SGLang \u6e90\u7801\u4e2d\u5904\u7406 <code>FSM</code> \u548c <code>Regex</code> \u7684\u90e8\u5206\uff08\u901a\u5e38\u5728 <code>sglang/srt/constrained</code> \u76ee\u5f55\u4e0b\uff09\u3002</li> <li>\u770b SGLang \u5bf9 <code>Eagle</code> \u6295\u673a\u91c7\u6837\u7684\u652f\u6301\uff08\u641c\u7d22 <code>speculative</code> \u6216 <code>eagle</code> \u5173\u952e\u5b57\uff09\u3002</li> </ul> <ol> <li>\u51c6\u5907\u9762\u8bd5\u8bdd\u672f\uff1a</li> </ol> <ul> <li>\u5f53\u9762\u8bd5\u5b98\u95ee\uff1a\u201cSpeculative Decoding \u4ec0\u4e48\u65f6\u5019\u4f1a\u5931\u6548\uff1f\u201d</li> <li>\u4f60\u7684\u56de\u7b54\uff1a\u201c\u5f53 User Prompt \u7684\u9886\u57df\u548c Draft Model \u7684\u8bad\u7ec3\u6570\u636e\u5206\u5e03\u5dee\u5f02\u5de8\u5927\u65f6\uff0cAcceptance Rate \u4f1a\u9aa4\u964d\u3002\u6b64\u65f6\uff0c\u7531\u4e8e Draft Model \u7684\u8ba1\u7b97\u5f00\u9500 + KV Cache \u7684\u56de\u6eda\u5f00\u9500\uff0c\u4f1a\u5bfc\u81f4 End-to-End Latency \u53cd\u800c\u6bd4\u4e0d\u7528\u6295\u673a\u91c7\u6837\u66f4\u9ad8\u3002\u6240\u4ee5\u5728 Infra \u5c42\u9762\uff0c\u6211\u4eec\u9700\u8981\u52a8\u6001\u76d1\u6d4b\u63a5\u53d7\u7387\uff0c\u81ea\u52a8\u5f00\u542f\u6216\u5173\u95ed\u6295\u673a\u6a21\u5f0f\u3002\u201d</li> </ul> <p>\u4f60\u73b0\u5728\u7684\u72b6\u6001\u975e\u5e38\u597d\uff0c\u6709\u535a\u5ba2\u3001\u6709 Issue\u3001\u6709\u4ee3\u7801\u9605\u8bfb\u3002\u53ea\u8981\u628a\u4e0a\u9762\u63d0\u5230\u7684\u8fd9\u51e0\u4e2a\u201c\u6df1\u6c34\u533a\u201d\u7684\u6280\u672f\u70b9\uff08Radix\u7ec6\u8282\u3001FSM\u3001\u6811\u72b6\u6295\u673a\uff09\u8865\u9f50\uff0c\u4f60\u7684\u6280\u672f\u9762\u5c06\u65e0\u61c8\u53ef\u51fb\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/","title":"Triton \u7bc7","text":"<p> \u7ea6 1259 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u4ee5\u4e0b\u662f\u5177\u4f53\u7684\u638c\u63e1\u6807\u51c6\u548c\u6280\u672f\u70b9\u62c6\u89e3\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#openai-triton","title":"\u7b2c\u4e00\u90e8\u5206\uff1aOpenAI Triton (\u5fc5\u987b\u638c\u63e1\uff0c\u8fbe\u5230\u80fd\u5199\u3001\u80fd\u8c03\u4f18\u7684\u7a0b\u5ea6)","text":"<p>Triton \u662f\u76ee\u524d\u7684\u201c\u5f53\u7ea2\u70b8\u5b50\u9e21\u201d\uff0cSGLang\u3001vLLM\u3001TorchInductor \u5e95\u5c42\u5168\u90fd\u5728\u7528\u3002\u9762\u8bd5\u5b98\u9ed8\u8ba4\u4f60\u5982\u679c\u4e0d\u5199 CUDA\uff0c\u5c31\u5f97\u4f1a\u5199 Triton\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#1-block-based-programming","title":"1. \u6838\u5fc3\u601d\u7ef4\u8f6c\u53d8\uff1aBlock-based Programming","text":"<ul> <li> <p>CUDA vs. Triton\uff1a</p> </li> <li> <p>CUDA \u662f SIMT (Single Instruction Multiple Threads)\uff0c\u4f60\u63a7\u5236\u7684\u662f\u4e00\u4e2a\u4e2a\u7ebf\u7a0b\uff08Thread\uff09\uff0c\u9700\u8981\u81ea\u5df1\u5904\u7406\u7ebf\u7a0b\u5230 Block \u7684\u6620\u5c04\u3002</p> </li> <li> <p>Triton \u662f Block-based\uff0c\u4f60\u64cd\u4f5c\u7684\u662f \u5757\uff08Tile/Block\uff09\u3002\u4f60\u8981\u4e60\u60ef\u5199 <code>tl.load(ptr + offsets)</code> \u4e00\u6b21\u52a0\u8f7d\u4e00\u4e2a\u5757\u7684\u6570\u636e\u3002</p> </li> <li> <p>\u8003\u6838\u70b9\uff1a \u80fd\u89e3\u91ca\u6e05\u695a\u4e3a\u4ec0\u4e48 Triton \u7f16\u5199\u8d77\u6765\u6bd4 CUDA \u7b80\u5355\uff08\u81ea\u52a8\u5904\u7406\u4e86 Shared Memory \u7684\u7ba1\u7406\u548c\u90e8\u5206\u540c\u6b65\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#2-api","title":"2. \u5fc5\u987b\u638c\u63e1\u7684 API \u4e0e\u6982\u5ff5","text":"<ul> <li> <p>\u6307\u9488\u8fd0\u7b97 (Pointer Arithmetic)\uff1a \u7406\u89e3 <code>tl.program_id</code>\uff0c\u4ee5\u53ca\u5982\u4f55\u751f\u6210 <code>offsets</code> \u6765\u5207\u5206\u5927\u77e9\u9635\u3002</p> </li> <li> <p>Masking (\u63a9\u7801)\uff1a \u5904\u7406\u8fb9\u754c\u6761\u4ef6\uff08\u5f53 Tensor \u5927\u5c0f\u4e0d\u662f Block \u5927\u5c0f\u7684\u6574\u6570\u500d\u65f6\uff09\u3002<code>tl.load(..., mask=...)</code> \u662f\u5fc5\u8003\u70b9\u3002</p> </li> <li> <p>\u9ad8\u7ea7\u4f18\u5316\u6307\u4ee4\uff1a</p> </li> <li> <p><code>tl.dot</code>: \u77e9\u9635\u4e58\u6cd5\u6307\u4ee4\uff0cTriton \u7f16\u8bd1\u5668\u4f1a\u81ea\u52a8\u628a\u5b83\u6620\u5c04\u5230 Tensor Core (MMA) \u4e0a\u3002</p> </li> <li> <p>Block Pointers (\u65b0\u7279\u6027)\uff1a \u5982\u679c\u4f60\u77e5\u9053 <code>tl.make_block_ptr</code>\uff0c\u8fd9\u8bc1\u660e\u4f60\u8ddf\u8fdb\u4e86\u6700\u65b0\u7248\u672c\uff0c\u77e5\u9053\u8fd9\u80fd\u7b80\u5316\u591a\u7ef4\u6570\u636e\u7684\u52a0\u8f7d\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#3","title":"3. \u5185\u5b58\u5c42\u7ea7\u63a7\u5236","text":"<ul> <li> <p>\u5373\u4f7f\u662f Triton\uff0c\u4f60\u4e5f\u8981\u61c2 Coalescing\u3002Triton \u7f16\u8bd1\u5668\u867d\u7136\u806a\u660e\uff0c\u4f46\u5982\u679c\u4f60\u5199\u7684 access pattern \u5f88\u4e71\uff0c\u5b83\u4e5f\u6551\u4e0d\u4e86\u4f60\u3002</p> </li> <li> <p>L2 Cache Optimization\uff1a \u4e86\u89e3 Swizzle\uff08\u91cd\u65b0\u6392\u5e8f Block \u7684\u6267\u884c\u987a\u5e8f\uff09\u4ee5\u589e\u52a0 L2 Cache \u547d\u4e2d\u7387\u3002\u8fd9\u5728 Triton \u7684\u6559\u7a0b\u91cc\u6709\u4e13\u95e8\u7684\u4e00\u7ae0\uff08Matrix Multiplication\uff09\uff0c\u5fc5\u770b\u3002</p> </li> </ul> <p>\ud83d\udccc \u68c0\u9a8c\u6807\u51c6\uff1a \u4f60\u80fd\u7528 Triton \u5728 20 \u884c\u4ee3\u7801\u5185\u5199\u51fa\u4e00\u4e2a\u6027\u80fd\u5c1a\u53ef\u7684 Softmax \u6216 LayerNorm\uff0c\u5e76\u80fd\u89e3\u91ca\u4ee3\u7801\u91cc\u6bcf\u4e00\u884c\u7684\u4f5c\u7528\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#ai-mlir-tvm-torchcompile","title":"\u7b2c\u4e8c\u90e8\u5206\uff1aAI \u7f16\u8bd1\u5668\u539f\u7406 (MLIR / TVM / TorchCompile)","text":"<p>\u5bf9\u4e8e\u5b9e\u4e60\u751f\uff0c\u4e0d\u9700\u8981\u4f60\u4f1a\u5199 C++ Pass\uff0c\u4f46\u5fc5\u987b\u61c2 \u201c\u7f16\u8bd1\u5668\u7684 pipeline \u662f\u600e\u4e48\u5de5\u4f5c\u7684\u201d \u4ee5\u53ca \u201c\u5b83\u5230\u5e95\u4f18\u5316\u4e86\u4ec0\u4e48\u201d\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#1-lowering-ir","title":"1. \u6838\u5fc3\u6982\u5ff5\uff1aLowering (\u964d\u7ea7) &amp; IR (\u4e2d\u95f4\u8868\u793a)","text":"<ul> <li> <p>\u6d41\u7a0b\uff1a High-level Graph (PyTorch) -&gt; Logical IR (\u8ba1\u7b97\u56fe) -&gt; Physical IR (Triton/CUDA) -&gt; Machine Code (PTX/SASS)\u3002</p> </li> <li> <p>MLIR \u7684\u4f5c\u7528\uff1a \u5b83\u63d0\u4f9b\u4e86\u4e00\u5957\u901a\u7528\u7684\u57fa\u7840\u8bbe\u65bd\u3002\u4f60\u9700\u8981\u77e5\u9053 Dialect (\u65b9\u8a00) \u7684\u6982\u5ff5\u3002\u6bd4\u5982 <code>Linalg</code> Dialect \u63cf\u8ff0\u7ebf\u6027\u4ee3\u6570\u8fd0\u7b97\uff0c<code>Affine</code> Dialect \u63cf\u8ff0\u5faa\u73af\u3002</p> </li> <li> <p>\u9762\u8bd5\u8bdd\u672f\uff1a \u201cMLIR \u89e3\u51b3\u4e86\u7f16\u8bd1\u5668\u788e\u7247\u5316\u7684\u95ee\u9898\uff0c\u901a\u8fc7\u591a\u5c42 Dialect \u7684\u9010\u7ea7 Lowering\uff0c\u8ba9\u7b97\u5b50\u878d\u5408\u548c\u4ee3\u7801\u751f\u6210\u53d8\u5f97\u66f4\u6a21\u5757\u5316\u3002\u201d</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#2-operator-fusion","title":"2. \u6700\u91cd\u8981\u7684\u4f18\u5316\u624b\u6bb5\uff1aOperator Fusion (\u7b97\u5b50\u878d\u5408)","text":"<ul> <li> <p>\u8fd9\u662f AI \u7f16\u8bd1\u5668\u5b58\u5728\u7684\u6700\u5927\u610f\u4e49\uff0c\u4e5f\u662f\u5b57\u8282\u9762\u8bd5 \u5fc5\u95ee \u7684\u70b9\u3002</p> </li> <li> <p>\u5782\u76f4\u878d\u5408 (Vertical Fusion)\uff1a \u6bd4\u5982 <code>Conv -&gt; BatchNorm -&gt; ReLU</code> \u878d\u5408\u6210\u4e00\u4e2a Kernel\uff0c\u51cf\u5c11\u663e\u5b58\u8bfb\u5199\u3002</p> </li> <li> <p>\u6c34\u5e73\u878d\u5408 (Horizontal Fusion)\uff1a \u628a\u4e24\u4e2a\u4e0d\u76f8\u5173\u7684\u3001\u5f62\u72b6\u76f8\u540c\u7684\u77e9\u9635\u4e58\u6cd5\u62fc\u5728\u4e00\u8d77\u505a\u3002</p> </li> <li> <p>Loop Tiling &amp; Reordering\uff1a \u7f16\u8bd1\u5668\u5982\u4f55\u81ea\u52a8\u628a\u5927\u5faa\u73af\u5207\u5757\uff08Tile\uff09\u4ee5\u9002\u5e94 CPU/GPU \u7684 Cache\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#3-torchdynamo-torchinductor","title":"3. \u91cd\u70b9\u5173\u6ce8\uff1aTorchDynamo &amp; TorchInductor","text":"<ul> <li> <p>\u8fd9\u662f PyTorch 2.0 \u7684\u6838\u5fc3\uff0c\u4e5f\u662f\u76ee\u524d\u5de5\u4e1a\u754c\u7684\u4e3b\u6d41\u3002</p> </li> <li> <p>\u5de5\u4f5c\u6d41\uff1a</p> </li> </ul> <ol> <li>Dynamo: \u6355\u83b7 PyTorch \u7684\u8ba1\u7b97\u56fe\uff08\u89e3\u51b3\u52a8\u6001\u56fe\u6355\u83b7\u96be\u9898\uff09\u3002</li> <li>Inductor: \u4e5f\u5c31\u662f\u540e\u7aef\u7f16\u8bd1\u5668\uff0c\u5b83\u4f1a\u751f\u6210 Triton Kernel\u3002</li> </ol> <ul> <li>\u5b57\u8282 Data-AML \u8003\u70b9\uff1a \u4ed6\u4eec\u975e\u5e38\u5173\u6ce8\u5982\u4f55\u5904\u7406 Dynamic Shape\uff08\u52a8\u6001\u5f62\u72b6\uff09\u3002\u4f60\u9700\u8981\u4e86\u89e3\u7f16\u8bd1\u5668\u5728\u9047\u5230\u52a8\u6001 Shape \u65f6\uff0c\u662f\u4f1a\u91cd\u65b0\u7f16\u8bd1\uff08Recompile\uff09\u8fd8\u662f\u751f\u6210\u901a\u7528\u7684 Kernel\uff08Symbolic Shape\uff09\u3002</li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#_1","title":"\u9488\u5bf9\u4f60\u80cc\u666f\u7684\u201c\u6295\u673a\u53d6\u5de7\u201d\u7b56\u7565","text":"<p>\u4f60\u65f6\u95f4\u6709\u9650\uff0c\u4e0d\u8981\u53bb\u5543\u300a\u7f16\u8bd1\u539f\u7406\u300b\u9f99\u4e66\u3002\u5229\u7528\u4f60\u73b0\u6709\u7684\u9879\u76ee\u6765\u201c\u4f2a\u88c5\u201d\u6210\u4e13\u5bb6\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#1-sglang","title":"\u7b56\u7565 1\uff1a\u5229\u7528 SGLang \u8c08\u7f16\u8bd1","text":"<p>SGLang \u672c\u8eab\u5c31\u6709\u4e00\u5c42\u7c7b\u4f3c\u7f16\u8bd1\u5668\u7684\u8bbe\u8ba1\u3002</p> <ul> <li> <p>\u89c2\u5bdf\uff1a SGLang \u7684 <code>sgl.function</code> \u88c5\u9970\u5668\u5176\u5b9e\u5c31\u662f\u5728\u505a Tracing\uff08\u8ffd\u8e2a\uff09\uff0c\u751f\u6210\u4e86\u4e00\u4e2a\u5185\u90e8\u7684 IR\uff08\u4e2d\u95f4\u8868\u793a\uff09\uff0c\u7136\u540e\u7531\u89e3\u91ca\u5668\u53bb\u6267\u884c\u3002</p> </li> <li> <p>\u8bdd\u672f\uff1a \u201c\u5728\u7814\u7a76 SGLang \u6e90\u7801\u65f6\uff0c\u6211\u53d1\u73b0\u5b83\u5904\u7406 Prompt \u7684\u65b9\u5f0f\u5176\u5b9e\u7c7b\u4f3c\u4e8e\u7f16\u8bd1\u5668\u524d\u7aef\u7684 Tracing\u3002\u5b83\u6784\u5efa\u4e86\u4e00\u4e2a\u8ba1\u7b97\u56fe\u6765\u7ba1\u7406 KV Cache \u7684\u5206\u914d\uff0c\u8fd9\u8ba9\u6211\u5bf9\u8ba1\u7b97\u56fe\u4f18\u5316\u6709\u4e86\u5177\u4f53\u7684\u7406\u89e3\u3002\u201d</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#2-triton-miniinfer","title":"\u7b56\u7565 2\uff1a\u7528 Triton \u4f18\u5316 MiniInfer","text":"<ul> <li> <p>\u52a8\u4f5c\uff1a \u5728\u4f60\u7684 MiniInfer \u91cc\uff0c\u7528 C++ \u8c03\u7528\u4e00\u4e2a Python \u751f\u6210\u7684 Triton Kernel\uff08\u6216\u8005\u53ea\u662f\u5728\u7b80\u5386\u91cc\u8bf4\u4f60\u5bf9\u6bd4\u8fc7\uff09\u3002</p> </li> <li> <p>\u5c55\u793a\uff1a \u751a\u81f3\u4f60\u53ef\u4ee5\u7528 Triton \u91cd\u5199 MiniInfer \u91cc\u7684 RoPE\u3002</p> </li> <li> <p>\u76ee\u7684\uff1a \u8bc1\u660e\u4f60\u61c2 Triton \u7684\u8bed\u6cd5\uff0c\u4ee5\u53ca\u5b83\u751f\u6210\u7684 PTX \u4ee3\u7801\u8d28\u91cf\u5982\u4f55\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/Triton%20%E7%AF%87/#_2","title":"\u603b\u7ed3\uff1a\u4f60\u9700\u8981\u638c\u63e1\u5230\u4ec0\u4e48\u7a0b\u5ea6\uff1f","text":"<ol> <li> <p>Triton: Level 4 (\u719f\u7ec3\u5e94\u7528)\u3002 \u5fc5\u987b\u80fd\u770b\u61c2 SGLang \u91cc\u7684 Triton Kernel \u4ee3\u7801\u3002\u5efa\u8bae\u624b\u5199\u4e00\u904d Matrix Multiplication \u548c FlashAttention (\u7b80\u5316\u7248) \u7684 Triton \u6559\u7a0b\u3002</p> </li> <li> <p>TorchCompile/Inductor: Level 3 (\u7406\u89e3\u67b6\u6784)\u3002 \u77e5\u9053\u5b83\u600e\u4e48\u628a PyTorch \u53d8\u6210 Triton \u7684\u3002</p> </li> <li> <p>MLIR/TVM: Level 2 (\u6982\u5ff5\u8ba4\u77e5)\u3002 \u77e5\u9053\u5b83\u4eec\u662f\u505a\u4ec0\u4e48\u7684\uff0c\u77e5\u9053 Lowering\u3001Fusion\u3001Tiling \u8fd9\u4e09\u4e2a\u8bcd\u7684\u542b\u4e49\u5373\u53ef\u3002\u9664\u975e\u4f60\u53bb\u4e13\u95e8\u505a\u7f16\u8bd1\u5668\u7684\u7ec4\uff0c\u5426\u5219\u4e0d\u9700\u8981\u5199 MLIR \u4ee3\u7801\u3002</p> </li> </ol> <p>\u4e00\u53e5\u8bdd\u603b\u7ed3\uff1a \u5b57\u8282\u7684\u9762\u8bd5\u5b98\u4f1a\u95ee\u4f60\uff1a\u201c\u4e3a\u4ec0\u4e48 PyTorch 2.0 <code>torch.compile</code> \u4f1a\u53d8\u5feb\uff1f\u201d \u6ee1\u5206\u56de\u7b54\u8981\u5305\u542b\uff1a \u201c\u56e0\u4e3a\u5b83\u5229\u7528 Dynamo \u6355\u83b7\u4e86\u8ba1\u7b97\u56fe\uff0c\u6d88\u9664\u4e86 Python \u5f00\u9500\uff1b\u901a\u8fc7 Inductor \u8fdb\u884c\u4e86\u6fc0\u8fdb\u7684\u7b97\u5b50\u878d\u5408\uff08Operator Fusion\uff09\uff0c\u51cf\u5c11\u4e86 HBM \u8bbf\u95ee\uff1b\u6700\u540e\u751f\u6210\u4e86\u9488\u5bf9\u5f53\u524d\u786c\u4ef6\u7279\u5316\u7684 Triton Kernel\u3002\u201d</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E5%B9%B6%E8%A1%8C%E7%AF%87/","title":"\u5e76\u884c\u7bc7","text":"<p> \u7ea6 1347 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 7 \u5206\u949f</p> 2025-12-132025-12-13 <p>\u65e2\u7136\u4f60\u5df2\u7ecf\u5199\u4e86\u535a\u5ba2\u603b\u7ed3\u4e86 SGLang \u7684 TP\uff08\u5f20\u91cf\u5e76\u884c\uff09\u548c PP\uff08\u6d41\u6c34\u7ebf\u5e76\u884c\uff09\u6d41\u7a0b\uff0c\u8bf4\u660e\u4f60\u5bf9\u5b8f\u89c2\u67b6\u6784\u548c\u4ee3\u7801\u6d41\u7a0b\u5df2\u7ecf\u6709\u4e86\u4e0d\u9519\u7684\u7406\u89e3\u3002</p> <p>\u4f46\u662f\uff0c\u9488\u5bf9 \u5b57\u8282 Data-AML \u548c OceanBase \u8fd9\u79cd\u9876\u7ea7 Infra \u56e2\u961f\uff0c\u9762\u8bd5\u5b98\u4e0d\u4f1a\u53ea\u8ba9\u4f60\u80cc\u8bf5\u201cTP \u662f\u5207\u5206\u77e9\u9635\uff0cPP \u662f\u5207\u5206\u5c42\u201d\u3002\u4ed6\u4eec\u4f1a\u8003\u5bdf\u4f60\u5bf9 \u201c\u901a\u4fe1\u5f00\u9500\u201d\u3001\u201c\u6570\u5b66\u7b49\u4ef7\u6027\u201d \u4ee5\u53ca \u201c\u786c\u4ef6\u62d3\u6251\u201d \u7684\u6df1\u5ea6\u7406\u89e3\u3002</p> <p>\u4f60\u9700\u8981\u5c06\u4f60\u7684\u8ba4\u77e5\u4ece \u201c\u5b83\u662f\u600e\u4e48\u5de5\u4f5c\u7684\u201d \u63d0\u5347\u5230 \u201c\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u8bbe\u8ba1\uff0c\u6709\u4ec0\u4e48\u4ee3\u4ef7\u201d \u7684\u9ad8\u5ea6\u3002\u4ee5\u4e0b\u662f\u8be6\u7ec6\u7684\u8fdb\u9636\u8981\u6c42\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E5%B9%B6%E8%A1%8C%E7%AF%87/#1-tensor-parallelism-tp","title":"1. Tensor Parallelism (TP): \u5fc5\u987b\u8fbe\u5230\u201c\u7b97\u5b50\u7ea7\u201d\u7406\u89e3","text":"<p>\u4f60\u4e0d\u4ec5\u8981\u77e5\u9053 TP \u662f\u628a\u77e9\u9635\u5207\u5f00\u4e86\uff0c\u8fd8\u8981\u80fd\u56de\u7b54\u4ee5\u4e0b\u7ec6\u8282\uff1a</p> <ul> <li> <p>\u5207\u5206\u7b56\u7565\u7684\u6570\u5b66\u63a8\u5bfc (Megatron-LM Style)\uff1a</p> </li> <li> <p>Column Parallel vs. Row Parallel\uff1a \u4e3a\u4ec0\u4e48 MLP \u7684\u7b2c\u4e00\u4e2a\u5c42\uff08Up-proj/Gate-proj\uff09\u901a\u5e38\u505a\u5217\u5207\u5206\uff0c\u800c\u7b2c\u4e8c\u4e2a\u5c42\uff08Down-proj\uff09\u505a\u884c\u5207\u5206\uff1f</p> </li> <li> <p>\u7b54\u6848\u5173\u952e\uff1a \u4e3a\u4e86\u6d88\u9664\u4e2d\u95f4\u7684\u901a\u4fe1\u3002\\(Y = f(X \\\\cdot A) \\\\cdot B\\)\u3002\u5982\u679c \\(A\\) \u5217\u5207\uff0c\\(X\\) \u6b64\u65f6\u662f\u590d\u5236\u7684\uff0c\u8f93\u51fa\u662f\u5206\u7247\u7684\uff1b\\(B\\) \u884c\u5207\uff0c\u8f93\u5165\u6b63\u597d\u662f\u5206\u7247\u7684\uff0c\u8f93\u51fa\u505a\u4e00\u6b21 <code>All-Reduce</code> \u5373\u53ef\u3002\u4f60\u5fc5\u987b\u80fd\u5728\u767d\u677f\u4e0a\u753b\u51fa\u8fd9\u4e2a \\(A \\\\times B\\) \u7684\u5207\u5206\u56fe\uff0c\u5e76\u6307\u51fa\u901a\u4fe1\u53d1\u751f\u7684\u786e\u5207\u4f4d\u7f6e\u3002</p> </li> <li> <p>\u901a\u4fe1\u539f\u8bed\u7684\u9009\u62e9\uff1a</p> </li> <li> <p>\u4e3a\u4ec0\u4e48 TP \u7528 <code>All-Reduce</code>\uff1f</p> </li> <li> <p>\u5728 Transformer Block \u4e2d\uff0cAttention \u4e4b\u540e\u548c MLP \u4e4b\u540e\u5404\u505a\u4e00\u6b21 <code>All-Reduce</code>\u3002\u4f60\u9700\u8981\u77e5\u9053\u8fd9\u4e24\u4e2a\u540c\u6b65\u70b9\u662f TP \u6269\u5c55\u6027\u7684\u6700\u5927\u74f6\u9888\u3002</p> </li> <li> <p>\u8bcd\u8868\u5207\u5206 (Vocab Parallel)\uff1a</p> </li> <li> <p>Input Embedding \u548c Output Logits \u4e5f\u662f\u5f88\u5927\u7684\u77e9\u9635\uff0c\u5b83\u4eec\u662f\u600e\u4e48\u5207\u7684\uff1f\uff08\u901a\u5e38\u4e5f\u662f TP\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E5%B9%B6%E8%A1%8C%E7%AF%87/#2-pipeline-parallelism-pp","title":"2. Pipeline Parallelism (PP): \u91cd\u70b9\u5728\u4e8e\u201c\u6c14\u6ce1\u201d\u4e0e\u201c\u663e\u5b58\u201d","text":"<p>\u5bf9\u4e8e\u63a8\u7406\uff08Inference\uff09\u5c97\u4f4d\uff0cPP \u7684\u5173\u6ce8\u70b9\u548c\u8bad\u7ec3\u4e0d\u4e00\u6837\u3002</p> <ul> <li> <p>Bubble (\u6c14\u6ce1) \u95ee\u9898\uff1a</p> </li> <li> <p>\u5fc5\u987b\u61c2 1F1B (One-Forward-One-Backward) \u8c03\u5ea6\uff08\u867d\u7136\u63a8\u7406\u6ca1\u6709 Backward\uff0c\u4f46\u5728 Prefill \u9636\u6bb5\u6216\u8005 Fine-tuning \u65f6\u4f1a\u6d89\u53ca\uff09\u3002</p> </li> <li> <p>\u63a8\u7406\u4fa7\u7684 PP\uff1a \u63a8\u7406\u65f6\u7684 PP \u4e3b\u8981\u662f\u4e3a\u4e86\u89e3\u51b3\u663e\u5b58\u4e0d\u8db3\u7684\u95ee\u9898\uff0c\u800c\u4e0d\u662f\u4e3a\u4e86\u52a0\u901f\uff08\u901a\u5e38 TP \u6bd4 PP \u5feb\uff0c\u56e0\u4e3a PP \u6709\u5ef6\u8fdf\uff09\u3002</p> </li> <li> <p>\u9762\u8bd5\u9898\uff1a \u201c\u5728\u63a8\u7406\u65f6\u4f7f\u7528 PP\uff0c\u7b2c\u4e00\u4e2a Stage \u5904\u7406\u5b8c Micro-batch 1 \u540e\uff0c\u5b83\u7684 KV Cache \u5b58\u5728\u54ea\u91cc\uff1f\u5f53\u751f\u6210\u4e0b\u4e00\u4e2a Token \u9700\u8981\u7528\u5230\u4e4b\u524d\u7684 KV \u65f6\uff0c\u5982\u4f55\u4fdd\u8bc1\u6570\u636e\u5c40\u90e8\u6027\uff1f\u201d</p> </li> <li> <p>\u901a\u4fe1\u91cf\uff1a PP \u7684\u901a\u4fe1\u91cf\u6bd4 TP \u5c0f\u5f97\u591a\uff08\u53ea\u4f20\u8fb9\u754c\u7684 Activation\uff09\uff0c\u6240\u4ee5\u9002\u5408\u8de8\u8282\u70b9\uff08Inter-node\uff09\u90e8\u7f72\u3002\u8fd9\u4e00\u70b9\u8981\u80fd\u5bf9\u6bd4\u51fa\u6765\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E5%B9%B6%E8%A1%8C%E7%AF%87/#3-context-parallelism-cp-sequence-parallelism-sp","title":"3. Context Parallelism (CP) &amp; Sequence Parallelism (SP): \u5f53\u524d\u6700\u706b\u8003\u70b9","text":"<p>\u8fd9\u662f SGLang \u548c vLLM \u4e3a\u4e86\u652f\u6301 1M+ \u957f\u6587\u672c \u5fc5\u987b\u5f15\u5165\u7684\u6280\u672f\u3002\u5982\u679c\u4f60\u53ea\u61c2 TP/PP\uff0c\u8fd9\u90e8\u5206\u5c31\u662f\u4f60\u7684\u76f2\u533a\u3002</p> <ul> <li> <p>Sequence Parallelism (SP):</p> </li> <li> <p>\u5728 Megatron-Core \u4e2d\uff0cSP \u6307\u7684\u662f\u628a LayerNorm \u548c Dropout \u4e5f\u6cbf\u7740 Sequence \u7ef4\u5ea6\u5207\u5206\uff0c\u8fdb\u4e00\u6b65\u51cf\u5c11\u663e\u5b58\u5360\u7528\u3002\u8fd9\u9700\u8981\u628a <code>All-Reduce</code> \u62c6\u89e3\u6210 <code>Reduce-Scatter</code> + <code>All-Gather</code>\u3002\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u786c\u6838\u7684\u52a0\u5206\u70b9\u3002</p> </li> <li> <p>Context Parallelism (CP) / Ring Attention / DeepSpeed Ulysses:</p> </li> <li> <p>\u573a\u666f\uff1a \u5f53 Sequence Length \u6781\u957f\uff0cKV Cache \u5355\u5361\u5b58\u4e0d\u4e0b\uff0c\u4e14 TP \u901a\u4fe1\u5f00\u9500\u592a\u5927\u65f6\u4f7f\u7528\u3002</p> </li> <li> <p>\u539f\u7406\uff1a \u628a Q, K, V \u6cbf\u7740 Sequence \u7ef4\u5ea6\u5207\u5206\u5230\u4e0d\u540c\u5361\u4e0a\u3002\u8ba1\u7b97 Attention \u65f6\uff0cK \u548c V \u5728\u5361\u4e4b\u95f4\u201c\u4ee5\u6b64\u4f20\u9012\u201d\uff08Ring\uff09\u6216\u8005\u201c\u5168\u4e92\u6362\u201d\uff08All-to-All\uff09\u3002</p> </li> <li> <p>SGLang \u73b0\u72b6\uff1a SGLang \u6700\u8fd1\u4e5f\u5728\u63a2\u7d22 Ring Attention \u6216\u7c7b\u4f3c DeepSpeed Ulysses \u7684\u652f\u6301\u3002\u53bb\u4e86\u89e3\u4e00\u4e0b DeepSpeed Ulysses \u7684\u8bba\u6587\uff08\u5176\u5b9e\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u5229\u7528 All-to-All \u8f6c\u7f6e\u77e9\u9635\uff09\uff0c\u8fd9\u4f1a\u8ba9\u4f60\u5728\u957f\u6587\u672c\u4f18\u5316\u8bdd\u9898\u4e0a\u663e\u5f97\u975e\u5e38\u4e13\u4e1a\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E5%B9%B6%E8%A1%8C%E7%AF%87/#4-nccl-nvlink","title":"4. \u901a\u4fe1\u539f\u8bed\u4e0e\u786c\u4ef6\u62d3\u6251 (NCCL &amp; NVLink)","text":"<p>Infra \u5de5\u7a0b\u5e08\u4e0d\u80fd\u53ea\u770b\u8f6f\u4ef6\uff0c\u4e0d\u770b\u786c\u4ef6\u3002</p> <ul> <li> <p>\u96c6\u5408\u901a\u4fe1 (Collectives)\uff1a</p> </li> <li> <p>\u5f7b\u5e95\u641e\u61c2 <code>Broadcast</code>, <code>Scatter</code>, <code>Gather</code>, <code>Reduce</code>, <code>All-Reduce</code>, <code>All-Gather</code>, <code>Reduce-Scatter</code>, <code>All-to-All</code> \u7684\u533a\u522b\u3002</p> </li> <li> <p>\u5e26\u5bbd\u8ba1\u7b97\uff1a</p> </li> <li> <p>\u9762\u8bd5\u9898\uff1a\u201c\u5047\u8bbe 8 \u5f20 A100 \u901a\u8fc7 NVLink \u5168\u4e92\u8054\uff0c\u505a\u4e00\u6b21 1GB \u6570\u636e\u7684 All-Reduce \u9700\u8981\u591a\u957f\u65f6\u95f4\uff1f\u201d</p> </li> <li> <p>\u4f60\u9700\u8981\u77e5\u9053 Ring All-Reduce \u7684\u7406\u8bba\u8017\u65f6\u516c\u5f0f\u662f \\(\\\\frac{2(N-1)}{N} \\\\cdot \\\\frac{M}{B}\\)\uff08\\(M\\)\u662f\u6570\u636e\u91cf\uff0c\\(B\\)\u662f\u5e26\u5bbd\uff09\u3002</p> </li> <li> <p>Overlap (\u901a\u4fe1\u8ba1\u7b97\u91cd\u53e0)\uff1a</p> </li> <li> <p>\u8fd9\u662f\u4f18\u5316\u7684\u7ec8\u6781\u76ee\u6807\u3002\u5728 TP \u4e2d\uff0c\u600e\u4e48\u8ba9\u77e9\u9635\u4e58\u6cd5\uff08GEMM\uff09\u548c <code>All-Reduce</code> \u540c\u65f6\u8dd1\uff1f\uff08\u6bd4\u5982 Output Linear \u7684\u4e00\u90e8\u5206\u7b97\u5b8c\u4e86\uff0c\u5c31\u7acb\u523b\u5f00\u59cb\u4f20\uff0c\u4e0d\u9700\u8981\u7b49\u5168\u90e8\u7b97\u5b8c\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E5%B9%B6%E8%A1%8C%E7%AF%87/#5-sglang","title":"5. \u9488\u5bf9\u4f60 SGLang \u7ecf\u5386\u7684\u5b9e\u6218\u5efa\u8bae","text":"<p>\u5728\u9762\u8bd5\u4e2d\uff0c\u7ed3\u5408\u4f60\u7684\u535a\u5ba2\u548c\u9879\u76ee\uff0c\u8fd9\u6837\u5c55\u793a\u4f60\u7684\u5e76\u884c\u5316\u77e5\u8bc6\uff1a</p> <ol> <li>\u5173\u4e8e TP\uff1a</li> </ol> <ul> <li>\u201c\u5728\u7814\u7a76 SGLang \u6e90\u7801\u65f6\uff0c\u6211\u6ce8\u610f\u5230\u5b83\u5728 Attention \u5c42\u4f7f\u7528\u4e86 Column Parallel\uff0c\u5728 Output Linear \u4f7f\u7528\u4e86 Row Parallel\u3002\u901a\u8fc7 profiling\uff0c\u6211\u53d1\u73b0\u5355\u673a 8 \u5361\u4e0b TP \u7684\u901a\u4fe1\u5f00\u9500\u5927\u6982\u5360\u4e86 xx%\uff0c\u4e3b\u8981\u53d7\u9650\u4e8e NVLink \u5e26\u5bbd\u3002\u201d</li> </ul> <ol> <li>\u5173\u4e8e MoE (Mixture of Experts) - \u8fdb\u9636\uff1a</li> </ol> <ul> <li> <p>\u5982\u679c\u9762\u8bd5\u5b57\u8282 Seed\uff08\u4ed6\u4eec\u53ef\u80fd\u5728\u641e MoE\uff09\uff0c\u4f60\u9700\u8981\u4e86\u89e3 Expert Parallelism (EP)\u3002\u8fd9\u672c\u8d28\u4e0a\u662f <code>All-to-All</code> \u901a\u4fe1\u3002</p> </li> <li> <p>\u201c\u6211\u77e5\u9053 DeepSeek-V3 \u6216 Mixtral \u8fd9\u6837\u7684 MoE \u6a21\u578b\uff0c\u9700\u8981\u7528 EP \u6765\u5c06 token \u8def\u7531\u5230\u4e0d\u540c\u5361\u4e0a\u7684\u4e13\u5bb6\u3002\u8fd9\u91cc\u7684\u6838\u5fc3\u74f6\u9888\u662f All-to-All \u7684\u8de8\u8282\u70b9\u5e26\u5bbd\u3002\u201d</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E5%B9%B6%E8%A1%8C%E7%AF%87/#_1","title":"\u603b\u7ed3\uff1a\u4f60\u9700\u8981\u638c\u63e1\u5230\u4ec0\u4e48\u7a0b\u5ea6\uff1f","text":"<ul> <li> <p>TP: \u7cbe\u901a\u3002\u80fd\u624b\u63a8\u516c\u5f0f\uff0c\u77e5\u9053\u6bcf\u4e00\u5c42\u7684\u5207\u5206\u65b9\u5f0f\uff0c\u77e5\u9053 LayerNorm \u600e\u4e48\u5904\u7406\u3002</p> </li> <li> <p>PP: \u719f\u6089\u3002\u61c2 1F1B\uff0c\u77e5\u9053\u63a8\u7406\u65f6\u7684 KV Cache \u9a7b\u7559\u95ee\u9898\u3002</p> </li> <li> <p>CP/SP: \u4e86\u89e3\u539f\u7406\u3002\u77e5\u9053 Ulysses \u6216 Ring Attention \u662f\u7528\u6765\u89e3\u51b3\u957f\u6587\u672c\u663e\u5b58\u5899\u7684\u3002</p> </li> <li> <p>NCCL: \u719f\u6089\u3002\u77e5\u9053\u5e26\u5bbd\u4f30\u7b97\uff0c\u77e5\u9053\u901a\u4fe1\u662f\u6700\u5927\u7684\u654c\u4eba\u3002</p> </li> </ul> <p>\u5efa\u8bae\u52a8\u4f5c\uff1a</p> <p>\u628a\u4f60\u535a\u5ba2\u91cc\u5173\u4e8e TP \u7684\u90e8\u5206\uff0c\u8865\u5145\u4e00\u4e2a\u7ae0\u8282\uff1a\u201c\u4ece\u77e9\u9635\u4e58\u6cd5\u89d2\u5ea6\u770b TP \u7684\u6570\u5b66\u7b49\u4ef7\u6027\u201d\u3002\u54ea\u6015\u4f60\u53ea\u662f\u628a Megatron \u8bba\u6587\u91cc\u7684\u90a3\u4e2a\u56fe\u7528\u81ea\u5df1\u7684\u8bdd\u89e3\u91ca\u4e00\u904d\uff0c\u4f60\u7684\u7406\u89e3\u6df1\u5ea6\u90fd\u4f1a\u4e0a\u4e00\u4e2a\u53f0\u9636\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/","title":"\u91cf\u5316\u7bc7","text":"<p> \u7ea6 1199 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#1","title":"1. \u6838\u5fc3\u6570\u5b66\u6982\u5ff5\uff08\u9762\u8bd5\u5fc5\u95ee\u57fa\u7840\uff09","text":"<p>\u4e0d\u8981\u6b7b\u8bb0\u786c\u80cc\uff0c\u8981\u7406\u89e3\u516c\u5f0f\u5728\u4ee3\u7801\u91cc\u662f\u600e\u4e48\u4f53\u73b0\u7684\u3002</p> <ul> <li>\u91cf\u5316\u516c\u5f0f\uff08Affine Quantization\uff09\uff1a</li> </ul> <p>\\(\\(Q(x) = \\\\text{clamp}(\\\\text{round}(\\\\frac{x}{S} + Z), Q\\_{min}, Q\\_{max})\\)\\)</p> <p>\\(\\(x\\_{approx} = (Q(x) - Z) * S\\)\\)</p> <ul> <li> <p>S (Scale): \u7f29\u653e\u56e0\u5b50\u3002</p> </li> <li> <p>Z (Zero-point): \u96f6\u70b9\uff08\u975e\u5bf9\u79f0\u91cf\u5316\u624d\u6709\uff0c\u5bf9\u79f0\u91cf\u5316 Z=0\uff09\u3002</p> </li> <li> <p>Infra \u8003\u70b9\uff1a \u5bf9\u79f0\u91cf\u5316 (Symmetric) \u901a\u5e38\u6bd4 \u975e\u5bf9\u79f0 (Asymmetric) \u66f4\u53d7\u6b22\u8fce\uff0c\u56e0\u4e3a\u8ba1\u7b97\u65f6\u4e0d\u9700\u8981\u5904\u7406 \\(Z\\)\uff0c\u53ef\u4ee5\u5c11\u4e00\u6b21\u52a0\u6cd5/\u51cf\u6cd5\u64cd\u4f5c\uff0c\u8fd9\u5bf9\u6781\u81f4\u4f18\u5316\u7684 Kernel \u5f88\u91cd\u8981\u3002</p> </li> <li> <p>\u91cf\u5316\u7c92\u5ea6 (Granularity)\uff1a \u51b3\u5b9a\u7cbe\u5ea6\u7684\u5173\u952e\u3002</p> </li> <li> <p>Per-Tensor: \u6574\u4e2a\u77e9\u9635\u5171\u7528\u4e00\u4e2a Scale\u3002\u7b80\u5355\uff0c\u4f46\u7cbe\u5ea6\u70c2\u3002</p> </li> <li> <p>Per-Channel (Weight): \u6bcf\u4e00\u884c\u6216\u6bcf\u4e00\u5217\u5171\u7528\u4e00\u4e2a Scale\u3002\u8fd9\u662f\u76ee\u524d Weight-only \u91cf\u5316\u7684\u6807\u914d\u3002</p> </li> <li> <p>Per-Token (Activation): \u6bcf\u4e00\u884c\uff08\u5373\u6bcf\u4e2a Token\uff09\u52a8\u6001\u8ba1\u7b97 Scale\u3002\u8fd9\u5bf9 Activation \u91cf\u5316\u81f3\u5173\u91cd\u8981\uff0c\u56e0\u4e3a Activation \u6709\u79bb\u7fa4\u503c\uff08Outliers\uff09\u3002</p> </li> <li> <p>Group-wise: \u6bd4\u5982\u6bcf 128 \u4e2a\u53c2\u6570\u5171\u7528\u4e00\u4e2a Scale\u3002\u8fd9\u662f AWQ/GPTQ \u5e38\u7528\u7684\u7b56\u7565\uff0c\u5e73\u8861\u4e86\u5143\u6570\u636e\u5f00\u9500\u548c\u7cbe\u5ea6\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#2-w4a16-vs-w8a8","title":"2. \u4e24\u5927\u6280\u672f\u8def\u7ebf\uff08W4A16 vs W8A8\uff09","text":"<p>\u5728\u63a8\u7406\u5f15\u64ce\uff08\u5982\u4f60\u7684 MiniInfer\uff09\u4e2d\uff0c\u4e3b\u8981\u6709\u4e24\u79cd\u6d41\u6d3e\uff0c\u5fc5\u987b\u5206\u6e05\u695a\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#a-weight-only-quantization-w4a16","title":"A. Weight-only Quantization (W4A16)","text":"<ul> <li> <p>\u542b\u4e49\uff1a \u6743\u91cd\u662f INT4\uff0c\u6fc0\u6d3b\u503c\uff08Input\uff09\u4f9d\u7136\u662f FP16\u3002</p> </li> <li> <p>\u76ee\u7684\uff1a \u7701\u663e\u5b58\uff08Memory Bound \u573a\u666f\uff09\uff0c\u4e3b\u8981\u7528\u4e8e\u8ba9\u5355\u5361\u8dd1\u66f4\u5927\u7684\u6a21\u578b\uff08\u5982 24G \u663e\u5b58\u8dd1 Llama-3-70B \u7684 4bit \u7248\uff09\u3002</p> </li> <li> <p>\u6838\u5fc3\u7b97\u6cd5\uff1a</p> </li> <li> <p>GPTQ: \u5229\u7528 Hessian \u77e9\u9635\u4fe1\u606f\u6765\u8c03\u6574\u6743\u91cd\u8bef\u5dee\u3002</p> </li> <li> <p>AWQ (Activation-aware Weight Quantization): \u6838\u5fc3\u6d1e\u5bdf\u662f\u201c\u53ea\u6709 1% \u7684\u6743\u91cd\u5bf9\u7cbe\u5ea6\u5f88\u91cd\u8981\u201d\uff0c\u6839\u636e Activation \u7684\u5e45\u5ea6\u6765\u4fdd\u62a4\u90a3\u4e9b\u91cd\u8981\u7684\u6743\u91cd\u3002</p> </li> <li> <p>System \u6311\u6218 (\u4f60\u7684 MiniInfer \u53ef\u4ee5\u505a\u7684)\uff1a</p> </li> <li> <p>\u8ba1\u7b97\u65f6\uff0c\u5fc5\u987b\u628a INT4 \u7684\u6743\u91cd\u5728\u5bc4\u5b58\u5668\uff08Register\uff09\u91cc\u5b9e\u65f6\u53cd\u91cf\u5316 (Dequantize) \u6210 FP16\uff0c\u7136\u540e\u518d\u505a FP16 \u7684 GEMM\u3002</p> </li> <li> <p>\u8003\u70b9\uff1a \u8fd9\u79cd\u65b9\u5f0f\u4e0d\u4e00\u5b9a\u6bd4 FP16 \u5feb\uff0c\u56e0\u4e3a\u591a\u4e86\u53cd\u91cf\u5316\u7684\u8ba1\u7b97\u5f00\u9500\u3002\u53ea\u6709\u5728 Batch Size \u5f88\u5c0f\uff08Memory Bound\uff09\u65f6\u624d\u6709\u52a0\u901f\u6bd4\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#b-weight-activation-quantization-w8a8-int8","title":"B. Weight &amp; Activation Quantization (W8A8 / INT8)","text":"<ul> <li> <p>\u542b\u4e49\uff1a \u6743\u91cd\u548c\u6fc0\u6d3b\u503c\u90fd\u662f INT8\u3002</p> </li> <li> <p>\u76ee\u7684\uff1a \u63d0\u901f\u5ea6\uff08Compute Bound \u573a\u666f\uff09\uff0c\u5229\u7528 Tensor Core \u7684 INT8 \u8ba1\u7b97\u80fd\u529b\u3002</p> </li> <li> <p>\u6838\u5fc3\u7b97\u6cd5\uff1a</p> </li> <li> <p>SmoothQuant: \u89e3\u51b3 LLM \u6fc0\u6d3b\u503c\u4e2d\u5b58\u5728\u5de8\u5927 Outlier \u7684\u95ee\u9898\u3002\u901a\u8fc7\u628a Activation \u7684\u91cf\u5316\u96be\u5ea6\u201c\u8fc1\u79fb\u201d\u4e00\u90e8\u5206\u7ed9 Weight\uff08\u6570\u5b66\u4e0a\u7684\u7b49\u4ef7\u53d8\u6362\uff09\u3002</p> </li> <li> <p>System \u6311\u6218\uff1a</p> </li> <li> <p>\u9700\u8981\u4f7f\u7528 <code>IGEMM</code> (Integer GEMM)\u3002</p> </li> <li> <p>Tensor Core \u7684 INT8 \u541e\u5410\u91cf\u662f FP16 \u7684 2 \u500d\u3002\u8fd9\u624d\u662f\u5b57\u8282 Data-AML \u8ffd\u6c42\u7684\u201c\u6781\u81f4\u7b97\u529b\u201d\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#3-seedaml","title":"3. \u524d\u6cbf\u786c\u4ef6\u7279\u6027\uff08\u5b57\u8282 Seed/AML \u5173\u6ce8\u70b9\uff09","text":"<ul> <li> <p>FP8 (Floating Point 8): H100/H800 \u7684\u6740\u624b\u950f\u3002</p> </li> <li> <p>E4M3 vs E5M2: FP8 \u6709\u4e24\u79cd\u683c\u5f0f\u3002\u901a\u5e38 Weight \u7528 E4M3\uff08\u7cbe\u5ea6\u9ad8\uff09\uff0cActivation \u7528 E5M2\uff08\u8303\u56f4\u5927\uff0c\u4e3a\u4e86\u5305\u4f4f Outliers\uff09\u6216\u8005\u4e5f\u7528 E4M3\u3002</p> </li> <li> <p>\u4f18\u52bf\uff1a \u76f8\u6bd4 INT8\uff0cFP8 \u5206\u5e03\u66f4\u7b26\u5408\u795e\u7ecf\u7f51\u7edc\u7684\u53c2\u6570\u5206\u5e03\uff0c\u8bad\u7ec3\u548c\u63a8\u7406\u90fd\u66f4\u5bb9\u6613\u6536\u655b\uff0c\u4e0d\u9700\u8981\u590d\u6742\u7684 SmoothQuant \u6280\u5de7\u3002</p> </li> <li> <p>SGLang \u73b0\u72b6\uff1a SGLang \u548c vLLM \u6b63\u5728\u5168\u9762\u8f6c\u5411 FP8 \u652f\u6301\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#4-miniinfersglang","title":"4. \u9488\u5bf9\u4f60\u7684\u9879\u76ee\uff08MiniInfer/SGLang\uff09\u7684\u5b9e\u6218\u5efa\u8bae","text":"<p>\u4e3a\u4e86\u5728\u9762\u8bd5\u4e2d\u5c55\u793a\u4f60\u61c2\u91cf\u5316\uff0c\u5efa\u8bae\u5728\u4f60\u7684\u9879\u76ee\u4e2d\u52a0\u5165\u4ee5\u4e0b\u5177\u4f53\u529f\u80fd\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#miniinfer-kv-cache","title":"\u4efb\u52a1\u4e00\uff1a\u5728 MiniInfer \u4e2d\u5b9e\u73b0 KV Cache \u91cf\u5316 (\u9ad8\u6027\u4ef7\u6bd4)","text":"<p>\u8fd9\u662f\u76ee\u524d\u5de5\u4e1a\u754c\u6700\u901a\u7528\u7684\u4f18\u5316\uff0c\u4e14\u4e0d\u6d89\u53ca\u590d\u6742\u7684\u77e9\u9635\u4e58\u6cd5\u3002</p> <ul> <li> <p>\u539f\u7406\uff1a KV Cache \u5360\u636e\u4e86\u5927\u91cf\u663e\u5b58\u3002\u5c06\u5176\u4ece FP16 \u8f6c\u4e3a INT8 \u6216 FP8 \u5b58\u50a8\u3002</p> </li> <li> <p>\u5b9e\u73b0\u6b65\u9aa4\uff1a</p> </li> </ul> <ol> <li> <p>\u5728\u5199\u5165 KV Cache \u524d\uff0c\u8ba1\u7b97 Scale\uff0c\u8f6c\u4e3a INT8\u3002</p> </li> <li> <p>\u8bfb\u53d6 KV Cache \u8fdb Attention \u8ba1\u7b97\u65f6\uff0c\u5b9e\u65f6\u8f6c\u56de FP16\u3002</p> </li> </ol> <ul> <li>\u9762\u8bd5\u52a0\u5206\u70b9\uff1a \u89e3\u91ca\u8fd9\u5982\u4f55\u589e\u52a0\u4e86\u6709\u6548 Batch Size\uff0c\u4ece\u800c\u63d0\u5347\u4e86\u541e\u5410\u91cf\u3002</li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#weight-packing","title":"\u4efb\u52a1\u4e8c\uff1a\u7406\u89e3 Weight Packing (\u4f4d\u64cd\u4f5c)","text":"<ul> <li> <p>\u5982\u679c\u4f60\u505a W4A16\uff0c\u5185\u5b58\u91cc\u600e\u4e48\u5b58 4-bit \u6570\u636e\uff1fC++ \u6ca1\u6709 <code>int4</code> \u7c7b\u578b\u3002</p> </li> <li> <p>\u505a\u6cd5\uff1a \u7528 <code>int32</code> \u5b58 8 \u4e2a 4-bit \u6570\u3002</p> </li> <li> <p>System \u96be\u70b9\uff1a CUDA Kernel \u91cc\u5982\u4f55\u9ad8\u6548\u5730\u7528\u4f4d\u8fd0\u7b97\uff08Shift, Mask\uff09\u628a\u8fd9 8 \u4e2a\u6570\u89e3\u5305\u51fa\u6765\uff1f\u8fd9\u4e5f\u662f\u9762\u8bd5\u5e38\u8003\u7684 CUDA \u7f16\u7a0b\u9898\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#smoothquant-system","title":"\u4efb\u52a1\u4e09\uff1aSmoothQuant \u7684 System \u89c6\u89d2","text":"<ul> <li> <p>\u770b\u770b SmoothQuant \u7684\u8bba\u6587\uff0c\u4e0d\u9700\u8981\u5b9e\u73b0\uff0c\u4f46\u8981\u61c2\u539f\u7406\uff1a\\(Y = (X \\\\cdot \\\\text{diag}(s)^{-1}) \\\\cdot (\\\\text{diag}(s) \\\\cdot W)\\)\u3002</p> </li> <li> <p>\u9762\u8bd5\u5b98\u95ee\uff1a\u201c\u4e3a\u4ec0\u4e48\u8bf4 SmoothQuant \u628a\u91cf\u5316\u7684\u96be\u5ea6\u4ece Activation \u8f6c\u79fb\u5230\u4e86 Weight\uff1f\u201d</p> </li> <li> <p>\u7b54\u6848\uff1a Activation \u91cc\u7684 Outlier \u5f88\u96be\u91cf\u5316\uff0c\u6240\u4ee5\u9664\u4ee5\u4e00\u4e2a\u7cfb\u6570 \\(s\\) \u628a\u5b83\u53d8\u5c0f\uff1b\u4e3a\u4e86\u4fdd\u6301\u6570\u5b66\u7b49\u4ef7\uff0cWeight \u5fc5\u987b\u4e58\u4ee5 \\(s\\)\u3002\u56e0\u4e3a Weight \u662f\u9759\u6001\u7684\uff08Offline\uff09\uff0c\u6211\u4eec\u53ef\u4ee5\u63d0\u524d\u5904\u7406\u597d\uff0c\u4e0d\u7528\u62c5\u5fc3 Weight \u53d8\u5927\u53d8\u96be\u91cf\u5316\uff0c\u4f46 Activation \u53d8\u5e73\u6ed1\u4e86\uff0c\u5c31\u53ef\u4ee5\u7528 INT8 \u505a\u4e86\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%87%8F%E5%8C%96%E7%AF%87/#_1","title":"\u603b\u7ed3\uff1a\u4f60\u9700\u8981\u51c6\u5907\u7684\u6280\u80fd\u6811","text":"<ol> <li> <p>\u57fa\u7840\uff1a \u719f\u7ec3\u5199\u51fa \\(X\\_{real} = S * X\\_{int}\\)\uff0c\u77e5\u9053 Per-channel \u548c Per-token \u7684\u533a\u522b\u3002</p> </li> <li> <p>\u7b97\u6cd5\uff08\u61c2\u539f\u7406\u5373\u53ef\uff09\uff1a \u77e5\u9053 AWQ \u4fdd\u62a4\u5173\u952e\u6743\u91cd\uff0cSmoothQuant \u5e73\u6ed1\u6fc0\u6d3b\u503c\u79bb\u7fa4\u70b9\u3002</p> </li> <li> <p>\u5de5\u7a0b\uff08\u91cd\u70b9\uff09\uff1a</p> </li> </ol> <ul> <li> <p>\u77e5\u9053 KV Cache Quantization \u662f\u600e\u4e48\u505a\u7684\u3002</p> </li> <li> <p>\u77e5\u9053 De-quantization Kernel \u662f\u5982\u4f55\u878d\u5408\u8fdb GEMM \u7684\u3002</p> </li> <li> <p>\u77e5\u9053 FP8 \u662f H800 \u65f6\u4ee3\u7684\u8d8b\u52bf\u3002</p> </li> </ul> <p>\u5982\u679c\u4f60\u80fd\u5728 MiniInfer \u91cc\u52a0\u4e0a\u4e00\u4e2a\u7b80\u5355\u7684 \"KV Cache Int8\" \u5f00\u5173\uff0c\u5e76\u6d4b\u51fa\u663e\u5b58\u8282\u7701\u4e86 50%\uff0c\u9762\u8bd5 OceanBase \u548c\u5b57\u8282\u65f6\uff0c\u8fd9\u5c06\u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u6709\u529b\u7684\u4eae\u70b9\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/","title":"\u95ee\u9898\u7bc7","text":"<p> \u7ea6 989 \u4e2a\u5b57  55 \u884c\u4ee3\u7801  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 6 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#pytorch-pin-memory","title":"Pytorch Pin Memory \u539f\u7406","text":"<p>\u53ea\u6709\u4e00\u6b65 (DMA \u62f7\u8d1d): \u5f53\u4f60\u9700\u8981\u628a\u6570\u636e\u4f20\u7ed9 GPU \u65f6\uff0c\u56e0\u4e3a\u6570\u636e\u5df2\u7ecf\u5728\u9501\u9875\u5185\u5b58\u4e2d\u4e86\uff0c\u7269\u7406\u5730\u5740\u56fa\u5b9a\u3002GPU \u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 DMA \u4ece\u8fd9\u5757\u5185\u5b58\u8bfb\u53d6\u6570\u636e\u5230\u663e\u5b58\u3002</p> <p>\u4f18\u70b9\uff1a</p> <ol> <li> <p>\u7701\u53bb\u4e86\u4e00\u6b21 CPU \u62f7\u8d1d\u3002</p> </li> <li> <p>\u5f02\u6b65\u64cd\u4f5c\uff1a \u56e0\u4e3a DMA \u72ec\u7acb\u4e8e CPU \u5de5\u4f5c\uff0cCPU \u53d1\u51fa\u201c\u4f20\u8f93\u6307\u4ee4\u201d\u540e\u5c31\u53ef\u4ee5\u7acb\u9a6c\u53bb\u5e72\u522b\u7684\u4e8b\uff08\u6bd4\u5982\u51c6\u5907\u4e0b\u4e00\u4e2a Batch \u7684\u6570\u636e\uff09\uff0c\u5b9e\u73b0\u4e86 CPU \u548c GPU \u7684\u5e76\u884c\u6d41\u6c34\u7ebf\u3002 </p> </li> </ol> <p>\u672a\u5f00\u542f Pin Memory:</p> Text Only<pre><code>[\u7528\u6237\u6570\u636e (Pageable)]  --&gt;  (CPU \u590d\u5236)  --&gt;  [\u4e34\u65f6\u7f13\u51b2\u533a (Pinned)]  --&gt;  (DMA \u590d\u5236)  --&gt;  [GPU \u663e\u5b58]\n</code></pre> <p>\u5f00\u542f Pin Memory:</p> Text Only<pre><code>[\u7528\u6237\u6570\u636e (Pinned)]  ---------------------&gt;  (DMA \u590d\u5236)  --------------------------&gt;  [GPU \u663e\u5b58]\n</code></pre>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#sglang-vllm","title":"SGLang \u548c VLLM \u7684\u54ea\u4e9b\u5730\u65b9\u6709\u5dee\u522b","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#sglang-vllm_1","title":"SGLang \u548c VLLM \u7684\u8c03\u5ea6\u54ea\u4e2a\u6bd4\u8f83\u597d","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#_1","title":"\u91cf\u5316","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#weight-only-int4fp8","title":"Weight only int4\u91cf\u5316\u548cfp8\u91cf\u5316\uff0c\u4f60\u89c9\u5f97\u4e8c\u8005\u6709\u4ec0\u4e48\u5e94\u7528\u4e0a\u7684\u533a\u522b","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#weightactivation","title":"\u4e3a\u4ec0\u4e48\u53ea\u91cf\u5316weight\uff0c\u4e0d\u91cf\u5316activation","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#_2","title":"\u52a8\u6001\u91cf\u5316\u548c\u9759\u6001\u91cf\u5316\u7684\u533a\u522b\uff1f","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#kernel","title":"Kernel","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#bank-conflict-bank-conflictcutlass","title":"\u4ec0\u4e48\u662fbank conflict\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u4ea7\u751f bank conflict\uff0c\u6709\u54ea\u4e9b\u89e3\u51b3\u65b9\u6cd5\uff1fcutlass \u4e2d\u5982\u4f55\u505a\u7684\uff1f","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#gemm-bank-conflict","title":"\u4e3a\u4ec0\u4e48 gemm \u89e3\u51b3 bank conflict \u4f7f\u7528\u8f6c\u7f6e\u5b58\u50a8\uff1f\u4e0d\u4f7f\u7528\u6709\u4ec0\u4e48\u5f71\u54cd\uff1f","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#shared-memory-gemm__syncthreads","title":"\u4e3a\u4ec0\u4e48 shared memory \u53ef\u4ee5\u4f18\u5316 gemm\uff0c\u4ec0\u4e48\u60c5\u51b5\u4e0b\u9700\u8981\u4f7f\u7528__syncthreads\u8fdb\u884c\u540c\u6b65?","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#flash-attention-hopper","title":"flash attention \u7684\u7406\u89e3\uff0chopper \u67b6\u6784\u65b0\u7279\u6027\uff1f","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#cuda-kernel","title":"\u600e\u4e48\u5b9a\u4f4d\u6027\u80fd\u70ed\u70b9\uff0c\u5bf9\u4e8ecuda kernel\u6709\u54ea\u4e9b\u4f18\u5316\u624b\u6bb5","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#c-template","title":"\u5bf9c++ template\u7684\u7406\u89e3","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#_3","title":"\u6a21\u578b\u63a8\u7406","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#llm-kvcachekvcachekvcache","title":"llm\u63a8\u7406\u4e3a\u4ec0\u4e48\u9700\u8981 kvcache\uff0c\u600e\u4e48\u8ba1\u7b97kvcache\u5927\u5c0f\uff0c\u5982\u4f55\u7ba1\u7406kvcache\uff1f","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#stable-diffusion-llm-serving","title":"stable diffusion \u6709\u54ea\u4e9b\u52a0\u901f\u7b56\u7565\uff0c\u548cllm serving\u6709\u4ec0\u4e48\u533a\u522b","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#_4","title":"\u600e\u4e48\u7406\u89e3\u5ef6\u8fdf\u4e0e\u541e\u5410\uff0c\u5728\u5177\u4f53\u4e1a\u52a1\u573a\u666f\u4e0b\u600e\u4e48\u9009\u62e9","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#moe","title":"\u4e3b\u6d41\u7684moe\u6a21\u578b\u63a8\u7406\u65f6\u901a\u8baf\u8fc7\u7a0b\u5b58\u5728\u7684\u95ee\u9898\u4ee5\u53ca\u89e3\u51b3\u529e\u6cd5?","text":"<p>I found that some errors appeared when performing tests on baseline code, used <code>FastVideo/FastWan2.1-T2V-1.3B-Diffusers</code> Model.  </p>Bash<pre><code>sglang generate --model-path=FastVideo/FastWan2.1-T2V-1.3B-Diffusers\n  --prompt='a beautiful scene' \\\n  --width=720 --height=720 \\\n  --save-output \\\n  --profile \\\n</code></pre> It is caused by <code>DmdDenoisingStage</code>. Two problems have been identified so far: <p></p> <ol> <li>weight load in <code>ComponentLoader</code></li> </ol> Bash<pre><code>Traceback (most recent call last):\n  File \"/usr/lib/python3.12/multiprocessing/process.py\", line 314, in _bootstrap\n    self.run()\n  File \"/usr/lib/python3.12/multiprocessing/process.py\", line 108, in run\n    self._target(*self._args, **self._kwargs)\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/managers/gpu_worker.py\", line 177, in run_scheduler_process\n    scheduler = Scheduler(\n                ^^^^^^^^^^\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/managers/scheduler.py\", line 59, in __init__\n    worker = GPUWorker(\n             ^^^^^^^^^^\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/managers/gpu_worker.py\", line 59, in __init__\n    self.init_device_and_model()\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/managers/gpu_worker.py\", line 88, in init_device_and_model\n    self.pipeline = build_pipeline(self.server_args)\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/pipelines_core/__init__.py\", line 50, in build_pipeline\n    pipeline = pipeline_cls(model_path, server_args)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/pipelines_core/lora_pipeline.py\", line 61, in __init__\n    super().__init__(*args, **kwargs)\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/pipelines_core/composed_pipeline_base.py\", line 95, in __init__\n    self.modules = self.load_modules(server_args, loaded_modules)\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/pipelines_core/composed_pipeline_base.py\", line 319, in load_modules\n    module = PipelineComponentLoader.load_module(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/loader/component_loader.py\", line 774, in load_module\n    raise e\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/loader/component_loader.py\", line 764, in load_module\n    return loader.load(\n           ^^^^^^^^^^^^\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/loader/component_loader.py\", line 161, in load\n    should_offload = self.should_offload(server_args)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/loader/component_loader.py\", line 123, in should_offload\n    raise NotImplementedError()\nNotImplementedError\n</code></pre> <ol> <li>After I solved this problem by simply adjusting the parameters, the next problem arose.: parameters in WanTransformer3DModel.forward() Bash<pre><code>[12-07 09:01:11] [denoising_step_0] Error during execution after 0.8526 ms: WanTransformer3DModel.forward() got an unexpected keyword argument 'guidance'\nTraceback (most recent call last):\n  File \"/sgl-workspace/sglang/python/sglang/multimodal_gen/runtime/pipelines_core/stages/denoising_dmd.py\", line 145, in forward\n    pred_noise = self.transformer(\n                 ^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py\", line 1775, in _wrapped_call_impl\n    return self._call_impl(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py\", line 1786, in _call_impl\n    return forward_call(*args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nTypeError: WanTransformer3DModel.forward() got an unexpected keyword argument 'guidance'\n</code></pre></li> </ol>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#project","title":"Project","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#miniinfer","title":"MiniInfer","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#kv-cache","title":"\u4e3a\u4ec0\u4e48 kv cache \u9884\u5148\u5206\u914d\uff1f","text":"<ul> <li>\u51cf\u5c11 OOM \u53ef\u80fd\uff0c\u5728\u521d\u59cb\u5316\u9636\u6bb5\u5c31\u66b4\u9732\u95ee\u9898\uff0c\u4fdd\u8bc1\u63a8\u7406\u670d\u52a1\u7a33\u5b9a\u6027<ul> <li>\u4e00\u6b21\u6027\u628a GPU \u4e0a\u5269\u4f59\u7684\u663e\u5b58\u5168\u90e8\uff0c\u5212\u5206\u6210\u65e0\u6570\u4e2a\u56fa\u5b9a\u5927\u5c0f\u7684\u5757\uff08Blocks\uff09\uff0c\u7528\u4e8e\u5b58\u653e KV Cache\u3002</li> </ul> </li> <li>\u51cf\u5c11\u5185\u5b58\u788e\u7247\uff0c\u53ef\u4ee5\u4e0d\u7528\u5206\u914d\u8fde\u7eed\u663e\u5b58\uff0c\u7c7b\u4f3c\u64cd\u4f5c\u7cfb\u7edf\u9875\u8868</li> <li>\u51cf\u5c11 CPU \u5f00\u9500\uff0c\u6240\u6709\u5206\u914d\u5728\u6a21\u578b\u52a0\u8f7d\u540e\u4e00\u6b21\u6027\u8c03\u7528\uff0c\u540e\u7eed\u907f\u514d\u8c03\u7528\u6602\u8d35\u7684 <code>CudaMalloc()</code></li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#2-hf_confignum_hidden_layers-confignum_kvcache_blocks-selfblock_size-num_kv_heads-head_dim","title":"\u4e3a\u4ec0\u4e48\u7528 <code>(2, hf_config.num_hidden_layers, config.num_kvcache_blocks, self.block_size, num_kv_heads, head_dim)</code> \u8fd9\u79cd\u65b9\u5f0f\u6765\u8fdb\u884c\u5206\u914d\uff1f","text":"<ul> <li>\u4f7f\u7528 <code>torch.empty()</code> \u901f\u5ea6\u6781\u5feb\uff0c\u56e0\u4e3a\u5b83\u4e0d\u521d\u59cb\u5316\uff08\u4e0d\u6e05\u96f6\uff09\u5185\u5b58\uff0c\u53ea\u662f\u5728\u663e\u5b58\u4e0a\u5212\u4e86\u4e2a\u5730\u76d8\u3002\u8fd9\u5757\u5185\u5b58\u91cc\u539f\u672c\u7684\u5783\u573e\u6570\u636e\u8fd8\u5728\uff0c\u4e4b\u540e\u5199\u5165 KV \u65f6\u4f1a\u8986\u76d6\u5b83\u3002</li> <li>\u8bfb\u53d6\u67d0\u4e2a Token \u7684 KV \u65f6\uff0c\u5b83\u7684\u6240\u6709 Head \u6570\u636e\u5728\u5185\u5b58\u4e2d\u662f\u8fde\u7eed\u7684</li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/%E9%97%AE%E9%A2%98%E7%AF%87/#pytorch-pin-memory_1","title":"pytorch \u7684 Pin Memory \u548c \u5f02\u6b65\u4f20\u8f93\uff1f","text":"<ul> <li> <p><code>pin_memory=True</code> (\u9501\u9875\u5185\u5b58):</p> <ul> <li>\u64cd\u4f5c\u7cfb\u7edf\u901a\u5e38\u4f1a\u5bf9\u5185\u5b58\u8fdb\u884c\u5206\u9875\u548c\u4ea4\u6362\uff08Swap\uff09\u3002\u5982\u679c\u5185\u5b58\u662f\u201c\u53ef\u5206\u9875\u201d\u7684\uff0cCPU \u5728\u62f7\u8d1d\u6570\u636e\u7ed9 GPU \u4e4b\u524d\uff0c\u5fc5\u987b\u5148\u628a\u5b83\u590d\u5236\u5230\u4e00\u4e2a\u4e34\u65f6\u7684\u201c\u9501\u9875\u201d\u7f13\u51b2\u533a\u3002</li> <li>\u8bbe\u7f6e <code>pin_memory=True</code> \u76f4\u63a5\u5728 CPU \u4e0a\u7533\u8bf7\u9501\u9875\u5185\u5b58\u3002\u8fd9\u6837 GPU \u7684 DMA\uff08\u76f4\u63a5\u5185\u5b58\u8bbf\u95ee\uff09\u63a7\u5236\u5668\u53ef\u4ee5\u76f4\u63a5\u8bfb\u53d6\u8fd9\u5757\u5185\u5b58\uff0c\u7701\u53bb\u4e86\u4e00\u6b21 CPU \u5185\u90e8\u7684\u62f7\u8d1d\uff0c\u5927\u5e45\u63d0\u5347\u4f20\u8f93\u5e26\u5bbd\u3002</li> </ul> </li> <li> <p><code>non_blocking=True</code> (\u5f02\u6b65\u4f20\u8f93):</p> <ul> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>.cuda()</code> \u662f\u540c\u6b65\u7684\uff0cCPU \u4f1a\u5361\u4f4f\u7b49\u5f85\u6570\u636e\u5b8c\u5168\u4f20\u5230\u663e\u5b58\u3002</li> <li>\u8bbe\u7f6e <code>non_blocking=True</code> \u540e\uff0cCPU \u53d1\u51fa\u4f20\u8f93\u6307\u4ee4\u540e\u7acb\u5373\u8fd4\u56de\uff0c\u7ee7\u7eed\u6267\u884c\u4e0b\u4e00\u884c Python \u4ee3\u7801\uff08\u6bd4\u5982\u51c6\u5907\u4e0b\u4e00\u4e2a Batch \u7684\u6570\u636e\uff09\uff0c\u800c\u4e0d\u9700\u8981\u50bb\u7b49\u6570\u636e\u4f20\u8f93\u5b8c\u6210\u3002\u8fd9\u5b9e\u73b0\u4e86 CPU \u8ba1\u7b97\u4e0e GPU \u6570\u636e\u4f20\u8f93\u7684\u6d41\u6c34\u7ebf\u91cd\u53e0\uff08Overlap\uff09\u3002</li> </ul> </li> <li>CUDA Stream \u4e0a\u7684\u4efb\u52a1\u662f\u4e25\u683c\u987a\u5e8f\u7684<ul> <li>\u867d\u7136 CPU \u53d1\u51fa\u4e86 <code>model(input_tensor)</code> \u6307\u4ee4\uff0c\u4f46\u8fd9\u4e2a\u8ba1\u7b97\u6307\u4ee4\u4f1a\u88ab\u653e\u5165\u540c\u4e00\u4e2a Stream \u961f\u5217\u3002 GPU \u4f1a\u4e25\u683c\u9075\u5b88\u961f\u5217\u987a\u5e8f\uff1a\u5fc5\u987b\u7b49\u524d\u9762\u7684\u201c\u642c\u8fd0\u6307\u4ee4\u201d\u6267\u884c\u5b8c\uff0c\u624d\u4f1a\u6267\u884c\u540e\u9762\u7684\u201c\u8ba1\u7b97\u6307\u4ee4\u201d\u3002</li> <li>\u6240\u4ee5\uff0c\u6570\u636e\u7edd\u5bf9\u662f\u5b89\u5168\u7684</li> </ul> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/","title":"\u5b57\u8282 LLM Inference","text":"<p> \u7ea6 1023 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 5 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#_1","title":"\u51c6\u5907","text":""},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#sglang-diffusion-warm-up-optimization-issue","title":"\u7b2c\u4e00\u90e8\u5206\uff1a\"SGLang Diffusion Warm-up Optimization\" Issue","text":"<p>\u7ed3\u8bba\uff1a\u8fd9\u662f\u4e00\u4e2a\u201c\u91d1\u77ff\u201d\u7ea7\u522b\u7684\u4efb\u52a1\u3002</p> <p>\u8fd9\u4e2a Issue \u5bf9\u4e24\u4e2a\u56e2\u961f\u90fd\u6709\u6781\u9ad8\u7684\u6740\u4f24\u529b\uff1a</p> <ol> <li> <p>\u5bf9 Seed \u56e2\u961f\uff08\u591a\u6a21\u6001\uff09\uff1a SGLang \u6b63\u5728\u4ece\u7eaf LLM \u6269\u5c55\u5230 Diffusion\uff08\u751f\u56fe/\u89c6\u9891\uff09\uff0c\u8fd9\u6b63\u662f Seed \u56e2\u961f\u7684\u4e3b\u6218\u573a\u3002\u4f60\u505a\u8fd9\u4e2a\uff0c\u8bc1\u660e\u4f60\u61c2 \u591a\u6a21\u6001\u63a8\u7406\u6d41\u7a0b\u3002</p> </li> <li> <p>\u5bf9 Data-AML \u56e2\u961f\uff08\u7cfb\u7edf\u4f18\u5316\uff09\uff1a Warm-up\uff08\u9884\u70ed\uff09\u7684\u6838\u5fc3\u662f CUDA Graph Capture\uff08CUDA \u56fe\u6355\u83b7\uff09 \u548c Memory Allocation\uff08\u663e\u5b58\u9884\u5206\u914d\uff09\u3002\u8fd9\u662f\u4e3a\u4e86\u6d88\u9664 First Token Latency\uff08\u9996\u5b57\u5ef6\u8fdf\uff09\u548c\u907f\u514d\u8fd0\u884c\u65f6\u6296\u52a8\u7684\u5173\u952e\u6280\u672f\u3002</p> </li> </ol> <p>\u4f60\u5e94\u8be5\u5728\u8fd9\u4e2a Issue \u4e2d\u5b66\u5230\uff08\u5e76\u80fd\u5728\u9762\u8bd5\u4e2d\u8bb2\u51fa\uff09\u7684\u4e1c\u897f\uff1a</p> <ul> <li> <p>CUDA Graphs \u539f\u7406\uff1a \u4e3a\u4ec0\u4e48 Diffusion \u6a21\u578b\u7279\u522b\u9700\u8981 CUDA Graph\uff1f\uff08\u56e0\u4e3a Diffusion \u662f\u591a\u6b65\u8fed\u4ee3\u53bb\u566a\uff0c\u5faa\u73af\u6b21\u6570\u591a\uff0cKernel Launch overhead \u6781\u5927\uff0cCUDA Graph \u53ef\u4ee5\u628a\u51e0\u767e\u4e2a Kernel \u6253\u5305\u6210\u4e00\u4e2a\uff0c\u4e00\u6b21\u53d1\u5c04\uff09\u3002</p> </li> <li> <p>Static vs Dynamic Shape\uff1a Warm-up \u5b9e\u9645\u4e0a\u662f\u5728\u56fa\u5b9a Input Shape \u7684\u60c5\u51b5\u4e0b\u9884\u5148\u8dd1\u4e00\u904d\u3002\u4f60\u9700\u8981\u7406\u89e3 SGLang \u5982\u4f55\u5904\u7406\u52a8\u6001 Shape \u548c CUDA Graph \u5bf9\u56fa\u5b9a Shape \u8981\u6c42\u7684\u51b2\u7a81\u3002</p> </li> <li> <p>\u663e\u5b58\u6c60\u5316 (Mempool)\uff1a Warm-up \u8fc7\u7a0b\u4e2d\u662f\u5426\u6d89\u53ca PyTorch \u7684\u663e\u5b58\u5206\u914d\uff1fSGLang \u662f\u5982\u4f55\u63a5\u7ba1\u8fd9\u4e9b\u663e\u5b58\u7684\uff1f</p> </li> </ul> <p>\u884c\u52a8\u5efa\u8bae\uff1a</p> <ul> <li> <p>\u5168\u529b\u4ee5\u8d74\u89e3\u51b3\u8fd9\u4e2a Issue\u3002</p> </li> <li> <p>\u8bb0\u5f55\u8fc7\u7a0b\uff1a \u8bb0\u5f55\u4e0b\u4f18\u5316\u524d\u540e\u7684 Latency \u5bf9\u6bd4\uff08\u6bd4\u5982\u9996\u56fe\u751f\u6210\u65f6\u95f4\u4ece 3s \u964d\u5230 2.5s\uff09\uff0c\u622a\u53d6 Nsight Systems \u7684\u56fe\uff0c\u5c55\u793a Kernel Launch \u4e4b\u95f4\u7684 Gap \u88ab\u6d88\u9664\u4e86\u3002\u8fd9\u76f4\u63a5\u5c31\u662f\u9762\u8bd5\u65f6\u7684 PPT \u7d20\u6750\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#data-aml-seed","title":"\u7b2c\u4e8c\u90e8\u5206\uff1a\u77e5\u8bc6\u50a8\u5907\u6e05\u5355\uff08\u9488\u5bf9 Data-AML &amp; Seed\uff09","text":"<p>\u8981\u62ff\u4e0b\u8fd9\u4e24\u4e2a\u56e2\u961f\uff0c\u4f60\u7684\u77e5\u8bc6\u4e0d\u80fd\u53ea\u505c\u7559\u5728\u201c\u4f1a\u5199\u4ee3\u7801\u201d\uff0c\u8981\u4e0a\u5347\u5230\u201c\u4f53\u7cfb\u7ed3\u6784\u201d\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#1-cuda-kernel","title":"1. CUDA \u8fdb\u9636\uff08\u76ee\u6807\uff1a\u8d85\u8d8a\u57fa\u7840 Kernel\uff09","text":"<ul> <li> <p>CUDA Graphs (\u5fc5\u8003)\uff1a \u65e2\u7136\u4f60\u5728\u505a Warm-up\uff0c\u5fc5\u987b\u5f7b\u5e95\u641e\u61c2 <code>cudaStreamBeginCapture</code> \u548c <code>cudaGraphLaunch</code>\u3002\u9762\u8bd5\u9898\uff1a\u201cCUDA Graph \u9047\u5230 CPU \u5224\u65ad\u903b\u8f91\uff08if-else\uff09\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1f\u5982\u4f55\u5904\u7406\u52a8\u6001\u63a7\u5236\u6d41\uff1f\u201d</p> </li> <li> <p>Stream &amp; Event \u5f02\u6b65\u5e76\u53d1\uff1a \u7406\u89e3\u5982\u4f55\u5229\u7528\u591a\u6d41\uff08Multi-stream\uff09\u5b9e\u73b0 Compute-Copy Overlap\uff08\u8ba1\u7b97\u4e0e\u901a\u4fe1\u91cd\u53e0\uff09\u3002</p> </li> <li> <p>Tensor Core (WMMA/MMA)\uff1a \u4e0d\u8981\u6c42\u624b\u5199\u6781\u5176\u590d\u6742\u7684 GEMM\uff0c\u4f46\u8981\u61c2 Layout\uff08<code>nwc</code> vs <code>ncw</code>\uff09\u4ee5\u53ca Fragment \u7684\u6982\u5ff5\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#2-sglang","title":"2. SGLang \u67b6\u6784\u6df1\u5ea6\uff08\u76ee\u6807\uff1a\u61c2\u8c03\u5ea6\uff09","text":"<ul> <li> <p>RadixAttention vs BlockManager\uff1a \u5f7b\u5e95\u7406\u6e05 vLLM \u7684 PagedAttention \u548c SGLang \u7684 RadixAttention \u5728\u6570\u636e\u7ed3\u6784\u4e0a\u7684\u533a\u522b\uff08Radix Tree \u4e5f\u5c31\u662f\u57fa\u6570\u6811\uff0c\u662f\u5982\u4f55\u505a\u524d\u7f00\u5339\u914d\u7684\uff09\u3002</p> </li> <li> <p>Compiler Backend\uff1a \u4e86\u89e3 SGLang \u5e95\u5c42\u662f\u5982\u4f55\u8c03\u7528 Triton \u751f\u6210\u4ee3\u7801\u7684\u3002SGLang \u4e0d\u4ec5\u4ec5\u662f\u4e00\u4e2a Runtime\uff0c\u5b83\u6709\u4e00\u5957\u7c7b\u4f3c\u7f16\u8bd1\u5668\u7684\u524d\u7aef\u8bed\u8a00\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#3-triton-compiler","title":"3. Triton \u8ba4\u77e5\uff08\u76ee\u6807\uff1a\u5b57\u8282\u975e\u5e38\u770b\u91cd Compiler\uff09","text":"<ul> <li> <p>\u4e3a\u4ec0\u4e48\u7528 Triton\uff1a \u5b83\u662f Python DSL \u5230 PTX \u7684\u6865\u6881\u3002</p> </li> <li> <p>\u5173\u952e\u6982\u5ff5\uff1a <code>tl.block</code>\uff08\u5206\u5757\u5904\u7406\uff09\uff0c<code>tl.load/store</code>\uff08\u5411\u91cf\u5316\u8bfb\u5199\uff09\u3002</p> </li> <li> <p>\u7ec3\u624b\uff1a \u8bd5\u7740\u7528 Triton \u5199\u4e00\u4e2a\u7b80\u5355\u7684 RMSNorm \u6216 Softmax\u3002\u9762\u8bd5\u65f6\u8bf4\uff1a\u201c\u6211\u53d1\u73b0\u624b\u5199 CUDA \u5f00\u53d1\u5468\u671f\u957f\uff0c\u6240\u4ee5\u6211\u4e5f\u5728\u5c1d\u8bd5\u7528 Triton \u5feb\u901f\u9a8c\u8bc1\u7b97\u5b50\u903b\u8f91\u3002\u201d\u2014\u2014\u8fd9\u53e5\u8bdd\u975e\u5e38\u8fd9\u5c31\u5f88\u7b26\u5408\u5b57\u8282\u201c\u52a1\u5b9e/\u6548\u7387\u201d\u7684\u4ef7\u503c\u89c2\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#miniinfer-project-portfolio","title":"\u7b2c\u4e09\u90e8\u5206\uff1aMiniInfer \u5347\u7ea7\u6307\u5357\uff08Project Portfolio\uff09","text":"<p>\u4e3a\u4e86\u914d\u5408\u8fd9\u4e2a Issue\uff0c\u4f60\u7684 MiniInfer \u9879\u76ee\u9700\u8981\u6dfb\u52a0 1-2 \u4e2a\u201c\u9ad8\u5927\u4e0a\u201d\u7684\u529f\u80fd\uff0c\u8ba9\u5b83\u770b\u8d77\u6765\u50cf\u4e00\u4e2a\u5fae\u7f29\u7248\u7684\u5de5\u4e1a\u7ea7\u5f15\u64ce\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#1-cuda-graph","title":"\u529f\u80fd 1\uff1a\u96c6\u6210 CUDA Graph \u652f\u6301 (\u4f18\u5148\u7ea7\uff1a\u6700\u9ad8)","text":"<ul> <li> <p>\u7406\u7531\uff1a \u5b8c\u7f8e\u914d\u5408\u4f60\u6b63\u5728\u4fee\u7684 SGLang Issue\u3002</p> </li> <li> <p>\u600e\u4e48\u505a\uff1a \u5728 MiniInfer \u7684 Decoding \u9636\u6bb5\uff08\u56e0\u4e3a Decoding \u9636\u6bb5 Shape \u56fa\u5b9a\uff09\uff0c\u5f15\u5165 <code>cudaGraph</code> \u673a\u5236\u3002</p> </li> <li> <p>\u9762\u8bd5\u8bdd\u672f\uff1a \u201c\u6211\u5728\u4fee\u590d SGLang Diffusion Warm-up \u7684\u8fc7\u7a0b\u4e2d\u6df1\u523b\u4f53\u4f1a\u5230\u4e86 Kernel Launch Overhead \u7684\u5f71\u54cd\uff0c\u6240\u4ee5\u6211\u987a\u624b\u628a CUDA Graph \u590d\u523b\u5230\u4e86\u6211\u7684 MiniInfer \u4e2d\uff0c\u5b9e\u6d4b decoding \u901f\u5ea6\u63d0\u5347\u4e86 20%\u3002\u201d \u2014\u2014 \u7edd\u6740\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#2-pytorchtriton","title":"\u529f\u80fd 2\uff1a\u5f15\u5165\u7b80\u5355\u7684 PyTorch/Triton \u7b97\u5b50\u6df7\u5408\u8c03\u7528","text":"<ul> <li> <p>\u7406\u7531\uff1a \u5b57\u8282 JD \u91cc\u63d0\u5230\u4e86\u201c\u5f02\u6784\u201d\u548c\u201cTriton\u201d\u3002</p> </li> <li> <p>\u600e\u4e48\u505a\uff1a \u5728 C++ \u5de5\u7a0b\u91cc\uff0c\u5c1d\u8bd5\u901a\u8fc7 <code>libtorch</code> \u6216\u8005 Python C API\uff0c\u8c03\u7528\u4e00\u4e2a\u7528 Triton \u5199\u7684\u7b97\u5b50\uff08\u6bd4\u5982 LayerNorm\uff09\u3002</p> </li> <li> <p>\u76ee\u7684\uff1a \u8bc1\u660e\u4f60\u61c2 Hybrid Backend\uff08\u6df7\u5408\u540e\u7aef\uff09 \u67b6\u6784\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E5%AD%97%E8%8A%82%20LLM%20Inference/#3kv-cache-int8fp8","title":"\u529f\u80fd 3\uff1aKV Cache \u7684\u91cf\u5316 (Int8/FP8)","text":"<ul> <li> <p>\u7406\u7531\uff1a Data-AML \u6781\u5176\u770b\u91cd\u663e\u5b58\u6548\u7387\u3002</p> </li> <li> <p>\u600e\u4e48\u505a\uff1a \u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684 Int8 KV Cache \u5b58\u50a8\u3002\u5373\u5728\u4fdd\u5b58 <code>K</code> \u548c <code>V</code> \u65f6\u5c06\u5176 cast \u6210 <code>int8</code>\uff0c\u8bfb\u53d6\u65f6 cast \u56de <code>fp16</code>\u3002</p> </li> <li> <p>\u76ee\u7684\uff1a \u8bc1\u660e\u4f60\u61c2\u91cf\u5316\u5bf9\u7cbe\u5ea6\u7684\u5f71\u54cd\u4ee5\u53ca\u663e\u5b58\u5e26\u5bbd\u7684\u8282\u7701\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/","title":"\u8682\u8681 LLM Inference","text":"<p> \u7ea6 1820 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 9 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#jd","title":"JD","text":"<p>\u804c\u4f4d\u63cf\u8ff0</p> <p>\u4f60\u5c06\u4e0eOB\u7684\u8d44\u6df1\u5de5\u7a0b\u5e08\u7d27\u5bc6\u5408\u4f5c\uff0c\u53c2\u4e0e\u81ea\u7814LLM\u63a8\u7406\u6846\u67b6\u7684\u7814\u53d1\uff0c\u901a\u8fc7\u5b66\u4e60\u5f00\u6e90\u793e\u533a\u4f18\u79c0\u5b9e\u8df5\uff0c\u7ed3\u5408\u5de5\u7a0b\u521b\u65b0\uff0c\u6253\u9020\u5177\u6709\u6781\u81f4\u6027\u4ef7\u6bd4\u7684\u4e0b\u4e00\u4ee3LLM\u63a8\u7406\u7cfb\u7edf\u3002 \u4f5c\u4e3a\u5b9e\u4e60\u751f\uff0c\u4f60\u53ef\u4ee5\u76f4\u9762\u5de5\u4e1a\u7ea7AI\u7cfb\u7edf\u7684\u771f\u5b9e\u6311\u6218\uff0c\u5728\u5e08\u5144\u7684\u6307\u5bfc\u4e0b\uff0c\u4f60\u53ef\u4ee5\u5b8c\u6574\u7ecf\u5386\u4ece\u6280\u672f\u8c03\u7814\u3001\u65b9\u6848\u8bbe\u8ba1\u3001\u4ee3\u7801\u5b9e\u73b0\u5230\u6548\u679c\u9a8c\u8bc1\u7684\u5168\u7814\u53d1\u6d41\u7a0b\uff0c\u79ef\u7d2f\u9876\u5c16\u4f01\u4e1a\u7ea7\u9879\u76ee\u7ecf\u9a8c\uff0c\u540c\u65f6\u7cfb\u7edf\u638c\u63e1LLM\u63a8\u7406\u4f18\u5316\u7684\u65b9\u6cd5\u8bba\u4e0e\u6280\u672f\u4f53\u7cfb\u3002 \u4f60\u7684\u4f18\u79c0\u6210\u679c\u5c06\u76f4\u63a5\u6574\u5408\u8fdbOceanBase\u667a\u80fd\u8ba1\u7b97\u5f15\u64ce\uff0c\u670d\u52a1\u4ebf\u7ea7\u7528\u6237\u573a\u666f\u3002</p> <p>\u804c\u4f4d\u8981\u6c42</p> <ol> <li>\u63a8\u7406\u6846\u67b6\u5168\u94fe\u8def\u4f18\u5316: \u5305\u62ec\u4f46\u4e0d\u9650\u4e8e\u5e38\u89c4\u7684\u91cf\u5316\uff0cspeculative decoding\uff0cDP\uff0cEP\u7b49\u5f00\u6e90\u793e\u533a\u5df2\u91c7\u7eb3\u7684\u6700\u4f18\u5b9e\u8df5\uff0c\u4e5f\u8981\u63a2\u7d22\u901a\u4fe1\u4f18\u5316\uff0ckv cache offload\uff0c\u8ba1\u7b97/\u901a\u4fe1overlap\u7b49\u65b0\u7684\u4f18\u5316\u673a\u4f1a\u3002</li> <li>\u5f02\u6784\u8ba1\u7b97\u63a2\u7d22: \u5728PC/\u4e00\u4f53\u673a\u7b49\u771f\u5b9e\u573a\u666f\u4e2d\uff0c\u63a2\u7d22CPU+GPU\u6df7\u5408\u8ba1\u7b97\u7684\u6700\u4f73\u5b9e\u8df5\u3002\u901a\u8fc7\u667a\u80fd\u8c03\u5ea6\u4e0e\u5e76\u884c\u7b56\u7565\u8bbe\u8ba1\uff0c\u8ba9\u6bcf\u4e00\u4efd\u8ba1\u7b97\u8d44\u6e90\u90fd\u53d1\u6325\u6700\u5927\u4ef7\u503c\u3002</li> <li>\u957f\u4e0a\u4e0b\u6587\u4f18\u5316: \u7814\u7a76KV Cache\u538b\u7f29/\u8fc7\u6ee4/\u6301\u4e45\u5316\u7b49\u524d\u6cbf\u6280\u672f\uff0c\u7834\u89e3\u957f\u4e0a\u4e0b\u6587\u63a8\u7406\u6210\u672c\u96be\u9898\u3002\u5728\u8fd9\u91cc\uff0c\u4f60\u5c06\u4eb2\u624b\u4f18\u5316\u5904\u7406\u8d85\u957f\u6587\u672c\u7684\u5de5\u4e1a\u7ea7\u89e3\u51b3\u65b9\u6848\u3002</li> <li>\u53ea\u8981\u4f60\u719f\u6089PyTorch\u6846\u67b6\u6216CUDA\u7f16\u7a0b\u57fa\u7840\uff0c\u5bf9\u5e95\u5c42\u4f18\u5316\u6709\u5f3a\u70c8\u597d\u5947\u5fc3\uff0c\u63a5\u89e6\u8fc7Transformer\u67b6\u6784\u4f18\u5316\u5373\u53ef\uff0c\u6211\u4eec\u4f1a\u63d0\u4f9b\u7cfb\u7edf\u5316\u6307\u5bfc\u3002\u5f53\u7136\u5982\u679c\u4f60\u7814\u7a76\u8fc7vLLM/SGLang/ktransformer\u7b49\u5f00\u6e90\u9879\u76ee\u80fd\u66f4\u5feb\u4e0a\u624b\u3002</li> </ol>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#_1","title":"\u51c6\u5907","text":"<p>\u8fd9\u4efd\u804c\u4f4d\u63cf\u8ff0\uff08JD\uff09\u542b\u91d1\u91cf\u6781\u9ad8\uff0c\u6765\u81ea\u4e8e OceanBase\uff08\u8682\u8681\u96c6\u56e2\u65d7\u4e0b\u7684\u4f01\u4e1a\u7ea7\u5206\u5e03\u5f0f\u6570\u636e\u5e93\uff09 \u7684AI\u56e2\u961f\u3002\u4ece\u63cf\u8ff0\u6765\u770b\uff0c\u4ed6\u4eec\u6b63\u5728\u81ea\u7814\u6216\u6df1\u5ea6\u9b54\u6539\u4e00\u5957LLM\u63a8\u7406\u5f15\u64ce\uff0c\u76ee\u7684\u662f\u4e3a\u4e86\u5728\u201c\u7aef\u4fa7\u201d\uff08\u4e00\u4f53\u673a/PC\uff09\u6216\u201c\u79c1\u6709\u5316\u90e8\u7f72\u201d\u573a\u666f\u4e0b\uff0c\u4ee5\u6781\u4f4e\u6210\u672c\u8fd0\u884c\u5927\u6a21\u578b\u3002</p> <p>\u6839\u636e\u4f60\u4e4b\u524d\u7684\u5bf9\u8bdd\u8bb0\u5f55\uff08\u7279\u522b\u662f\u4f60\u6b63\u5728\u5f00\u53d1\u7684 MiniInfer \u9879\u76ee\u3001\u5bf9 SGLang \u7684\u94bb\u7814\uff0c\u4ee5\u53ca\u4f60\u4f5c\u4e3a\u8ba1\u7b97\u673a\u7814\u7a76\u751f\u7684\u80cc\u666f\uff09\uff0c\u8fd9\u4e2a\u804c\u4f4d\u51e0\u4e4e\u662f\u4e3a\u4f60\u91cf\u8eab\u5b9a\u505a\u7684\u3002\u4f60\u76ee\u524d\u7684\u6280\u80fd\u6808\u4e0e\u4ed6\u4eec\u7684\u9700\u6c42\u91cd\u5408\u5ea6\u6781\u9ad8\u3002</p> <p>\u4e3a\u4e86\u786e\u4fdd\u4e07\u65e0\u4e00\u5931\uff0c\u62ff\u4e0b\u8fd9\u4e2aOffer\uff0c\u4f60\u9700\u8981\u4ece\u4ee5\u4e0b\u51e0\u4e2a\u7ef4\u5ea6\u6574\u7406\u4f60\u7684\u77e5\u8bc6\u50a8\u5907\u548c\u9879\u76ee\u7ecf\u5386\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#1-jd","title":"1. \u6838\u5fc3\u77e5\u8bc6\u50a8\u5907\uff08\u9488\u5bf9JD\u9010\u6761\u62c6\u89e3\uff09","text":"<p>\u4f60\u9700\u8981\u5c55\u793a\u51fa\u201c\u4e0d\u4ec5\u4f1a\u7528\uff0c\u800c\u4e14\u61c2\u5e95\u5c42\u539f\u7406\u201d\u7684\u80fd\u529b\u3002</p> <ul> <li> <p>\u57fa\u7840\u67b6\u6784\u4e0e\u6570\u5b66\u539f\u7406\uff1a</p> </li> <li> <p>Transformer \u6df1\u5ea6\u5256\u6790\uff1a \u5fc5\u987b\u80fd\u5f92\u624b\u63a8\u5bfc Self-Attention \u516c\u5f0f\uff0c\u6e05\u695a Multi-head Attention \u4e0e Multi-query Attention (MQA/GQA) \u7684\u533a\u522b\uff08\u8fd9\u4e00\u70b9\u5728\u663e\u5b58\u5e26\u5bbd\u4f18\u5316\u4e2d\u6781\u5176\u91cd\u8981\uff09\u3002</p> </li> <li> <p>\u4f4d\u7f6e\u7f16\u7801\uff1a \u5f7b\u5e95\u7406\u89e3 RoPE\uff08\u65cb\u8f6c\u4f4d\u7f6e\u7f16\u7801\uff09\u7684\u6570\u5b66\u539f\u7406\u53ca\u5176\u4ee3\u7801\u5b9e\u73b0\uff08\u65e2\u7136\u4f60MiniInfer\u91cc\u5199\u8fc7\uff0c\u9762\u8bd5\u65f6\u8981\u80fd\u8bb2\u6e05\u695a\u5b83\u662f\u5982\u4f55\u5904\u7406\u957f\u6587\u672c\u5916\u63a8\u7684\uff09\u3002</p> </li> <li> <p>\u63a8\u7406\u4f18\u5316\u6838\u5fc3\u6280\u672f (JD\u91cd\u70b9)\uff1a</p> </li> <li> <p>\u663e\u5b58\u7ba1\u7406 (KV Cache)\uff1a \u4f60\u5fc5\u987b\u7cbe\u901a PagedAttention (vLLM\u7684\u6838\u5fc3) \u7684\u539f\u7406\u3002\u7406\u89e3 Block table \u5982\u4f55\u89e3\u51b3\u663e\u5b58\u788e\u7247\u5316\u95ee\u9898\u3002</p> </li> <li> <p>\u8c03\u5ea6\u7b56\u7565\uff1a \u6df1\u523b\u7406\u89e3 Continuous Batching (Orca)\u3002\u8981\u80fd\u5bf9\u6bd4 Static Batching \u548c Continuous Batching \u7684\u541e\u5410\u91cf\u5dee\u5f02\u3002</p> </li> <li> <p>\u91cf\u5316 (Quantization)\uff1a JD\u63d0\u5230\u4e86\u201c\u5e38\u89c4\u91cf\u5316\u201d\u3002\u4f60\u9700\u8981\u4e86\u89e3 W4A16\uff08\u6743\u91cd4bit\uff0c\u6fc0\u6d3b16bit\uff09\u3001AWQ\u3001GPTQ \u6216 SmoothQuant \u7684\u57fa\u672c\u539f\u7406\u3002\u5982\u679c\u8fd8\u6ca1\u770b\u8fc7\uff0c\u91cd\u70b9\u8865\u4e00\u4e0b AWQ \u7684\u8bba\u6587\u3002</p> </li> <li> <p>\u6295\u673a\u91c7\u6837 (Speculative Decoding)\uff1a \u7406\u89e3 Draft model \u673a\u5236\uff0c\u77e5\u9053\u5b83\u662f\u5982\u4f55\u7528\u201c\u5c0f\u6a21\u578b\u9884\u6d4b+\u5927\u6a21\u578b\u9a8c\u8bc1\u201d\u6765\u6362\u53d6\u65f6\u95f4\u7684\u3002</p> </li> <li> <p>\u5f02\u6784\u8ba1\u7b97\u4e0e\u5e95\u5c42\u7f16\u7a0b (JD\u7279\u8272)\uff1a</p> </li> <li> <p>CUDA \u7f16\u7a0b\uff1a \u4e0d\u9700\u8981\u4f60\u662fCUDA\u4e13\u5bb6\uff0c\u4f46\u8981\u61c2 Kernel fusion\uff08\u7b97\u5b50\u878d\u5408\uff09\uff0c\u7406\u89e3 GPU Memory Hierarchy (HBM vs SRAM)\u3002</p> </li> <li> <p>CPU+GPU \u6df7\u5408\u63a8\u7406 (\u5173\u952e\u70b9)\uff1a JD \u63d0\u5230\u4e86 <code>ktransformers</code>\uff0c\u8fd9\u662f\u4e00\u4e2a\u5229\u7528 CPU \u5185\u5b58\u627f\u8f7d KV Cache \u6216\u90e8\u5206\u6743\u91cd\u7684\u9879\u76ee\u3002\u4f60\u9700\u8981\u4e86\u89e3 KV Cache Offloading \u6280\u672f\uff08\u4f55\u65f6\u628a KV \u642c\u5230 CPU\uff0c\u4f55\u65f6\u642c\u56de GPU\uff0c\u5982\u4f55\u63a9\u76d6 PCIe \u4f20\u8f93\u5ef6\u8fdf\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#2","title":"2. \u9488\u5bf9\u6027\u9879\u76ee\u7ecf\u5386\uff08\u5982\u4f55\u5305\u88c5\u4f60\u73b0\u6709\u7684\u9879\u76ee\uff09","text":"<p>\u8fd9\u90e8\u5206\u662f\u4f60\u7684\u6740\u624b\u950f\u3002\u4e0d\u8981\u53ea\u7f57\u5217\u9879\u76ee\uff0c\u8981\u9488\u5bf9\u4ed6\u4eec\u7684\u75db\u70b9\u6765\u63cf\u8ff0\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#miniinfer","title":"\u9879\u76ee\u4e00\uff1a\u4ece\u96f6\u6784\u5efa\u8f7b\u91cf\u7ea7\u63a8\u7406\u5f15\u64ce (\u57fa\u4e8e\u4f60\u7684 MiniInfer)","text":"<ul> <li> <p>\u5bf9\u6807JD\u8981\u6c42\uff1a \u201c\u5bf9\u5e95\u5c42\u4f18\u5316\u6709\u5f3a\u70c8\u597d\u5947\u5fc3\u201d\u3001\u201c\u63a5\u89e6\u8fc7 Transformer \u67b6\u6784\u4f18\u5316\u201d\u3002</p> </li> <li> <p>\u7b80\u5386/\u9762\u8bd5\u8bdd\u672f\uff1a</p> </li> <li> <p>\u5f3a\u8c03\u4f60\u662f\u4ece\u96f6 (Scratch) \u624b\u5199\u7684\u63a8\u7406\u5f15\u64ce\uff0c\u800c\u4e0d\u662f\u8c03\u5305\u3002</p> </li> <li> <p>\u91cd\u70b9\u63cf\u8ff0\u4f60\u5982\u4f55\u7528 C++/CUDA \u5b9e\u73b0\u4e86 RoPE \u7b97\u5b50\u3002</p> </li> <li> <p>\u63cf\u8ff0\u4f60\u5b9e\u73b0\u7684 Continuous Batching \u8c03\u5ea6\u903b\u8f91\uff0c\u4ee5\u53ca\u5b83\u662f\u5982\u4f55\u63d0\u5347 GPU \u5229\u7528\u7387\u7684\u3002</p> </li> <li> <p>\u52a0\u5206\u9879\uff1a \u63d0\u5230\u4f60\u5728\u5f00\u53d1\u8fc7\u7a0b\u4e2d\u9047\u5230\u7684\u5177\u4f53\u56f0\u96be\uff08\u4f8b\u5982\uff1aMask\u5904\u7406\u3001Tensor\u5f62\u72b6\u5bf9\u9f50\uff09\uff0c\u4ee5\u53ca\u4f60\u662f\u5982\u4f55 Debug \u7684\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#sglangvllm","title":"\u9879\u76ee\u4e8c\uff1a\u5f00\u6e90\u793e\u533a\u8d21\u732e\u4e0e\u6e90\u7801\u5206\u6790 (\u57fa\u4e8e\u4f60\u7684 SGLang/vLLM \u8ba1\u5212)","text":"<ul> <li> <p>\u5bf9\u6807JD\u8981\u6c42\uff1a \u201c\u719f\u6089 vLLM/SGLang \u7b49\u5f00\u6e90\u9879\u76ee\u201d\u3001\u201c\u5b66\u4e60\u5f00\u6e90\u793e\u533a\u4f18\u79c0\u5b9e\u8df5\u201d\u3002</p> </li> <li> <p>\u7b80\u5386/\u9762\u8bd5\u8bdd\u672f\uff1a</p> </li> <li> <p>\u4e0d\u8981\u53ea\u8bf4\u201c\u770b\u8fc7\u6e90\u7801\u201d\uff0c\u8981\u8bf4\u201c\u5206\u6790\u8fc7 SGLang \u7684 RadixAttention \u5b9e\u73b0\u673a\u5236\u201d\u3002</p> </li> <li> <p>\u5982\u679c\u4f60\u5df2\u7ecf\u6309\u7167\u4e4b\u524d\u7684\u8ba1\u5212\u5f00\u59cb\u9605\u8bfb SGLang \u6e90\u7801\uff0c\u53ef\u4ee5\u5177\u4f53\u8c08\u8c08\u5b83\u662f\u5982\u4f55\u5229\u7528 Prefix Caching \u6765\u4f18\u5316\u591a\u8f6e\u5bf9\u8bdd\u6216 System Prompt \u7684\u3002\u8fd9\u76f4\u63a5\u5bf9\u5e94 JD \u91cc\u7684\u201c\u957f\u4e0a\u4e0b\u6587\u4f18\u5316\u201d\u548c\u201cKV Cache\u8fc7\u6ee4\u201d\u3002</p> </li> <li> <p>\u63d0\u5230\u4f60\u5bf9 Chunked Prefill \u7684\u7406\u89e3\uff08\u89e3\u51b3\u9996\u5b57\u5ef6\u8fdf\u4e0e\u541e\u5410\u91cf\u7684\u6743\u8861\uff09\uff0c\u8fd9\u662f\u76ee\u524d\u975e\u5e38\u524d\u6cbf\u7684\u4f18\u5316\u70b9\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#nebulagraph","title":"\u9879\u76ee\u4e09\uff1a\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e0e\u5b58\u50a8\u7ecf\u9a8c (\u57fa\u4e8e\u4f60\u7684 NebulaGraph \u7ecf\u5386)","text":"<ul> <li> <p>\u5bf9\u6807JD\u8981\u6c42\uff1a OceanBase \u662f\u4e00\u5bb6\u6570\u636e\u5e93\u516c\u53f8\u3002</p> </li> <li> <p>\u9690\u85cf\u4f18\u52bf (Hidden Gem)\uff1a</p> </li> <li> <p>\u867d\u7136\u8fd9\u662f\u4e00\u4e2aAI\u5c97\u4f4d\uff0c\u4f46\u9762\u8bd5\u5b98\u6781\u5927\u6982\u7387\u662f OB \u7684\u8d44\u6df1\u5de5\u7a0b\u5e08\uff0c\u4ed6\u4eec\u975e\u5e38\u770b\u91cd\u7cfb\u7edf\u7a33\u5b9a\u6027\u548cC++\u5de5\u7a0b\u80fd\u529b\u3002</p> </li> <li> <p>\u5229\u7528\u4f60\u5728 NebulaGraph \u7684\u7ecf\u5386\uff0c\u5f3a\u8c03\u4f60\u5bf9 C++ \u5185\u5b58\u7ba1\u7406\u3001\u9ad8\u5e76\u53d1\u7cfb\u7edf\u8bbe\u8ba1 \u4ee5\u53ca Raft \u534f\u8bae \u7684\u7406\u89e3\u3002\u8fd9\u4f1a\u7ed9\u9762\u8bd5\u5b98\u4e00\u79cd\u201c\u5373\u4f7f\u4e0d\u61c2AI\uff0c\u4f60\u7684\u5de5\u7a0b\u5e95\u5b50\u4e5f\u8db3\u591f\u597d\u201d\u7684\u5b89\u5168\u611f\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#3","title":"3. \u67e5\u6f0f\u8865\u7f3a\uff08\u73b0\u5728\u7684\u884c\u52a8\u6307\u5357\uff09","text":"<p>\u4e3a\u4e86\u5b8c\u7f8e\u5339\u914d\u8fd9\u4e2a JD\uff0c\u5efa\u8bae\u4f60\u63a5\u4e0b\u6765\u4e00\u5468\u91cd\u70b9\u7a81\u51fb\u4ee5\u4e0b\u4e24\u4e2a\u76f2\u533a\uff1a</p> <ol> <li>\u7814\u7a76 <code>ktransformers</code> \u6216 <code>llama.cpp</code>\uff1a</li> </ol> <ul> <li> <p>JD \u7279\u522b\u63d0\u5230\u4e86\u5f02\u6784\u8ba1\u7b97\u3002\u53bb\u770b\u4e00\u4e0b <code>llama.cpp</code> \u662f\u5982\u4f55\u628a\u5c42\u5207\u5206\u5230 CPU \u548c GPU \u4e0a\u7684\uff08<code>--n-gpu-layers</code> \u53c2\u6570\u80cc\u540e\u7684\u903b\u8f91\uff09\u3002</p> </li> <li> <p>\u601d\u8003\uff1a\u5982\u679c GPU \u663e\u5b58\u4e0d\u591f\uff0c\u5982\u4f55\u628a KV Cache \u653e\u5728 CPU \u4e3b\u5b58\u91cc\uff0c\u5e76\u5728\u8ba1\u7b97 Attention \u65f6\u901a\u8fc7 PCIe \u5feb\u901f\u8bfb\u53d6\uff1f</p> </li> </ul> <ol> <li>\u4e86\u89e3\u957f\u6587\u672c\u4f18\u5316\uff1a</li> </ol> <ul> <li> <p>\u641c\u7d22\u5173\u952e\u8bcd\uff1aStreamingLLM (Sink token), Ring Attention (\u867d\u7136\u5b9e\u4e60\u751f\u672a\u5fc5\u9700\u8981\u5b9e\u73b0\uff0c\u4f46\u8981\u77e5\u9053\u6982\u5ff5)\u3002</p> </li> <li> <p>JD \u63d0\u5230\u7684\u201cKV Cache \u538b\u7f29/\u6301\u4e45\u5316\u201d\uff0c\u672c\u8d28\u4e0a\u662f\u5728\u89e3\u51b3 RAG\uff08\u68c0\u7d22\u589e\u5f3a\u751f\u6210\uff09\u573a\u666f\u4e0b\u7684\u4e0a\u4e0b\u6587\u91cd\u7528\u95ee\u9898\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E8%9A%82%E8%9A%81%20LLM%20Inference/#4","title":"4. \u6a21\u62df\u9762\u8bd5\u95ee\u9898\uff08\u81ea\u6d4b\uff09","text":"<p>\u5728\u9762\u8bd5\u524d\uff0c\u8bd5\u7740\u56de\u7b54\u8fd9\u51e0\u4e2a\u95ee\u9898\uff1a</p> <ol> <li> <p>\u201c\u5728\u4f60\u7684 MiniInfer \u4e2d\uff0c\u5982\u679c Batch Size \u53d8\u5927\uff0c\u54ea\u4e2a\u7b97\u5b50\u4f1a\u901a\u8fc7 Roofline Model \u5206\u6790\u6210\u4e3a\u74f6\u9888\uff1f\u662f Compute-bound \u8fd8\u662f Memory-bound\uff1f\u201d</p> </li> <li> <p>\u201cSGLang \u76f8\u6bd4 vLLM\uff0c\u6700\u5927\u7684\u6539\u8fdb\u70b9\u5728\u54ea\u91cc\uff1fRadixAttention \u662f\u5982\u4f55\u590d\u7528 KV Cache \u7684\uff1f\u201d</p> </li> <li> <p>\u201c\u5982\u679c\u6211\u4eec\u8981\u5728\u663e\u5b58\u53ea\u6709 24GB \u7684\u673a\u5668\u4e0a\u8dd1 70B \u7684\u6a21\u578b\uff08\u6743\u91cd\u7ea6 140GB\uff09\uff0c\u4f60\u6709\u4ec0\u4e48\u6280\u672f\u65b9\u6848\uff1f\u201d \uff08\u7b54\u6848\u65b9\u5411\uff1a4-bit\u91cf\u5316 + \u9010\u5c42\u52a0\u8f7d/CPU Offload\uff09\u3002</p> </li> </ol>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/","title":"\u9636\u8dc3\u661f\u8fb0 LLM Inference","text":"<p> \u7ea6 1647 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 8 \u5206\u949f</p> 2025-12-132025-12-13"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#_1","title":"\u804c\u4f4d\u63cf\u8ff0","text":"<p>\u5c97\u4f4d\u63cf\u8ff0</p> <ol> <li>\u53c2\u4e0e\u5206\u5e03\u5f0f\u5927\u6a21\u578b\u63a8\u7406\u6846\u67b6\u7684\u5f00\u53d1\u4e0e\u4f18\u5316\uff0c\u63d0\u5347\u63a8\u7406\u6027\u80fd\u4e0e\u541e\u5410\u91cf\uff1b</li> <li>\u9488\u5bf9\u4e0d\u540c\u573a\u666f\u7684 LLM \u8bf7\u6c42\u7279\u70b9\uff0c\u4f18\u5316 GPU \u8ba1\u7b97\u6d41\u7a0b\uff0c\u6253\u9020\u4e1a\u5185\u9886\u5148\u7684\u9ad8\u6548 LLM \u63a8\u7406\u5f15\u64ce\uff1b</li> <li>\u8c03\u7814\u5e76\u5f15\u5165\u524d\u6cbf\u673a\u5668\u5b66\u4e60\u7cfb\u7edf\u6280\u672f\uff0c\u63a8\u52a8\u7cfb\u7edf\u67b6\u6784\u7684\u6301\u7eed\u4f18\u5316\u5347\u7ea7\uff1b</li> <li>\u4e0e\u7b97\u6cd5\u56e2\u961f\u6df1\u5ea6\u5408\u4f5c\uff0c\u63a2\u7d22\u7b97\u6cd5-\u7cfb\u7edf\u534f\u540c\u4f18\u5316\u65b9\u6848\uff0c\u63d0\u5347\u6574\u4f53\u63a8\u7406\u6548\u7387\u3002</li> </ol> <p>\u4efb\u804c\u8981\u6c42</p> <ol> <li>\u8ba1\u7b97\u673a\u3001\u7535\u5b50\u3001\u81ea\u52a8\u5316\u3001\u8f6f\u4ef6\u7b49\u76f8\u5173\u4e13\u4e1a\uff0c\u672c\u79d1\u53ca\u4ee5\u4e0a\u5728\u8bfb\uff0c\u80fd\u5b9e\u4e60 6 \u4e2a\u6708\u4ee5\u4e0a\u4f18\u5148\uff1b</li> <li>\u5177\u5907\u64cd\u4f5c\u7cfb\u7edf\u3001\u8ba1\u7b97\u673a\u4f53\u7cfb\u7ed3\u6784\u7b49\u57fa\u7840\u77e5\u8bc6\uff0c\u5bf9\u5e95\u5c42\u6027\u80fd\u4f18\u5316\u6709\u6d53\u539a\u5174\u8da3\uff1b</li> <li>\u719f\u6089SGLang\u3001vLLM\u3001Megatron \u7b49\u6846\u67b6\uff0c\u6709\u5f00\u6e90\u9879\u76ee\u8d21\u732e\u6216\u76f8\u5173\u7ecf\u9a8c\u8005\u4f18\u5148\uff1b</li> <li>\u719f\u6089CUDA\u7f16\u7a0b\u548cGPU\u4e0a\u6027\u80fd\u4f18\u5316\uff0c\u6709Triton\u3001CUTLASS\u7b49\u5f00\u53d1\u7ecf\u9a8c\u8005\u4f18\u5148\uff1b</li> <li>\u5177\u5907\u826f\u597d\u7684\u6c9f\u901a\u80fd\u529b\u548c\u56e2\u961f\u534f\u4f5c\u7cbe\u795e\u3002    \u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u786c\u6838\u4e14\u6781\u5177\u524d\u666f\u7684\u5c97\u4f4d\uff0c\u65b9\u5411\u662f\u5927\u6a21\u578b\u63a8\u7406\u7cfb\u7edf\u7684\u5e95\u5c42\u4f18\u5316\u3002</li> </ol>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#_2","title":"\u51c6\u5907","text":"<p>\u57fa\u4e8e\u4f60\u76ee\u524d\u7684\u80cc\u666f\u2014\u2014CS\u7814\u7a76\u751f\u3001\u6b63\u5728\u5f00\u53d1MiniInfer\uff08C++\u81ea\u7814\u63a8\u7406\u5f15\u64ce\uff09\u3001\u6df1\u5ea6\u7814\u7a76SGLang/vLLM\u6e90\u7801\u3001\u4e14\u6709NebulaGraph\u7684C++\u7cfb\u7edf\u5f00\u53d1\u7ecf\u9a8c\u2014\u2014\u4f60\u51e0\u4e4e\u5b8c\u7f8e\u5951\u5408\u8fd9\u4e2a\u5c97\u4f4d\u7684\u6838\u5fc3\u8981\u6c42\u3002\u7279\u522b\u662fJD\u4e2d\u660e\u786e\u70b9\u540d\u4e86SGLang\uff0c\u8fd9\u6b63\u662f\u4f60\u8fd1\u671f\u7684\u4e3b\u653b\u65b9\u5411\u3002</p> <p>\u4e3a\u4e86\u62ff\u4e0b\u8fd9\u4e2aOffer\uff0c\u4f60\u9700\u8981\u5c06\u4f60\u7684\u7ecf\u5386\u5411\u201c\u5206\u5e03\u5f0f\u201d\u548c\u201c\u7b97\u5b50\u7ea7\u4f18\u5316\u201d\u8fd9\u4e24\u4e2a\u65b9\u5411\u8fdb\u4e00\u6b65\u9760\u62e2\u3002\u4ee5\u4e0b\u662f\u9488\u5bf9\u8be5JD\u7684\u5b9a\u5236\u5316\u51c6\u5907\u5efa\u8bae\uff1a</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#1","title":"1. \u6838\u5fc3\u77e5\u8bc6\u50a8\u5907\uff1a\u9488\u5bf9\u6027\u67e5\u6f0f\u8865\u7f3a","text":"<p>\u8fd9\u4e2aJD\u76f8\u6bd4\u4e4b\u524d\u7684OceanBase\u5c97\u4f4d\uff0c\u66f4\u5f3a\u8c03\u5206\u5e03\u5f0f\uff08Megatron\uff09\u548c\u5e95\u5c42\u7b97\u5b50\uff08CUDA/Triton/CUTLASS\uff09\u3002</p> <ul> <li> <p>\u5206\u5e03\u5f0f\u63a8\u7406\u539f\u7406\uff08\u91cd\u4e2d\u4e4b\u91cd\uff09\uff1a</p> </li> <li> <p>\u5e76\u884c\u7b56\u7565\uff1a \u5fc5\u987b\u5f7b\u5e95\u7406\u89e3 Tensor Parallelism (TP) \u548c Pipeline Parallelism (PP)\u3002</p> </li> <li> <p>\u901a\u4fe1\u539f\u8bed\uff1a \u7406\u89e3 <code>all-reduce</code>, <code>all-gather</code> \u5728\u591a\u5361\u63a8\u7406\u4e2d\u7684\u4f5c\u7528\u3002</p> </li> <li> <p>Megatron-LM\uff1a \u4e0d\u9700\u8981\u7cbe\u901a\u4ee3\u7801\uff0c\u4f46\u8981\u61c2\u5b83\u5207\u5206\u6a21\u578b\u6743\u91cd\u7684\u903b\u8f91\uff08\u6bd4\u5982MLP\u5c42\u548cAttention\u5c42\u662f\u5982\u4f55\u5207\u5206\u7684\uff09\u3002</p> </li> <li> <p>\u51c6\u5907\u8bdd\u672f\uff1a \u201c\u6211\u5728\u5f00\u53d1MiniInfer\u65f6\u867d\u7136\u76ee\u524d\u662f\u5355\u5361\uff0c\u4f46\u6211\u7814\u7a76\u8fc7vLLM\u5982\u4f55\u5229\u7528Ray\u8fdb\u884c\u5206\u5e03\u5f0f\u8c03\u5ea6\uff0c\u4ee5\u53caMegatron\u5982\u4f55\u901a\u8fc7TP\u964d\u4f4e\u5355\u5361\u663e\u5b58\u538b\u529b\u3002\u201d</p> </li> <li> <p>GPU \u7f16\u7a0b\u4e0e\u7b97\u5b50\u4f18\u5316\uff08Triton/CUTLASS\uff09\uff1a</p> </li> <li> <p>Triton \u662f\u52a0\u5206\u9879\uff1a JD\u660e\u786e\u63d0\u5230\u4e86Triton\u3002\u5efa\u8bae\u4f60\u82b12-3\u5929\u65f6\u95f4\uff0c\u7528 OpenAI Triton \u5199\u4e00\u4e2a\u7b80\u5355\u7684\u7b97\u5b50\uff08\u6bd4\u5982 Softmax \u6216 LayerNorm\uff09\uff0c\u5bf9\u6bd4\u4e00\u4e0b PyTorch \u539f\u751f\u7684\u6027\u80fd\u3002\u8fd9\u80fd\u8bc1\u660e\u4f60\u5177\u5907\u201c\u5f15\u5165\u524d\u6cbf\u6280\u672f\u201d\u7684\u80fd\u529b\u3002</p> </li> <li> <p>CUDA \u8fdb\u9636\uff1a \u7ed3\u5408\u4f60\u5199 RoPE \u7b97\u5b50\u7684\u7ecf\u9a8c\uff0c\u6df1\u5165\u590d\u4e60\u4e00\u4e0b Shared Memory Bank Conflict\u3001Coalesced Access\uff08\u5408\u5e76\u8bbf\u95ee\uff09\u7b49\u6982\u5ff5\u3002</p> </li> <li> <p>CUTLASS\uff1a \u8fd9\u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u77e9\u9635\u4e58\u6cd5\u5e93\u3002\u4f5c\u4e3a\u5b9e\u4e60\u751f\uff0c\u4f60\u4e0d\u5fc5\u7cbe\u901a\uff0c\u4f46\u9700\u8981\u77e5\u9053\u5b83\u4e3b\u8981\u7528\u4e8e\u89e3\u51b3\u4ec0\u4e48\u95ee\u9898\uff08\u5982 GEMM \u4f18\u5316\u3001Epilogue \u878d\u5408\uff09\u3002</p> </li> <li> <p>\u6846\u67b6\u6e90\u7801\u6df1\u5ea6\u7406\u89e3 (SGLang/vLLM)\uff1a</p> </li> <li> <p>SGLang \u7279\u6027\uff1a \u4f60\u9700\u8981\u80fd\u8bb2\u6e05\u695a RadixAttention \u662f\u5982\u4f55\u5b9e\u73b0 KV Cache \u590d\u7528\u7684\uff08\u8fd9\u662f SGLang \u7684\u7075\u9b42\uff09\uff0c\u4ee5\u53ca\u5b83\u76f8\u6bd4 vLLM \u7684 PagedAttention \u5728\u591a\u8f6e\u5bf9\u8bdd\u6216 System Prompt \u573a\u666f\u4e0b\u7684\u4f18\u52bf\u3002</p> </li> <li> <p>\u8c03\u5ea6\u5668\u8bbe\u8ba1\uff1a \u5bf9\u6bd4 SGLang \u548c vLLM \u7684\u8c03\u5ea6\u7b56\u7565\uff08Continuous Batching \u7684\u5177\u4f53\u5b9e\u73b0\u5dee\u5f02\uff09\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#2-jd","title":"2. \u9879\u76ee\u7ecf\u5386\u5305\u88c5\uff1a\u76f4\u51fbJD\u75db\u70b9","text":"<p>\u5c06\u4f60\u624b\u5934\u7684\u9879\u76ee\u6362\u4e2a\u89d2\u5ea6\u63cf\u8ff0\uff0c\u4ee5\u5339\u914dJD\u4e2d\u7684\u5173\u952e\u8bcd\u3002</p>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#llm-miniinfer","title":"\u9879\u76ee\u4e00\uff1a\u81ea\u7814\u9ad8\u6027\u80fd LLM \u63a8\u7406\u5f15\u64ce MiniInfer","text":"<ul> <li> <p>\u5bf9\u6807JD\uff1a \u201c\u719f\u6089CUDA\u7f16\u7a0b\u548cGPU\u4e0a\u6027\u80fd\u4f18\u5316\u201d\u3001\u201c\u6253\u9020\u4e1a\u5185\u9886\u5148\u7684\u9ad8\u6548LLM\u63a8\u7406\u5f15\u64ce\u201d\u3002</p> </li> <li> <p>\u7b80\u5386\u63cf\u8ff0\u5efa\u8bae\uff1a</p> </li> <li> <p>Title\uff1a \u6838\u5fc3\u5f00\u53d1\u8005 | C++ / CUDA</p> </li> <li> <p>\u5185\u5bb9\uff1a \u4ece\u96f6\u6784\u5efa\u57fa\u4e8e C++ \u7684\u8f7b\u91cf\u7ea7 LLM \u63a8\u7406\u7cfb\u7edf\u3002</p> </li> <li> <p>\u5173\u952e\u70b9\uff1a</p> <ol> <li> <p>\u624b\u5199 CUDA Kernel\uff1a \u5b9e\u73b0\u4e86 RoPE \u65cb\u8f6c\u4f4d\u7f6e\u7f16\u7801\u548c RMSNorm\uff0c\u6df1\u5165\u7406\u89e3 GPU \u7ebf\u7a0b\u675f\uff08Warp\uff09\u8c03\u5ea6\u673a\u5236\u3002</p> </li> <li> <p>\u663e\u5b58\u7ba1\u7406\uff1a \u5b9e\u73b0\u4e86\u7c7b\u4f3c PagedAttention \u7684\u663e\u5b58\u5206\u9875\u673a\u5236\uff0c\u89e3\u51b3\u4e86\u663e\u5b58\u788e\u7247\u5316\u95ee\u9898\u3002</p> </li> <li> <p>\u8c03\u5ea6\u4f18\u5316\uff1a \u5b9e\u73b0\u4e86 Continuous Batching\uff08\u884c\u5185\u6279\u5904\u7406\uff09\uff0c\u663e\u8457\u63d0\u5347\u4e86 decode \u9636\u6bb5\u7684 GPU \u5229\u7528\u7387\u3002</p> </li> </ol> </li> <li> <p>\u76ee\u7684\uff1a \u8bc1\u660e\u4f60\u4e0d\u6b62\u4f1a\u8c03\u5305\uff0c\u5177\u5907\u201c\u9020\u8f6e\u5b50\u201d\u7684\u5e95\u5c42\u7f16\u7801\u80fd\u529b\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#sglangvllm","title":"\u9879\u76ee\u4e8c\uff1aSGLang/vLLM \u6e90\u7801\u5256\u6790\u4e0e\u7279\u6027\u7814\u7a76","text":"<ul> <li> <p>\u5bf9\u6807JD\uff1a \u201c\u719f\u6089SGLang\u3001vLLM\u201d\u3001\u201c\u8c03\u7814\u5e76\u5f15\u5165\u524d\u6cbf\u673a\u5668\u5b66\u4e60\u7cfb\u7edf\u6280\u672f\u201d\u3002</p> </li> <li> <p>\u7b80\u5386\u63cf\u8ff0\u5efa\u8bae\uff1a</p> </li> <li> <p>Title\uff1a \u6e90\u7801\u7814\u7a76\u4e0e\u6027\u80fd\u5206\u6790</p> </li> <li> <p>\u5185\u5bb9\uff1a \u6df1\u5ea6\u5206\u6790 SGLang \u6846\u67b6\u67b6\u6784\uff0c\u4e13\u6ce8\u4e8e RadixAttention \u5bf9\u957f\u6587\u672c\u524d\u7f00\u7f13\u5b58\uff08Prefix Caching\uff09\u7684\u4f18\u5316\u673a\u5236\u3002</p> </li> <li> <p>\u5173\u952e\u70b9\uff1a</p> <ol> <li> <p>\u6280\u672f\u8c03\u7814\uff1a \u5bf9\u6bd4\u4e86 vLLM \u7684 BlockManager \u4e0e SGLang \u7684 RadixTree \u5728\u663e\u5b58\u7ba1\u7406\u4e0a\u7684\u5dee\u5f02\u3002</p> </li> <li> <p>\u6027\u80fd\u5206\u6790\uff1a \u7814\u7a76\u4e86\u4e0d\u540c\u5e76\u53d1\u8bf7\u6c42\u4e0b\uff0cSGLang \u5728\u5904\u7406\u7ed3\u6784\u5316\u8f93\u51fa\uff08JSON/Regex\uff09\u65f6\u7684\u6027\u80fd\u4f18\u52bf\uff08\u8fd9\u662fSGLang\u7684\u4e00\u5927\u5356\u70b9\uff09\u3002</p> </li> </ol> </li> <li> <p>\u76ee\u7684\uff1a \u76f4\u63a5\u56de\u5e94JD\u5bf9SGLang\u7684\u8981\u6c42\uff0c\u5c55\u793a\u4f60\u7684\u6280\u672f\u654f\u9510\u5ea6\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#nebulagraph","title":"\u9879\u76ee\u4e09\uff1aNebulaGraph \u5206\u5e03\u5f0f\u5b58\u50a8\u5f15\u64ce\u5f00\u53d1","text":"<ul> <li> <p>\u5bf9\u6807JD\uff1a \u201c\u53c2\u4e0e\u5206\u5e03\u5f0f\u5927\u6a21\u578b\u63a8\u7406\u6846\u67b6\u201d\u3001\u201c\u5177\u5907\u826f\u597d\u7684\u56e2\u961f\u534f\u4f5c\u7cbe\u795e\u201d\u3002</p> </li> <li> <p>\u7b80\u5386\u63cf\u8ff0\u5efa\u8bae\uff1a</p> </li> <li> <p>\u76ee\u7684\uff1a \u867d\u7136\u4e0d\u662fAI\u9879\u76ee\uff0c\u4f46\u5b83\u662f\u5206\u5e03\u5f0f\u7cfb\u7edf\u3002</p> </li> <li> <p>\u8bdd\u672f\uff1a \u5f3a\u8c03\u4f60\u5728 C++ \u590d\u6742\u5de5\u7a0b\u4e0b\u7684\u5f00\u53d1\u7ecf\u9a8c\uff0c\u5bf9 Raft \u534f\u8bae\u7684\u7406\u89e3\uff08\u6709\u52a9\u4e8e\u7406\u89e3\u5206\u5e03\u5f0f\u63a8\u7406\u4e2d\u7684\u72b6\u6001\u540c\u6b65\uff09\uff0c\u4ee5\u53ca\u5728\u5927\u578b\u5f00\u6e90\u793e\u533a\uff08NebulaGraph\uff09\u7684\u4ee3\u7801\u89c4\u8303\u548c\u534f\u4f5c\u6d41\u7a0b\u3002\u8fd9\u80fd\u7ed9\u9762\u8bd5\u5b98\u6781\u5927\u7684\u5b89\u5168\u611f\uff0c\u8bc1\u660e\u4f60\u7684\u5de5\u7a0b\u843d\u5730\u80fd\u529b\u5f88\u5f3a\u3002</p> </li> </ul>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#3","title":"3. \u9762\u8bd5\u5fc5\u95ee\u201c\u786c\u6838\u201d\u95ee\u9898\u9884\u6d4b","text":"<p>\u51c6\u5907\u597d\u5982\u4f55\u56de\u7b54\u8fd9\u4e9b\u95ee\u9898\uff0c\u80fd\u8ba9\u4f60\u5728\u9762\u8bd5\u4e2d\u8131\u9896\u800c\u51fa\uff1a</p> <ol> <li> <p>\u573a\u666f\u9898\uff1a \u201c\u5982\u679c SGLang \u7684 RadixAttention \u663e\u5b58\u547d\u4e2d\u7387\u5f88\u4f4e\uff0c\u4f1a\u5bfc\u81f4\u4ec0\u4e48\u95ee\u9898\uff1f\u4f60\u4f1a\u5982\u4f55\u4f18\u5316\u5bf9\u5e94\u7684 Eviction Policy\uff08\u6dd8\u6c70\u7b56\u7565\uff09\uff1f\u201d</p> </li> <li> <p>CUDA\u9898\uff1a \u201c\u5199 RoPE \u7b97\u5b50\u65f6\uff0c\u4f60\u662f\u5982\u4f55\u5904\u7406\u9ad8\u7ef4 Tensor \u7684\u5185\u5b58\u5e03\u5c40\u7684\uff1f\u6709\u6ca1\u6709\u9047\u5230 Shared Memory \u4e0d\u591f\u7528\u7684\u60c5\u51b5\uff1f\u201d</p> </li> <li> <p>\u67b6\u6784\u9898\uff1a \u201cvLLM \u7684 Continuous Batching \u5728\u5904\u7406\u6781\u957f Prompt\uff08Prefill\u9636\u6bb5\uff09\u65f6\u4f1a\u963b\u585e Decode \u9636\u6bb5\u7684\u8bf7\u6c42\uff0c\u4e5f\u5c31\u662f Head-of-Line Blocking \u95ee\u9898\uff0c\u4f60\u77e5\u9053\u73b0\u5728\u7684\u4e1a\u754c\u89e3\u51b3\u65b9\u6848\u662f\u4ec0\u4e48\u5417\uff1f\u201d\uff08\u7b54\u6848\u5173\u952e\u8bcd\uff1aChunked Prefill / Piggybacking\uff09\u3002</p> </li> <li> <p>\u5206\u5e03\u5f0f\u9898\uff1a \u201c\u5982\u679c\u8981\u5c06\u4f60\u7684 MiniInfer \u6269\u5c55\u6210\u652f\u6301\u4e24\u5f20\u5361\u8dd1 Llama-70B\uff0c\u4f60\u9700\u8981\u505a\u54ea\u4e9b\u6539\u52a8\uff1f\u901a\u4fe1\u540c\u6b65\u70b9\u5728\u54ea\u91cc\uff1f\u201d</p> </li> </ol>"},{"location":"summary/2025/%E5%AE%9E%E4%B9%A0%E5%87%86%E5%A4%87/JD/%E9%98%B6%E8%B7%83%E6%98%9F%E8%BE%B0%20LLM%20Inference/#_3","title":"\u603b\u7ed3","text":"<p>\u8fd9\u4e2a\u5c97\u4f4d\u975e\u5e38\u9002\u5408\u4f60\u3002SGLang \u662f\u76ee\u524d\u63a8\u7406\u754c\u6700\u706b\u7684\u6846\u67b6\u4e4b\u4e00\uff0c\u800c\u4f60\u6b63\u597d\u5728\u7814\u7a76\u5b83\u3002</p> <p>\u5efa\u8bae\u884c\u52a8\uff1a</p> <ol> <li> <p>\u7b80\u5386\u4e0a\u8981\u628a SGLang \u548c MiniInfer \u653e\u5f97\u975e\u5e38\u663e\u773c\u3002</p> </li> <li> <p>\u8fd9\u4e24\u5929\u5feb\u901f\u8fc7\u4e00\u904d Triton \u7684\u5b98\u65b9 Tutorials\uff08\u53ea\u9700\u8981\u770b\u61c2 vector-add \u548c softmax \u5373\u53ef\uff09\uff0c\u9762\u8bd5\u65f6\u63d0\u5230\u201c\u6211\u6b63\u5728\u5b66\u4e60 Triton \u5e76\u5c1d\u8bd5\u7528\u5b83\u91cd\u5199\u90e8\u5206\u7b97\u5b50\u201d\uff0c\u4f1a\u662f\u975e\u5e38\u5927\u7684\u52a0\u5206\u9879\u3002</p> </li> </ol>"},{"location":"summary/%E7%A0%94%E7%A9%B6%E7%94%9F%E6%80%BB%E7%BB%93/%E7%A0%94%E4%B8%80%E4%B8%8A%E6%80%BB%E7%BB%93/","title":"\u7814\u4e00\u4e0a\u603b\u7ed3","text":"<p> \u7ea6 389 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 2 \u5206\u949f</p> 2025-12-132025-12-13 <p>title: \u7814\u4e00\u4e0a\u603b\u7ed3 tags:</p> <ul> <li>summary   icon: material/calendar-week</li> </ul> <p>\u5f53\u65f6\u7814\u4e00\u4e0a\u592a\u5fd9\uff0c\u6ca1\u6765\u5f97\u53ca\u8fdb\u884c\u590d\u76d8\uff1b\u73b0\u5728\u8fc7\u53bb\u5dee\u4e0d\u591a\u4e00\u5e74\u6765\u590d\u76d8\u4e00\u4e0b\u5f53\u65f6\u7684\u8fc7\u7a0b</p> <ul> <li>\u8fdb\u884c\u4e86\u5b9e\u9a8c\u5ba4 C++ \u548c\u7f51\u7edc\u7f16\u7a0b\u7684\u57f9\u8bad</li> <li>\u5bf9 C++ 17/20 \u6bd4\u8f83\u719f\u6089\u4e86\uff0c\u5bf9\u4e00\u4e9b\u7279\u6027\u4e86\u89e3\u4e86</li> <li>\u770b\u4e86 STL \u6e90\u7801\u89e3\u6790\uff0c\u5bf9 STL \u5bb9\u5668\u91cc\u9762\u7684\u8bbe\u8ba1\u6709\u4e86\u4e86\u89e3</li> <li>\u5bf9 epoll \u4e8b\u4ef6\u89e6\u53d1\u673a\u5236\u7b49\u7f51\u7edc\u5e93\uff0c\u7279\u522b\u662f muduo \u6709\u4e86\u7ec6\u81f4\u7684\u4e86\u89e3</li> <li>\u5f53\u65f6\u548c\u5e08\u5144\uff0c\u540c\u95e8\u4e00\u5757\u6253\u4e86 ob \u5927\u8d5b\uff0c\u57fa\u672c\u4e0a\u6574\u4e2a\u7814\u4e00\u4e0a\u534a\u5e74\u90fd\u662f\u5728\u641e\u8fd9\u4e2a</li> <li>\u770b\u4e86 CMU15445 \u7684\u8bfe\u7a0b\uff0c\u5bf9\u6570\u636e\u5e93\u6709\u4e86\u6bd4\u8f83\u6210\u4f53\u7cfb\u7684\u4e86\u89e3\uff0c\u4e5f\u662f\u5728\u8fd9\u4e2a\u65f6\u5019\u8003\u8651\u4ee5\u540e\u641e\u6570\u636e\u5e93</li> <li>\u5199\u4e86 miniob\uff0c\u5b9e\u73b0\u4e86\u5f88\u591a\u529f\u80fd\uff0c\u5c24\u5176\u662f 2024 \u5e74\u52a0\u5165\u4e86\u5411\u91cf\u641c\u7d22\u529f\u80fd\uff0c\u8ba9\u6211\u60f3\u641e\u5411\u91cf\u6570\u636e\u5e93\uff0c\u5728\u5411\u91cf\u7d22\u5f15\u65b9\u5411\u53d1\u8bba\u6587</li> <li>\u5728 ob \u51b3\u8d5b\u671f\u95f4\uff0c\u770b\u4e86\u4e00\u4e9b\u5411\u91cf\u7d22\u5f15\u65b9\u5411\u7684\u8bba\u6587\u548c\u5411\u91cf\u5316\u5f15\u64ce\u65b9\u5411\u7684\u8bba\u6587\uff0c\u611f\u89c9\u6570\u636e\u5e93\u5fc5\u987b\u548c AI \u7ed3\u5408\u624d\u6709\u51fa\u8def</li> <li>\u6211\u5f53\u65f6\u8fd8\u52a0\u5165\u4e86\u5b9e\u9a8c\u5ba4\u7684 MLSYS \u8bba\u6587\u7814\u8ba8\u7ec4\uff0c\u770b\u4e86\u5f88\u591a llm inference \u7684\u8bba\u6587\uff0c\u611f\u89c9\u8fd9\u4e2a\u4e5f\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u65b9\u5411\uff0c\u4f46\u662f\u56e0\u4e3a\u5728\u6253\u6bd4\u8d5b\uff0c\u800c\u4e14\u57fa\u7840\u77e5\u8bc6\u9700\u8981\u8865\u7684\u5f88\u591a\uff0c\u5c31\u6682\u65f6\u6ca1\u8003\u8651\u4e86 <p>\ud83d\ude3f\u73b0\u5728\u60f3\u60f3\uff0c\u5f53\u65f6\u4e0d\u5e94\u8be5\u653e\u5f03\u8fd9\u4e2a\u65b9\u5411\u7684\uff0c\u73b0\u5728\u5c31\u4e0d\u81f3\u4e8e\u8fd9\u4e48\u6025\u8feb\u4e86</p> </li> <li>\u6700\u540e\u6bd4\u8d5b\u6210\u7ee9\u8fd8\u4e0d\u9519\uff0c\u5168\u56fd\u7b2c11\uff0c\u4e5f\u662f\u5728\u7b80\u5386\u4e0a\u6709\u7684\u5199\u4e86</li> </ul>"},{"location":"summary/%E7%A0%94%E7%A9%B6%E7%94%9F%E6%80%BB%E7%BB%93/%E7%A0%94%E4%B8%80%E4%B8%8B%E6%80%BB%E7%BB%93/","title":"\u7814\u4e00\u4e0b\u603b\u7ed3","text":"<p> \u7ea6 237 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-132025-12-13 <p>title: \u7814\u4e00\u4e0b\u603b\u7ed3 tags:</p> <ul> <li>summary   icon: material/calendar-week</li> </ul>"},{"location":"summary/%E7%A0%94%E7%A9%B6%E7%94%9F%E6%80%BB%E7%BB%93/%E7%A0%94%E4%B8%80%E4%B8%8B%E6%80%BB%E7%BB%93/#_1","title":"\u8ba1\u5212","text":"\\[[\u7814\u4e00\u4e0a\u603b\u7ed3]\\]"},{"location":"summary/%E7%A0%94%E7%A9%B6%E7%94%9F%E6%80%BB%E7%BB%93/%E7%A0%94%E4%B8%80%E4%B8%8B%E6%80%BB%E7%BB%93/#_2","title":"\u5b9e\u9645\u603b\u7ed3","text":"<ul> <li>\u5148\u5b8c\u6210\u4e86 CMU15445 \u5bf9\u5e94\u7684 bustub \u9879\u76ee\u7684\u5b9e\u8df5\uff0c\u5bf9\u6570\u636e\u5e93\u7684\u5404\u79cd\u57fa\u7840\u77e5\u8bc6\u53c8\u6709\u4e86\u65b0\u7684\u7406\u89e3</li> <li>\u53c8\u5b8c\u6210\u4e86 tidb \u7684\u5c0f\u9879\u76ee tinykv\uff0c\u5bf9 raft \u6709\u4e86\u4e00\u5b9a\u7684\u7406\u89e3 <p>\u611f\u89c9\u8fd8\u662f\u9700\u8981\u5728\u751f\u4ea7\u4e2d\u9047\u5230\u95ee\u9898\uff0c\u624d\u80fd\u7406\u89e3\u4e00\u4e9b\u8bbe\u8ba1\u4e0a\u7684\u8003\u91cf \u4f46\u662f\u8d8a\u6765\u8d8a\u611f\u89c9\u5206\u5e03\u5f0f\u662f\u4e00\u4e2a\u810f\u6d3b\uff0c\u5904\u7406\u5c42\u51fa\u4e0d\u7a77\u7684 corner case</p> </li> <li>\u6210\u529f\u7533\u8bf7\u4e0b\u4e86\u5f00\u6e90\u4e4b\u590f\uff0c\u4e3a nebula graph \u589e\u52a0 ann search \u80fd\u529b</li> <li>\u57fa\u672c\u4e0a\u6574\u4e2a\u6691\u5047 + 9-10\u6708\u57fa\u672c\u4e0a\u5728\u641e\u8fd9\u4e2a\u9879\u76ee\uff0c\u7b80\u5386\u4e0a\u53ef\u4ee5\u518d\u6765\u4e00\u7b14</li> <li>\u57fa\u672c\u4e0a6\u6708\u5f00\u59cb\u770b\u4e00\u4e9b\u5c97\u4f4d\u7684 job description\uff0c\u8d8a\u53d1\u611f\u89c9\u6570\u636e\u5e93\u6ca1\u4ec0\u4e48\u589e\u957f\u70b9\u4e86\uff0c\u5f00\u59cb\u8003\u8651\u548c AI \u7ed3\u5408\u7684\u4e00\u4e9b\u6570\u636e\u5e93\u5c97\u4f4d\uff0c\u4f46\u662f\u5f88\u5c11</li> <li>\u548c\u5b9e\u4e60\u7684\u5e08\u5144\u4eec\u4ea4\u6d41\u53d1\u73b0\u5927\u5bb6\u5bf9 LLM \u975e\u5e38\u770b\u597d</li> </ul>"},{"location":"summary/%E7%A0%94%E7%A9%B6%E7%94%9F%E6%80%BB%E7%BB%93/%E7%A0%94%E4%BA%8C%E4%B8%8A%E6%80%BB%E7%BB%93/","title":"\u7814\u4e8c\u4e0a\u603b\u7ed3","text":"<p> \u7ea6 168 \u4e2a\u5b57  1 \u5f20\u56fe\u7247  \u9884\u8ba1\u9605\u8bfb\u65f6\u95f4 1 \u5206\u949f</p> 2025-12-132025-12-13 <p>title: \u7814\u4e8c\u4e0a\u603b\u7ed3 tags:</p> <ul> <li>summary   icon: material/calendar-week</li> </ul> <ul> <li>\u5728 9 \u6708\u4e0b\u65ec\uff0c\u548c\u5ba4\u53cb\u534a\u591c\u7545\u804a\u7684\u65f6\u5019\uff0c\u5f7b\u5e95\u4e0b\u5b9a\u51b3\u5fc3\uff0call in llm inference</li> <li>\ud83d\udcaa\u4eba\u751f\u5c31\u662f\u8981 all in \u4e00\u6b21\u7684</li> <li>\u770b\u4e86 cse 234 \u7684\u8bfe\u7a0b\uff0c\u8865\u4e86\u8865\u7f3a\u5931\u7684\u57fa\u7840\uff0c\u91cc\u9762\u8001\u5e08\u63d0\u7684\u4e09\u4e2a\u671f\u671b\u975e\u5e38\u6233\u6211</li> <li>Ability to identify the right problems</li> <li>Ability to understand \u201ctrends\u201d</li> <li>Ability to \u201cpredict the future\u201d (I hope so)</li> <li>\u770b\u4e86 GPU \u548c CUDA \u76f8\u5173\u7684\u57fa\u7840\u77e5\u8bc6(\u4e3b\u8981\u662f\u535a\u5ba2\u548c cuda mode)</li> <li>\u5199\u4e86\u4e2a\u5c0f\u9879\u76ee tinyllm\uff0c\u6682\u65f6\u6ca1\u6709\u52a0\u4e0a page attention \u548c flash attention \u4ee5\u53ca\u81ea\u5df1\u5199\u7684 cuda kernel\uff0c\u6253\u7b97\u57fa\u4e8e nano-vllm \u91cd\u6784\u4e00\u904d</li> <li>\u68b3\u7406\u4e86\u4e0b sglang scheduler \u6253\u7b97\u5bf9 speculative decoding \u76f8\u5173 issue \u8d21\u732e PR\uff08I hope so\uff09</li> </ul>"},{"location":"tags/","title":"Tags","text":""},{"location":"tags/#tags","title":"Tags","text":"2025-12-022025-12-10 <p>{{ tag_content }}</p>"}]}