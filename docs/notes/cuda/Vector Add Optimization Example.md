---
title: ä¸€æ­¥æ­¥å®ç° CUDA Vector Add ä¼˜åŒ–
date: 2025/10/21 23:15
tags:
  - LLMInference
---

# ä¸€æ­¥æ­¥å®ç° CUDA Vector Add ä¼˜åŒ–

ğŸ“š æœ¬æ–‡å°†ä»æœ€åŸºç¡€çš„ vector add å®ç°å¼€å§‹ï¼Œä½¿ç”¨ nsight compute å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æå¯»æ‰¾ç“¶é¢ˆå¹¶ä¸€æ­¥æ­¥è¿›è¡Œä¼˜åŒ–ã€‚é€šè¿‡è¿™ç§æ–¹å¼æ¥å­¦ä¹  CUDA çš„ç¼–ç¨‹å’Œä¼˜åŒ–ã€‚

## Prerequisite

### Arithmetic Intensity(AI)

ç®—æœ¯å¼ºåº¦æ˜¯è¡¡é‡ä¸€ä¸ªè®¡ç®—ä»»åŠ¡ï¼ˆå¦‚ CUDA Kernelï¼‰æ˜¯â€œè®¡ç®—å¯†é›†å‹â€è¿˜æ˜¯â€œè®¿å­˜å¯†é›†å‹â€çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚

**1. å®šä¹‰ï¼š** å®ƒè¢«å®šä¹‰ä¸ºâ€œæ€»å…±æ‰§è¡Œçš„æµ®ç‚¹è®¡ç®—æ“ä½œæ¬¡æ•°â€ä¸â€œæ€»å…±ä¼ è¾“çš„æ•°æ®å­—èŠ‚æ•°â€ä¹‹é—´çš„æ¯”ç‡ã€‚

- **`AI = (æ€»è®¡ç®—æ“ä½œæ•°) / (æ€»è®¿å­˜å­—èŠ‚æ•°)`**
- **å•ä½ï¼š** `FLOPs/Byte` (å³ï¼Œæ¯ä¼ è¾“ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œèƒ½å¯¹åº”æ‰§è¡Œå¤šå°‘æ¬¡æµ®ç‚¹è®¡ç®—)

**2. ä¸ºä»€ä¹ˆå®ƒå¦‚æ­¤é‡è¦ï¼Ÿ** AI å†³å®šäº†ä¸€ä¸ªç¨‹åº**ç†è®ºä¸Šçš„æ€§èƒ½ç“¶é¢ˆ**ã€‚æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å¯¹æ¯”ä¸€ä¸ªç¨‹åºå’Œä¸€ä¸ªç¡¬ä»¶ï¼ˆGPUï¼‰çš„ç‰¹æ€§ï¼š

- **ç¡¬ä»¶çš„â€œAIâ€**ï¼šGPU ä¹Ÿæœ‰ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œå³å®ƒçš„ `å³°å€¼è®¡ç®—èƒ½åŠ› (GFLOPs/s)` / `å³°å€¼å†…å­˜å¸¦å®½ (GB/s)
- **ç¨‹åºçš„ AI**ï¼šå†…æ ¸çš„ `FLOPs / Bytes`ã€‚

### Roofline

Roofline æ¨¡å‹ï¼ˆå±‹é¡¶çº¿æ¨¡å‹ï¼‰æ˜¯ä¸€ç§ç”¨æ¥**åˆ†æç¨‹åºæ€§èƒ½ç“¶é¢ˆ**ï¼ˆè®¡ç®—å—é™è¿˜æ˜¯å¸¦å®½å—é™ï¼‰çš„æ–¹æ³•ã€‚  
å®ƒæŠŠ**è®¡ç®—æ€§èƒ½**ï¼ˆFLOPs/sï¼‰å’Œ**è®¿å­˜æ€§èƒ½**ï¼ˆBytes/sï¼‰è”ç³»åœ¨ä¸€èµ·ï¼Œã€‚ä»¥å¯è§†åŒ–çš„æ–¹å¼å±•ç¤ºæ€§èƒ½ä¸Šé™

$$
AchievableÂ FLOPs=min(AIÃ—MemoryÂ BW,PeakÂ FLOPs)
$$

![](img/roofline.png)

### Stall in NCU

| ç±»å‹                       | ä»£è¡¨ç­‰å¾…       | å…¸å‹ç“¶é¢ˆ | ä¼˜åŒ–æ–¹å‘      |
| ------------------------ | ---------- | ---- | --------- |
| **All Scoreboard**       | æ‰€æœ‰ä¾èµ–æœªæ»¡è¶³    | å®Œå…¨ç­‰å¾… | æé«˜å¹¶å‘ã€å¼‚æ­¥è®¿é—® |
| **Long Scoreboard**      | DRAM è®¿é—®æœªè¿”å› | å†…å­˜å»¶è¿Ÿ | ä¼˜åŒ–è®¿å­˜ã€å…±äº«å†…å­˜ |
| **Short Scoreboard**     | L1/å¯„å­˜å™¨ä¾èµ–   | æ•°æ®ä¾èµ– | è°ƒæ•´æŒ‡ä»¤é¡ºåº    |
| **Execution Dependency** | ç®—æœ¯æŒ‡ä»¤ç»“æœæœªå°±ç»ª  | è¿ç®—é“¾é•¿ | å¢åŠ  ILP    |
| **Barrier/Branch**       | åŒæ­¥æˆ–åˆ†æ”¯ç­‰å¾…    | æ§åˆ¶æµ  | å‡å°‘åˆ†æ”¯/åŒæ­¥   |
## Settings

è¿™é‡Œæµ‹è¯•ç¯å¢ƒæ˜¯ RTX 3080 Ti
- ç†è®ºå¸¦å®½çº¦ä¸º 912 GB/s
- FP32 peak FLOPsï¼š**34 TFLOPS**
- **æœ€å¤§çº¿ç¨‹æ•° / SMï¼š** 1536 ä¸ªã€‚
- **æœ€å¤§ Warp æ•° / SMï¼š** 48 ä¸ªã€‚

ä¸‹é¢é™¤ Benchmark å¤–ï¼Œæ‰€æœ‰çš„æµ‹è¯• Vector Element å¤§å°ä¸º 1024

## æŒ‡æ ‡

### Compute Throughput

$$\text{Compute Throughput} \approx \frac{\text{Total Instructions Executed (æŒ‡ä»¤æ€»æ•°)}}{\text{Execution Time (æ‰§è¡Œæ—¶é—´)}}$$
### Memory Throughput

**å½±å“è¯¥æŒ‡æ ‡çš„é—®é¢˜**

#### 1. æŒ‡ä»¤å±‚çº§ï¼šæŒ‡ä»¤å‘å°„æ•ˆç‡ (Instruction Issue Efficiency)

è¿™æ˜¯ `float4` ä¼˜åŒ–çš„ç›´æ¥ä½œç”¨åŸŸã€‚

- **LSU (Load Store Unit) å‹åŠ›ï¼š**
    
    - **Scalar (`float`):** æ¬è¿åŒæ ·å¤šçš„æ•°æ®ï¼Œéœ€è¦å‘å°„ **4 å€** çš„æŒ‡ä»¤æ•°ã€‚è¿™ä¼šå¤§é‡å ç”¨å‰ç«¯ï¼ˆFetch/Decodeï¼‰å¸¦å®½ï¼Œå¹¶å¢åŠ  LSU ç»´æŠ¤ In-flight çŠ¶æ€çš„å¼€é”€ã€‚
        
    - **Vectorized (`float4`):** **å•æŒ‡ä»¤é«˜åå**ã€‚ä¸€æ¡æŒ‡ä»¤å³å¯æ¬è¿ 128-bit æ•°æ®ã€‚LSU é˜Ÿåˆ—å ç”¨å°‘ï¼Œæ›´å®¹æ˜“ç»´æŒæµæ°´çº¿é¥±å’Œã€‚
        
    - _ä¿®æ­£ç‚¹ï¼š_ å³ä½¿æ˜¯æ ‡é‡è®¿é—®ï¼Œå¦‚æœæ˜¯ Coalesced çš„ï¼ŒWarp ä¹Ÿåªä¼šç”Ÿæˆ 1 ä¸ª Transactionï¼Œä½†éœ€è¦ **4 æ¡æŒ‡ä»¤** æ‰èƒ½å®Œæˆ 4 ä¸ªå…ƒç´ çš„åŠ è½½ã€‚
        
- **æŒ‡ä»¤å‘å°„å»¶è¿Ÿæ©ç›– (Issue Latency Hiding)ï¼š**
    
    - **æ°”æ³¡é—®é¢˜ï¼š** æŒ‡ä»¤å‘å°„æœ‰å›ºæœ‰å»¶è¿Ÿã€‚å¦‚æœæ¯æ¡æŒ‡ä»¤æ¬è¿çš„æ•°æ®é‡å¤ªå°ï¼ˆå¦‚ 4 Bytesï¼‰ï¼ŒæŒ‡ä»¤å‘å°„çš„é€Ÿåº¦å¯èƒ½è·Ÿä¸ä¸Šå†…å­˜æ€»çº¿çš„æ¶ˆè€—é€Ÿåº¦ï¼Œå¯¼è‡´æ€»çº¿å‡ºç°â€œç©ºé—²æ°”æ³¡â€ã€‚
        
    - **ä¼˜åŠ¿ï¼š** `float4` (16 Bytes/thread) è®©æ¯æ¬¡å‘å°„çš„â€œå«é‡‘é‡â€æ›´é«˜ï¼Œæ›´å®¹æ˜“å¡«æ»¡å†…å­˜ç®¡é“ã€‚
        

#### 2. æ•°æ®å±‚çº§ï¼šå†…å­˜çº§å¹¶è¡Œåº¦ (MLP, Memory Level Parallelism)

è¿™æ˜¯å†³å®šå¸¦å®½ä¸Šé™çš„å…³é”®è½¯ä»¶ç­–ç•¥ã€‚

- **åŸç†ï¼š** HBM å»¶è¿Ÿæé«˜ (~600 cycles)ã€‚ä¸ºäº†æ©ç›–å»¶è¿Ÿï¼Œå¿…é¡»è®©æ€»çº¿ä¸ŠåŒæ—¶é£ç€è¶³å¤Ÿå¤šçš„è¯·æ±‚ (In-flight Requests)ã€‚
    
- **ä¼˜åŒ–æ‰‹æ®µï¼š** **å¾ªç¯å±•å¼€ (Loop Unrolling)**ã€‚
    
    - _Bad:_ `Load -> Use -> Load -> Use` (ä¸²è¡Œä¾èµ–ï¼Œå»¶è¿Ÿæ— æ³•æ©ç›–)ã€‚
        
    - _Good:_ `Load1 -> Load2 -> Load3 -> Load4 ... -> Use1` (å¹¶è¡Œå‘å°„ï¼Œä¸€æ¬¡ç­‰å¾…ï¼Œå…¨éƒ¨è¿”å›)ã€‚
        

#### 3. ç¡¬ä»¶å±‚çº§ï¼šä¼ è¾“ç²’åº¦ä¸åˆ©ç”¨ç‡ (Transaction & Utilization)

å³ä½¿è½¯ä»¶å†™å¾—å¥½ï¼Œç¡¬ä»¶æœºåˆ¶ä¹Ÿå¯èƒ½å¯¼è‡´æµªè´¹ã€‚

- **æ‰‡åŒºåˆ©ç”¨ç‡ (Sector Utilization):**
    
    - **æœºåˆ¶ï¼š** DRAM åˆ° L2 çš„æœ€å°ä¼ è¾“ç²’åº¦æ˜¯ **32 Bytes (Sector)**ã€‚
        
    - **æµªè´¹ï¼š** å¦‚æœä½ åªè¯» 1 ä¸ª Byte (`char`) ä¸”æœªæ‰“åŒ…ï¼Œç¡¬ä»¶ä¹Ÿè¢«è¿«æ¬è¿ 32 Bytesã€‚**æœ‰æ•ˆå¸¦å®½ (Effective Bandwidth)** åªæœ‰ 1/32ã€‚
        
    - **å¯¹ç­–ï¼š** å¯¹äºå°æ•°æ®ç±»å‹ï¼ˆINT8/FP16ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨æ‰“åŒ…å¯¹é½ï¼ˆPack Alignmentï¼‰è®¿é—®ã€‚
        
- **åœ°å€å¯¹é½ (Address Alignment):**
    
    - **æœºåˆ¶ï¼š** ç¡¬ä»¶è¦æ±‚è®¿é—®åœ°å€æŒ‰ 32B æˆ– 128B å¯¹é½ã€‚
        
    - **åæœï¼š** å¦‚æœæŒ‡é’ˆåœ°å€åç§»ï¼ˆMisalignedï¼‰ï¼Œä¸€æ¬¡ 128 Bytes çš„è¯»å–å¯èƒ½ä¼šè·¨è¶Šä¸¤ä¸ª 128B å—ï¼Œå¯¼è‡´ç¡¬ä»¶å¿…é¡»å‘èµ· **2 ä¸ª Transactions**ã€‚è¿™ä¼šç›´æ¥å¯¼è‡´å¸¦å®½æ€§èƒ½å‡åŠã€‚
        

#### 4. æ¶æ„å±‚çº§ï¼šç‰©ç†å†²çª (Physical Conflict)

é€šå¸¸ç”±ç¡¬ä»¶è§£å†³ï¼Œä½†åœ¨æç«¯ä¼˜åŒ–æ—¶éœ€æ³¨æ„ã€‚

- **åˆ†åŒºå†²çª (Partition Camping / Channel Conflict):**
    
    - **åŸç†ï¼š** æ˜¾å­˜è¢«åˆ’åˆ†ä¸ºå¤šä¸ªç‰©ç†åˆ†åŒºï¼ˆMemory Controllersï¼‰ã€‚
        
    - **ç°è±¡ï¼š** ç‰¹å®šçš„è®¿é—®æ­¥é•¿ï¼ˆStrideï¼Œé€šå¸¸æ˜¯ 2 çš„å¹‚æ¬¡ï¼‰å¯èƒ½å¯¼è‡´æ‰€æœ‰è¯·æ±‚é›†ä¸­æ‰“å‘åŒä¸€ä¸ª Controllerï¼Œé€ æˆå±€éƒ¨æ‹¥å µï¼ˆSerializationï¼‰ï¼Œè€Œå…¶ä»– Controller ç©ºé—²ã€‚
        
    - **ç°çŠ¶ï¼š** ç°ä»£ GPU (Pascal+) å·²é€šè¿‡ç‰©ç†åœ°å€å“ˆå¸Œï¼ˆAddress Swizzlingï¼‰æå¤§ç¼“è§£äº†æ­¤é—®é¢˜ï¼Œä½†åœ¨å†™æé™ Kernel æ—¶ä»éœ€é¿å…å®Œç¾çš„ 2 çš„å¹‚æ¬¡è·¨åº¦ã€‚
## baseline

```cpp
// FP32
// ElementWise Add grid(N/256),
// block(256) a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)
__global__ void vector_add_kernel(const float *a, const float *b, float *c,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  int n) {
Â  int idx = blockIdx.x * blockDim.x + threadIdx.x;
Â  if (idx < n) {
Â  Â  c[idx] = a[idx] + b[idx];
Â  }
}
```

### åˆ†æ

è¯¥ç‰ˆæœ¬çš„ vector addï¼Œæ‰§è¡Œä¸€æ¬¡è®¡ç®—éœ€è¦ä¸‰æ¬¡è®¿å­˜ï¼Œæ¯æ¬¡è¯» 4 bytes (read A, read B, write C)

$$
	AI = 1 / (3 \times 4) =1/12\approx 0.083
$$

è¯´æ˜è¿™æ˜¯ä¸€ä¸ª **memory-bound** çš„ç¨‹åº

- æŸ¥çœ‹ ncu çš„ SLO æˆ‘ä»¬å¯ä»¥çœ‹åˆ°
	- Memory Throughput: 75%
	- Compute Throughput: 15%

- æŸ¥çœ‹ Memory Workload Analysisï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æˆ‘ä»¬å®Œå…¨æ²¡æœ‰ç”¨åˆ° shared memoryï¼Œç›´æ¥ç”¨ L2 Cache å’Œ L1 Cache

![](img/memory_chat.png)

- Kernel çš„ä¸»è¦ç“¶é¢ˆæ˜¯ **`Stall Long Scoreboard`**â€”â€”å³**å†…å­˜å»¶è¿Ÿåœé¡¿**ã€‚GPU éšè—è¿™ç§â€œç­‰å¾…â€çš„å”¯ä¸€æœºåˆ¶ï¼Œå°±æ˜¯ **Occupancy (å ç”¨ç‡)**

## Optimization V1 -- vectorized access

### ä¼˜åŒ–

- çŸ¢é‡åŒ–å†…å­˜è®¿é—®ï¼šæˆ‘ä»¬ä¸å†ä¸€æ¬¡è¯»å–ä¸€ä¸ª floatï¼Œè€Œæ˜¯åŒæ—¶å– 4 ä¸ª floatï¼Œ**ä¸€ä¸ª wrap é‡Œé¢çš„æ‰€æœ‰çº¿ç¨‹åŒæ—¶è·å– 4 floatï¼Œå¯ä»¥å˜ä¸º LDG.128 ä¸€æ¬¡æ€§è·å– 128 bit æ•°æ®**
- å¢åŠ äº† ILP
- âš  è¿™é‡Œæœ‰ä¸ª trade-offï¼Œå¦‚æœæˆ‘ä»¬æ¯ä¸ª thread ä½¿ç”¨äº†è¿‡å¤šçš„å¯„å­˜å™¨ï¼Œé‚£ä¹ˆ SM ä¸Šæ´»è·ƒçš„ Warp ä¼šå˜å°‘ï¼Œå¯¼è‡´ Occupany ä¼šä¸‹é™ï¼Œè¿™åŒæ ·å¯¹æ€§èƒ½å½±å“å¾ˆå¤§

```cpp
// ElementWise Add + Vec4
// grid(N/256), block(256/4)
// a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)
__global__ void elementwise_add_f32x4_kernel(const float *a, const float *b,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â float *c, int n) {
Â  int idx = (blockIdx.x * blockDim.x + threadIdx.x) * 4;
Â  if (idx < n) {
Â  Â  float4 a4 = reinterpret_cast<const float4 *>(a)[idx / 4];
Â  Â  float4 b4 = reinterpret_cast<const float4 *>(b)[idx / 4];
Â  Â  float4 c4;
Â  Â  c4.x = a4.x + b4.x;
Â  Â  c4.y = a4.y + b4.y;
Â  Â  c4.z = a4.z + b4.z;
Â  Â  c4.w = a4.w + b4.w;
Â  Â  reinterpret_cast<float4 *>(c)[idx / 4] = c4;
Â  }
}
```

### ç»“æœ

- å†…å­˜ååå¢åŠ ï¼Œå†…å­˜åˆ©ç”¨ç‡æå‡è‡³ 80 %ï¼›è®¡ç®—åˆ©ç”¨ç‡ä¸‹é™
![](img/vector_add_slo.png)

- Occupancy ä» 67% æå‡è‡³ 100%
### åˆ†æ
- **Compute Throughput ä¸‹é™ï¼š** å› ä¸º Vector Add æ˜¯ Memory-Bound çš„ï¼Œæ€§èƒ½ç“¶é¢ˆåœ¨äºå¸¦å®½è€Œéè®¡ç®—ã€‚ä½¿ç”¨ `float4` å¹¶æ²¡æœ‰æ”¹å˜æ€»çš„æ•°æ®ä¼ è¾“é‡ï¼Œä½†å®ƒé€šè¿‡å‘é‡åŒ–æŒ‡ä»¤**å¤§å¹…å‡å°‘äº† SM éœ€è¦å‘å°„çš„æŒ‡ä»¤æ€»æ•°**ï¼ˆå‡å°‘äº† Load/Store æŒ‡ä»¤æ•°å’Œå¾ªç¯å¼€é”€ï¼‰ã€‚æ ¹æ® `ååç‡ = æŒ‡ä»¤æ•° / æ—¶é—´`ï¼Œåœ¨æ—¶é—´ä¸å˜çš„æƒ…å†µä¸‹ï¼ŒæŒ‡ä»¤æ•°å‡å°‘å¯¼è‡´äº† Compute Throughput ä¸‹é™ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€**æŒ‡ä»¤æ•ˆç‡çš„æå‡**ã€‚
    
- **å…³äº Memory ä¸Šå‡ï¼š** `float4` ç”Ÿæˆäº†æ›´å®½çš„å†…å­˜äº‹åŠ¡ï¼ˆMemory Transactionsï¼‰ï¼Œå‡å°‘äº† LSUï¼ˆLoad Store Unitï¼‰å¤„ç†è¯·æ±‚çš„å¼€é”€ï¼Œå¹¶å‡å°‘äº†æŒ‡ä»¤å‘å°„å¸¦æ¥çš„å»¶è¿Ÿæ°”æ³¡ï¼Œä»è€Œèƒ½æ›´ç´§å¯†åœ°å¡«æ»¡æ˜¾å­˜å¸¦å®½ï¼Œå› æ­¤ Memory Utilization ä¸é™åå‡ã€‚


## Optimization V2 -- fp16 

### ä¼˜åŒ–

- FP16 è®¡ç®—ä½¿ç”¨ CUDA Core ä¼šæ¯” FP32 å¿«è¿‘ 2 å€

```cpp
// FP16
// ElementWise Add grid(N/256),
// block(256) a: Nx1, b: Nx1, c: Nx1, c = elementwise_add(a, b)
__global__ void elementwise_add_f16_kernel(half *a, half *b, half *c, int N) {
Â  int idx = blockIdx.x * blockDim.x + threadIdx.x;
Â  if (idx < N)
Â  Â  c[idx] = __hadd(a[idx], b[idx]);
}
```

### ç»“æœ

- Memory Throughput ä¸‹é™ (80%â†’47%)
- æ‰§è¡Œæ—¶é—´å‡å°‘ï¼ˆ15.97Î¼s -> 13.38Î¼sï¼‰

### åˆ†æ

ä¼ è¾“çš„æ•°æ®é‡å‡åŠï¼Œç†è®ºä¸Šæ—¶é—´åº”è¯¥ä» **15.97 å˜æˆ 8.0 å·¦å³**æ‰å¯¹ï¼Œä¸ºä»€ä¹ˆåªåˆ°äº† 13.38 ï¼Ÿ

**å•æ¬¡æ¬è¿ç²’åº¦å˜å°äº†ï¼Œå¯¼è‡´æ€»çº¿åˆ©ç”¨ç‡ä½ã€‚**

- **FP32 + float4 (Baseline):**
    - æ¯ä¸ªçº¿ç¨‹ä¸€æ¡æŒ‡ä»¤æ¬è¿ï¼š$4 \times 4 \text{ Bytes} = \mathbf{16 \text{ Bytes}}$ã€‚
        
- **FP16 (Current):**
    - æ¯ä¸ªçº¿ç¨‹ä¸€æ¡æŒ‡ä»¤æ¬è¿ï¼š$\mathbf{2 \text{ Bytes}}$ã€‚å•æ¬¡è¯·æ±‚å¤ªå°äº†ã€‚
    - **åæœï¼š**
        1. **LSU æ‹¥å µï¼š** å‘å°„æŒ‡ä»¤çš„é¢‘ç‡å¤ªé«˜ï¼ŒLSU å¤„ç†ä¸è¿‡æ¥ã€‚
        2. **Sector æµªè´¹ï¼š** æ˜¾å­˜ä¼ è¾“æœ€å°å•ä½æ˜¯ 32 Bytesã€‚å¦‚æœä½ æ²¡åšå¥½åˆå¹¶è®¿é—®ï¼ˆCoalescingï¼‰ï¼Œæ¯æ¬¡ä¸ºäº†æ‹¿ 2 Bytes éƒ½è¦åŠ¨ç”¨ 32 Bytes çš„å¸¦å®½ï¼Œ**æœ‰æ•ˆå¸¦å®½ï¼ˆEffective Bandwidthï¼‰** å°±ä¼šå¾ˆä½ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ¬¡æ¬è¿æ›´å¤šæ•°æ®
## Optimization V3 -- fp16 * 8

### ä¼˜åŒ–

- ä¸€æ¬¡å– $\mathbf{16 \text{ Bytes}}$ æ•°æ®

```cpp
__global__ void elementwise_add_f16x8_kernel(const half *a, const half *b, half *c, int n) {
Â  int idx = (blockIdx.x * blockDim.x + threadIdx.x) * 8;
Â  if (idx < n) {
Â  Â  float4 a4 = reinterpret_cast<const float4 *>(a)[idx / 8];
Â  Â  float4 b4 = reinterpret_cast<const float4 *>(b)[idx / 8];
Â  Â  float4 c4;
Â  Â  half2 *a2 = reinterpret_cast<half2 *>(&a4);
Â  Â  half2 *b2 = reinterpret_cast<half2 *>(&b4);
Â  Â  half2 *c2 = reinterpret_cast<half2 *>(&c4);
Â  Â  c2[0] = __hadd2(a2[0], b2[0]);
Â  Â  c2[1] = __hadd2(a2[1], b2[1]);
Â  Â  c2[2] = __hadd2(a2[2], b2[2]);
Â  Â  c2[3] = __hadd2(a2[3], b2[3]);
Â  Â  reinterpret_cast<float4 *>(c)[idx / 8] = c4;
Â  }
}
```

### ç»“æœ

- Memory Throughput ä¸Šå‡ï¼Œè¾¾åˆ° 66%
- æ‰§è¡Œæ—¶é—´å‡å°‘ï¼ˆ13.38Î¼s -> 8.96Î¼sï¼‰

### åˆ†æ

- **æ•°æ®é‡ï¼š** $1M \text{ elements} \times 3 \text{ arrays} \times 2 \text{ Bytes} = \mathbf{6 \text{ MB}}$ã€‚
- **è€—æ—¶ï¼š** $8.96 \mu s$ã€‚
- ç†è®ºæœ‰æ•ˆå¸¦å®½ï¼š
    $$\frac{6 \text{ MB}}{8.96 \mu s} = 0.669 \text{ TB/s} \approx \mathbf{670 \text{ GB/s}}$$
- **åˆ©ç”¨ç‡ï¼š** $670 / 912 \approx \mathbf{73\%}$ã€‚

#### ä¸ºä»€ä¹ˆæ²¡æœ‰è¾¾åˆ° FP32 * 4 çš„ Memory Throughput å‘¢ï¼Ÿ

**çŒœæƒ³**
- **ç‰©ç†è§„å¾‹ï¼š** å†…å­˜æ§åˆ¶å™¨ä»æ”¶åˆ°è¯·æ±‚åˆ°æ•°æ®çœŸæ­£å æ»¡æ€»çº¿ï¼Œæœ‰ä¸€æ®µå›ºå®šçš„**ç‰©ç†å»¶è¿Ÿ (Latency)**ã€‚
- **FP32 åœºæ™¯:**
    - æ€»æ¬è¿é‡ 12MBã€‚
    - è€—æ—¶ ~16Î¼sã€‚
    - è¿™ä¸ªæ—¶é—´è¶³å¤Ÿé•¿ï¼Œè®©æ€»çº¿åœ¨å¤§éƒ¨åˆ†æ—¶é—´é‡Œå¤„äºâ€œæ»¡è½½â€çŠ¶æ€ï¼Œä»è€Œæ‹‰é«˜äº†å¹³å‡å¸¦å®½ã€‚
- **FP16 åœºæ™¯:**
    - æ€»æ¬è¿é‡ 6MBã€‚
    - è€—æ—¶ **8.96Î¼s**ã€‚
    - **ç»“æœï¼š** Nsight Compute ç»Ÿè®¡çš„æ˜¯**æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„å¹³å‡å¸¦å®½**ã€‚å› ä¸ºâ€œæ»¡è½½â€çš„æ—¶é—´æ®µå˜çŸ­äº†ï¼Œå›ºå®šçš„â€œå»¶è¿Ÿâ€æ—¶é—´æ®µå æ¯”å˜å¤§äº†ï¼Œå¯¼è‡´å¹³å‡å¸¦å®½è¢«æ‹‰ä½äº†ã€‚
#### éªŒè¯

éªŒè¯ 10 M çš„ vector addï¼Œç»“æœï¼š
- ä¸ç®¡æ˜¯ fp32 * 4 è¿˜æ˜¯ fp16 * 8ï¼ŒMemory Throughput éƒ½æœ‰æ˜æ˜¾å¢åŠ ï¼Œè¯´æ˜æˆ‘ä»¬çš„çŒœæƒ³åŸºæœ¬æ­£ç¡®

![](img/vector_add_slo_2.png)

## Summary

vector add ç®—å­æ˜¯ä¸€ä¸ªå…¸å‹çš„ memory-bound çš„ç®—å­ï¼Œæˆ‘ä»¬éœ€è¦å°½å¯èƒ½èŠ‚çœå†…å­˜å¸¦å®½å¹¶æé«˜è®¡ç®—æ•ˆç‡ã€‚

> ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ benchmark æµ‹è¯•æ‰€æœ‰ç®—å­çš„å¼€é”€ï¼Œåˆ†æäº§ç”Ÿè¿™ç§ç»“æœçš„åŸå› 

![](img/vector_add_bench.png)
### é˜¶æ®µä¸€ï¼šå°æ•°æ®é‡åŒºé—´ (Latency Bound / å¯åŠ¨å¼€é”€ä¸»å¯¼)

- **æ•°æ®ï¼š** S=256, K=256
- **ç°è±¡1ï¼š**
    - **PyTorch (`f32_th`):** 0.0116 ms
    - **Your Kernel (`f32x4`):** 0.0080 ms (**å¿«äº† ~30%**)
- **åŸå› ï¼š**
	- **é€šç”¨æ€§ vs ä¸“ç”¨æ€§ (Generality vs Specialization)ï¼š**
		- **PyTorch:** ä¸ºäº†é€šç”¨æ€§ï¼ŒPyTorch çš„ Element-wise ç®—å­ï¼ˆ`TensorIterator`ï¼‰å¿…é¡»å¤„ç†å„ç§å¤æ‚æƒ…å†µï¼šéè¿ç»­å†…å­˜ï¼ˆStrided Memoryï¼‰ã€å¹¿æ’­ï¼ˆBroadcastingï¼‰ã€ç±»å‹è½¬æ¢ï¼ˆType Castingï¼‰ã€‚å³ä¾¿æ•°æ®æ˜¯è¿ç»­çš„ï¼Œå®ƒå†…éƒ¨çš„ç´¢å¼•è®¡ç®—é€»è¾‘ä¹Ÿæ¯”ä½ å¤æ‚çš„ç´¢å¼•è®¡ç®—æ›´é‡ï¼Œæ¶ˆè€—æ›´å¤šå¯„å­˜å™¨å’ŒæŒ‡ä»¤ã€‚
		- **f32x4 Kernel:** å‡è®¾äº†æ•°æ®ç»å¯¹è¿ç»­ã€æ— å¹¿æ’­ã€‚ã€‚
			
	- **å¯åŠ¨é…ç½® (Launch Heuristics)ï¼š**
		- PyTorch æœ‰ä¸€å¥—é€šç”¨çš„ Block/Grid è®¡ç®—å…¬å¼ã€‚å¯¹äºæå°å½¢çŠ¶ï¼Œå®ƒçš„é…ç½®å¯èƒ½ä¸æ˜¯é’ˆå¯¹å½“å‰ GPU æœ€ä¼˜çš„ã€‚è€Œä½ æ˜¯é’ˆå¯¹æ€§è°ƒä¼˜çš„ã€‚

- **ç°è±¡2ï¼š**

| **å†…æ ¸ç‰ˆæœ¬**    | **æ‰§è¡Œæ—¶é—´ (ms)** |
| ----------- | ------------- |
| `out_f32x4` | **0.0079**    |
| `out_f16x8` | **0.0063**    |
- **åŸå› ï¼š**
	- FP16 ä¼ è¾“æ•°æ®æ›´å°‘ï¼Œè¯»å†™è¿™å‡ ç™¾ KB æ•°æ®çš„**åºåˆ—åŒ–å»¶è¿Ÿï¼ˆSerialization Delayï¼‰** å·®å¼‚æ­£å¥½å°±åœ¨å¾®ç§’çº§åˆ«
		- **FP32x4:** éœ€è¦æ¬è¿ $65536 \times 4 \text{B} \times 3 \approx \mathbf{786 \text{ KB}}$ã€‚
		- **FP16x8:** éœ€è¦æ¬è¿ $65536 \times 2 \text{B} \times 3 \approx \mathbf{393 \text{ KB}}$ã€‚

### é˜¶æ®µäºŒï¼šä¸­ç­‰æ•°æ®é‡åŒºé—´

**å…³æ³¨ç‚¹ï¼š** $S=1024, K=1024$ å·¦å³ã€‚

- **ç°è±¡ï¼š**
    - FP32 çš„æ—¶é—´å¼€å§‹æ˜¾è‘—å¢åŠ ï¼ˆ0.017msï¼‰ã€‚
    - FP16 çš„æ—¶é—´çº¦ä¸º FP32 çš„ä¸€åŠç”šè‡³æ›´å°‘ï¼ˆ0.006ms - 0.011msï¼‰ã€‚
        
- **åŸå› ï¼š**
    - æ•°æ®é‡å¼€å§‹å¤§åˆ°è¶³ä»¥æ©ç›–å¯åŠ¨å¼€é”€ã€‚
    - æ­¤æ—¶ **Memory Bound (å¸¦å®½é™åˆ¶)** çš„ç‰¹å¾å¼€å§‹æ˜¾ç°ï¼ŒFP16 å› ä¸ºæ•°æ®é‡å‡åŠï¼Œä¼˜åŠ¿å¼€å§‹æ‰©å¤§ã€‚
        
### é˜¶æ®µä¸‰ï¼šå¤§æ•°æ®é‡åŒºé—´ (Bandwidth Bound)

**å…³æ³¨ç‚¹ï¼š** $S=4096, K=4096$ (æœ€å¤§è§„æ¨¡)ã€‚

- **ç°è±¡ï¼š** **2 å€çº¿æ€§åŠ é€Ÿ (FP32 vs FP16)**

| **å†…æ ¸ç‰ˆæœ¬**     | **æ‰§è¡Œæ—¶é—´ (ms)** | **åˆ†æ** |
| ------------ | ------------- | ------ |
| `out_f32x4`  | **0.240**     | å‘é‡åŒ–åŠ è½½  |
| `out_f16x8`  | **0.122**     | å‘é‡åŒ–åŠ è½½  |

- **åŸå› ï¼š** è¿™è¯æ˜äº†è¿™æ˜¯å½»åº•çš„ **Memory Bound** åœºæ™¯ã€‚FP16 çš„æ•°æ®é‡æ˜¯ 16-bitï¼ŒFP32 æ˜¯ 32-bitã€‚**è®¡ç®—å•å…ƒï¼ˆALUï¼‰åœ¨è¿™é‡Œå®Œå…¨æ˜¯åœ¨ç­‰æ•°æ®**ã€‚
        
## é™„å½•

```shell
-------------------------------------------------------------------------------------
                                        S=256, K=256
         out_f32x4: [1.97265029, -1.30800462], time:0.00798702ms
        out_f32_th: [1.97265029, -1.30800462], time:0.01163483ms
-------------------------------------------------------------------------------------
         out_f16x8: [1.97265625, -1.30859375], time:0.00634193ms
        out_f16_th: [1.97265625, -1.30859375], time:0.01137257ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=256, K=512
         out_f32x4: [-0.01563577, -0.42283049], time:0.00610352ms
        out_f32_th: [-0.01563577, -0.42283049], time:0.01132488ms
-------------------------------------------------------------------------------------
         out_f16x8: [-0.015625, -0.42285156], time:0.00598431ms
        out_f16_th: [-0.015625, -0.42285156], time:0.01120567ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=256, K=1024
         out_f32x4: [-1.84007502, 0.55290109], time:0.00596046ms
        out_f32_th: [-1.84007502, 0.55290109], time:0.01132488ms
-------------------------------------------------------------------------------------
         out_f16x8: [-1.83984375, 0.55273438], time:0.00605583ms
        out_f16_th: [-1.83984375, 0.55273438], time:0.01125336ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=256, K=2048
         out_f32x4: [1.10615909, 1.60974789], time:0.00636578ms
        out_f32_th: [1.10615909, 1.60974789], time:0.01173019ms
-------------------------------------------------------------------------------------
         out_f16x8: [1.10644531, 1.609375], time:0.00603199ms
        out_f16_th: [1.10644531, 1.609375], time:0.01103878ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=256, K=4096
         out_f32x4: [2.09329867, 1.75160038], time:0.01795292ms
        out_f32_th: [2.09329867, 1.75160038], time:0.01842976ms
-------------------------------------------------------------------------------------
         out_f16x8: [2.09375, 1.75195312], time:0.00665188ms
        out_f16_th: [2.09375, 1.75195312], time:0.01180172ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=512, K=256
         out_f32x4: [2.45374489, 0.12144065], time:0.00607967ms
        out_f32_th: [2.45374489, 0.12144065], time:0.01118183ms
-------------------------------------------------------------------------------------
         out_f16x8: [2.453125, 0.12158203], time:0.00586510ms
        out_f16_th: [2.453125, 0.12158203], time:0.01101494ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=512, K=512
         out_f32x4: [-0.09491166, -1.25630379], time:0.00629425ms
        out_f32_th: [-0.09491166, -1.25630379], time:0.01106262ms
-------------------------------------------------------------------------------------
         out_f16x8: [-0.09472656, -1.25585938], time:0.00588894ms
        out_f16_th: [-0.09472656, -1.25585938], time:0.01108646ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=512, K=1024
         out_f32x4: [0.18375367, 0.85552824], time:0.00627041ms
        out_f32_th: [0.18375367, 0.85552824], time:0.01142025ms
-------------------------------------------------------------------------------------
         out_f16x8: [0.18408203, 0.85546875], time:0.00581741ms
        out_f16_th: [0.18408203, 0.85546875], time:0.01120567ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=512, K=2048
         out_f32x4: [-0.19396098, 1.58398294], time:0.01785755ms
        out_f32_th: [-0.19396098, 1.58398294], time:0.01859665ms
-------------------------------------------------------------------------------------
         out_f16x8: [-0.19384766, 1.58398438], time:0.00648499ms
        out_f16_th: [-0.19384766, 1.58398438], time:0.01170635ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=512, K=4096
         out_f32x4: [-2.16418219, -0.03980557], time:0.03359318ms
        out_f32_th: [-2.16418219, -0.03980557], time:0.03430843ms
-------------------------------------------------------------------------------------
         out_f16x8: [-2.1640625, -0.03979492], time:0.01790524ms
        out_f16_th: [-2.1640625, -0.03979492], time:0.01864433ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=256
         out_f32x4: [0.90988386, 0.60685712], time:0.00605583ms
        out_f32_th: [0.90988386, 0.60685712], time:0.01113415ms
-------------------------------------------------------------------------------------
         out_f16x8: [0.91015625, 0.60644531], time:0.00584126ms
        out_f16_th: [0.91015625, 0.60644531], time:0.01084805ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=512
         out_f32x4: [-0.33057773, 1.10878396], time:0.00631809ms
        out_f32_th: [-0.33057773, 1.10878396], time:0.01146793ms
-------------------------------------------------------------------------------------
         out_f16x8: [-0.33056641, 1.10839844], time:0.00598431ms
        out_f16_th: [-0.33056641, 1.10839844], time:0.01108646ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=1024
         out_f32x4: [1.78476286, 2.11524606], time:0.01773834ms
        out_f32_th: [1.78476286, 2.11524606], time:0.01845360ms
-------------------------------------------------------------------------------------
         out_f16x8: [1.78515625, 2.11523438], time:0.00653267ms
        out_f16_th: [1.78515625, 2.11523438], time:0.01168251ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=2048
         out_f32x4: [-0.7581079, 2.17606115], time:0.03349781ms
        out_f32_th: [-0.7581079, 2.17606115], time:0.03435612ms
-------------------------------------------------------------------------------------
         out_f16x8: [-0.7578125, 2.17578125], time:0.01788139ms
        out_f16_th: [-0.7578125, 2.17578125], time:0.01869202ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=1024, K=4096
         out_f32x4: [-1.73245358, 0.14577931], time:0.06384850ms
        out_f32_th: [-1.73245358, 0.14577931], time:0.06377697ms
-------------------------------------------------------------------------------------
         out_f16x8: [-1.73242188, 0.14550781], time:0.03356934ms
        out_f16_th: [-1.73242188, 0.14550781], time:0.03452301ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=256
         out_f32x4: [-0.57417279, -2.21091771], time:0.00746250ms
        out_f32_th: [-0.57417279, -2.21091771], time:0.01170635ms
-------------------------------------------------------------------------------------
         out_f16x8: [-0.57470703, -2.2109375], time:0.00593662ms
        out_f16_th: [-0.57470703, -2.2109375], time:0.01111031ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=512
         out_f32x4: [-1.0632087, -1.56113195], time:0.01783371ms
        out_f32_th: [-1.0632087, -1.56113195], time:0.01852512ms
-------------------------------------------------------------------------------------
         out_f16x8: [-1.06347656, -1.56054688], time:0.00619888ms
        out_f16_th: [-1.06347656, -1.56054688], time:0.01146793ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=1024
         out_f32x4: [1.92093897, 1.09060407], time:0.03349781ms
        out_f32_th: [1.92093897, 1.09060407], time:0.03435612ms
-------------------------------------------------------------------------------------
         out_f16x8: [1.92089844, 1.09082031], time:0.01776218ms
        out_f16_th: [1.92089844, 1.09082031], time:0.01859665ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=2048
         out_f32x4: [1.64275861, -0.26722771], time:0.06289482ms
        out_f32_th: [1.64275861, -0.26722771], time:0.06389618ms
-------------------------------------------------------------------------------------
         out_f16x8: [1.64257812, -0.26708984], time:0.03345013ms
        out_f16_th: [1.64257812, -0.26708984], time:0.03454685ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=2048, K=4096
         out_f32x4: [-1.02567387, -0.87697959], time:0.12266636ms
        out_f32_th: [-1.02567387, -0.87697959], time:0.12316704ms
-------------------------------------------------------------------------------------
         out_f16x8: [-1.02539062, -0.87695312], time:0.06325245ms
        out_f16_th: [-1.02539062, -0.87695312], time:0.06403923ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=256
         out_f32x4: [-0.12928185, 1.02175057], time:0.01778603ms
        out_f32_th: [-0.12928185, 1.02175057], time:0.01845360ms
-------------------------------------------------------------------------------------
         out_f16x8: [-0.12915039, 1.02148438], time:0.00731945ms
        out_f16_th: [-0.12915039, 1.02148438], time:0.01139641ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=512
         out_f32x4: [0.10359669, 1.60598481], time:0.03335476ms
        out_f32_th: [0.10359669, 1.60598481], time:0.03447533ms
-------------------------------------------------------------------------------------
         out_f16x8: [0.10351562, 1.60546875], time:0.01790524ms
        out_f16_th: [0.10351562, 1.60546875], time:0.01866817ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=1024
         out_f32x4: [0.50812161, 2.05591512], time:0.06299019ms
        out_f32_th: [0.50812161, 2.05591512], time:0.06392002ms
-------------------------------------------------------------------------------------
         out_f16x8: [0.5078125, 2.0546875], time:0.03347397ms
        out_f16_th: [0.5078125, 2.0546875], time:0.03452301ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=2048
         out_f32x4: [0.44834208, -2.61600804], time:0.12195110ms
        out_f32_th: [0.44834208, -2.61600804], time:0.12311935ms
-------------------------------------------------------------------------------------
         out_f16x8: [0.44824219, -2.6171875], time:0.06358624ms
        out_f16_th: [0.44824219, -2.6171875], time:0.06401539ms
-------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
                                        S=4096, K=4096
         out_f32x4: [0.87607241, -2.12679267], time:0.24068356ms
        out_f32_th: [0.87607241, -2.12679267], time:0.24130344ms
-------------------------------------------------------------------------------------
         out_f16x8: [0.87597656, -2.12695312], time:0.12204647ms
        out_f16_th: [0.87597656, -2.12695312], time:0.12366772ms
-------------------------------------------------------------------------------------
```
